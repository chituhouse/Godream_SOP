# Bug 修复工作流 SOP

> 从对话分析中提炼的"越改越乱"问题根因与解决方案

---

## 一、问题描述：为什么会越改越乱？

### 1.1 典型症状

从对话记录中发现的常见模式：

1. **症状修复而非根因修复**
   - 用户反馈："还是不对"、"又出问题"
   - 修复了表面症状，但根本问题未解决
   - 例：边框显示问题反复修改，最终发现是信号机制问题

2. **上下文丢失导致重复踩坑**
   - AI 窗口间记忆断裂，同一问题被重复尝试错误方案
   - 例：打包问题在不同会话中被多次"从头分析"

3. **方向错误的连续修改**
   - 用户被迫喊停："你的方向错了，把所有修改给我回滚到对话最开始的状态"
   - 例：2025-12-30 回滚案例

4. **改一处破多处**
   - 修复 A 功能时意外影响 B 功能
   - 跨文件改动未做完整影响分析

### 1.2 根因分析

| 根因类型 | 表现 | 对话证据 |
|---------|------|---------|
| 未理解问题本质 | 猜测性修复、反复试错 | "为什么总是不对"、"又错了" |
| 缺少系统视角 | 局部修改引发连锁问题 | "改完这个那个又坏了" |
| 知识断裂 | 跨会话重复错误 | "这个问题之前不是解决过吗" |
| 验收标准模糊 | 修完不知道对不对 | "到底改好了没" |
| 缺少回滚点 | 改乱了无法恢复 | "回滚到开始状态" |

---

## 二、成功 vs 失败模式对比

### 2.1 失败模式（越改越乱）

```
问题出现 → 猜测原因 → 直接修改 → 测试失败 → 换个猜测 → 再改 → 更多问题 → 回滚
```

典型对话特征：
- "先改改试试"
- "应该是这个问题"
- "怎么还不行"
- "再试一下这个方法"

### 2.2 成功模式（根因定位）

```
问题出现 → 复现确认 → 定位分析 → 根因确定 → 影响评估 → 方案规划 → 用户确认 → 小步修改 → 验证通过
```

典型对话特征：
- "先分析一下原因"
- "让我检查调用链"
- "根因是..."
- "影响范围包括..."
- "我同意后再执行"

---

## 三、典型案例分析

### 案例 1：PyInstaller 打包问题（2025-10-30）

**问题**：Mac 应用包异常退出

**失败尝试**：
- 多次调整打包参数
- 修改入口文件
- 尝试不同版本

**最终根因**：
```
**主因：PyInstaller配置缺陷**
- `packaging/macos/archive/pyinstaller/鸽梦 GoDream.spec`中`bundle_identifier=None`
- 缺少info_plist配置参数
- 导致Info.plist文件完全未生成
```

**教训**：
- 应先分析崩溃日志（SIGKILL - Code Signature Invalid）
- 根据日志定位是代码签名问题
- 再检查签名相关配置

### 案例 2：参考图功能（持续 5 个月）

**问题描述**：参考图画廊显示、缩放问题反复出现

**失败循环**：
- 修改 CSS 尺寸 → 不生效
- 修改布局逻辑 → 破坏其他功能
- 重新设计 → 还是有问题

**根因**：
- 信号机制未正确触发
- Qt 布局系统理解偏差
- 多个组件间状态同步问题

**最终解决**：
- 统一信号机制设计
- 建立组件间状态管理规范
- 添加调试日志定位实际触发点

### 案例 3：Seedream 4.0 API 联调

**问题**："3.0 都没问题，4.0 就不行"

**用户关键提问**：
> "这个联通性，你能不能安排一个小节点先试试呢？不会是 AKSK 的问题吗？"

**根因定位流程**：
1. 先排除网络问题（curl 测试）
2. 对比 3.0 vs 4.0 请求差异
3. 发现 payload 格式不同
4. 统一接口设计

---

## 四、根因分析方法

### 4.1 五问法（5 Whys）

```
问题：应用崩溃
Why1：代码签名验证失败
Why2：Info.plist 文件缺失
Why3：PyInstaller 配置不完整
Why4：bundle_identifier=None
Why5：配置模板未更新
```

### 4.2 二分法定位

```
1. 确认问题可复现
2. 找到"好的"和"坏的"状态边界
3. git bisect 或手动二分
4. 定位到引入问题的变更
5. 分析该变更的影响
```

### 4.3 调用链追踪

```
1. 确定问题表现位置
2. 向上追溯调用链
3. 在关键节点添加日志
4. 运行复现，观察日志
5. 定位实际出错位置
```

### 4.4 对比分析

```
1. 找到"好的"参照（旧版本/其他场景）
2. 对比差异
3. 逐一排除
4. 确定关键差异
```

---

## 五、Bug 修复检查清单

### Phase 0: 问题确认（必须）

- [ ] 问题可复现？复现步骤是什么？
- [ ] 问题边界清晰？什么情况下正常，什么情况下异常？
- [ ] 是新问题还是回归问题？
- [ ] 是否有错误日志/堆栈？

### Phase 1: 根因定位（必须）

- [ ] 是否使用了根因分析方法（5 Whys/二分法/调用链）？
- [ ] 根因是否已确认？有证据支持？
- [ ] 是否检查了 Serena 记忆中的相关历史？

### Phase 2: 方案规划（必须）

- [ ] 修改范围明确？涉及哪些文件？
- [ ] 影响评估完成？是否会影响其他功能？
- [ ] 是否有多个候选方案？选择理由？
- [ ] 用户已确认方案？

### Phase 3: 安全措施（必须）

- [ ] Git 备份已创建？
- [ ] 回滚方案明确？
- [ ] 单步改动 <= 300 行？

### Phase 4: 执行修改

- [ ] 只改确定需要改的地方
- [ ] 保持代码风格一致
- [ ] 添加必要注释说明

### Phase 5: 验证确认

- [ ] 问题已解决？
- [ ] 相关功能未受影响？
- [ ] 用户验收通过？
- [ ] 写入 Serena 决策卡（如为重要 Bug）

---

## 六、关键决策点

### 何时应该暂停

1. **修改超过 2 轮仍未解决** → 停下来重新分析根因
2. **开始"试一试"心态** → 停下来理清思路
3. **改动范围扩大** → 停下来评估影响
4. **用户表示困惑** → 停下来解释当前状态

### 何时应该回滚

1. **方向确认错误** → 立即回滚，不要继续
2. **改动引入更多问题** → 回滚到稳定点
3. **超过计划范围** → 回滚，重新规划

### 何时应该写记忆

1. **根因与表象差异大** → 写入决策卡防止重复踩坑
2. **涉及架构理解** → 写入便于后续会话继承
3. **跨文件改动** → 记录影响范围和关联

---

## 七、协作原则

### 用户侧

```
- 先确认后执行
- 提供清晰的问题描述和复现步骤
- 给予足够的分析时间，不催促"先改改试试"
- 发现方向错误及时喊停
```

### AI 侧

```
- 先分析后动手
- 不猜测，不试错
- 规划先行，小步执行
- 每步都有验收标准
- 发现超出预期主动暂停
```

---

## 附录：快速参考

### 修复前自问清单

1. 我真的理解问题了吗？
2. 我知道根因是什么吗？
3. 我的修改会影响什么？
4. 如果改错了怎么回滚？
5. 用户同意这个方案了吗？

### 红线规则

- **禁止**：未分析就动手
- **禁止**：改多个无关文件
- **禁止**：不备份就改
- **禁止**：用户没确认就执行
- **禁止**：跳过验证就提交

---

*版本：1.0*
*创建日期：2026-01-11*
*基于对话分析：2025-09-14 至 2026-01-11*
