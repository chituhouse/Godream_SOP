{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01GxFLZEnx6JCKmZr3qpZUy3","type":"message","role":"assistant","content":[{"type":"text","text":"我来全面审查批量图片生成的完整链路，找出尺寸参数超过 2048 像素的根因。"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14793,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14793,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"type":"assistant","uuid":"489b7d85-ffab-437c-b399-e4aa55501b85","timestamp":"2025-11-25T19:08:56.745Z"}
{"parentUuid":"489b7d85-ffab-437c-b399-e4aa55501b85","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01GxFLZEnx6JCKmZr3qpZUy3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SfekFvCvjkAiVgX6N14dcp","name":"Glob","input":{"pattern":"**/{client,manager,volc}.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14793,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14793,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"type":"assistant","uuid":"2261b3c3-437c-4ad5-80c7-12a7477a1196","timestamp":"2025-11-25T19:08:57.039Z"}
{"parentUuid":"2261b3c3-437c-4ad5-80c7-12a7477a1196","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01GxFLZEnx6JCKmZr3qpZUy3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01E7Ex1qk1JoJzkE4qB3kLbi","name":"Glob","input":{"pattern":"components/**/*{size,image,generate}*.{tsx,ts,jsx,js}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14793,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14793,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"type":"assistant","uuid":"0534d7b9-e975-4c10-8904-1b8bdb6089e1","timestamp":"2025-11-25T19:08:57.455Z"}
{"parentUuid":"0534d7b9-e975-4c10-8904-1b8bdb6089e1","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01GxFLZEnx6JCKmZr3qpZUy3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019C8BCyXepp8Kjq7VnQ44YT","name":"Glob","input":{"pattern":"modules/**/*.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":14793,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":14793,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"type":"assistant","uuid":"49ead350-72c8-4f16-9349-54092389cd31","timestamp":"2025-11-25T19:08:57.552Z"}
{"parentUuid":"49ead350-72c8-4f16-9349-54092389cd31","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01E7Ex1qk1JoJzkE4qB3kLbi","type":"tool_result","content":"No files found"}]},"uuid":"cf0259e7-9b21-4540-ba7c-3ceb93817e6e","timestamp":"2025-11-25T19:08:58.214Z","toolUseResult":{"filenames":[],"durationMs":633,"numFiles":0,"truncated":false}}
{"parentUuid":"cf0259e7-9b21-4540-ba7c-3ceb93817e6e","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SfekFvCvjkAiVgX6N14dcp","type":"tool_result","content":"/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/gemeng2-0.7.0/modules/glm/client.py\n/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/gemeng2-0.7.0/modules/glm/manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/gemeng2-0.7.0/modules/repository/manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/gemeng2-0.7.0/modules/seedance/client.py\n/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/gemeng2-0.7.0/modules/seedance/manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/gemeng2-0.7.0/modules/seedream/client.py\n/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/gemeng2-0.7.0/modules/seedream/manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/modules/glm/client.py\n/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/modules/glm/manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/modules/repository/manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/modules/seedance/client.py\n/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/modules/seedance/manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/modules/seedream/client.py\n/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/modules/seedream/manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/volc.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/repository/manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/seedance/manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/client.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/seedance/client.py"}]},"uuid":"e9de8e77-cd4d-4ecb-a9d1-320922f7b2d7","timestamp":"2025-11-25T19:08:58.344Z","toolUseResult":{"filenames":["/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/gemeng2-0.7.0/modules/glm/client.py","/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/gemeng2-0.7.0/modules/glm/manager.py","/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/gemeng2-0.7.0/modules/repository/manager.py","/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/gemeng2-0.7.0/modules/seedance/client.py","/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/gemeng2-0.7.0/modules/seedance/manager.py","/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/gemeng2-0.7.0/modules/seedream/client.py","/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/gemeng2-0.7.0/modules/seedream/manager.py","/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/modules/glm/client.py","/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/modules/glm/manager.py","/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/modules/repository/manager.py","/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/modules/seedance/client.py","/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/modules/seedance/manager.py","/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/modules/seedream/client.py","/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/modules/seedream/manager.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/volc.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/repository/manager.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/seedance/manager.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/manager.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/client.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/seedance/client.py"],"durationMs":763,"numFiles":20,"truncated":false}}
{"parentUuid":"e9de8e77-cd4d-4ecb-a9d1-320922f7b2d7","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019C8BCyXepp8Kjq7VnQ44YT","type":"tool_result","content":"/Users/yunchang/Documents/GitHub/gemeng2/modules/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/config/config_manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/base.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/factory.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/schema.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/volc.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/volc_v4.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/repository/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/repository/csv_handler.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/repository/manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/repository/sqlite_handler.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/seedance/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/seedance/config.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/seedance/manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/storage/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/storage/storage_manager_factory.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/storage/unified_storage_manager_v2.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/utils/error_handler.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/utils/progress_tracker.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/utils/safe_requests.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/client.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/seedance/client.py"}]},"uuid":"9b34ff14-8d0e-4ecb-9208-f1251c1becd4","timestamp":"2025-11-25T19:08:58.521Z","toolUseResult":{"filenames":["/Users/yunchang/Documents/GitHub/gemeng2/modules/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/config/config_manager.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/base.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/factory.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/schema.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/volc.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/volc_v4.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/repository/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/repository/csv_handler.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/repository/manager.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/repository/sqlite_handler.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/seedance/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/seedance/config.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/seedance/manager.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/manager.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/storage/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/storage/storage_manager_factory.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/storage/unified_storage_manager_v2.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/utils/error_handler.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/utils/progress_tracker.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/utils/safe_requests.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/client.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/seedance/client.py"],"durationMs":940,"numFiles":25,"truncated":false}}
{"parentUuid":"9b34ff14-8d0e-4ecb-9208-f1251c1becd4","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01K3DFA1kjCYvXUsw4GEmGjY","type":"message","role":"assistant","content":[{"type":"text","text":"现在读取关键文件："}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1511,"cache_read_input_tokens":14793,"cache_creation":{"ephemeral_5m_input_tokens":1511,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"2790b76a-687e-4709-8871-75e8d937f09a","timestamp":"2025-11-25T19:09:01.730Z"}
{"parentUuid":"2790b76a-687e-4709-8871-75e8d937f09a","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01K3DFA1kjCYvXUsw4GEmGjY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PgoFXm6Bbw6jcTbKW6JMzu","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/client.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1511,"cache_read_input_tokens":14793,"cache_creation":{"ephemeral_5m_input_tokens":1511,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"1bfb6295-29d5-4371-b850-c358d04f5c7d","timestamp":"2025-11-25T19:09:01.962Z"}
{"parentUuid":"1bfb6295-29d5-4371-b850-c358d04f5c7d","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01K3DFA1kjCYvXUsw4GEmGjY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Kgnr2wDhRnLiW8cKEuTQNm","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/manager.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1511,"cache_read_input_tokens":14793,"cache_creation":{"ephemeral_5m_input_tokens":1511,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"f43927e7-bf36-4a95-95be-7ded54bc928b","timestamp":"2025-11-25T19:09:02.187Z"}
{"parentUuid":"f43927e7-bf36-4a95-95be-7ded54bc928b","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01K3DFA1kjCYvXUsw4GEmGjY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Azx9T9xksTSZkKmixbBbnT","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/volc.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1511,"cache_read_input_tokens":14793,"cache_creation":{"ephemeral_5m_input_tokens":1511,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"5783139b-a0bc-4405-a95a-e7ff5f3e7b67","timestamp":"2025-11-25T19:09:02.315Z"}
{"parentUuid":"5783139b-a0bc-4405-a95a-e7ff5f3e7b67","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Azx9T9xksTSZkKmixbBbnT","type":"tool_result","content":"     1→#!/usr/bin/env python3\n     2→# -*- coding: utf-8 -*-\n     3→\"\"\"\n     4→Volc (Ark) Provider 映射（最小实现）\n     5→\n     6→职责：将统一 Schema 归一化后的参数映射到当前 Ark v3 的请求载荷/文本 flag。\n     7→HTTP 请求仍在各自 Client 内执行。\n     8→\"\"\"\n     9→from typing import Dict, Any, Tuple\n    10→from .base import BaseProvider\n    11→from .schema import TextToImageParams, ImageToImageParams, VideoParams\n    12→try:\n    13→    # 复用现有模型 ID 定义，避免硬编码漂移\n    14→    from modules.seedance.config import SeedanceModels\n    15→except Exception:\n    16→    SeedanceModels = None\n    17→\n    18→\n    19→class VolcProvider(BaseProvider):\n    20→    name = \"volcengine\"\n    21→\n    22→    # Seedream 3.0/3.1 - 文生图\n    23→    def map_t2i(self, params: TextToImageParams) -> Tuple[Dict[str, Any], bool, str, str]:\n    24→        norm, fb, reason = self.validate_t2i(params)\n    25→        # 与当前实现保持一致：固定 watermark=False，response_format=url\n    26→        data = {\n    27→            \"model\": \"doubao-seedream-3-0-t2i-250415\",\n    28→            \"prompt\": norm.prompt,\n    29→            \"size\": norm.size,\n    30→            \"response_format\": \"url\",\n    31→            \"watermark\": False,\n    32→            \"guidance_scale\": norm.guidance_scale,\n    33→        }\n    34→        if norm.seed is not None:\n    35→            data[\"seed\"] = norm.seed\n    36→        return data, fb, reason, \"/images/generations\"\n    37→\n    38→    # Seedream 3.0/3.1 - 图生图\n    39→    def map_i2i(self, params: ImageToImageParams) -> Tuple[Dict[str, Any], bool, str, str]:\n    40→        norm, fb, reason = self.validate_i2i(params)\n    41→        data = {\n    42→            \"model\": \"doubao-seededit-3-0-i2i-250628\",\n    43→            \"prompt\": norm.prompt,\n    44→            \"image\": norm.image,\n    45→            \"size\": \"adaptive\",\n    46→            \"response_format\": \"url\",\n    47→            \"watermark\": False,\n    48→            \"guidance_scale\": norm.guidance_scale,\n    49→        }\n    50→        if norm.seed is not None:\n    51→            data[\"seed\"] = norm.seed\n    52→        return data, fb, reason, \"/images/generations\"\n    53→\n    54→    # Seedance pro/lite - 视频\n    55→    def map_video(self, params: VideoParams) -> Tuple[Dict[str, Any], bool, str, str, str]:\n    56→        norm, fb, reason, used_rs, used_rt = self.validate_video(params)\n    57→\n    58→        # 模型选择逻辑保持与现有实现一致\n    59→        if norm.first_frame_path and norm.last_frame_path:\n    60→            model = SeedanceModels.LITE_I2V.value if SeedanceModels else \"doubao-seedance-1-0-lite-i2v-250428\"\n    61→            mode = \"首尾帧视频(Lite)\"\n    62→        elif norm.use_pro_model:\n    63→            model = SeedanceModels.PRO.value if SeedanceModels else \"doubao-seedance-1-0-pro-250528\"\n    64→            mode = \"图生视频(Pro)\" if norm.image_path else \"文生视频(Pro)\"\n    65→        else:\n    66→            if norm.image_path:\n    67→                model = SeedanceModels.LITE_I2V.value if SeedanceModels else \"doubao-seedance-1-0-lite-i2v-250428\"\n    68→                mode = \"图生视频(Lite)\"\n    69→            else:\n    70→                model = SeedanceModels.LITE_T2V.value if SeedanceModels else \"doubao-seedance-1-0-lite-t2v-250428\"\n    71→                mode = \"文生视频(Lite)\"\n    72→\n    73→        # 文本 flags（与客户端 _validate_and_build_flags 顺序对齐）\n    74→        parts = [\n    75→            \"--rs\", used_rs,\n    76→            \"--rt\", used_rt,\n    77→            \"--dur\", str(norm.duration),\n    78→            \"--fps\", str(norm.fps),\n    79→            \"--wm\", str(bool(norm.watermark)).lower(),\n    80→        ]\n    81→        if norm.seed is not None:\n    82→            parts += [\"--seed\", str(norm.seed)]\n    83→        parts += [\"--cf\", str(bool(norm.camera_fixed)).lower()]\n    84→        flags_text = \" \".join(parts)\n    85→\n    86→        content = []\n    87→        if norm.first_frame_path and norm.last_frame_path:\n    88→            content.append({\n    89→                \"type\": \"image_url\",\n    90→                \"image_url\": {\"url\": norm.first_frame_path},\n    91→                \"role\": \"first_frame\"\n    92→            })\n    93→            content.append({\n    94→                \"type\": \"image_url\",\n    95→                \"image_url\": {\"url\": norm.last_frame_path},\n    96→                \"role\": \"last_frame\"\n    97→            })\n    98→        elif norm.image_path:\n    99→            content.append({\n   100→                \"type\": \"image_url\",\n   101→                \"image_url\": {\"url\": norm.image_path},\n   102→                \"role\": \"first_frame\"\n   103→            })\n   104→\n   105→        text_prompt = f\"{norm.prompt} {flags_text}\".strip()\n   106→        content.append({\"type\": \"text\", \"text\": text_prompt})\n   107→\n   108→        mapped = {\n   109→            \"model\": model,\n   110→            \"content\": content,\n   111→            \"mode\": mode,\n   112→            \"flags_text\": flags_text,\n   113→        }\n   114→        return mapped, fb, reason, used_rs, used_rt\n   115→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"ddb051db-315f-4317-9ab6-fcfb3f347b54","timestamp":"2025-11-25T19:09:02.386Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/volc.py","content":"#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n\"\"\"\nVolc (Ark) Provider 映射（最小实现）\n\n职责：将统一 Schema 归一化后的参数映射到当前 Ark v3 的请求载荷/文本 flag。\nHTTP 请求仍在各自 Client 内执行。\n\"\"\"\nfrom typing import Dict, Any, Tuple\nfrom .base import BaseProvider\nfrom .schema import TextToImageParams, ImageToImageParams, VideoParams\ntry:\n    # 复用现有模型 ID 定义，避免硬编码漂移\n    from modules.seedance.config import SeedanceModels\nexcept Exception:\n    SeedanceModels = None\n\n\nclass VolcProvider(BaseProvider):\n    name = \"volcengine\"\n\n    # Seedream 3.0/3.1 - 文生图\n    def map_t2i(self, params: TextToImageParams) -> Tuple[Dict[str, Any], bool, str, str]:\n        norm, fb, reason = self.validate_t2i(params)\n        # 与当前实现保持一致：固定 watermark=False，response_format=url\n        data = {\n            \"model\": \"doubao-seedream-3-0-t2i-250415\",\n            \"prompt\": norm.prompt,\n            \"size\": norm.size,\n            \"response_format\": \"url\",\n            \"watermark\": False,\n            \"guidance_scale\": norm.guidance_scale,\n        }\n        if norm.seed is not None:\n            data[\"seed\"] = norm.seed\n        return data, fb, reason, \"/images/generations\"\n\n    # Seedream 3.0/3.1 - 图生图\n    def map_i2i(self, params: ImageToImageParams) -> Tuple[Dict[str, Any], bool, str, str]:\n        norm, fb, reason = self.validate_i2i(params)\n        data = {\n            \"model\": \"doubao-seededit-3-0-i2i-250628\",\n            \"prompt\": norm.prompt,\n            \"image\": norm.image,\n            \"size\": \"adaptive\",\n            \"response_format\": \"url\",\n            \"watermark\": False,\n            \"guidance_scale\": norm.guidance_scale,\n        }\n        if norm.seed is not None:\n            data[\"seed\"] = norm.seed\n        return data, fb, reason, \"/images/generations\"\n\n    # Seedance pro/lite - 视频\n    def map_video(self, params: VideoParams) -> Tuple[Dict[str, Any], bool, str, str, str]:\n        norm, fb, reason, used_rs, used_rt = self.validate_video(params)\n\n        # 模型选择逻辑保持与现有实现一致\n        if norm.first_frame_path and norm.last_frame_path:\n            model = SeedanceModels.LITE_I2V.value if SeedanceModels else \"doubao-seedance-1-0-lite-i2v-250428\"\n            mode = \"首尾帧视频(Lite)\"\n        elif norm.use_pro_model:\n            model = SeedanceModels.PRO.value if SeedanceModels else \"doubao-seedance-1-0-pro-250528\"\n            mode = \"图生视频(Pro)\" if norm.image_path else \"文生视频(Pro)\"\n        else:\n            if norm.image_path:\n                model = SeedanceModels.LITE_I2V.value if SeedanceModels else \"doubao-seedance-1-0-lite-i2v-250428\"\n                mode = \"图生视频(Lite)\"\n            else:\n                model = SeedanceModels.LITE_T2V.value if SeedanceModels else \"doubao-seedance-1-0-lite-t2v-250428\"\n                mode = \"文生视频(Lite)\"\n\n        # 文本 flags（与客户端 _validate_and_build_flags 顺序对齐）\n        parts = [\n            \"--rs\", used_rs,\n            \"--rt\", used_rt,\n            \"--dur\", str(norm.duration),\n            \"--fps\", str(norm.fps),\n            \"--wm\", str(bool(norm.watermark)).lower(),\n        ]\n        if norm.seed is not None:\n            parts += [\"--seed\", str(norm.seed)]\n        parts += [\"--cf\", str(bool(norm.camera_fixed)).lower()]\n        flags_text = \" \".join(parts)\n\n        content = []\n        if norm.first_frame_path and norm.last_frame_path:\n            content.append({\n                \"type\": \"image_url\",\n                \"image_url\": {\"url\": norm.first_frame_path},\n                \"role\": \"first_frame\"\n            })\n            content.append({\n                \"type\": \"image_url\",\n                \"image_url\": {\"url\": norm.last_frame_path},\n                \"role\": \"last_frame\"\n            })\n        elif norm.image_path:\n            content.append({\n                \"type\": \"image_url\",\n                \"image_url\": {\"url\": norm.image_path},\n                \"role\": \"first_frame\"\n            })\n\n        text_prompt = f\"{norm.prompt} {flags_text}\".strip()\n        content.append({\"type\": \"text\", \"text\": text_prompt})\n\n        mapped = {\n            \"model\": model,\n            \"content\": content,\n            \"mode\": mode,\n            \"flags_text\": flags_text,\n        }\n        return mapped, fb, reason, used_rs, used_rt\n","numLines":115,"startLine":1,"totalLines":115}}}
{"parentUuid":"ddb051db-315f-4317-9ab6-fcfb3f347b54","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PgoFXm6Bbw6jcTbKW6JMzu","type":"tool_result","content":"     1→# Seedream图像生成客户端\n     2→# 封装火山引擎Seedream3.0 API调用\n     3→\n     4→import json\n     5→import os\n     6→import requests\n     7→import time\n     8→import random\n     9→from typing import Dict, Any, Optional, List\n    10→from pathlib import Path\n    11→from loguru import logger\n    12→from urllib3.util.retry import Retry\n    13→from requests.adapters import HTTPAdapter\n    14→\n    15→# 导入配置管理器和错误处理\n    16→from config.unified_config import get_unified_config\n    17→from modules.utils.error_handler import ErrorHandler, AppError, error_handler, RetryHandler, ErrorType\n    18→\n    19→\n    20→class SeedreamClient:\n    21→    \"\"\"火山引擎Seedream图片生成客户端\n    22→\n    23→    提供文生图和图生图功能\n    24→    \"\"\"\n    25→\n    26→    def __init__(\n    27→        self,\n    28→        api_key: Optional[str] = None,\n    29→        base_url: str = \"https://ark.cn-beijing.volces.com/api/v3\",\n    30→        model_id: str = \"doubao-seedream-3-0-t2i-250415\",\n    31→        timeout: int = 60,\n    32→        max_retries: int = 3,\n    33→    ):\n    34→        \"\"\"初始化Seedream客户端\n    35→\n    36→        Args:\n    37→            api_key: 火山引擎API密钥，如果为None则从配置管理器获取\n    38→            base_url: API基础URL\n    39→            timeout: 请求超时时间（秒）\n    40→            max_retries: 最大重试次数\n    41→        \"\"\"\n    42→        # 获取API密钥\n    43→        if api_key is None:\n    44→            try:\n    45→                api_key = get_unified_config().get_api_key(\"volcengine\")\n    46→            except Exception as exc:\n    47→                raise AppError(str(exc), ErrorHandler.ErrorType.AUTH_ERROR) from exc\n    48→\n    49→        self.api_key = api_key\n    50→        self.base_url = base_url.rstrip(\"/\")\n    51→        self.model_id = model_id or \"doubao-seedream-3-0-t2i-250415\"\n    52→        self.timeout = timeout\n    53→        self.max_retries = max_retries\n    54→\n    55→        # 配置会话\n    56→        self.session = requests.Session()\n    57→\n    58→        # 配置重试策略\n    59→        retry_strategy = Retry(\n    60→            total=max_retries,\n    61→            status_forcelist=[429, 500, 502, 503, 504],\n    62→            allowed_methods=[\"HEAD\", \"GET\", \"POST\"],\n    63→            backoff_factor=1\n    64→        )\n    65→\n    66→        adapter = HTTPAdapter(max_retries=retry_strategy)\n    67→        self.session.mount(\"http://\", adapter)\n    68→        self.session.mount(\"https://\", adapter)\n    69→\n    70→        logger.info(\"Seedream客户端初始化完成\")\n    71→\n    72→        # 初始化性能监控与错误缓存（统一结构）\n    73→        self._performance_stats = {\n    74→            \"total_requests\": 0,\n    75→            \"successful_requests\": 0,\n    76→            \"failed_requests\": 0,\n    77→            \"total_response_time\": 0.0,\n    78→            \"last_request_time\": None,\n    79→        }\n    80→        self._last_error: Dict[str, Any] = {\"code\": None, \"message\": None}\n    81→        self._last_provider: Optional[str] = None\n    82→        self._last_endpoint: Optional[str] = None\n    83→\n    84→    def _encode_image(self, image_path: str) -> str:\n    85→        \"\"\"将图像文件编码为base64字符串\n    86→        \n    87→        Args:\n    88→            image_path: 图像文件路径\n    89→            \n    90→        Returns:\n    91→            base64编码的图像字符串\n    92→        \"\"\"\n    93→        import base64\n    94→        \n    95→        try:\n    96→            with open(image_path, 'rb') as image_file:\n    97→                image_data = image_file.read()\n    98→                base64_string = base64.b64encode(image_data).decode('utf-8')\n    99→                return base64_string\n   100→        except Exception as e:\n   101→            # 避免在日志中显示可能包含base64数据的异常信息\n   102→            error_msg = str(e)\n   103→            if len(error_msg) > 200:\n   104→                error_msg = error_msg[:200] + \"...[错误信息过长，已截断]\"\n   105→            logger.error(f\"图像编码失败: {error_msg}\")\n   106→            raise AppError(f\"图像编码失败: 文件处理错误\", ErrorHandler.ErrorType.FILE_ERROR)\n   107→\n   108→    def _get_headers(self) -> Dict[str, str]:\n   109→        \"\"\"获取请求头\"\"\"\n   110→        # 验证API密钥，防止尺寸配置被错误使用\n   111→        api_key = str(self.api_key).strip()\n   112→\n   113→        # 检查 API key 是否为纯 ASCII（HTTP headers 必须是 latin-1 可编码的）\n   114→        try:\n   115→            api_key.encode('ascii')\n   116→        except UnicodeEncodeError:\n   117→            raise ValueError(f\"API密钥包含非ASCII字符（如中文），请检查配置是否正确: {api_key[:20]}...\")\n   118→\n   119→        # 检查是否包含尺寸信息或换行符\n   120→        if any(indicator in api_key for indicator in [\"x\", \":\", \"\\n\", \"2048\", \"1024\", \"1:1\", \"4:3\", \"16:9\"]):\n   121→            raise ValueError(f\"API密钥格式错误，包含尺寸配置信息: {api_key[:50]}...\")\n   122→\n   123→        # 检查API密钥长度\n   124→        if len(api_key) < 10 or len(api_key) > 200:\n   125→            raise ValueError(f\"API密钥长度异常: {len(api_key)} 字符\")\n   126→        \n   127→        return {\n   128→            \"Authorization\": f\"Bearer {api_key}\",\n   129→            \"Content-Type\": \"application/json; charset=utf-8\",\n   130→            \"User-Agent\": \"Seedream-Client/1.0.0\",\n   131→        }\n   132→\n   133→    def _safe_json_post(self, url: str, headers: Dict[str, str], data: Dict[str, Any], timeout: int = 60):\n   134→        \"\"\"安全的 JSON POST 请求，手动编码避免 PyInstaller latin-1 问题\"\"\"\n   135→        body = json.dumps(data, ensure_ascii=False).encode(\"utf-8\")\n   136→        return self.session.post(url, headers=headers, data=body, timeout=timeout)\n   137→\n   138→    def _provider_enabled(self) -> bool:\n   139→        try:\n   140→            import os\n   141→            v = (os.environ.get(\"GEMENG_PROVIDER_ENABLED\", \"1\") or \"1\").lower().strip()\n   142→            return v not in {\"0\", \"false\", \"no\"}\n   143→        except Exception:\n   144→            return True\n   145→\n   146→    def _get_seedream_provider_order(self) -> List[str]:\n   147→        order: List[str] = []\n   148→        try:\n   149→            env_value = os.environ.get(\"GEMENG_SEEDREAM_PROVIDER\", \"volc_v3\")\n   150→        except Exception:\n   151→            env_value = \"volc_v3\"\n   152→        candidates = [env_value]\n   153→        for candidate in candidates:\n   154→            if not candidate:\n   155→                continue\n   156→            name = candidate.strip().lower()\n   157→            if not name:\n   158→                continue\n   159→            if name not in order:\n   160→                order.append(name)\n   161→        if \"volc_v3\" not in order:\n   162→            order.append(\"volc_v3\")\n   163→        return order\n   164→\n   165→    def _call_seedream_provider(self, headers: Dict[str, str], mapper, operation: str):\n   166→        from modules.provider.factory import get_default_provider\n   167→        default_endpoint = \"/images/generations\"\n   168→        base_url = self.base_url.rstrip(\"/\")\n   169→        first_choice = None\n   170→        last_error: Optional[BaseException] = None\n   171→        order = self._get_seedream_provider_order()\n   172→        if order:\n   173→            first_choice = order[0]\n   174→        for idx, name in enumerate(order):\n   175→            try:\n   176→                provider = get_default_provider(name)\n   177→            except Exception as e:\n   178→                logger.warning(f\"Seedream provider加载失败: {name} ({e})\")\n   179→                last_error = e\n   180→                continue\n   181→            try:\n   182→                mapped = mapper(provider)\n   183→                if not isinstance(mapped, tuple):\n   184→                    raise ValueError(\"provider mapper 返回值异常\")\n   185→                if len(mapped) == 4:\n   186→                    payload, fb, reason, endpoint = mapped\n   187→                elif len(mapped) == 3:\n   188→                    payload, fb, reason = mapped\n   189→                    endpoint = default_endpoint\n   190→                else:\n   191→                    raise ValueError(\"provider mapper 返回值长度不受支持\")\n   192→            except Exception as e:\n   193→                logger.warning(f\"Seedream provider参数映射失败: {name} ({e})\")\n   194→                last_error = e\n   195→                continue\n   196→            start_time = time.time()\n   197→            try:\n   198→                endpoint_path = endpoint or default_endpoint\n   199→                if isinstance(endpoint_path, str) and endpoint_path.startswith(\"http\"):\n   200→                    request_url = endpoint_path\n   201→                else:\n   202→                    normalized = endpoint_path if isinstance(endpoint_path, str) else default_endpoint\n   203→                    if not normalized.startswith(\"/\"):\n   204→                        normalized = f\"/{normalized}\"\n   205→                    request_url = f\"{base_url}{normalized}\"\n   206→                response = self._safe_json_post(request_url, headers, payload, timeout=60)\n   207→                result = self._handle_response(response)\n   208→                elapsed = time.time() - start_time\n   209→                if idx > 0 and first_choice:\n   210→                    logger.warning(f\"Seedream provider {first_choice} 回退至 {name}\")\n   211→                if fb and reason:\n   212→                    logger.warning(f\"参数回退: {reason}\")\n   213→                logger.info(\n   214→                    f\"摘要|operation={operation}_provider provider={name} endpoint={endpoint_path} elapsed={elapsed:.2f}s fallback={'yes' if fb else 'no'}\"\n   215→                )\n   216→                self._last_provider = name\n   217→                self._last_endpoint = endpoint_path if isinstance(endpoint_path, str) else default_endpoint\n   218→                return result, payload, endpoint_path, name, fb, reason, elapsed\n   219→            except AppError as e:\n   220→                last_error = e\n   221→                logger.warning(f\"Seedream provider {name} 请求失败: {e.message}\")\n   222→                continue\n   223→            except Exception as e:\n   224→                last_error = e\n   225→                logger.warning(f\"Seedream provider {name} 请求异常: {e}\")\n   226→                continue\n   227→        raise last_error or RuntimeError(\"Seedream provider 调用失败\")\n   228→\n   229→    def _log_seedream_event(\n   230→        self,\n   231→        operation: str,\n   232→        status: str,\n   233→        provider: Optional[str],\n   234→        endpoint: Optional[str],\n   235→        elapsed: float,\n   236→        fallback_applied: bool,\n   237→        fallback_reason: Optional[str] = None,\n   238→        extra: Optional[Dict[str, Any]] = None,\n   239→    ) -> None:\n   240→        try:\n   241→            provider_name = provider or \"unknown\"\n   242→            endpoint_text = endpoint or \"/images/generations\"\n   243→            parts = [\n   244→                f\"operation={operation}\",\n   245→                f\"status={status}\",\n   246→                f\"provider={provider_name}\",\n   247→                f\"endpoint={endpoint_text}\",\n   248→                f\"elapsed={elapsed:.2f}s\",\n   249→                f\"fallback={'yes' if fallback_applied else 'no'}\",\n   250→            ]\n   251→            if fallback_applied and fallback_reason:\n   252→                safe_reason = str(fallback_reason)\n   253→                if len(safe_reason) > 120:\n   254→                    safe_reason = safe_reason[:120] + \"...\"\n   255→                parts.append(f\"fallback_reason={safe_reason}\")\n   256→            if extra:\n   257→                for key, value in extra.items():\n   258→                    if value is None:\n   259→                        continue\n   260→                    parts.append(f\"{key}={value}\")\n   261→            logger.info(\"摘要|\" + \" \".join(parts))\n   262→        except Exception:\n   263→            # 保证日志逻辑不会影响主流程\n   264→            pass\n   265→\n   266→    @staticmethod\n   267→    def _wrap_base64_as_data_url(b64_data: str, path_hint: Optional[str] = None) -> str:\n   268→        mime = \"image/png\"\n   269→        try:\n   270→            if path_hint:\n   271→                suffix = Path(path_hint).suffix.lower()\n   272→                if suffix in {\".jpg\", \".jpeg\"}:\n   273→                    mime = \"image/jpeg\"\n   274→                elif suffix == \".webp\":\n   275→                    mime = \"image/webp\"\n   276→                elif suffix == \".bmp\":\n   277→                    mime = \"image/bmp\"\n   278→                elif suffix == \".gif\":\n   279→                    mime = \"image/gif\"\n   280→        except Exception:\n   281→            pass\n   282→        return f\"data:{mime};base64,{b64_data}\"\n   283→\n   284→    def _handle_response(self, response: requests.Response) -> Dict[str, Any]:\n   285→        \"\"\"处理API响应\n   286→\n   287→        Args:\n   288→            response: HTTP响应对象\n   289→\n   290→        Returns:\n   291→            解析后的响应数据\n   292→\n   293→        Raises:\n   294→            AppError: 当API返回错误时\n   295→        \"\"\"\n   296→        try:\n   297→            if not response.ok:\n   298→                try:\n   299→                    error_text = (response.content or b\"\").decode(response.encoding or 'utf-8', errors='ignore')\n   300→                except Exception:\n   301→                    error_text = str(response.content[:500])\n   302→                # 避免在日志中显示可能包含base64数据的完整响应\n   303→                if len(error_text) > 500:\n   304→                    error_summary = error_text[:500] + \"...[响应过长，已截断]\"\n   305→                else:\n   306→                    error_summary = error_text\n   307→                logger.error(f\"API请求失败 - 状态码: {response.status_code}, 响应: {error_summary}\")\n   308→                raise AppError(\n   309→                    f\"API请求失败 (状态码: {response.status_code}): {error_summary}\",\n   310→                    ErrorType.API_ERROR,\n   311→                    {\"status_code\": response.status_code, \"response_text\": error_summary}\n   312→                )\n   313→\n   314→            # 解析响应（增强容错：包括编码问题回退）\n   315→            try:\n   316→                result = response.json()\n   317→            except (json.JSONDecodeError, UnicodeDecodeError) as e:\n   318→                raw = response.content or b\"\"\n   319→                tried = set()\n   320→                result = None\n   321→                for enc in [response.encoding, \"utf-8\", \"utf-8-sig\", \"gb18030\"]:\n   322→                    if not enc or enc in tried:\n   323→                        continue\n   324→                    tried.add(enc)\n   325→                    try:\n   326→                        text = raw.decode(enc, errors=\"strict\")\n   327→                        result = json.loads(text)\n   328→                        logger.debug(f\"Seedream _handle_response - 通过备用编码解析成功: {enc}\")\n   329→                        break\n   330→                    except Exception:\n   331→                        continue\n   332→                if result is None:\n   333→                    try:\n   334→                        preview = raw.decode(\"utf-8\", errors=\"ignore\")[:200]\n   335→                    except Exception:\n   336→                        preview = str(raw[:200])\n   337→                    logger.error(f\"Seedream _handle_response - JSON解析失败(编码问题): {preview}\")\n   338→                    raise Exception(f\"响应格式错误: 无法解析JSON - {str(e)}\")\n   339→\n   340→            # OpenAI格式的响应检查\n   341→            if \"data\" not in result:\n   342→                error_msg = result.get(\"error\", {}).get(\"message\", \"未知错误\")\n   343→                logger.error(f\"Seedream API错误: {error_msg}\")\n   344→                raise AppError(\n   345→                    f\"API错误: {error_msg}\",\n   346→                    ErrorHandler.ErrorType.API_ERROR,\n   347→                    {\"response_data\": result},\n   348→                )\n   349→\n   350→            # 转换为统一格式，只保留URL数据，避免base64数据造成终端乱码\n   351→            images = []\n   352→            for item in result[\"data\"]:\n   353→                if \"url\" in item:\n   354→                    images.append({\n   355→                        \"url\": item[\"url\"]\n   356→                        # 注意：不再包含b64_json字段，避免base64数据在日志中显示造成乱码\n   357→                    })\n   358→\n   359→            return {\n   360→                \"code\": 200,\n   361→                \"message\": \"success\",\n   362→                \"data\": {\n   363→                    \"images\": images\n   364→                },\n   365→                \"created\": result.get(\"created\"),\n   366→                \"usage\": result.get(\"usage\", {})\n   367→            }\n   368→\n   369→        except requests.exceptions.RequestException as e:\n   370→            raise ErrorHandler.handle_network_error(e, \"火山引擎Seedream\")\n   371→        except json.JSONDecodeError as e:\n   372→            raise ErrorHandler.handle_unknown_error(e, \"火山引擎Seedream响应解析\")\n   373→\n   374→    def _record_request_stats(\n   375→        self,\n   376→        operation: str,\n   377→        success: bool,\n   378→        response_time: float,\n   379→        error_code: Optional[str] = None,\n   380→        error_message: Optional[str] = None,\n   381→    ) -> None:\n   382→        \"\"\"记录统一性能统计并缓存最近错误摘要（不含敏感详情）。\"\"\"\n   383→        try:\n   384→            self._performance_stats[\"total_requests\"] += 1\n   385→            self._performance_stats[\"total_response_time\"] += max(0.0, float(response_time))\n   386→            self._performance_stats[\"last_request_time\"] = time.time()\n   387→            if success:\n   388→                self._performance_stats[\"successful_requests\"] += 1\n   389→            else:\n   390→                self._performance_stats[\"failed_requests\"] += 1\n   391→                if error_code or error_message:\n   392→                    self._last_error = {\"code\": error_code, \"message\": str(error_message)[:200]}\n   393→\n   394→            # 调试日志（安全版）\n   395→            total = max(1, self._performance_stats[\"total_requests\"])\n   396→            avg = self._performance_stats[\"total_response_time\"] / total\n   397→            succ = self._performance_stats[\"successful_requests\"]\n   398→            success_rate = (succ / total) * 100.0\n   399→            logger.debug(\n   400→                f\"{operation} 统计: 响应时间={response_time:.2f}s, 平均={avg:.2f}s, 成功率={success_rate:.1f}%\"\n   401→            )\n   402→        except Exception:\n   403→            # 统计不应影响业务流程\n   404→            pass\n   405→\n   406→    def get_performance_stats(self) -> Dict[str, Any]:\n   407→        \"\"\"获取统一性能统计（字段统一）。\"\"\"\n   408→        stats = dict(self._performance_stats)\n   409→        total = stats.get(\"total_requests\", 0) or 0\n   410→        if total > 0:\n   411→            avg = stats.get(\"total_response_time\", 0.0) / total\n   412→            success_rate = (stats.get(\"successful_requests\", 0) / total) * 100.0\n   413→        else:\n   414→            avg = 0.0\n   415→            success_rate = 0.0\n   416→        return {\n   417→            \"total_requests\": total,\n   418→            \"successful_requests\": stats.get(\"successful_requests\", 0),\n   419→            \"failed_requests\": stats.get(\"failed_requests\", 0),\n   420→            \"avg_response_time\": avg,\n   421→            \"success_rate\": success_rate,\n   422→            \"last_error\": dict(self._last_error) if self._last_error else {\"code\": None, \"message\": None},\n   423→        }\n   424→\n   425→    def dump_metrics(self) -> Dict[str, Any]:\n   426→        \"\"\"导出诊断可读的统一指标。\"\"\"\n   427→        m = self.get_performance_stats()\n   428→        m.update({\n   429→            \"client\": \"Seedream\",\n   430→            \"model\": self.model_id,\n   431→            \"base_url\": self.base_url,\n   432→        })\n   433→        return m\n   434→\n   435→    def last_provider(self) -> Optional[str]:\n   436→        \"\"\"返回最近一次成功调用所使用的 provider 名称。\"\"\"\n   437→        return self._last_provider\n   438→\n   439→    def last_endpoint(self) -> Optional[str]:\n   440→        \"\"\"返回最近一次成功调用所使用的 endpoint。\"\"\"\n   441→        return self._last_endpoint\n   442→\n   443→    @error_handler(\"Seedream文生图\")\n   444→    @RetryHandler.retry_on_error(max_retries=3, delay=1.0)\n   445→    def text_to_image(\n   446→        self,\n   447→        prompt: str,\n   448→        size: str = \"1024x1024\",\n   449→        guidance_scale: float = 2.5,\n   450→        seed: Optional[int] = None,\n   451→        reference_images: Optional[List[Any]] = None,\n   452→    ) -> Dict[str, Any]:\n   453→        \"\"\"\n   454→        文生图API调用\n   455→\n   456→        Args:\n   457→            prompt: 图片描述提示词\n   458→            size: 图像尺寸，支持的尺寸见get_supported_sizes()\n   459→            guidance_scale: 引导强度，范围[1.0, 10.0]\n   460→            seed: 随机种子，范围[-1, 2147483647]，-1表示随机\n   461→            reference_images: 参考图列表（路径或URL），最多10张\n   462→            response_format: 返回格式，\"url\"或\"b64_json\"\n   463→\n   464→        Returns:\n   465→            API响应结果\n   466→\n   467→        Raises:\n   468→            AppError: 当API调用失败时\n   469→        \"\"\"\n   470→        headers = self._get_headers()\n   471→\n   472→        logger.info(f\"发送文生图请求: {prompt[:50]}...\")\n   473→\n   474→        if self._provider_enabled():\n   475→            try:\n   476→                from modules.provider.schema import TextToImageParams\n   477→\n   478→                result, data, endpoint_used, provider_used, fallback_applied, fallback_reason, response_time = self._call_seedream_provider(\n   479→                    headers,\n   480→                    lambda provider: provider.map_t2i(TextToImageParams(\n   481→                        prompt=prompt,\n   482→                        size=size,\n   483→                        guidance_scale=guidance_scale,\n   484→                        seed=(None if (seed is None or seed == -1) else seed),\n   485→                        reference_images=reference_images or []\n   486→                    )),\n   487→                    \"text_to_image\"\n   488→                )\n   489→                self._log_seedream_event(\n   490→                    \"text_to_image\",\n   491→                    \"success\",\n   492→                    provider_used,\n   493→                    endpoint_used,\n   494→                    response_time,\n   495→                    fallback_applied,\n   496→                    fallback_reason,\n   497→                    {\"size\": data.get(\"size\"), \"seed\": data.get(\"seed\")},\n   498→                )\n   499→                self._record_request_stats(\"text_to_image\", True, response_time, None, None)\n   500→                return result\n   501→            except Exception as provider_exc:\n   502→                logger.warning(f\"Seedream provider 路径失败，回退旧逻辑: {provider_exc}\")\n   503→\n   504→        success = False\n   505→        err_code: Optional[str] = None\n   506→        err_msg: Optional[str] = None\n   507→        start_time = time.time()\n   508→        try:\n   509→            if not self.validate_image_size(size):\n   510→                raise AppError(f\"不支持的图像尺寸: {size}\", ErrorType.VALIDATION_ERROR)\n   511→            if not (1.0 <= guidance_scale <= 10.0):\n   512→                raise AppError(f\"guidance_scale必须在1.0-10.0范围内，当前值: {guidance_scale}\", ErrorType.VALIDATION_ERROR)\n   513→            if seed is not None and not (-1 <= seed <= 2147483647):\n   514→                raise AppError(f\"seed必须在-1到2147483647范围内，当前值: {seed}\", ErrorType.VALIDATION_ERROR)\n   515→\n   516→            data = {\n   517→                \"model\": \"doubao-seedream-3-0-t2i-250415\",\n   518→                \"prompt\": prompt,\n   519→                \"size\": size,\n   520→                \"response_format\": \"url\",\n   521→                \"watermark\": False,  # 正式版固定禁用水印\n   522→                \"guidance_scale\": guidance_scale,\n   523→            }\n   524→            if seed is not None:\n   525→                data[\"seed\"] = seed\n   526→\n   527→            if reference_images:\n   528→                images_payload = []\n   529→                for item in reference_images:\n   530→                    try:\n   531→                        if isinstance(item, str):\n   532→                            if item.startswith(\"data:image/\"):\n   533→                                images_payload.append(item)\n   534→                                continue\n   535→                            p = Path(item)\n   536→                            if p.exists():\n   537→                                encoded = self._encode_image(str(p))\n   538→                                images_payload.append(self._wrap_base64_as_data_url(encoded, str(p)))\n   539→                            elif item.startswith(\"http://\") or item.startswith(\"https://\"):\n   540→                                images_payload.append(item)\n   541→                        elif isinstance(item, dict):\n   542→                            payload = item.get('_payload_b64') or item.get('data') or item.get('value')\n   543→                            path_hint = item.get('path') or item.get('source')\n   544→                            if payload:\n   545→                                images_payload.append(self._wrap_base64_as_data_url(payload, path_hint))\n   546→                            else:\n   547→                                path_val = item.get('path')\n   548→                                if path_val:\n   549→                                    p = Path(path_val)\n   550→                                    if p.exists():\n   551→                                        encoded = self._encode_image(str(p))\n   552→                                        images_payload.append(self._wrap_base64_as_data_url(encoded, str(p)))\n   553→                    except Exception as exc:\n   554→                        logger.warning(f\"参考图处理失败: {exc}\")\n   555→                if images_payload:\n   556→                    data[\"image\"] = images_payload if len(images_payload) > 1 else images_payload[0]\n   557→                    data[\"sequential_image_generation\"] = \"disabled\"\n   558→\n   559→            request_url = f\"{self.base_url.rstrip('/')}/images/generations\"\n   560→            response = self._safe_json_post(request_url, headers, data, timeout=60)\n   561→            result = self._handle_response(response)\n   562→            success = True\n   563→            elapsed = time.time() - start_time\n   564→            self._last_provider = \"legacy_v3\"\n   565→            self._last_endpoint = \"/images/generations\"\n   566→            self._log_seedream_event(\n   567→                \"text_to_image\",\n   568→                \"success\",\n   569→                \"legacy_v3\",\n   570→                \"/images/generations\",\n   571→                elapsed,\n   572→                False,\n   573→                None,\n   574→                {\"size\": data.get(\"size\"), \"seed\": data.get(\"seed\")},\n   575→            )\n   576→            return result\n   577→        except AppError as e:\n   578→            err_code = getattr(e, \"error_type\", ErrorType.API_ERROR).value\n   579→            err_msg = e.message\n   580→            safe_msg = (err_msg[:200] + \"...[错误信息过长，已截断]\") if err_msg and len(err_msg) > 200 else err_msg\n   581→            logger.error(f\"文生图请求失败: {safe_msg}\")\n   582→            raise\n   583→        except Exception as e:\n   584→            err_code = \"UNKNOWN_ERROR\"\n   585→            err_msg = str(e)\n   586→            safe_msg = (err_msg[:200] + \"...[错误信息过长，已截断]\") if err_msg and len(err_msg) > 200 else err_msg\n   587→            logger.error(f\"文生图请求失败: {safe_msg}\")\n   588→            raise Exception(f\"文生图API调用失败: {safe_msg}\")\n   589→        finally:\n   590→            elapsed = time.time() - start_time\n   591→            self._record_request_stats(\"text_to_image\", success, elapsed, err_code, err_msg)\n   592→\n   593→    @error_handler(\"Seedream图生图\")\n   594→    @RetryHandler.retry_on_error(max_retries=3, delay=1.0)\n   595→    def image_to_image(\n   596→        self,\n   597→        prompt: str,\n   598→        image: str,\n   599→        guidance_scale: float = 5.5,\n   600→        seed: Optional[int] = None,\n   601→        reference_images: Optional[List[str]] = None,\n   602→    ) -> Dict[str, Any]:\n   603→        \"\"\"\n   604→        图生图API调用\n   605→\n   606→        Args:\n   607→            prompt: 图片编辑提示词\n   608→            image: 输入图像URL或Base64编码\n   609→            guidance_scale: 引导强度，范围[1.0, 10.0]\n   610→            seed: 随机种子，范围[-1, 2147483647]，-1表示随机\n   611→            reference_images: 参考图列表（路径或URL），最多10张\n   612→            response_format: 返回格式，\"url\"或\"b64_json\"\n   613→            reference_images: 额外参考图（base64/url），Seedream 4.0 多参考图\n   614→\n   615→        Returns:\n   616→            API响应结果\n   617→\n   618→        Raises:\n   619→            AppError: 当API调用失败时\n   620→        \"\"\"\n   621→        headers = self._get_headers()\n   622→\n   623→        logger.info(f\"发送图生图请求: {prompt[:50]}...\")\n   624→\n   625→        if self._provider_enabled():\n   626→            try:\n   627→                from modules.provider.schema import ImageToImageParams\n   628→\n   629→                result, data, endpoint_used, provider_used, fallback_applied, fallback_reason, response_time = self._call_seedream_provider(\n   630→                    headers,\n   631→                    lambda provider: provider.map_i2i(ImageToImageParams(\n   632→                        prompt=prompt,\n   633→                        image=image,\n   634→                        guidance_scale=guidance_scale,\n   635→                        seed=(None if (seed is None or seed == -1) else seed),\n   636→                        reference_images=(reference_images or []),\n   637→                    )),\n   638→                    \"image_to_image\"\n   639→                )\n   640→                self._log_seedream_event(\n   641→                    \"image_to_image\",\n   642→                    \"success\",\n   643→                    provider_used,\n   644→                    endpoint_used,\n   645→                    response_time,\n   646→                    fallback_applied,\n   647→                    fallback_reason,\n   648→                    {\"seed\": data.get(\"seed\")},\n   649→                )\n   650→                self._record_request_stats(\"image_to_image\", True, response_time, None, None)\n   651→                return result\n   652→            except Exception as provider_exc:\n   653→                logger.warning(f\"Seedream provider 路径失败，回退旧逻辑: {provider_exc}\")\n   654→\n   655→        success = False\n   656→        err_code: Optional[str] = None\n   657→        err_msg: Optional[str] = None\n   658→        start_time = time.time()\n   659→        try:\n   660→            if not (1.0 <= guidance_scale <= 10.0):\n   661→                raise AppError(f\"guidance_scale必须在1.0-10.0范围内，当前值: {guidance_scale}\", ErrorType.VALIDATION_ERROR)\n   662→            if seed is not None and not (-1 <= seed <= 2147483647):\n   663→                raise AppError(f\"seed必须在-1到2147483647范围内，当前值: {seed}\", ErrorType.VALIDATION_ERROR)\n   664→\n   665→            data = {\n   666→                \"model\": \"doubao-seededit-3-0-i2i-250628\",\n   667→                \"prompt\": prompt,\n   668→                \"image\": image,\n   669→                \"size\": \"adaptive\",\n   670→                \"response_format\": \"url\",\n   671→                \"watermark\": False,  # 正式版固定禁用水印\n   672→                \"guidance_scale\": guidance_scale,\n   673→            }\n   674→            if seed is not None:\n   675→                data[\"seed\"] = seed\n   676→            if reference_images:\n   677→                logger.warning(\"Seedream 3.x 路径不支持多参考图，已忽略 reference_images\")\n   678→\n   679→            request_url = f\"{self.base_url.rstrip('/')}/images/generations\"\n   680→            response = self._safe_json_post(request_url, headers, data, timeout=60)\n   681→            result = self._handle_response(response)\n   682→            success = True\n   683→            elapsed = time.time() - start_time\n   684→            self._last_provider = \"legacy_v3\"\n   685→            self._last_endpoint = \"/images/generations\"\n   686→            self._log_seedream_event(\n   687→                \"image_to_image\",\n   688→                \"success\",\n   689→                \"legacy_v3\",\n   690→                \"/images/generations\",\n   691→                elapsed,\n   692→                False,\n   693→                None,\n   694→                {\"seed\": data.get(\"seed\")},\n   695→            )\n   696→            return result\n   697→        except AppError as e:\n   698→            err_code = getattr(e, \"error_type\", ErrorType.API_ERROR).value\n   699→            err_msg = e.message\n   700→            safe_msg = (err_msg[:200] + \"...[错误信息过长，已截断]\") if err_msg and len(err_msg) > 200 else err_msg\n   701→            logger.error(f\"图生图请求失败: {safe_msg}\")\n   702→            raise\n   703→        except Exception as e:\n   704→            err_code = \"UNKNOWN_ERROR\"\n   705→            err_msg = str(e)\n   706→            safe_msg = (err_msg[:200] + \"...[错误信息过长，已截断]\") if err_msg and len(err_msg) > 200 else err_msg\n   707→            logger.error(f\"图生图请求失败: {safe_msg}\")\n   708→            raise Exception(f\"图生图API调用失败: {safe_msg}\")\n   709→        finally:\n   710→            elapsed = time.time() - start_time\n   711→            self._record_request_stats(\"image_to_image\", success, elapsed, err_code, err_msg)\n   712→\n   713→    def batch_text_to_image(\n   714→        self, prompts: List[str], width: int = 1024, height: int = 1024, guidance_scale: float = 2.5\n   715→    ) -> List[Dict[str, Any]]:\n   716→        \"\"\"\n   717→        批量文生图：同时生成多张图片\n   718→\n   719→        Args:\n   720→            prompts: 提示词列表\n   721→            width: 图像宽度\n   722→            height: 图像高度\n   723→            guidance_scale: 提示词一致性\n   724→\n   725→        Returns:\n   726→            List[Dict]: 生成结果列表\n   727→        \"\"\"\n   728→        results = []\n   729→        logger.info(f\"开始批量文生图，共{len(prompts)}个任务\")\n   730→\n   731→        for i, prompt in enumerate(prompts, 1):\n   732→            logger.info(f\"处理第{i}/{len(prompts)}个任务\")\n   733→\n   734→            try:\n   735→                # 为每个任务生成不同的随机种子\n   736→                seed = random.randint(1, 2147483647)\n   737→\n   738→                result = self.text_to_image(\n   739→                    prompt=prompt, \n   740→                    width=width, \n   741→                    height=height, \n   742→                    guidance_scale=guidance_scale, \n   743→                    seed=seed\n   744→                )\n   745→\n   746→                results.append({\n   747→                    \"success\": True,\n   748→                    \"result\": result,\n   749→                    \"prompt\": prompt\n   750→                })\n   751→\n   752→            except Exception as e:\n   753→                # 避免在日志中显示过长的异常信息\n   754→                error_msg = str(e)\n   755→                if len(error_msg) > 200:\n   756→                    error_msg = error_msg[:200] + \"...[错误信息过长，已截断]\"\n   757→                logger.error(f\"第{i}个任务失败: {error_msg}\")\n   758→                results.append({\n   759→                    \"success\": False,\n   760→                    \"error\": error_msg,\n   761→                    \"prompt\": prompt\n   762→                })\n   763→\n   764→            # 避免请求过于频繁\n   765→            if i < len(prompts):\n   766→                time.sleep(0.5)\n   767→\n   768→        success_count = sum(1 for r in results if r[\"success\"])\n   769→        logger.info(f\"批量文生图完成，成功{success_count}/{len(prompts)}个\")\n   770→        return results\n   771→\n   772→    def validate_image_size(self, size: str) -> bool:\n   773→        \"\"\"\n   774→        验证图像尺寸是否支持\n   775→\n   776→        Args:\n   777→            size: 图像尺寸字符串，如 \"1024x1024\"\n   778→\n   779→        Returns:\n   780→            bool: 是否支持该尺寸\n   781→        \"\"\"\n   782→        try:\n   783→            # 解析尺寸字符串\n   784→            if 'x' not in size:\n   785→                return False\n   786→                \n   787→            width_str, height_str = size.split('x', 1)\n   788→            width = int(width_str)\n   789→            height = int(height_str)\n   790→            \n   791→            # 验证范围：Seedream 4.0 支持 512-4096像素\n   792→            return (512 <= width <= 4096) and (512 <= height <= 4096)\n   793→            \n   794→        except (ValueError, AttributeError):\n   795→            return False\n   796→\n   797→    def get_supported_sizes(self) -> List[str]:\n   798→        \"\"\"\n   799→        获取常用的图像尺寸列表\n   800→        \n   801→        注意：Seedream 4.0 支持更大尺寸范围，实际支持512x512到4096x4096范围内的所有尺寸\n   802→\n   803→        Returns:\n   804→            List[str]: 常用尺寸列表，包含官方推荐尺寸\n   805→        \"\"\"\n   806→        return [\n   807→            # 官方推荐尺寸 (Seedream 4.0)\n   808→            \"2048x2048\",   # 1:1 官方推荐\n   809→            \"2304x1728\",   # 4:3 官方推荐\n   810→            \"1728x2304\",   # 3:4 官方推荐\n   811→            \"2560x1440\",   # 16:9 官方推荐\n   812→            \"1440x2560\",   # 9:16 官方推荐\n   813→            \"2496x1664\",   # 3:2 官方推荐\n   814→            \"1664x2496\",   # 2:3 官方推荐\n   815→            \"3024x1296\",   # 21:9 官方推荐\n   816→            \n   817→            # 兼容性尺寸\n   818→            \"1920x1080\",   # 16:9 兼容\n   819→            \"1080x1920\",   # 9:16 兼容\n   820→            \"1536x1024\",   # 3:2 兼容\n   821→            \"1024x1536\",   # 2:3 兼容\n   822→            \"1512x648\",    # 21:9 兼容\n   823→            \"1280x720\",    # 16:9 小尺寸\n   824→            \"720x1280\",    # 9:16 小尺寸\n   825→            \"1024x1024\",   # 1:1 兼容\n   826→            \"768x768\",     # 1:1 小尺寸\n   827→            \"512x512\",     # 1:1 最小尺寸\n   828→        ]\n   829→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"da981f39-f2cb-49bc-b2be-19b031477539","timestamp":"2025-11-25T19:09:03.141Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/client.py","content":"# Seedream图像生成客户端\n# 封装火山引擎Seedream3.0 API调用\n\nimport json\nimport os\nimport requests\nimport time\nimport random\nfrom typing import Dict, Any, Optional, List\nfrom pathlib import Path\nfrom loguru import logger\nfrom urllib3.util.retry import Retry\nfrom requests.adapters import HTTPAdapter\n\n# 导入配置管理器和错误处理\nfrom config.unified_config import get_unified_config\nfrom modules.utils.error_handler import ErrorHandler, AppError, error_handler, RetryHandler, ErrorType\n\n\nclass SeedreamClient:\n    \"\"\"火山引擎Seedream图片生成客户端\n\n    提供文生图和图生图功能\n    \"\"\"\n\n    def __init__(\n        self,\n        api_key: Optional[str] = None,\n        base_url: str = \"https://ark.cn-beijing.volces.com/api/v3\",\n        model_id: str = \"doubao-seedream-3-0-t2i-250415\",\n        timeout: int = 60,\n        max_retries: int = 3,\n    ):\n        \"\"\"初始化Seedream客户端\n\n        Args:\n            api_key: 火山引擎API密钥，如果为None则从配置管理器获取\n            base_url: API基础URL\n            timeout: 请求超时时间（秒）\n            max_retries: 最大重试次数\n        \"\"\"\n        # 获取API密钥\n        if api_key is None:\n            try:\n                api_key = get_unified_config().get_api_key(\"volcengine\")\n            except Exception as exc:\n                raise AppError(str(exc), ErrorHandler.ErrorType.AUTH_ERROR) from exc\n\n        self.api_key = api_key\n        self.base_url = base_url.rstrip(\"/\")\n        self.model_id = model_id or \"doubao-seedream-3-0-t2i-250415\"\n        self.timeout = timeout\n        self.max_retries = max_retries\n\n        # 配置会话\n        self.session = requests.Session()\n\n        # 配置重试策略\n        retry_strategy = Retry(\n            total=max_retries,\n            status_forcelist=[429, 500, 502, 503, 504],\n            allowed_methods=[\"HEAD\", \"GET\", \"POST\"],\n            backoff_factor=1\n        )\n\n        adapter = HTTPAdapter(max_retries=retry_strategy)\n        self.session.mount(\"http://\", adapter)\n        self.session.mount(\"https://\", adapter)\n\n        logger.info(\"Seedream客户端初始化完成\")\n\n        # 初始化性能监控与错误缓存（统一结构）\n        self._performance_stats = {\n            \"total_requests\": 0,\n            \"successful_requests\": 0,\n            \"failed_requests\": 0,\n            \"total_response_time\": 0.0,\n            \"last_request_time\": None,\n        }\n        self._last_error: Dict[str, Any] = {\"code\": None, \"message\": None}\n        self._last_provider: Optional[str] = None\n        self._last_endpoint: Optional[str] = None\n\n    def _encode_image(self, image_path: str) -> str:\n        \"\"\"将图像文件编码为base64字符串\n        \n        Args:\n            image_path: 图像文件路径\n            \n        Returns:\n            base64编码的图像字符串\n        \"\"\"\n        import base64\n        \n        try:\n            with open(image_path, 'rb') as image_file:\n                image_data = image_file.read()\n                base64_string = base64.b64encode(image_data).decode('utf-8')\n                return base64_string\n        except Exception as e:\n            # 避免在日志中显示可能包含base64数据的异常信息\n            error_msg = str(e)\n            if len(error_msg) > 200:\n                error_msg = error_msg[:200] + \"...[错误信息过长，已截断]\"\n            logger.error(f\"图像编码失败: {error_msg}\")\n            raise AppError(f\"图像编码失败: 文件处理错误\", ErrorHandler.ErrorType.FILE_ERROR)\n\n    def _get_headers(self) -> Dict[str, str]:\n        \"\"\"获取请求头\"\"\"\n        # 验证API密钥，防止尺寸配置被错误使用\n        api_key = str(self.api_key).strip()\n\n        # 检查 API key 是否为纯 ASCII（HTTP headers 必须是 latin-1 可编码的）\n        try:\n            api_key.encode('ascii')\n        except UnicodeEncodeError:\n            raise ValueError(f\"API密钥包含非ASCII字符（如中文），请检查配置是否正确: {api_key[:20]}...\")\n\n        # 检查是否包含尺寸信息或换行符\n        if any(indicator in api_key for indicator in [\"x\", \":\", \"\\n\", \"2048\", \"1024\", \"1:1\", \"4:3\", \"16:9\"]):\n            raise ValueError(f\"API密钥格式错误，包含尺寸配置信息: {api_key[:50]}...\")\n\n        # 检查API密钥长度\n        if len(api_key) < 10 or len(api_key) > 200:\n            raise ValueError(f\"API密钥长度异常: {len(api_key)} 字符\")\n        \n        return {\n            \"Authorization\": f\"Bearer {api_key}\",\n            \"Content-Type\": \"application/json; charset=utf-8\",\n            \"User-Agent\": \"Seedream-Client/1.0.0\",\n        }\n\n    def _safe_json_post(self, url: str, headers: Dict[str, str], data: Dict[str, Any], timeout: int = 60):\n        \"\"\"安全的 JSON POST 请求，手动编码避免 PyInstaller latin-1 问题\"\"\"\n        body = json.dumps(data, ensure_ascii=False).encode(\"utf-8\")\n        return self.session.post(url, headers=headers, data=body, timeout=timeout)\n\n    def _provider_enabled(self) -> bool:\n        try:\n            import os\n            v = (os.environ.get(\"GEMENG_PROVIDER_ENABLED\", \"1\") or \"1\").lower().strip()\n            return v not in {\"0\", \"false\", \"no\"}\n        except Exception:\n            return True\n\n    def _get_seedream_provider_order(self) -> List[str]:\n        order: List[str] = []\n        try:\n            env_value = os.environ.get(\"GEMENG_SEEDREAM_PROVIDER\", \"volc_v3\")\n        except Exception:\n            env_value = \"volc_v3\"\n        candidates = [env_value]\n        for candidate in candidates:\n            if not candidate:\n                continue\n            name = candidate.strip().lower()\n            if not name:\n                continue\n            if name not in order:\n                order.append(name)\n        if \"volc_v3\" not in order:\n            order.append(\"volc_v3\")\n        return order\n\n    def _call_seedream_provider(self, headers: Dict[str, str], mapper, operation: str):\n        from modules.provider.factory import get_default_provider\n        default_endpoint = \"/images/generations\"\n        base_url = self.base_url.rstrip(\"/\")\n        first_choice = None\n        last_error: Optional[BaseException] = None\n        order = self._get_seedream_provider_order()\n        if order:\n            first_choice = order[0]\n        for idx, name in enumerate(order):\n            try:\n                provider = get_default_provider(name)\n            except Exception as e:\n                logger.warning(f\"Seedream provider加载失败: {name} ({e})\")\n                last_error = e\n                continue\n            try:\n                mapped = mapper(provider)\n                if not isinstance(mapped, tuple):\n                    raise ValueError(\"provider mapper 返回值异常\")\n                if len(mapped) == 4:\n                    payload, fb, reason, endpoint = mapped\n                elif len(mapped) == 3:\n                    payload, fb, reason = mapped\n                    endpoint = default_endpoint\n                else:\n                    raise ValueError(\"provider mapper 返回值长度不受支持\")\n            except Exception as e:\n                logger.warning(f\"Seedream provider参数映射失败: {name} ({e})\")\n                last_error = e\n                continue\n            start_time = time.time()\n            try:\n                endpoint_path = endpoint or default_endpoint\n                if isinstance(endpoint_path, str) and endpoint_path.startswith(\"http\"):\n                    request_url = endpoint_path\n                else:\n                    normalized = endpoint_path if isinstance(endpoint_path, str) else default_endpoint\n                    if not normalized.startswith(\"/\"):\n                        normalized = f\"/{normalized}\"\n                    request_url = f\"{base_url}{normalized}\"\n                response = self._safe_json_post(request_url, headers, payload, timeout=60)\n                result = self._handle_response(response)\n                elapsed = time.time() - start_time\n                if idx > 0 and first_choice:\n                    logger.warning(f\"Seedream provider {first_choice} 回退至 {name}\")\n                if fb and reason:\n                    logger.warning(f\"参数回退: {reason}\")\n                logger.info(\n                    f\"摘要|operation={operation}_provider provider={name} endpoint={endpoint_path} elapsed={elapsed:.2f}s fallback={'yes' if fb else 'no'}\"\n                )\n                self._last_provider = name\n                self._last_endpoint = endpoint_path if isinstance(endpoint_path, str) else default_endpoint\n                return result, payload, endpoint_path, name, fb, reason, elapsed\n            except AppError as e:\n                last_error = e\n                logger.warning(f\"Seedream provider {name} 请求失败: {e.message}\")\n                continue\n            except Exception as e:\n                last_error = e\n                logger.warning(f\"Seedream provider {name} 请求异常: {e}\")\n                continue\n        raise last_error or RuntimeError(\"Seedream provider 调用失败\")\n\n    def _log_seedream_event(\n        self,\n        operation: str,\n        status: str,\n        provider: Optional[str],\n        endpoint: Optional[str],\n        elapsed: float,\n        fallback_applied: bool,\n        fallback_reason: Optional[str] = None,\n        extra: Optional[Dict[str, Any]] = None,\n    ) -> None:\n        try:\n            provider_name = provider or \"unknown\"\n            endpoint_text = endpoint or \"/images/generations\"\n            parts = [\n                f\"operation={operation}\",\n                f\"status={status}\",\n                f\"provider={provider_name}\",\n                f\"endpoint={endpoint_text}\",\n                f\"elapsed={elapsed:.2f}s\",\n                f\"fallback={'yes' if fallback_applied else 'no'}\",\n            ]\n            if fallback_applied and fallback_reason:\n                safe_reason = str(fallback_reason)\n                if len(safe_reason) > 120:\n                    safe_reason = safe_reason[:120] + \"...\"\n                parts.append(f\"fallback_reason={safe_reason}\")\n            if extra:\n                for key, value in extra.items():\n                    if value is None:\n                        continue\n                    parts.append(f\"{key}={value}\")\n            logger.info(\"摘要|\" + \" \".join(parts))\n        except Exception:\n            # 保证日志逻辑不会影响主流程\n            pass\n\n    @staticmethod\n    def _wrap_base64_as_data_url(b64_data: str, path_hint: Optional[str] = None) -> str:\n        mime = \"image/png\"\n        try:\n            if path_hint:\n                suffix = Path(path_hint).suffix.lower()\n                if suffix in {\".jpg\", \".jpeg\"}:\n                    mime = \"image/jpeg\"\n                elif suffix == \".webp\":\n                    mime = \"image/webp\"\n                elif suffix == \".bmp\":\n                    mime = \"image/bmp\"\n                elif suffix == \".gif\":\n                    mime = \"image/gif\"\n        except Exception:\n            pass\n        return f\"data:{mime};base64,{b64_data}\"\n\n    def _handle_response(self, response: requests.Response) -> Dict[str, Any]:\n        \"\"\"处理API响应\n\n        Args:\n            response: HTTP响应对象\n\n        Returns:\n            解析后的响应数据\n\n        Raises:\n            AppError: 当API返回错误时\n        \"\"\"\n        try:\n            if not response.ok:\n                try:\n                    error_text = (response.content or b\"\").decode(response.encoding or 'utf-8', errors='ignore')\n                except Exception:\n                    error_text = str(response.content[:500])\n                # 避免在日志中显示可能包含base64数据的完整响应\n                if len(error_text) > 500:\n                    error_summary = error_text[:500] + \"...[响应过长，已截断]\"\n                else:\n                    error_summary = error_text\n                logger.error(f\"API请求失败 - 状态码: {response.status_code}, 响应: {error_summary}\")\n                raise AppError(\n                    f\"API请求失败 (状态码: {response.status_code}): {error_summary}\",\n                    ErrorType.API_ERROR,\n                    {\"status_code\": response.status_code, \"response_text\": error_summary}\n                )\n\n            # 解析响应（增强容错：包括编码问题回退）\n            try:\n                result = response.json()\n            except (json.JSONDecodeError, UnicodeDecodeError) as e:\n                raw = response.content or b\"\"\n                tried = set()\n                result = None\n                for enc in [response.encoding, \"utf-8\", \"utf-8-sig\", \"gb18030\"]:\n                    if not enc or enc in tried:\n                        continue\n                    tried.add(enc)\n                    try:\n                        text = raw.decode(enc, errors=\"strict\")\n                        result = json.loads(text)\n                        logger.debug(f\"Seedream _handle_response - 通过备用编码解析成功: {enc}\")\n                        break\n                    except Exception:\n                        continue\n                if result is None:\n                    try:\n                        preview = raw.decode(\"utf-8\", errors=\"ignore\")[:200]\n                    except Exception:\n                        preview = str(raw[:200])\n                    logger.error(f\"Seedream _handle_response - JSON解析失败(编码问题): {preview}\")\n                    raise Exception(f\"响应格式错误: 无法解析JSON - {str(e)}\")\n\n            # OpenAI格式的响应检查\n            if \"data\" not in result:\n                error_msg = result.get(\"error\", {}).get(\"message\", \"未知错误\")\n                logger.error(f\"Seedream API错误: {error_msg}\")\n                raise AppError(\n                    f\"API错误: {error_msg}\",\n                    ErrorHandler.ErrorType.API_ERROR,\n                    {\"response_data\": result},\n                )\n\n            # 转换为统一格式，只保留URL数据，避免base64数据造成终端乱码\n            images = []\n            for item in result[\"data\"]:\n                if \"url\" in item:\n                    images.append({\n                        \"url\": item[\"url\"]\n                        # 注意：不再包含b64_json字段，避免base64数据在日志中显示造成乱码\n                    })\n\n            return {\n                \"code\": 200,\n                \"message\": \"success\",\n                \"data\": {\n                    \"images\": images\n                },\n                \"created\": result.get(\"created\"),\n                \"usage\": result.get(\"usage\", {})\n            }\n\n        except requests.exceptions.RequestException as e:\n            raise ErrorHandler.handle_network_error(e, \"火山引擎Seedream\")\n        except json.JSONDecodeError as e:\n            raise ErrorHandler.handle_unknown_error(e, \"火山引擎Seedream响应解析\")\n\n    def _record_request_stats(\n        self,\n        operation: str,\n        success: bool,\n        response_time: float,\n        error_code: Optional[str] = None,\n        error_message: Optional[str] = None,\n    ) -> None:\n        \"\"\"记录统一性能统计并缓存最近错误摘要（不含敏感详情）。\"\"\"\n        try:\n            self._performance_stats[\"total_requests\"] += 1\n            self._performance_stats[\"total_response_time\"] += max(0.0, float(response_time))\n            self._performance_stats[\"last_request_time\"] = time.time()\n            if success:\n                self._performance_stats[\"successful_requests\"] += 1\n            else:\n                self._performance_stats[\"failed_requests\"] += 1\n                if error_code or error_message:\n                    self._last_error = {\"code\": error_code, \"message\": str(error_message)[:200]}\n\n            # 调试日志（安全版）\n            total = max(1, self._performance_stats[\"total_requests\"])\n            avg = self._performance_stats[\"total_response_time\"] / total\n            succ = self._performance_stats[\"successful_requests\"]\n            success_rate = (succ / total) * 100.0\n            logger.debug(\n                f\"{operation} 统计: 响应时间={response_time:.2f}s, 平均={avg:.2f}s, 成功率={success_rate:.1f}%\"\n            )\n        except Exception:\n            # 统计不应影响业务流程\n            pass\n\n    def get_performance_stats(self) -> Dict[str, Any]:\n        \"\"\"获取统一性能统计（字段统一）。\"\"\"\n        stats = dict(self._performance_stats)\n        total = stats.get(\"total_requests\", 0) or 0\n        if total > 0:\n            avg = stats.get(\"total_response_time\", 0.0) / total\n            success_rate = (stats.get(\"successful_requests\", 0) / total) * 100.0\n        else:\n            avg = 0.0\n            success_rate = 0.0\n        return {\n            \"total_requests\": total,\n            \"successful_requests\": stats.get(\"successful_requests\", 0),\n            \"failed_requests\": stats.get(\"failed_requests\", 0),\n            \"avg_response_time\": avg,\n            \"success_rate\": success_rate,\n            \"last_error\": dict(self._last_error) if self._last_error else {\"code\": None, \"message\": None},\n        }\n\n    def dump_metrics(self) -> Dict[str, Any]:\n        \"\"\"导出诊断可读的统一指标。\"\"\"\n        m = self.get_performance_stats()\n        m.update({\n            \"client\": \"Seedream\",\n            \"model\": self.model_id,\n            \"base_url\": self.base_url,\n        })\n        return m\n\n    def last_provider(self) -> Optional[str]:\n        \"\"\"返回最近一次成功调用所使用的 provider 名称。\"\"\"\n        return self._last_provider\n\n    def last_endpoint(self) -> Optional[str]:\n        \"\"\"返回最近一次成功调用所使用的 endpoint。\"\"\"\n        return self._last_endpoint\n\n    @error_handler(\"Seedream文生图\")\n    @RetryHandler.retry_on_error(max_retries=3, delay=1.0)\n    def text_to_image(\n        self,\n        prompt: str,\n        size: str = \"1024x1024\",\n        guidance_scale: float = 2.5,\n        seed: Optional[int] = None,\n        reference_images: Optional[List[Any]] = None,\n    ) -> Dict[str, Any]:\n        \"\"\"\n        文生图API调用\n\n        Args:\n            prompt: 图片描述提示词\n            size: 图像尺寸，支持的尺寸见get_supported_sizes()\n            guidance_scale: 引导强度，范围[1.0, 10.0]\n            seed: 随机种子，范围[-1, 2147483647]，-1表示随机\n            reference_images: 参考图列表（路径或URL），最多10张\n            response_format: 返回格式，\"url\"或\"b64_json\"\n\n        Returns:\n            API响应结果\n\n        Raises:\n            AppError: 当API调用失败时\n        \"\"\"\n        headers = self._get_headers()\n\n        logger.info(f\"发送文生图请求: {prompt[:50]}...\")\n\n        if self._provider_enabled():\n            try:\n                from modules.provider.schema import TextToImageParams\n\n                result, data, endpoint_used, provider_used, fallback_applied, fallback_reason, response_time = self._call_seedream_provider(\n                    headers,\n                    lambda provider: provider.map_t2i(TextToImageParams(\n                        prompt=prompt,\n                        size=size,\n                        guidance_scale=guidance_scale,\n                        seed=(None if (seed is None or seed == -1) else seed),\n                        reference_images=reference_images or []\n                    )),\n                    \"text_to_image\"\n                )\n                self._log_seedream_event(\n                    \"text_to_image\",\n                    \"success\",\n                    provider_used,\n                    endpoint_used,\n                    response_time,\n                    fallback_applied,\n                    fallback_reason,\n                    {\"size\": data.get(\"size\"), \"seed\": data.get(\"seed\")},\n                )\n                self._record_request_stats(\"text_to_image\", True, response_time, None, None)\n                return result\n            except Exception as provider_exc:\n                logger.warning(f\"Seedream provider 路径失败，回退旧逻辑: {provider_exc}\")\n\n        success = False\n        err_code: Optional[str] = None\n        err_msg: Optional[str] = None\n        start_time = time.time()\n        try:\n            if not self.validate_image_size(size):\n                raise AppError(f\"不支持的图像尺寸: {size}\", ErrorType.VALIDATION_ERROR)\n            if not (1.0 <= guidance_scale <= 10.0):\n                raise AppError(f\"guidance_scale必须在1.0-10.0范围内，当前值: {guidance_scale}\", ErrorType.VALIDATION_ERROR)\n            if seed is not None and not (-1 <= seed <= 2147483647):\n                raise AppError(f\"seed必须在-1到2147483647范围内，当前值: {seed}\", ErrorType.VALIDATION_ERROR)\n\n            data = {\n                \"model\": \"doubao-seedream-3-0-t2i-250415\",\n                \"prompt\": prompt,\n                \"size\": size,\n                \"response_format\": \"url\",\n                \"watermark\": False,  # 正式版固定禁用水印\n                \"guidance_scale\": guidance_scale,\n            }\n            if seed is not None:\n                data[\"seed\"] = seed\n\n            if reference_images:\n                images_payload = []\n                for item in reference_images:\n                    try:\n                        if isinstance(item, str):\n                            if item.startswith(\"data:image/\"):\n                                images_payload.append(item)\n                                continue\n                            p = Path(item)\n                            if p.exists():\n                                encoded = self._encode_image(str(p))\n                                images_payload.append(self._wrap_base64_as_data_url(encoded, str(p)))\n                            elif item.startswith(\"http://\") or item.startswith(\"https://\"):\n                                images_payload.append(item)\n                        elif isinstance(item, dict):\n                            payload = item.get('_payload_b64') or item.get('data') or item.get('value')\n                            path_hint = item.get('path') or item.get('source')\n                            if payload:\n                                images_payload.append(self._wrap_base64_as_data_url(payload, path_hint))\n                            else:\n                                path_val = item.get('path')\n                                if path_val:\n                                    p = Path(path_val)\n                                    if p.exists():\n                                        encoded = self._encode_image(str(p))\n                                        images_payload.append(self._wrap_base64_as_data_url(encoded, str(p)))\n                    except Exception as exc:\n                        logger.warning(f\"参考图处理失败: {exc}\")\n                if images_payload:\n                    data[\"image\"] = images_payload if len(images_payload) > 1 else images_payload[0]\n                    data[\"sequential_image_generation\"] = \"disabled\"\n\n            request_url = f\"{self.base_url.rstrip('/')}/images/generations\"\n            response = self._safe_json_post(request_url, headers, data, timeout=60)\n            result = self._handle_response(response)\n            success = True\n            elapsed = time.time() - start_time\n            self._last_provider = \"legacy_v3\"\n            self._last_endpoint = \"/images/generations\"\n            self._log_seedream_event(\n                \"text_to_image\",\n                \"success\",\n                \"legacy_v3\",\n                \"/images/generations\",\n                elapsed,\n                False,\n                None,\n                {\"size\": data.get(\"size\"), \"seed\": data.get(\"seed\")},\n            )\n            return result\n        except AppError as e:\n            err_code = getattr(e, \"error_type\", ErrorType.API_ERROR).value\n            err_msg = e.message\n            safe_msg = (err_msg[:200] + \"...[错误信息过长，已截断]\") if err_msg and len(err_msg) > 200 else err_msg\n            logger.error(f\"文生图请求失败: {safe_msg}\")\n            raise\n        except Exception as e:\n            err_code = \"UNKNOWN_ERROR\"\n            err_msg = str(e)\n            safe_msg = (err_msg[:200] + \"...[错误信息过长，已截断]\") if err_msg and len(err_msg) > 200 else err_msg\n            logger.error(f\"文生图请求失败: {safe_msg}\")\n            raise Exception(f\"文生图API调用失败: {safe_msg}\")\n        finally:\n            elapsed = time.time() - start_time\n            self._record_request_stats(\"text_to_image\", success, elapsed, err_code, err_msg)\n\n    @error_handler(\"Seedream图生图\")\n    @RetryHandler.retry_on_error(max_retries=3, delay=1.0)\n    def image_to_image(\n        self,\n        prompt: str,\n        image: str,\n        guidance_scale: float = 5.5,\n        seed: Optional[int] = None,\n        reference_images: Optional[List[str]] = None,\n    ) -> Dict[str, Any]:\n        \"\"\"\n        图生图API调用\n\n        Args:\n            prompt: 图片编辑提示词\n            image: 输入图像URL或Base64编码\n            guidance_scale: 引导强度，范围[1.0, 10.0]\n            seed: 随机种子，范围[-1, 2147483647]，-1表示随机\n            reference_images: 参考图列表（路径或URL），最多10张\n            response_format: 返回格式，\"url\"或\"b64_json\"\n            reference_images: 额外参考图（base64/url），Seedream 4.0 多参考图\n\n        Returns:\n            API响应结果\n\n        Raises:\n            AppError: 当API调用失败时\n        \"\"\"\n        headers = self._get_headers()\n\n        logger.info(f\"发送图生图请求: {prompt[:50]}...\")\n\n        if self._provider_enabled():\n            try:\n                from modules.provider.schema import ImageToImageParams\n\n                result, data, endpoint_used, provider_used, fallback_applied, fallback_reason, response_time = self._call_seedream_provider(\n                    headers,\n                    lambda provider: provider.map_i2i(ImageToImageParams(\n                        prompt=prompt,\n                        image=image,\n                        guidance_scale=guidance_scale,\n                        seed=(None if (seed is None or seed == -1) else seed),\n                        reference_images=(reference_images or []),\n                    )),\n                    \"image_to_image\"\n                )\n                self._log_seedream_event(\n                    \"image_to_image\",\n                    \"success\",\n                    provider_used,\n                    endpoint_used,\n                    response_time,\n                    fallback_applied,\n                    fallback_reason,\n                    {\"seed\": data.get(\"seed\")},\n                )\n                self._record_request_stats(\"image_to_image\", True, response_time, None, None)\n                return result\n            except Exception as provider_exc:\n                logger.warning(f\"Seedream provider 路径失败，回退旧逻辑: {provider_exc}\")\n\n        success = False\n        err_code: Optional[str] = None\n        err_msg: Optional[str] = None\n        start_time = time.time()\n        try:\n            if not (1.0 <= guidance_scale <= 10.0):\n                raise AppError(f\"guidance_scale必须在1.0-10.0范围内，当前值: {guidance_scale}\", ErrorType.VALIDATION_ERROR)\n            if seed is not None and not (-1 <= seed <= 2147483647):\n                raise AppError(f\"seed必须在-1到2147483647范围内，当前值: {seed}\", ErrorType.VALIDATION_ERROR)\n\n            data = {\n                \"model\": \"doubao-seededit-3-0-i2i-250628\",\n                \"prompt\": prompt,\n                \"image\": image,\n                \"size\": \"adaptive\",\n                \"response_format\": \"url\",\n                \"watermark\": False,  # 正式版固定禁用水印\n                \"guidance_scale\": guidance_scale,\n            }\n            if seed is not None:\n                data[\"seed\"] = seed\n            if reference_images:\n                logger.warning(\"Seedream 3.x 路径不支持多参考图，已忽略 reference_images\")\n\n            request_url = f\"{self.base_url.rstrip('/')}/images/generations\"\n            response = self._safe_json_post(request_url, headers, data, timeout=60)\n            result = self._handle_response(response)\n            success = True\n            elapsed = time.time() - start_time\n            self._last_provider = \"legacy_v3\"\n            self._last_endpoint = \"/images/generations\"\n            self._log_seedream_event(\n                \"image_to_image\",\n                \"success\",\n                \"legacy_v3\",\n                \"/images/generations\",\n                elapsed,\n                False,\n                None,\n                {\"seed\": data.get(\"seed\")},\n            )\n            return result\n        except AppError as e:\n            err_code = getattr(e, \"error_type\", ErrorType.API_ERROR).value\n            err_msg = e.message\n            safe_msg = (err_msg[:200] + \"...[错误信息过长，已截断]\") if err_msg and len(err_msg) > 200 else err_msg\n            logger.error(f\"图生图请求失败: {safe_msg}\")\n            raise\n        except Exception as e:\n            err_code = \"UNKNOWN_ERROR\"\n            err_msg = str(e)\n            safe_msg = (err_msg[:200] + \"...[错误信息过长，已截断]\") if err_msg and len(err_msg) > 200 else err_msg\n            logger.error(f\"图生图请求失败: {safe_msg}\")\n            raise Exception(f\"图生图API调用失败: {safe_msg}\")\n        finally:\n            elapsed = time.time() - start_time\n            self._record_request_stats(\"image_to_image\", success, elapsed, err_code, err_msg)\n\n    def batch_text_to_image(\n        self, prompts: List[str], width: int = 1024, height: int = 1024, guidance_scale: float = 2.5\n    ) -> List[Dict[str, Any]]:\n        \"\"\"\n        批量文生图：同时生成多张图片\n\n        Args:\n            prompts: 提示词列表\n            width: 图像宽度\n            height: 图像高度\n            guidance_scale: 提示词一致性\n\n        Returns:\n            List[Dict]: 生成结果列表\n        \"\"\"\n        results = []\n        logger.info(f\"开始批量文生图，共{len(prompts)}个任务\")\n\n        for i, prompt in enumerate(prompts, 1):\n            logger.info(f\"处理第{i}/{len(prompts)}个任务\")\n\n            try:\n                # 为每个任务生成不同的随机种子\n                seed = random.randint(1, 2147483647)\n\n                result = self.text_to_image(\n                    prompt=prompt, \n                    width=width, \n                    height=height, \n                    guidance_scale=guidance_scale, \n                    seed=seed\n                )\n\n                results.append({\n                    \"success\": True,\n                    \"result\": result,\n                    \"prompt\": prompt\n                })\n\n            except Exception as e:\n                # 避免在日志中显示过长的异常信息\n                error_msg = str(e)\n                if len(error_msg) > 200:\n                    error_msg = error_msg[:200] + \"...[错误信息过长，已截断]\"\n                logger.error(f\"第{i}个任务失败: {error_msg}\")\n                results.append({\n                    \"success\": False,\n                    \"error\": error_msg,\n                    \"prompt\": prompt\n                })\n\n            # 避免请求过于频繁\n            if i < len(prompts):\n                time.sleep(0.5)\n\n        success_count = sum(1 for r in results if r[\"success\"])\n        logger.info(f\"批量文生图完成，成功{success_count}/{len(prompts)}个\")\n        return results\n\n    def validate_image_size(self, size: str) -> bool:\n        \"\"\"\n        验证图像尺寸是否支持\n\n        Args:\n            size: 图像尺寸字符串，如 \"1024x1024\"\n\n        Returns:\n            bool: 是否支持该尺寸\n        \"\"\"\n        try:\n            # 解析尺寸字符串\n            if 'x' not in size:\n                return False\n                \n            width_str, height_str = size.split('x', 1)\n            width = int(width_str)\n            height = int(height_str)\n            \n            # 验证范围：Seedream 4.0 支持 512-4096像素\n            return (512 <= width <= 4096) and (512 <= height <= 4096)\n            \n        except (ValueError, AttributeError):\n            return False\n\n    def get_supported_sizes(self) -> List[str]:\n        \"\"\"\n        获取常用的图像尺寸列表\n        \n        注意：Seedream 4.0 支持更大尺寸范围，实际支持512x512到4096x4096范围内的所有尺寸\n\n        Returns:\n            List[str]: 常用尺寸列表，包含官方推荐尺寸\n        \"\"\"\n        return [\n            # 官方推荐尺寸 (Seedream 4.0)\n            \"2048x2048\",   # 1:1 官方推荐\n            \"2304x1728\",   # 4:3 官方推荐\n            \"1728x2304\",   # 3:4 官方推荐\n            \"2560x1440\",   # 16:9 官方推荐\n            \"1440x2560\",   # 9:16 官方推荐\n            \"2496x1664\",   # 3:2 官方推荐\n            \"1664x2496\",   # 2:3 官方推荐\n            \"3024x1296\",   # 21:9 官方推荐\n            \n            # 兼容性尺寸\n            \"1920x1080\",   # 16:9 兼容\n            \"1080x1920\",   # 9:16 兼容\n            \"1536x1024\",   # 3:2 兼容\n            \"1024x1536\",   # 2:3 兼容\n            \"1512x648\",    # 21:9 兼容\n            \"1280x720\",    # 16:9 小尺寸\n            \"720x1280\",    # 9:16 小尺寸\n            \"1024x1024\",   # 1:1 兼容\n            \"768x768\",     # 1:1 小尺寸\n            \"512x512\",     # 1:1 最小尺寸\n        ]\n","numLines":829,"startLine":1,"totalLines":829}}}
{"parentUuid":"da981f39-f2cb-49bc-b2be-19b031477539","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Kgnr2wDhRnLiW8cKEuTQNm","type":"tool_result","content":"     1→# Seedream图像生成管理器\n     2→# 负责图像生成的业务逻辑和本地存储管理\n     3→# 路径真源说明：存储路径仅允许通过 config_api.get_storage_dir() + V2 工厂注入；\n     4→# 禁止通过构造参数传入路径，杜绝多根与兼容分支。\n     5→\n     6→import os\n     7→import uuid\n     8→import requests\n     9→from ..utils.safe_requests import safe_requests_get\n    10→import hashlib\n    11→import mimetypes\n    12→from datetime import datetime\n    13→from pathlib import Path\n    14→from typing import Dict, Any, List, Optional, Callable, Tuple\n    15→from PIL import Image\n    16→from loguru import logger\n    17→from urllib.parse import urlparse\n    18→import base64\n    19→import asyncio\n    20→import aiohttp\n    21→import threading\n    22→from concurrent.futures import ThreadPoolExecutor, as_completed\n    23→import time\n    24→\n    25→from .client import SeedreamClient\n    26→from ..storage import get_v2_storage_manager\n    27→from ..provider.schema import (\n    28→    TextToImageParams,\n    29→    ImageToImageParams,\n    30→    validate_and_normalize_t2i,\n    31→    validate_and_normalize_i2i,\n    32→    MAX_REFERENCE_IMAGES,\n    33→    MAX_REFERENCE_BUNDLE,\n    34→)\n    35→from config_api import get_storage_dir\n    36→\n    37→# 使用统一水印服务（edition/watermark_service.py）\n    38→from edition.watermark_service import (\n    39→    should_add_watermark,\n    40→    get_watermark_text,\n    41→    get_watermark_opacity,\n    42→)\n    43→\n    44→\n    45→class SeedreamManager:\n    46→    \"\"\"Seedream图像生成管理器\"\"\"\n    47→\n    48→    def __init__(self, api_key: str = None):\n    49→        \"\"\"\n    50→        初始化Seedream管理器\n    51→\n    52→        Args:\n    53→            api_key: 火山引擎API密钥，如果为None则从ConfigManager获取\n    54→        \"\"\"\n    55→        self.client = SeedreamClient(api_key)\n    56→        \n    57→        # 使用V2统一存储管理器（与单一真源对齐）\n    58→        self.storage_manager = get_v2_storage_manager(get_storage_dir())\n    59→        \n    60→        # 保持兼容性别名\n    61→        self.file_manager = self.storage_manager\n    62→        self.metadata_manager = self.storage_manager\n    63→        self.image_storage_manager = self.storage_manager\n    64→        \n    65→        # 保留原有的目录属性以保持兼容性\n    66→        self.data_dir = Path(self.storage_manager.root_path)\n    67→        self.images_dir = self.data_dir / \"images\"\n    68→        self.metadata_dir = self.data_dir / \"metadata\"\n    69→\n    70→        logger.info(f\"Seedream管理器初始化完成，使用统一存储管理器，根目录: {self.storage_manager.root_path}\")\n    71→\n    72→    def generate_text_to_image(\n    73→        self,\n    74→        prompt: str,\n    75→        size: str = \"1024x1024\",\n    76→        guidance_scale: float = 2.5,\n    77→        seed: int = -1,\n    78→        save_local: bool = True,\n    79→        reference_images: Optional[List[Any]] = None,\n    80→        model_variant: Optional[str] = None,\n    81→        generation_id: Optional[str] = None,\n    82→    ) -> Dict[str, Any]:\n    83→        \"\"\"\n    84→        生成文生图并保存到本地\n    85→\n    86→        Args:\n    87→            prompt: 图像生成提示词\n    88→            size: 图像尺寸，支持的尺寸见client.get_supported_sizes()\n    89→            guidance_scale: 引导强度，范围[1.0, 10.0]\n    90→            seed: 随机种子，范围[-1, 2147483647]，None表示随机\n    91→            response_format: 返回格式，\"url\"或\"b64_json\"\n    92→            save_local: 是否保存到本地\n    93→            reference_images: 参考图列表\n    94→            model_variant: 模型变体，如 'seedream_v4' 使用 Seedream 4.0\n    95→\n    96→        Returns:\n    97→            Dict: 生成结果，包含本地文件路径\n    98→        \n    99→        Note:\n   100→            model和watermark参数已固定，不再需要前端控制\n   101→        \"\"\"\n   102→        logger.info(f\"开始文生图任务: {prompt[:50]}... (model_variant: {model_variant})\")\n   103→        \n   104→        # 根据 model_variant 设置环境变量\n   105→        if model_variant == 'seedream_v4':\n   106→            os.environ[\"GEMENG_SEEDREAM_PROVIDER\"] = \"volc_v4\"\n   107→        else:\n   108→            # 默认使用 volc_v3\n   109→            os.environ[\"GEMENG_SEEDREAM_PROVIDER\"] = \"volc_v3\"\n   110→\n   111→        # 生成唯一ID，优先使用外部传入的generation_id\n   112→        task_id = generation_id or str(uuid.uuid4())\n   113→\n   114→        ref_assets: List[Dict[str, Any]] = []\n   115→        ref_paths: List[str] = []\n   116→        ref_summary: Dict[str, Any] = {}\n   117→        ref_payloads: List[str] = []\n   118→\n   119→        try:\n   120→            if reference_images:\n   121→                ref_summary = self._process_reference_assets(\n   122→                    reference_images,\n   123→                    max_refs=MAX_REFERENCE_IMAGES,\n   124→                    expected_outputs=1,\n   125→                )\n   126→                ref_assets = list(ref_summary.get('assets', []))\n   127→                ref_paths = list(ref_summary.get('paths', []))\n   128→                ref_payloads = self._build_reference_payloads(ref_assets)\n   129→\n   130→                if ref_summary.get('errors'):\n   131→                    logger.warning(\n   132→                        f\"参考图处理不完整: count={len(ref_assets)} errors={len(ref_summary['errors'])}\"\n   133→                    )\n   134→                if ref_summary.get('warnings'):\n   135→                    for warn in ref_summary['warnings']:\n   136→                        logger.warning(f\"参考图提示: {warn}\")\n   137→\n   138→            # 前置参数校验（不改变业务流程，仅记录摘要与回退建议）\n   139→            try:\n   140→                norm, fb, reason = validate_and_normalize_t2i(\n   141→                    TextToImageParams(\n   142→                        prompt=prompt,\n   143→                        size=size,\n   144→                        guidance_scale=guidance_scale,\n   145→                        seed=(None if seed == -1 else seed),\n   146→                    )\n   147→                )\n   148→                logger.info(\n   149→                    f\"摘要|operation=precheck_t2i size={norm.size} gs={norm.guidance_scale} seed={norm.seed} fallback={'yes' if fb else 'no'}\"\n   150→                )\n   151→                if fb:\n   152→                    logger.warning(f\"前置参数回退建议: {reason}\")\n   153→            except Exception as _e:\n   154→                logger.debug(f\"前置参数校验跳过: {_e}\")\n   155→            # 调用API生成图像（model和watermark参数已在客户端固定）\n   156→            api_result = self.client.text_to_image(\n   157→                prompt=prompt,\n   158→                size=size,\n   159→                guidance_scale=guidance_scale,\n   160→                seed=seed,\n   161→                reference_images=ref_payloads or None,\n   162→            )\n   163→\n   164→            result = {\n   165→                \"task_id\": task_id,\n   166→                \"success\": True,\n   167→                \"type\": \"text_to_image\",\n   168→                \"prompt\": prompt,\n   169→                \"image_url\": api_result[\"data\"][\"images\"][0][\"url\"],\n   170→                \"parameters\": {\n   171→                    \"size\": size, \n   172→                    \"guidance_scale\": guidance_scale, \n   173→                    \"seed\": seed, \n   174→                    \"response_format\": \"url\",  # 固定值\n   175→                    \"watermark\": False,  # 固定值\n   176→                    \"model\": self._resolve_model_id(\n   177→                        \"doubao-seedream-3-0-t2i-250415\",\n   178→                        \"doubao-seedream-4-0-250828\",\n   179→                    )\n   180→                },\n   181→                \"created_at\": datetime.now().isoformat(),\n   182→                \"usage\": api_result.get(\"usage\", {}),\n   183→            }\n   184→\n   185→            sanitized_refs = self._sanitize_reference_assets(ref_assets)\n   186→            if sanitized_refs:\n   187→                result[\"parameters\"][\"reference_assets\"] = sanitized_refs\n   188→                result[\"reference_assets\"] = sanitized_refs\n   189→                masked_ids = self._summarize_reference_ids(sanitized_refs)\n   190→                logger.info(\n   191→                    \"摘要|operation=t2i_reference reference_count={} ref_ids={} provider={}\",\n   192→                    len(sanitized_refs),\n   193→                    masked_ids or \"-\",\n   194→                    self._provider_used(),\n   195→                )\n   196→            else:\n   197→                result[\"parameters\"][\"reference_assets\"] = []\n   198→                result[\"reference_assets\"] = []\n   199→\n   200→            # 保存到本地\n   201→            if save_local and result.get(\"image_url\"):\n   202→                local_result = self._save_image_locally(result)\n   203→                result.update(local_result)\n   204→                if local_result.get('local_save_error') and sanitized_refs:\n   205→                    self._cleanup_reference_paths(ref_paths)\n   206→                    result[\"parameters\"][\"reference_assets\"] = []\n   207→                    result[\"reference_assets\"] = []\n   208→                    warnings = result.setdefault(\"reference_asset_warnings\", [])\n   209→                    warnings.append(\"主图保存失败，参考图已回滚\")\n   210→                    logger.warning(f\"参考图已回滚: task_id={task_id}\")\n   211→\n   212→            logger.success(f\"文生图任务完成: {task_id}\")\n   213→            return result\n   214→\n   215→        except Exception as e:\n   216→            logger.error(f\"文生图API调用失败: {str(e)}\")\n   217→            self._cleanup_reference_paths(ref_paths)\n   218→            return {\n   219→                \"task_id\": task_id,\n   220→                \"success\": False,\n   221→                \"error\": str(e),\n   222→                \"type\": \"text_to_image\"\n   223→            }\n   224→\n   225→    def generate_image_to_image(\n   226→        self,\n   227→        prompt: str,\n   228→        image: str,\n   229→        guidance_scale: float = 5.5,\n   230→        seed: int = -1,\n   231→        save_local: bool = True,\n   232→        reference_images: Optional[List[Any]] = None,\n   233→        generation_id: Optional[str] = None,\n   234→    ) -> Dict[str, Any]:\n   235→        \"\"\"\n   236→        生成图生图并保存到本地\n   237→\n   238→        Args:\n   239→            prompt: 编辑提示词\n   240→            image_path: 原始图像路径（本地路径或URL）\n   241→            guidance_scale: 引导强度，范围[1.0, 10.0]\n   242→            seed: 随机种子，范围[-1, 2147483647]，None表示随机\n   243→            response_format: 返回格式，\"url\"或\"b64_json\"\n   244→            save_local: 是否保存到本地\n   245→\n   246→        Returns:\n   247→            Dict: 生成结果\n   248→        \n   249→        Note:\n   250→            model、size、watermark参数已固定，不再需要前端控制\n   251→        \"\"\"\n   252→        logger.info(f\"开始图生图任务: {prompt[:50]}...\")\n   253→\n   254→        # 生成唯一ID，优先使用外部传入的generation_id\n   255→        task_id = generation_id or str(uuid.uuid4())\n   256→\n   257→        ref_paths: List[str] = []\n   258→\n   259→        try:\n   260→            # 处理输入图像\n   261→            image_data = self._prepare_input_image(image)\n   262→            if not image_data:\n   263→                return {\"success\": False, \"error\": \"无法处理输入图像\", \"task_id\": task_id}\n   264→\n   265→            # 处理参考图（复制到 references 并准备 API 载荷）\n   266→            ref_summary = self._process_reference_assets(\n   267→                reference_images,\n   268→                max_refs=MAX_REFERENCE_IMAGES,\n   269→                expected_outputs=1,\n   270→            )\n   271→            ref_assets = ref_summary.get('assets', [])\n   272→            ref_paths = list(ref_summary.get('paths', []))\n   273→            ref_payloads: List[str] = self._build_reference_payloads(ref_assets)\n   274→            if ref_summary.get('errors'):\n   275→                logger.warning(\n   276→                    f\"参考图处理不完整: count={len(ref_assets)} errors={len(ref_summary['errors'])}\"\n   277→                )\n   278→            if ref_summary.get('warnings'):\n   279→                for warn in ref_summary['warnings']:\n   280→                    logger.warning(f\"参考图提示: {warn}\")\n   281→\n   282→            # 前置参数校验（不改变流程，仅记录摘要）\n   283→            fb = False\n   284→            reason = \"\"\n   285→            try:\n   286→                norm, fb, reason = validate_and_normalize_i2i(\n   287→                    ImageToImageParams(\n   288→                        prompt=prompt,\n   289→                        image=\"<omitted>\",  # 避免在校验阶段传递大数据\n   290→                        guidance_scale=guidance_scale,\n   291→                        seed=(None if seed == -1 else seed),\n   292→                        reference_images=ref_payloads,\n   293→                    )\n   294→                )\n   295→                logger.info(\n   296→                    f\"摘要|operation=precheck_i2i gs={norm.guidance_scale} seed={norm.seed} fallback={'yes' if fb else 'no'}\"\n   297→                )\n   298→                if fb:\n   299→                    logger.warning(f\"前置参数回退建议: {reason}\")\n   300→            except Exception as _e:\n   301→                logger.debug(f\"前置参数校验跳过: {_e}\")\n   302→\n   303→            # 调用API生成图像（model、size、watermark参数已在客户端固定）\n   304→            api_result = self.client.image_to_image(\n   305→                prompt=prompt,\n   306→                image=image_data,\n   307→                guidance_scale=guidance_scale,\n   308→                seed=seed,\n   309→                reference_images=(ref_payloads or None),\n   310→            )\n   311→\n   312→            # 处理input_image字段，避免在日志中输出大量base64数据\n   313→            input_image_info = \"[图像数据]\"\n   314→            if image:\n   315→                if image.startswith(\"data:image/\"):\n   316→                    # 如果是base64数据，只保留格式信息\n   317→                    format_part = image.split(';')[0] if ';' in image else \"data:image/unknown\"\n   318→                    input_image_info = f\"{format_part};base64,[数据已隐藏]\"\n   319→                elif image.startswith((\"http://\", \"https://\")):\n   320→                    # 如果是URL，保留URL\n   321→                    input_image_info = image\n   322→                else:\n   323→                    # 如果是文件路径，只保留文件名\n   324→                    input_image_info = f\"[本地文件: {Path(image).name}]\"\n   325→            \n   326→            result = {\n   327→                \"task_id\": task_id,\n   328→                \"success\": True,\n   329→                \"type\": \"image_to_image\",\n   330→                \"prompt\": prompt,\n   331→                \"input_image\": input_image_info,\n   332→                \"image_url\": api_result[\"data\"][\"images\"][0][\"url\"],\n   333→                \"parameters\": {\n   334→                    \"guidance_scale\": guidance_scale, \n   335→                    \"seed\": seed, \n   336→                    \"response_format\": \"url\",  # 固定值\n   337→                    \"watermark\": False,  # 固定值\n   338→                    \"size\": \"adaptive\",  # 固定值\n   339→                    \"model\": self._resolve_model_id(\n   340→                        \"doubao-seededit-3-0-i2i-250628\",\n   341→                        \"doubao-seedream-4-0-250828\",\n   342→                    )  # v4 路径统一使用 Seedream 4.0 模型\n   343→                },\n   344→                \"created_at\": datetime.now().isoformat(),\n   345→                \"usage\": api_result.get(\"usage\", {}),\n   346→            }\n   347→\n   348→            sanitized_refs = self._sanitize_reference_assets(ref_assets)\n   349→            result[\"parameters\"][\"reference_assets\"] = sanitized_refs\n   350→            result[\"reference_assets\"] = sanitized_refs\n   351→            if ref_summary.get('errors'):\n   352→                result[\"reference_asset_errors\"] = ref_summary['errors']\n   353→            if ref_summary.get('warnings'):\n   354→                result[\"reference_asset_warnings\"] = ref_summary['warnings']\n   355→            if fb and reason:\n   356→                result[\"fallback_applied\"] = True\n   357→                result[\"fallback_reason\"] = reason\n   358→\n   359→            masked_ids = self._summarize_reference_ids(sanitized_refs)\n   360→            logger.info(\n   361→                \"摘要|operation=i2i_reference reference_count={} ref_ids={} provider={}\",\n   362→                len(sanitized_refs),\n   363→                masked_ids or \"-\",\n   364→                self._provider_used(),\n   365→            )\n   366→\n   367→            # 保存到本地\n   368→            if save_local and result.get(\"image_url\"):\n   369→                local_result = self._save_image_locally(result)\n   370→                result.update(local_result)\n   371→                if local_result.get('local_save_error'):\n   372→                    self._cleanup_reference_paths(ref_paths)\n   373→                    result[\"parameters\"][\"reference_assets\"] = []\n   374→                    result[\"reference_assets\"] = []\n   375→                    warnings = result.setdefault(\"reference_asset_warnings\", [])\n   376→                    warnings.append(\"主图保存失败，参考图已回滚\")\n   377→                    logger.warning(f\"参考图已回滚: task_id={task_id}\")\n   378→\n   379→            logger.success(f\"图生图任务完成: {task_id}\")\n   380→            return result\n   381→\n   382→        except Exception as e:\n   383→            # 避免在日志中显示可能包含base64数据的异常信息\n   384→            error_msg = str(e)\n   385→            if len(error_msg) > 200:\n   386→                error_msg = error_msg[:200] + \"...[错误信息过长，已截断]\"\n   387→            logger.error(f\"图生图API调用失败: {error_msg}\")\n   388→            self._cleanup_reference_paths(ref_paths)\n   389→            return {\n   390→                \"task_id\": task_id,\n   391→                \"success\": False,\n   392→                \"error\": error_msg,\n   393→                \"type\": \"image_to_image\"\n   394→            }\n   395→\n   396→    def batch_generate_text_to_image(\n   397→        self,\n   398→        prompts: List[str],\n   399→        size: str = \"1024x1024\",\n   400→        guidance_scale: float = 2.5,\n   401→        save_local: bool = True,\n   402→    ) -> List[Dict[str, Any]]:\n   403→        \"\"\"\n   404→        批量生成文生图（顺序执行，保持向后兼容）\n   405→\n   406→        Args:\n   407→            prompts: 提示词列表\n   408→            size: 图像尺寸\n   409→            guidance_scale: 提示词一致性\n   410→            save_local: 是否保存到本地\n   411→\n   412→        Returns:\n   413→            List[Dict]: 生成结果列表\n   414→        \n   415→        Note:\n   416→            水印参数已固定为False，不再需要前端控制\n   417→            如需并发执行，请使用concurrent_generate_text_to_image方法\n   418→        \"\"\"\n   419→        logger.info(f\"开始批量文生图，共{len(prompts)}个任务\")\n   420→\n   421→        results = []\n   422→        for i, prompt in enumerate(prompts, 1):\n   423→            logger.info(f\"处理第{i}/{len(prompts)}个任务\")\n   424→\n   425→            result = self.generate_text_to_image(\n   426→                prompt=prompt,\n   427→                size=size,\n   428→                guidance_scale=guidance_scale,\n   429→                save_local=save_local,\n   430→                generation_id=None,\n   431→            )\n   432→\n   433→            results.append(result)\n   434→\n   435→        success_count = sum(1 for r in results if r[\"success\"])\n   436→        logger.info(f\"批量文生图完成，成功{success_count}/{len(prompts)}个\")\n   437→\n   438→        return results\n   439→\n   440→    def concurrent_generate_text_to_image(\n   441→        self,\n   442→        prompt: str,\n   443→        count: int = 4,\n   444→        size: str = \"1024x1024\",\n   445→        guidance_scale: float = 2.5,\n   446→        seed: int = -1,\n   447→        save_local: bool = True,\n   448→        progress_callback: Optional[Callable[[int, int, Dict[str, Any]], None]] = None,\n   449→        max_workers: int = 5,\n   450→        derived_ids: Optional[List[str]] = None,\n   451→        generation_id: Optional[str] = None,\n   452→    ) -> Dict[str, Any]:\n   453→        \"\"\"\n   454→        并发生成多张文生图\n   455→\n   456→        Args:\n   457→            prompt: 图像生成提示词\n   458→            count: 生成图片数量，默认4张，最多10张\n   459→            size: 图像尺寸\n   460→            guidance_scale: 引导强度\n   461→            seed: 随机种子，-1表示为每张图片生成不同的随机种子\n   462→            save_local: 是否保存到本地\n   463→            progress_callback: 进度回调函数，参数为(completed, total, result)\n   464→            max_workers: 最大并发数\n   465→\n   466→        Returns:\n   467→            Dict: 包含所有任务结果的字典\n   468→        \"\"\"\n   469→        # 验证参数\n   470→        if count < 1 or count > 10:\n   471→            raise ValueError(\"生成数量必须在1-10之间\")\n   472→        \n   473→        if max_workers > count:\n   474→            max_workers = count\n   475→        \n   476→        logger.info(f\"开始并发生成{count}张文生图: {prompt[:50]}...\")\n   477→        \n   478→        # 生成批次ID\n   479→        batch_id = str(uuid.uuid4())\n   480→        start_time = time.time()\n   481→\n   482→        slots = max(1, count)\n   483→        per_ids: List[str] = list(derived_ids or [])\n   484→        if len(per_ids) < slots:\n   485→            base = generation_id or batch_id\n   486→            for idx in range(len(per_ids), slots):\n   487→                per_ids.append(f\"{base}_{idx + 1}\")\n   488→        \n   489→        # 准备任务参数\n   490→        tasks = []\n   491→        for i in range(count):\n   492→            # 为每个任务生成不同的种子（如果seed为-1）\n   493→            task_seed = seed if seed != -1 else None\n   494→            gen_id = per_ids[i] if i < len(per_ids) else None\n   495→            tasks.append({\n   496→                'prompt': prompt,\n   497→                'size': size,\n   498→                'guidance_scale': guidance_scale,\n   499→                'seed': task_seed,\n   500→                'save_local': save_local,\n   501→                'task_index': i + 1,\n   502→                'generation_id': gen_id,\n   503→            })\n   504→        \n   505→        # 使用线程池并发执行\n   506→        results = []\n   507→        completed_count = 0\n   508→        \n   509→        with ThreadPoolExecutor(max_workers=max_workers) as executor:\n   510→            # 提交所有任务\n   511→            future_to_task = {\n   512→                executor.submit(self._execute_single_text_to_image_task, task): task \n   513→                for task in tasks\n   514→            }\n   515→            \n   516→            # 收集结果\n   517→            for future in as_completed(future_to_task):\n   518→                task = future_to_task[future]\n   519→                try:\n   520→                    result = future.result()\n   521→                    result['task_index'] = task['task_index']\n   522→                    result['batch_id'] = batch_id\n   523→                    results.append(result)\n   524→                    \n   525→                    completed_count += 1\n   526→                    \n   527→                    # 调用进度回调\n   528→                    if progress_callback:\n   529→                        try:\n   530→                            progress_callback(completed_count, count, result)\n   531→                        except Exception as e:\n   532→                            logger.warning(f\"进度回调执行失败: {e}\")\n   533→                    \n   534→                    logger.info(f\"任务 {task['task_index']}/{count} 完成\")\n   535→                    \n   536→                except Exception as e:\n   537→                    error_result = {\n   538→                        'task_index': task['task_index'],\n   539→                        'batch_id': batch_id,\n   540→                        'success': False,\n   541→                        'error': str(e),\n   542→                        'type': 'text_to_image'\n   543→                    }\n   544→                    results.append(error_result)\n   545→                    completed_count += 1\n   546→                    \n   547→                    if progress_callback:\n   548→                        try:\n   549→                            progress_callback(completed_count, count, error_result)\n   550→                        except Exception as e:\n   551→                            logger.warning(f\"进度回调执行失败: {e}\")\n   552→                    \n   553→                    # 避免在日志中显示可能包含base64数据的异常信息\n   554→                    error_msg = str(e)\n   555→                    if len(error_msg) > 200:\n   556→                        error_msg = error_msg[:200] + \"...[错误信息过长，已截断]\"\n   557→                    logger.error(f\"任务 {task['task_index']}/{count} 失败: {error_msg}\")\n   558→        \n   559→        # 按task_index排序\n   560→        results.sort(key=lambda x: x.get('task_index', 0))\n   561→        \n   562→        # 统计结果\n   563→        success_count = sum(1 for r in results if r.get('success', False))\n   564→        total_time = time.time() - start_time\n   565→        \n   566→        batch_result = {\n   567→            'batch_id': batch_id,\n   568→            'success': True,\n   569→            'prompt': prompt,\n   570→            'total_count': count,\n   571→            'success_count': success_count,\n   572→            'failed_count': count - success_count,\n   573→            'total_time': round(total_time, 2),\n   574→            'average_time': round(total_time / count, 2),\n   575→            'results': results,\n   576→            'parameters': {\n   577→                'size': size,\n   578→                'guidance_scale': guidance_scale,\n   579→                'seed': seed,\n   580→                'max_workers': max_workers\n   581→            },\n   582→            'derived_ids': per_ids,\n   583→            'created_at': datetime.now().isoformat()\n   584→        }\n   585→        \n   586→        logger.success(f\"并发文生图完成: {success_count}/{count} 成功，耗时 {total_time:.2f}s\")\n   587→        return batch_result\n   588→\n   589→    def concurrent_generate_image_to_image(\n   590→        self,\n   591→        prompt: str,\n   592→        image: str,\n   593→        count: int = 4,\n   594→        guidance_scale: float = 5.5,\n   595→        seed: int = -1,\n   596→        save_local: bool = True,\n   597→        progress_callback: Optional[Callable[[int, int, Dict[str, Any]], None]] = None,\n   598→        max_workers: int = 5,\n   599→        derived_ids: Optional[List[str]] = None,\n   600→        generation_id: Optional[str] = None,\n   601→    ) -> Dict[str, Any]:\n   602→        \"\"\"\n   603→        并发生成多张图生图\n   604→\n   605→        Args:\n   606→            prompt: 编辑提示词\n   607→            image: 输入图像路径或URL\n   608→            count: 生成图片数量，默认4张，最多10张\n   609→            guidance_scale: 引导强度\n   610→            seed: 随机种子，-1表示为每张图片生成不同的随机种子\n   611→            save_local: 是否保存到本地\n   612→            progress_callback: 进度回调函数\n   613→            max_workers: 最大并发数\n   614→\n   615→        Returns:\n   616→            Dict: 包含所有任务结果的字典\n   617→        \"\"\"\n   618→        # 验证参数\n   619→        if count < 1 or count > 10:\n   620→            raise ValueError(\"生成数量必须在1-10之间\")\n   621→        \n   622→        if max_workers > count:\n   623→            max_workers = count\n   624→        \n   625→        logger.info(f\"开始并发生成{count}张图生图: {prompt[:50]}...\")\n   626→        \n   627→        # 生成批次ID\n   628→        batch_id = str(uuid.uuid4())\n   629→        start_time = time.time()\n   630→        \n   631→        slots = max(1, count)\n   632→        per_ids: List[str] = list(derived_ids or [])\n   633→        if len(per_ids) < slots:\n   634→            base = generation_id or batch_id\n   635→            for idx in range(len(per_ids), slots):\n   636→                per_ids.append(f\"{base}_{idx + 1}\")\n   637→        \n   638→        # 准备输入图像\n   639→        image_data = self._prepare_input_image(image)\n   640→        if not image_data:\n   641→            return {\n   642→                'batch_id': batch_id,\n   643→                'success': False,\n   644→                'error': '无法处理输入图像',\n   645→                'type': 'image_to_image'\n   646→            }\n   647→        \n   648→        # 准备任务参数\n   649→        tasks = []\n   650→        for i in range(count):\n   651→            task_seed = seed if seed != -1 else None\n   652→            gen_id = per_ids[i] if i < len(per_ids) else None\n   653→            tasks.append({\n   654→                'prompt': prompt,\n   655→                'image': image_data,\n   656→                'guidance_scale': guidance_scale,\n   657→                'seed': task_seed,\n   658→                'save_local': save_local,\n   659→                'task_index': i + 1,\n   660→                'generation_id': gen_id\n   661→            })\n   662→        \n   663→        # 使用线程池并发执行\n   664→        results = []\n   665→        completed_count = 0\n   666→        \n   667→        with ThreadPoolExecutor(max_workers=max_workers) as executor:\n   668→            # 提交所有任务\n   669→            future_to_task = {\n   670→                executor.submit(self._execute_single_image_to_image_task, task): task \n   671→                for task in tasks\n   672→            }\n   673→            \n   674→            # 收集结果\n   675→            for future in as_completed(future_to_task):\n   676→                task = future_to_task[future]\n   677→                try:\n   678→                    result = future.result()\n   679→                    result['task_index'] = task['task_index']\n   680→                    result['batch_id'] = batch_id\n   681→                    results.append(result)\n   682→                    \n   683→                    completed_count += 1\n   684→                    \n   685→                    # 调用进度回调\n   686→                    if progress_callback:\n   687→                        try:\n   688→                            progress_callback(completed_count, count, result)\n   689→                        except Exception as e:\n   690→                            logger.warning(f\"进度回调执行失败: {e}\")\n   691→                    \n   692→                    logger.info(f\"任务 {task['task_index']}/{count} 完成\")\n   693→                    \n   694→                except Exception as e:\n   695→                    error_result = {\n   696→                        'task_index': task['task_index'],\n   697→                        'batch_id': batch_id,\n   698→                        'success': False,\n   699→                        'error': str(e),\n   700→                        'type': 'image_to_image'\n   701→                    }\n   702→                    results.append(error_result)\n   703→                    completed_count += 1\n   704→                    \n   705→                    if progress_callback:\n   706→                        try:\n   707→                            progress_callback(completed_count, count, error_result)\n   708→                        except Exception as e:\n   709→                            logger.warning(f\"进度回调执行失败: {e}\")\n   710→                    \n   711→                    # 避免在日志中显示可能包含base64数据的异常信息\n   712→                    error_msg = str(e)\n   713→                    if len(error_msg) > 200:\n   714→                        error_msg = error_msg[:200] + \"...[错误信息过长，已截断]\"\n   715→                    logger.error(f\"任务 {task['task_index']}/{count} 失败: {error_msg}\")\n   716→        \n   717→        # 按task_index排序\n   718→        results.sort(key=lambda x: x.get('task_index', 0))\n   719→        \n   720→        # 统计结果\n   721→        success_count = sum(1 for r in results if r.get('success', False))\n   722→        total_time = time.time() - start_time\n   723→        \n   724→        # 处理input_image字段，避免在日志中输出大量base64数据\n   725→        input_image_info = \"[图像数据]\"\n   726→        if image:\n   727→            if image.startswith(\"data:image/\"):\n   728→                # 如果是base64数据，只保留格式信息\n   729→                format_part = image.split(';')[0] if ';' in image else \"data:image/unknown\"\n   730→                input_image_info = f\"{format_part};base64,[数据已隐藏]\"\n   731→            elif image.startswith((\"http://\", \"https://\")):\n   732→                # 如果是URL，保留URL\n   733→                input_image_info = image\n   734→            else:\n   735→                # 如果是文件路径，只保留文件名\n   736→                input_image_info = f\"[本地文件: {Path(image).name}]\"\n   737→        \n   738→        batch_result = {\n   739→            'batch_id': batch_id,\n   740→            'success': True,\n   741→            'prompt': prompt,\n   742→            'input_image': input_image_info,\n   743→            'total_count': count,\n   744→            'success_count': success_count,\n   745→            'failed_count': count - success_count,\n   746→            'total_time': round(total_time, 2),\n   747→            'average_time': round(total_time / count, 2),\n   748→            'results': results,\n   749→            'parameters': {\n   750→                'guidance_scale': guidance_scale,\n   751→                'seed': seed,\n   752→                'max_workers': max_workers\n   753→            },\n   754→            'derived_ids': per_ids,\n   755→            'created_at': datetime.now().isoformat()\n   756→        }\n   757→        \n   758→        logger.success(f\"并发图生图完成: {success_count}/{count} 成功，耗时 {total_time:.2f}s\")\n   759→        return batch_result\n   760→\n   761→    def _execute_single_text_to_image_task(self, task: Dict[str, Any]) -> Dict[str, Any]:\n   762→        \"\"\"\n   763→        执行单个文生图任务\n   764→        \n   765→        Args:\n   766→            task: 任务参数字典\n   767→            \n   768→        Returns:\n   769→            Dict: 任务执行结果\n   770→        \"\"\"\n   771→        return self.generate_text_to_image(\n   772→            prompt=task['prompt'],\n   773→            size=task['size'],\n   774→            guidance_scale=task['guidance_scale'],\n   775→            seed=task['seed'],\n   776→            save_local=task['save_local'],\n   777→            generation_id=task.get('generation_id'),\n   778→        )\n   779→    \n   780→    def _execute_single_image_to_image_task(self, task: Dict[str, Any]) -> Dict[str, Any]:\n   781→        \"\"\"\n   782→        执行单个图生图任务\n   783→        \n   784→        Args:\n   785→            task: 任务参数字典\n   786→            \n   787→        Returns:\n   788→            Dict: 任务执行结果\n   789→        \"\"\"\n   790→        # 生成唯一ID，优先使用外部传入的generation_id\n   791→        task_id = task.get('generation_id') or str(uuid.uuid4())\n   792→        \n   793→        try:\n   794→            # 直接使用已经处理好的图片数据，避免重复处理\n   795→            image_data = task['image']\n   796→            \n   797→            # 调用API生成图像\n   798→            api_result = self.client.image_to_image(\n   799→                prompt=task['prompt'], \n   800→                image=image_data, \n   801→                guidance_scale=task['guidance_scale'], \n   802→                seed=task['seed']\n   803→            )\n   804→            \n   805→            result = {\n   806→                \"task_id\": task_id,\n   807→                \"success\": True,\n   808→                \"type\": \"image_to_image\",\n   809→                \"prompt\": task['prompt'],\n   810→                \"image_url\": api_result[\"data\"][\"images\"][0][\"url\"],\n   811→                \"parameters\": {\n   812→                    \"guidance_scale\": task['guidance_scale'], \n   813→                    \"seed\": task['seed'], \n   814→                    \"response_format\": \"url\",\n   815→                    \"watermark\": False,\n   816→                    \"size\": \"adaptive\",\n   817→                    \"model\": \"doubao-seededit-3-0-i2i-250628\"\n   818→                },\n   819→                \"created_at\": datetime.now().isoformat(),\n   820→                \"usage\": api_result.get(\"usage\", {}),\n   821→            }\n   822→            \n   823→            # 保存到本地\n   824→            if task['save_local'] and result.get(\"image_url\"):\n   825→                local_result = self._save_image_locally(result)\n   826→                result.update(local_result)\n   827→            \n   828→            return result\n   829→            \n   830→        except Exception as e:\n   831→            # 避免在日志中显示可能包含base64数据的异常信息\n   832→            error_msg = str(e)\n   833→            if len(error_msg) > 200:\n   834→                error_msg = error_msg[:200] + \"...[错误信息过长，已截断]\"\n   835→            return {\n   836→                \"task_id\": task_id,\n   837→                \"success\": False,\n   838→                \"error\": error_msg,\n   839→                \"type\": \"image_to_image\"\n   840→            }\n   841→\n   842→    def _save_image_locally(self, result: Dict[str, Any]) -> Dict[str, Any]:\n   843→        \"\"\"\n   844→        保存图像到本地并记录元数据\n   845→\n   846→        Args:\n   847→            result: API生成结果\n   848→\n   849→        Returns:\n   850→            Dict: 包含本地文件信息的字典\n   851→        \"\"\"\n   852→        try:\n   853→            # 下载图像\n   854→            image_url = result[\"image_url\"]\n   855→            response = safe_requests_get(image_url, timeout=30)\n   856→\n   857→            # 先解析真实像素尺寸（以真实像素为准，避免使用size推测）\n   858→            from io import BytesIO\n   859→            real_w, real_h = None, None\n   860→            try:\n   861→                with Image.open(BytesIO(response.content)) as img:\n   862→                    real_w, real_h = int(img.width), int(img.height)\n   863→            except Exception as _e:\n   864→                logger.warning(f\"无法从图像数据读取真实尺寸，回退至size参数: {_e}\")\n   865→                real_w = self._extract_width_from_size(result.get(\"parameters\", {}).get(\"size\", \"1024x1024\"))\n   866→                real_h = self._extract_height_from_size(result.get(\"parameters\", {}).get(\"size\", \"1024x1024\"))\n   867→\n   868→            # 组装元数据（适配UnifiedStorageManager的格式）\n   869→            params = result.get(\"parameters\", {}) or {}\n   870→            # 若无比例信息，按真实像素计算一个 ratio 文本（约分）\n   871→            try:\n   872→                if not params.get('ratio') and real_w and real_h and real_w > 0 and real_h > 0:\n   873→                    from math import gcd\n   874→                    g = gcd(real_w, real_h)\n   875→                    params['ratio'] = f\"{real_w//g}:{real_h//g}\"\n   876→            except Exception:\n   877→                pass\n   878→\n   879→            metadata = {\n   880→                'generation_id': result.get(\"task_id\", \"\"),\n   881→                'prompt': result.get(\"prompt\", \"\"),\n   882→                'parameters': params,\n   883→                'model': params.get(\"model\", \"seedream\"),\n   884→                'width': real_w,\n   885→                'height': real_h,\n   886→                'generation_time': result.get(\"generation_time\", 0),\n   887→                'batch_id': result.get(\"batch_id\", \"\"),\n   888→                'status': 'completed'\n   889→            }\n   890→            \n   891→            # 使用统一存储管理器保存文件\n   892→            save_result = self.storage_manager.save_content_file(\n   893→                content_type='images',\n   894→                file_data=response.content,\n   895→                url=image_url,\n   896→                metadata=metadata\n   897→            )\n   898→\n   899→            # 获取图像信息（再次确认像素尺寸）\n   900→            image_info = self._get_image_info(Path(save_result['local_path']))\n   901→            file_size = Path(save_result['local_path']).stat().st_size\n   902→\n   903→            logger.success(f\"图像已保存到本地: {Path(save_result['local_path']).name}\")\n   904→\n   905→            result_obj = {\n   906→                \"local_path\": save_result['local_path'],\n   907→                \"filename\": Path(save_result['local_path']).name,\n   908→                \"file_size\": file_size,\n   909→                \"image_info\": image_info,\n   910→                \"file_path\": save_result['local_path'],  # 保持兼容性\n   911→                \"thumbnail_path\": save_result.get('thumbnail_path'),  # 缩略图路径\n   912→                # 修复：确保 file_id 和 relative_path 被返回，用于占位符替换\n   913→                \"file_id\": save_result.get('file_id'),\n   914→                \"relative_path\": save_result.get('relative_path'),\n   915→            }\n   916→            try:\n   917→                w = image_info.get('width') if isinstance(image_info, dict) else None\n   918→                h = image_info.get('height') if isinstance(image_info, dict) else None\n   919→                logger.info(\n   920→                    f\"摘要|operation=save_image status=success file={result_obj['filename']} size={file_size}B width={w} height={h}\"\n   921→                )\n   922→            except Exception:\n   923→                pass\n   924→\n   925→            # 体验版本地图片水印（使用统一水印服务）\n   926→            if should_add_watermark():\n   927→                try:\n   928→                    from edition.watermark_service import WatermarkService\n   929→\n   930→                    watermark_text = get_watermark_text() or \"PIGEON\"\n   931→                    try:\n   932→                        opacity = get_watermark_opacity()\n   933→                    except Exception:\n   934→                        opacity = 0.3\n   935→                    opacity = max(0.0, min(opacity, 1.0))\n   936→\n   937→                    watermark_service = WatermarkService(watermark_text, opacity=opacity)\n   938→                    watermark_applied = watermark_service.apply_to_image(Path(save_result['local_path']))\n   939→                    if watermark_applied:\n   940→                        logger.success(f\"图片水印添加成功: {Path(save_result['local_path']).name}\")\n   941→                        result_obj[\"watermark_applied\"] = True\n   942→                    else:\n   943→                        logger.warning(f\"图片水印添加失败: {Path(save_result['local_path']).name}\")\n   944→                        result_obj[\"watermark_applied\"] = False\n   945→                except Exception as e:\n   946→                    logger.warning(f\"添加图片水印时出错: {e}\")\n   947→                    result_obj[\"watermark_applied\"] = False\n   948→\n   949→            return result_obj\n   950→\n   951→        except Exception as e:\n   952→            logger.error(f\"保存图像到本地失败: {e}\")\n   953→            try:\n   954→                logger.info(\"摘要|operation=save_image status=failed\")\n   955→            except Exception:\n   956→                pass\n   957→            return {\"local_save_error\": str(e)}\n   958→\n   959→    def _generate_reference_asset_id(self, file_data: bytes) -> str:\n   960→        checksum = hashlib.sha1(file_data).hexdigest()\n   961→        ts = datetime.now().strftime(\"%Y%m%d%H%M%S%f\")\n   962→        return f\"ref_{ts}_{checksum[:8]}\"\n   963→\n   964→    def _load_reference_source(self, ref: Any) -> Optional[Tuple[bytes, str, Dict[str, Any]]]:\n   965→        \"\"\"解析参考图来源，返回 (bytes, 扩展名, 元信息)。\"\"\"\n   966→        source_meta: Dict[str, Any] = {}\n   967→        raw = ref\n   968→        if isinstance(ref, dict):\n   969→            for key in ('source', 'order', 'type', 'extension', 'width', 'height'):\n   970→                if ref.get(key) is not None:\n   971→                    source_meta[key] = ref.get(key)\n   972→            raw = ref.get('data') or ref.get('path') or ref.get('url') or ref.get('value')\n   973→        if raw is None:\n   974→            return None\n   975→\n   976→        extension = source_meta.get('extension')\n   977→        data = None\n   978→        source_repr = source_meta.get('source')\n   979→\n   980→        try:\n   981→            if isinstance(raw, bytes):\n   982→                data = raw\n   983→            elif isinstance(raw, str):\n   984→                stripped = raw.strip()\n   985→                if stripped.startswith('data:') and ';base64,' in stripped:\n   986→                    header, payload = stripped.split(';base64,', 1)\n   987→                    mime_part = header[5:]\n   988→                    extension = extension or mimetypes.guess_extension(mime_part) or '.png'\n   989→                    data = base64.b64decode(payload)\n   990→                    source_repr = source_repr or mime_part\n   991→                    source_meta.setdefault('type', 'image')\n   992→                elif stripped.startswith(('http://', 'https://')):\n   993→                    resp = safe_requests_get(stripped, timeout=15)\n   994→                    data = resp.content\n   995→                    parsed = urlparse(stripped)\n   996→                    extension = extension or Path(parsed.path).suffix or mimetypes.guess_extension(resp.headers.get('Content-Type', '')) or '.png'\n   997→                    source_repr = source_repr or stripped\n   998→                    source_meta.setdefault('source_url', stripped)\n   999→                else:\n  1000→                    path = Path(stripped)\n  1001→                    if not path.exists():\n  1002→                        logger.warning(f\"引用图像不存在: {stripped}\")\n  1003→                        return None\n  1004→                    data = path.read_bytes()\n  1005→                    extension = extension or path.suffix or '.png'\n  1006→                    source_repr = source_repr or path.name\n  1007→                    source_meta.setdefault('source_path', str(path))\n  1008→            else:\n  1009→                logger.warning(f\"不支持的参考图类型: {type(raw)}\")\n  1010→                return None\n  1011→        except Exception as exc:\n  1012→            logger.warning(f\"加载参考图失败: {exc}\")\n  1013→            return None\n  1014→\n  1015→        if data is None:\n  1016→            return None\n  1017→\n  1018→        width = source_meta.get('width')\n  1019→        height = source_meta.get('height')\n  1020→        if source_meta.get('type', 'image') == 'image' and (width is None or height is None):\n  1021→            try:\n  1022→                from io import BytesIO\n  1023→\n  1024→                with Image.open(BytesIO(data)) as img:\n  1025→                    width = img.width\n  1026→                    height = img.height\n  1027→            except Exception:\n  1028→                pass\n  1029→\n  1030→        source_meta['width'] = width\n  1031→        source_meta['height'] = height\n  1032→        source_meta.setdefault('type', 'image')\n  1033→        source_meta['source'] = source_repr or source_meta.get('source')\n  1034→\n  1035→        return data, extension, source_meta\n  1036→\n  1037→    def _process_reference_assets(\n  1038→        self,\n  1039→        references: Optional[List[Any]],\n  1040→        *,\n  1041→        max_refs: int = MAX_REFERENCE_IMAGES,\n  1042→        expected_outputs: int = 1,\n  1043→    ) -> Dict[str, Any]:\n  1044→        \"\"\"拷贝参考图到 references 目录并返回处理结果摘要。\"\"\"\n  1045→        stored: List[Dict[str, Any]] = []\n  1046→        absolute_paths: List[str] = []\n  1047→        errors: List[str] = []\n  1048→        warnings: List[str] = []\n  1049→\n  1050→        if not references:\n  1051→            return {\n  1052→                'assets': stored,\n  1053→                'paths': absolute_paths,\n  1054→                'errors': errors,\n  1055→                'warnings': warnings,\n  1056→            }\n  1057→\n  1058→        if max_refs is not None and max_refs > 0 and len(references) > max_refs:\n  1059→            warnings.append(\n  1060→                f\"参考图数量超过 {max_refs}（官方文档行203-204），已按顺序截取前 {max_refs} 张\"\n  1061→            )\n  1062→            references = references[:max_refs]\n  1063→\n  1064→        for order, item in enumerate(references):\n  1065→            load_result = self._load_reference_source(item)\n  1066→            if not load_result:\n  1067→                errors.append(f\"ref[{order}] 加载失败\")\n  1068→                continue\n  1069→\n  1070→            file_data, extension, meta = load_result\n  1071→            meta.setdefault('order', order)\n  1072→            meta.setdefault('kind', meta.get('type', 'image'))\n  1073→\n  1074→            try:\n  1075→                asset_id = self._generate_reference_asset_id(file_data)\n  1076→                record = self.storage_manager.save_reference_asset(\n  1077→                    'images',\n  1078→                    file_data,\n  1079→                    asset_id=asset_id,\n  1080→                    extension=extension,\n  1081→                    metadata=meta,\n  1082→                )\n  1083→                try:\n  1084→                    record['_payload_b64'] = base64.b64encode(file_data).decode('utf-8')\n  1085→                except Exception:\n  1086→                    record['_payload_b64'] = None\n  1087→                record['_source_meta'] = meta\n  1088→                stored.append(record)\n  1089→                if record.get('absolute_path'):\n  1090→                    absolute_paths.append(record['absolute_path'])\n  1091→            except Exception as exc:\n  1092→                logger.warning(f\"保存参考图失败: {exc}\")\n  1093→                errors.append(f\"ref[{order}] 保存失败\")\n  1094→\n  1095→        if expected_outputs >= 0 and len(stored) + expected_outputs > MAX_REFERENCE_BUNDLE:\n  1096→            allowed = max(0, MAX_REFERENCE_BUNDLE - expected_outputs)\n  1097→            if len(stored) > allowed:\n  1098→                warnings.append(\n  1099→                    f\"参考图与生成量合计超过 {MAX_REFERENCE_BUNDLE}（官方文档行203-204），已截取前 {allowed} 张\"\n  1100→                )\n  1101→                stored = stored[:allowed]\n  1102→                absolute_paths = absolute_paths[:allowed]\n  1103→\n  1104→        return {\n  1105→            'assets': stored,\n  1106→            'paths': absolute_paths,\n  1107→            'errors': errors,\n  1108→            'warnings': warnings,\n  1109→        }\n  1110→\n  1111→    def _build_reference_payloads(self, assets: List[Dict[str, Any]]) -> List[str]:\n  1112→        payloads: List[str] = []\n  1113→        for asset in assets or []:\n  1114→            payload = asset.get('_payload_b64')\n  1115→            if not payload:\n  1116→                continue\n  1117→            path_hint = asset.get('path') or asset.get('_source_meta', {}).get('source_path')\n  1118→            mime = 'image/png'\n  1119→            try:\n  1120→                if path_hint:\n  1121→                    suffix = Path(path_hint).suffix.lower()\n  1122→                    if suffix in {'.jpg', '.jpeg'}:\n  1123→                        mime = 'image/jpeg'\n  1124→                    elif suffix == '.webp':\n  1125→                        mime = 'image/webp'\n  1126→                    elif suffix == '.bmp':\n  1127→                        mime = 'image/bmp'\n  1128→                    elif suffix == '.gif':\n  1129→                        mime = 'image/gif'\n  1130→            except Exception:\n  1131→                pass\n  1132→            payloads.append(f\"data:{mime};base64,{payload}\")\n  1133→        return payloads\n  1134→\n  1135→    def _resolve_model_id(self, default_model: str, v4_model: str) -> str:\n  1136→        provider = (self.client.last_provider() or \"\").lower()\n  1137→        if provider in {\"volc_v4\", \"volcengine_v4\"}:\n  1138→            return v4_model\n  1139→        return default_model\n  1140→\n  1141→    def _sanitize_reference_assets(self, assets: List[Dict[str, Any]]) -> List[Dict[str, Any]]:\n  1142→        cleaned: List[Dict[str, Any]] = []\n  1143→        for rec in assets or []:\n  1144→            rec.pop('_payload_b64', None)\n  1145→            rec.pop('_source_meta', None)\n  1146→            rec.pop('absolute_path', None)\n  1147→            cleaned.append({\n  1148→                'id': rec.get('id') or rec.get('asset_id') or rec.get('reference_id'),  # 兼容多种ID字段名\n  1149→                'path': rec.get('path') or rec.get('relative_path') or rec.get('asset_path'),  # 确保有path字段\n  1150→                'type': rec.get('type'),\n  1151→                'kind': rec.get('kind'),\n  1152→                'source': rec.get('source'),\n  1153→                'order': rec.get('order'),\n  1154→                'checksum': rec.get('checksum') or rec.get('file_hash'),  # 兼容不同的哈希字段名\n  1155→                'size': rec.get('size') or rec.get('file_size'),  # 兼容不同的大小字段名\n  1156→                'width': rec.get('width'),\n  1157→                'height': rec.get('height'),\n  1158→                'created_at': rec.get('created_at'),\n  1159→            })\n  1160→        return cleaned\n  1161→\n  1162→    @staticmethod\n  1163→    def _summarize_reference_ids(assets: List[Dict[str, Any]]) -> str:\n  1164→        masked: List[str] = []\n  1165→        for rec in assets or []:\n  1166→            rid = rec.get('id') or ''\n  1167→            if not rid:\n  1168→                continue\n  1169→            masked.append(f\"{rid[:6]}***\")\n  1170→        return \",\".join(masked)\n  1171→\n  1172→    @staticmethod\n  1173→    def _provider_hint() -> str:\n  1174→        try:\n  1175→            return os.environ.get(\"GEMENG_SEEDREAM_PROVIDER\", \"volc_v3\")\n  1176→        except Exception:\n  1177→            return \"unknown\"\n  1178→\n  1179→    def _provider_used(self) -> str:\n  1180→        provider = self.client.last_provider() if hasattr(self.client, \"last_provider\") else None\n  1181→        if provider:\n  1182→            return provider\n  1183→        return self._provider_hint()\n  1184→\n  1185→    @staticmethod\n  1186→    def _cleanup_reference_paths(paths: List[str]):\n  1187→        for path in paths or []:\n  1188→            try:\n  1189→                if path and Path(path).exists():\n  1190→                    Path(path).unlink(missing_ok=True)\n  1191→            except Exception as exc:\n  1192→                logger.debug(f\"参考图清理失败: {exc}\")\n  1193→\n  1194→    def _prepare_input_image(self, image_path: str) -> Optional[str]:\n  1195→        \"\"\"\n  1196→        准备输入图像，支持本地文件和URL\n  1197→        \n  1198→        Args:\n  1199→            image_path: 图像路径（本地路径或URL）\n  1200→            \n  1201→        Returns:\n  1202→            str: 图像URL、base64数据或None\n  1203→        \"\"\"\n  1204→        try:\n  1205→            # 如果是URL，直接返回\n  1206→            if image_path.startswith((\"http://\", \"https://\")):\n  1207→                return image_path\n  1208→\n  1209→            # 如果是本地文件，转换为Base64\n  1210→            local_path = Path(image_path)\n  1211→            if local_path.exists():\n  1212→                with open(local_path, \"rb\") as f:\n  1213→                    image_data = f.read()\n  1214→\n  1215→                # 检测图像格式\n  1216→                image = Image.open(local_path)\n  1217→                format_name = image.format.lower()\n  1218→\n  1219→                # 转换为Base64\n  1220→                base64_data = base64.b64encode(image_data).decode(\"utf-8\")\n  1221→                return f\"data:image/{format_name};base64,{base64_data}\"\n  1222→\n  1223→            logger.error(f\"图像文件不存在: {image_path}\")\n  1224→            return None\n  1225→\n  1226→        except Exception as e:\n  1227→            logger.error(f\"处理输入图像失败: {e}\")\n  1228→            return None\n  1229→\n  1230→    def _extract_width_from_size(self, size: str) -> int:\n  1231→        \"\"\"\n  1232→        从尺寸字符串中提取宽度\n  1233→        \n  1234→        Args:\n  1235→            size: 尺寸字符串，如 \"1024x1024\"\n  1236→            \n  1237→        Returns:\n  1238→            int: 宽度值\n  1239→        \"\"\"\n  1240→        try:\n  1241→            return int(size.split('x')[0])\n  1242→        except (ValueError, IndexError):\n  1243→            return 1024  # 默认值\n  1244→    \n  1245→    def _extract_height_from_size(self, size: str) -> int:\n  1246→        \"\"\"\n  1247→        从尺寸字符串中提取高度\n  1248→        \n  1249→        Args:\n  1250→            size: 尺寸字符串，如 \"1024x1024\"\n  1251→            \n  1252→        Returns:\n  1253→            int: 高度值\n  1254→        \"\"\"\n  1255→        try:\n  1256→            return int(size.split('x')[1])\n  1257→        except (ValueError, IndexError):\n  1258→            return 1024  # 默认值\n  1259→\n  1260→    def _get_image_info(self, image_path: Path) -> Dict[str, Any]:\n  1261→        \"\"\"\n  1262→        获取图像信息\n  1263→\n  1264→        Args:\n  1265→            image_path: 图像文件路径\n  1266→\n  1267→        Returns:\n  1268→            Dict: 图像信息\n  1269→        \"\"\"\n  1270→        try:\n  1271→            with Image.open(image_path) as img:\n  1272→                return {\"width\": img.width, \"height\": img.height, \"format\": img.format, \"mode\": img.mode}\n  1273→        except Exception as e:\n  1274→            logger.error(f\"获取图像信息失败: {e}\")\n  1275→            return {\"width\": 0, \"height\": 0, \"format\": \"unknown\", \"mode\": \"unknown\"}\n  1276→\n  1277→    def get_generation_history(self, limit: int = 50) -> List[Dict[str, Any]]:\n  1278→        \"\"\"\n  1279→        获取图像生成历史记录\n  1280→\n  1281→        Args:\n  1282→            limit: 返回记录数量限制\n  1283→\n  1284→        Returns:\n  1285→            List[Dict]: 历史记录列表\n  1286→        \"\"\"\n  1287→        return self.storage_manager.load_history('images', limit=limit)\n  1288→\n  1289→    def search_by_prompt(self, keyword: str) -> List[Dict[str, Any]]:\n  1290→        \"\"\"\n  1291→        根据提示词关键字搜索历史记录\n  1292→\n  1293→        Args:\n  1294→            keyword: 搜索关键字\n  1295→\n  1296→        Returns:\n  1297→            List[Dict]: 匹配的记录列表\n  1298→        \"\"\"\n  1299→        # 获取所有历史记录并在内存中过滤\n  1300→        all_records = self.storage_manager.load_history('images', limit=1000)\n  1301→        return [record for record in all_records if keyword.lower() in record.get('prompt', '').lower()]\n  1302→\n  1303→    def get_statistics(self) -> Dict[str, Any]:\n  1304→        \"\"\"\n  1305→        获取生成统计信息\n  1306→\n  1307→        Returns:\n  1308→            Dict: 统计信息\n  1309→        \"\"\"\n  1310→        try:\n  1311→            # 使用统一存储管理器获取存储统计\n  1312→            storage_stats = self.storage_manager.get_storage_stats()\n  1313→            image_stats = storage_stats.get('content_types', {}).get('images', {})\n  1314→            \n  1315→            # 获取历史记录进行详细统计\n  1316→            all_records = self.storage_manager.load_history('images', limit=1000)\n  1317→            \n  1318→            if not all_records:\n  1319→                return {\n  1320→                    \"total_images\": 0,\n  1321→                    \"text_to_image_count\": 0,\n  1322→                    \"image_to_image_count\": 0,\n  1323→                    \"total_file_size\": 0,\n  1324→                    \"average_file_size\": 0,\n  1325→                    \"most_common_size\": \"unknown\"\n  1326→                }\n  1327→\n  1328→            # 统计不同类型的图片数量\n  1329→            text_to_image_count = 0\n  1330→            image_to_image_count = 0\n  1331→            total_file_size = 0\n  1332→            sizes = []\n  1333→            \n  1334→            for record in all_records:\n  1335→                # 从参数中判断类型（因为新格式可能没有直接的type字段）\n  1336→                if 'input_image' in record.get('parameters', {}):\n  1337→                    image_to_image_count += 1\n  1338→                else:\n  1339→                    text_to_image_count += 1\n  1340→                \n  1341→                # 计算文件大小\n  1342→                file_size = record.get('file_size', 0)\n  1343→                if isinstance(file_size, str) and file_size.isdigit():\n  1344→                    file_size = int(file_size)\n  1345→                elif not isinstance(file_size, (int, float)):\n  1346→                    file_size = 0\n  1347→                total_file_size += file_size\n  1348→                \n  1349→                # 收集尺寸信息\n  1350→                width = record.get('width', 0)\n  1351→                height = record.get('height', 0)\n  1352→                if width and height:\n  1353→                    sizes.append(f\"{width}x{height}\")\n  1354→\n  1355→            stats = {\n  1356→                \"total_images\": len(all_records),\n  1357→                \"text_to_image_count\": text_to_image_count,\n  1358→                \"image_to_image_count\": image_to_image_count,\n  1359→                \"total_file_size\": total_file_size,\n  1360→                \"average_file_size\": total_file_size / len(all_records) if all_records else 0,\n  1361→                \"most_common_size\": \"unknown\",\n  1362→                \"creation_dates\": [record.get('created_at', '') for record in all_records[-10:]]  # 最近10次\n  1363→            }\n  1364→\n  1365→            # 最常用的尺寸\n  1366→            if sizes:\n  1367→                from collections import Counter\n  1368→                size_counts = Counter(sizes)\n  1369→                stats[\"most_common_size\"] = size_counts.most_common(1)[0][0]\n  1370→\n  1371→            return stats\n  1372→\n  1373→        except Exception as e:\n  1374→            logger.error(f\"获取统计信息失败: {e}\")\n  1375→            return {\n  1376→                \"total_images\": 0,\n  1377→                \"text_to_image_count\": 0,\n  1378→                \"image_to_image_count\": 0,\n  1379→                \"total_file_size\": 0,\n  1380→                \"average_file_size\": 0,\n  1381→                \"most_common_size\": \"unknown\"\n  1382→            }\n  1383→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"8412d5fa-9561-4b96-a7c3-c36871c9597c","timestamp":"2025-11-25T19:09:03.643Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/manager.py","content":"# Seedream图像生成管理器\n# 负责图像生成的业务逻辑和本地存储管理\n# 路径真源说明：存储路径仅允许通过 config_api.get_storage_dir() + V2 工厂注入；\n# 禁止通过构造参数传入路径，杜绝多根与兼容分支。\n\nimport os\nimport uuid\nimport requests\nfrom ..utils.safe_requests import safe_requests_get\nimport hashlib\nimport mimetypes\nfrom datetime import datetime\nfrom pathlib import Path\nfrom typing import Dict, Any, List, Optional, Callable, Tuple\nfrom PIL import Image\nfrom loguru import logger\nfrom urllib.parse import urlparse\nimport base64\nimport asyncio\nimport aiohttp\nimport threading\nfrom concurrent.futures import ThreadPoolExecutor, as_completed\nimport time\n\nfrom .client import SeedreamClient\nfrom ..storage import get_v2_storage_manager\nfrom ..provider.schema import (\n    TextToImageParams,\n    ImageToImageParams,\n    validate_and_normalize_t2i,\n    validate_and_normalize_i2i,\n    MAX_REFERENCE_IMAGES,\n    MAX_REFERENCE_BUNDLE,\n)\nfrom config_api import get_storage_dir\n\n# 使用统一水印服务（edition/watermark_service.py）\nfrom edition.watermark_service import (\n    should_add_watermark,\n    get_watermark_text,\n    get_watermark_opacity,\n)\n\n\nclass SeedreamManager:\n    \"\"\"Seedream图像生成管理器\"\"\"\n\n    def __init__(self, api_key: str = None):\n        \"\"\"\n        初始化Seedream管理器\n\n        Args:\n            api_key: 火山引擎API密钥，如果为None则从ConfigManager获取\n        \"\"\"\n        self.client = SeedreamClient(api_key)\n        \n        # 使用V2统一存储管理器（与单一真源对齐）\n        self.storage_manager = get_v2_storage_manager(get_storage_dir())\n        \n        # 保持兼容性别名\n        self.file_manager = self.storage_manager\n        self.metadata_manager = self.storage_manager\n        self.image_storage_manager = self.storage_manager\n        \n        # 保留原有的目录属性以保持兼容性\n        self.data_dir = Path(self.storage_manager.root_path)\n        self.images_dir = self.data_dir / \"images\"\n        self.metadata_dir = self.data_dir / \"metadata\"\n\n        logger.info(f\"Seedream管理器初始化完成，使用统一存储管理器，根目录: {self.storage_manager.root_path}\")\n\n    def generate_text_to_image(\n        self,\n        prompt: str,\n        size: str = \"1024x1024\",\n        guidance_scale: float = 2.5,\n        seed: int = -1,\n        save_local: bool = True,\n        reference_images: Optional[List[Any]] = None,\n        model_variant: Optional[str] = None,\n        generation_id: Optional[str] = None,\n    ) -> Dict[str, Any]:\n        \"\"\"\n        生成文生图并保存到本地\n\n        Args:\n            prompt: 图像生成提示词\n            size: 图像尺寸，支持的尺寸见client.get_supported_sizes()\n            guidance_scale: 引导强度，范围[1.0, 10.0]\n            seed: 随机种子，范围[-1, 2147483647]，None表示随机\n            response_format: 返回格式，\"url\"或\"b64_json\"\n            save_local: 是否保存到本地\n            reference_images: 参考图列表\n            model_variant: 模型变体，如 'seedream_v4' 使用 Seedream 4.0\n\n        Returns:\n            Dict: 生成结果，包含本地文件路径\n        \n        Note:\n            model和watermark参数已固定，不再需要前端控制\n        \"\"\"\n        logger.info(f\"开始文生图任务: {prompt[:50]}... (model_variant: {model_variant})\")\n        \n        # 根据 model_variant 设置环境变量\n        if model_variant == 'seedream_v4':\n            os.environ[\"GEMENG_SEEDREAM_PROVIDER\"] = \"volc_v4\"\n        else:\n            # 默认使用 volc_v3\n            os.environ[\"GEMENG_SEEDREAM_PROVIDER\"] = \"volc_v3\"\n\n        # 生成唯一ID，优先使用外部传入的generation_id\n        task_id = generation_id or str(uuid.uuid4())\n\n        ref_assets: List[Dict[str, Any]] = []\n        ref_paths: List[str] = []\n        ref_summary: Dict[str, Any] = {}\n        ref_payloads: List[str] = []\n\n        try:\n            if reference_images:\n                ref_summary = self._process_reference_assets(\n                    reference_images,\n                    max_refs=MAX_REFERENCE_IMAGES,\n                    expected_outputs=1,\n                )\n                ref_assets = list(ref_summary.get('assets', []))\n                ref_paths = list(ref_summary.get('paths', []))\n                ref_payloads = self._build_reference_payloads(ref_assets)\n\n                if ref_summary.get('errors'):\n                    logger.warning(\n                        f\"参考图处理不完整: count={len(ref_assets)} errors={len(ref_summary['errors'])}\"\n                    )\n                if ref_summary.get('warnings'):\n                    for warn in ref_summary['warnings']:\n                        logger.warning(f\"参考图提示: {warn}\")\n\n            # 前置参数校验（不改变业务流程，仅记录摘要与回退建议）\n            try:\n                norm, fb, reason = validate_and_normalize_t2i(\n                    TextToImageParams(\n                        prompt=prompt,\n                        size=size,\n                        guidance_scale=guidance_scale,\n                        seed=(None if seed == -1 else seed),\n                    )\n                )\n                logger.info(\n                    f\"摘要|operation=precheck_t2i size={norm.size} gs={norm.guidance_scale} seed={norm.seed} fallback={'yes' if fb else 'no'}\"\n                )\n                if fb:\n                    logger.warning(f\"前置参数回退建议: {reason}\")\n            except Exception as _e:\n                logger.debug(f\"前置参数校验跳过: {_e}\")\n            # 调用API生成图像（model和watermark参数已在客户端固定）\n            api_result = self.client.text_to_image(\n                prompt=prompt,\n                size=size,\n                guidance_scale=guidance_scale,\n                seed=seed,\n                reference_images=ref_payloads or None,\n            )\n\n            result = {\n                \"task_id\": task_id,\n                \"success\": True,\n                \"type\": \"text_to_image\",\n                \"prompt\": prompt,\n                \"image_url\": api_result[\"data\"][\"images\"][0][\"url\"],\n                \"parameters\": {\n                    \"size\": size, \n                    \"guidance_scale\": guidance_scale, \n                    \"seed\": seed, \n                    \"response_format\": \"url\",  # 固定值\n                    \"watermark\": False,  # 固定值\n                    \"model\": self._resolve_model_id(\n                        \"doubao-seedream-3-0-t2i-250415\",\n                        \"doubao-seedream-4-0-250828\",\n                    )\n                },\n                \"created_at\": datetime.now().isoformat(),\n                \"usage\": api_result.get(\"usage\", {}),\n            }\n\n            sanitized_refs = self._sanitize_reference_assets(ref_assets)\n            if sanitized_refs:\n                result[\"parameters\"][\"reference_assets\"] = sanitized_refs\n                result[\"reference_assets\"] = sanitized_refs\n                masked_ids = self._summarize_reference_ids(sanitized_refs)\n                logger.info(\n                    \"摘要|operation=t2i_reference reference_count={} ref_ids={} provider={}\",\n                    len(sanitized_refs),\n                    masked_ids or \"-\",\n                    self._provider_used(),\n                )\n            else:\n                result[\"parameters\"][\"reference_assets\"] = []\n                result[\"reference_assets\"] = []\n\n            # 保存到本地\n            if save_local and result.get(\"image_url\"):\n                local_result = self._save_image_locally(result)\n                result.update(local_result)\n                if local_result.get('local_save_error') and sanitized_refs:\n                    self._cleanup_reference_paths(ref_paths)\n                    result[\"parameters\"][\"reference_assets\"] = []\n                    result[\"reference_assets\"] = []\n                    warnings = result.setdefault(\"reference_asset_warnings\", [])\n                    warnings.append(\"主图保存失败，参考图已回滚\")\n                    logger.warning(f\"参考图已回滚: task_id={task_id}\")\n\n            logger.success(f\"文生图任务完成: {task_id}\")\n            return result\n\n        except Exception as e:\n            logger.error(f\"文生图API调用失败: {str(e)}\")\n            self._cleanup_reference_paths(ref_paths)\n            return {\n                \"task_id\": task_id,\n                \"success\": False,\n                \"error\": str(e),\n                \"type\": \"text_to_image\"\n            }\n\n    def generate_image_to_image(\n        self,\n        prompt: str,\n        image: str,\n        guidance_scale: float = 5.5,\n        seed: int = -1,\n        save_local: bool = True,\n        reference_images: Optional[List[Any]] = None,\n        generation_id: Optional[str] = None,\n    ) -> Dict[str, Any]:\n        \"\"\"\n        生成图生图并保存到本地\n\n        Args:\n            prompt: 编辑提示词\n            image_path: 原始图像路径（本地路径或URL）\n            guidance_scale: 引导强度，范围[1.0, 10.0]\n            seed: 随机种子，范围[-1, 2147483647]，None表示随机\n            response_format: 返回格式，\"url\"或\"b64_json\"\n            save_local: 是否保存到本地\n\n        Returns:\n            Dict: 生成结果\n        \n        Note:\n            model、size、watermark参数已固定，不再需要前端控制\n        \"\"\"\n        logger.info(f\"开始图生图任务: {prompt[:50]}...\")\n\n        # 生成唯一ID，优先使用外部传入的generation_id\n        task_id = generation_id or str(uuid.uuid4())\n\n        ref_paths: List[str] = []\n\n        try:\n            # 处理输入图像\n            image_data = self._prepare_input_image(image)\n            if not image_data:\n                return {\"success\": False, \"error\": \"无法处理输入图像\", \"task_id\": task_id}\n\n            # 处理参考图（复制到 references 并准备 API 载荷）\n            ref_summary = self._process_reference_assets(\n                reference_images,\n                max_refs=MAX_REFERENCE_IMAGES,\n                expected_outputs=1,\n            )\n            ref_assets = ref_summary.get('assets', [])\n            ref_paths = list(ref_summary.get('paths', []))\n            ref_payloads: List[str] = self._build_reference_payloads(ref_assets)\n            if ref_summary.get('errors'):\n                logger.warning(\n                    f\"参考图处理不完整: count={len(ref_assets)} errors={len(ref_summary['errors'])}\"\n                )\n            if ref_summary.get('warnings'):\n                for warn in ref_summary['warnings']:\n                    logger.warning(f\"参考图提示: {warn}\")\n\n            # 前置参数校验（不改变流程，仅记录摘要）\n            fb = False\n            reason = \"\"\n            try:\n                norm, fb, reason = validate_and_normalize_i2i(\n                    ImageToImageParams(\n                        prompt=prompt,\n                        image=\"<omitted>\",  # 避免在校验阶段传递大数据\n                        guidance_scale=guidance_scale,\n                        seed=(None if seed == -1 else seed),\n                        reference_images=ref_payloads,\n                    )\n                )\n                logger.info(\n                    f\"摘要|operation=precheck_i2i gs={norm.guidance_scale} seed={norm.seed} fallback={'yes' if fb else 'no'}\"\n                )\n                if fb:\n                    logger.warning(f\"前置参数回退建议: {reason}\")\n            except Exception as _e:\n                logger.debug(f\"前置参数校验跳过: {_e}\")\n\n            # 调用API生成图像（model、size、watermark参数已在客户端固定）\n            api_result = self.client.image_to_image(\n                prompt=prompt,\n                image=image_data,\n                guidance_scale=guidance_scale,\n                seed=seed,\n                reference_images=(ref_payloads or None),\n            )\n\n            # 处理input_image字段，避免在日志中输出大量base64数据\n            input_image_info = \"[图像数据]\"\n            if image:\n                if image.startswith(\"data:image/\"):\n                    # 如果是base64数据，只保留格式信息\n                    format_part = image.split(';')[0] if ';' in image else \"data:image/unknown\"\n                    input_image_info = f\"{format_part};base64,[数据已隐藏]\"\n                elif image.startswith((\"http://\", \"https://\")):\n                    # 如果是URL，保留URL\n                    input_image_info = image\n                else:\n                    # 如果是文件路径，只保留文件名\n                    input_image_info = f\"[本地文件: {Path(image).name}]\"\n            \n            result = {\n                \"task_id\": task_id,\n                \"success\": True,\n                \"type\": \"image_to_image\",\n                \"prompt\": prompt,\n                \"input_image\": input_image_info,\n                \"image_url\": api_result[\"data\"][\"images\"][0][\"url\"],\n                \"parameters\": {\n                    \"guidance_scale\": guidance_scale, \n                    \"seed\": seed, \n                    \"response_format\": \"url\",  # 固定值\n                    \"watermark\": False,  # 固定值\n                    \"size\": \"adaptive\",  # 固定值\n                    \"model\": self._resolve_model_id(\n                        \"doubao-seededit-3-0-i2i-250628\",\n                        \"doubao-seedream-4-0-250828\",\n                    )  # v4 路径统一使用 Seedream 4.0 模型\n                },\n                \"created_at\": datetime.now().isoformat(),\n                \"usage\": api_result.get(\"usage\", {}),\n            }\n\n            sanitized_refs = self._sanitize_reference_assets(ref_assets)\n            result[\"parameters\"][\"reference_assets\"] = sanitized_refs\n            result[\"reference_assets\"] = sanitized_refs\n            if ref_summary.get('errors'):\n                result[\"reference_asset_errors\"] = ref_summary['errors']\n            if ref_summary.get('warnings'):\n                result[\"reference_asset_warnings\"] = ref_summary['warnings']\n            if fb and reason:\n                result[\"fallback_applied\"] = True\n                result[\"fallback_reason\"] = reason\n\n            masked_ids = self._summarize_reference_ids(sanitized_refs)\n            logger.info(\n                \"摘要|operation=i2i_reference reference_count={} ref_ids={} provider={}\",\n                len(sanitized_refs),\n                masked_ids or \"-\",\n                self._provider_used(),\n            )\n\n            # 保存到本地\n            if save_local and result.get(\"image_url\"):\n                local_result = self._save_image_locally(result)\n                result.update(local_result)\n                if local_result.get('local_save_error'):\n                    self._cleanup_reference_paths(ref_paths)\n                    result[\"parameters\"][\"reference_assets\"] = []\n                    result[\"reference_assets\"] = []\n                    warnings = result.setdefault(\"reference_asset_warnings\", [])\n                    warnings.append(\"主图保存失败，参考图已回滚\")\n                    logger.warning(f\"参考图已回滚: task_id={task_id}\")\n\n            logger.success(f\"图生图任务完成: {task_id}\")\n            return result\n\n        except Exception as e:\n            # 避免在日志中显示可能包含base64数据的异常信息\n            error_msg = str(e)\n            if len(error_msg) > 200:\n                error_msg = error_msg[:200] + \"...[错误信息过长，已截断]\"\n            logger.error(f\"图生图API调用失败: {error_msg}\")\n            self._cleanup_reference_paths(ref_paths)\n            return {\n                \"task_id\": task_id,\n                \"success\": False,\n                \"error\": error_msg,\n                \"type\": \"image_to_image\"\n            }\n\n    def batch_generate_text_to_image(\n        self,\n        prompts: List[str],\n        size: str = \"1024x1024\",\n        guidance_scale: float = 2.5,\n        save_local: bool = True,\n    ) -> List[Dict[str, Any]]:\n        \"\"\"\n        批量生成文生图（顺序执行，保持向后兼容）\n\n        Args:\n            prompts: 提示词列表\n            size: 图像尺寸\n            guidance_scale: 提示词一致性\n            save_local: 是否保存到本地\n\n        Returns:\n            List[Dict]: 生成结果列表\n        \n        Note:\n            水印参数已固定为False，不再需要前端控制\n            如需并发执行，请使用concurrent_generate_text_to_image方法\n        \"\"\"\n        logger.info(f\"开始批量文生图，共{len(prompts)}个任务\")\n\n        results = []\n        for i, prompt in enumerate(prompts, 1):\n            logger.info(f\"处理第{i}/{len(prompts)}个任务\")\n\n            result = self.generate_text_to_image(\n                prompt=prompt,\n                size=size,\n                guidance_scale=guidance_scale,\n                save_local=save_local,\n                generation_id=None,\n            )\n\n            results.append(result)\n\n        success_count = sum(1 for r in results if r[\"success\"])\n        logger.info(f\"批量文生图完成，成功{success_count}/{len(prompts)}个\")\n\n        return results\n\n    def concurrent_generate_text_to_image(\n        self,\n        prompt: str,\n        count: int = 4,\n        size: str = \"1024x1024\",\n        guidance_scale: float = 2.5,\n        seed: int = -1,\n        save_local: bool = True,\n        progress_callback: Optional[Callable[[int, int, Dict[str, Any]], None]] = None,\n        max_workers: int = 5,\n        derived_ids: Optional[List[str]] = None,\n        generation_id: Optional[str] = None,\n    ) -> Dict[str, Any]:\n        \"\"\"\n        并发生成多张文生图\n\n        Args:\n            prompt: 图像生成提示词\n            count: 生成图片数量，默认4张，最多10张\n            size: 图像尺寸\n            guidance_scale: 引导强度\n            seed: 随机种子，-1表示为每张图片生成不同的随机种子\n            save_local: 是否保存到本地\n            progress_callback: 进度回调函数，参数为(completed, total, result)\n            max_workers: 最大并发数\n\n        Returns:\n            Dict: 包含所有任务结果的字典\n        \"\"\"\n        # 验证参数\n        if count < 1 or count > 10:\n            raise ValueError(\"生成数量必须在1-10之间\")\n        \n        if max_workers > count:\n            max_workers = count\n        \n        logger.info(f\"开始并发生成{count}张文生图: {prompt[:50]}...\")\n        \n        # 生成批次ID\n        batch_id = str(uuid.uuid4())\n        start_time = time.time()\n\n        slots = max(1, count)\n        per_ids: List[str] = list(derived_ids or [])\n        if len(per_ids) < slots:\n            base = generation_id or batch_id\n            for idx in range(len(per_ids), slots):\n                per_ids.append(f\"{base}_{idx + 1}\")\n        \n        # 准备任务参数\n        tasks = []\n        for i in range(count):\n            # 为每个任务生成不同的种子（如果seed为-1）\n            task_seed = seed if seed != -1 else None\n            gen_id = per_ids[i] if i < len(per_ids) else None\n            tasks.append({\n                'prompt': prompt,\n                'size': size,\n                'guidance_scale': guidance_scale,\n                'seed': task_seed,\n                'save_local': save_local,\n                'task_index': i + 1,\n                'generation_id': gen_id,\n            })\n        \n        # 使用线程池并发执行\n        results = []\n        completed_count = 0\n        \n        with ThreadPoolExecutor(max_workers=max_workers) as executor:\n            # 提交所有任务\n            future_to_task = {\n                executor.submit(self._execute_single_text_to_image_task, task): task \n                for task in tasks\n            }\n            \n            # 收集结果\n            for future in as_completed(future_to_task):\n                task = future_to_task[future]\n                try:\n                    result = future.result()\n                    result['task_index'] = task['task_index']\n                    result['batch_id'] = batch_id\n                    results.append(result)\n                    \n                    completed_count += 1\n                    \n                    # 调用进度回调\n                    if progress_callback:\n                        try:\n                            progress_callback(completed_count, count, result)\n                        except Exception as e:\n                            logger.warning(f\"进度回调执行失败: {e}\")\n                    \n                    logger.info(f\"任务 {task['task_index']}/{count} 完成\")\n                    \n                except Exception as e:\n                    error_result = {\n                        'task_index': task['task_index'],\n                        'batch_id': batch_id,\n                        'success': False,\n                        'error': str(e),\n                        'type': 'text_to_image'\n                    }\n                    results.append(error_result)\n                    completed_count += 1\n                    \n                    if progress_callback:\n                        try:\n                            progress_callback(completed_count, count, error_result)\n                        except Exception as e:\n                            logger.warning(f\"进度回调执行失败: {e}\")\n                    \n                    # 避免在日志中显示可能包含base64数据的异常信息\n                    error_msg = str(e)\n                    if len(error_msg) > 200:\n                        error_msg = error_msg[:200] + \"...[错误信息过长，已截断]\"\n                    logger.error(f\"任务 {task['task_index']}/{count} 失败: {error_msg}\")\n        \n        # 按task_index排序\n        results.sort(key=lambda x: x.get('task_index', 0))\n        \n        # 统计结果\n        success_count = sum(1 for r in results if r.get('success', False))\n        total_time = time.time() - start_time\n        \n        batch_result = {\n            'batch_id': batch_id,\n            'success': True,\n            'prompt': prompt,\n            'total_count': count,\n            'success_count': success_count,\n            'failed_count': count - success_count,\n            'total_time': round(total_time, 2),\n            'average_time': round(total_time / count, 2),\n            'results': results,\n            'parameters': {\n                'size': size,\n                'guidance_scale': guidance_scale,\n                'seed': seed,\n                'max_workers': max_workers\n            },\n            'derived_ids': per_ids,\n            'created_at': datetime.now().isoformat()\n        }\n        \n        logger.success(f\"并发文生图完成: {success_count}/{count} 成功，耗时 {total_time:.2f}s\")\n        return batch_result\n\n    def concurrent_generate_image_to_image(\n        self,\n        prompt: str,\n        image: str,\n        count: int = 4,\n        guidance_scale: float = 5.5,\n        seed: int = -1,\n        save_local: bool = True,\n        progress_callback: Optional[Callable[[int, int, Dict[str, Any]], None]] = None,\n        max_workers: int = 5,\n        derived_ids: Optional[List[str]] = None,\n        generation_id: Optional[str] = None,\n    ) -> Dict[str, Any]:\n        \"\"\"\n        并发生成多张图生图\n\n        Args:\n            prompt: 编辑提示词\n            image: 输入图像路径或URL\n            count: 生成图片数量，默认4张，最多10张\n            guidance_scale: 引导强度\n            seed: 随机种子，-1表示为每张图片生成不同的随机种子\n            save_local: 是否保存到本地\n            progress_callback: 进度回调函数\n            max_workers: 最大并发数\n\n        Returns:\n            Dict: 包含所有任务结果的字典\n        \"\"\"\n        # 验证参数\n        if count < 1 or count > 10:\n            raise ValueError(\"生成数量必须在1-10之间\")\n        \n        if max_workers > count:\n            max_workers = count\n        \n        logger.info(f\"开始并发生成{count}张图生图: {prompt[:50]}...\")\n        \n        # 生成批次ID\n        batch_id = str(uuid.uuid4())\n        start_time = time.time()\n        \n        slots = max(1, count)\n        per_ids: List[str] = list(derived_ids or [])\n        if len(per_ids) < slots:\n            base = generation_id or batch_id\n            for idx in range(len(per_ids), slots):\n                per_ids.append(f\"{base}_{idx + 1}\")\n        \n        # 准备输入图像\n        image_data = self._prepare_input_image(image)\n        if not image_data:\n            return {\n                'batch_id': batch_id,\n                'success': False,\n                'error': '无法处理输入图像',\n                'type': 'image_to_image'\n            }\n        \n        # 准备任务参数\n        tasks = []\n        for i in range(count):\n            task_seed = seed if seed != -1 else None\n            gen_id = per_ids[i] if i < len(per_ids) else None\n            tasks.append({\n                'prompt': prompt,\n                'image': image_data,\n                'guidance_scale': guidance_scale,\n                'seed': task_seed,\n                'save_local': save_local,\n                'task_index': i + 1,\n                'generation_id': gen_id\n            })\n        \n        # 使用线程池并发执行\n        results = []\n        completed_count = 0\n        \n        with ThreadPoolExecutor(max_workers=max_workers) as executor:\n            # 提交所有任务\n            future_to_task = {\n                executor.submit(self._execute_single_image_to_image_task, task): task \n                for task in tasks\n            }\n            \n            # 收集结果\n            for future in as_completed(future_to_task):\n                task = future_to_task[future]\n                try:\n                    result = future.result()\n                    result['task_index'] = task['task_index']\n                    result['batch_id'] = batch_id\n                    results.append(result)\n                    \n                    completed_count += 1\n                    \n                    # 调用进度回调\n                    if progress_callback:\n                        try:\n                            progress_callback(completed_count, count, result)\n                        except Exception as e:\n                            logger.warning(f\"进度回调执行失败: {e}\")\n                    \n                    logger.info(f\"任务 {task['task_index']}/{count} 完成\")\n                    \n                except Exception as e:\n                    error_result = {\n                        'task_index': task['task_index'],\n                        'batch_id': batch_id,\n                        'success': False,\n                        'error': str(e),\n                        'type': 'image_to_image'\n                    }\n                    results.append(error_result)\n                    completed_count += 1\n                    \n                    if progress_callback:\n                        try:\n                            progress_callback(completed_count, count, error_result)\n                        except Exception as e:\n                            logger.warning(f\"进度回调执行失败: {e}\")\n                    \n                    # 避免在日志中显示可能包含base64数据的异常信息\n                    error_msg = str(e)\n                    if len(error_msg) > 200:\n                        error_msg = error_msg[:200] + \"...[错误信息过长，已截断]\"\n                    logger.error(f\"任务 {task['task_index']}/{count} 失败: {error_msg}\")\n        \n        # 按task_index排序\n        results.sort(key=lambda x: x.get('task_index', 0))\n        \n        # 统计结果\n        success_count = sum(1 for r in results if r.get('success', False))\n        total_time = time.time() - start_time\n        \n        # 处理input_image字段，避免在日志中输出大量base64数据\n        input_image_info = \"[图像数据]\"\n        if image:\n            if image.startswith(\"data:image/\"):\n                # 如果是base64数据，只保留格式信息\n                format_part = image.split(';')[0] if ';' in image else \"data:image/unknown\"\n                input_image_info = f\"{format_part};base64,[数据已隐藏]\"\n            elif image.startswith((\"http://\", \"https://\")):\n                # 如果是URL，保留URL\n                input_image_info = image\n            else:\n                # 如果是文件路径，只保留文件名\n                input_image_info = f\"[本地文件: {Path(image).name}]\"\n        \n        batch_result = {\n            'batch_id': batch_id,\n            'success': True,\n            'prompt': prompt,\n            'input_image': input_image_info,\n            'total_count': count,\n            'success_count': success_count,\n            'failed_count': count - success_count,\n            'total_time': round(total_time, 2),\n            'average_time': round(total_time / count, 2),\n            'results': results,\n            'parameters': {\n                'guidance_scale': guidance_scale,\n                'seed': seed,\n                'max_workers': max_workers\n            },\n            'derived_ids': per_ids,\n            'created_at': datetime.now().isoformat()\n        }\n        \n        logger.success(f\"并发图生图完成: {success_count}/{count} 成功，耗时 {total_time:.2f}s\")\n        return batch_result\n\n    def _execute_single_text_to_image_task(self, task: Dict[str, Any]) -> Dict[str, Any]:\n        \"\"\"\n        执行单个文生图任务\n        \n        Args:\n            task: 任务参数字典\n            \n        Returns:\n            Dict: 任务执行结果\n        \"\"\"\n        return self.generate_text_to_image(\n            prompt=task['prompt'],\n            size=task['size'],\n            guidance_scale=task['guidance_scale'],\n            seed=task['seed'],\n            save_local=task['save_local'],\n            generation_id=task.get('generation_id'),\n        )\n    \n    def _execute_single_image_to_image_task(self, task: Dict[str, Any]) -> Dict[str, Any]:\n        \"\"\"\n        执行单个图生图任务\n        \n        Args:\n            task: 任务参数字典\n            \n        Returns:\n            Dict: 任务执行结果\n        \"\"\"\n        # 生成唯一ID，优先使用外部传入的generation_id\n        task_id = task.get('generation_id') or str(uuid.uuid4())\n        \n        try:\n            # 直接使用已经处理好的图片数据，避免重复处理\n            image_data = task['image']\n            \n            # 调用API生成图像\n            api_result = self.client.image_to_image(\n                prompt=task['prompt'], \n                image=image_data, \n                guidance_scale=task['guidance_scale'], \n                seed=task['seed']\n            )\n            \n            result = {\n                \"task_id\": task_id,\n                \"success\": True,\n                \"type\": \"image_to_image\",\n                \"prompt\": task['prompt'],\n                \"image_url\": api_result[\"data\"][\"images\"][0][\"url\"],\n                \"parameters\": {\n                    \"guidance_scale\": task['guidance_scale'], \n                    \"seed\": task['seed'], \n                    \"response_format\": \"url\",\n                    \"watermark\": False,\n                    \"size\": \"adaptive\",\n                    \"model\": \"doubao-seededit-3-0-i2i-250628\"\n                },\n                \"created_at\": datetime.now().isoformat(),\n                \"usage\": api_result.get(\"usage\", {}),\n            }\n            \n            # 保存到本地\n            if task['save_local'] and result.get(\"image_url\"):\n                local_result = self._save_image_locally(result)\n                result.update(local_result)\n            \n            return result\n            \n        except Exception as e:\n            # 避免在日志中显示可能包含base64数据的异常信息\n            error_msg = str(e)\n            if len(error_msg) > 200:\n                error_msg = error_msg[:200] + \"...[错误信息过长，已截断]\"\n            return {\n                \"task_id\": task_id,\n                \"success\": False,\n                \"error\": error_msg,\n                \"type\": \"image_to_image\"\n            }\n\n    def _save_image_locally(self, result: Dict[str, Any]) -> Dict[str, Any]:\n        \"\"\"\n        保存图像到本地并记录元数据\n\n        Args:\n            result: API生成结果\n\n        Returns:\n            Dict: 包含本地文件信息的字典\n        \"\"\"\n        try:\n            # 下载图像\n            image_url = result[\"image_url\"]\n            response = safe_requests_get(image_url, timeout=30)\n\n            # 先解析真实像素尺寸（以真实像素为准，避免使用size推测）\n            from io import BytesIO\n            real_w, real_h = None, None\n            try:\n                with Image.open(BytesIO(response.content)) as img:\n                    real_w, real_h = int(img.width), int(img.height)\n            except Exception as _e:\n                logger.warning(f\"无法从图像数据读取真实尺寸，回退至size参数: {_e}\")\n                real_w = self._extract_width_from_size(result.get(\"parameters\", {}).get(\"size\", \"1024x1024\"))\n                real_h = self._extract_height_from_size(result.get(\"parameters\", {}).get(\"size\", \"1024x1024\"))\n\n            # 组装元数据（适配UnifiedStorageManager的格式）\n            params = result.get(\"parameters\", {}) or {}\n            # 若无比例信息，按真实像素计算一个 ratio 文本（约分）\n            try:\n                if not params.get('ratio') and real_w and real_h and real_w > 0 and real_h > 0:\n                    from math import gcd\n                    g = gcd(real_w, real_h)\n                    params['ratio'] = f\"{real_w//g}:{real_h//g}\"\n            except Exception:\n                pass\n\n            metadata = {\n                'generation_id': result.get(\"task_id\", \"\"),\n                'prompt': result.get(\"prompt\", \"\"),\n                'parameters': params,\n                'model': params.get(\"model\", \"seedream\"),\n                'width': real_w,\n                'height': real_h,\n                'generation_time': result.get(\"generation_time\", 0),\n                'batch_id': result.get(\"batch_id\", \"\"),\n                'status': 'completed'\n            }\n            \n            # 使用统一存储管理器保存文件\n            save_result = self.storage_manager.save_content_file(\n                content_type='images',\n                file_data=response.content,\n                url=image_url,\n                metadata=metadata\n            )\n\n            # 获取图像信息（再次确认像素尺寸）\n            image_info = self._get_image_info(Path(save_result['local_path']))\n            file_size = Path(save_result['local_path']).stat().st_size\n\n            logger.success(f\"图像已保存到本地: {Path(save_result['local_path']).name}\")\n\n            result_obj = {\n                \"local_path\": save_result['local_path'],\n                \"filename\": Path(save_result['local_path']).name,\n                \"file_size\": file_size,\n                \"image_info\": image_info,\n                \"file_path\": save_result['local_path'],  # 保持兼容性\n                \"thumbnail_path\": save_result.get('thumbnail_path'),  # 缩略图路径\n                # 修复：确保 file_id 和 relative_path 被返回，用于占位符替换\n                \"file_id\": save_result.get('file_id'),\n                \"relative_path\": save_result.get('relative_path'),\n            }\n            try:\n                w = image_info.get('width') if isinstance(image_info, dict) else None\n                h = image_info.get('height') if isinstance(image_info, dict) else None\n                logger.info(\n                    f\"摘要|operation=save_image status=success file={result_obj['filename']} size={file_size}B width={w} height={h}\"\n                )\n            except Exception:\n                pass\n\n            # 体验版本地图片水印（使用统一水印服务）\n            if should_add_watermark():\n                try:\n                    from edition.watermark_service import WatermarkService\n\n                    watermark_text = get_watermark_text() or \"PIGEON\"\n                    try:\n                        opacity = get_watermark_opacity()\n                    except Exception:\n                        opacity = 0.3\n                    opacity = max(0.0, min(opacity, 1.0))\n\n                    watermark_service = WatermarkService(watermark_text, opacity=opacity)\n                    watermark_applied = watermark_service.apply_to_image(Path(save_result['local_path']))\n                    if watermark_applied:\n                        logger.success(f\"图片水印添加成功: {Path(save_result['local_path']).name}\")\n                        result_obj[\"watermark_applied\"] = True\n                    else:\n                        logger.warning(f\"图片水印添加失败: {Path(save_result['local_path']).name}\")\n                        result_obj[\"watermark_applied\"] = False\n                except Exception as e:\n                    logger.warning(f\"添加图片水印时出错: {e}\")\n                    result_obj[\"watermark_applied\"] = False\n\n            return result_obj\n\n        except Exception as e:\n            logger.error(f\"保存图像到本地失败: {e}\")\n            try:\n                logger.info(\"摘要|operation=save_image status=failed\")\n            except Exception:\n                pass\n            return {\"local_save_error\": str(e)}\n\n    def _generate_reference_asset_id(self, file_data: bytes) -> str:\n        checksum = hashlib.sha1(file_data).hexdigest()\n        ts = datetime.now().strftime(\"%Y%m%d%H%M%S%f\")\n        return f\"ref_{ts}_{checksum[:8]}\"\n\n    def _load_reference_source(self, ref: Any) -> Optional[Tuple[bytes, str, Dict[str, Any]]]:\n        \"\"\"解析参考图来源，返回 (bytes, 扩展名, 元信息)。\"\"\"\n        source_meta: Dict[str, Any] = {}\n        raw = ref\n        if isinstance(ref, dict):\n            for key in ('source', 'order', 'type', 'extension', 'width', 'height'):\n                if ref.get(key) is not None:\n                    source_meta[key] = ref.get(key)\n            raw = ref.get('data') or ref.get('path') or ref.get('url') or ref.get('value')\n        if raw is None:\n            return None\n\n        extension = source_meta.get('extension')\n        data = None\n        source_repr = source_meta.get('source')\n\n        try:\n            if isinstance(raw, bytes):\n                data = raw\n            elif isinstance(raw, str):\n                stripped = raw.strip()\n                if stripped.startswith('data:') and ';base64,' in stripped:\n                    header, payload = stripped.split(';base64,', 1)\n                    mime_part = header[5:]\n                    extension = extension or mimetypes.guess_extension(mime_part) or '.png'\n                    data = base64.b64decode(payload)\n                    source_repr = source_repr or mime_part\n                    source_meta.setdefault('type', 'image')\n                elif stripped.startswith(('http://', 'https://')):\n                    resp = safe_requests_get(stripped, timeout=15)\n                    data = resp.content\n                    parsed = urlparse(stripped)\n                    extension = extension or Path(parsed.path).suffix or mimetypes.guess_extension(resp.headers.get('Content-Type', '')) or '.png'\n                    source_repr = source_repr or stripped\n                    source_meta.setdefault('source_url', stripped)\n                else:\n                    path = Path(stripped)\n                    if not path.exists():\n                        logger.warning(f\"引用图像不存在: {stripped}\")\n                        return None\n                    data = path.read_bytes()\n                    extension = extension or path.suffix or '.png'\n                    source_repr = source_repr or path.name\n                    source_meta.setdefault('source_path', str(path))\n            else:\n                logger.warning(f\"不支持的参考图类型: {type(raw)}\")\n                return None\n        except Exception as exc:\n            logger.warning(f\"加载参考图失败: {exc}\")\n            return None\n\n        if data is None:\n            return None\n\n        width = source_meta.get('width')\n        height = source_meta.get('height')\n        if source_meta.get('type', 'image') == 'image' and (width is None or height is None):\n            try:\n                from io import BytesIO\n\n                with Image.open(BytesIO(data)) as img:\n                    width = img.width\n                    height = img.height\n            except Exception:\n                pass\n\n        source_meta['width'] = width\n        source_meta['height'] = height\n        source_meta.setdefault('type', 'image')\n        source_meta['source'] = source_repr or source_meta.get('source')\n\n        return data, extension, source_meta\n\n    def _process_reference_assets(\n        self,\n        references: Optional[List[Any]],\n        *,\n        max_refs: int = MAX_REFERENCE_IMAGES,\n        expected_outputs: int = 1,\n    ) -> Dict[str, Any]:\n        \"\"\"拷贝参考图到 references 目录并返回处理结果摘要。\"\"\"\n        stored: List[Dict[str, Any]] = []\n        absolute_paths: List[str] = []\n        errors: List[str] = []\n        warnings: List[str] = []\n\n        if not references:\n            return {\n                'assets': stored,\n                'paths': absolute_paths,\n                'errors': errors,\n                'warnings': warnings,\n            }\n\n        if max_refs is not None and max_refs > 0 and len(references) > max_refs:\n            warnings.append(\n                f\"参考图数量超过 {max_refs}（官方文档行203-204），已按顺序截取前 {max_refs} 张\"\n            )\n            references = references[:max_refs]\n\n        for order, item in enumerate(references):\n            load_result = self._load_reference_source(item)\n            if not load_result:\n                errors.append(f\"ref[{order}] 加载失败\")\n                continue\n\n            file_data, extension, meta = load_result\n            meta.setdefault('order', order)\n            meta.setdefault('kind', meta.get('type', 'image'))\n\n            try:\n                asset_id = self._generate_reference_asset_id(file_data)\n                record = self.storage_manager.save_reference_asset(\n                    'images',\n                    file_data,\n                    asset_id=asset_id,\n                    extension=extension,\n                    metadata=meta,\n                )\n                try:\n                    record['_payload_b64'] = base64.b64encode(file_data).decode('utf-8')\n                except Exception:\n                    record['_payload_b64'] = None\n                record['_source_meta'] = meta\n                stored.append(record)\n                if record.get('absolute_path'):\n                    absolute_paths.append(record['absolute_path'])\n            except Exception as exc:\n                logger.warning(f\"保存参考图失败: {exc}\")\n                errors.append(f\"ref[{order}] 保存失败\")\n\n        if expected_outputs >= 0 and len(stored) + expected_outputs > MAX_REFERENCE_BUNDLE:\n            allowed = max(0, MAX_REFERENCE_BUNDLE - expected_outputs)\n            if len(stored) > allowed:\n                warnings.append(\n                    f\"参考图与生成量合计超过 {MAX_REFERENCE_BUNDLE}（官方文档行203-204），已截取前 {allowed} 张\"\n                )\n                stored = stored[:allowed]\n                absolute_paths = absolute_paths[:allowed]\n\n        return {\n            'assets': stored,\n            'paths': absolute_paths,\n            'errors': errors,\n            'warnings': warnings,\n        }\n\n    def _build_reference_payloads(self, assets: List[Dict[str, Any]]) -> List[str]:\n        payloads: List[str] = []\n        for asset in assets or []:\n            payload = asset.get('_payload_b64')\n            if not payload:\n                continue\n            path_hint = asset.get('path') or asset.get('_source_meta', {}).get('source_path')\n            mime = 'image/png'\n            try:\n                if path_hint:\n                    suffix = Path(path_hint).suffix.lower()\n                    if suffix in {'.jpg', '.jpeg'}:\n                        mime = 'image/jpeg'\n                    elif suffix == '.webp':\n                        mime = 'image/webp'\n                    elif suffix == '.bmp':\n                        mime = 'image/bmp'\n                    elif suffix == '.gif':\n                        mime = 'image/gif'\n            except Exception:\n                pass\n            payloads.append(f\"data:{mime};base64,{payload}\")\n        return payloads\n\n    def _resolve_model_id(self, default_model: str, v4_model: str) -> str:\n        provider = (self.client.last_provider() or \"\").lower()\n        if provider in {\"volc_v4\", \"volcengine_v4\"}:\n            return v4_model\n        return default_model\n\n    def _sanitize_reference_assets(self, assets: List[Dict[str, Any]]) -> List[Dict[str, Any]]:\n        cleaned: List[Dict[str, Any]] = []\n        for rec in assets or []:\n            rec.pop('_payload_b64', None)\n            rec.pop('_source_meta', None)\n            rec.pop('absolute_path', None)\n            cleaned.append({\n                'id': rec.get('id') or rec.get('asset_id') or rec.get('reference_id'),  # 兼容多种ID字段名\n                'path': rec.get('path') or rec.get('relative_path') or rec.get('asset_path'),  # 确保有path字段\n                'type': rec.get('type'),\n                'kind': rec.get('kind'),\n                'source': rec.get('source'),\n                'order': rec.get('order'),\n                'checksum': rec.get('checksum') or rec.get('file_hash'),  # 兼容不同的哈希字段名\n                'size': rec.get('size') or rec.get('file_size'),  # 兼容不同的大小字段名\n                'width': rec.get('width'),\n                'height': rec.get('height'),\n                'created_at': rec.get('created_at'),\n            })\n        return cleaned\n\n    @staticmethod\n    def _summarize_reference_ids(assets: List[Dict[str, Any]]) -> str:\n        masked: List[str] = []\n        for rec in assets or []:\n            rid = rec.get('id') or ''\n            if not rid:\n                continue\n            masked.append(f\"{rid[:6]}***\")\n        return \",\".join(masked)\n\n    @staticmethod\n    def _provider_hint() -> str:\n        try:\n            return os.environ.get(\"GEMENG_SEEDREAM_PROVIDER\", \"volc_v3\")\n        except Exception:\n            return \"unknown\"\n\n    def _provider_used(self) -> str:\n        provider = self.client.last_provider() if hasattr(self.client, \"last_provider\") else None\n        if provider:\n            return provider\n        return self._provider_hint()\n\n    @staticmethod\n    def _cleanup_reference_paths(paths: List[str]):\n        for path in paths or []:\n            try:\n                if path and Path(path).exists():\n                    Path(path).unlink(missing_ok=True)\n            except Exception as exc:\n                logger.debug(f\"参考图清理失败: {exc}\")\n\n    def _prepare_input_image(self, image_path: str) -> Optional[str]:\n        \"\"\"\n        准备输入图像，支持本地文件和URL\n        \n        Args:\n            image_path: 图像路径（本地路径或URL）\n            \n        Returns:\n            str: 图像URL、base64数据或None\n        \"\"\"\n        try:\n            # 如果是URL，直接返回\n            if image_path.startswith((\"http://\", \"https://\")):\n                return image_path\n\n            # 如果是本地文件，转换为Base64\n            local_path = Path(image_path)\n            if local_path.exists():\n                with open(local_path, \"rb\") as f:\n                    image_data = f.read()\n\n                # 检测图像格式\n                image = Image.open(local_path)\n                format_name = image.format.lower()\n\n                # 转换为Base64\n                base64_data = base64.b64encode(image_data).decode(\"utf-8\")\n                return f\"data:image/{format_name};base64,{base64_data}\"\n\n            logger.error(f\"图像文件不存在: {image_path}\")\n            return None\n\n        except Exception as e:\n            logger.error(f\"处理输入图像失败: {e}\")\n            return None\n\n    def _extract_width_from_size(self, size: str) -> int:\n        \"\"\"\n        从尺寸字符串中提取宽度\n        \n        Args:\n            size: 尺寸字符串，如 \"1024x1024\"\n            \n        Returns:\n            int: 宽度值\n        \"\"\"\n        try:\n            return int(size.split('x')[0])\n        except (ValueError, IndexError):\n            return 1024  # 默认值\n    \n    def _extract_height_from_size(self, size: str) -> int:\n        \"\"\"\n        从尺寸字符串中提取高度\n        \n        Args:\n            size: 尺寸字符串，如 \"1024x1024\"\n            \n        Returns:\n            int: 高度值\n        \"\"\"\n        try:\n            return int(size.split('x')[1])\n        except (ValueError, IndexError):\n            return 1024  # 默认值\n\n    def _get_image_info(self, image_path: Path) -> Dict[str, Any]:\n        \"\"\"\n        获取图像信息\n\n        Args:\n            image_path: 图像文件路径\n\n        Returns:\n            Dict: 图像信息\n        \"\"\"\n        try:\n            with Image.open(image_path) as img:\n                return {\"width\": img.width, \"height\": img.height, \"format\": img.format, \"mode\": img.mode}\n        except Exception as e:\n            logger.error(f\"获取图像信息失败: {e}\")\n            return {\"width\": 0, \"height\": 0, \"format\": \"unknown\", \"mode\": \"unknown\"}\n\n    def get_generation_history(self, limit: int = 50) -> List[Dict[str, Any]]:\n        \"\"\"\n        获取图像生成历史记录\n\n        Args:\n            limit: 返回记录数量限制\n\n        Returns:\n            List[Dict]: 历史记录列表\n        \"\"\"\n        return self.storage_manager.load_history('images', limit=limit)\n\n    def search_by_prompt(self, keyword: str) -> List[Dict[str, Any]]:\n        \"\"\"\n        根据提示词关键字搜索历史记录\n\n        Args:\n            keyword: 搜索关键字\n\n        Returns:\n            List[Dict]: 匹配的记录列表\n        \"\"\"\n        # 获取所有历史记录并在内存中过滤\n        all_records = self.storage_manager.load_history('images', limit=1000)\n        return [record for record in all_records if keyword.lower() in record.get('prompt', '').lower()]\n\n    def get_statistics(self) -> Dict[str, Any]:\n        \"\"\"\n        获取生成统计信息\n\n        Returns:\n            Dict: 统计信息\n        \"\"\"\n        try:\n            # 使用统一存储管理器获取存储统计\n            storage_stats = self.storage_manager.get_storage_stats()\n            image_stats = storage_stats.get('content_types', {}).get('images', {})\n            \n            # 获取历史记录进行详细统计\n            all_records = self.storage_manager.load_history('images', limit=1000)\n            \n            if not all_records:\n                return {\n                    \"total_images\": 0,\n                    \"text_to_image_count\": 0,\n                    \"image_to_image_count\": 0,\n                    \"total_file_size\": 0,\n                    \"average_file_size\": 0,\n                    \"most_common_size\": \"unknown\"\n                }\n\n            # 统计不同类型的图片数量\n            text_to_image_count = 0\n            image_to_image_count = 0\n            total_file_size = 0\n            sizes = []\n            \n            for record in all_records:\n                # 从参数中判断类型（因为新格式可能没有直接的type字段）\n                if 'input_image' in record.get('parameters', {}):\n                    image_to_image_count += 1\n                else:\n                    text_to_image_count += 1\n                \n                # 计算文件大小\n                file_size = record.get('file_size', 0)\n                if isinstance(file_size, str) and file_size.isdigit():\n                    file_size = int(file_size)\n                elif not isinstance(file_size, (int, float)):\n                    file_size = 0\n                total_file_size += file_size\n                \n                # 收集尺寸信息\n                width = record.get('width', 0)\n                height = record.get('height', 0)\n                if width and height:\n                    sizes.append(f\"{width}x{height}\")\n\n            stats = {\n                \"total_images\": len(all_records),\n                \"text_to_image_count\": text_to_image_count,\n                \"image_to_image_count\": image_to_image_count,\n                \"total_file_size\": total_file_size,\n                \"average_file_size\": total_file_size / len(all_records) if all_records else 0,\n                \"most_common_size\": \"unknown\",\n                \"creation_dates\": [record.get('created_at', '') for record in all_records[-10:]]  # 最近10次\n            }\n\n            # 最常用的尺寸\n            if sizes:\n                from collections import Counter\n                size_counts = Counter(sizes)\n                stats[\"most_common_size\"] = size_counts.most_common(1)[0][0]\n\n            return stats\n\n        except Exception as e:\n            logger.error(f\"获取统计信息失败: {e}\")\n            return {\n                \"total_images\": 0,\n                \"text_to_image_count\": 0,\n                \"image_to_image_count\": 0,\n                \"total_file_size\": 0,\n                \"average_file_size\": 0,\n                \"most_common_size\": \"unknown\"\n            }\n","numLines":1383,"startLine":1,"totalLines":1383}}}
{"parentUuid":"8412d5fa-9561-4b96-a7c3-c36871c9597c","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01RBT6Yi4a8mBGuEm3HB4K36","type":"message","role":"assistant","content":[{"type":"text","text":"现在查找UI组件和相关配置："}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1877,"cache_creation_input_tokens":32574,"cache_read_input_tokens":16304,"cache_creation":{"ephemeral_5m_input_tokens":32574,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"c82f3718-f632-42f5-b28e-9b95a9378655","timestamp":"2025-11-25T19:09:07.450Z"}
{"parentUuid":"c82f3718-f632-42f5-b28e-9b95a9378655","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01RBT6Yi4a8mBGuEm3HB4K36","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013SxojNjxpQr1AsYtn33qbG","name":"Glob","input":{"pattern":"components/**/*.tsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1877,"cache_creation_input_tokens":32574,"cache_read_input_tokens":16304,"cache_creation":{"ephemeral_5m_input_tokens":32574,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"68ecc73f-4fe5-4df3-9920-332c83d0a4a6","timestamp":"2025-11-25T19:09:07.602Z"}
{"parentUuid":"68ecc73f-4fe5-4df3-9920-332c83d0a4a6","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01RBT6Yi4a8mBGuEm3HB4K36","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014WZAWtMUYmq6Jn91wsZ5Yk","name":"Glob","input":{"pattern":"**/{volc_v4,config,schema}.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1877,"cache_creation_input_tokens":32574,"cache_read_input_tokens":16304,"cache_creation":{"ephemeral_5m_input_tokens":32574,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"90ef3216-91f8-4d1c-a5bb-79c86fd3419e","timestamp":"2025-11-25T19:09:07.985Z"}
{"parentUuid":"90ef3216-91f8-4d1c-a5bb-79c86fd3419e","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013SxojNjxpQr1AsYtn33qbG","type":"tool_result","content":"No files found"}]},"uuid":"3a6baba7-3a42-4403-a390-66a492d8d242","timestamp":"2025-11-25T19:09:08.433Z","toolUseResult":{"filenames":[],"durationMs":379,"numFiles":0,"truncated":false}}
{"parentUuid":"3a6baba7-3a42-4403-a390-66a492d8d242","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014WZAWtMUYmq6Jn91wsZ5Yk","type":"tool_result","content":"/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/gemeng2-0.7.0/modules/seedance/config.py\n/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/modules/seedance/config.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/schema.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/volc_v4.py\n/Users/yunchang/Documents/GitHub/gemeng2/modules/seedance/config.py\n/Users/yunchang/Documents/GitHub/gemeng2/dist/鸽梦Godream/_internal/cv2/config.py\n/Users/yunchang/Documents/GitHub/gemeng2/dist/鸽梦Godream_v1.2.1_正式版.app/Contents/Resources/cv2/config.py"}]},"uuid":"f2f99b9a-b54f-4798-8e65-df846ced54ac","timestamp":"2025-11-25T19:09:08.600Z","toolUseResult":{"filenames":["/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/gemeng2-0.7.0/modules/seedance/config.py","/Users/yunchang/Documents/GitHub/gemeng2/archive/imported_sources/modules/seedance/config.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/schema.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/volc_v4.py","/Users/yunchang/Documents/GitHub/gemeng2/modules/seedance/config.py","/Users/yunchang/Documents/GitHub/gemeng2/dist/鸽梦Godream/_internal/cv2/config.py","/Users/yunchang/Documents/GitHub/gemeng2/dist/鸽梦Godream_v1.2.1_正式版.app/Contents/Resources/cv2/config.py"],"durationMs":546,"numFiles":7,"truncated":false}}
{"parentUuid":"f2f99b9a-b54f-4798-8e65-df846ced54ac","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01CwMWWBUtZ5sNdPtPBiUD1v","type":"message","role":"assistant","content":[{"type":"text","text":"读取关键文件："}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":2380,"cache_read_input_tokens":48878,"cache_creation":{"ephemeral_5m_input_tokens":2380,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"45b88ce3-2c48-4e1d-a867-a223d34fba56","timestamp":"2025-11-25T19:09:12.381Z"}
{"parentUuid":"45b88ce3-2c48-4e1d-a867-a223d34fba56","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01CwMWWBUtZ5sNdPtPBiUD1v","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KpjdnXGQ2PHMmYuMeVM2Xz","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/schema.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":2380,"cache_read_input_tokens":48878,"cache_creation":{"ephemeral_5m_input_tokens":2380,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"40089f27-46c8-4d8c-9303-5f5bb1e2b8f7","timestamp":"2025-11-25T19:09:12.507Z"}
{"parentUuid":"40089f27-46c8-4d8c-9303-5f5bb1e2b8f7","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01CwMWWBUtZ5sNdPtPBiUD1v","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017Q2d3QJurkkGEQAHcbGXPp","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/volc_v4.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":2380,"cache_read_input_tokens":48878,"cache_creation":{"ephemeral_5m_input_tokens":2380,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"28b9e764-6ef0-43f4-a2ba-d90364fa9ff0","timestamp":"2025-11-25T19:09:12.673Z"}
{"parentUuid":"28b9e764-6ef0-43f4-a2ba-d90364fa9ff0","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017Q2d3QJurkkGEQAHcbGXPp","type":"tool_result","content":"     1→#!/usr/bin/env python3\n     2→# -*- coding: utf-8 -*-\n     3→\"\"\"\n     4→Volc (Ark) Seedream 4.0 Provider 映射。\n     5→\n     6→仅调整模型 ID 以及字段，以便在不改 UI 的前提下灰度接入。\n     7→\"\"\"\n     8→from typing import Dict, Any, Tuple, List\n     9→\n    10→def _to_v4_size(size: str) -> str:\n    11→    \"\"\"\n    12→    转换尺寸参数为 Seedream 4.0 支持的格式。\n    13→    支持两种格式：\n    14→    1. 分辨率格式：1K、2K、4K\n    15→    2. 具体像素值：如 2048x2048（保持原样）\n    16→    \"\"\"\n    17→    try:\n    18→        if not size:\n    19→            return \"2048x2048\"  # 默认值\n    20→        \n    21→        normalized = size.strip().lower()\n    22→        \n    23→        # 如果已经是支持的分辨率格式，直接返回\n    24→        if normalized in {\"1k\", \"2k\", \"4k\"}:\n    25→            return normalized\n    26→        \n    27→        # 如果是具体的像素值（如 \"2048x2048\"），验证范围并返回\n    28→        if \"x\" in normalized:\n    29→            width_str, height_str = normalized.split(\"x\", 1)\n    30→            width = int(float(width_str))\n    31→            height = int(float(height_str))\n    32→            \n    33→            # 验证尺寸范围：[1024x1024, 4096x4096]\n    34→            if width < 1024 or height < 1024:\n    35→                # 太小，使用最小尺寸\n    36→                return \"1024x1024\"\n    37→            elif width > 4096 or height > 4096:\n    38→                # 太大，使用最大尺寸\n    39→                return \"4096x4096\"\n    40→            else:\n    41→                # 在有效范围内，返回原始尺寸\n    42→                return f\"{width}x{height}\"\n    43→    except Exception:\n    44→        pass\n    45→    \n    46→    return \"2048x2048\"  # 默认值\n    47→\n    48→from .base import BaseProvider\n    49→from .schema import TextToImageParams, ImageToImageParams\n    50→\n    51→\n    52→class VolcV4Provider(BaseProvider):\n    53→    name = \"volcengine_v4\"\n    54→\n    55→    def map_t2i(self, params: TextToImageParams) -> Tuple[Dict[str, Any], bool, str, str]:\n    56→        norm, fb, reason = self.validate_t2i(params)\n    57→        size_value = _to_v4_size(norm.size)\n    58→        data = {\n    59→            \"model\": \"doubao-seedream-4-0-250828\",\n    60→            \"prompt\": norm.prompt,\n    61→            \"size\": size_value,\n    62→            \"response_format\": \"url\",\n    63→            \"watermark\": False,\n    64→        }\n    65→        # Seedream 4.0 不支持 seed 参数\n    66→        # 根据官方文档：\"seed 可以传入，但不生效\"\n    67→        # 为避免误导，这里不传递 seed\n    68→\n    69→        images_payload: List[str] = []\n    70→        for ref in norm.reference_images or []:\n    71→            if isinstance(ref, str) and ref:\n    72→                images_payload.append(ref)\n    73→\n    74→        if images_payload:\n    75→            # Ark 文档要求：单图输出场景保持 sequential_image_generation=disabled，\n    76→            # 仅在显式请求组图时才开启 auto。当前桌面端仍是单图出口，因此统一禁用，\n    77→            # 避免超过 4 张参考图时被服务端判定为组图任务并返回参数错误。\n    78→            data[\"image\"] = images_payload if len(images_payload) > 1 else images_payload[0]\n    79→            data[\"sequential_image_generation\"] = \"disabled\"\n    80→\n    81→        return data, fb, reason, \"/images/generations\"\n    82→\n    83→    def map_i2i(self, params: ImageToImageParams) -> Tuple[Dict[str, Any], bool, str, str]:\n    84→        norm, fb, reason = self.validate_i2i(params)\n    85→        target_size = _to_v4_size(getattr(norm, \"size\", None) or \"1k\")\n    86→        data = {\n    87→            \"model\": \"doubao-seedream-4-0-250828\",\n    88→            \"prompt\": norm.prompt,\n    89→            \"image\": norm.image,\n    90→            \"size\": target_size,\n    91→            \"response_format\": \"url\",\n    92→            \"watermark\": False,\n    93→        }\n    94→        # Seedream 4.0 不支持 seed 参数\n    95→        # 根据官方文档：\"seed 可以传入，但不生效\"\n    96→        # 为避免误导，这里不传递 seed\n    97→\n    98→        images_payload: List[str] = []\n    99→        if norm.image:\n   100→            images_payload.append(norm.image)\n   101→        for ref in norm.reference_images or []:\n   102→            if ref and isinstance(ref, str):\n   103→                images_payload.append(ref)\n   104→\n   105→        if images_payload:\n   106→            # 图生图同样保持单输出模式，避免触发组图分支。\n   107→            data[\"image\"] = images_payload if len(images_payload) > 1 else images_payload[0]\n   108→            data[\"sequential_image_generation\"] = \"disabled\"\n   109→        return data, fb, reason, \"/images/generations\"\n   110→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"1bebd982-c8e8-4e02-a924-5eca7f83e014","timestamp":"2025-11-25T19:09:12.848Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/volc_v4.py","content":"#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n\"\"\"\nVolc (Ark) Seedream 4.0 Provider 映射。\n\n仅调整模型 ID 以及字段，以便在不改 UI 的前提下灰度接入。\n\"\"\"\nfrom typing import Dict, Any, Tuple, List\n\ndef _to_v4_size(size: str) -> str:\n    \"\"\"\n    转换尺寸参数为 Seedream 4.0 支持的格式。\n    支持两种格式：\n    1. 分辨率格式：1K、2K、4K\n    2. 具体像素值：如 2048x2048（保持原样）\n    \"\"\"\n    try:\n        if not size:\n            return \"2048x2048\"  # 默认值\n        \n        normalized = size.strip().lower()\n        \n        # 如果已经是支持的分辨率格式，直接返回\n        if normalized in {\"1k\", \"2k\", \"4k\"}:\n            return normalized\n        \n        # 如果是具体的像素值（如 \"2048x2048\"），验证范围并返回\n        if \"x\" in normalized:\n            width_str, height_str = normalized.split(\"x\", 1)\n            width = int(float(width_str))\n            height = int(float(height_str))\n            \n            # 验证尺寸范围：[1024x1024, 4096x4096]\n            if width < 1024 or height < 1024:\n                # 太小，使用最小尺寸\n                return \"1024x1024\"\n            elif width > 4096 or height > 4096:\n                # 太大，使用最大尺寸\n                return \"4096x4096\"\n            else:\n                # 在有效范围内，返回原始尺寸\n                return f\"{width}x{height}\"\n    except Exception:\n        pass\n    \n    return \"2048x2048\"  # 默认值\n\nfrom .base import BaseProvider\nfrom .schema import TextToImageParams, ImageToImageParams\n\n\nclass VolcV4Provider(BaseProvider):\n    name = \"volcengine_v4\"\n\n    def map_t2i(self, params: TextToImageParams) -> Tuple[Dict[str, Any], bool, str, str]:\n        norm, fb, reason = self.validate_t2i(params)\n        size_value = _to_v4_size(norm.size)\n        data = {\n            \"model\": \"doubao-seedream-4-0-250828\",\n            \"prompt\": norm.prompt,\n            \"size\": size_value,\n            \"response_format\": \"url\",\n            \"watermark\": False,\n        }\n        # Seedream 4.0 不支持 seed 参数\n        # 根据官方文档：\"seed 可以传入，但不生效\"\n        # 为避免误导，这里不传递 seed\n\n        images_payload: List[str] = []\n        for ref in norm.reference_images or []:\n            if isinstance(ref, str) and ref:\n                images_payload.append(ref)\n\n        if images_payload:\n            # Ark 文档要求：单图输出场景保持 sequential_image_generation=disabled，\n            # 仅在显式请求组图时才开启 auto。当前桌面端仍是单图出口，因此统一禁用，\n            # 避免超过 4 张参考图时被服务端判定为组图任务并返回参数错误。\n            data[\"image\"] = images_payload if len(images_payload) > 1 else images_payload[0]\n            data[\"sequential_image_generation\"] = \"disabled\"\n\n        return data, fb, reason, \"/images/generations\"\n\n    def map_i2i(self, params: ImageToImageParams) -> Tuple[Dict[str, Any], bool, str, str]:\n        norm, fb, reason = self.validate_i2i(params)\n        target_size = _to_v4_size(getattr(norm, \"size\", None) or \"1k\")\n        data = {\n            \"model\": \"doubao-seedream-4-0-250828\",\n            \"prompt\": norm.prompt,\n            \"image\": norm.image,\n            \"size\": target_size,\n            \"response_format\": \"url\",\n            \"watermark\": False,\n        }\n        # Seedream 4.0 不支持 seed 参数\n        # 根据官方文档：\"seed 可以传入，但不生效\"\n        # 为避免误导，这里不传递 seed\n\n        images_payload: List[str] = []\n        if norm.image:\n            images_payload.append(norm.image)\n        for ref in norm.reference_images or []:\n            if ref and isinstance(ref, str):\n                images_payload.append(ref)\n\n        if images_payload:\n            # 图生图同样保持单输出模式，避免触发组图分支。\n            data[\"image\"] = images_payload if len(images_payload) > 1 else images_payload[0]\n            data[\"sequential_image_generation\"] = \"disabled\"\n        return data, fb, reason, \"/images/generations\"\n","numLines":110,"startLine":1,"totalLines":110}}}
{"parentUuid":"1bebd982-c8e8-4e02-a924-5eca7f83e014","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KpjdnXGQ2PHMmYuMeVM2Xz","type":"tool_result","content":"     1→﻿#!/usr/bin/env python3\n     2→# -*- coding: utf-8 -*-\n     3→\"\"\"\n     4→Provider 参数 Schema 与校验（最小落地）\n     5→\n     6→目标：\n     7→- 为图片/视频生成提供统一的参数模型与校验/归一化逻辑；\n     8→- 返回 (normalized, fallback_applied, fallback_reason) 三元组；\n     9→- 本阶段仅覆盖 Seedream 3.0/3.1 与 Seedance pro/lite 所需字段；UI 暂不改动。\n    10→\"\"\"\n    11→\n    12→import copy\n    13→from dataclasses import dataclass, field\n    14→from typing import Any, Optional, Tuple, List, Dict\n    15→\n    16→# 参考图限制（见官方文档 lines 203-204）\n    17→MAX_REFERENCE_IMAGES = 10  # doubao-seedream-4.0 最多支持10张参考图\n    18→MAX_REFERENCE_BUNDLE = 15  # 参考图数量 + 生成图数量 ≤ 15（组图扩展）\n    19→\n    20→\n    21→# 白名单与范围\n    22→RES_GRADES = {\"480p\", \"720p\", \"1080p\"}\n    23→RATIOS = {\"16:9\", \"9:16\", \"4:3\", \"1:1\", \"3:4\", \"21:9\"}\n    24→\n    25→\n    26→@dataclass\n    27→class TextToImageParams:\n    28→    prompt: str\n    29→    size: str = \"1024x1024\"\n    30→    guidance_scale: float = 2.5\n    31→    seed: Optional[int] = None  # -1 表示随机 → 归一化为 None\n    32→    reference_images: List[str] = field(default_factory=list)\n    33→\n    34→\n    35→@dataclass\n    36→class ImageToImageParams:\n    37→    prompt: str\n    38→    image: str  # URL 或 data URL\n    39→    guidance_scale: float = 5.5\n    40→    seed: Optional[int] = None\n    41→    reference_images: List[str] = field(default_factory=list)\n    42→\n    43→\n    44→@dataclass\n    45→class VideoParams:\n    46→    prompt: str\n    47→    image_path: Optional[str] = None\n    48→    first_frame_path: Optional[str] = None\n    49→    last_frame_path: Optional[str] = None\n    50→    duration: int = 8\n    51→    fps: int = 24\n    52→    seed: Optional[int] = None\n    53→    camera_fixed: bool = True\n    54→    watermark: bool = False\n    55→    resolution_grade: Optional[str] = None\n    56→    ratio: Optional[str] = None\n    57→    use_pro_model: bool = True\n    58→    reference_images: List[str] = field(default_factory=list)\n    59→\n    60→\n    61→@dataclass(frozen=True)\n    62→class UIOption:\n    63→    value: Any\n    64→    label: str\n    65→    description: Optional[str] = None\n    66→    meta: Dict[str, Any] = field(default_factory=dict)\n    67→\n    68→\n    69→@dataclass(frozen=True)\n    70→class UIDependency:\n    71→    field: str\n    72→    equals: Any = None\n    73→    not_equals: Any = None\n    74→    exists: bool = False\n    75→\n    76→\n    77→@dataclass\n    78→class UISchemaField:\n    79→    name: str\n    80→    field_type: str\n    81→    label: str\n    82→    default: Any = None\n    83→    required: bool = False\n    84→    help_text: Optional[str] = None\n    85→    placeholder: Optional[str] = None\n    86→    options: List[UIOption] = field(default_factory=list)\n    87→    min_value: Optional[float] = None\n    88→    max_value: Optional[float] = None\n    89→    step: Optional[float] = None\n    90→    visible_if: List[UIDependency] = field(default_factory=list)\n    91→    enabled_if: List[UIDependency] = field(default_factory=list)\n    92→    extra: Dict[str, Any] = field(default_factory=dict)\n    93→\n    94→    def to_dict(self) -> Dict[str, Any]:\n    95→        return {\n    96→            \"name\": self.name,\n    97→            \"type\": self.field_type,\n    98→            \"label\": self.label,\n    99→            \"default\": self.default,\n   100→            \"required\": self.required,\n   101→            \"help_text\": self.help_text,\n   102→            \"placeholder\": self.placeholder,\n   103→            \"options\": [\n   104→                {\n   105→                    \"value\": opt.value,\n   106→                    \"label\": opt.label,\n   107→                    \"description\": opt.description,\n   108→                    \"meta\": opt.meta,\n   109→                }\n   110→                for opt in self.options\n   111→            ],\n   112→            \"min\": self.min_value,\n   113→            \"max\": self.max_value,\n   114→            \"step\": self.step,\n   115→            \"visible_if\": [\n   116→                {\n   117→                    \"field\": dep.field,\n   118→                    \"equals\": dep.equals,\n   119→                    \"not_equals\": dep.not_equals,\n   120→                    \"exists\": dep.exists,\n   121→                }\n   122→                for dep in self.visible_if\n   123→            ],\n   124→            \"enabled_if\": [\n   125→                {\n   126→                    \"field\": dep.field,\n   127→                    \"equals\": dep.equals,\n   128→                    \"not_equals\": dep.not_equals,\n   129→                    \"exists\": dep.exists,\n   130→                }\n   131→                for dep in self.enabled_if\n   132→            ],\n   133→            \"extra\": self.extra,\n   134→        }\n   135→\n   136→\n   137→@dataclass\n   138→class UISchema:\n   139→    provider: str\n   140→    mode: str\n   141→    variant: str\n   142→    fields: List[UISchemaField] = field(default_factory=list)\n   143→    primary_image: Dict[str, Any] = field(default_factory=dict)\n   144→    reference_assets: Dict[str, Any] = field(default_factory=dict)\n   145→    extra: Dict[str, Any] = field(default_factory=dict)\n   146→\n   147→    def to_dict(self) -> Dict[str, Any]:\n   148→        return {\n   149→            \"provider\": self.provider,\n   150→            \"mode\": self.mode,\n   151→            \"variant\": self.variant,\n   152→            \"fields\": [field.to_dict() for field in self.fields],\n   153→            \"primary_image\": self.primary_image,\n   154→            \"reference_assets\": self.reference_assets,\n   155→            \"extra\": self.extra,\n   156→        }\n   157→\n   158→\n   159→def _clip_seed(seed: Optional[int]) -> Optional[int]:\n   160→    if seed is None:\n   161→        return None\n   162→    try:\n   163→        iv = int(seed)\n   164→    except Exception:\n   165→        return None\n   166→    if iv < 0:\n   167→        return None\n   168→    if iv > 2147483647:\n   169→        iv = 2147483647\n   170→    return iv\n   171→\n   172→\n   173→def validate_and_normalize_t2i(p: TextToImageParams) -> Tuple[TextToImageParams, bool, str]:\n   174→    fb = False\n   175→    reasons: List[str] = []\n   176→    # size: 期望形如 WxH，范围 512..4096（兼容 Seedream 4.0 高分辨率）\n   177→    def _valid_size(s: str) -> bool:\n   178→        try:\n   179→            if 'x' not in s:\n   180→                return False\n   181→            w, h = s.split('x', 1)\n   182→            w, h = int(w), int(h)\n   183→            return 512 <= w <= 4096 and 512 <= h <= 4096\n   184→        except Exception:\n   185→            return False\n   186→\n   187→    size = p.size or \"1024x1024\"\n   188→    if not _valid_size(size):\n   189→        fb = True\n   190→        reasons.append(f\"无效尺寸: {p.size or '缺失'}\")\n   191→        size = \"1024x1024\"\n   192→\n   193→    gs = p.guidance_scale\n   194→    if not (1.0 <= gs <= 10.0):\n   195→        fb = True\n   196→        reasons.append(f\"guidance_scale越界: {gs}\")\n   197→        gs = min(10.0, max(1.0, gs)) if isinstance(gs, (int, float)) else 2.5\n   198→\n   199→    seed = _clip_seed(p.seed)\n   200→\n   201→    raw_refs: List[str] = []\n   202→    try:\n   203→        for item in p.reference_images or []:\n   204→            if isinstance(item, str) and item:\n   205→                raw_refs.append(item)\n   206→    except Exception:\n   207→        raw_refs = []\n   208→\n   209→    refs, ref_fb, ref_reason = _normalize_reference_images(raw_refs, expected_outputs=1)\n   210→    if ref_fb:\n   211→        fb = True\n   212→        reasons.append(ref_reason)\n   213→\n   214→    norm = TextToImageParams(\n   215→        prompt=p.prompt,\n   216→        size=size,\n   217→        guidance_scale=gs,\n   218→        seed=seed,\n   219→        reference_images=refs,\n   220→    )\n   221→    return norm, fb, \", \".join(reasons) if fb else \"\"\n   222→\n   223→\n   224→def _normalize_reference_images(refs: List[str], expected_outputs: int = 1) -> Tuple[List[str], bool, str]:\n   225→    \"\"\"裁剪/校验参考图数量，返回 (normalized_refs, fallback, reason)。\n   226→\n   227→    约束源于官方文档《doubao-seedream-4.0 教程》（行 203-204）：\n   228→    - Seedream 4.0 最多 10 张参考图；\n   229→    - （组图扩展）参考图数量 + 生成图数量 ≤ 15。\n   230→    \"\"\"\n   231→    fb = False\n   232→    reasons: List[str] = []\n   233→    refs = [r for r in refs if isinstance(r, str) and r]\n   234→    # 限制：≤10 张\n   235→    if len(refs) > MAX_REFERENCE_IMAGES:\n   236→        fb = True\n   237→        reasons.append(\n   238→            f\"参考图数量超过 {MAX_REFERENCE_IMAGES}，已自动截取前 {MAX_REFERENCE_IMAGES} 张\"\n   239→        )\n   240→        refs = refs[:MAX_REFERENCE_IMAGES]\n   241→    # 组图扩展：参考图 + 生成图 ≤ 15（当前生成图默认为 expected_outputs）\n   242→    if expected_outputs >= 0 and len(refs) + expected_outputs > MAX_REFERENCE_BUNDLE:\n   243→        allowed = max(0, MAX_REFERENCE_BUNDLE - expected_outputs)\n   244→        if len(refs) > allowed:\n   245→            fb = True\n   246→            reasons.append(\n   247→                f\"参考图与生成量合计超过 {MAX_REFERENCE_BUNDLE}，已截取前 {allowed} 张\"\n   248→            )\n   249→            refs = refs[:allowed]\n   250→    return refs, fb, \", \".join(reasons) if fb else \"\"\n   251→\n   252→\n   253→def validate_and_normalize_i2i(p: ImageToImageParams) -> Tuple[ImageToImageParams, bool, str]:\n   254→    fb = False\n   255→    reasons: List[str] = []\n   256→    gs = p.guidance_scale\n   257→    if not (1.0 <= gs <= 10.0):\n   258→        fb = True\n   259→        reasons.append(f\"guidance_scale越界: {gs}\")\n   260→        gs = min(10.0, max(1.0, gs)) if isinstance(gs, (int, float)) else 5.5\n   261→    seed = _clip_seed(p.seed)\n   262→    raw_refs: List[str] = []\n   263→    try:\n   264→        for item in p.reference_images or []:\n   265→            if isinstance(item, str) and item:\n   266→                raw_refs.append(item)\n   267→    except Exception:\n   268→        raw_refs = []\n   269→\n   270→    refs, ref_fb, ref_reason = _normalize_reference_images(raw_refs, expected_outputs=1)\n   271→    if ref_fb:\n   272→        fb = True\n   273→        reasons.append(ref_reason)\n   274→\n   275→    norm = ImageToImageParams(\n   276→        prompt=p.prompt,\n   277→        image=p.image,\n   278→        guidance_scale=gs,\n   279→        seed=seed,\n   280→        reference_images=refs,\n   281→    )\n   282→    return norm, fb, \", \".join(reasons) if fb else \"\"\n   283→\n   284→\n   285→def validate_and_normalize_video(p: VideoParams) -> Tuple[VideoParams, bool, str, str, str]:\n   286→    \"\"\"返回 (normalized, fallback_applied, fallback_reason, used_rs, used_rt)\"\"\"\n   287→    fb = False\n   288→    reasons: List[str] = []\n   289→\n   290→    rs = p.resolution_grade or \"1080p\"\n   291→    rt = p.ratio or \"16:9\"\n   292→    if rs not in RES_GRADES:\n   293→        fb = True\n   294→        reasons.append(f\"无效分辨率: {rs}\")\n   295→        rs = \"1080p\"\n   296→    if rt not in RATIOS:\n   297→        fb = True\n   298→        reasons.append(f\"无效比例: {rt}\")\n   299→        rt = \"16:9\"\n   300→\n   301→    fps = int(p.fps or 24)\n   302→    if fps <= 0:\n   303→        fps = 24\n   304→    dur = int(p.duration or 8)\n   305→    if dur < 3:\n   306→        fb = True\n   307→        reasons.append(\"时长过短(<3s)\")\n   308→        dur = 3\n   309→    if dur > 12:\n   310→        fb = True\n   311→        reasons.append(\"时长过长(>12s)\")\n   312→        dur = 12\n   313→\n   314→    seed = _clip_seed(p.seed)\n   315→    raw_refs: List[str] = []\n   316→    try:\n   317→        for item in p.reference_images or []:\n   318→            if isinstance(item, str) and item:\n   319→                raw_refs.append(item)\n   320→    except Exception:\n   321→        raw_refs = []\n   322→\n   323→    refs, ref_fb, ref_reason = _normalize_reference_images(raw_refs, expected_outputs=1)\n   324→    if ref_fb:\n   325→        fb = True\n   326→        reasons.append(ref_reason)\n   327→\n   328→    norm = VideoParams(\n   329→        prompt=p.prompt,\n   330→        image_path=p.image_path,\n   331→        first_frame_path=p.first_frame_path,\n   332→        last_frame_path=p.last_frame_path,\n   333→        duration=dur,\n   334→        fps=fps,\n   335→        seed=seed,\n   336→        camera_fixed=bool(p.camera_fixed),\n   337→        watermark=bool(p.watermark),\n   338→        resolution_grade=rs,\n   339→        ratio=rt,\n   340→        use_pro_model=bool(p.use_pro_model),\n   341→        reference_images=refs,\n   342→    )\n   343→    return norm, fb, \", \".join(reasons) if fb else \"\", rs, rt\n   344→\n   345→\n   346→# ------------------------------\n   347→# UI Schema 定义（供前端驱动参数面板）\n   348→# ------------------------------\n   349→\n   350→\n   351→def _schema_key(provider: str, mode: str, variant: str) -> str:\n   352→    return f\"{provider}:{mode}:{variant}\"\n   353→\n   354→\n   355→def _option(value: Any, label: str, *, description: Optional[str] = None, meta: Optional[Dict[str, Any]] = None) -> UIOption:\n   356→    return UIOption(value=value, label=label, description=description, meta=meta or {})\n   357→\n   358→\n   359→def _dependency(field: str, *, equals: Any = None, not_equals: Any = None, exists: bool = False) -> UIDependency:\n   360→    return UIDependency(field=field, equals=equals, not_equals=not_equals, exists=exists)\n   361→\n   362→\n   363→def _build_seedream_schema(variant: str) -> UISchema:\n   364→    variant = variant or \"seedream_v3\"\n   365→    fields: List[UISchemaField] = []\n   366→\n   367→    model_options = [\n   368→        _option(\n   369→            \"seedream_v3\",\n   370→            \"Seedream 3.x\",\n   371→            description=\"稳定版本，支持单图/文生图\",\n   372→            meta={\n   373→                \"t2i_model\": \"doubao-seedream-3-0-t2i-250415\",\n   374→                \"i2i_model\": \"doubao-seededit-3-0-i2i-250628\",\n   375→                \"ui_variant\": \"seedream_v3\",\n   376→            },\n   377→        ),\n   378→        _option(\n   379→            \"seedream_v4\",\n   380→            \"Seedream 4.0\",\n   381→            description=\"多参考图融合，最大10张参考图\",\n   382→            meta={\n   383→                \"t2i_model\": \"doubao-seedream-4-0-250828\",\n   384→                \"i2i_model\": \"doubao-seedream-4-0-250828\",\n   385→                \"ui_variant\": \"seedream_v4\",\n   386→            },\n   387→        ),\n   388→    ]\n   389→    fields.append(\n   390→        UISchemaField(\n   391→            name=\"model_variant\",\n   392→            field_type=\"select\",\n   393→            label=\"模型版本\",\n   394→            default=variant,\n   395→            help_text=\"切换模型将刷新可选参数与上传限制\",\n   396→            options=model_options,\n   397→            extra={\"reload_on_change\": True, \"schema_family\": \"seedream\"},\n   398→        )\n   399→    )\n   400→\n   401→    if variant == \"seedream_v4\":\n   402→        size_options = [\n   403→            # 4K最大尺寸 (Seedream 4.0)\n   404→            _option(\"4096x4096\", \"4096×4096 (1:1) 🔥\"),\n   405→            _option(\"4096x2304\", \"4096×2304 (16:9) 🔥\"),\n   406→            _option(\"2304x4096\", \"2304×4096 (9:16) 🔥\"),\n   407→            \n   408→            # 标准4K尺寸\n   409→            _option(\"3840x2160\", \"3840×2160 (16:9)\"),\n   410→            _option(\"2160x3840\", \"2160×3840 (9:16)\"),\n   411→            _option(\"4096x3072\", \"4096×3072 (4:3)\"),\n   412→            _option(\"3072x4096\", \"3072×4096 (3:4)\"),\n   413→            _option(\"4096x2731\", \"4096×2731 (3:2)\"),\n   414→            _option(\"2731x4096\", \"2731×4096 (2:3)\"),\n   415→            _option(\"4096x1755\", \"4096×1755 (21:9)\"),\n   416→            \n   417→            # 兼容性尺寸\n   418→            _option(\"3072x2048\", \"3072×2048 (3:2)\"),\n   419→            _option(\"2048x3072\", \"2048×3072 (2:3)\"),\n   420→            _option(\"2048x2048\", \"2048×2048 (1:1)\"),\n   421→            _option(\"1920x1080\", \"1920×1080 (16:9)\"),\n   422→            _option(\"1080x1920\", \"1080×1920 (9:16)\"),\n   423→            _option(\"1024x1024\", \"1024×1024 (1:1)\"),\n   424→        ]\n   425→        default_size = \"4096x4096\"\n   426→        # 过滤：移除边长小于 1024 的尺寸项（例如 1512x648），保证 4.0 仅提供大尺寸\n   427→        try:\n   428→            filtered_opts = []\n   429→            for opt in list(size_options):\n   430→                try:\n   431→                    parts = [int(x.strip()) for x in str(opt.value).lower().split('x')]\n   432→                    if len(parts) == 2 and min(parts[0], parts[1]) < 1024:\n   433→                        continue\n   434→                except Exception:\n   435→                    pass\n   436→                filtered_opts.append(opt)\n   437→            size_options = filtered_opts\n   438→        except Exception:\n   439→            pass\n   440→    else:\n   441→        # Seedream 3.x：按常见比例提供范围内的最大像素组合（宽高在 512–2048）\n   442→        size_options = [\n   443→            _option(\"2048x2048\", \"2048×2048 (1:1)\"),\n   444→            _option(\"2048x1536\", \"2048×1536 (4:3)\"),\n   445→            _option(\"1536x2048\", \"1536×2048 (3:4)\"),\n   446→            _option(\"2048x1152\", \"2048×1152 (16:9)\"),\n   447→            _option(\"1152x2048\", \"1152×2048 (9:16)\"),\n   448→            _option(\"1920x1280\", \"1920×1280 (3:2)\"),\n   449→            _option(\"1280x1920\", \"1280×1920 (2:3)\"),\n   450→            _option(\"1792x768\",  \"1792×768 (21:9)\"),\n   451→        ]\n   452→        default_size = \"2048x2048\"\n   453→\n   454→    fields.append(\n   455→        UISchemaField(\n   456→            name=\"size\",\n   457→            field_type=\"select\",\n   458→            label=\"分辨率\",\n   459→            default=default_size,\n   460→            options=size_options,\n   461→            help_text=\"仅提供官方支持的常用分辨率\",\n   462→        )\n   463→    )\n   464→\n   465→    fields.append(\n   466→        UISchemaField(\n   467→            name=\"seed\",\n   468→            field_type=\"spinbox\",\n   469→            label=\"Seed\",\n   470→            default=-1,\n   471→            min_value=-1,\n   472→            max_value=2147483647,\n   473→            help_text=\"-1 表示随机；指定整数可复现结果\",\n   474→        )\n   475→    )\n   476→\n   477→    fields.append(\n   478→        UISchemaField(\n   479→            name=\"count\",\n   480→            field_type=\"spinbox\",\n   481→            label=\"生成数量\",\n   482→            default=1,\n   483→            min_value=1,\n   484→            max_value=10,\n   485→            help_text=\"一次最多生成 10 张\",\n   486→        )\n   487→    )\n   488→\n   489→    # 隐藏\"自动压缩参考图\"参数，后端自动启用\n   490→    # fields.append(\n   491→    #     UISchemaField(\n   492→    #         name=\"auto_compress_references\",\n   493→    #         field_type=\"toggle\",\n   494→    #         label=\"自动压缩参考图\",\n   495→    #         default=True,\n   496→    #         help_text=\"上传时自动压缩到 2K 内，避免超出 API 限制\",\n   497→    #     )\n   498→    # )\n   499→\n   500→    if variant == \"seedream_v4\":\n   501→        reference_enabled = True\n   502→        ref_max_count = MAX_REFERENCE_IMAGES\n   503→        ref_bundle_limit = MAX_REFERENCE_BUNDLE\n   504→        ref_help = \"最多 10 张参考图，参考图 + 输出数量 ≤ 15\"\n   505→        multi_reference = True\n   506→    else:\n   507→        # seedream_v3: 保留旧体验（单张参考图，面板隐藏）\n   508→        reference_enabled = False\n   509→        ref_max_count = 1\n   510→        ref_bundle_limit = 1\n   511→        ref_help = \"最多 1 张参考图\"\n   512→        multi_reference = False\n   513→\n   514→    reference_assets = {\n   515→        \"enabled\": reference_enabled,\n   516→        \"max_count\": ref_max_count,\n   517→        \"bundle_limit\": ref_bundle_limit,\n   518→        \"accept\": [\"image/png\", \"image/jpeg\"],\n   519→        \"auto_compress_field\": \"auto_compress_references\",\n   520→        \"help_text\": ref_help,\n   521→        \"orderable\": True,\n   522→    }\n   523→\n   524→    primary_image = {\n   525→        \"enabled\": True,\n   526→        \"label\": \"基础图 (可选)\",\n   527→        \"placeholder\": \"拖拽或点击上传一张基础图，留空则进行文生图\",\n   528→        \"accept\": [\"image/png\", \"image/jpeg\"],\n   529→        \"max_size_mb\": 10,\n   530→    }\n   531→\n   532→    capabilities = {\n   533→        \"multi_reference\": multi_reference,\n   534→        \"supports_reference\": True,\n   535→        \"single_reference\": not multi_reference,\n   536→    }\n   537→\n   538→    extra = {\n   539→        \"supports_reference\": True,  # 3.x模式也支持参考图显示，只是UI面板隐藏\n   540→        \"layout\": {\n   541→            \"type\": \"rows\",\n   542→            \"row_spacing\": 6,\n   543→            \"column_spacing\": 12,\n   544→            \"rows\": [\n   545→                [\n   546→                    {\"name\": \"model_variant\", \"stretch\": 3, \"label_width\": 70, \"min_width\": 220},\n   547→                    {\"name\": \"size\", \"stretch\": 2, \"label_width\": 70, \"min_width\": 120},\n   548→                    {\"name\": \"seed\", \"stretch\": 1, \"label_width\": 70, \"min_width\": 120},\n   549→                    {\"name\": \"count\", \"stretch\": 1, \"label_width\": 70, \"min_width\": 100},\n   550→                    {\n   551→                        \"name\": \"auto_compress_references\",\n   552→                        \"stretch\": 1,\n   553→                        \"label_width\": 70,\n   554→                    },\n   555→                ],\n   556→            ],\n   557→        },\n   558→        \"capabilities\": capabilities,\n   559→    }\n   560→\n   561→    return UISchema(\n   562→        provider=\"seedream\",\n   563→        mode=\"image\",\n   564→        variant=variant,\n   565→        fields=fields,\n   566→        primary_image=primary_image,\n   567→        reference_assets=reference_assets,\n   568→        extra=extra,\n   569→    )\n   570→\n   571→\n   572→def _build_seedance_schema(variant: str) -> UISchema:\n   573→    variant = variant or \"seedance_pro\"\n   574→    model_options = [\n   575→        _option(\n   576→            \"seedance_pro\",\n   577→            \"Seedance Pro\",\n   578→            description=\"高质量输出，适合正式素材\",\n   579→            meta={\"use_pro_model\": True, \"ui_variant\": \"seedance_pro\"},\n   580→        ),\n   581→        _option(\n   582→            \"seedance_lite\",\n   583→            \"Seedance Lite\",\n   584→            description=\"快速输出，适合草稿\",\n   585→            meta={\"use_pro_model\": False, \"ui_variant\": \"seedance_lite\"},\n   586→        ),\n   587→    ]\n   588→\n   589→    fields: List[UISchemaField] = [\n   590→        UISchemaField(\n   591→            name=\"model_variant\",\n   592→            field_type=\"select\",\n   593→            label=\"模型\",\n   594→            default=variant,\n   595→            help_text=\"Pro 输出质量更高，Lite 更快速\",\n   596→            options=model_options,\n   597→            extra={\"reload_on_change\": True, \"schema_family\": \"seedance\"},\n   598→        ),\n   599→        UISchemaField(\n   600→            name=\"resolution_grade\",\n   601→            field_type=\"select\",\n   602→            label=\"分辨率档位\",\n   603→            default=\"1080p\",\n   604→            options=[\n   605→                _option(\"480p\", \"480p\"),\n   606→                _option(\"720p\", \"720p\"),\n   607→                _option(\"1080p\", \"1080p\"),\n   608→            ],\n   609→            help_text=\"官方推荐 480p/720p/1080p 三档\",\n   610→        ),\n   611→        UISchemaField(\n   612→            name=\"ratio\",\n   613→            field_type=\"select\",\n   614→            label=\"画面比例\",\n   615→            default=\"16:9\",\n   616→            options=[\n   617→                _option(\"16:9\", \"16:9\"),\n   618→                _option(\"9:16\", \"9:16\"),\n   619→                _option(\"4:3\", \"4:3\"),\n   620→                _option(\"1:1\", \"1:1\"),\n   621→                _option(\"3:4\", \"3:4\"),\n   622→                _option(\"21:9\", \"21:9\"),\n   623→            ],\n   624→            help_text=\"生成时自动拼接 --rs/--rt 参数\",\n   625→        ),\n   626→        UISchemaField(\n   627→            name=\"duration\",\n   628→            field_type=\"select\",\n   629→            label=\"时长 (秒)\",\n   630→            default=5,\n   631→            options=[_option(sec, f\"{sec} 秒\") for sec in range(3, 13)],\n   632→            help_text=\"范围 3-12 秒，超过范围将自动回退\",\n   633→        ),\n   634→        UISchemaField(\n   635→            name=\"seed\",\n   636→            field_type=\"spinbox\",\n   637→            label=\"Seed\",\n   638→            default=-1,\n   639→            min_value=-1,\n   640→            max_value=2147483647,\n   641→            help_text=\"-1 表示随机；指定整数可复现\",\n   642→        ),\n   643→        UISchemaField(\n   644→            name=\"camera_fixed\",\n   645→            field_type=\"toggle\",\n   646→            label=\"固定摄像机\",\n   647→            default=True,\n   648→            help_text=\"开启后相机保持固定，适合稳态镜头\",\n   649→        ),\n   650→    ]\n   651→\n   652→    reference_assets = {\n   653→        \"enabled\": False,\n   654→        \"max_count\": 0,\n   655→        \"bundle_limit\": 0,\n   656→        \"accept\": [],\n   657→        \"auto_compress_field\": None,\n   658→        \"help_text\": \"\",\n   659→        \"orderable\": False,\n   660→    }\n   661→\n   662→    primary_frames = {\n   663→        \"enabled\": True,\n   664→        \"slots\": [\n   665→            {\n   666→                \"name\": \"first_frame\",\n   667→                \"label\": \"首帧 (可选)\",\n   668→                \"help_text\": \"提供首帧可提升人物一致性\",\n   669→                \"accept\": [\"image/png\", \"image/jpeg\"],\n   670→            },\n   671→            {\n   672→                \"name\": \"last_frame\",\n   673→                \"label\": \"尾帧 (可选)\",\n   674→                \"help_text\": \"提供尾帧可控制结尾画面\",\n   675→                \"accept\": [\"image/png\", \"image/jpeg\"],\n   676→            },\n   677→        ],\n   678→        \"max_size_mb\": 10,\n   679→    }\n   680→\n   681→    capabilities = {\n   682→        \"multi_reference\": False,\n   683→        \"supports_reference\": False,\n   684→    }\n   685→\n   686→    extra = {\n   687→        \"use_pro_model\": variant == \"seedance_pro\",\n   688→        \"layout\": {\n   689→            \"type\": \"rows\",\n   690→            \"row_spacing\": 6,\n   691→            \"column_spacing\": 10,\n   692→            \"rows\": [\n   693→                [\n   694→                    {\"name\": \"model_variant\", \"stretch\": 2, \"label_width\": 70, \"min_width\": 160},\n   695→                    {\"name\": \"resolution_grade\", \"stretch\": 2, \"label_width\": 70, \"min_width\": 140},\n   696→                    {\"name\": \"ratio\", \"stretch\": 1, \"label_width\": 70, \"min_width\": 110},\n   697→                    {\"name\": \"duration\", \"stretch\": 1, \"label_width\": 70, \"min_width\": 110},\n   698→                    {\"name\": \"seed\", \"stretch\": 1, \"label_width\": 70, \"min_width\": 120},\n   699→                    {\"name\": \"camera_fixed\", \"stretch\": 1, \"label_width\": 70, \"min_width\": 110},\n   700→                ],\n   701→            ],\n   702→        },\n   703→        \"capabilities\": capabilities,\n   704→    }\n   705→\n   706→    return UISchema(\n   707→        provider=\"seedance\",\n   708→        mode=\"video\",\n   709→        variant=variant,\n   710→        fields=fields,\n   711→        primary_image=primary_frames,\n   712→        reference_assets=reference_assets,\n   713→        extra=extra,\n   714→    )\n   715→\n   716→\n   717→_UI_SCHEMAS: Dict[str, UISchema] = {\n   718→    _schema_key(\"seedream\", \"image\", \"seedream_v3\"): _build_seedream_schema(\"seedream_v3\"),\n   719→    _schema_key(\"seedream\", \"image\", \"seedream_v4\"): _build_seedream_schema(\"seedream_v4\"),\n   720→    _schema_key(\"seedance\", \"video\", \"seedance_pro\"): _build_seedance_schema(\"seedance_pro\"),\n   721→    _schema_key(\"seedance\", \"video\", \"seedance_lite\"): _build_seedance_schema(\"seedance_lite\"),\n   722→}\n   723→\n   724→\n   725→_DEFAULT_VARIANTS: Dict[Tuple[str, str], str] = {\n   726→    (\"seedream\", \"image\"): \"seedream_v3\",\n   727→    (\"seedance\", \"video\"): \"seedance_pro\",\n   728→}\n   729→\n   730→\n   731→def get_ui_schema(provider: str, mode: str, variant: Optional[str] = None, *, as_dict: bool = False) -> UISchema:\n   732→    \"\"\"返回 UI Schema（深拷贝，避免调用侧修改真源）。\"\"\"\n   733→\n   734→    key_variant = variant or _DEFAULT_VARIANTS.get((provider, mode))\n   735→    if not key_variant:\n   736→        raise ValueError(f\"未定义默认 UI Schema: provider={provider} mode={mode}\")\n   737→\n   738→    key = _schema_key(provider, mode, key_variant)\n   739→    if key not in _UI_SCHEMAS:\n   740→        raise ValueError(f\"未找到 UI Schema: provider={provider} mode={mode} variant={key_variant}\")\n   741→\n   742→    schema = copy.deepcopy(_UI_SCHEMAS[key])\n   743→    if as_dict:\n   744→        return schema.to_dict()  # type: ignore[return-value]\n   745→    return schema\n   746→\n   747→\n   748→def list_ui_schema_variants(provider: str, mode: str) -> List[str]:\n   749→    prefix = f\"{provider}:{mode}:\"\n   750→    return [key.split(\":\", 2)[-1] for key in _UI_SCHEMAS.keys() if key.startswith(prefix)]\n   751→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"a6e81da6-97dd-4087-a5d8-460a2e07516c","timestamp":"2025-11-25T19:09:12.854Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/schema.py","content":"﻿#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n\"\"\"\nProvider 参数 Schema 与校验（最小落地）\n\n目标：\n- 为图片/视频生成提供统一的参数模型与校验/归一化逻辑；\n- 返回 (normalized, fallback_applied, fallback_reason) 三元组；\n- 本阶段仅覆盖 Seedream 3.0/3.1 与 Seedance pro/lite 所需字段；UI 暂不改动。\n\"\"\"\n\nimport copy\nfrom dataclasses import dataclass, field\nfrom typing import Any, Optional, Tuple, List, Dict\n\n# 参考图限制（见官方文档 lines 203-204）\nMAX_REFERENCE_IMAGES = 10  # doubao-seedream-4.0 最多支持10张参考图\nMAX_REFERENCE_BUNDLE = 15  # 参考图数量 + 生成图数量 ≤ 15（组图扩展）\n\n\n# 白名单与范围\nRES_GRADES = {\"480p\", \"720p\", \"1080p\"}\nRATIOS = {\"16:9\", \"9:16\", \"4:3\", \"1:1\", \"3:4\", \"21:9\"}\n\n\n@dataclass\nclass TextToImageParams:\n    prompt: str\n    size: str = \"1024x1024\"\n    guidance_scale: float = 2.5\n    seed: Optional[int] = None  # -1 表示随机 → 归一化为 None\n    reference_images: List[str] = field(default_factory=list)\n\n\n@dataclass\nclass ImageToImageParams:\n    prompt: str\n    image: str  # URL 或 data URL\n    guidance_scale: float = 5.5\n    seed: Optional[int] = None\n    reference_images: List[str] = field(default_factory=list)\n\n\n@dataclass\nclass VideoParams:\n    prompt: str\n    image_path: Optional[str] = None\n    first_frame_path: Optional[str] = None\n    last_frame_path: Optional[str] = None\n    duration: int = 8\n    fps: int = 24\n    seed: Optional[int] = None\n    camera_fixed: bool = True\n    watermark: bool = False\n    resolution_grade: Optional[str] = None\n    ratio: Optional[str] = None\n    use_pro_model: bool = True\n    reference_images: List[str] = field(default_factory=list)\n\n\n@dataclass(frozen=True)\nclass UIOption:\n    value: Any\n    label: str\n    description: Optional[str] = None\n    meta: Dict[str, Any] = field(default_factory=dict)\n\n\n@dataclass(frozen=True)\nclass UIDependency:\n    field: str\n    equals: Any = None\n    not_equals: Any = None\n    exists: bool = False\n\n\n@dataclass\nclass UISchemaField:\n    name: str\n    field_type: str\n    label: str\n    default: Any = None\n    required: bool = False\n    help_text: Optional[str] = None\n    placeholder: Optional[str] = None\n    options: List[UIOption] = field(default_factory=list)\n    min_value: Optional[float] = None\n    max_value: Optional[float] = None\n    step: Optional[float] = None\n    visible_if: List[UIDependency] = field(default_factory=list)\n    enabled_if: List[UIDependency] = field(default_factory=list)\n    extra: Dict[str, Any] = field(default_factory=dict)\n\n    def to_dict(self) -> Dict[str, Any]:\n        return {\n            \"name\": self.name,\n            \"type\": self.field_type,\n            \"label\": self.label,\n            \"default\": self.default,\n            \"required\": self.required,\n            \"help_text\": self.help_text,\n            \"placeholder\": self.placeholder,\n            \"options\": [\n                {\n                    \"value\": opt.value,\n                    \"label\": opt.label,\n                    \"description\": opt.description,\n                    \"meta\": opt.meta,\n                }\n                for opt in self.options\n            ],\n            \"min\": self.min_value,\n            \"max\": self.max_value,\n            \"step\": self.step,\n            \"visible_if\": [\n                {\n                    \"field\": dep.field,\n                    \"equals\": dep.equals,\n                    \"not_equals\": dep.not_equals,\n                    \"exists\": dep.exists,\n                }\n                for dep in self.visible_if\n            ],\n            \"enabled_if\": [\n                {\n                    \"field\": dep.field,\n                    \"equals\": dep.equals,\n                    \"not_equals\": dep.not_equals,\n                    \"exists\": dep.exists,\n                }\n                for dep in self.enabled_if\n            ],\n            \"extra\": self.extra,\n        }\n\n\n@dataclass\nclass UISchema:\n    provider: str\n    mode: str\n    variant: str\n    fields: List[UISchemaField] = field(default_factory=list)\n    primary_image: Dict[str, Any] = field(default_factory=dict)\n    reference_assets: Dict[str, Any] = field(default_factory=dict)\n    extra: Dict[str, Any] = field(default_factory=dict)\n\n    def to_dict(self) -> Dict[str, Any]:\n        return {\n            \"provider\": self.provider,\n            \"mode\": self.mode,\n            \"variant\": self.variant,\n            \"fields\": [field.to_dict() for field in self.fields],\n            \"primary_image\": self.primary_image,\n            \"reference_assets\": self.reference_assets,\n            \"extra\": self.extra,\n        }\n\n\ndef _clip_seed(seed: Optional[int]) -> Optional[int]:\n    if seed is None:\n        return None\n    try:\n        iv = int(seed)\n    except Exception:\n        return None\n    if iv < 0:\n        return None\n    if iv > 2147483647:\n        iv = 2147483647\n    return iv\n\n\ndef validate_and_normalize_t2i(p: TextToImageParams) -> Tuple[TextToImageParams, bool, str]:\n    fb = False\n    reasons: List[str] = []\n    # size: 期望形如 WxH，范围 512..4096（兼容 Seedream 4.0 高分辨率）\n    def _valid_size(s: str) -> bool:\n        try:\n            if 'x' not in s:\n                return False\n            w, h = s.split('x', 1)\n            w, h = int(w), int(h)\n            return 512 <= w <= 4096 and 512 <= h <= 4096\n        except Exception:\n            return False\n\n    size = p.size or \"1024x1024\"\n    if not _valid_size(size):\n        fb = True\n        reasons.append(f\"无效尺寸: {p.size or '缺失'}\")\n        size = \"1024x1024\"\n\n    gs = p.guidance_scale\n    if not (1.0 <= gs <= 10.0):\n        fb = True\n        reasons.append(f\"guidance_scale越界: {gs}\")\n        gs = min(10.0, max(1.0, gs)) if isinstance(gs, (int, float)) else 2.5\n\n    seed = _clip_seed(p.seed)\n\n    raw_refs: List[str] = []\n    try:\n        for item in p.reference_images or []:\n            if isinstance(item, str) and item:\n                raw_refs.append(item)\n    except Exception:\n        raw_refs = []\n\n    refs, ref_fb, ref_reason = _normalize_reference_images(raw_refs, expected_outputs=1)\n    if ref_fb:\n        fb = True\n        reasons.append(ref_reason)\n\n    norm = TextToImageParams(\n        prompt=p.prompt,\n        size=size,\n        guidance_scale=gs,\n        seed=seed,\n        reference_images=refs,\n    )\n    return norm, fb, \", \".join(reasons) if fb else \"\"\n\n\ndef _normalize_reference_images(refs: List[str], expected_outputs: int = 1) -> Tuple[List[str], bool, str]:\n    \"\"\"裁剪/校验参考图数量，返回 (normalized_refs, fallback, reason)。\n\n    约束源于官方文档《doubao-seedream-4.0 教程》（行 203-204）：\n    - Seedream 4.0 最多 10 张参考图；\n    - （组图扩展）参考图数量 + 生成图数量 ≤ 15。\n    \"\"\"\n    fb = False\n    reasons: List[str] = []\n    refs = [r for r in refs if isinstance(r, str) and r]\n    # 限制：≤10 张\n    if len(refs) > MAX_REFERENCE_IMAGES:\n        fb = True\n        reasons.append(\n            f\"参考图数量超过 {MAX_REFERENCE_IMAGES}，已自动截取前 {MAX_REFERENCE_IMAGES} 张\"\n        )\n        refs = refs[:MAX_REFERENCE_IMAGES]\n    # 组图扩展：参考图 + 生成图 ≤ 15（当前生成图默认为 expected_outputs）\n    if expected_outputs >= 0 and len(refs) + expected_outputs > MAX_REFERENCE_BUNDLE:\n        allowed = max(0, MAX_REFERENCE_BUNDLE - expected_outputs)\n        if len(refs) > allowed:\n            fb = True\n            reasons.append(\n                f\"参考图与生成量合计超过 {MAX_REFERENCE_BUNDLE}，已截取前 {allowed} 张\"\n            )\n            refs = refs[:allowed]\n    return refs, fb, \", \".join(reasons) if fb else \"\"\n\n\ndef validate_and_normalize_i2i(p: ImageToImageParams) -> Tuple[ImageToImageParams, bool, str]:\n    fb = False\n    reasons: List[str] = []\n    gs = p.guidance_scale\n    if not (1.0 <= gs <= 10.0):\n        fb = True\n        reasons.append(f\"guidance_scale越界: {gs}\")\n        gs = min(10.0, max(1.0, gs)) if isinstance(gs, (int, float)) else 5.5\n    seed = _clip_seed(p.seed)\n    raw_refs: List[str] = []\n    try:\n        for item in p.reference_images or []:\n            if isinstance(item, str) and item:\n                raw_refs.append(item)\n    except Exception:\n        raw_refs = []\n\n    refs, ref_fb, ref_reason = _normalize_reference_images(raw_refs, expected_outputs=1)\n    if ref_fb:\n        fb = True\n        reasons.append(ref_reason)\n\n    norm = ImageToImageParams(\n        prompt=p.prompt,\n        image=p.image,\n        guidance_scale=gs,\n        seed=seed,\n        reference_images=refs,\n    )\n    return norm, fb, \", \".join(reasons) if fb else \"\"\n\n\ndef validate_and_normalize_video(p: VideoParams) -> Tuple[VideoParams, bool, str, str, str]:\n    \"\"\"返回 (normalized, fallback_applied, fallback_reason, used_rs, used_rt)\"\"\"\n    fb = False\n    reasons: List[str] = []\n\n    rs = p.resolution_grade or \"1080p\"\n    rt = p.ratio or \"16:9\"\n    if rs not in RES_GRADES:\n        fb = True\n        reasons.append(f\"无效分辨率: {rs}\")\n        rs = \"1080p\"\n    if rt not in RATIOS:\n        fb = True\n        reasons.append(f\"无效比例: {rt}\")\n        rt = \"16:9\"\n\n    fps = int(p.fps or 24)\n    if fps <= 0:\n        fps = 24\n    dur = int(p.duration or 8)\n    if dur < 3:\n        fb = True\n        reasons.append(\"时长过短(<3s)\")\n        dur = 3\n    if dur > 12:\n        fb = True\n        reasons.append(\"时长过长(>12s)\")\n        dur = 12\n\n    seed = _clip_seed(p.seed)\n    raw_refs: List[str] = []\n    try:\n        for item in p.reference_images or []:\n            if isinstance(item, str) and item:\n                raw_refs.append(item)\n    except Exception:\n        raw_refs = []\n\n    refs, ref_fb, ref_reason = _normalize_reference_images(raw_refs, expected_outputs=1)\n    if ref_fb:\n        fb = True\n        reasons.append(ref_reason)\n\n    norm = VideoParams(\n        prompt=p.prompt,\n        image_path=p.image_path,\n        first_frame_path=p.first_frame_path,\n        last_frame_path=p.last_frame_path,\n        duration=dur,\n        fps=fps,\n        seed=seed,\n        camera_fixed=bool(p.camera_fixed),\n        watermark=bool(p.watermark),\n        resolution_grade=rs,\n        ratio=rt,\n        use_pro_model=bool(p.use_pro_model),\n        reference_images=refs,\n    )\n    return norm, fb, \", \".join(reasons) if fb else \"\", rs, rt\n\n\n# ------------------------------\n# UI Schema 定义（供前端驱动参数面板）\n# ------------------------------\n\n\ndef _schema_key(provider: str, mode: str, variant: str) -> str:\n    return f\"{provider}:{mode}:{variant}\"\n\n\ndef _option(value: Any, label: str, *, description: Optional[str] = None, meta: Optional[Dict[str, Any]] = None) -> UIOption:\n    return UIOption(value=value, label=label, description=description, meta=meta or {})\n\n\ndef _dependency(field: str, *, equals: Any = None, not_equals: Any = None, exists: bool = False) -> UIDependency:\n    return UIDependency(field=field, equals=equals, not_equals=not_equals, exists=exists)\n\n\ndef _build_seedream_schema(variant: str) -> UISchema:\n    variant = variant or \"seedream_v3\"\n    fields: List[UISchemaField] = []\n\n    model_options = [\n        _option(\n            \"seedream_v3\",\n            \"Seedream 3.x\",\n            description=\"稳定版本，支持单图/文生图\",\n            meta={\n                \"t2i_model\": \"doubao-seedream-3-0-t2i-250415\",\n                \"i2i_model\": \"doubao-seededit-3-0-i2i-250628\",\n                \"ui_variant\": \"seedream_v3\",\n            },\n        ),\n        _option(\n            \"seedream_v4\",\n            \"Seedream 4.0\",\n            description=\"多参考图融合，最大10张参考图\",\n            meta={\n                \"t2i_model\": \"doubao-seedream-4-0-250828\",\n                \"i2i_model\": \"doubao-seedream-4-0-250828\",\n                \"ui_variant\": \"seedream_v4\",\n            },\n        ),\n    ]\n    fields.append(\n        UISchemaField(\n            name=\"model_variant\",\n            field_type=\"select\",\n            label=\"模型版本\",\n            default=variant,\n            help_text=\"切换模型将刷新可选参数与上传限制\",\n            options=model_options,\n            extra={\"reload_on_change\": True, \"schema_family\": \"seedream\"},\n        )\n    )\n\n    if variant == \"seedream_v4\":\n        size_options = [\n            # 4K最大尺寸 (Seedream 4.0)\n            _option(\"4096x4096\", \"4096×4096 (1:1) 🔥\"),\n            _option(\"4096x2304\", \"4096×2304 (16:9) 🔥\"),\n            _option(\"2304x4096\", \"2304×4096 (9:16) 🔥\"),\n            \n            # 标准4K尺寸\n            _option(\"3840x2160\", \"3840×2160 (16:9)\"),\n            _option(\"2160x3840\", \"2160×3840 (9:16)\"),\n            _option(\"4096x3072\", \"4096×3072 (4:3)\"),\n            _option(\"3072x4096\", \"3072×4096 (3:4)\"),\n            _option(\"4096x2731\", \"4096×2731 (3:2)\"),\n            _option(\"2731x4096\", \"2731×4096 (2:3)\"),\n            _option(\"4096x1755\", \"4096×1755 (21:9)\"),\n            \n            # 兼容性尺寸\n            _option(\"3072x2048\", \"3072×2048 (3:2)\"),\n            _option(\"2048x3072\", \"2048×3072 (2:3)\"),\n            _option(\"2048x2048\", \"2048×2048 (1:1)\"),\n            _option(\"1920x1080\", \"1920×1080 (16:9)\"),\n            _option(\"1080x1920\", \"1080×1920 (9:16)\"),\n            _option(\"1024x1024\", \"1024×1024 (1:1)\"),\n        ]\n        default_size = \"4096x4096\"\n        # 过滤：移除边长小于 1024 的尺寸项（例如 1512x648），保证 4.0 仅提供大尺寸\n        try:\n            filtered_opts = []\n            for opt in list(size_options):\n                try:\n                    parts = [int(x.strip()) for x in str(opt.value).lower().split('x')]\n                    if len(parts) == 2 and min(parts[0], parts[1]) < 1024:\n                        continue\n                except Exception:\n                    pass\n                filtered_opts.append(opt)\n            size_options = filtered_opts\n        except Exception:\n            pass\n    else:\n        # Seedream 3.x：按常见比例提供范围内的最大像素组合（宽高在 512–2048）\n        size_options = [\n            _option(\"2048x2048\", \"2048×2048 (1:1)\"),\n            _option(\"2048x1536\", \"2048×1536 (4:3)\"),\n            _option(\"1536x2048\", \"1536×2048 (3:4)\"),\n            _option(\"2048x1152\", \"2048×1152 (16:9)\"),\n            _option(\"1152x2048\", \"1152×2048 (9:16)\"),\n            _option(\"1920x1280\", \"1920×1280 (3:2)\"),\n            _option(\"1280x1920\", \"1280×1920 (2:3)\"),\n            _option(\"1792x768\",  \"1792×768 (21:9)\"),\n        ]\n        default_size = \"2048x2048\"\n\n    fields.append(\n        UISchemaField(\n            name=\"size\",\n            field_type=\"select\",\n            label=\"分辨率\",\n            default=default_size,\n            options=size_options,\n            help_text=\"仅提供官方支持的常用分辨率\",\n        )\n    )\n\n    fields.append(\n        UISchemaField(\n            name=\"seed\",\n            field_type=\"spinbox\",\n            label=\"Seed\",\n            default=-1,\n            min_value=-1,\n            max_value=2147483647,\n            help_text=\"-1 表示随机；指定整数可复现结果\",\n        )\n    )\n\n    fields.append(\n        UISchemaField(\n            name=\"count\",\n            field_type=\"spinbox\",\n            label=\"生成数量\",\n            default=1,\n            min_value=1,\n            max_value=10,\n            help_text=\"一次最多生成 10 张\",\n        )\n    )\n\n    # 隐藏\"自动压缩参考图\"参数，后端自动启用\n    # fields.append(\n    #     UISchemaField(\n    #         name=\"auto_compress_references\",\n    #         field_type=\"toggle\",\n    #         label=\"自动压缩参考图\",\n    #         default=True,\n    #         help_text=\"上传时自动压缩到 2K 内，避免超出 API 限制\",\n    #     )\n    # )\n\n    if variant == \"seedream_v4\":\n        reference_enabled = True\n        ref_max_count = MAX_REFERENCE_IMAGES\n        ref_bundle_limit = MAX_REFERENCE_BUNDLE\n        ref_help = \"最多 10 张参考图，参考图 + 输出数量 ≤ 15\"\n        multi_reference = True\n    else:\n        # seedream_v3: 保留旧体验（单张参考图，面板隐藏）\n        reference_enabled = False\n        ref_max_count = 1\n        ref_bundle_limit = 1\n        ref_help = \"最多 1 张参考图\"\n        multi_reference = False\n\n    reference_assets = {\n        \"enabled\": reference_enabled,\n        \"max_count\": ref_max_count,\n        \"bundle_limit\": ref_bundle_limit,\n        \"accept\": [\"image/png\", \"image/jpeg\"],\n        \"auto_compress_field\": \"auto_compress_references\",\n        \"help_text\": ref_help,\n        \"orderable\": True,\n    }\n\n    primary_image = {\n        \"enabled\": True,\n        \"label\": \"基础图 (可选)\",\n        \"placeholder\": \"拖拽或点击上传一张基础图，留空则进行文生图\",\n        \"accept\": [\"image/png\", \"image/jpeg\"],\n        \"max_size_mb\": 10,\n    }\n\n    capabilities = {\n        \"multi_reference\": multi_reference,\n        \"supports_reference\": True,\n        \"single_reference\": not multi_reference,\n    }\n\n    extra = {\n        \"supports_reference\": True,  # 3.x模式也支持参考图显示，只是UI面板隐藏\n        \"layout\": {\n            \"type\": \"rows\",\n            \"row_spacing\": 6,\n            \"column_spacing\": 12,\n            \"rows\": [\n                [\n                    {\"name\": \"model_variant\", \"stretch\": 3, \"label_width\": 70, \"min_width\": 220},\n                    {\"name\": \"size\", \"stretch\": 2, \"label_width\": 70, \"min_width\": 120},\n                    {\"name\": \"seed\", \"stretch\": 1, \"label_width\": 70, \"min_width\": 120},\n                    {\"name\": \"count\", \"stretch\": 1, \"label_width\": 70, \"min_width\": 100},\n                    {\n                        \"name\": \"auto_compress_references\",\n                        \"stretch\": 1,\n                        \"label_width\": 70,\n                    },\n                ],\n            ],\n        },\n        \"capabilities\": capabilities,\n    }\n\n    return UISchema(\n        provider=\"seedream\",\n        mode=\"image\",\n        variant=variant,\n        fields=fields,\n        primary_image=primary_image,\n        reference_assets=reference_assets,\n        extra=extra,\n    )\n\n\ndef _build_seedance_schema(variant: str) -> UISchema:\n    variant = variant or \"seedance_pro\"\n    model_options = [\n        _option(\n            \"seedance_pro\",\n            \"Seedance Pro\",\n            description=\"高质量输出，适合正式素材\",\n            meta={\"use_pro_model\": True, \"ui_variant\": \"seedance_pro\"},\n        ),\n        _option(\n            \"seedance_lite\",\n            \"Seedance Lite\",\n            description=\"快速输出，适合草稿\",\n            meta={\"use_pro_model\": False, \"ui_variant\": \"seedance_lite\"},\n        ),\n    ]\n\n    fields: List[UISchemaField] = [\n        UISchemaField(\n            name=\"model_variant\",\n            field_type=\"select\",\n            label=\"模型\",\n            default=variant,\n            help_text=\"Pro 输出质量更高，Lite 更快速\",\n            options=model_options,\n            extra={\"reload_on_change\": True, \"schema_family\": \"seedance\"},\n        ),\n        UISchemaField(\n            name=\"resolution_grade\",\n            field_type=\"select\",\n            label=\"分辨率档位\",\n            default=\"1080p\",\n            options=[\n                _option(\"480p\", \"480p\"),\n                _option(\"720p\", \"720p\"),\n                _option(\"1080p\", \"1080p\"),\n            ],\n            help_text=\"官方推荐 480p/720p/1080p 三档\",\n        ),\n        UISchemaField(\n            name=\"ratio\",\n            field_type=\"select\",\n            label=\"画面比例\",\n            default=\"16:9\",\n            options=[\n                _option(\"16:9\", \"16:9\"),\n                _option(\"9:16\", \"9:16\"),\n                _option(\"4:3\", \"4:3\"),\n                _option(\"1:1\", \"1:1\"),\n                _option(\"3:4\", \"3:4\"),\n                _option(\"21:9\", \"21:9\"),\n            ],\n            help_text=\"生成时自动拼接 --rs/--rt 参数\",\n        ),\n        UISchemaField(\n            name=\"duration\",\n            field_type=\"select\",\n            label=\"时长 (秒)\",\n            default=5,\n            options=[_option(sec, f\"{sec} 秒\") for sec in range(3, 13)],\n            help_text=\"范围 3-12 秒，超过范围将自动回退\",\n        ),\n        UISchemaField(\n            name=\"seed\",\n            field_type=\"spinbox\",\n            label=\"Seed\",\n            default=-1,\n            min_value=-1,\n            max_value=2147483647,\n            help_text=\"-1 表示随机；指定整数可复现\",\n        ),\n        UISchemaField(\n            name=\"camera_fixed\",\n            field_type=\"toggle\",\n            label=\"固定摄像机\",\n            default=True,\n            help_text=\"开启后相机保持固定，适合稳态镜头\",\n        ),\n    ]\n\n    reference_assets = {\n        \"enabled\": False,\n        \"max_count\": 0,\n        \"bundle_limit\": 0,\n        \"accept\": [],\n        \"auto_compress_field\": None,\n        \"help_text\": \"\",\n        \"orderable\": False,\n    }\n\n    primary_frames = {\n        \"enabled\": True,\n        \"slots\": [\n            {\n                \"name\": \"first_frame\",\n                \"label\": \"首帧 (可选)\",\n                \"help_text\": \"提供首帧可提升人物一致性\",\n                \"accept\": [\"image/png\", \"image/jpeg\"],\n            },\n            {\n                \"name\": \"last_frame\",\n                \"label\": \"尾帧 (可选)\",\n                \"help_text\": \"提供尾帧可控制结尾画面\",\n                \"accept\": [\"image/png\", \"image/jpeg\"],\n            },\n        ],\n        \"max_size_mb\": 10,\n    }\n\n    capabilities = {\n        \"multi_reference\": False,\n        \"supports_reference\": False,\n    }\n\n    extra = {\n        \"use_pro_model\": variant == \"seedance_pro\",\n        \"layout\": {\n            \"type\": \"rows\",\n            \"row_spacing\": 6,\n            \"column_spacing\": 10,\n            \"rows\": [\n                [\n                    {\"name\": \"model_variant\", \"stretch\": 2, \"label_width\": 70, \"min_width\": 160},\n                    {\"name\": \"resolution_grade\", \"stretch\": 2, \"label_width\": 70, \"min_width\": 140},\n                    {\"name\": \"ratio\", \"stretch\": 1, \"label_width\": 70, \"min_width\": 110},\n                    {\"name\": \"duration\", \"stretch\": 1, \"label_width\": 70, \"min_width\": 110},\n                    {\"name\": \"seed\", \"stretch\": 1, \"label_width\": 70, \"min_width\": 120},\n                    {\"name\": \"camera_fixed\", \"stretch\": 1, \"label_width\": 70, \"min_width\": 110},\n                ],\n            ],\n        },\n        \"capabilities\": capabilities,\n    }\n\n    return UISchema(\n        provider=\"seedance\",\n        mode=\"video\",\n        variant=variant,\n        fields=fields,\n        primary_image=primary_frames,\n        reference_assets=reference_assets,\n        extra=extra,\n    )\n\n\n_UI_SCHEMAS: Dict[str, UISchema] = {\n    _schema_key(\"seedream\", \"image\", \"seedream_v3\"): _build_seedream_schema(\"seedream_v3\"),\n    _schema_key(\"seedream\", \"image\", \"seedream_v4\"): _build_seedream_schema(\"seedream_v4\"),\n    _schema_key(\"seedance\", \"video\", \"seedance_pro\"): _build_seedance_schema(\"seedance_pro\"),\n    _schema_key(\"seedance\", \"video\", \"seedance_lite\"): _build_seedance_schema(\"seedance_lite\"),\n}\n\n\n_DEFAULT_VARIANTS: Dict[Tuple[str, str], str] = {\n    (\"seedream\", \"image\"): \"seedream_v3\",\n    (\"seedance\", \"video\"): \"seedance_pro\",\n}\n\n\ndef get_ui_schema(provider: str, mode: str, variant: Optional[str] = None, *, as_dict: bool = False) -> UISchema:\n    \"\"\"返回 UI Schema（深拷贝，避免调用侧修改真源）。\"\"\"\n\n    key_variant = variant or _DEFAULT_VARIANTS.get((provider, mode))\n    if not key_variant:\n        raise ValueError(f\"未定义默认 UI Schema: provider={provider} mode={mode}\")\n\n    key = _schema_key(provider, mode, key_variant)\n    if key not in _UI_SCHEMAS:\n        raise ValueError(f\"未找到 UI Schema: provider={provider} mode={mode} variant={key_variant}\")\n\n    schema = copy.deepcopy(_UI_SCHEMAS[key])\n    if as_dict:\n        return schema.to_dict()  # type: ignore[return-value]\n    return schema\n\n\ndef list_ui_schema_variants(provider: str, mode: str) -> List[str]:\n    prefix = f\"{provider}:{mode}:\"\n    return [key.split(\":\", 2)[-1] for key in _UI_SCHEMAS.keys() if key.startswith(prefix)]\n","numLines":751,"startLine":1,"totalLines":751}}}
{"parentUuid":"a6e81da6-97dd-4087-a5d8-460a2e07516c","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_014woCUjcXsHUcigGs1Bf8bA","type":"message","role":"assistant","content":[{"type":"text","text":"现在搜索 API 调用链和错误处理："}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1802,"cache_creation_input_tokens":10641,"cache_read_input_tokens":51258,"cache_creation":{"ephemeral_5m_input_tokens":10641,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"f86185de-7af9-413f-adb2-ee9e1989e172","timestamp":"2025-11-25T19:09:15.662Z"}
{"parentUuid":"f86185de-7af9-413f-adb2-ee9e1989e172","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_014woCUjcXsHUcigGs1Bf8bA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015fYppwbuQCrGrFqj2cY4dF","name":"Grep","input":{"pattern":"InvalidParameter|must be at most 2048|image sides","type":"py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1802,"cache_creation_input_tokens":10641,"cache_read_input_tokens":51258,"cache_creation":{"ephemeral_5m_input_tokens":10641,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"5f23d4c1-05e9-4e68-b976-69158360dc0f","timestamp":"2025-11-25T19:09:16.213Z"}
{"parentUuid":"5f23d4c1-05e9-4e68-b976-69158360dc0f","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_014woCUjcXsHUcigGs1Bf8bA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NkwhcouhvkT6wQ6Dk1rGEN","name":"Grep","input":{"pattern":"concurrent_generate|batch_text_to_image|width.*height|1024x1024","type":"py","path":"/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1802,"cache_creation_input_tokens":10641,"cache_read_input_tokens":51258,"cache_creation":{"ephemeral_5m_input_tokens":10641,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"fbc03a65-d796-4358-90b0-fe9569981816","timestamp":"2025-11-25T19:09:17.035Z"}
{"parentUuid":"fbc03a65-d796-4358-90b0-fe9569981816","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015fYppwbuQCrGrFqj2cY4dF","type":"tool_result","content":"No files found"}]},"uuid":"fb93b4ca-2b1e-456b-8268-d626f4396f9e","timestamp":"2025-11-25T19:09:17.460Z","toolUseResult":{"mode":"files_with_matches","filenames":[],"numFiles":0,"appliedLimit":20}}
{"parentUuid":"fb93b4ca-2b1e-456b-8268-d626f4396f9e","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NkwhcouhvkT6wQ6Dk1rGEN","type":"tool_result","content":"Found 3 files limit: 20, offset: 0\nmodules/seedream/client.py\nmodules/seedream/__init__.py\nmodules/seedream/manager.py"}]},"uuid":"a78ad2f9-1665-4990-93cf-5c877d29719d","timestamp":"2025-11-25T19:09:17.626Z","toolUseResult":{"mode":"files_with_matches","filenames":["modules/seedream/client.py","modules/seedream/__init__.py","modules/seedream/manager.py"],"numFiles":3,"appliedLimit":20}}
{"parentUuid":"a78ad2f9-1665-4990-93cf-5c877d29719d","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01DAbe6kczfPGVTC7wsSxSBo","type":"message","role":"assistant","content":[{"type":"text","text":"查看batch_text_to_image方法的细节："}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":2209,"cache_read_input_tokens":61899,"cache_creation":{"ephemeral_5m_input_tokens":2209,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"3ae25ec7-ff61-4294-a50e-33cf158ecc79","timestamp":"2025-11-25T19:09:20.440Z"}
{"parentUuid":"3ae25ec7-ff61-4294-a50e-33cf158ecc79","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01DAbe6kczfPGVTC7wsSxSBo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QGk1pHUpe7ja1YFH8vkUku","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/client.py","offset":713,"limit":60}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":2209,"cache_read_input_tokens":61899,"cache_creation":{"ephemeral_5m_input_tokens":2209,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"e5f26689-a8db-4569-b4d0-6301db8fa8f5","timestamp":"2025-11-25T19:09:20.816Z"}
{"parentUuid":"e5f26689-a8db-4569-b4d0-6301db8fa8f5","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01DAbe6kczfPGVTC7wsSxSBo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WxmhByg9bJQswEa7UpGKwW","name":"Grep","input":{"pattern":"text_to_image.*width|text_to_image.*height|batch_text_to_image.*width|client.text_to_image","type":"py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":2209,"cache_read_input_tokens":61899,"cache_creation":{"ephemeral_5m_input_tokens":2209,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"e900ef91-75dc-4e9d-9536-19dd1b38c1a9","timestamp":"2025-11-25T19:09:21.153Z"}
{"parentUuid":"e900ef91-75dc-4e9d-9536-19dd1b38c1a9","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QGk1pHUpe7ja1YFH8vkUku","type":"tool_result","content":"   713→    def batch_text_to_image(\n   714→        self, prompts: List[str], width: int = 1024, height: int = 1024, guidance_scale: float = 2.5\n   715→    ) -> List[Dict[str, Any]]:\n   716→        \"\"\"\n   717→        批量文生图：同时生成多张图片\n   718→\n   719→        Args:\n   720→            prompts: 提示词列表\n   721→            width: 图像宽度\n   722→            height: 图像高度\n   723→            guidance_scale: 提示词一致性\n   724→\n   725→        Returns:\n   726→            List[Dict]: 生成结果列表\n   727→        \"\"\"\n   728→        results = []\n   729→        logger.info(f\"开始批量文生图，共{len(prompts)}个任务\")\n   730→\n   731→        for i, prompt in enumerate(prompts, 1):\n   732→            logger.info(f\"处理第{i}/{len(prompts)}个任务\")\n   733→\n   734→            try:\n   735→                # 为每个任务生成不同的随机种子\n   736→                seed = random.randint(1, 2147483647)\n   737→\n   738→                result = self.text_to_image(\n   739→                    prompt=prompt, \n   740→                    width=width, \n   741→                    height=height, \n   742→                    guidance_scale=guidance_scale, \n   743→                    seed=seed\n   744→                )\n   745→\n   746→                results.append({\n   747→                    \"success\": True,\n   748→                    \"result\": result,\n   749→                    \"prompt\": prompt\n   750→                })\n   751→\n   752→            except Exception as e:\n   753→                # 避免在日志中显示过长的异常信息\n   754→                error_msg = str(e)\n   755→                if len(error_msg) > 200:\n   756→                    error_msg = error_msg[:200] + \"...[错误信息过长，已截断]\"\n   757→                logger.error(f\"第{i}个任务失败: {error_msg}\")\n   758→                results.append({\n   759→                    \"success\": False,\n   760→                    \"error\": error_msg,\n   761→                    \"prompt\": prompt\n   762→                })\n   763→\n   764→            # 避免请求过于频繁\n   765→            if i < len(prompts):\n   766→                time.sleep(0.5)\n   767→\n   768→        success_count = sum(1 for r in results if r[\"success\"])\n   769→        logger.info(f\"批量文生图完成，成功{success_count}/{len(prompts)}个\")\n   770→        return results\n   771→\n   772→    def validate_image_size(self, size: str) -> bool:\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"40f171e7-98d9-4e90-aa0c-bb7b88daedca","timestamp":"2025-11-25T19:09:21.174Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/client.py","content":"    def batch_text_to_image(\n        self, prompts: List[str], width: int = 1024, height: int = 1024, guidance_scale: float = 2.5\n    ) -> List[Dict[str, Any]]:\n        \"\"\"\n        批量文生图：同时生成多张图片\n\n        Args:\n            prompts: 提示词列表\n            width: 图像宽度\n            height: 图像高度\n            guidance_scale: 提示词一致性\n\n        Returns:\n            List[Dict]: 生成结果列表\n        \"\"\"\n        results = []\n        logger.info(f\"开始批量文生图，共{len(prompts)}个任务\")\n\n        for i, prompt in enumerate(prompts, 1):\n            logger.info(f\"处理第{i}/{len(prompts)}个任务\")\n\n            try:\n                # 为每个任务生成不同的随机种子\n                seed = random.randint(1, 2147483647)\n\n                result = self.text_to_image(\n                    prompt=prompt, \n                    width=width, \n                    height=height, \n                    guidance_scale=guidance_scale, \n                    seed=seed\n                )\n\n                results.append({\n                    \"success\": True,\n                    \"result\": result,\n                    \"prompt\": prompt\n                })\n\n            except Exception as e:\n                # 避免在日志中显示过长的异常信息\n                error_msg = str(e)\n                if len(error_msg) > 200:\n                    error_msg = error_msg[:200] + \"...[错误信息过长，已截断]\"\n                logger.error(f\"第{i}个任务失败: {error_msg}\")\n                results.append({\n                    \"success\": False,\n                    \"error\": error_msg,\n                    \"prompt\": prompt\n                })\n\n            # 避免请求过于频繁\n            if i < len(prompts):\n                time.sleep(0.5)\n\n        success_count = sum(1 for r in results if r[\"success\"])\n        logger.info(f\"批量文生图完成，成功{success_count}/{len(prompts)}个\")\n        return results\n\n    def validate_image_size(self, size: str) -> bool:","numLines":60,"startLine":713,"totalLines":829}}}
{"parentUuid":"40f171e7-98d9-4e90-aa0c-bb7b88daedca","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WxmhByg9bJQswEa7UpGKwW","type":"tool_result","content":"Found 3 files limit: 20, offset: 0\nmodules/seedream/manager.py\narchive/imported_sources/modules/seedream/manager.py\narchive/imported_sources/gemeng2-0.7.0/modules/seedream/manager.py"}]},"uuid":"ce7e0153-e667-45d6-b884-fbaaec73306f","timestamp":"2025-11-25T19:09:21.531Z","toolUseResult":{"mode":"files_with_matches","filenames":["modules/seedream/manager.py","archive/imported_sources/modules/seedream/manager.py","archive/imported_sources/gemeng2-0.7.0/modules/seedream/manager.py"],"numFiles":3,"appliedLimit":20}}
{"parentUuid":"ce7e0153-e667-45d6-b884-fbaaec73306f","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_011V92jpFh3ZPuxqdBxqm4jd","type":"message","role":"assistant","content":[{"type":"text","text":"现在查看text_to_image方法的签名："}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1288,"cache_read_input_tokens":64108,"cache_creation":{"ephemeral_5m_input_tokens":1288,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"373e977c-3f7d-40d3-8d84-bafcd9107082","timestamp":"2025-11-25T19:09:24.142Z"}
{"parentUuid":"373e977c-3f7d-40d3-8d84-bafcd9107082","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_011V92jpFh3ZPuxqdBxqm4jd","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TrTFdQ4UsjoptyjQcwR229","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/client.py","offset":443,"limit":80}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1288,"cache_read_input_tokens":64108,"cache_creation":{"ephemeral_5m_input_tokens":1288,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"b4891095-f25c-42c8-81ea-155ea7bcf269","timestamp":"2025-11-25T19:09:24.665Z"}
{"parentUuid":"b4891095-f25c-42c8-81ea-155ea7bcf269","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TrTFdQ4UsjoptyjQcwR229","type":"tool_result","content":"   443→    @error_handler(\"Seedream文生图\")\n   444→    @RetryHandler.retry_on_error(max_retries=3, delay=1.0)\n   445→    def text_to_image(\n   446→        self,\n   447→        prompt: str,\n   448→        size: str = \"1024x1024\",\n   449→        guidance_scale: float = 2.5,\n   450→        seed: Optional[int] = None,\n   451→        reference_images: Optional[List[Any]] = None,\n   452→    ) -> Dict[str, Any]:\n   453→        \"\"\"\n   454→        文生图API调用\n   455→\n   456→        Args:\n   457→            prompt: 图片描述提示词\n   458→            size: 图像尺寸，支持的尺寸见get_supported_sizes()\n   459→            guidance_scale: 引导强度，范围[1.0, 10.0]\n   460→            seed: 随机种子，范围[-1, 2147483647]，-1表示随机\n   461→            reference_images: 参考图列表（路径或URL），最多10张\n   462→            response_format: 返回格式，\"url\"或\"b64_json\"\n   463→\n   464→        Returns:\n   465→            API响应结果\n   466→\n   467→        Raises:\n   468→            AppError: 当API调用失败时\n   469→        \"\"\"\n   470→        headers = self._get_headers()\n   471→\n   472→        logger.info(f\"发送文生图请求: {prompt[:50]}...\")\n   473→\n   474→        if self._provider_enabled():\n   475→            try:\n   476→                from modules.provider.schema import TextToImageParams\n   477→\n   478→                result, data, endpoint_used, provider_used, fallback_applied, fallback_reason, response_time = self._call_seedream_provider(\n   479→                    headers,\n   480→                    lambda provider: provider.map_t2i(TextToImageParams(\n   481→                        prompt=prompt,\n   482→                        size=size,\n   483→                        guidance_scale=guidance_scale,\n   484→                        seed=(None if (seed is None or seed == -1) else seed),\n   485→                        reference_images=reference_images or []\n   486→                    )),\n   487→                    \"text_to_image\"\n   488→                )\n   489→                self._log_seedream_event(\n   490→                    \"text_to_image\",\n   491→                    \"success\",\n   492→                    provider_used,\n   493→                    endpoint_used,\n   494→                    response_time,\n   495→                    fallback_applied,\n   496→                    fallback_reason,\n   497→                    {\"size\": data.get(\"size\"), \"seed\": data.get(\"seed\")},\n   498→                )\n   499→                self._record_request_stats(\"text_to_image\", True, response_time, None, None)\n   500→                return result\n   501→            except Exception as provider_exc:\n   502→                logger.warning(f\"Seedream provider 路径失败，回退旧逻辑: {provider_exc}\")\n   503→\n   504→        success = False\n   505→        err_code: Optional[str] = None\n   506→        err_msg: Optional[str] = None\n   507→        start_time = time.time()\n   508→        try:\n   509→            if not self.validate_image_size(size):\n   510→                raise AppError(f\"不支持的图像尺寸: {size}\", ErrorType.VALIDATION_ERROR)\n   511→            if not (1.0 <= guidance_scale <= 10.0):\n   512→                raise AppError(f\"guidance_scale必须在1.0-10.0范围内，当前值: {guidance_scale}\", ErrorType.VALIDATION_ERROR)\n   513→            if seed is not None and not (-1 <= seed <= 2147483647):\n   514→                raise AppError(f\"seed必须在-1到2147483647范围内，当前值: {seed}\", ErrorType.VALIDATION_ERROR)\n   515→\n   516→            data = {\n   517→                \"model\": \"doubao-seedream-3-0-t2i-250415\",\n   518→                \"prompt\": prompt,\n   519→                \"size\": size,\n   520→                \"response_format\": \"url\",\n   521→                \"watermark\": False,  # 正式版固定禁用水印\n   522→                \"guidance_scale\": guidance_scale,\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d69c391e-6b1a-4208-9e49-0492f0111e85","timestamp":"2025-11-25T19:09:24.745Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/client.py","content":"    @error_handler(\"Seedream文生图\")\n    @RetryHandler.retry_on_error(max_retries=3, delay=1.0)\n    def text_to_image(\n        self,\n        prompt: str,\n        size: str = \"1024x1024\",\n        guidance_scale: float = 2.5,\n        seed: Optional[int] = None,\n        reference_images: Optional[List[Any]] = None,\n    ) -> Dict[str, Any]:\n        \"\"\"\n        文生图API调用\n\n        Args:\n            prompt: 图片描述提示词\n            size: 图像尺寸，支持的尺寸见get_supported_sizes()\n            guidance_scale: 引导强度，范围[1.0, 10.0]\n            seed: 随机种子，范围[-1, 2147483647]，-1表示随机\n            reference_images: 参考图列表（路径或URL），最多10张\n            response_format: 返回格式，\"url\"或\"b64_json\"\n\n        Returns:\n            API响应结果\n\n        Raises:\n            AppError: 当API调用失败时\n        \"\"\"\n        headers = self._get_headers()\n\n        logger.info(f\"发送文生图请求: {prompt[:50]}...\")\n\n        if self._provider_enabled():\n            try:\n                from modules.provider.schema import TextToImageParams\n\n                result, data, endpoint_used, provider_used, fallback_applied, fallback_reason, response_time = self._call_seedream_provider(\n                    headers,\n                    lambda provider: provider.map_t2i(TextToImageParams(\n                        prompt=prompt,\n                        size=size,\n                        guidance_scale=guidance_scale,\n                        seed=(None if (seed is None or seed == -1) else seed),\n                        reference_images=reference_images or []\n                    )),\n                    \"text_to_image\"\n                )\n                self._log_seedream_event(\n                    \"text_to_image\",\n                    \"success\",\n                    provider_used,\n                    endpoint_used,\n                    response_time,\n                    fallback_applied,\n                    fallback_reason,\n                    {\"size\": data.get(\"size\"), \"seed\": data.get(\"seed\")},\n                )\n                self._record_request_stats(\"text_to_image\", True, response_time, None, None)\n                return result\n            except Exception as provider_exc:\n                logger.warning(f\"Seedream provider 路径失败，回退旧逻辑: {provider_exc}\")\n\n        success = False\n        err_code: Optional[str] = None\n        err_msg: Optional[str] = None\n        start_time = time.time()\n        try:\n            if not self.validate_image_size(size):\n                raise AppError(f\"不支持的图像尺寸: {size}\", ErrorType.VALIDATION_ERROR)\n            if not (1.0 <= guidance_scale <= 10.0):\n                raise AppError(f\"guidance_scale必须在1.0-10.0范围内，当前值: {guidance_scale}\", ErrorType.VALIDATION_ERROR)\n            if seed is not None and not (-1 <= seed <= 2147483647):\n                raise AppError(f\"seed必须在-1到2147483647范围内，当前值: {seed}\", ErrorType.VALIDATION_ERROR)\n\n            data = {\n                \"model\": \"doubao-seedream-3-0-t2i-250415\",\n                \"prompt\": prompt,\n                \"size\": size,\n                \"response_format\": \"url\",\n                \"watermark\": False,  # 正式版固定禁用水印\n                \"guidance_scale\": guidance_scale,","numLines":80,"startLine":443,"totalLines":829}}}
{"parentUuid":"d69c391e-6b1a-4208-9e49-0492f0111e85","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"4c3ce3c6-a57f-4db7-97cb-37b9b4a83397","version":"2.0.53","gitBranch":"main","agentId":"ba1d5065","slug":"rustling-wondering-wand","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01N7ypU6i6D2nREzYpdo3GNd","type":"message","role":"assistant","content":[{"type":"text","text":"完美！现在我找到了问题的根源。让我生成完整的分析报告。\n\n## 批量图片生成尺寸超限问题 - 根因分析\n\n我已经完成全面审查，发现了问题的根本原因。以下是详细分析：\n\n### 1. 问题根源概览\n\n**错误信息链路：**\n```\nInvalidParameter: The parameter `size` specified in the request is not valid: \nimage sides must be at most 2048 pixels\n```\n\n**根本原因：** `client.py` 中的 `batch_text_to_image()` 方法使用 **width/height 参数**，但 `text_to_image()` 期望的是 **size 字符串（如 \"1024x1024\"）**，且没有参数转换逻辑。\n\n---\n\n### 2. 尺寸参数完整传递链路\n\n#### 问题代码位置\n\n**文件：** `/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/client.py` (第 713-770 行)\n\n```python\ndef batch_text_to_image(\n    self, \n    prompts: List[str], \n    width: int = 1024,          # <-- width 参数\n    height: int = 1024,         # <-- height 参数\n    guidance_scale: float = 2.5\n) -> List[Dict[str, Any]]:\n    \n    for i, prompt in enumerate(prompts, 1):\n        result = self.text_to_image(\n            prompt=prompt, \n            width=width,           # <-- 错误：传入 width 而非 size\n            height=height,         # <-- 错误：传入 height 而非 size\n            guidance_scale=guidance_scale, \n            seed=seed\n        )\n```\n\n#### 正确的参数签名\n\n**文件：** `/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/client.py` (第 445-452 行)\n\n```python\ndef text_to_image(\n    self,\n    prompt: str,\n    size: str = \"1024x1024\",           # <-- 期望：size 字符串\n    guidance_scale: float = 2.5,\n    seed: Optional[int] = None,\n    reference_images: Optional[List[Any]] = None,\n) -> Dict[str, Any]:\n```\n\n---\n\n### 3. 为什么会发送超过 2048 像素的尺寸\n\n#### 场景分析\n\n假设调用者这样调用 `batch_text_to_image()`：\n\n```python\n# 假设 width=4096, height=2304（用户想要 4K 尺寸）\nmanager.batch_generate_text_to_image(\n    prompts=[...],\n    size=\"4096x2304\"  # Seedream 4.0 支持的尺寸\n)\n```\n\n但实际流程是：\n\n1. **Manager 调用** (manager.py, 第 425-430 行)：\n   ```python\n   self.generate_text_to_image(\n       prompt=prompt,\n       size=size,                      # 正确的 size 字符串\n       guidance_scale=guidance_scale,\n       ...\n   )\n   ```\n\n2. **Manager 调用 Client** (manager.py, 第 156-162 行)：\n   ```python\n   api_result = self.client.text_to_image(\n       prompt=prompt,\n       size=size,                      # size 字符串格式\n       guidance_scale=guidance_scale,\n       ...\n   )\n   ```\n\n3. **Provider 路径** (client.py, 第 475-488 行)：\n   ```python\n   provider.map_t2i(TextToImageParams(\n       prompt=prompt,\n       size=size,                      # 仍然是正确的字符串\n       ...\n   ))\n   ```\n\n4. **Volc V4 Provider 处理** (volc_v4.py, 第 55-61 行)：\n   ```python\n   def map_t2i(self, params: TextToImageParams):\n       norm, fb, reason = self.validate_t2i(params)\n       size_value = _to_v4_size(norm.size)  # 尺寸验证与转换\n       data = {\n           \"model\": \"doubao-seedream-4-0-250828\",\n           \"size\": size_value,\n       }\n   ```\n\n5. **尺寸验证逻辑** (volc_v4.py, 第 10-46 行)：\n   ```python\n   def _to_v4_size(size: str) -> str:\n       # 验证范围：[1024x1024, 4096x4096]\n       if width < 1024 or height < 1024:\n           return \"1024x1024\"\n       elif width > 4096 or height > 4096:\n           return \"4096x4096\"  # 超过 4096 被截断\n       else:\n           return f\"{width}x{height}\"  # 在范围内返回原值\n   ```\n\n---\n\n### 4. 批量并发生成中的问题\n\n**文件：** `/Users/yunchang/Documents/GitHub/gemeng2/modules/seedream/manager.py` (第 440-587 行)\n\n并发方法 `concurrent_generate_text_to_image()` **正确地使用了 size 字符串**：\n\n```python\ndef concurrent_generate_text_to_image(\n    self,\n    prompt: str,\n    count: int = 4,\n    size: str = \"1024x1024\",     # <-- 正确：size 字符串\n    guidance_scale: float = 2.5,\n    ...\n) -> Dict[str, Any]:\n    \n    tasks = []\n    for i in range(count):\n        tasks.append({\n            'prompt': prompt,\n            'size': size,           # <-- 传入正确的 size\n            'guidance_scale': guidance_scale,\n            ...\n        })\n        \n    # 执行任务\n    result = self._execute_single_text_to_image_task(task)\n```\n\n**内部执行** (manager.py, 第 761-778 行)：\n```python\ndef _execute_single_text_to_image_task(self, task: Dict[str, Any]):\n    return self.generate_text_to_image(\n        prompt=task['prompt'],\n        size=task['size'],                  # <-- 正确传入 size\n        guidance_scale=task['guidance_scale'],\n        ...\n    )\n```\n\n---\n\n### 5. UI 层的尺寸选择器\n\n**文件：** `/Users/yunchang/Documents/GitHub/gemeng2/modules/provider/schema.py` (第 363-569 行)\n\nUI Schema 中定义的尺寸选项：\n\n**Seedream 4.0 模式** (第 401-425 行)：\n```python\nif variant == \"seedream_v4\":\n    size_options = [\n        _option(\"4096x4096\", \"4096×4096 (1:1) 🔥\"),\n        _option(\"4096x2304\", \"4096×2304 (16:9) 🔥\"),\n        _option(\"2304x4096\", \"2304×4096 (9:16) 🔥\"),\n        # ... 其他支持的尺寸\n    ]\n    default_size = \"4096x4096\"\n```\n\n**Seedream 3.x 模式** (第 440-452 行)：\n```python\nelse:\n    # Seedream 3.x：最大支持 2048×2048\n    size_options = [\n        _option(\"2048x2048\", \"2048×2048 (1:1)\"),\n        _option(\"2048x1536\", \"2048×1536 (4:3)\"),\n        # ... 不超过 2048 的尺寸\n    ]\n    default_size = \"2048x2048\"\n```\n\n---\n\n### 6. 问题根因总结\n\n**直接根因：**\n\n1. **batch_text_to_image() 方法签名错误** (client.py, 第 713-714 行)\n   - 使用 `width` 和 `height` 分离参数\n   - 但 `text_to_image()` 期望 `size` 字符串（如 \"1024x1024\"）\n   - 没有参数转换逻辑\n\n2. **参数传递断层** (client.py, 第 738-743 行)\n   - 直接将 `width` 和 `height` 传给 `text_to_image()`\n   - 导致 `size` 参数被忽略或错误解析\n\n**深层根因：**\n\n1. **API 接口不一致**\n   - `batch_text_to_image()` 使用 width/height\n   - `text_to_image()` 使用 size 字符串\n   - `concurrent_generate_text_to_image()` 使用 size 字符串\n\n2. **缺少参数验证**\n   - `validate_image_size()` (第 772-795 行) 检查 size 字符串格式\n   - 但 `batch_text_to_image()` 可能传入无效参数\n\n3. **Provider 路径的 4K 支持**\n   - volc_v4.py 支持 4096×4096\n   - 但如果尺寸参数错误，会被截断到 4096×4096\n   - 然后发送时超过 API 的 2048 限制\n\n---\n\n### 7. 修复建议\n\n#### 方案 1：统一使用 size 字符串（推荐）\n\n移除 `batch_text_to_image()` 方法中的 width/height 参数，改用 size：\n\n```python\ndef batch_text_to_image(\n    self, \n    prompts: List[str], \n    size: str = \"1024x1024\",           # <-- 改为 size 字符串\n    guidance_scale: float = 2.5\n) -> List[Dict[str, Any]]:\n    \n    for i, prompt in enumerate(prompts, 1):\n        result = self.text_to_image(\n            prompt=prompt, \n            size=size,                  # <-- 使用 size\n            guidance_scale=guidance_scale, \n            seed=seed\n        )\n```\n\n#### 方案 2：参数转换（临时兼容）\n\n保留 width/height 参数但添加转换逻辑：\n\n```python\ndef batch_text_to_image(\n    self, \n    prompts: List[str], \n    width: int = 1024, \n    height: int = 1024, \n    guidance_scale: float = 2.5\n) -> List[Dict[str, Any]]:\n    \n    # 转换 width/height 为 size 字符串\n    size = f\"{width}x{height}\"\n    \n    for i, prompt in enumerate(prompts, 1):\n        result = self.text_to_image(\n            prompt=prompt, \n            size=size,                  # <-- 使用转换后的 size\n            guidance_scale=guidance_scale, \n            seed=seed\n        )\n```\n\n---\n\n### 8. 验证清单\n\n- [x] `validate_image_size()` 检查 size 字符串格式（512-4096）\n- [x] Provider schema 验证尺寸范围\n- [x] concurrent_generate_text_to_image() **正确使用 size**\n- [x] generate_text_to_image() **正确使用 size**\n- [x] **batch_text_to_image() 参数传递错误** ❌\n- [x] UI 选项列表正确（v3 最大 2048，v4 最大 4096）\n\n---\n\n### 9. 完整参数流链路\n\n```\nUI 选择器 (size: \"4096x4096\")\n    ↓\ngenerate_text_to_image(size=\"4096x4096\") ✓\n    ↓\nclient.text_to_image(size=\"4096x4096\") ✓\n    ↓\nTextToImageParams(size=\"4096x4096\") ✓\n    ↓\nvalidate_and_normalize_t2i() → 检查 512-4096 ✓\n    ↓\nvolc_v4.map_t2i() → _to_v4_size() ✓\n    ↓\nAPI 请求 payload: {\"size\": \"4096x4096\"} ✓\n```\n\n**但批量路径中断：**\n```\nbatch_text_to_image(width=4096, height=2304)\n    ↓\nclient.text_to_image(width=4096, height=2304)  ❌ 参数错误\n    ↓\ntext_to_image() 期望 size，但收到 width/height\n    ↓\n可能导致尺寸解析失败或默认值被使用\n```\n\n---\n\n### 总结\n\n**问题所在：**\n- `batch_text_to_image()` 使用错误的参数格式 (width/height 而非 size 字符串)\n- 导致尺寸参数在传递链中丢失或错误解析\n- 最终可能发送超过 API 限制的尺寸参数\n\n**建议修复：**\n统一所有批量生成方法使用 `size` 字符串参数，与 `text_to_image()` 和 `concurrent_generate_text_to_image()` 保持一致。"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":1412,"cache_read_input_tokens":65396,"cache_creation":{"ephemeral_5m_input_tokens":1412,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"fc255e26-e256-4bb3-8256-138dae0498e3","timestamp":"2025-11-25T19:09:52.573Z"}
