{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","type":"user","message":{"role":"user","content":"用户报告复制提示词按钮和导出选中参考图按钮时不时变成空白/无颜色。\n\n我刚才添加了 SecondaryButton 样式到 style_system.py，并让这些按钮使用 setObjectName(\"SecondaryButton\")。但问题仍然存在。\n\n请检查：\n1. `utils/style_system.py` 中的 `apply_to_widget` 方法如何处理 objectName 样式\n2. `utils/style_system.py` 中 SecondaryButton 样式定义是否正确\n3. QPushButton 样式选择器优先级问题\n4. 是否有其他代码路径可能覆盖按钮样式\n\n重点关注为什么 #SecondaryButton 选择器可能不生效。"},"uuid":"97b4972d-9e62-4d0f-99c6-5c0f23407af0","timestamp":"2025-12-22T04:15:32.079Z"}
{"parentUuid":"97b4972d-9e62-4d0f-99c6-5c0f23407af0","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01UBbjf2i95nT591dZTNNBvH","type":"message","role":"assistant","content":[{"type":"text","text":"我来帮你分析这个问题。让我先读取相关文件，理解样式系统的工作原理。"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":21095,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":21095,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"type":"assistant","uuid":"47bbd1e2-c09d-4b2d-9eb8-cd82f47cd42d","timestamp":"2025-12-22T04:15:36.663Z"}
{"parentUuid":"47bbd1e2-c09d-4b2d-9eb8-cd82f47cd42d","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01UBbjf2i95nT591dZTNNBvH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LiJfKfj5VxRCjRxufeC2Xo","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/utils/style_system.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":21095,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":21095,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"type":"assistant","uuid":"9222c321-e5da-457d-ae63-2a0f499a6bd9","timestamp":"2025-12-22T04:15:37.048Z"}
{"parentUuid":"9222c321-e5da-457d-ae63-2a0f499a6bd9","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01UBbjf2i95nT591dZTNNBvH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01U78jnUQ1sNeRLr7kaepHUR","name":"Glob","input":{"pattern":"**/*button*.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":21095,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":21095,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"type":"assistant","uuid":"9ecfb716-d6bc-4c0f-9f84-af49c550df22","timestamp":"2025-12-22T04:15:37.263Z"}
{"parentUuid":"9ecfb716-d6bc-4c0f-9f84-af49c550df22","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01UBbjf2i95nT591dZTNNBvH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0126aJvqC2sqYbSboM9u8K4o","name":"Glob","input":{"pattern":"components/**/*.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":21095,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":21095,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"type":"assistant","uuid":"f59d390e-48e0-48ae-ad89-1a438980e79a","timestamp":"2025-12-22T04:15:37.398Z"}
{"parentUuid":"f59d390e-48e0-48ae-ad89-1a438980e79a","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0126aJvqC2sqYbSboM9u8K4o","type":"tool_result","content":"/Users/yunchang/Documents/GitHub/gemeng2/components/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/adapters/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/controllers/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/dialogs/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/forms/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/modes/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/base_component.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/first_run_wizard_simple.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/chat_components.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/forms/parameter_form_standard.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/adapters/generation_adapter.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/adapters/reference_adapter.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/controllers/export_bundle_controller.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/clickable_label.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/zoomable_text_edit.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/common_components.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/zoomable_image_label.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/adapters/history_adapter.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/models/video_history_model.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/models/image_history_model.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/layouts/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/views/image_history_view_adapter.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/reference_assets/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/cards/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/creation_components.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/mode_button.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/reference_assets/actions.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/views/image_history_view.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/views/video_history_view.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/reference_images_simple.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/video_image_upload_panel.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/reference_assets_panel.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/toast_manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/reference_assets/gallery.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/main_window.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/delegates/image_card_delegate.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/delegates/video_card_delegate.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/modes/image_mode_widget.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/settings_page.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/forms/schema_form_renderer.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/modes/video_mode_widget.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/image_preview_dialog.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/integrated_reference_panel.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/dialogs/image_detail_dialog.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/dialogs/video_detail_dialog.py"}]},"uuid":"a24310e8-9dfd-4329-86d6-84fea6183b28","timestamp":"2025-12-22T04:15:37.575Z","toolUseResult":{"filenames":["/Users/yunchang/Documents/GitHub/gemeng2/components/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/components/adapters/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/components/controllers/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/components/dialogs/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/components/forms/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/components/modes/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/components/base_component.py","/Users/yunchang/Documents/GitHub/gemeng2/components/first_run_wizard_simple.py","/Users/yunchang/Documents/GitHub/gemeng2/components/chat_components.py","/Users/yunchang/Documents/GitHub/gemeng2/components/forms/parameter_form_standard.py","/Users/yunchang/Documents/GitHub/gemeng2/components/adapters/generation_adapter.py","/Users/yunchang/Documents/GitHub/gemeng2/components/adapters/reference_adapter.py","/Users/yunchang/Documents/GitHub/gemeng2/components/controllers/export_bundle_controller.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/clickable_label.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/zoomable_text_edit.py","/Users/yunchang/Documents/GitHub/gemeng2/components/common_components.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/zoomable_image_label.py","/Users/yunchang/Documents/GitHub/gemeng2/components/adapters/history_adapter.py","/Users/yunchang/Documents/GitHub/gemeng2/components/models/video_history_model.py","/Users/yunchang/Documents/GitHub/gemeng2/components/models/image_history_model.py","/Users/yunchang/Documents/GitHub/gemeng2/components/layouts/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/components/views/image_history_view_adapter.py","/Users/yunchang/Documents/GitHub/gemeng2/components/reference_assets/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/components/cards/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/components/creation_components.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/mode_button.py","/Users/yunchang/Documents/GitHub/gemeng2/components/reference_assets/actions.py","/Users/yunchang/Documents/GitHub/gemeng2/components/views/image_history_view.py","/Users/yunchang/Documents/GitHub/gemeng2/components/views/video_history_view.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/reference_images_simple.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/video_image_upload_panel.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/reference_assets_panel.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/toast_manager.py","/Users/yunchang/Documents/GitHub/gemeng2/components/reference_assets/gallery.py","/Users/yunchang/Documents/GitHub/gemeng2/components/main_window.py","/Users/yunchang/Documents/GitHub/gemeng2/components/delegates/image_card_delegate.py","/Users/yunchang/Documents/GitHub/gemeng2/components/delegates/video_card_delegate.py","/Users/yunchang/Documents/GitHub/gemeng2/components/modes/image_mode_widget.py","/Users/yunchang/Documents/GitHub/gemeng2/components/settings_page.py","/Users/yunchang/Documents/GitHub/gemeng2/components/forms/schema_form_renderer.py","/Users/yunchang/Documents/GitHub/gemeng2/components/modes/video_mode_widget.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/image_preview_dialog.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/integrated_reference_panel.py","/Users/yunchang/Documents/GitHub/gemeng2/components/dialogs/image_detail_dialog.py","/Users/yunchang/Documents/GitHub/gemeng2/components/dialogs/video_detail_dialog.py"],"durationMs":113,"numFiles":46,"truncated":false}}
{"parentUuid":"a24310e8-9dfd-4329-86d6-84fea6183b28","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01U78jnUQ1sNeRLr7kaepHUR","type":"tool_result","content":"/Users/yunchang/Documents/GitHub/gemeng2/.style_backup/components/widgets/mode_button.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/mode_button.py"}]},"uuid":"3202bef1-577a-4756-9a68-0c45917412fa","timestamp":"2025-12-22T04:15:37.577Z","toolUseResult":{"filenames":["/Users/yunchang/Documents/GitHub/gemeng2/.style_backup/components/widgets/mode_button.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/mode_button.py"],"durationMs":115,"numFiles":2,"truncated":false}}
{"parentUuid":"3202bef1-577a-4756-9a68-0c45917412fa","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LiJfKfj5VxRCjRxufeC2Xo","type":"tool_result","content":"     1→\"\"\"统一的样式管理系统 - 增强版\"\"\"\n     2→\n     3→from PySide6.QtWidgets import (\n     4→    QApplication, QWidget, QLabel, QComboBox, QPushButton,\n     5→    QSpinBox, QDoubleSpinBox, QSlider, QCheckBox, QGroupBox,\n     6→    QTextEdit, QLineEdit, QRadioButton, QScrollArea, QProgressBar,\n     7→    QListWidget, QListView, QTableWidget, QTableView, QTreeWidget,\n     8→    QTreeView, QTabWidget, QToolButton, QMenuBar, QMenu, QToolBar\n     9→)\n    10→from PySide6.QtCore import QObject, Signal, Qt\n    11→from PySide6.QtGui import QFont, QPalette, QColor\n    12→from typing import Optional, Dict, Any, Type, List\n    13→import re\n    14→from utils.theme_engine import theme_engine\n    15→\n    16→\n    17→class UnifiedStyleSystem(QObject):\n    18→    \"\"\"统一的样式管理系统 - 增强版\n    19→    \n    20→    负责管理所有UI组件的样式，确保字体大小可以统一缩放\n    21→    支持组件类型自动识别和样式继承\n    22→    \"\"\"\n    23→    \n    24→    styleChanged = Signal()\n    25→    \n    26→    _instance: Optional['UnifiedStyleSystem'] = None\n    27→    \n    28→    def __new__(cls):\n    29→        if cls._instance is None:\n    30→            cls._instance = super().__new__(cls)\n    31→        return cls._instance\n    32→    \n    33→    def __init__(self):\n    34→        # 先调用父类初始化\n    35→        super().__init__()\n    36→        \n    37→        # 检查是否已经初始化（单例模式）\n    38→        if hasattr(self, '_initialized') and self._initialized:\n    39→            return\n    40→            \n    41→        self._initialized = True\n    42→        self._base_font_size = 12\n    43→        self._font_scale = 1.0\n    44→        self._style_cache: Dict[str, str] = {}\n    45→        self._widget_registry: Dict[int, str] = {}  # 记录widget ID到类型的映射\n    46→\n    47→        # 连接主题加载信号，实现解耦\n    48→        theme_engine.themeLoaded.connect(self._on_theme_loaded)\n    49→\n    50→    def _on_theme_loaded(self):\n    51→        \"\"\"主题加载完成后自动刷新样式\"\"\"\n    52→        self.apply_theme()\n    53→        \n    54→        # 组件类型映射表\n    55→        self._widget_type_map = {\n    56→            QLabel: \"QLabel\",\n    57→            QComboBox: \"QComboBox\",\n    58→            QPushButton: \"QPushButton\",\n    59→            QSpinBox: \"QSpinBox\",\n    60→            QDoubleSpinBox: \"QDoubleSpinBox\",\n    61→            QSlider: \"QSlider\",\n    62→            QCheckBox: \"QCheckBox\",\n    63→            QRadioButton: \"QRadioButton\",\n    64→            QGroupBox: \"QGroupBox\",\n    65→            QTextEdit: \"QTextEdit\",\n    66→            QLineEdit: \"QLineEdit\",\n    67→            QScrollArea: \"QScrollArea\",\n    68→            QProgressBar: \"QProgressBar\",\n    69→            QListWidget: \"QListWidget\",\n    70→            QListView: \"QListView\",\n    71→            QTableWidget: \"QTableWidget\",\n    72→            QTableView: \"QTableView\",\n    73→            QTreeWidget: \"QTreeWidget\",\n    74→            QTreeView: \"QTreeView\",\n    75→            QTabWidget: \"QTabWidget\",\n    76→            QToolButton: \"QToolButton\",\n    77→            QMenuBar: \"QMenuBar\",\n    78→            QMenu: \"QMenu\",\n    79→            QToolBar: \"QToolBar\"\n    80→        }\n    81→\n    82→    def identify_widget_type(self, widget: QWidget) -> str:\n    83→        \"\"\"智能识别组件类型\n    84→        \n    85→        优先使用精确类名匹配，避免 isinstance 误判导致子类被识别为父类\n    86→        \"\"\"\n    87→        # 首先检查是否有注册的类型\n    88→        widget_id = id(widget)\n    89→        if widget_id in self._widget_registry:\n    90→            return self._widget_registry[widget_id]\n    91→        \n    92→        # 优先：精确类名匹配（最可靠）\n    93→        class_name = widget.__class__.__name__\n    94→        known_types = {\n    95→            'QSpinBox', 'QDoubleSpinBox', 'QComboBox', 'QLineEdit',\n    96→            'QPushButton', 'QLabel', 'QCheckBox', 'QRadioButton',\n    97→            'QSlider', 'QGroupBox', 'QTextEdit', 'QScrollArea',\n    98→            'QProgressBar', 'QListWidget', 'QListView', 'QTableWidget',\n    99→            'QTableView', 'QTreeWidget', 'QTreeView', 'QTabWidget',\n   100→            'QToolButton', 'QMenuBar', 'QMenu', 'QToolBar'\n   101→        }\n   102→        if class_name in known_types:\n   103→            self._widget_registry[widget_id] = class_name\n   104→            return class_name\n   105→        \n   106→        # 备用：通过类型映射表识别（处理自定义子类）\n   107→        for widget_class, type_name in self._widget_type_map.items():\n   108→            if isinstance(widget, widget_class):\n   109→                self._widget_registry[widget_id] = type_name\n   110→                return type_name\n   111→        \n   112→        # 如果都不匹配，返回类名\n   113→        self._widget_registry[widget_id] = class_name\n   114→        return class_name\n   115→\n   116→    def set_font_scale(self, scale: float):\n   117→        \"\"\"设置字体缩放比例\"\"\"\n   118→        self._font_scale = scale\n   119→        self._style_cache.clear()\n   120→        # 字体缩放属于全局样式变更：立即刷新应用级 QSS + 全窗口样式\n   121→        self.apply_to_application()\n   122→        self.styleChanged.emit()\n   123→        \n   124→    def get_scaled_font_size(self, base_size: int = None) -> int:\n   125→        \"\"\"获取缩放后的字体大小\"\"\"\n   126→        base = base_size or self._base_font_size\n   127→        scaled = int(round(base * self._font_scale))\n   128→        return max(8, scaled)  # 确保最小字体大小为8\n   129→\n   130→    def apply_theme(self):\n   131→        \"\"\"应用当前主题 (Refresh global styles)\"\"\"\n   132→        self._style_cache.clear()\n   133→        # Re-apply styles to all widgets\n   134→        self.apply_to_application()\n   135→        self.styleChanged.emit()\n   136→    \n   137→\n   138→\n   139→    def get_colors(self) -> Dict[str, str]:\n   140→        \"\"\"获取颜色配置 (Delegated to ThemeEngine)\"\"\"\n   141→        return theme_engine.get_palette()\n   142→        \n   143→    def get_widget_style(self, widget_type: str, extra: Dict[str, Any] = None) -> str:\n   144→        \"\"\"获取组件样式\"\"\"\n   145→        cache_key = f\"{widget_type}_{self._font_scale}\"\n   146→        if extra:\n   147→            cache_key += f\"_{hash(str(extra))}\"\n   148→        \n   149→        if cache_key not in self._style_cache:\n   150→            self._style_cache[cache_key] = self._generate_style(widget_type, extra)\n   151→        return self._style_cache[cache_key]\n   152→        \n   153→    def _generate_style(self, widget_type: str, extra: Dict[str, Any] = None) -> str:\n   154→        \"\"\"生成组件样式\"\"\"\n   155→        colors = self.get_colors()\n   156→\n   157→        # 字体大小配置（保持代码内定义，因为这些是设计规范）\n   158→        base_sizes = {\n   159→            'small': 12,     # Secondary text\n   160→            'normal': 14,    # Body text, Inputs\n   161→            'medium': 16,    # Headers, Large Buttons\n   162→            'large': 20,     # Titles\n   163→            'xlarge': 24     # Display\n   164→        }\n   165→\n   166→        # 从 JSON 读取 Layout Metrics（支持配置化）\n   167→        # 如果 JSON 没有定义则使用默认值\n   168→        metrics = {\n   169→            'height_lg': theme_engine.get_value('layout.height_lg', 40),\n   170→            'height_base': theme_engine.get_value('layout.height_base', 32),\n   171→            'radius_lg': theme_engine.get_value('layout.radius_lg', 8),\n   172→            'radius_base': theme_engine.get_value('layout.radius_base', 6),\n   173→            'radius_sm': theme_engine.get_value('layout.radius_sm', 4),\n   174→            'padding_x_lg': theme_engine.get_value('layout.padding_x_lg', 12),\n   175→            'padding_x_base': theme_engine.get_value('layout.padding_x_base', 8),\n   176→            'icon_size': theme_engine.get_value('layout.icon_size', 16)\n   177→        }\n   178→\n   179→        styles = {\n   180→            \"QWidget\": f\"\"\"\n   181→                QWidget {{\n   182→                    font-family: {theme_engine.get_font_family()};\n   183→                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n   184→                    color: {colors['text']};\n   185→                }}\n   186→                /* Global Card Style */\n   187→                QWidget#settingsCard, QFrame[class=\"card\"] {{\n   188→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_card\")};\n   189→                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n   190→                    border-radius: {self.get_scaled_font_size(metrics['radius_lg'])}px;\n   191→                }}\n   192→            \"\"\",\n   193→            \n   194→            \"QLabel\": f\"\"\"\n   195→                QLabel {{\n   196→                    color: {colors['text']};\n   197→                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n   198→                    padding: {self.get_scaled_font_size(2)}px 0;\n   199→                }}\n   200→                QLabel#titleLabel {{\n   201→                    font-size: {self.get_scaled_font_size(base_sizes['xlarge'])}px;\n   202→                    font-weight: 600;\n   203→                    color: {colors['text']};\n   204→                }}\n   205→            \"\"\",\n   206→            \n   207→            \"QComboBox\": f\"\"\"\n   208→                QComboBox {{\n   209→                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n   210→                    padding: 0 {self.get_scaled_font_size(metrics['padding_x_base'])}px;  /* 紧凑 padding，让 AdjustToContents 更精准 */\n   211→                    min-height: {self.get_scaled_font_size(metrics['height_lg'])}px;\n   212→                    min-width: {self.get_scaled_font_size(60)}px;  /* 保底值，确保基本可用性 */\n   213→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n   214→                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n   215→                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n   216→                    color: {colors['text']};\n   217→                }}\n   218→                QComboBox:hover {{\n   219→                    border-color: {theme_engine.get_color(\"palette.neutral.border_strong\")};\n   220→                }}\n   221→                QComboBox:focus, QComboBox:on {{\n   222→                    border-color: {colors['primary']};\n   223→                }}\n   224→                QComboBox::drop-down {{\n   225→                    width: 0;\n   226→                    border: none;\n   227→                    background: transparent;\n   228→                }}\n   229→                QComboBox QAbstractItemView {{\n   230→                    background-color: {colors['surface']};\n   231→                    border: 1px solid {colors['border']};\n   232→                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n   233→                    padding: {self.get_scaled_font_size(4)}px;\n   234→                    color: {colors['text']};\n   235→                    selection-background-color: {theme_engine.get_color(\"palette.brand.subtle\")};\n   236→                    selection-color: {theme_engine.get_color(\"palette.brand.main\")};\n   237→                    outline: none;\n   238→                }}\n   239→                QComboBox QAbstractItemView::item {{\n   240→                    min-height: {self.get_scaled_font_size(metrics['height_lg'])}px;\n   241→                    padding: 0 {self.get_scaled_font_size(metrics['padding_x_lg'])}px;\n   242→                    border-radius: {self.get_scaled_font_size(metrics['radius_sm'])}px;\n   243→                }}\n   244→                QComboBox QAbstractItemView::item:hover {{\n   245→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n   246→                }}\n   247→                QComboBox QAbstractItemView::item:selected {{\n   248→                    background-color: {theme_engine.get_color(\"palette.brand.subtle\")};\n   249→                    color: {theme_engine.get_color(\"palette.brand.main\")};\n   250→                }}\n   251→            \"\"\",\n   252→            \n   253→            \"QPushButton\": f\"\"\"\n   254→                QPushButton {{\n   255→                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n   256→                    font-weight: 500;\n   257→                    padding: 0 {self.get_scaled_font_size(metrics['padding_x_lg'])}px;\n   258→                    min-height: {self.get_scaled_font_size(metrics['height_lg'])}px;\n   259→                    min-width: {self.get_scaled_font_size(60)}px;\n   260→                    border: 1px solid {colors['border']};\n   261→                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n   262→                    color: {colors['text']};\n   263→                    background-color: {colors['surface']};\n   264→                }}\n   265→                \n   266→                QPushButton:hover {{\n   267→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n   268→                    border-color: {theme_engine.get_color(\"palette.neutral.border_strong\")};\n   269→                }}\n   270→\n   271→                QPushButton:pressed {{\n   272→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n   273→                }}\n   274→\n   275→                /* Primary Variant */\n   276→                QPushButton[style_variant=\"primary\"] {{\n   277→                    background-color: {theme_engine.get_color(\"palette.brand.main\")};\n   278→                    border: 1px solid {theme_engine.get_color(\"palette.brand.main\")};\n   279→                    color: {theme_engine.get_color(\"palette.text.on_brand\")};\n   280→                }}\n   281→                QPushButton[style_variant=\"primary\"]:hover {{\n   282→                    background-color: {theme_engine.get_color(\"palette.brand.hover\")};\n   283→                    border-color: {theme_engine.get_color(\"palette.brand.hover\")};\n   284→                }}\n   285→                QPushButton[style_variant=\"primary\"]:pressed {{\n   286→                    background-color: {theme_engine.get_color(\"palette.brand.pressed\")};\n   287→                }}\n   288→\n   289→                /* Secondary Variant */\n   290→                QPushButton[style_variant=\"secondary\"] {{\n   291→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_card\")};\n   292→                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n   293→                    color: {colors['text']};\n   294→                }}\n   295→                QPushButton[style_variant=\"secondary\"]:hover {{\n   296→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n   297→                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_strong\")};\n   298→                }}\n   299→                \n   300→                /* Danger Variant */\n   301→                QPushButton[style_variant=\"danger\"] {{\n   302→                    background-color: {theme_engine.get_color(\"palette.semantic.error\")};\n   303→                    border: 1px solid {theme_engine.get_color(\"palette.semantic.error\")};\n   304→                    color: white;\n   305→                }}\n   306→                QPushButton[style_variant=\"danger\"]:hover {{\n   307→                    background-color: {theme_engine.get_color(\"palette.semantic.error_hover\")};\n   308→                    border-color: {theme_engine.get_color(\"palette.semantic.error_hover\")};\n   309→                }}\n   310→                QPushButton[style_variant=\"danger\"]:pressed {{\n   311→                    background-color: {theme_engine.get_color(\"palette.semantic.error_pressed\")};\n   312→                    border-color: {theme_engine.get_color(\"palette.semantic.error_pressed\")};\n   313→                }}\n   314→                /* Upload Button */\n   315→                QPushButton#uploadButton {{\n   316→                    font-size: {self.get_scaled_font_size(base_sizes['large'])}px;\n   317→                    border: 1px dashed {colors['border']};\n   318→                    background-color: {colors['surface']};\n   319→                    color: {colors['text']};\n   320→                }}\n   321→                QPushButton#uploadButton:hover {{\n   322→                    border-color: {colors['primary']};\n   323→                    color: {colors['primary']};\n   324→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n   325→                }}\n   326→                /* Theme Toggle Buttons - 紧凑尺寸 */\n   327→                QPushButton[role=\"themeToggle\"] {{\n   328→                    min-width: 30px;\n   329→                    min-height: 24px;\n   330→                    padding: 2px 6px;\n   331→                    font-size: {self.get_scaled_font_size(base_sizes['small'])}px;\n   332→                    border-radius: {self.get_scaled_font_size(metrics['radius_sm'])}px;\n   333→                }}\n   334→                QPushButton[role=\"themeToggle\"]:checked {{\n   335→                    background-color: {colors['primary']};\n   336→                    color: {theme_engine.get_color(\"palette.text.on_brand\")};\n   337→                    border-color: {colors['primary']};\n   338→                }}\n   339→                /* Navigation Buttons (for detail dialogs) */\n   340→                QPushButton#NavButton {{\n   341→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_card\")};\n   342→                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n   343→                    border-radius: 15px;\n   344→                    color: {colors['text']};\n   345→                    padding: 0px;\n   346→                    min-width: 30px;\n   347→                    min-height: 30px;\n   348→                }}\n   349→                QPushButton#NavButton:hover {{\n   350→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n   351→                    border-color: {theme_engine.get_color(\"palette.neutral.border_strong\")};\n   352→                }}\n   353→                QPushButton#NavButton:pressed {{\n   354→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n   355→                }}\n   356→                QPushButton#NavButton:disabled {{\n   357→                    color: {theme_engine.get_color(\"palette.text.disabled\")};\n   358→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_panel\")};\n   359→                    border-color: {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n   360→                }}\n   361→                /* Secondary Buttons (copy prompt, export, etc.) */\n   362→                QPushButton#SecondaryButton {{\n   363→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_card\")};\n   364→                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n   365→                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n   366→                    color: {colors['text']};\n   367→                    padding: 0 {self.get_scaled_font_size(metrics['padding_x_base'])}px;\n   368→                    min-height: {self.get_scaled_font_size(metrics['height_base'])}px;\n   369→                }}\n   370→                QPushButton#SecondaryButton:hover {{\n   371→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n   372→                    border-color: {theme_engine.get_color(\"palette.neutral.border_strong\")};\n   373→                }}\n   374→                QPushButton#SecondaryButton:pressed {{\n   375→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n   376→                }}\n   377→            \"\"\",\n   378→            \n   379→            \"QSpinBox\": f\"\"\"\n   380→                QSpinBox {{\n   381→                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n   382→                    padding: 0;\n   383→                    min-height: {self.get_scaled_font_size(metrics['height_lg'])}px;\n   384→                    min-width: {self.get_scaled_font_size(80)}px;\n   385→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n   386→                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n   387→                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n   388→                    color: {colors['text']};\n   389→                }}\n   390→                QSpinBox:hover, QSpinBox:focus {{\n   391→                    border-color: {theme_engine.get_color(\"palette.neutral.border_strong\")};\n   392→                }}\n   393→                QSpinBox::up-button, QSpinBox::down-button {{\n   394→                    background: transparent;\n   395→                    width: {self.get_scaled_font_size(24)}px;\n   396→                    border: none;\n   397→                    margin: 2px;\n   398→                }}\n   399→                QSpinBox::up-button:hover, QSpinBox::down-button:hover {{\n   400→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n   401→                    border-radius: 4px;\n   402→                }}\n   403→            \"\"\",\n   404→            \n   405→            \"QDoubleSpinBox\": f\"\"\"\n   406→                QDoubleSpinBox {{\n   407→                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n   408→                    padding: 0;\n   409→                    min-height: {self.get_scaled_font_size(metrics['height_lg'])}px;\n   410→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n   411→                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n   412→                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n   413→                    color: {colors['text']};\n   414→                }}\n   415→                QDoubleSpinBox::up-button, QDoubleSpinBox::down-button {{\n   416→                    background: transparent;\n   417→                    width: {self.get_scaled_font_size(24)}px;\n   418→                    border: none;\n   419→                    margin: 2px;\n   420→                }}\n   421→                QDoubleSpinBox::up-button:hover, QDoubleSpinBox::down-button:hover {{\n   422→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n   423→                    border-radius: 4px;\n   424→                }}\n   425→            \"\"\",\n   426→            \n   427→            \"QLineEdit\": f\"\"\"\n   428→                QLineEdit {{\n   429→                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n   430→                    padding: 0 {self.get_scaled_font_size(metrics['padding_x_lg'])}px;\n   431→                    min-height: {self.get_scaled_font_size(metrics['height_lg'])}px;\n   432→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n   433→                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n   434→                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n   435→                    color: {colors['text']};\n   436→                    selection-background-color: {theme_engine.get_color(\"palette.brand.main\")};\n   437→                    selection-color: {theme_engine.get_color(\"palette.text.on_brand\")};\n   438→                }}\n   439→                QLineEdit:hover {{\n   440→                    border-color: {theme_engine.get_color(\"palette.neutral.border_strong\")};\n   441→                }}\n   442→                QLineEdit:focus {{\n   443→                    border-color: {colors['primary']};\n   444→                }}\n   445→            \"\"\",\n   446→            \n   447→            \"QTextEdit\": f\"\"\"\n   448→                QTextEdit {{\n   449→                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n   450→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n   451→                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n   452→                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n   453→                    color: {colors['text']};\n   454→                    padding: {self.get_scaled_font_size(metrics['padding_x_lg'])}px;\n   455→                }}\n   456→                QTextEdit:focus {{\n   457→                    border-color: {colors['primary']};\n   458→                }}\n   459→            \"\"\",\n   460→            \n   461→            \"QSlider\": f\"\"\"\n   462→                QSlider::groove:horizontal {{\n   463→                    border: 1px solid {colors['border']};\n   464→                    height: {self.get_scaled_font_size(4)}px;\n   465→                    background: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n   466→                    border-radius: 2px;\n   467→                }}\n   468→                QSlider::handle:horizontal {{\n   469→                    background: {colors['primary']};\n   470→                    width: {self.get_scaled_font_size(16)}px;\n   471→                    margin: -6px 0;\n   472→                    border-radius: 8px;\n   473→                }}\n   474→            \"\"\",\n   475→            \n   476→            \"QProgressBar\": f\"\"\"\n   477→                QProgressBar {{\n   478→                    font-size: {self.get_scaled_font_size(base_sizes['small'])}px;\n   479→                    min-height: {self.get_scaled_font_size(8)}px;\n   480→                    max-height: {self.get_scaled_font_size(8)}px;\n   481→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n   482→                    border-radius: 4px;\n   483→                    border: none;\n   484→                }}\n   485→                QProgressBar::chunk {{\n   486→                    background-color: {colors['primary']};\n   487→                    border-radius: 4px;\n   488→                }}\n   489→            \"\"\",\n   490→            \n   491→            \"QListWidget\": f\"\"\"\n   492→                QListWidget {{\n   493→                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n   494→                    background-color: {colors['surface']};\n   495→                    border: 1px solid {colors['border']};\n   496→                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n   497→                    color: {colors['text']};\n   498→                    outline: none;\n   499→                }}\n   500→                QListWidget::item {{\n   501→                    padding: {self.get_scaled_font_size(8)}px;\n   502→                    border-bottom: 1px solid {colors['border']};\n   503→                }}\n   504→                QListWidget::item:hover {{\n   505→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n   506→                }}\n   507→                QListWidget::item:selected {{\n   508→                    background-color: {theme_engine.get_color(\"palette.brand.subtle\")};\n   509→                    color: {theme_engine.get_color(\"palette.brand.main\")};\n   510→                    border-left: 2px solid {theme_engine.get_color(\"palette.brand.main\")};\n   511→                }}\n   512→            \"\"\",\n   513→            \n   514→            \"QToolButton\": f\"\"\"\n   515→                QToolButton {{\n   516→                    padding: {self.get_scaled_font_size(4)}px;\n   517→                    background-color: transparent;\n   518→                    border: none;\n   519→                    border-radius: {self.get_scaled_font_size(metrics['radius_sm'])}px;\n   520→                    color: {colors['text']};\n   521→                }}\n   522→                QToolButton:hover {{\n   523→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n   524→                }}\n   525→                QToolButton:checked {{\n   526→                    background-color: {theme_engine.get_color(\"palette.brand.subtle\")};\n   527→                    color: {theme_engine.get_color(\"palette.brand.main\")};\n   528→                }}\n   529→            \"\"\"\n   530→        }\n   531→        \n   532→        # 添加对象名称特定的样式\n   533→        if extra and 'objectName' in extra:\n   534→            obj_name = extra['objectName']\n   535→            if widget_type == \"QWidget\" and obj_name == \"parameterGroup\":\n   536→                return self._generate_style(\"QGroupBox\", extra)\n   537→        \n   538→        return styles.get(widget_type, \"\")\n   539→    \n   540→    def apply_to_widget(self, widget: QWidget, widget_type: str = None, recursive: bool = True, extra: Dict[str, Any] = None):\n   541→        \"\"\"应用样式到组件\"\"\"\n   542→        if widget_type is None:\n   543→            widget_type = self.identify_widget_type(widget)\n   544→        \n   545→        # 准备样式参数\n   546→        style_extra = {}\n   547→        \n   548→        # 1. 自动提取 objectName\n   549→        if widget.objectName():\n   550→            style_extra['objectName'] = widget.objectName()\n   551→            \n   552→        # 2. 检查持久化属性 (style_variant, style_extra)\n   553→        # 优先级：传入参数 > 属性 > objectName\n   554→        variant_prop = widget.property('style_variant')\n   555→        extra_prop = widget.property('style_extra')\n   556→        \n   557→        if extra_prop and isinstance(extra_prop, dict):\n   558→            style_extra.update(extra_prop)\n   559→        if variant_prop:\n   560→            style_extra['variant'] = variant_prop\n   561→            \n   562→        # 3. 合并手动传入的参数 (优先级最高，并更新持久化属性)\n   563→        need_polish = False  # 标记是否需要重新polish\n   564→        if extra:\n   565→            style_extra.update(extra)\n   566→            # 如果传入了 extra，保存到属性中以便后续刷新使用\n   567→            if 'variant' in extra:\n   568→                widget.setProperty('style_variant', extra['variant'])\n   569→                need_polish = True  # 设置了动态属性，需要polish\n   570→            # 保存其他 extra 参数\n   571→            other_extras = {k: v for k, v in extra.items() if k != 'variant'}\n   572→            if other_extras:\n   573→                current_extras = widget.property('style_extra') or {}\n   574→                if isinstance(current_extras, dict):\n   575→                    current_extras.update(other_extras)\n   576→                    widget.setProperty('style_extra', current_extras)\n   577→            \n   578→        # 如果没有任何参数，设为 None\n   579→        if not style_extra:\n   580→            style_extra = None\n   581→        \n   582→        style = self.get_widget_style(widget_type, style_extra)\n   583→        if style:\n   584→            # 对于表单控件，直接替换样式（避免继承冲突）\n   585→            # 其他控件保留原有非字体样式并放在前面（新样式优先）\n   586→            form_controls = ('QSpinBox', 'QDoubleSpinBox', 'QComboBox', 'QLineEdit')\n   587→            if widget_type in form_controls:\n   588→                # 表单控件：直接使用新样式，不合并旧样式\n   589→                widget.setStyleSheet(style)\n   590→            else:\n   591→                current_style = widget.styleSheet()\n   592→                if current_style:\n   593→                    # 移除原有的字体相关样式\n   594→                    current_style = self.remove_font_styles(current_style)\n   595→                    # 合并：旧样式在前，新样式在后（新样式优先级更高）\n   596→                    if current_style.strip():\n   597→                        style = f\"{current_style}\\n{style}\"\n   598→                \n   599→                widget.setStyleSheet(style)\n   600→\n   601→        # 如果设置了动态属性（如 style_variant），需要强制 Qt 重新评估样式选择器\n   602→        if need_polish:\n   603→            widget.style().unpolish(widget)\n   604→            widget.style().polish(widget)\n   605→\n   606→        # 设置字体\n   607→        font = widget.font()\n   608→        base_size = self._get_base_font_size_for_widget(widget_type, widget.objectName())\n   609→        font.setPointSize(self.get_scaled_font_size(base_size))\n   610→        widget.setFont(font)\n   611→        \n   612→        # 递归应用到子组件 - 修复递归逻辑\n   613→        if recursive:\n   614→            # 标记已处理的组件，避免重复处理\n   615→            if not hasattr(self, '_processed_widgets'):\n   616→                self._processed_widgets = set()\n   617→            \n   618→            widget_id = id(widget)\n   619→            if widget_id in self._processed_widgets:\n   620→                return\n   621→            self._processed_widgets.add(widget_id)\n   622→            \n   623→            try:\n   624→                for child in widget.findChildren(QWidget):\n   625→                    child_id = id(child)\n   626→                    # 只处理直接子组件，避免重复处理\n   627→                    if child_id not in self._processed_widgets and child.parent() == widget:\n   628→                        # 跳过表单控件的内部子组件，防止样式覆盖\n   629→                        # QComboBox/QSpinBox/QDoubleSpinBox 内部的 QLineEdit 不应单独应用样式\n   630→                        parent_widget = child.parent()\n   631→                        if parent_widget and isinstance(parent_widget, (QComboBox, QSpinBox, QDoubleSpinBox)):\n   632→                            # 标记为已处理但不应用样式\n   633→                            self._processed_widgets.add(child_id)\n   634→                            continue\n   635→                        self.apply_to_widget(child, recursive=True)\n   636→            finally:\n   637→                # 清理处理标记（在顶层调用结束时）\n   638→                if hasattr(self, '_processed_widgets'):\n   639→                    self._processed_widgets.discard(widget_id)\n   640→    \n   641→    def _get_base_font_size_for_widget(self, widget_type: str, object_name: str = \"\") -> int:\n   642→        \"\"\"根据组件类型和对象名称获取基础字体大小\"\"\"\n   643→        # 特殊对象名称的字体大小\n   644→        special_sizes = {\n   645→            'moduleTitle': 16,\n   646→            'paramLabel': 13,\n   647→            'fieldLabel': 13,\n   648→            'generateButton': 13,\n   649→            'uploadButton': 14,\n   650→            'historyPromptLabel': 14,\n   651→            'historyInfoLabel': 12\n   652→        }\n   653→        \n   654→        if object_name in special_sizes:\n   655→            return special_sizes[object_name]\n   656→        \n   657→        # 组件类型的默认字体大小\n   658→        type_sizes = {\n   659→            'QGroupBox': 13,\n   660→            'QPushButton': 12,\n   661→            'QLabel': 12,\n   662→            'QComboBox': 12,\n   663→            'QSpinBox': 12,\n   664→            'QTextEdit': 12,\n   665→            'QLineEdit': 12\n   666→        }\n   667→        \n   668→        return type_sizes.get(widget_type, 12)\n   669→    \n   670→    def scale_stylesheet_fonts(self, stylesheet: str) -> str:\n   671→        \"\"\"缩放样式表中的字体大小\"\"\"\n   672→        if not stylesheet:\n   673→            return stylesheet\n   674→        \n   675→        def replace_font_size(match):\n   676→            size_str = match.group(1)\n   677→            try:\n   678→                size = int(size_str)\n   679→                new_size = self.get_scaled_font_size(size)\n   680→                return f\"font-size: {new_size}px\"\n   681→            except ValueError:\n   682→                return match.group(0)\n   683→        \n   684→        # 匹配 font-size: XXpx 模式\n   685→        pattern = r'font-size:\\s*(\\d+)px'\n   686→        return re.sub(pattern, replace_font_size, stylesheet)\n   687→    \n   688→    def remove_font_styles(self, stylesheet: str) -> str:\n   689→        \"\"\"从样式表中移除字体相关样式\"\"\"\n   690→        if not stylesheet:\n   691→            return stylesheet\n   692→            \n   693→        # 移除 font-size 声明\n   694→        stylesheet = re.sub(r'font-size:\\s*\\d+px;?', '', stylesheet)\n   695→        # 移除 font-weight 声明\n   696→        stylesheet = re.sub(r'font-weight:\\s*\\w+;?', '', stylesheet)\n   697→        # 移除 font-family 声明\n   698→        stylesheet = re.sub(r'font-family:\\s*[^;]+;?', '', stylesheet)\n   699→        # 移除 font 简写声明\n   700→        stylesheet = re.sub(r'font:\\s*[^;]+;?', '', stylesheet)\n   701→        \n   702→        # 清理多余的空格、分号和空规则\n   703→        stylesheet = re.sub(r'\\s*;\\s*;', ';', stylesheet)\n   704→        stylesheet = re.sub(r'{\\s*}', '', stylesheet)\n   705→        stylesheet = re.sub(r'\\n\\s*\\n', '\\n', stylesheet)\n   706→        \n   707→        return stylesheet.strip()\n   708→    \n   709→    def apply_to_application(self):\n   710→        \"\"\"应用到整个应用程序\"\"\"\n   711→        app = QApplication.instance()\n   712→        if not app:\n   713→            return\n   714→        \n   715→        # 清理组件处理标记\n   716→        if hasattr(self, '_processed_widgets'):\n   717→            self._processed_widgets.clear()\n   718→        \n   719→        # 设置应用程序字体\n   720→        font = app.font()\n   721→        font.setPointSize(self.get_scaled_font_size())\n   722→        app.setFont(font)\n   723→\n   724→        # 同步应用级 QPalette（尤其是 QComboBox 弹出列表等更依赖 Palette 的控件）\n   725→        try:\n   726→            bg_app = theme_engine.get_qcolor(\"palette.neutral.bg_app\")\n   727→            bg_panel = theme_engine.get_qcolor(\"palette.neutral.bg_panel\")\n   728→            bg_card = theme_engine.get_qcolor(\"palette.neutral.bg_card\")\n   729→            text_primary = theme_engine.get_qcolor(\"palette.text.primary\")\n   730→            text_on_brand = theme_engine.get_qcolor(\"palette.text.on_brand\")\n   731→            brand = theme_engine.get_qcolor(\"palette.brand.main\")\n   732→\n   733→            palette = app.palette() or QPalette()\n   734→            palette.setColor(QPalette.Window, bg_app)\n   735→            palette.setColor(QPalette.WindowText, text_primary)\n   736→            palette.setColor(QPalette.Base, bg_card)\n   737→            palette.setColor(QPalette.AlternateBase, bg_panel)\n   738→            palette.setColor(QPalette.Text, text_primary)\n   739→            palette.setColor(QPalette.Button, bg_card)\n   740→            palette.setColor(QPalette.ButtonText, text_primary)\n   741→            palette.setColor(QPalette.ToolTipBase, bg_panel)\n   742→            palette.setColor(QPalette.ToolTipText, text_primary)\n   743→            palette.setColor(QPalette.Highlight, brand)\n   744→            palette.setColor(QPalette.HighlightedText, text_on_brand)\n   745→            app.setPalette(palette)\n   746→        except Exception:\n   747→            pass\n   748→        \n   749→        # 应用全局样式表 (基础控件 + 滚动条等)\n   750→        app.setStyleSheet(self._get_global_style())\n   751→\n   752→        # 将样式刷新应用到所有顶层窗口（确保主题切换后所有页面/对话框一起更新）\n   753→        for window in app.topLevelWidgets():\n   754→            try:\n   755→                self.apply_to_widget(window)\n   756→            except Exception:\n   757→                # 避免单个窗口异常阻断全局刷新\n   758→                continue\n   759→\n   760→        # 清理处理标记（避免后续调用被污染）\n   761→        if hasattr(self, '_processed_widgets'):\n   762→            self._processed_widgets.clear()\n   763→        \n   764→    def _get_global_style(self) -> str:\n   765→        \"\"\"获取全局样式（应用级 QSS）\"\"\"\n   766→        # Core tokens (Linear)\n   767→        bg_app = theme_engine.get_color(\"palette.neutral.bg_app\")\n   768→        bg_panel = theme_engine.get_color(\"palette.neutral.bg_panel\")\n   769→        bg_card = theme_engine.get_color(\"palette.neutral.bg_card\")\n   770→        bg_hover = theme_engine.get_color(\"palette.neutral.bg_hover\")\n   771→        bg_sidebar = theme_engine.get_color(\"palette.neutral.bg_sidebar\")\n   772→        bg_input = theme_engine.get_color(\"palette.neutral.bg_input\")\n   773→\n   774→        border_subtle = theme_engine.get_color(\"palette.neutral.border_subtle\")\n   775→        border_strong = theme_engine.get_color(\"palette.neutral.border_strong\")\n   776→        border_sidebar = theme_engine.get_color(\"palette.neutral.border_sidebar\")\n   777→\n   778→        text_primary = theme_engine.get_color(\"palette.text.primary\")\n   779→        text_secondary = theme_engine.get_color(\"palette.text.secondary\")\n   780→        text_disabled = theme_engine.get_color(\"palette.text.disabled\")\n   781→        text_on_brand = theme_engine.get_color(\"palette.text.on_brand\")\n   782→\n   783→        brand = theme_engine.get_color(\"palette.brand.main\")\n   784→        brand_hover = theme_engine.get_color(\"palette.brand.hover\")\n   785→        brand_subtle = theme_engine.get_color(\"palette.brand.subtle\")\n   786→        overlay_dark = theme_engine.get_color(\"palette.overlay.dark\")\n   787→\n   788→        # Semantic tokens (for toasts, states)\n   789→        semantic_success = theme_engine.get_color(\"palette.semantic.success\")\n   790→        semantic_warning = theme_engine.get_color(\"palette.semantic.warning\")\n   791→        semantic_error = theme_engine.get_color(\"palette.semantic.error\")\n   792→        semantic_info = theme_engine.get_color(\"palette.semantic.info\")\n   793→\n   794→        # Scrollbar tokens\n   795→        bg = theme_engine.get_color(\"palette.scrollbar.bg\")\n   796→        handle = theme_engine.get_color(\"palette.scrollbar.handle\")\n   797→        handle_hover = theme_engine.get_color(\"palette.scrollbar.handle_hover\")\n   798→\n   799→        width = self.get_scaled_font_size(12)\n   800→        radius = width // 2\n   801→\n   802→        # 基础：清理 Qt 默认 focus outline，避免“绿色边框/蓝色点”\n   803→        base = f\"\"\"\n   804→            QWidget {{\n   805→                color: {text_primary};\n   806→                font-family: {theme_engine.get_font_family()};\n   807→            }}\n   808→\n   809→            QMainWindow, QDialog {{\n   810→                background-color: {bg_app};\n   811→            }}\n   812→\n   813→            QStackedWidget {{\n   814→                background-color: transparent;\n   815→                border: none;\n   816→            }}\n   817→\n   818→            QWidget#Sidebar {{\n   819→                background-color: {bg_sidebar};\n   820→                border: none;\n   821→            }}\n   822→\n   823→            /* Core surfaces for existing layout (top history / bottom params) */\n   824→            QWidget#HistoryPanel {{\n   825→                background-color: {bg_panel};\n   826→                border: 1px solid {border_subtle};\n   827→                border-radius: 12px;\n   828→            }}\n   829→            QWidget#ParamPanel {{\n   830→                background-color: {bg_panel};\n   831→                border: 1px solid {border_subtle};\n   832→                border-radius: 12px;\n   833→            }}\n   834→            QWidget#settingsCard {{\n   835→                background-color: {bg_card};\n   836→                border: 1px solid {border_subtle};\n   837→                border-radius: 12px;\n   838→            }}\n   839→\n   840→            /* Settings typography */\n   841→            QLabel#sectionTitle {{\n   842→                color: {text_primary};\n   843→                font-size: {self.get_scaled_font_size(14)}px;\n   844→                font-weight: 600;\n   845→            }}\n   846→            QLabel#infoLabel {{\n   847→                color: {text_secondary};\n   848→            }}\n   849→\n   850→            /* Toast (ephemeral overlay label) */\n   851→            QLabel#Toast {{\n   852→                background-color: {overlay_dark};\n   853→                color: {text_on_brand};\n   854→                border: 1px solid {border_subtle};\n   855→                border-radius: {self.get_scaled_font_size(18)}px;\n   856→                padding: {self.get_scaled_font_size(10)}px {self.get_scaled_font_size(16)}px;\n   857→            }}\n   858→            QLabel#Toast[toastType=\"info\"] {{\n   859→                background-color: {semantic_info};\n   860→            }}\n   861→            QLabel#Toast[toastType=\"success\"] {{\n   862→                background-color: {semantic_success};\n   863→            }}\n   864→            QLabel#Toast[toastType=\"warning\"] {{\n   865→                background-color: {semantic_warning};\n   866→            }}\n   867→            QLabel#Toast[toastType=\"error\"] {{\n   868→                background-color: {semantic_error};\n   869→            }}\n   870→\n   871→            /* List views are painted by delegates; keep container clean */\n   872→            QListView {{\n   873→                background-color: transparent;\n   874→                border: none;\n   875→                outline: none;\n   876→            }}\n   877→            QListView::item:selected, QListView::item:hover {{\n   878→                background-color: transparent;\n   879→            }}\n   880→\n   881→            /* Splitter handle (Eagle style: transparent, visible on hover) */\n   882→            QSplitter::handle:vertical {{\n   883→                background-color: transparent;\n   884→                height: 4px;\n   885→            }}\n   886→            QSplitter::handle:vertical:hover {{\n   887→                background-color: {border_subtle};\n   888→            }}\n   889→            QSplitter::handle:horizontal {{\n   890→                background-color: transparent;\n   891→                width: 4px;\n   892→            }}\n   893→            QSplitter::handle:horizontal:hover {{\n   894→                background-color: {border_subtle};\n   895→            }}\n   896→\n   897→            QScrollArea {{\n   898→                background-color: transparent;\n   899→                border: none;\n   900→            }}\n   901→\n   902→            QStatusBar {{\n   903→                background-color: {bg_panel};\n   904→                color: {text_secondary};\n   905→                border-top: 1px solid {border_subtle};\n   906→            }}\n   907→\n   908→            QToolTip {{\n   909→                background-color: {bg_card};\n   910→                color: {text_primary};\n   911→                border: 1px solid {border_subtle};\n   912→                border-radius: 8px;\n   913→                padding: 6px 8px;\n   914→            }}\n   915→\n   916→            QMenu {{\n   917→                background-color: {bg_card};\n   918→                color: {text_primary};\n   919→                border: 1px solid {border_strong};\n   920→                border-radius: 10px;\n   921→                padding: 6px;\n   922→            }}\n   923→            QMenu::item {{\n   924→                padding: 8px 10px;\n   925→                border-radius: 8px;\n   926→            }}\n   927→            QMenu::item:selected {{\n   928→                background-color: {bg_hover};\n   929→            }}\n   930→\n   931→            /* Theme toggle (keep existing widget count; style as segmented) */\n   932→            QFrame#ThemeToggle {{\n   933→                background-color: {bg_panel};\n   934→                border: 1px solid {border_subtle};\n   935→                border-radius: 10px;\n   936→            }}\n   937→            QPushButton[role=\"themeToggle\"] {{\n   938→                background-color: transparent;\n   939→                border: none;\n   940→                color: {text_disabled};\n   941→                padding: 0px;\n   942→                min-width: 0px;\n   943→                min-height: 0px;\n   944→            }}\n   945→            QPushButton[role=\"themeToggle\"]:hover {{\n   946→                background-color: {bg_hover};\n   947→                color: {text_primary};\n   948→            }}\n   949→            QPushButton[role=\"themeToggle\"]:checked {{\n   950→                background-color: {brand_subtle};\n   951→                color: {brand};\n   952→            }}\n   953→            QPushButton[role=\"themeToggle\"]:checked:hover {{\n   954→                background-color: {brand_subtle};\n   955→                color: {brand_hover};\n   956→            }}\n   957→\n   958→            /* Navigation buttons (for detail dialogs) */\n   959→            QPushButton#NavButton {{\n   960→                background-color: {bg_card};\n   961→                border: 1px solid {border_subtle};\n   962→                border-radius: 15px;\n   963→                color: {text_primary};\n   964→                padding: 0px;\n   965→                min-width: 30px;\n   966→                min-height: 30px;\n   967→            }}\n   968→            QPushButton#NavButton:hover {{\n   969→                background-color: {bg_hover};\n   970→                border-color: {border_strong};\n   971→            }}\n   972→            QPushButton#NavButton:pressed {{\n   973→                background-color: {bg_input};\n   974→            }}\n   975→            QPushButton#NavButton:disabled {{\n   976→                color: {text_disabled};\n   977→                background-color: {bg_panel};\n   978→                border-color: {border_subtle};\n   979→            }}\n   980→\n   981→            /* Play button (for video dialogs) */\n   982→            QPushButton#PlayButton {{\n   983→                background-color: {brand};\n   984→                border: none;\n   985→                border-radius: 15px;\n   986→                color: {text_on_brand};\n   987→                font-size: 14px;\n   988→            }}\n   989→            QPushButton#PlayButton:hover {{\n   990→                background-color: {brand_hover};\n   991→            }}\n   992→\n   993→            /* Default input surface fallback (components may override via apply_to_widget) */\n   994→            QLineEdit, QTextEdit {{\n   995→                background-color: {bg_input};\n   996→                border: 1px solid {border_subtle};\n   997→                border-radius: 8px;\n   998→                padding: 8px 10px;\n   999→                selection-background-color: {brand};\n  1000→                selection-color: {text_on_brand};\n  1001→            }}\n  1002→            QLineEdit:focus, QTextEdit:focus {{\n  1003→                border-color: {brand};\n  1004→            }}\n  1005→\n  1006→            *:focus {{\n  1007→                outline: none;\n  1008→            }}\n  1009→\n  1010→            /* Overlay helper (for dialogs/toasts) */\n  1011→            QWidget[role=\"overlay\"] {{\n  1012→                background-color: {overlay_dark};\n  1013→            }}\n  1014→        \"\"\"\n  1015→\n  1016→        scrollbar = f\"\"\"\n  1017→            QScrollBar:vertical {{\n  1018→                border: none;\n  1019→                background: {bg};\n  1020→                width: {width}px;\n  1021→                margin: 0px 0px 0px 0px;\n  1022→                border-radius: {radius}px;\n  1023→            }}\n  1024→            QScrollBar::handle:vertical {{\n  1025→                background: {handle};\n  1026→                min-height: 20px;\n  1027→                border-radius: {radius}px;\n  1028→                margin: 2px;\n  1029→            }}\n  1030→            QScrollBar::handle:vertical:hover {{\n  1031→                background: {handle_hover};\n  1032→            }}\n  1033→            QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical {{\n  1034→                border: none;\n  1035→                background: none;\n  1036→                height: 0px;\n  1037→            }}\n  1038→            QScrollBar::add-page:vertical, QScrollBar::sub-page:vertical {{\n  1039→                background: none;\n  1040→            }}\n  1041→            \n  1042→            QScrollBar:horizontal {{\n  1043→                border: none;\n  1044→                background: {bg};\n  1045→                height: {width}px;\n  1046→                margin: 0px 0px 0px 0px;\n  1047→                border-radius: {radius}px;\n  1048→            }}\n  1049→            QScrollBar::handle:horizontal {{\n  1050→                background: {handle};\n  1051→                min-width: 20px;\n  1052→                border-radius: {radius}px;\n  1053→                margin: 2px;\n  1054→            }}\n  1055→            QScrollBar::handle:horizontal:hover {{\n  1056→                background: {handle_hover};\n  1057→            }}\n  1058→            QScrollBar::add-line:horizontal, QScrollBar::sub-line:horizontal {{\n  1059→                border: none;\n  1060→                background: none;\n  1061→                width: 0px;\n  1062→            }}\n  1063→            QScrollBar::add-page:horizontal, QScrollBar::sub-page:horizontal {{\n  1064→                background: none;\n  1065→            }}\n  1066→        \"\"\"\n  1067→\n  1068→        return f\"{base}\\n{scrollbar}\"\n  1069→\n  1070→\n  1071→# 全局样式系统实例\n  1072→unified_style_system = UnifiedStyleSystem()\n  1073→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"3951839e-6156-4592-8f9e-4b4995df2894","timestamp":"2025-12-22T04:15:38.881Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/utils/style_system.py","content":"\"\"\"统一的样式管理系统 - 增强版\"\"\"\n\nfrom PySide6.QtWidgets import (\n    QApplication, QWidget, QLabel, QComboBox, QPushButton,\n    QSpinBox, QDoubleSpinBox, QSlider, QCheckBox, QGroupBox,\n    QTextEdit, QLineEdit, QRadioButton, QScrollArea, QProgressBar,\n    QListWidget, QListView, QTableWidget, QTableView, QTreeWidget,\n    QTreeView, QTabWidget, QToolButton, QMenuBar, QMenu, QToolBar\n)\nfrom PySide6.QtCore import QObject, Signal, Qt\nfrom PySide6.QtGui import QFont, QPalette, QColor\nfrom typing import Optional, Dict, Any, Type, List\nimport re\nfrom utils.theme_engine import theme_engine\n\n\nclass UnifiedStyleSystem(QObject):\n    \"\"\"统一的样式管理系统 - 增强版\n    \n    负责管理所有UI组件的样式，确保字体大小可以统一缩放\n    支持组件类型自动识别和样式继承\n    \"\"\"\n    \n    styleChanged = Signal()\n    \n    _instance: Optional['UnifiedStyleSystem'] = None\n    \n    def __new__(cls):\n        if cls._instance is None:\n            cls._instance = super().__new__(cls)\n        return cls._instance\n    \n    def __init__(self):\n        # 先调用父类初始化\n        super().__init__()\n        \n        # 检查是否已经初始化（单例模式）\n        if hasattr(self, '_initialized') and self._initialized:\n            return\n            \n        self._initialized = True\n        self._base_font_size = 12\n        self._font_scale = 1.0\n        self._style_cache: Dict[str, str] = {}\n        self._widget_registry: Dict[int, str] = {}  # 记录widget ID到类型的映射\n\n        # 连接主题加载信号，实现解耦\n        theme_engine.themeLoaded.connect(self._on_theme_loaded)\n\n    def _on_theme_loaded(self):\n        \"\"\"主题加载完成后自动刷新样式\"\"\"\n        self.apply_theme()\n        \n        # 组件类型映射表\n        self._widget_type_map = {\n            QLabel: \"QLabel\",\n            QComboBox: \"QComboBox\",\n            QPushButton: \"QPushButton\",\n            QSpinBox: \"QSpinBox\",\n            QDoubleSpinBox: \"QDoubleSpinBox\",\n            QSlider: \"QSlider\",\n            QCheckBox: \"QCheckBox\",\n            QRadioButton: \"QRadioButton\",\n            QGroupBox: \"QGroupBox\",\n            QTextEdit: \"QTextEdit\",\n            QLineEdit: \"QLineEdit\",\n            QScrollArea: \"QScrollArea\",\n            QProgressBar: \"QProgressBar\",\n            QListWidget: \"QListWidget\",\n            QListView: \"QListView\",\n            QTableWidget: \"QTableWidget\",\n            QTableView: \"QTableView\",\n            QTreeWidget: \"QTreeWidget\",\n            QTreeView: \"QTreeView\",\n            QTabWidget: \"QTabWidget\",\n            QToolButton: \"QToolButton\",\n            QMenuBar: \"QMenuBar\",\n            QMenu: \"QMenu\",\n            QToolBar: \"QToolBar\"\n        }\n\n    def identify_widget_type(self, widget: QWidget) -> str:\n        \"\"\"智能识别组件类型\n        \n        优先使用精确类名匹配，避免 isinstance 误判导致子类被识别为父类\n        \"\"\"\n        # 首先检查是否有注册的类型\n        widget_id = id(widget)\n        if widget_id in self._widget_registry:\n            return self._widget_registry[widget_id]\n        \n        # 优先：精确类名匹配（最可靠）\n        class_name = widget.__class__.__name__\n        known_types = {\n            'QSpinBox', 'QDoubleSpinBox', 'QComboBox', 'QLineEdit',\n            'QPushButton', 'QLabel', 'QCheckBox', 'QRadioButton',\n            'QSlider', 'QGroupBox', 'QTextEdit', 'QScrollArea',\n            'QProgressBar', 'QListWidget', 'QListView', 'QTableWidget',\n            'QTableView', 'QTreeWidget', 'QTreeView', 'QTabWidget',\n            'QToolButton', 'QMenuBar', 'QMenu', 'QToolBar'\n        }\n        if class_name in known_types:\n            self._widget_registry[widget_id] = class_name\n            return class_name\n        \n        # 备用：通过类型映射表识别（处理自定义子类）\n        for widget_class, type_name in self._widget_type_map.items():\n            if isinstance(widget, widget_class):\n                self._widget_registry[widget_id] = type_name\n                return type_name\n        \n        # 如果都不匹配，返回类名\n        self._widget_registry[widget_id] = class_name\n        return class_name\n\n    def set_font_scale(self, scale: float):\n        \"\"\"设置字体缩放比例\"\"\"\n        self._font_scale = scale\n        self._style_cache.clear()\n        # 字体缩放属于全局样式变更：立即刷新应用级 QSS + 全窗口样式\n        self.apply_to_application()\n        self.styleChanged.emit()\n        \n    def get_scaled_font_size(self, base_size: int = None) -> int:\n        \"\"\"获取缩放后的字体大小\"\"\"\n        base = base_size or self._base_font_size\n        scaled = int(round(base * self._font_scale))\n        return max(8, scaled)  # 确保最小字体大小为8\n\n    def apply_theme(self):\n        \"\"\"应用当前主题 (Refresh global styles)\"\"\"\n        self._style_cache.clear()\n        # Re-apply styles to all widgets\n        self.apply_to_application()\n        self.styleChanged.emit()\n    \n\n\n    def get_colors(self) -> Dict[str, str]:\n        \"\"\"获取颜色配置 (Delegated to ThemeEngine)\"\"\"\n        return theme_engine.get_palette()\n        \n    def get_widget_style(self, widget_type: str, extra: Dict[str, Any] = None) -> str:\n        \"\"\"获取组件样式\"\"\"\n        cache_key = f\"{widget_type}_{self._font_scale}\"\n        if extra:\n            cache_key += f\"_{hash(str(extra))}\"\n        \n        if cache_key not in self._style_cache:\n            self._style_cache[cache_key] = self._generate_style(widget_type, extra)\n        return self._style_cache[cache_key]\n        \n    def _generate_style(self, widget_type: str, extra: Dict[str, Any] = None) -> str:\n        \"\"\"生成组件样式\"\"\"\n        colors = self.get_colors()\n\n        # 字体大小配置（保持代码内定义，因为这些是设计规范）\n        base_sizes = {\n            'small': 12,     # Secondary text\n            'normal': 14,    # Body text, Inputs\n            'medium': 16,    # Headers, Large Buttons\n            'large': 20,     # Titles\n            'xlarge': 24     # Display\n        }\n\n        # 从 JSON 读取 Layout Metrics（支持配置化）\n        # 如果 JSON 没有定义则使用默认值\n        metrics = {\n            'height_lg': theme_engine.get_value('layout.height_lg', 40),\n            'height_base': theme_engine.get_value('layout.height_base', 32),\n            'radius_lg': theme_engine.get_value('layout.radius_lg', 8),\n            'radius_base': theme_engine.get_value('layout.radius_base', 6),\n            'radius_sm': theme_engine.get_value('layout.radius_sm', 4),\n            'padding_x_lg': theme_engine.get_value('layout.padding_x_lg', 12),\n            'padding_x_base': theme_engine.get_value('layout.padding_x_base', 8),\n            'icon_size': theme_engine.get_value('layout.icon_size', 16)\n        }\n\n        styles = {\n            \"QWidget\": f\"\"\"\n                QWidget {{\n                    font-family: {theme_engine.get_font_family()};\n                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n                    color: {colors['text']};\n                }}\n                /* Global Card Style */\n                QWidget#settingsCard, QFrame[class=\"card\"] {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_card\")};\n                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n                    border-radius: {self.get_scaled_font_size(metrics['radius_lg'])}px;\n                }}\n            \"\"\",\n            \n            \"QLabel\": f\"\"\"\n                QLabel {{\n                    color: {colors['text']};\n                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n                    padding: {self.get_scaled_font_size(2)}px 0;\n                }}\n                QLabel#titleLabel {{\n                    font-size: {self.get_scaled_font_size(base_sizes['xlarge'])}px;\n                    font-weight: 600;\n                    color: {colors['text']};\n                }}\n            \"\"\",\n            \n            \"QComboBox\": f\"\"\"\n                QComboBox {{\n                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n                    padding: 0 {self.get_scaled_font_size(metrics['padding_x_base'])}px;  /* 紧凑 padding，让 AdjustToContents 更精准 */\n                    min-height: {self.get_scaled_font_size(metrics['height_lg'])}px;\n                    min-width: {self.get_scaled_font_size(60)}px;  /* 保底值，确保基本可用性 */\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n                    color: {colors['text']};\n                }}\n                QComboBox:hover {{\n                    border-color: {theme_engine.get_color(\"palette.neutral.border_strong\")};\n                }}\n                QComboBox:focus, QComboBox:on {{\n                    border-color: {colors['primary']};\n                }}\n                QComboBox::drop-down {{\n                    width: 0;\n                    border: none;\n                    background: transparent;\n                }}\n                QComboBox QAbstractItemView {{\n                    background-color: {colors['surface']};\n                    border: 1px solid {colors['border']};\n                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n                    padding: {self.get_scaled_font_size(4)}px;\n                    color: {colors['text']};\n                    selection-background-color: {theme_engine.get_color(\"palette.brand.subtle\")};\n                    selection-color: {theme_engine.get_color(\"palette.brand.main\")};\n                    outline: none;\n                }}\n                QComboBox QAbstractItemView::item {{\n                    min-height: {self.get_scaled_font_size(metrics['height_lg'])}px;\n                    padding: 0 {self.get_scaled_font_size(metrics['padding_x_lg'])}px;\n                    border-radius: {self.get_scaled_font_size(metrics['radius_sm'])}px;\n                }}\n                QComboBox QAbstractItemView::item:hover {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n                }}\n                QComboBox QAbstractItemView::item:selected {{\n                    background-color: {theme_engine.get_color(\"palette.brand.subtle\")};\n                    color: {theme_engine.get_color(\"palette.brand.main\")};\n                }}\n            \"\"\",\n            \n            \"QPushButton\": f\"\"\"\n                QPushButton {{\n                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n                    font-weight: 500;\n                    padding: 0 {self.get_scaled_font_size(metrics['padding_x_lg'])}px;\n                    min-height: {self.get_scaled_font_size(metrics['height_lg'])}px;\n                    min-width: {self.get_scaled_font_size(60)}px;\n                    border: 1px solid {colors['border']};\n                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n                    color: {colors['text']};\n                    background-color: {colors['surface']};\n                }}\n                \n                QPushButton:hover {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n                    border-color: {theme_engine.get_color(\"palette.neutral.border_strong\")};\n                }}\n\n                QPushButton:pressed {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n                }}\n\n                /* Primary Variant */\n                QPushButton[style_variant=\"primary\"] {{\n                    background-color: {theme_engine.get_color(\"palette.brand.main\")};\n                    border: 1px solid {theme_engine.get_color(\"palette.brand.main\")};\n                    color: {theme_engine.get_color(\"palette.text.on_brand\")};\n                }}\n                QPushButton[style_variant=\"primary\"]:hover {{\n                    background-color: {theme_engine.get_color(\"palette.brand.hover\")};\n                    border-color: {theme_engine.get_color(\"palette.brand.hover\")};\n                }}\n                QPushButton[style_variant=\"primary\"]:pressed {{\n                    background-color: {theme_engine.get_color(\"palette.brand.pressed\")};\n                }}\n\n                /* Secondary Variant */\n                QPushButton[style_variant=\"secondary\"] {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_card\")};\n                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n                    color: {colors['text']};\n                }}\n                QPushButton[style_variant=\"secondary\"]:hover {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_strong\")};\n                }}\n                \n                /* Danger Variant */\n                QPushButton[style_variant=\"danger\"] {{\n                    background-color: {theme_engine.get_color(\"palette.semantic.error\")};\n                    border: 1px solid {theme_engine.get_color(\"palette.semantic.error\")};\n                    color: white;\n                }}\n                QPushButton[style_variant=\"danger\"]:hover {{\n                    background-color: {theme_engine.get_color(\"palette.semantic.error_hover\")};\n                    border-color: {theme_engine.get_color(\"palette.semantic.error_hover\")};\n                }}\n                QPushButton[style_variant=\"danger\"]:pressed {{\n                    background-color: {theme_engine.get_color(\"palette.semantic.error_pressed\")};\n                    border-color: {theme_engine.get_color(\"palette.semantic.error_pressed\")};\n                }}\n                /* Upload Button */\n                QPushButton#uploadButton {{\n                    font-size: {self.get_scaled_font_size(base_sizes['large'])}px;\n                    border: 1px dashed {colors['border']};\n                    background-color: {colors['surface']};\n                    color: {colors['text']};\n                }}\n                QPushButton#uploadButton:hover {{\n                    border-color: {colors['primary']};\n                    color: {colors['primary']};\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n                }}\n                /* Theme Toggle Buttons - 紧凑尺寸 */\n                QPushButton[role=\"themeToggle\"] {{\n                    min-width: 30px;\n                    min-height: 24px;\n                    padding: 2px 6px;\n                    font-size: {self.get_scaled_font_size(base_sizes['small'])}px;\n                    border-radius: {self.get_scaled_font_size(metrics['radius_sm'])}px;\n                }}\n                QPushButton[role=\"themeToggle\"]:checked {{\n                    background-color: {colors['primary']};\n                    color: {theme_engine.get_color(\"palette.text.on_brand\")};\n                    border-color: {colors['primary']};\n                }}\n                /* Navigation Buttons (for detail dialogs) */\n                QPushButton#NavButton {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_card\")};\n                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n                    border-radius: 15px;\n                    color: {colors['text']};\n                    padding: 0px;\n                    min-width: 30px;\n                    min-height: 30px;\n                }}\n                QPushButton#NavButton:hover {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n                    border-color: {theme_engine.get_color(\"palette.neutral.border_strong\")};\n                }}\n                QPushButton#NavButton:pressed {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n                }}\n                QPushButton#NavButton:disabled {{\n                    color: {theme_engine.get_color(\"palette.text.disabled\")};\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_panel\")};\n                    border-color: {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n                }}\n                /* Secondary Buttons (copy prompt, export, etc.) */\n                QPushButton#SecondaryButton {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_card\")};\n                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n                    color: {colors['text']};\n                    padding: 0 {self.get_scaled_font_size(metrics['padding_x_base'])}px;\n                    min-height: {self.get_scaled_font_size(metrics['height_base'])}px;\n                }}\n                QPushButton#SecondaryButton:hover {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n                    border-color: {theme_engine.get_color(\"palette.neutral.border_strong\")};\n                }}\n                QPushButton#SecondaryButton:pressed {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n                }}\n            \"\"\",\n            \n            \"QSpinBox\": f\"\"\"\n                QSpinBox {{\n                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n                    padding: 0;\n                    min-height: {self.get_scaled_font_size(metrics['height_lg'])}px;\n                    min-width: {self.get_scaled_font_size(80)}px;\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n                    color: {colors['text']};\n                }}\n                QSpinBox:hover, QSpinBox:focus {{\n                    border-color: {theme_engine.get_color(\"palette.neutral.border_strong\")};\n                }}\n                QSpinBox::up-button, QSpinBox::down-button {{\n                    background: transparent;\n                    width: {self.get_scaled_font_size(24)}px;\n                    border: none;\n                    margin: 2px;\n                }}\n                QSpinBox::up-button:hover, QSpinBox::down-button:hover {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n                    border-radius: 4px;\n                }}\n            \"\"\",\n            \n            \"QDoubleSpinBox\": f\"\"\"\n                QDoubleSpinBox {{\n                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n                    padding: 0;\n                    min-height: {self.get_scaled_font_size(metrics['height_lg'])}px;\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n                    color: {colors['text']};\n                }}\n                QDoubleSpinBox::up-button, QDoubleSpinBox::down-button {{\n                    background: transparent;\n                    width: {self.get_scaled_font_size(24)}px;\n                    border: none;\n                    margin: 2px;\n                }}\n                QDoubleSpinBox::up-button:hover, QDoubleSpinBox::down-button:hover {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n                    border-radius: 4px;\n                }}\n            \"\"\",\n            \n            \"QLineEdit\": f\"\"\"\n                QLineEdit {{\n                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n                    padding: 0 {self.get_scaled_font_size(metrics['padding_x_lg'])}px;\n                    min-height: {self.get_scaled_font_size(metrics['height_lg'])}px;\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n                    color: {colors['text']};\n                    selection-background-color: {theme_engine.get_color(\"palette.brand.main\")};\n                    selection-color: {theme_engine.get_color(\"palette.text.on_brand\")};\n                }}\n                QLineEdit:hover {{\n                    border-color: {theme_engine.get_color(\"palette.neutral.border_strong\")};\n                }}\n                QLineEdit:focus {{\n                    border-color: {colors['primary']};\n                }}\n            \"\"\",\n            \n            \"QTextEdit\": f\"\"\"\n                QTextEdit {{\n                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n                    color: {colors['text']};\n                    padding: {self.get_scaled_font_size(metrics['padding_x_lg'])}px;\n                }}\n                QTextEdit:focus {{\n                    border-color: {colors['primary']};\n                }}\n            \"\"\",\n            \n            \"QSlider\": f\"\"\"\n                QSlider::groove:horizontal {{\n                    border: 1px solid {colors['border']};\n                    height: {self.get_scaled_font_size(4)}px;\n                    background: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n                    border-radius: 2px;\n                }}\n                QSlider::handle:horizontal {{\n                    background: {colors['primary']};\n                    width: {self.get_scaled_font_size(16)}px;\n                    margin: -6px 0;\n                    border-radius: 8px;\n                }}\n            \"\"\",\n            \n            \"QProgressBar\": f\"\"\"\n                QProgressBar {{\n                    font-size: {self.get_scaled_font_size(base_sizes['small'])}px;\n                    min-height: {self.get_scaled_font_size(8)}px;\n                    max-height: {self.get_scaled_font_size(8)}px;\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_input\")};\n                    border-radius: 4px;\n                    border: none;\n                }}\n                QProgressBar::chunk {{\n                    background-color: {colors['primary']};\n                    border-radius: 4px;\n                }}\n            \"\"\",\n            \n            \"QListWidget\": f\"\"\"\n                QListWidget {{\n                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n                    background-color: {colors['surface']};\n                    border: 1px solid {colors['border']};\n                    border-radius: {self.get_scaled_font_size(metrics['radius_base'])}px;\n                    color: {colors['text']};\n                    outline: none;\n                }}\n                QListWidget::item {{\n                    padding: {self.get_scaled_font_size(8)}px;\n                    border-bottom: 1px solid {colors['border']};\n                }}\n                QListWidget::item:hover {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n                }}\n                QListWidget::item:selected {{\n                    background-color: {theme_engine.get_color(\"palette.brand.subtle\")};\n                    color: {theme_engine.get_color(\"palette.brand.main\")};\n                    border-left: 2px solid {theme_engine.get_color(\"palette.brand.main\")};\n                }}\n            \"\"\",\n            \n            \"QToolButton\": f\"\"\"\n                QToolButton {{\n                    padding: {self.get_scaled_font_size(4)}px;\n                    background-color: transparent;\n                    border: none;\n                    border-radius: {self.get_scaled_font_size(metrics['radius_sm'])}px;\n                    color: {colors['text']};\n                }}\n                QToolButton:hover {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_hover\")};\n                }}\n                QToolButton:checked {{\n                    background-color: {theme_engine.get_color(\"palette.brand.subtle\")};\n                    color: {theme_engine.get_color(\"palette.brand.main\")};\n                }}\n            \"\"\"\n        }\n        \n        # 添加对象名称特定的样式\n        if extra and 'objectName' in extra:\n            obj_name = extra['objectName']\n            if widget_type == \"QWidget\" and obj_name == \"parameterGroup\":\n                return self._generate_style(\"QGroupBox\", extra)\n        \n        return styles.get(widget_type, \"\")\n    \n    def apply_to_widget(self, widget: QWidget, widget_type: str = None, recursive: bool = True, extra: Dict[str, Any] = None):\n        \"\"\"应用样式到组件\"\"\"\n        if widget_type is None:\n            widget_type = self.identify_widget_type(widget)\n        \n        # 准备样式参数\n        style_extra = {}\n        \n        # 1. 自动提取 objectName\n        if widget.objectName():\n            style_extra['objectName'] = widget.objectName()\n            \n        # 2. 检查持久化属性 (style_variant, style_extra)\n        # 优先级：传入参数 > 属性 > objectName\n        variant_prop = widget.property('style_variant')\n        extra_prop = widget.property('style_extra')\n        \n        if extra_prop and isinstance(extra_prop, dict):\n            style_extra.update(extra_prop)\n        if variant_prop:\n            style_extra['variant'] = variant_prop\n            \n        # 3. 合并手动传入的参数 (优先级最高，并更新持久化属性)\n        need_polish = False  # 标记是否需要重新polish\n        if extra:\n            style_extra.update(extra)\n            # 如果传入了 extra，保存到属性中以便后续刷新使用\n            if 'variant' in extra:\n                widget.setProperty('style_variant', extra['variant'])\n                need_polish = True  # 设置了动态属性，需要polish\n            # 保存其他 extra 参数\n            other_extras = {k: v for k, v in extra.items() if k != 'variant'}\n            if other_extras:\n                current_extras = widget.property('style_extra') or {}\n                if isinstance(current_extras, dict):\n                    current_extras.update(other_extras)\n                    widget.setProperty('style_extra', current_extras)\n            \n        # 如果没有任何参数，设为 None\n        if not style_extra:\n            style_extra = None\n        \n        style = self.get_widget_style(widget_type, style_extra)\n        if style:\n            # 对于表单控件，直接替换样式（避免继承冲突）\n            # 其他控件保留原有非字体样式并放在前面（新样式优先）\n            form_controls = ('QSpinBox', 'QDoubleSpinBox', 'QComboBox', 'QLineEdit')\n            if widget_type in form_controls:\n                # 表单控件：直接使用新样式，不合并旧样式\n                widget.setStyleSheet(style)\n            else:\n                current_style = widget.styleSheet()\n                if current_style:\n                    # 移除原有的字体相关样式\n                    current_style = self.remove_font_styles(current_style)\n                    # 合并：旧样式在前，新样式在后（新样式优先级更高）\n                    if current_style.strip():\n                        style = f\"{current_style}\\n{style}\"\n                \n                widget.setStyleSheet(style)\n\n        # 如果设置了动态属性（如 style_variant），需要强制 Qt 重新评估样式选择器\n        if need_polish:\n            widget.style().unpolish(widget)\n            widget.style().polish(widget)\n\n        # 设置字体\n        font = widget.font()\n        base_size = self._get_base_font_size_for_widget(widget_type, widget.objectName())\n        font.setPointSize(self.get_scaled_font_size(base_size))\n        widget.setFont(font)\n        \n        # 递归应用到子组件 - 修复递归逻辑\n        if recursive:\n            # 标记已处理的组件，避免重复处理\n            if not hasattr(self, '_processed_widgets'):\n                self._processed_widgets = set()\n            \n            widget_id = id(widget)\n            if widget_id in self._processed_widgets:\n                return\n            self._processed_widgets.add(widget_id)\n            \n            try:\n                for child in widget.findChildren(QWidget):\n                    child_id = id(child)\n                    # 只处理直接子组件，避免重复处理\n                    if child_id not in self._processed_widgets and child.parent() == widget:\n                        # 跳过表单控件的内部子组件，防止样式覆盖\n                        # QComboBox/QSpinBox/QDoubleSpinBox 内部的 QLineEdit 不应单独应用样式\n                        parent_widget = child.parent()\n                        if parent_widget and isinstance(parent_widget, (QComboBox, QSpinBox, QDoubleSpinBox)):\n                            # 标记为已处理但不应用样式\n                            self._processed_widgets.add(child_id)\n                            continue\n                        self.apply_to_widget(child, recursive=True)\n            finally:\n                # 清理处理标记（在顶层调用结束时）\n                if hasattr(self, '_processed_widgets'):\n                    self._processed_widgets.discard(widget_id)\n    \n    def _get_base_font_size_for_widget(self, widget_type: str, object_name: str = \"\") -> int:\n        \"\"\"根据组件类型和对象名称获取基础字体大小\"\"\"\n        # 特殊对象名称的字体大小\n        special_sizes = {\n            'moduleTitle': 16,\n            'paramLabel': 13,\n            'fieldLabel': 13,\n            'generateButton': 13,\n            'uploadButton': 14,\n            'historyPromptLabel': 14,\n            'historyInfoLabel': 12\n        }\n        \n        if object_name in special_sizes:\n            return special_sizes[object_name]\n        \n        # 组件类型的默认字体大小\n        type_sizes = {\n            'QGroupBox': 13,\n            'QPushButton': 12,\n            'QLabel': 12,\n            'QComboBox': 12,\n            'QSpinBox': 12,\n            'QTextEdit': 12,\n            'QLineEdit': 12\n        }\n        \n        return type_sizes.get(widget_type, 12)\n    \n    def scale_stylesheet_fonts(self, stylesheet: str) -> str:\n        \"\"\"缩放样式表中的字体大小\"\"\"\n        if not stylesheet:\n            return stylesheet\n        \n        def replace_font_size(match):\n            size_str = match.group(1)\n            try:\n                size = int(size_str)\n                new_size = self.get_scaled_font_size(size)\n                return f\"font-size: {new_size}px\"\n            except ValueError:\n                return match.group(0)\n        \n        # 匹配 font-size: XXpx 模式\n        pattern = r'font-size:\\s*(\\d+)px'\n        return re.sub(pattern, replace_font_size, stylesheet)\n    \n    def remove_font_styles(self, stylesheet: str) -> str:\n        \"\"\"从样式表中移除字体相关样式\"\"\"\n        if not stylesheet:\n            return stylesheet\n            \n        # 移除 font-size 声明\n        stylesheet = re.sub(r'font-size:\\s*\\d+px;?', '', stylesheet)\n        # 移除 font-weight 声明\n        stylesheet = re.sub(r'font-weight:\\s*\\w+;?', '', stylesheet)\n        # 移除 font-family 声明\n        stylesheet = re.sub(r'font-family:\\s*[^;]+;?', '', stylesheet)\n        # 移除 font 简写声明\n        stylesheet = re.sub(r'font:\\s*[^;]+;?', '', stylesheet)\n        \n        # 清理多余的空格、分号和空规则\n        stylesheet = re.sub(r'\\s*;\\s*;', ';', stylesheet)\n        stylesheet = re.sub(r'{\\s*}', '', stylesheet)\n        stylesheet = re.sub(r'\\n\\s*\\n', '\\n', stylesheet)\n        \n        return stylesheet.strip()\n    \n    def apply_to_application(self):\n        \"\"\"应用到整个应用程序\"\"\"\n        app = QApplication.instance()\n        if not app:\n            return\n        \n        # 清理组件处理标记\n        if hasattr(self, '_processed_widgets'):\n            self._processed_widgets.clear()\n        \n        # 设置应用程序字体\n        font = app.font()\n        font.setPointSize(self.get_scaled_font_size())\n        app.setFont(font)\n\n        # 同步应用级 QPalette（尤其是 QComboBox 弹出列表等更依赖 Palette 的控件）\n        try:\n            bg_app = theme_engine.get_qcolor(\"palette.neutral.bg_app\")\n            bg_panel = theme_engine.get_qcolor(\"palette.neutral.bg_panel\")\n            bg_card = theme_engine.get_qcolor(\"palette.neutral.bg_card\")\n            text_primary = theme_engine.get_qcolor(\"palette.text.primary\")\n            text_on_brand = theme_engine.get_qcolor(\"palette.text.on_brand\")\n            brand = theme_engine.get_qcolor(\"palette.brand.main\")\n\n            palette = app.palette() or QPalette()\n            palette.setColor(QPalette.Window, bg_app)\n            palette.setColor(QPalette.WindowText, text_primary)\n            palette.setColor(QPalette.Base, bg_card)\n            palette.setColor(QPalette.AlternateBase, bg_panel)\n            palette.setColor(QPalette.Text, text_primary)\n            palette.setColor(QPalette.Button, bg_card)\n            palette.setColor(QPalette.ButtonText, text_primary)\n            palette.setColor(QPalette.ToolTipBase, bg_panel)\n            palette.setColor(QPalette.ToolTipText, text_primary)\n            palette.setColor(QPalette.Highlight, brand)\n            palette.setColor(QPalette.HighlightedText, text_on_brand)\n            app.setPalette(palette)\n        except Exception:\n            pass\n        \n        # 应用全局样式表 (基础控件 + 滚动条等)\n        app.setStyleSheet(self._get_global_style())\n\n        # 将样式刷新应用到所有顶层窗口（确保主题切换后所有页面/对话框一起更新）\n        for window in app.topLevelWidgets():\n            try:\n                self.apply_to_widget(window)\n            except Exception:\n                # 避免单个窗口异常阻断全局刷新\n                continue\n\n        # 清理处理标记（避免后续调用被污染）\n        if hasattr(self, '_processed_widgets'):\n            self._processed_widgets.clear()\n        \n    def _get_global_style(self) -> str:\n        \"\"\"获取全局样式（应用级 QSS）\"\"\"\n        # Core tokens (Linear)\n        bg_app = theme_engine.get_color(\"palette.neutral.bg_app\")\n        bg_panel = theme_engine.get_color(\"palette.neutral.bg_panel\")\n        bg_card = theme_engine.get_color(\"palette.neutral.bg_card\")\n        bg_hover = theme_engine.get_color(\"palette.neutral.bg_hover\")\n        bg_sidebar = theme_engine.get_color(\"palette.neutral.bg_sidebar\")\n        bg_input = theme_engine.get_color(\"palette.neutral.bg_input\")\n\n        border_subtle = theme_engine.get_color(\"palette.neutral.border_subtle\")\n        border_strong = theme_engine.get_color(\"palette.neutral.border_strong\")\n        border_sidebar = theme_engine.get_color(\"palette.neutral.border_sidebar\")\n\n        text_primary = theme_engine.get_color(\"palette.text.primary\")\n        text_secondary = theme_engine.get_color(\"palette.text.secondary\")\n        text_disabled = theme_engine.get_color(\"palette.text.disabled\")\n        text_on_brand = theme_engine.get_color(\"palette.text.on_brand\")\n\n        brand = theme_engine.get_color(\"palette.brand.main\")\n        brand_hover = theme_engine.get_color(\"palette.brand.hover\")\n        brand_subtle = theme_engine.get_color(\"palette.brand.subtle\")\n        overlay_dark = theme_engine.get_color(\"palette.overlay.dark\")\n\n        # Semantic tokens (for toasts, states)\n        semantic_success = theme_engine.get_color(\"palette.semantic.success\")\n        semantic_warning = theme_engine.get_color(\"palette.semantic.warning\")\n        semantic_error = theme_engine.get_color(\"palette.semantic.error\")\n        semantic_info = theme_engine.get_color(\"palette.semantic.info\")\n\n        # Scrollbar tokens\n        bg = theme_engine.get_color(\"palette.scrollbar.bg\")\n        handle = theme_engine.get_color(\"palette.scrollbar.handle\")\n        handle_hover = theme_engine.get_color(\"palette.scrollbar.handle_hover\")\n\n        width = self.get_scaled_font_size(12)\n        radius = width // 2\n\n        # 基础：清理 Qt 默认 focus outline，避免“绿色边框/蓝色点”\n        base = f\"\"\"\n            QWidget {{\n                color: {text_primary};\n                font-family: {theme_engine.get_font_family()};\n            }}\n\n            QMainWindow, QDialog {{\n                background-color: {bg_app};\n            }}\n\n            QStackedWidget {{\n                background-color: transparent;\n                border: none;\n            }}\n\n            QWidget#Sidebar {{\n                background-color: {bg_sidebar};\n                border: none;\n            }}\n\n            /* Core surfaces for existing layout (top history / bottom params) */\n            QWidget#HistoryPanel {{\n                background-color: {bg_panel};\n                border: 1px solid {border_subtle};\n                border-radius: 12px;\n            }}\n            QWidget#ParamPanel {{\n                background-color: {bg_panel};\n                border: 1px solid {border_subtle};\n                border-radius: 12px;\n            }}\n            QWidget#settingsCard {{\n                background-color: {bg_card};\n                border: 1px solid {border_subtle};\n                border-radius: 12px;\n            }}\n\n            /* Settings typography */\n            QLabel#sectionTitle {{\n                color: {text_primary};\n                font-size: {self.get_scaled_font_size(14)}px;\n                font-weight: 600;\n            }}\n            QLabel#infoLabel {{\n                color: {text_secondary};\n            }}\n\n            /* Toast (ephemeral overlay label) */\n            QLabel#Toast {{\n                background-color: {overlay_dark};\n                color: {text_on_brand};\n                border: 1px solid {border_subtle};\n                border-radius: {self.get_scaled_font_size(18)}px;\n                padding: {self.get_scaled_font_size(10)}px {self.get_scaled_font_size(16)}px;\n            }}\n            QLabel#Toast[toastType=\"info\"] {{\n                background-color: {semantic_info};\n            }}\n            QLabel#Toast[toastType=\"success\"] {{\n                background-color: {semantic_success};\n            }}\n            QLabel#Toast[toastType=\"warning\"] {{\n                background-color: {semantic_warning};\n            }}\n            QLabel#Toast[toastType=\"error\"] {{\n                background-color: {semantic_error};\n            }}\n\n            /* List views are painted by delegates; keep container clean */\n            QListView {{\n                background-color: transparent;\n                border: none;\n                outline: none;\n            }}\n            QListView::item:selected, QListView::item:hover {{\n                background-color: transparent;\n            }}\n\n            /* Splitter handle (Eagle style: transparent, visible on hover) */\n            QSplitter::handle:vertical {{\n                background-color: transparent;\n                height: 4px;\n            }}\n            QSplitter::handle:vertical:hover {{\n                background-color: {border_subtle};\n            }}\n            QSplitter::handle:horizontal {{\n                background-color: transparent;\n                width: 4px;\n            }}\n            QSplitter::handle:horizontal:hover {{\n                background-color: {border_subtle};\n            }}\n\n            QScrollArea {{\n                background-color: transparent;\n                border: none;\n            }}\n\n            QStatusBar {{\n                background-color: {bg_panel};\n                color: {text_secondary};\n                border-top: 1px solid {border_subtle};\n            }}\n\n            QToolTip {{\n                background-color: {bg_card};\n                color: {text_primary};\n                border: 1px solid {border_subtle};\n                border-radius: 8px;\n                padding: 6px 8px;\n            }}\n\n            QMenu {{\n                background-color: {bg_card};\n                color: {text_primary};\n                border: 1px solid {border_strong};\n                border-radius: 10px;\n                padding: 6px;\n            }}\n            QMenu::item {{\n                padding: 8px 10px;\n                border-radius: 8px;\n            }}\n            QMenu::item:selected {{\n                background-color: {bg_hover};\n            }}\n\n            /* Theme toggle (keep existing widget count; style as segmented) */\n            QFrame#ThemeToggle {{\n                background-color: {bg_panel};\n                border: 1px solid {border_subtle};\n                border-radius: 10px;\n            }}\n            QPushButton[role=\"themeToggle\"] {{\n                background-color: transparent;\n                border: none;\n                color: {text_disabled};\n                padding: 0px;\n                min-width: 0px;\n                min-height: 0px;\n            }}\n            QPushButton[role=\"themeToggle\"]:hover {{\n                background-color: {bg_hover};\n                color: {text_primary};\n            }}\n            QPushButton[role=\"themeToggle\"]:checked {{\n                background-color: {brand_subtle};\n                color: {brand};\n            }}\n            QPushButton[role=\"themeToggle\"]:checked:hover {{\n                background-color: {brand_subtle};\n                color: {brand_hover};\n            }}\n\n            /* Navigation buttons (for detail dialogs) */\n            QPushButton#NavButton {{\n                background-color: {bg_card};\n                border: 1px solid {border_subtle};\n                border-radius: 15px;\n                color: {text_primary};\n                padding: 0px;\n                min-width: 30px;\n                min-height: 30px;\n            }}\n            QPushButton#NavButton:hover {{\n                background-color: {bg_hover};\n                border-color: {border_strong};\n            }}\n            QPushButton#NavButton:pressed {{\n                background-color: {bg_input};\n            }}\n            QPushButton#NavButton:disabled {{\n                color: {text_disabled};\n                background-color: {bg_panel};\n                border-color: {border_subtle};\n            }}\n\n            /* Play button (for video dialogs) */\n            QPushButton#PlayButton {{\n                background-color: {brand};\n                border: none;\n                border-radius: 15px;\n                color: {text_on_brand};\n                font-size: 14px;\n            }}\n            QPushButton#PlayButton:hover {{\n                background-color: {brand_hover};\n            }}\n\n            /* Default input surface fallback (components may override via apply_to_widget) */\n            QLineEdit, QTextEdit {{\n                background-color: {bg_input};\n                border: 1px solid {border_subtle};\n                border-radius: 8px;\n                padding: 8px 10px;\n                selection-background-color: {brand};\n                selection-color: {text_on_brand};\n            }}\n            QLineEdit:focus, QTextEdit:focus {{\n                border-color: {brand};\n            }}\n\n            *:focus {{\n                outline: none;\n            }}\n\n            /* Overlay helper (for dialogs/toasts) */\n            QWidget[role=\"overlay\"] {{\n                background-color: {overlay_dark};\n            }}\n        \"\"\"\n\n        scrollbar = f\"\"\"\n            QScrollBar:vertical {{\n                border: none;\n                background: {bg};\n                width: {width}px;\n                margin: 0px 0px 0px 0px;\n                border-radius: {radius}px;\n            }}\n            QScrollBar::handle:vertical {{\n                background: {handle};\n                min-height: 20px;\n                border-radius: {radius}px;\n                margin: 2px;\n            }}\n            QScrollBar::handle:vertical:hover {{\n                background: {handle_hover};\n            }}\n            QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical {{\n                border: none;\n                background: none;\n                height: 0px;\n            }}\n            QScrollBar::add-page:vertical, QScrollBar::sub-page:vertical {{\n                background: none;\n            }}\n            \n            QScrollBar:horizontal {{\n                border: none;\n                background: {bg};\n                height: {width}px;\n                margin: 0px 0px 0px 0px;\n                border-radius: {radius}px;\n            }}\n            QScrollBar::handle:horizontal {{\n                background: {handle};\n                min-width: 20px;\n                border-radius: {radius}px;\n                margin: 2px;\n            }}\n            QScrollBar::handle:horizontal:hover {{\n                background: {handle_hover};\n            }}\n            QScrollBar::add-line:horizontal, QScrollBar::sub-line:horizontal {{\n                border: none;\n                background: none;\n                width: 0px;\n            }}\n            QScrollBar::add-page:horizontal, QScrollBar::sub-page:horizontal {{\n                background: none;\n            }}\n        \"\"\"\n\n        return f\"{base}\\n{scrollbar}\"\n\n\n# 全局样式系统实例\nunified_style_system = UnifiedStyleSystem()\n","numLines":1073,"startLine":1,"totalLines":1073}}}
{"parentUuid":"3951839e-6156-4592-8f9e-4b4995df2894","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SBFkriHuFKXapyMzLdytms","type":"message","role":"assistant","content":[{"type":"text","text":"现在让我搜索这两个问题按钮在代码中的实际位置："}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1283,"cache_creation_input_tokens":16818,"cache_read_input_tokens":21095,"cache_creation":{"ephemeral_5m_input_tokens":16818,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"5d3571dd-21db-4f67-973b-918a260c98d5","timestamp":"2025-12-22T04:15:44.283Z"}
{"parentUuid":"5d3571dd-21db-4f67-973b-918a260c98d5","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SBFkriHuFKXapyMzLdytms","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MBBfKDrQsp278EBaEAJTxW","name":"Grep","input":{"pattern":"copyPrompt|copy_prompt|复制提示词|SecondaryButton","glob":"components/**/*.py","output_mode":"files_with_matches"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1283,"cache_creation_input_tokens":16818,"cache_read_input_tokens":21095,"cache_creation":{"ephemeral_5m_input_tokens":16818,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"d57df4d2-c062-4556-bfe4-fa38094ae095","timestamp":"2025-12-22T04:15:45.023Z"}
{"parentUuid":"d57df4d2-c062-4556-bfe4-fa38094ae095","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01SBFkriHuFKXapyMzLdytms","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011LRDDb3g8CbmmhUzA6Dzki","name":"Grep","input":{"pattern":"exportReference|export.*reference|导出选中参考|SecondaryButton","glob":"components/**/*.py","output_mode":"files_with_matches"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1283,"cache_creation_input_tokens":16818,"cache_read_input_tokens":21095,"cache_creation":{"ephemeral_5m_input_tokens":16818,"ephemeral_1h_input_tokens":0},"output_tokens":233,"service_tier":"standard"}},"type":"assistant","uuid":"232084eb-0310-471f-ba79-189220b38a13","timestamp":"2025-12-22T04:15:45.543Z"}
{"parentUuid":"232084eb-0310-471f-ba79-189220b38a13","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MBBfKDrQsp278EBaEAJTxW","type":"tool_result","content":"Found 2 files\ncomponents/dialogs/video_detail_dialog.py\ncomponents/dialogs/image_detail_dialog.py"}]},"uuid":"f3612cc2-fcdd-4fd9-8333-640fd4f61b6f","timestamp":"2025-12-22T04:15:45.622Z","toolUseResult":{"mode":"files_with_matches","filenames":["components/dialogs/video_detail_dialog.py","components/dialogs/image_detail_dialog.py"],"numFiles":2}}
{"parentUuid":"f3612cc2-fcdd-4fd9-8333-640fd4f61b6f","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011LRDDb3g8CbmmhUzA6Dzki","type":"tool_result","content":"Found 4 files\ncomponents/dialogs/video_detail_dialog.py\ncomponents/dialogs/image_detail_dialog.py\ncomponents/reference_assets/actions.py\ncomponents/reference_assets/__init__.py"}]},"uuid":"1aee2a08-6423-4f15-9dd7-45b1fe9a7f1b","timestamp":"2025-12-22T04:15:45.631Z","toolUseResult":{"mode":"files_with_matches","filenames":["components/dialogs/video_detail_dialog.py","components/dialogs/image_detail_dialog.py","components/reference_assets/actions.py","components/reference_assets/__init__.py"],"numFiles":4}}
{"parentUuid":"1aee2a08-6423-4f15-9dd7-45b1fe9a7f1b","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Umc51tVe29z5e31hWv2YA1","type":"message","role":"assistant","content":[{"type":"text","text":"让我读取这些对话框文件，看具体按钮的实现："}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1791,"cache_read_input_tokens":37913,"cache_creation":{"ephemeral_5m_input_tokens":1791,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"type":"assistant","uuid":"0b5b9e17-6b62-4c34-822a-c136d02c85d0","timestamp":"2025-12-22T04:15:52.091Z"}
{"parentUuid":"0b5b9e17-6b62-4c34-822a-c136d02c85d0","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Umc51tVe29z5e31hWv2YA1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AajjVMrhBWJL8GKSeuqcYS","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/components/dialogs/image_detail_dialog.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1791,"cache_read_input_tokens":37913,"cache_creation":{"ephemeral_5m_input_tokens":1791,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"type":"assistant","uuid":"506c92ab-57c1-4170-99c4-881821810407","timestamp":"2025-12-22T04:15:52.383Z"}
{"parentUuid":"506c92ab-57c1-4170-99c4-881821810407","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Umc51tVe29z5e31hWv2YA1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01M68kTjC92n4UMeVvWnYZcX","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/components/reference_assets/actions.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":1791,"cache_read_input_tokens":37913,"cache_creation":{"ephemeral_5m_input_tokens":1791,"ephemeral_1h_input_tokens":0},"output_tokens":161,"service_tier":"standard"}},"type":"assistant","uuid":"43e7de0d-e74a-469d-be06-b9dba8769ba9","timestamp":"2025-12-22T04:15:52.581Z"}
{"parentUuid":"43e7de0d-e74a-469d-be06-b9dba8769ba9","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01M68kTjC92n4UMeVvWnYZcX","type":"tool_result","content":"     1→#!/usr/bin/env python3\n     2→# -*- coding: utf-8 -*-\n     3→\"\"\"Reference asset actions extracted from qt_app.\"\"\"\n     4→\n     5→from __future__ import annotations\n     6→\n     7→import os\n     8→import shutil\n     9→from pathlib import Path\n    10→from typing import Any, Callable, Dict, Optional, Sequence\n    11→\n    12→from PySide6.QtCore import Qt\n    13→from PySide6.QtGui import QKeySequence, QPixmap\n    14→from PySide6.QtWidgets import (\n    15→    QDialog,\n    16→    QFileDialog,\n    17→    QHBoxLayout,\n    18→    QLabel,\n    19→    QMessageBox,\n    20→    QPushButton,\n    21→    QMenu,\n    22→    QVBoxLayout,\n    23→    QWidget,\n    24→)\n    25→from PySide6.QtGui import QShortcut\n    26→from utils.style_system import unified_style_system\n    27→\n    28→from components.reference_assets.gallery import ReferenceGalleryWidget\n    29→from components.widgets.zoomable_image_label import ZoomableImageLabel\n    30→from utils.logger import logger\n    31→from utils.reference_display import (\n    32→    _mask_reference_ids,\n    33→    format_reference_display_label,\n    34→)\n    35→\n    36→def _find_reference_asset_index(assets: Sequence[Dict[str, Any]], target: Dict[str, Any]) -> int:\n    37→    for idx, candidate in enumerate(assets):\n    38→        if ReferenceGalleryWidget._is_same_asset(candidate, target):\n    39→            return idx\n    40→    return 0\n    41→\n    42→\n    43→def open_reference_preview(\n    44→    parent: QWidget,\n    45→    asset: Dict[str, Any],\n    46→    *,\n    47→    title_prefix: str = \"参考图\",\n    48→    asset_list: Optional[Sequence[Dict[str, Any]]] = None,\n    49→    start_index: Optional[int] = None,\n    50→    on_asset_changed: Optional[Callable[[Dict[str, Any]], None]] = None,\n    51→):\n    52→    assets = list(asset_list) if asset_list else [asset]\n    53→    if not assets:\n    54→        assets = [asset]\n    55→\n    56→    total = len(assets)\n    57→    index = start_index if (start_index is not None and 0 <= start_index < total) else _find_reference_asset_index(assets, asset)\n    58→\n    59→    dialog = QDialog(parent)\n    60→    dialog.setModal(True)\n    61→    dialog.setWindowModality(Qt.ApplicationModal)\n    62→    dialog.setAttribute(Qt.WA_DeleteOnClose, True)\n    63→    layout = QVBoxLayout(dialog)\n    64→    layout.setContentsMargins(12, 12, 12, 12)\n    65→    layout.setSpacing(10)\n    66→\n    67→    viewer = ZoomableImageLabel()\n    68→    viewer.setFocusPolicy(Qt.StrongFocus)\n    69→    viewer.setMinimumSize(480, 360)\n    70→    layout.addWidget(viewer, 1)\n    71→\n    72→    # 获取主题颜色\n    73→    colors = unified_style_system.get_colors()\n    74→    warning_color = (\n    75→        colors.get('palette.accent.orange')\n    76→        or colors.get('palette.semantic.warning')\n    77→        or colors.get('primary')\n    78→    )\n    79→    secondary_text = (\n    80→        colors.get('palette.text.secondary')\n    81→        or colors.get('text_secondary')\n    82→        or colors.get('palette.text.primary')\n    83→        or colors.get('text')\n    84→    )\n    85→\n    86→    info_label = QLabel(\"\")\n    87→    info_label.setStyleSheet(f\"color: {warning_color};\")\n    88→    info_label.setWordWrap(True)\n    89→    info_label.hide()\n    90→    layout.addWidget(info_label)\n    91→\n    92→    controls = QHBoxLayout()\n    93→    controls.setContentsMargins(0, 0, 0, 0)\n    94→    controls.setSpacing(8)\n    95→\n    96→    prev_btn = QPushButton(\"上一张\")\n    97→    next_btn = QPushButton(\"下一张\")\n    98→    index_label = QLabel(\"\")\n    99→    index_label.setStyleSheet(f\"color: {secondary_text};\")\n   100→    hint_label = QLabel(\"Ctrl/⌘+滚轮缩放，双击或点击按钮重置\")\n   101→    hint_label.setStyleSheet(f\"color: {secondary_text};\")\n   102→    reset_btn = QPushButton(\"重置缩放\")\n   103→    close_btn = QPushButton(\"关闭\")\n   104→\n   105→    controls.addWidget(prev_btn)\n   106→    controls.addWidget(next_btn)\n   107→    controls.addStretch(1)\n   108→    controls.addWidget(index_label)\n   109→    controls.addStretch(1)\n   110→    controls.addWidget(hint_label)\n   111→    controls.addStretch(1)\n   112→    controls.addWidget(reset_btn)\n   113→    controls.addWidget(close_btn)\n   114→    layout.addLayout(controls)\n   115→\n   116→    esc_shortcut = QShortcut(QKeySequence(Qt.Key_Escape), dialog)\n   117→    esc_shortcut.activated.connect(dialog.reject)\n   118→\n   119→    prev_shortcut = QShortcut(QKeySequence(Qt.Key_Left), dialog)\n   120→    next_shortcut = QShortcut(QKeySequence(Qt.Key_Right), dialog)\n   121→    prev_shortcut_a = QShortcut(QKeySequence(Qt.Key_A), dialog)\n   122→    next_shortcut_d = QShortcut(QKeySequence(Qt.Key_D), dialog)\n   123→\n   124→    state = {\n   125→        'index': index,\n   126→        'total': total,\n   127→    }\n   128→\n   129→    def update_title(current_asset: Dict[str, Any]):\n   130→        display_label = format_reference_display_label(current_asset, current_asset.get('order') or 0)\n   131→        dialog.setWindowTitle(f\"{title_prefix} {display_label}\")\n   132→\n   133→    def update_nav_buttons():\n   134→        idx = state['index']\n   135→        total_count = state['total']\n   136→        prev_btn.setEnabled(total_count > 1 and idx > 0)\n   137→        next_btn.setEnabled(total_count > 1 and idx < total_count - 1)\n   138→        index_label.setText(f\"{idx + 1}/{total_count}\")\n   139→\n   140→    def load_asset(idx: int):\n   141→        idx = max(0, min(idx, state['total'] - 1))\n   142→        current_asset = assets[idx]\n   143→        \n   144→        # 兼容新旧字段名：新系统使用 file_path/relative_path，旧系统使用 absolute_path/path\n   145→        path = current_asset.get('file_path') or current_asset.get('absolute_path') or current_asset.get('path')\n   146→        \n   147→        # 如果没有路径，尝试使用 relative_path\n   148→        if not path and current_asset.get('relative_path'):\n   149→            path = current_asset.get('relative_path')\n   150→        \n   151→        # 如果有路径，判断是否需要与存储目录拼接\n   152→        if path:\n   153→            # 如果不是绝对路径\n   154→            if not os.path.isabs(path):\n   155→                # path 是相对路径，需要与存储目录拼接\n   156→                try:\n   157→                    from config_api import get_storage_dir\n   158→                    storage_root = get_storage_dir()\n   159→                    if storage_root:\n   160→                        path = os.path.join(storage_root, path)\n   161→                except Exception:\n   162→                    pass\n   163→        \n   164→        available = False\n   165→        pixmap = None\n   166→        if path and os.path.exists(path):\n   167→            pixmap = QPixmap(path)\n   168→            if pixmap and not pixmap.isNull():\n   169→                available = True\n   170→\n   171→        if available:\n   172→            viewer.setPixmap(pixmap)\n   173→            info_label.hide()\n   174→            # 只在成功加载图片时才重置缩放\n   175→            viewer.reset_zoom()\n   176→        else:\n   177→            viewer.original_pixmap = None\n   178→            viewer.setPixmap(QPixmap())\n   179→            info_label.setText(\"参考图暂不可用（文件缺失或无法加载）\")\n   180→            info_label.show()\n   181→\n   182→        state['index'] = idx\n   183→        update_title(current_asset)\n   184→        update_nav_buttons()\n   185→\n   186→        if callable(on_asset_changed):\n   187→            try:\n   188→                on_asset_changed(current_asset)\n   189→            except Exception:\n   190→                pass\n   191→\n   192→    def show_prev():\n   193→        idx = state['index']\n   194→        if idx > 0:\n   195→            load_asset(idx - 1)\n   196→\n   197→    def show_next():\n   198→        idx = state['index']\n   199→        if idx < state['total'] - 1:\n   200→            load_asset(idx + 1)\n   201→\n   202→    prev_btn.clicked.connect(show_prev)\n   203→    next_btn.clicked.connect(show_next)\n   204→    reset_btn.clicked.connect(viewer.reset_zoom)\n   205→    close_btn.clicked.connect(dialog.accept)\n   206→    prev_shortcut.activated.connect(show_prev)\n   207→    prev_shortcut_a.activated.connect(show_prev)\n   208→    next_shortcut.activated.connect(show_next)\n   209→    next_shortcut_d.activated.connect(show_next)\n   210→\n   211→    load_asset(state['index'])\n   212→\n   213→    dialog.resize(720, 560)\n   214→    dialog.exec()\n   215→\n   216→\n   217→def export_reference_asset(parent: QWidget, asset: Dict[str, Any]) -> Optional[str]:\n   218→    path = asset.get('absolute_path') or asset.get('path')\n   219→    if not (path and os.path.exists(path)):\n   220→        QMessageBox.warning(parent, \"导出参考图\", \"参考图暂不可用\")\n   221→        return None\n   222→\n   223→    src_path = Path(path)\n   224→    suffix = src_path.suffix or '.png'\n   225→    base_name = asset.get('id') or src_path.stem\n   226→    if not base_name:\n   227→        base_name = 'reference_image'\n   228→    if not base_name.endswith(suffix):\n   229→        suggested_name = f\"{base_name}{suffix}\"\n   230→    else:\n   231→        suggested_name = base_name\n   232→\n   233→    start_path = os.path.join(os.path.expanduser('~'), suggested_name)\n   234→    dest_path, _ = QFileDialog.getSaveFileName(\n   235→        parent,\n   236→        \"导出参考图\",\n   237→        start_path,\n   238→        \"Images (*.png *.jpg *.jpeg *.webp *.bmp)\"\n   239→    )\n   240→    if not dest_path:\n   241→        return None\n   242→\n   243→    try:\n   244→        shutil.copyfile(str(src_path), dest_path)\n   245→    except Exception as exc:\n   246→        QMessageBox.critical(parent, \"导出失败\", f\"导出失败：{exc}\")\n   247→        try:\n   248→            logger.warning(f\"reference_export_failed|ids={_mask_reference_ids([asset])}\")\n   249→        except Exception:\n   250→            pass\n   251→        return None\n   252→\n   253→    try:\n   254→        masked = _mask_reference_ids([asset])\n   255→        dest_dir_name = Path(dest_path).parent.name or Path(dest_path).parent\n   256→        logger.info(f\"reference_export|count=1 ids={masked} dest={dest_dir_name}\")\n   257→    except Exception:\n   258→        pass\n   259→\n   260→    dest_dir = str(Path(dest_path).parent)\n   261→    QMessageBox.information(parent, \"导出成功\", f\"已导出到目录: {dest_dir}\")\n   262→    return dest_path\n   263→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"c8728ddb-6b39-4816-8f13-7626739f4def","timestamp":"2025-12-22T04:15:52.641Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/components/reference_assets/actions.py","content":"#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n\"\"\"Reference asset actions extracted from qt_app.\"\"\"\n\nfrom __future__ import annotations\n\nimport os\nimport shutil\nfrom pathlib import Path\nfrom typing import Any, Callable, Dict, Optional, Sequence\n\nfrom PySide6.QtCore import Qt\nfrom PySide6.QtGui import QKeySequence, QPixmap\nfrom PySide6.QtWidgets import (\n    QDialog,\n    QFileDialog,\n    QHBoxLayout,\n    QLabel,\n    QMessageBox,\n    QPushButton,\n    QMenu,\n    QVBoxLayout,\n    QWidget,\n)\nfrom PySide6.QtGui import QShortcut\nfrom utils.style_system import unified_style_system\n\nfrom components.reference_assets.gallery import ReferenceGalleryWidget\nfrom components.widgets.zoomable_image_label import ZoomableImageLabel\nfrom utils.logger import logger\nfrom utils.reference_display import (\n    _mask_reference_ids,\n    format_reference_display_label,\n)\n\ndef _find_reference_asset_index(assets: Sequence[Dict[str, Any]], target: Dict[str, Any]) -> int:\n    for idx, candidate in enumerate(assets):\n        if ReferenceGalleryWidget._is_same_asset(candidate, target):\n            return idx\n    return 0\n\n\ndef open_reference_preview(\n    parent: QWidget,\n    asset: Dict[str, Any],\n    *,\n    title_prefix: str = \"参考图\",\n    asset_list: Optional[Sequence[Dict[str, Any]]] = None,\n    start_index: Optional[int] = None,\n    on_asset_changed: Optional[Callable[[Dict[str, Any]], None]] = None,\n):\n    assets = list(asset_list) if asset_list else [asset]\n    if not assets:\n        assets = [asset]\n\n    total = len(assets)\n    index = start_index if (start_index is not None and 0 <= start_index < total) else _find_reference_asset_index(assets, asset)\n\n    dialog = QDialog(parent)\n    dialog.setModal(True)\n    dialog.setWindowModality(Qt.ApplicationModal)\n    dialog.setAttribute(Qt.WA_DeleteOnClose, True)\n    layout = QVBoxLayout(dialog)\n    layout.setContentsMargins(12, 12, 12, 12)\n    layout.setSpacing(10)\n\n    viewer = ZoomableImageLabel()\n    viewer.setFocusPolicy(Qt.StrongFocus)\n    viewer.setMinimumSize(480, 360)\n    layout.addWidget(viewer, 1)\n\n    # 获取主题颜色\n    colors = unified_style_system.get_colors()\n    warning_color = (\n        colors.get('palette.accent.orange')\n        or colors.get('palette.semantic.warning')\n        or colors.get('primary')\n    )\n    secondary_text = (\n        colors.get('palette.text.secondary')\n        or colors.get('text_secondary')\n        or colors.get('palette.text.primary')\n        or colors.get('text')\n    )\n\n    info_label = QLabel(\"\")\n    info_label.setStyleSheet(f\"color: {warning_color};\")\n    info_label.setWordWrap(True)\n    info_label.hide()\n    layout.addWidget(info_label)\n\n    controls = QHBoxLayout()\n    controls.setContentsMargins(0, 0, 0, 0)\n    controls.setSpacing(8)\n\n    prev_btn = QPushButton(\"上一张\")\n    next_btn = QPushButton(\"下一张\")\n    index_label = QLabel(\"\")\n    index_label.setStyleSheet(f\"color: {secondary_text};\")\n    hint_label = QLabel(\"Ctrl/⌘+滚轮缩放，双击或点击按钮重置\")\n    hint_label.setStyleSheet(f\"color: {secondary_text};\")\n    reset_btn = QPushButton(\"重置缩放\")\n    close_btn = QPushButton(\"关闭\")\n\n    controls.addWidget(prev_btn)\n    controls.addWidget(next_btn)\n    controls.addStretch(1)\n    controls.addWidget(index_label)\n    controls.addStretch(1)\n    controls.addWidget(hint_label)\n    controls.addStretch(1)\n    controls.addWidget(reset_btn)\n    controls.addWidget(close_btn)\n    layout.addLayout(controls)\n\n    esc_shortcut = QShortcut(QKeySequence(Qt.Key_Escape), dialog)\n    esc_shortcut.activated.connect(dialog.reject)\n\n    prev_shortcut = QShortcut(QKeySequence(Qt.Key_Left), dialog)\n    next_shortcut = QShortcut(QKeySequence(Qt.Key_Right), dialog)\n    prev_shortcut_a = QShortcut(QKeySequence(Qt.Key_A), dialog)\n    next_shortcut_d = QShortcut(QKeySequence(Qt.Key_D), dialog)\n\n    state = {\n        'index': index,\n        'total': total,\n    }\n\n    def update_title(current_asset: Dict[str, Any]):\n        display_label = format_reference_display_label(current_asset, current_asset.get('order') or 0)\n        dialog.setWindowTitle(f\"{title_prefix} {display_label}\")\n\n    def update_nav_buttons():\n        idx = state['index']\n        total_count = state['total']\n        prev_btn.setEnabled(total_count > 1 and idx > 0)\n        next_btn.setEnabled(total_count > 1 and idx < total_count - 1)\n        index_label.setText(f\"{idx + 1}/{total_count}\")\n\n    def load_asset(idx: int):\n        idx = max(0, min(idx, state['total'] - 1))\n        current_asset = assets[idx]\n        \n        # 兼容新旧字段名：新系统使用 file_path/relative_path，旧系统使用 absolute_path/path\n        path = current_asset.get('file_path') or current_asset.get('absolute_path') or current_asset.get('path')\n        \n        # 如果没有路径，尝试使用 relative_path\n        if not path and current_asset.get('relative_path'):\n            path = current_asset.get('relative_path')\n        \n        # 如果有路径，判断是否需要与存储目录拼接\n        if path:\n            # 如果不是绝对路径\n            if not os.path.isabs(path):\n                # path 是相对路径，需要与存储目录拼接\n                try:\n                    from config_api import get_storage_dir\n                    storage_root = get_storage_dir()\n                    if storage_root:\n                        path = os.path.join(storage_root, path)\n                except Exception:\n                    pass\n        \n        available = False\n        pixmap = None\n        if path and os.path.exists(path):\n            pixmap = QPixmap(path)\n            if pixmap and not pixmap.isNull():\n                available = True\n\n        if available:\n            viewer.setPixmap(pixmap)\n            info_label.hide()\n            # 只在成功加载图片时才重置缩放\n            viewer.reset_zoom()\n        else:\n            viewer.original_pixmap = None\n            viewer.setPixmap(QPixmap())\n            info_label.setText(\"参考图暂不可用（文件缺失或无法加载）\")\n            info_label.show()\n\n        state['index'] = idx\n        update_title(current_asset)\n        update_nav_buttons()\n\n        if callable(on_asset_changed):\n            try:\n                on_asset_changed(current_asset)\n            except Exception:\n                pass\n\n    def show_prev():\n        idx = state['index']\n        if idx > 0:\n            load_asset(idx - 1)\n\n    def show_next():\n        idx = state['index']\n        if idx < state['total'] - 1:\n            load_asset(idx + 1)\n\n    prev_btn.clicked.connect(show_prev)\n    next_btn.clicked.connect(show_next)\n    reset_btn.clicked.connect(viewer.reset_zoom)\n    close_btn.clicked.connect(dialog.accept)\n    prev_shortcut.activated.connect(show_prev)\n    prev_shortcut_a.activated.connect(show_prev)\n    next_shortcut.activated.connect(show_next)\n    next_shortcut_d.activated.connect(show_next)\n\n    load_asset(state['index'])\n\n    dialog.resize(720, 560)\n    dialog.exec()\n\n\ndef export_reference_asset(parent: QWidget, asset: Dict[str, Any]) -> Optional[str]:\n    path = asset.get('absolute_path') or asset.get('path')\n    if not (path and os.path.exists(path)):\n        QMessageBox.warning(parent, \"导出参考图\", \"参考图暂不可用\")\n        return None\n\n    src_path = Path(path)\n    suffix = src_path.suffix or '.png'\n    base_name = asset.get('id') or src_path.stem\n    if not base_name:\n        base_name = 'reference_image'\n    if not base_name.endswith(suffix):\n        suggested_name = f\"{base_name}{suffix}\"\n    else:\n        suggested_name = base_name\n\n    start_path = os.path.join(os.path.expanduser('~'), suggested_name)\n    dest_path, _ = QFileDialog.getSaveFileName(\n        parent,\n        \"导出参考图\",\n        start_path,\n        \"Images (*.png *.jpg *.jpeg *.webp *.bmp)\"\n    )\n    if not dest_path:\n        return None\n\n    try:\n        shutil.copyfile(str(src_path), dest_path)\n    except Exception as exc:\n        QMessageBox.critical(parent, \"导出失败\", f\"导出失败：{exc}\")\n        try:\n            logger.warning(f\"reference_export_failed|ids={_mask_reference_ids([asset])}\")\n        except Exception:\n            pass\n        return None\n\n    try:\n        masked = _mask_reference_ids([asset])\n        dest_dir_name = Path(dest_path).parent.name or Path(dest_path).parent\n        logger.info(f\"reference_export|count=1 ids={masked} dest={dest_dir_name}\")\n    except Exception:\n        pass\n\n    dest_dir = str(Path(dest_path).parent)\n    QMessageBox.information(parent, \"导出成功\", f\"已导出到目录: {dest_dir}\")\n    return dest_path\n","numLines":263,"startLine":1,"totalLines":263}}}
{"parentUuid":"c8728ddb-6b39-4816-8f13-7626739f4def","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AajjVMrhBWJL8GKSeuqcYS","type":"tool_result","content":"     1→import os\n     2→import json\n     3→from datetime import datetime\n     4→from typing import Dict, Any, List, Optional\n     5→\n     6→from PySide6.QtWidgets import (\n     7→    QDialog, QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton,\n     8→    QTextEdit, QFileDialog, QMessageBox, QSplitter, QApplication,\n     9→    QMenu, QSizePolicy\n    10→)\n    11→from PySide6.QtGui import QAction, QShortcut\n    12→from PySide6.QtCore import Qt, QTimer, QSize, QEvent\n    13→from PySide6.QtGui import QPixmap, QKeySequence\n    14→\n    15→from utils.logger import logger\n    16→from utils.style_system import unified_style_system\n    17→from components.widgets import ZoomableImageLabel, ClickableLabel\n    18→from components.reference_assets import (\n    19→    ReferenceGalleryWidget,\n    20→    export_reference_asset,\n    21→    open_reference_preview,\n    22→    _find_reference_asset_index,\n    23→)\n    24→from components.controllers import ExportBundleController\n    25→from utils.reference_display import ensure_reference_info, resolve_reference_assets\n    26→from PySide6.QtCore import Signal\n    27→\n    28→class ImageDetailDialog(QDialog):\n    29→    \"\"\"图片详细信息对话框\"\"\"\n    30→    \n    31→    # 删除记录后发出信号，通知父视图刷新\n    32→    recordDeleted = Signal(str)  # 参数为被删除的记录ID\n    33→    \n    34→    def __init__(self, image_data: Dict[str, Any], image_list: List[Dict[str, Any]] = None, current_index: int = 0, parent=None):\n    35→        super().__init__(parent)\n    36→        self.image_data = image_data\n    37→        self.image_list = image_list or [image_data]  # 图片列表\n    38→        self.current_index = current_index  # 当前图片索引\n    39→        self.zoom_factor = 1.0  # 缩放因子\n    40→        self.is_fullscreen = False  # 全屏状态\n    41→        self.original_geometry = None  # 原始窗口几何\n    42→        self._reference_summary = ensure_reference_info(self.image_data)\n    43→        self._reference_assets: List[Dict[str, Any]] = []\n    44→        self._export_controller = ExportBundleController(self, \"image\")\n    45→        \n    46→        # Subscribe to theme changes\n    47→        unified_style_system.styleChanged.connect(self._update_theme)\n    48→        \n    49→        self.setup_ui()\n    50→        \n    51→    def setup_ui(self):\n    52→        \"\"\"设置UI\"\"\"\n    53→        self.setWindowTitle(\"图片详细信息\")\n    54→        self.resize(1100, 800)  # 改为可调整大小\n    55→        self.setMinimumSize(800, 600)  # 设置最小尺寸\n    56→        \n    57→        # 设置焦点策略，确保能接收键盘事件\n    58→        self.setFocusPolicy(Qt.StrongFocus)\n    59→        self.setAttribute(Qt.WA_KeyCompression, False)  # 禁用键盘事件压缩\n    60→        self.setFocus()\n    61→\n    62→        # 确保窗口激活时获得焦点\n    63→        self.activateWindow()\n    64→        self.raise_()\n    65→\n    66→        try:\n    67→            self.setObjectName(\"DetailDialog\")\n    68→        except Exception:\n    69→            pass\n    70→\n    71→        self._focus_timer = QTimer(self)\n    72→        self._focus_timer.setSingleShot(True)\n    73→        self._focus_timer.timeout.connect(self._ensure_focus)\n    74→\n    75→        layout = QHBoxLayout(self)\n    76→        \n    77→        # 左侧：大图显示（占70%宽度）\n    78→        left_widget = QWidget()\n    79→        left_layout = QVBoxLayout(left_widget)\n    80→        left_layout.setContentsMargins(0, 0, 0, 0)\n    81→        \n    82→        # 图片显示区域（占据上方全部空间）\n    83→        image_container = QWidget()\n    84→        image_container.setObjectName(\"ImageContainer\")\n    85→        image_container.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)\n    86→\n    87→        # 在容器内创建布局\n    88→        container_layout = QVBoxLayout(image_container)\n    89→        container_layout.setContentsMargins(0, 0, 0, 0)\n    90→        container_layout.setSpacing(0)\n    91→\n    92→        # 使用可缩放的图片标签，自适应容器大小\n    93→        self.large_image_label = ZoomableImageLabel()\n    94→        self.large_image_label.setAlignment(Qt.AlignCenter)\n    95→        self.large_image_label.setStyleSheet(\"border: none; background-color: transparent;\")\n    96→        \n    97→        # 设置右键菜单\n    98→        self.large_image_label.setContextMenuPolicy(Qt.CustomContextMenu)\n    99→        self.large_image_label.customContextMenuRequested.connect(self.show_context_menu)\n   100→        \n   101→        # 加载大图\n   102→        image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')\n   103→        if image_path and os.path.exists(image_path):\n   104→            pixmap = QPixmap(image_path)\n   105→            if not pixmap.isNull():\n   106→                self.large_image_label.setPixmap(pixmap)\n   107→        \n   108→        container_layout.addWidget(self.large_image_label, 1)\n   109→\n   110→        reference_section = QWidget()\n   111→        reference_section.setObjectName(\"ReferenceSection\")\n   112→        reference_section.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)\n   113→        reference_section_layout = QVBoxLayout(reference_section)\n   114→        reference_section_layout.setContentsMargins(0, 0, 0, 0)\n   115→        reference_section_layout.setSpacing(8)\n   116→\n   117→        self.reference_gallery = ReferenceGalleryWidget()\n   118→        self.reference_gallery.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)\n   119→        try:\n   120→            self.reference_gallery.referenceClicked.connect(self._on_reference_clicked)\n   121→            self.reference_gallery.exportRequested.connect(self._on_reference_export)\n   122→            self.reference_gallery.selectionChanged.connect(self._on_reference_selection_changed)\n   123→        except Exception:\n   124→            pass\n   125→        reference_section_layout.addWidget(self.reference_gallery, 1)\n   126→\n   127→        reference_button_layout = QHBoxLayout()\n   128→        reference_button_layout.setContentsMargins(0, 0, 0, 0)\n   129→        reference_button_layout.setSpacing(6)\n   130→        self.export_status_label = QLabel(\"\")\n   131→        self.export_status_label.setObjectName(\"infoLabel\")\n   132→        unified_style_system.apply_to_widget(self.export_status_label)\n   133→        reference_button_layout.addWidget(self.export_status_label)\n   134→        reference_button_layout.addStretch(1)\n   135→        self.reference_export_btn = QPushButton(\"导出选中参考图\")\n   136→        self.reference_export_btn.setObjectName(\"SecondaryButton\")\n   137→        self.reference_export_btn.setEnabled(False)\n   138→        unified_style_system.apply_to_widget(self.reference_export_btn)\n   139→        self.reference_export_btn.clicked.connect(self._export_selected_reference)\n   140→        reference_button_layout.addWidget(self.reference_export_btn)\n   141→        self.export_bundle_btn = QPushButton(\"导出记录\")\n   142→        self.export_bundle_btn.setObjectName(\"SecondaryButton\")\n   143→        self.export_bundle_btn.setEnabled(False)\n   144→        unified_style_system.apply_to_widget(self.export_bundle_btn)\n   145→        self._export_controller.configure(\n   146→            self.export_bundle_btn,\n   147→            self.export_status_label,\n   148→            self._resolve_record_id,\n   149→            context_widget=self,\n   150→        )\n   151→        reference_button_layout.addWidget(self.export_bundle_btn)\n   152→        reference_section_layout.addLayout(reference_button_layout)\n   153→\n   154→        self._image_reference_splitter = QSplitter(Qt.Vertical)\n   155→        self._image_reference_splitter.setObjectName(\"ImageReferenceSplitter\")\n   156→        self._image_reference_splitter.setChildrenCollapsible(False)\n   157→        self._image_reference_splitter.setHandleWidth(6)\n   158→        self._image_reference_splitter.addWidget(image_container)\n   159→        self._image_reference_splitter.addWidget(reference_section)\n   160→        self._image_reference_splitter.setStretchFactor(0, 3)\n   161→        self._image_reference_splitter.setStretchFactor(1, 2)\n   162→        self._image_reference_splitter.setSizes([520, 280])\n   163→\n   164→        left_layout.addWidget(self._image_reference_splitter, 1)\n   165→\n   166→        # 底部区域：导航按钮 + 说明文本框（与右侧参数栏高度对齐）\n   167→        bottom_layout = QHBoxLayout()\n   168→        bottom_layout.setContentsMargins(0, 5, 0, 5)\n   169→        bottom_layout.setSpacing(10)\n   170→        \n   171→        # 向左按钮\n   172→        self.prev_btn = QPushButton(\"◀\")\n   173→        self.prev_btn.setFixedSize(30, 30)  # 固定尺寸\n   174→        self.prev_btn.setObjectName(\"NavButton\")\n   175→        unified_style_system.apply_to_widget(self.prev_btn)\n   176→        self.prev_btn.clicked.connect(self.show_previous_image)\n   177→        bottom_layout.addWidget(self.prev_btn)\n   178→        \n   179→        # 中间的说明文本框（完全透明设计）\n   180→        zoom_info = QLabel(\"提示：鼠标位置缩放，点击拖拽，双击重置\")\n   181→        zoom_info.setObjectName(\"infoLabel\")\n   182→        unified_style_system.apply_to_widget(zoom_info)\n   183→        zoom_info.setAlignment(Qt.AlignCenter)\n   184→        zoom_info.setMinimumHeight(30)  # 与按钮高度一致\n   185→        zoom_info.setMaximumHeight(30)  # 固定高度，防止文字被压缩\n   186→        bottom_layout.addWidget(zoom_info, 1)  # 占据中间所有空间\n   187→        \n   188→        # 向右按钮\n   189→        self.next_btn = QPushButton(\"▶\")\n   190→        self.next_btn.setFixedSize(30, 30)  # 固定尺寸\n   191→        self.next_btn.setObjectName(\"NavButton\")\n   192→        unified_style_system.apply_to_widget(self.next_btn)\n   193→        self.next_btn.clicked.connect(self.show_next_image)\n   194→        bottom_layout.addWidget(self.next_btn)\n   195→        \n   196→        left_layout.addLayout(bottom_layout)\n   197→\n   198→        # 更新导航按钮状态\n   199→        self.update_navigation_buttons()\n   200→        self._refresh_reference_gallery()\n   201→        self._export_controller.refresh()\n   202→\n   203→        # 右侧：详细信息（固定30%宽度）\n   204→        right_layout = QVBoxLayout()\n   205→        \n   206→        # 创建参数显示区域（不使用滚动条）\n   207→        params_widget = QWidget()\n   208→        params_widget.setFixedWidth(int(self.width() * 0.3))  # 固定30%宽度\n   209→        params_widget.setObjectName(\"ParamsWidget\")\n   210→        self.params_layout = QVBoxLayout(params_widget)  # 保存引用以便后续更新\n   211→        self.params_layout.setSpacing(0)  # 设置间距为0\n   212→        self.params_layout.setContentsMargins(5, 5, 5, 5)  # 设置紧凑的边距\n   213→        \n   214→        # 初始化参数显示区域\n   215→        self.setup_params_area()\n   216→        \n   217→        \n   218→        right_layout.addWidget(params_widget)\n   219→        \n   220→        # 全屏和复制图片按钮（与参数区底部对齐）\n   221→        image_control_layout = QHBoxLayout()\n   222→\n   223→        self.fullscreen_btn = QPushButton(\"全屏 (F11)\")\n   224→        self.fullscreen_btn.setMaximumHeight(30)\n   225→        unified_style_system.apply_to_widget(self.fullscreen_btn)\n   226→        self.fullscreen_btn.clicked.connect(self.toggle_fullscreen)\n   227→        image_control_layout.addWidget(self.fullscreen_btn)\n   228→\n   229→        self.copy_image_btn = QPushButton(\"复制图片\")\n   230→        self.copy_image_btn.setMaximumHeight(30)\n   231→        unified_style_system.apply_to_widget(self.copy_image_btn)\n   232→        self.copy_image_btn.clicked.connect(self.copy_image)\n   233→        image_control_layout.addWidget(self.copy_image_btn)\n   234→\n   235→        right_layout.addLayout(image_control_layout)\n   236→\n   237→        # 其他按钮\n   238→        button_layout = QHBoxLayout()\n   239→\n   240→        self.delete_btn = QPushButton(\"删除记录\")\n   241→        unified_style_system.apply_to_widget(self.delete_btn, extra={'variant': 'danger'})\n   242→        self.delete_btn.clicked.connect(self._delete_current_record)\n   243→        button_layout.addWidget(self.delete_btn)\n   244→\n   245→        self.close_btn = QPushButton(\"关闭（ESC）\")\n   246→        unified_style_system.apply_to_widget(self.close_btn)\n   247→        self.close_btn.clicked.connect(self.accept)\n   248→        button_layout.addWidget(self.close_btn)\n   249→        \n   250→        right_layout.addLayout(button_layout)\n   251→        \n   252→        # 设置布局比例：左侧70%，右侧30%\n   253→        layout.addWidget(left_widget, 7)\n   254→        layout.addLayout(right_layout, 3)\n   255→        \n   256→        # 添加键盘快捷键\n   257→        self.setup_shortcuts()\n   258→\n   259→        # 延迟设置焦点，确保窗口完全初始化后获得焦点\n   260→        self._focus_timer.start(100)\n   261→\n   262→        self._esc_shortcut = QShortcut(QKeySequence(Qt.Key_Escape), self)\n   263→        self._esc_shortcut.activated.connect(self.handle_escape_key)\n   264→        \n   265→        # Apply initial theme\n   266→        self._update_theme()\n   267→    \n   268→    def format_time(self, time_str: str) -> str:\n   269→        \"\"\"格式化时间显示\"\"\"\n   270→        if not time_str:\n   271→            return '未知时间'\n   272→        try:\n   273→            dt = datetime.fromisoformat(time_str.replace('Z', '+00:00'))\n   274→            return dt.strftime('%Y-%m-%d %H:%M:%S')\n   275→        except:\n   276→            return time_str[:19] if len(time_str) > 19 else time_str\n   277→    \n   278→    def format_file_size(self, size) -> str:\n   279→        \"\"\"格式化文件大小显示\"\"\"\n   280→        # 处理字符串类型的size\n   281→        try:\n   282→            size = float(size) if size else 0\n   283→        except (ValueError, TypeError):\n   284→            return '未知大小'\n   285→            \n   286→        if size == 0:\n   287→            return '未知大小'\n   288→        \n   289→        for unit in ['B', 'KB', 'MB', 'GB']:\n   290→            if size < 1024.0:\n   291→                return f\"{size:.1f} {unit}\"\n   292→            size /= 1024.0\n   293→        return f\"{size:.1f} TB\"\n   294→    \n   295→    def setup_shortcuts(self):\n   296→        \"\"\"设置键盘快捷键\"\"\"\n   297→        # 移除所有QShortcut，统一使用keyPressEvent处理\n   298→        # 避免快捷键冲突问题\n   299→        pass\n   300→    \n   301→    def _ensure_focus(self):\n   302→        \"\"\"确保窗口获得焦点\"\"\"\n   303→        self.activateWindow()\n   304→        self.raise_()\n   305→        self.setFocus()\n   306→        logger.debug(f\"[FOCUS] ImageDialog窗口焦点设置完成，hasFocus: {self.hasFocus()}\")\n   307→        \n   308→    def toggle_fullscreen(self):\n   309→        \"\"\"切换全屏模式\"\"\"\n   310→        if self.is_fullscreen:\n   311→            self.exit_fullscreen()\n   312→        else:\n   313→            self.enter_fullscreen()\n   314→            \n   315→    def enter_fullscreen(self):\n   316→        \"\"\"进入全屏模式\"\"\"\n   317→        if not self.is_fullscreen:\n   318→            self.original_geometry = self.geometry()\n   319→            self.showFullScreen()\n   320→            self.is_fullscreen = True\n   321→            \n   322→    def exit_fullscreen(self):\n   323→        \"\"\"退出全屏模式\"\"\"\n   324→        if self.is_fullscreen:\n   325→            self.showNormal()\n   326→            if self.original_geometry:\n   327→                self.setGeometry(self.original_geometry)\n   328→            self.is_fullscreen = False\n   329→            \n   330→    def handle_escape_key(self):\n   331→        \"\"\"处理ESC键：如果是全屏则退出全屏，否则关闭对话框\"\"\"\n   332→        if self.is_fullscreen:\n   333→            self.exit_fullscreen()\n   334→        else:\n   335→            self.accept()  # 关闭对话框\n   336→            \n   337→    def copy_text_to_clipboard(self, text: str):\n   338→        \"\"\"复制文本到剪贴板并显示提示\"\"\"\n   339→        from PySide6.QtWidgets import QApplication\n   340→        clipboard = QApplication.clipboard()\n   341→        clipboard.setText(text)\n   342→        self.show_copy_toast(f\"已复制: {text[:30]}...\" if len(text) > 30 else f\"已复制: {text}\")\n   343→        \n   344→    def show_copy_toast(self, message: str):\n   345→        \"\"\"显示复制成功的轻量提示\"\"\"\n   346→        # 创建一个临时的提示标签\n   347→        toast = QLabel(message, self)\n   348→        toast.setObjectName(\"ToastLabel\")\n   349→        toast.setAlignment(Qt.AlignCenter)\n   350→        toast.adjustSize()\n   351→        \n   352→        # 定位到窗口中央偏上\n   353→        x = (self.width() - toast.width()) // 2\n   354→        y = self.height() // 4\n   355→        toast.move(x, y)\n   356→        toast.show()\n   357→        \n   358→        # 2秒后自动隐藏\n   359→        QTimer.singleShot(2000, toast.deleteLater)\n   360→        \n   361→    def copy_prompt(self):\n   362→        \"\"\"复制提示词到剪贴板\"\"\"\n   363→        prompt_content = self.prompt_text_edit.toPlainText()\n   364→        self.copy_text_to_clipboard(prompt_content)\n   365→    \n   366→    def copy_image(self):\n   367→        \"\"\"复制图片到剪贴板\"\"\"\n   368→        from PySide6.QtWidgets import QApplication\n   369→        image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')\n   370→        if image_path and os.path.exists(image_path):\n   371→            pixmap = QPixmap(image_path)\n   372→            if not pixmap.isNull():\n   373→                clipboard = QApplication.clipboard()\n   374→                clipboard.setPixmap(pixmap)\n   375→                self.show_copy_toast(\"图片已复制到剪贴板\")\n   376→            else:\n   377→                self.show_copy_toast(\"无法复制图片\")\n   378→        else:\n   379→            self.show_copy_toast(\"图片文件不存在\")\n   380→    \n   381→    def copy_all_info(self):\n   382→        \"\"\"复制所有信息到剪贴板\"\"\"\n   383→        from PySide6.QtWidgets import QApplication\n   384→        \n   385→        params = self.image_data.get('parameters', '{}')\n   386→        if isinstance(params, str):\n   387→            try:\n   388→                params = json.loads(params)\n   389→            except:\n   390→                params = {}\n   391→        \n   392→        info_text = f\"\"\"图片详细信息\n   393→===================\n   394→提示词: {self.image_data.get('prompt', '无提示词')}\n   395→尺寸: {params.get('size', '未知')}\n   396→种子值: {params.get('seed', '未知')}\n   397→引导强度: {params.get('guidance_scale', '未知')}\n   398→生成模型: {params.get('model', '未知模型')}\n   399→生成时间: {self.format_time(self.image_data.get('created_at', ''))}\n   400→文件大小: {self.format_file_size(self.image_data.get('file_size', 0))}\n   401→文件路径: {self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')}\n   402→\"\"\"\n   403→        \n   404→        clipboard = QApplication.clipboard()\n   405→        clipboard.setText(info_text)\n   406→        self.show_copy_toast(\"所有信息已复制到剪贴板\")\n   407→\n   408→    def show_copy_message(self, message: str):\n   409→        \"\"\"显示复制成功消息（已弃用，使用show_copy_toast代替）\"\"\"\n   410→        # 直接使用轻量级Toast提示\n   411→        self.show_copy_toast(message)\n   412→\n   413→    def _delete_current_record(self):\n   414→        \"\"\"删除当前记录及相关文件\"\"\"\n   415→        record_id = self._resolve_record_id()\n   416→        if not record_id:\n   417→            self.show_copy_toast(\"无法获取记录ID\")\n   418→            return\n   419→        \n   420→        try:\n   421→            # 获取 RepositoryManager\n   422→            from config_api import get_storage_dir\n   423→            from modules.repository.manager import RepositoryManager\n   424→            \n   425→            storage_dir = get_storage_dir()\n   426→            repo = RepositoryManager(storage_dir)\n   427→            \n   428→            # 执行删除\n   429→            if repo.delete_record_with_files(record_id):\n   430→                self.show_copy_toast(\"记录已删除\")\n   431→                \n   432→                # 发出信号通知父视图刷新\n   433→                self.recordDeleted.emit(record_id)\n   434→                \n   435→                # 从列表中移除当前记录\n   436→                if len(self.image_list) > 1:\n   437→                    del self.image_list[self.current_index]\n   438→                    \n   439→                    # 导航到后一条记录（保持索引，指向原来的下一条）\n   440→                    # 只有当删除的是最后一条时，才需要调整索引\n   441→                    if self.current_index >= len(self.image_list):\n   442→                        self.current_index = len(self.image_list) - 1\n   443→                    \n   444→                    self.load_current_image()\n   445→                    self.update_navigation_buttons()\n   446→                else:\n   447→                    # 只剩一条记录，关闭对话框\n   448→                    self.accept()\n   449→            else:\n   450→                self.show_copy_toast(\"删除失败\")\n   451→        except Exception as e:\n   452→            from utils.logger import logger\n   453→            logger.error(f\"删除记录异常: {e}\")\n   454→            self.show_copy_toast(f\"删除失败: {str(e)}\")\n   455→\n   456→    def _on_reference_clicked(self, asset: Dict[str, Any]):\n   457→        assets = list(self._reference_assets) if self._reference_assets else [asset]\n   458→        start_idx = _find_reference_asset_index(assets, asset)\n   459→        open_reference_preview(\n   460→            self,\n   461→            asset,\n   462→            title_prefix=\"参考图\",\n   463→            asset_list=assets,\n   464→            start_index=start_idx,\n   465→            on_asset_changed=self._sync_reference_selection,\n   466→        )\n   467→\n   468→    def _on_reference_export(self, asset: Dict[str, Any]):\n   469→        export_reference_asset(self, asset)\n   470→\n   471→    def _on_reference_selection_changed(self, asset: Dict[str, Any]):\n   472→        asset_path = None\n   473→        if isinstance(asset, dict):\n   474→            asset_path = asset.get('absolute_path') or asset.get('path')\n   475→        has_path = bool(asset_path and os.path.exists(asset_path))\n   476→        if hasattr(self, 'reference_export_btn'):\n   477→            self.reference_export_btn.setEnabled(has_path)\n   478→\n   479→    def _export_selected_reference(self):\n   480→        asset = self.reference_gallery.current_asset() if hasattr(self, 'reference_gallery') else None\n   481→        if not asset:\n   482→            QMessageBox.information(self, \"导出参考图\", \"请先选择参考图\")\n   483→            return\n   484→        export_reference_asset(self, asset)\n   485→\n   486→    def _refresh_reference_gallery(self):\n   487→        if not hasattr(self, 'reference_gallery'):\n   488→            return\n   489→        self._reference_summary = ensure_reference_info(self.image_data)\n   490→        if self._reference_summary.get('count', 0) <= 0:\n   491→            self.reference_gallery.clear()\n   492→            self.reference_gallery.setVisible(False)\n   493→            if hasattr(self, 'reference_export_btn'):\n   494→                self.reference_export_btn.setEnabled(False)\n   495→            self._reference_assets = []\n   496→            self._export_controller.refresh()\n   497→            return\n   498→        try:\n   499→            self._reference_assets = resolve_reference_assets(self.image_data, absolute=True)\n   500→        except Exception:\n   501→            self._reference_assets = []\n   502→        self.reference_gallery.setVisible(True)\n   503→        self.reference_gallery.set_assets(self._reference_assets)\n   504→        self._on_reference_selection_changed(self.reference_gallery.current_asset())\n   505→        self._export_controller.refresh()\n   506→\n   507→    def _sync_reference_selection(self, asset: Dict[str, Any]):\n   508→        try:\n   509→            self.reference_gallery.select_asset(asset)\n   510→        except Exception:\n   511→            pass\n   512→\n   513→    def _resolve_record_id(self) -> Optional[str]:\n   514→        for key in (\"file_id\", \"id\", \"generation_id\"):\n   515→            value = self.image_data.get(key)\n   516→            if value not in (None, \"\"):\n   517→                return str(value)\n   518→        return None\n   519→\n   520→    def show_context_menu(self, position):\n   521→        \"\"\"显示右键菜单\"\"\"\n   522→        from PySide6.QtWidgets import QMenu\n   523→        from PySide6.QtGui import QAction, QShortcut\n   524→        \n   525→        menu = QMenu(self)\n   526→        \n   527→        # 复制图片动作\n   528→        copy_action = QAction(\"复制图片\", self)\n   529→        copy_action.triggered.connect(self.copy_image)\n   530→        menu.addAction(copy_action)\n   531→        \n   532→        # 下载图片动作\n   533→        download_action = QAction(\"下载图片\", self)\n   534→        download_action.triggered.connect(self.download_image)\n   535→        menu.addAction(download_action)\n   536→        \n   537→        # 显示菜单\n   538→        menu.exec(self.large_image_label.mapToGlobal(position))\n   539→    \n   540→    def download_image(self):\n   541→        \"\"\"下载图片到指定位置\"\"\"\n   542→        from PySide6.QtWidgets import QFileDialog, QMessageBox\n   543→        import shutil\n   544→        \n   545→        image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')\n   546→        if not image_path or not os.path.exists(image_path):\n   547→            self.show_styled_message(\"错误\", \"图片文件不存在\", \"warning\")\n   548→            return\n   549→        \n   550→        # 获取原始文件名\n   551→        original_filename = os.path.basename(image_path)\n   552→        \n   553→        # 打开保存对话框\n   554→        save_path, _ = QFileDialog.getSaveFileName(\n   555→            self,\n   556→            \"保存图片\",\n   557→            original_filename,\n   558→            \"图片文件 (*.png *.jpg *.jpeg *.bmp *.gif)\"\n   559→        )\n   560→        \n   561→        if save_path:\n   562→            try:\n   563→                shutil.copy2(image_path, save_path)\n   564→                self.show_styled_message(\"成功\", f\"图片已保存到:\\n{save_path}\", \"information\")\n   565→            except Exception as e:\n   566→                self.show_styled_message(\"错误\", f\"保存图片失败:\\n{str(e)}\", \"critical\")\n   567→    \n   568→    def update_navigation_buttons(self):\n   569→        \"\"\"更新导航按钮状态（基于有效记录检查）\"\"\"\n   570→        # 检查是否有图片列表\n   571→        if len(self.image_list) <= 1:\n   572→            self.prev_btn.setEnabled(False)\n   573→            self.next_btn.setEnabled(False)\n   574→            self.prev_btn.setToolTip(\"没有更多图片\")\n   575→            self.next_btn.setToolTip(\"没有更多图片\")\n   576→            return\n   577→        \n   578→        # 更新按钮状态（基于有效记录检查）\n   579→        self.prev_btn.setEnabled(self._has_valid_previous_record())\n   580→        self.next_btn.setEnabled(self._has_valid_next_record())\n   581→        \n   582→        # 更新工具提示显示当前位置和快捷键信息\n   583→        current_pos = f\"({self.current_index + 1}/{len(self.image_list)})\"\n   584→        self.prev_btn.setToolTip(f\"上一张 {current_pos} - 快捷键: ←\")\n   585→        self.next_btn.setToolTip(f\"下一张 {current_pos} - 快捷键: →\")\n   586→        \n   587→        # 按钮文本保持简洁的箭头符号\n   588→        self.prev_btn.setText(\"◀\")\n   589→    \n   590→    def _has_valid_previous_record(self):\n   591→        \"\"\"检查是否有有效的上一个记录\"\"\"\n   592→        for i in range(self.current_index - 1, -1, -1):\n   593→            candidate_data = self.image_list[i]\n   594→            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n   595→            if file_path and os.path.exists(file_path):\n   596→                return True\n   597→        return False\n   598→    \n   599→    def _has_valid_next_record(self):\n   600→        \"\"\"检查是否有有效的下一个记录\"\"\"\n   601→        for i in range(self.current_index + 1, len(self.image_list)):\n   602→            candidate_data = self.image_list[i]\n   603→            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n   604→            if file_path and os.path.exists(file_path):\n   605→                return True\n   606→        return False\n   607→    \n   608→    def show_previous_image(self):\n   609→        \"\"\"显示上一张图片（带有效性验证）\"\"\"\n   610→        # 寻找上一个有效记录\n   611→        for i in range(self.current_index - 1, -1, -1):\n   612→            candidate_data = self.image_list[i]\n   613→            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n   614→            \n   615→            if file_path and os.path.exists(file_path):\n   616→                # 找到有效记录\n   617→                self.current_index = i\n   618→                self.load_current_image()\n   619→                self.update_navigation_buttons()\n   620→                return\n   621→        \n   622→        # 没有找到有效的上一个记录，保持当前状态\n   623→        self.update_navigation_buttons()\n   624→    \n   625→    def show_next_image(self):\n   626→        \"\"\"显示下一张图片（带有效性验证）\"\"\"\n   627→        # 寻找下一个有效记录\n   628→        for i in range(self.current_index + 1, len(self.image_list)):\n   629→            candidate_data = self.image_list[i]\n   630→            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n   631→            \n   632→            if file_path and os.path.exists(file_path):\n   633→                # 找到有效记录\n   634→                self.current_index = i\n   635→                self.load_current_image()\n   636→                self.update_navigation_buttons()\n   637→                return\n   638→        \n   639→        # 没有找到有效的下一个记录，保持当前状态\n   640→        self.update_navigation_buttons()\n   641→    \n   642→    def load_current_image(self):\n   643→        \"\"\"加载当前索引的图片\"\"\"\n   644→        if 0 <= self.current_index < len(self.image_list):\n   645→            # 更新当前图片数据\n   646→            self.image_data = self.image_list[self.current_index]\n   647→            \n   648→            # 重新加载图片\n   649→            image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '') or self.image_data.get('file_path', '')\n   650→            if image_path and os.path.exists(image_path):\n   651→                pixmap = QPixmap(image_path)\n   652→                if not pixmap.isNull():\n   653→                    self.large_image_label.setPixmap(pixmap)\n   654→                else:\n   655→                    self.large_image_label.setText(\"图片加载失败\")\n   656→            else:\n   657→                self.large_image_label.setText(\"图片不存在\")\n   658→            \n   659→            # 更新窗口标题\n   660→            self.setWindowTitle(f\"图片详细信息 ({self.current_index + 1}/{len(self.image_list)})\")\n   661→            \n   662→            # 更新提示词内容\n   663→            prompt_content = self.image_data.get('prompt', '无提示词')\n   664→            self.prompt_text_edit.setPlainText(prompt_content)\n   665→            \n   666→            # 更新参数信息\n   667→            self.update_params_area()\n   668→            self._refresh_reference_gallery()\n   669→\n   670→        self._export_controller.refresh()\n   671→    \n   672→    def setup_params_area(self):\n   673→        \"\"\"初始化参数显示区域\"\"\"\n   674→        # Ensure this area is deterministic (avoid stale/duplicated widgets across refresh/theme changes)\n   675→        self._clear_params_layout()\n   676→\n   677→        # 解析生成参数\n   678→        params = self.image_data.get('parameters', '{}')\n   679→        if isinstance(params, str):\n   680→            try:\n   681→                params = json.loads(params)\n   682→            except:\n   683→                params = {}\n   684→        \n   685→        # 提示词区域（可滚动查看全文）\n   686→        prompt_label = QLabel(\"<b>提示词:</b>\")\n   687→        prompt_label.setStyleSheet(\"margin: 0px; padding: 2px 0px;\")\n   688→        unified_style_system.apply_to_widget(prompt_label)\n   689→        self.params_layout.addWidget(prompt_label)\n   690→        \n   691→        # 提示词文本框\n   692→        prompt_content = self.image_data.get('prompt', '无提示词')\n   693→        self.prompt_text_edit = QTextEdit()\n   694→        self.prompt_text_edit.setPlainText(prompt_content)\n   695→        self.prompt_text_edit.setReadOnly(True)  # 只读模式\n   696→        # 约 4 行高度（按当前字体动态计算），避免信息区过高压缩其它内容\n   697→        try:\n   698→            line_height = self.prompt_text_edit.fontMetrics().lineSpacing()\n   699→            target_lines = 4\n   700→            vertical_padding = 16  # 与全局 QTextEdit padding (8*2) 对齐\n   701→            border = 2  # 1px*2\n   702→            height = line_height * target_lines + vertical_padding + border\n   703→            self.prompt_text_edit.setFixedHeight(max(72, int(height)))\n   704→        except Exception:\n   705→            self.prompt_text_edit.setMaximumHeight(96)\n   706→            self.prompt_text_edit.setMinimumHeight(96)\n   707→        self.prompt_text_edit.setVerticalScrollBarPolicy(Qt.ScrollBarAsNeeded)\n   708→        self.prompt_text_edit.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)\n   709→        unified_style_system.apply_to_widget(self.prompt_text_edit)\n   710→        # 应用与 _update_theme 一致的额外样式\n   711→        colors = unified_style_system.get_colors()\n   712→        bg_input = colors.get('palette.neutral.bg_input') or colors.get('palette.neutral.bg_card')\n   713→        text_color = colors.get('text') or colors.get('palette.text.primary')\n   714→        border_subtle = colors.get('palette.neutral.border_subtle') or colors.get('border')\n   715→        brand = colors.get('palette.brand.main') or colors.get('primary')\n   716→        self.prompt_text_edit.setStyleSheet(f\"\"\"\n   717→            QTextEdit {{\n   718→                background-color: {bg_input};\n   719→                color: {text_color};\n   720→                border: 1px solid {border_subtle};\n   721→                border-radius: 8px;\n   722→                padding: 8px;\n   723→            }}\n   724→            QTextEdit:focus {{\n   725→                border-color: {brand};\n   726→            }}\n   727→        \"\"\")\n   728→        self.params_layout.addWidget(self.prompt_text_edit)\n   729→        \n   730→        # 添加复制提示词按钮（使用统一的 SecondaryButton 样式）\n   731→        self.copy_prompt_btn = QPushButton(\"复制提示词\")\n   732→        self.copy_prompt_btn.setObjectName(\"SecondaryButton\")\n   733→        self.copy_prompt_btn.setMaximumHeight(30)\n   734→        unified_style_system.apply_to_widget(self.copy_prompt_btn)\n   735→        self.copy_prompt_btn.clicked.connect(self.copy_prompt)\n   736→        self.params_layout.addWidget(self.copy_prompt_btn)\n   737→        \n   738→        # 存储参数标签列表，用于后续清理\n   739→        self.param_labels = []\n   740→        self.create_param_labels()\n   741→\n   742→    def _clear_params_layout(self):\n   743→        \"\"\"清空参数区布局中的所有控件（保留布局本身），避免重复/遮挡。\"\"\"\n   744→        if not hasattr(self, \"params_layout\") or self.params_layout is None:\n   745→            return\n   746→        while self.params_layout.count() > 0:\n   747→            item = self.params_layout.takeAt(0)\n   748→            w = item.widget()\n   749→            if w is not None:\n   750→                w.hide()  # 立即隐藏，避免 deleteLater 异步导致残留显示\n   751→                w.setParent(None)  # 断开父子关系\n   752→                w.deleteLater()\n   753→    \n   754→    def _update_theme(self):\n   755→        \"\"\"响应主题变化\"\"\"\n   756→        colors = unified_style_system.get_colors()\n   757→        logger.info(f\"[ImageDetailDialog] _update_theme called. Surface color: {colors.get('palette.neutral.bg_surface')}\")\n   758→        \n   759→        # Apply theme to self (Dialog)\n   760→        bg_color = colors.get('palette.neutral.bg_surface') or colors.get('palette.neutral.bg_app') or colors.get('background')\n   761→        text_color = colors.get('text') or colors.get('palette.text.primary')\n   762→        bg_card = colors.get('palette.neutral.bg_card') or colors.get('surface') or bg_color\n   763→        bg_input = colors.get('palette.neutral.bg_input') or bg_card\n   764→        border_subtle = colors.get('palette.neutral.border_subtle') or colors.get('border')\n   765→        brand = colors.get('palette.brand.main') or colors.get('primary') or text_color\n   766→        \n   767→        self.setStyleSheet(f\"\"\"\n   768→            QDialog {{\n   769→                background-color: {bg_color};\n   770→                color: {text_color};\n   771→            }}\n   772→            QLabel {{\n   773→                color: {text_color};\n   774→            }}\n   775→            QWidget#ParamsWidget {{\n   776→                 background-color: {bg_card};\n   777→                 border-left: 1px solid {border_subtle};\n   778→            }}\n   779→        \"\"\")\n   780→\n   781→        if hasattr(self, 'prompt_text_edit'):\n   782→            self.prompt_text_edit.setStyleSheet(f\"\"\"\n   783→                QTextEdit {{\n   784→                    background-color: {bg_input};\n   785→                    color: {text_color};\n   786→                    border: 1px solid {border_subtle};\n   787→                    border-radius: 8px;\n   788→                    padding: 8px;\n   789→                }}\n   790→                QTextEdit:focus {{\n   791→                    border-color: {brand};\n   792→                }}\n   793→            \"\"\")\n   794→\n   795→        # Reapply button styles\n   796→        if hasattr(self, 'fullscreen_btn'):\n   797→            unified_style_system.apply_to_widget(self.fullscreen_btn)\n   798→        if hasattr(self, 'copy_image_btn'):\n   799→            unified_style_system.apply_to_widget(self.copy_image_btn)\n   800→        if hasattr(self, 'delete_btn'):\n   801→            unified_style_system.apply_to_widget(self.delete_btn, extra={'variant': 'danger'})\n   802→        if hasattr(self, 'close_btn'):\n   803→            unified_style_system.apply_to_widget(self.close_btn)\n   804→        if hasattr(self, 'reference_export_btn'):\n   805→            unified_style_system.apply_to_widget(self.reference_export_btn)\n   806→        if hasattr(self, 'export_bundle_btn'):\n   807→            unified_style_system.apply_to_widget(self.export_bundle_btn)\n   808→        if hasattr(self, 'prev_btn'):\n   809→            unified_style_system.apply_to_widget(self.prev_btn)\n   810→        if hasattr(self, 'next_btn'):\n   811→            unified_style_system.apply_to_widget(self.next_btn)\n   812→\n   813→        # Rebuild to ensure all param widgets pick up new palette and no stale widgets remain\n   814→        self.setup_params_area()\n   815→\n   816→    def create_param_labels(self):\n   817→        \"\"\"创建参数标签（初始化或更新时调用）\"\"\"\n   818→        # 清除旧的参数标签 - Fix Race Condition\n   819→        if hasattr(self, 'param_labels'):\n   820→            for label_pair in self.param_labels:\n   821→                # 必须先从布局中移除，防止 deleteLater 的异步销毁导致重影\n   822→                self.params_layout.removeWidget(label_pair[0])\n   823→                self.params_layout.removeWidget(label_pair[1])\n   824→                label_pair[0].deleteLater()  # 删除标题标签\n   825→                label_pair[1].deleteLater()  # 删除值标签\n   826→            self.param_labels.clear()\n   827→        else:\n   828→            self.param_labels = []\n   829→        \n   830→        # 解析生成参数\n   831→        params = self.image_data.get('parameters', '{}')\n   832→        if isinstance(params, str):\n   833→            try:\n   834→                params = json.loads(params)\n   835→            except:\n   836→                params = {}\n   837→        \n   838→        # 详细信息\n   839→        info_items = [\n   840→            (\"尺寸\", f\"{params.get('size', '未知')}\"),\n   841→            (\"种子值\", f\"{params.get('seed', '未知')}\"),\n   842→            (\"引导强度\", f\"{params.get('guidance_scale', '未知')}\"),\n   843→            (\"生成模型\", f\"{params.get('model', '未知模型')}\"),\n   844→            (\"生成时间\", self.format_time(self.image_data.get('created_at', ''))),\n   845→            (\"文件大小\", self.format_file_size(self.image_data.get('file_size', 0))),\n   846→            (\"文件路径\", self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')),\n   847→        ]\n   848→        \n   849→        # 如果是图生图，显示参考图信息\n   850→        if params.get('model', '').find('i2i') != -1:\n   851→            info_items.insert(-2, (\"生成类型\", \"图生图\"))\n   852→            input_image = self.image_data.get('input_image', '')\n   853→            if input_image:\n   854→                info_items.insert(-2, (\"参考图片\", input_image))\n   855→        else:\n   856→            info_items.insert(-2, (\"生成类型\", \"文生图\"))\n   857→        \n   858→        colors = unified_style_system.get_colors()\n   859→        bg_tag = colors.get('palette.neutral.bg_surface') or colors.get('palette.neutral.bg_card') or colors.get('surface')\n   860→        border_tag = colors.get('palette.neutral.border_subtle') or colors.get('border')\n   861→        text_tag = colors.get('text') or colors.get('palette.text.primary')\n   862→        hover_bg = colors.get('palette.neutral.bg_hover') or bg_tag\n   863→        hover_border = colors.get('palette.brand.main') or colors.get('primary') or border_tag\n   864→\n   865→        for label, value in info_items:\n   866→            label_widget = QLabel(f\"<b>{label}:</b>\")\n   867→            label_widget.setStyleSheet(\"margin: 0px; padding: 2px 0px;\")\n   868→            unified_style_system.apply_to_widget(label_widget)\n   869→            self.params_layout.addWidget(label_widget)\n   870→            \n   871→            # 使用可点击的标签\n   872→            value_clickable = ClickableLabel(str(value))\n   873→            value_clickable.set_text_with_ellipsis(str(value), int(self.width() * 0.25))\n   874→            # File path is long and can otherwise expand to fill the panel, overlapping the prompt area.\n   875→            # Keep it single-line with ellipsis and fixed height.\n   876→            if label == \"文件路径\":\n   877→                value_clickable.setWordWrap(False)\n   878→                value_clickable.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)\n   879→                value_clickable.setFixedHeight(32)\n   880→                value_clickable.setToolTip(str(value))\n   881→            else:\n   882→                value_clickable.setWordWrap(True)\n   883→            # 使用动态样式\n   884→            value_clickable.setStyleSheet(f\"\"\"\n   885→                QLabel {{\n   886→                    margin: 0px; \n   887→                    padding: 6px; \n   888→                    background-color: {bg_tag}; \n   889→                    color: {text_tag};\n   890→                    border: 1px solid {border_tag};\n   891→                    border-radius: 4px;\n   892→                }}\n   893→                QLabel:hover {{\n   894→                    background-color: {hover_bg};\n   895→                    border-color: {hover_border};\n   896→                }}\n   897→            \"\"\")\n   898→            unified_style_system.apply_to_widget(value_clickable)\n   899→            value_clickable.clicked.connect(self.copy_text_to_clipboard)\n   900→            self.params_layout.addWidget(value_clickable)\n   901→            \n   902→            # 保存标签引用\n   903→            self.param_labels.append((label_widget, value_clickable))\n   904→\n   905→        # Ensure remaining vertical space doesn't get assigned to the last label widget.\n   906→        self.params_layout.addStretch(1)\n   907→    \n   908→    def update_params_area(self):\n   909→        \"\"\"更新参数显示区域（切换图片时调用）\"\"\"\n   910→        # Full rebuild avoids duplicated/stale widgets (e.g. file path blocks prompt area)\n   911→        self.setup_params_area()\n   912→\n   913→    def closeEvent(self, event):\n   914→        try:\n   915→            if hasattr(self, '_focus_timer') and self._focus_timer.isActive():\n   916→                self._focus_timer.stop()\n   917→        except Exception:\n   918→            pass\n   919→\n   920→        try:\n   921→            self._export_controller.dispose()\n   922→        except Exception:\n   923→            pass\n   924→\n   925→        super().closeEvent(event)\n   926→    \n   927→    def keyPressEvent(self, event):\n   928→        \"\"\"键盘事件处理\"\"\"\n   929→        from PySide6.QtCore import Qt\n   930→        \n   931→        logger.debug(f\"[KEYBOARD] ImageDetailDialog键盘事件: {event.key()}\")\n   932→        \n   933→        if event.key() == Qt.Key_Left:\n   934→            # 左方向键：上一张图片\n   935→            if self.prev_btn.isEnabled():\n   936→                self.show_previous_image()\n   937→            event.accept()\n   938→        elif event.key() == Qt.Key_Right:\n   939→            # 右方向键：下一张图片\n   940→            if self.next_btn.isEnabled():\n   941→                self.show_next_image()\n   942→            event.accept()\n   943→        elif event.key() == Qt.Key_Escape:\n   944→            # ESC键：关闭对话框（保持原有功能）\n   945→            logger.debug(f\"[KEYBOARD] ESC键pressed，fullscreen: {self.is_fullscreen}\")\n   946→            if self.is_fullscreen:\n   947→                self.exit_fullscreen()\n   948→            else:\n   949→                self.accept()\n   950→            event.accept()\n   951→        elif event.key() == Qt.Key_F11:\n   952→            # F11键：全屏切换（保持原有功能）\n   953→            self.toggle_fullscreen()\n   954→            event.accept()\n   955→        else:\n   956→            # 其他按键交给父类处理\n   957→            super().keyPressEvent(event)\n   958→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"db87cec5-c5f8-4ab6-a61c-2d086b47cc1f","timestamp":"2025-12-22T04:15:54.104Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/components/dialogs/image_detail_dialog.py","content":"import os\nimport json\nfrom datetime import datetime\nfrom typing import Dict, Any, List, Optional\n\nfrom PySide6.QtWidgets import (\n    QDialog, QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton,\n    QTextEdit, QFileDialog, QMessageBox, QSplitter, QApplication,\n    QMenu, QSizePolicy\n)\nfrom PySide6.QtGui import QAction, QShortcut\nfrom PySide6.QtCore import Qt, QTimer, QSize, QEvent\nfrom PySide6.QtGui import QPixmap, QKeySequence\n\nfrom utils.logger import logger\nfrom utils.style_system import unified_style_system\nfrom components.widgets import ZoomableImageLabel, ClickableLabel\nfrom components.reference_assets import (\n    ReferenceGalleryWidget,\n    export_reference_asset,\n    open_reference_preview,\n    _find_reference_asset_index,\n)\nfrom components.controllers import ExportBundleController\nfrom utils.reference_display import ensure_reference_info, resolve_reference_assets\nfrom PySide6.QtCore import Signal\n\nclass ImageDetailDialog(QDialog):\n    \"\"\"图片详细信息对话框\"\"\"\n    \n    # 删除记录后发出信号，通知父视图刷新\n    recordDeleted = Signal(str)  # 参数为被删除的记录ID\n    \n    def __init__(self, image_data: Dict[str, Any], image_list: List[Dict[str, Any]] = None, current_index: int = 0, parent=None):\n        super().__init__(parent)\n        self.image_data = image_data\n        self.image_list = image_list or [image_data]  # 图片列表\n        self.current_index = current_index  # 当前图片索引\n        self.zoom_factor = 1.0  # 缩放因子\n        self.is_fullscreen = False  # 全屏状态\n        self.original_geometry = None  # 原始窗口几何\n        self._reference_summary = ensure_reference_info(self.image_data)\n        self._reference_assets: List[Dict[str, Any]] = []\n        self._export_controller = ExportBundleController(self, \"image\")\n        \n        # Subscribe to theme changes\n        unified_style_system.styleChanged.connect(self._update_theme)\n        \n        self.setup_ui()\n        \n    def setup_ui(self):\n        \"\"\"设置UI\"\"\"\n        self.setWindowTitle(\"图片详细信息\")\n        self.resize(1100, 800)  # 改为可调整大小\n        self.setMinimumSize(800, 600)  # 设置最小尺寸\n        \n        # 设置焦点策略，确保能接收键盘事件\n        self.setFocusPolicy(Qt.StrongFocus)\n        self.setAttribute(Qt.WA_KeyCompression, False)  # 禁用键盘事件压缩\n        self.setFocus()\n\n        # 确保窗口激活时获得焦点\n        self.activateWindow()\n        self.raise_()\n\n        try:\n            self.setObjectName(\"DetailDialog\")\n        except Exception:\n            pass\n\n        self._focus_timer = QTimer(self)\n        self._focus_timer.setSingleShot(True)\n        self._focus_timer.timeout.connect(self._ensure_focus)\n\n        layout = QHBoxLayout(self)\n        \n        # 左侧：大图显示（占70%宽度）\n        left_widget = QWidget()\n        left_layout = QVBoxLayout(left_widget)\n        left_layout.setContentsMargins(0, 0, 0, 0)\n        \n        # 图片显示区域（占据上方全部空间）\n        image_container = QWidget()\n        image_container.setObjectName(\"ImageContainer\")\n        image_container.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)\n\n        # 在容器内创建布局\n        container_layout = QVBoxLayout(image_container)\n        container_layout.setContentsMargins(0, 0, 0, 0)\n        container_layout.setSpacing(0)\n\n        # 使用可缩放的图片标签，自适应容器大小\n        self.large_image_label = ZoomableImageLabel()\n        self.large_image_label.setAlignment(Qt.AlignCenter)\n        self.large_image_label.setStyleSheet(\"border: none; background-color: transparent;\")\n        \n        # 设置右键菜单\n        self.large_image_label.setContextMenuPolicy(Qt.CustomContextMenu)\n        self.large_image_label.customContextMenuRequested.connect(self.show_context_menu)\n        \n        # 加载大图\n        image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')\n        if image_path and os.path.exists(image_path):\n            pixmap = QPixmap(image_path)\n            if not pixmap.isNull():\n                self.large_image_label.setPixmap(pixmap)\n        \n        container_layout.addWidget(self.large_image_label, 1)\n\n        reference_section = QWidget()\n        reference_section.setObjectName(\"ReferenceSection\")\n        reference_section.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)\n        reference_section_layout = QVBoxLayout(reference_section)\n        reference_section_layout.setContentsMargins(0, 0, 0, 0)\n        reference_section_layout.setSpacing(8)\n\n        self.reference_gallery = ReferenceGalleryWidget()\n        self.reference_gallery.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)\n        try:\n            self.reference_gallery.referenceClicked.connect(self._on_reference_clicked)\n            self.reference_gallery.exportRequested.connect(self._on_reference_export)\n            self.reference_gallery.selectionChanged.connect(self._on_reference_selection_changed)\n        except Exception:\n            pass\n        reference_section_layout.addWidget(self.reference_gallery, 1)\n\n        reference_button_layout = QHBoxLayout()\n        reference_button_layout.setContentsMargins(0, 0, 0, 0)\n        reference_button_layout.setSpacing(6)\n        self.export_status_label = QLabel(\"\")\n        self.export_status_label.setObjectName(\"infoLabel\")\n        unified_style_system.apply_to_widget(self.export_status_label)\n        reference_button_layout.addWidget(self.export_status_label)\n        reference_button_layout.addStretch(1)\n        self.reference_export_btn = QPushButton(\"导出选中参考图\")\n        self.reference_export_btn.setObjectName(\"SecondaryButton\")\n        self.reference_export_btn.setEnabled(False)\n        unified_style_system.apply_to_widget(self.reference_export_btn)\n        self.reference_export_btn.clicked.connect(self._export_selected_reference)\n        reference_button_layout.addWidget(self.reference_export_btn)\n        self.export_bundle_btn = QPushButton(\"导出记录\")\n        self.export_bundle_btn.setObjectName(\"SecondaryButton\")\n        self.export_bundle_btn.setEnabled(False)\n        unified_style_system.apply_to_widget(self.export_bundle_btn)\n        self._export_controller.configure(\n            self.export_bundle_btn,\n            self.export_status_label,\n            self._resolve_record_id,\n            context_widget=self,\n        )\n        reference_button_layout.addWidget(self.export_bundle_btn)\n        reference_section_layout.addLayout(reference_button_layout)\n\n        self._image_reference_splitter = QSplitter(Qt.Vertical)\n        self._image_reference_splitter.setObjectName(\"ImageReferenceSplitter\")\n        self._image_reference_splitter.setChildrenCollapsible(False)\n        self._image_reference_splitter.setHandleWidth(6)\n        self._image_reference_splitter.addWidget(image_container)\n        self._image_reference_splitter.addWidget(reference_section)\n        self._image_reference_splitter.setStretchFactor(0, 3)\n        self._image_reference_splitter.setStretchFactor(1, 2)\n        self._image_reference_splitter.setSizes([520, 280])\n\n        left_layout.addWidget(self._image_reference_splitter, 1)\n\n        # 底部区域：导航按钮 + 说明文本框（与右侧参数栏高度对齐）\n        bottom_layout = QHBoxLayout()\n        bottom_layout.setContentsMargins(0, 5, 0, 5)\n        bottom_layout.setSpacing(10)\n        \n        # 向左按钮\n        self.prev_btn = QPushButton(\"◀\")\n        self.prev_btn.setFixedSize(30, 30)  # 固定尺寸\n        self.prev_btn.setObjectName(\"NavButton\")\n        unified_style_system.apply_to_widget(self.prev_btn)\n        self.prev_btn.clicked.connect(self.show_previous_image)\n        bottom_layout.addWidget(self.prev_btn)\n        \n        # 中间的说明文本框（完全透明设计）\n        zoom_info = QLabel(\"提示：鼠标位置缩放，点击拖拽，双击重置\")\n        zoom_info.setObjectName(\"infoLabel\")\n        unified_style_system.apply_to_widget(zoom_info)\n        zoom_info.setAlignment(Qt.AlignCenter)\n        zoom_info.setMinimumHeight(30)  # 与按钮高度一致\n        zoom_info.setMaximumHeight(30)  # 固定高度，防止文字被压缩\n        bottom_layout.addWidget(zoom_info, 1)  # 占据中间所有空间\n        \n        # 向右按钮\n        self.next_btn = QPushButton(\"▶\")\n        self.next_btn.setFixedSize(30, 30)  # 固定尺寸\n        self.next_btn.setObjectName(\"NavButton\")\n        unified_style_system.apply_to_widget(self.next_btn)\n        self.next_btn.clicked.connect(self.show_next_image)\n        bottom_layout.addWidget(self.next_btn)\n        \n        left_layout.addLayout(bottom_layout)\n\n        # 更新导航按钮状态\n        self.update_navigation_buttons()\n        self._refresh_reference_gallery()\n        self._export_controller.refresh()\n\n        # 右侧：详细信息（固定30%宽度）\n        right_layout = QVBoxLayout()\n        \n        # 创建参数显示区域（不使用滚动条）\n        params_widget = QWidget()\n        params_widget.setFixedWidth(int(self.width() * 0.3))  # 固定30%宽度\n        params_widget.setObjectName(\"ParamsWidget\")\n        self.params_layout = QVBoxLayout(params_widget)  # 保存引用以便后续更新\n        self.params_layout.setSpacing(0)  # 设置间距为0\n        self.params_layout.setContentsMargins(5, 5, 5, 5)  # 设置紧凑的边距\n        \n        # 初始化参数显示区域\n        self.setup_params_area()\n        \n        \n        right_layout.addWidget(params_widget)\n        \n        # 全屏和复制图片按钮（与参数区底部对齐）\n        image_control_layout = QHBoxLayout()\n\n        self.fullscreen_btn = QPushButton(\"全屏 (F11)\")\n        self.fullscreen_btn.setMaximumHeight(30)\n        unified_style_system.apply_to_widget(self.fullscreen_btn)\n        self.fullscreen_btn.clicked.connect(self.toggle_fullscreen)\n        image_control_layout.addWidget(self.fullscreen_btn)\n\n        self.copy_image_btn = QPushButton(\"复制图片\")\n        self.copy_image_btn.setMaximumHeight(30)\n        unified_style_system.apply_to_widget(self.copy_image_btn)\n        self.copy_image_btn.clicked.connect(self.copy_image)\n        image_control_layout.addWidget(self.copy_image_btn)\n\n        right_layout.addLayout(image_control_layout)\n\n        # 其他按钮\n        button_layout = QHBoxLayout()\n\n        self.delete_btn = QPushButton(\"删除记录\")\n        unified_style_system.apply_to_widget(self.delete_btn, extra={'variant': 'danger'})\n        self.delete_btn.clicked.connect(self._delete_current_record)\n        button_layout.addWidget(self.delete_btn)\n\n        self.close_btn = QPushButton(\"关闭（ESC）\")\n        unified_style_system.apply_to_widget(self.close_btn)\n        self.close_btn.clicked.connect(self.accept)\n        button_layout.addWidget(self.close_btn)\n        \n        right_layout.addLayout(button_layout)\n        \n        # 设置布局比例：左侧70%，右侧30%\n        layout.addWidget(left_widget, 7)\n        layout.addLayout(right_layout, 3)\n        \n        # 添加键盘快捷键\n        self.setup_shortcuts()\n\n        # 延迟设置焦点，确保窗口完全初始化后获得焦点\n        self._focus_timer.start(100)\n\n        self._esc_shortcut = QShortcut(QKeySequence(Qt.Key_Escape), self)\n        self._esc_shortcut.activated.connect(self.handle_escape_key)\n        \n        # Apply initial theme\n        self._update_theme()\n    \n    def format_time(self, time_str: str) -> str:\n        \"\"\"格式化时间显示\"\"\"\n        if not time_str:\n            return '未知时间'\n        try:\n            dt = datetime.fromisoformat(time_str.replace('Z', '+00:00'))\n            return dt.strftime('%Y-%m-%d %H:%M:%S')\n        except:\n            return time_str[:19] if len(time_str) > 19 else time_str\n    \n    def format_file_size(self, size) -> str:\n        \"\"\"格式化文件大小显示\"\"\"\n        # 处理字符串类型的size\n        try:\n            size = float(size) if size else 0\n        except (ValueError, TypeError):\n            return '未知大小'\n            \n        if size == 0:\n            return '未知大小'\n        \n        for unit in ['B', 'KB', 'MB', 'GB']:\n            if size < 1024.0:\n                return f\"{size:.1f} {unit}\"\n            size /= 1024.0\n        return f\"{size:.1f} TB\"\n    \n    def setup_shortcuts(self):\n        \"\"\"设置键盘快捷键\"\"\"\n        # 移除所有QShortcut，统一使用keyPressEvent处理\n        # 避免快捷键冲突问题\n        pass\n    \n    def _ensure_focus(self):\n        \"\"\"确保窗口获得焦点\"\"\"\n        self.activateWindow()\n        self.raise_()\n        self.setFocus()\n        logger.debug(f\"[FOCUS] ImageDialog窗口焦点设置完成，hasFocus: {self.hasFocus()}\")\n        \n    def toggle_fullscreen(self):\n        \"\"\"切换全屏模式\"\"\"\n        if self.is_fullscreen:\n            self.exit_fullscreen()\n        else:\n            self.enter_fullscreen()\n            \n    def enter_fullscreen(self):\n        \"\"\"进入全屏模式\"\"\"\n        if not self.is_fullscreen:\n            self.original_geometry = self.geometry()\n            self.showFullScreen()\n            self.is_fullscreen = True\n            \n    def exit_fullscreen(self):\n        \"\"\"退出全屏模式\"\"\"\n        if self.is_fullscreen:\n            self.showNormal()\n            if self.original_geometry:\n                self.setGeometry(self.original_geometry)\n            self.is_fullscreen = False\n            \n    def handle_escape_key(self):\n        \"\"\"处理ESC键：如果是全屏则退出全屏，否则关闭对话框\"\"\"\n        if self.is_fullscreen:\n            self.exit_fullscreen()\n        else:\n            self.accept()  # 关闭对话框\n            \n    def copy_text_to_clipboard(self, text: str):\n        \"\"\"复制文本到剪贴板并显示提示\"\"\"\n        from PySide6.QtWidgets import QApplication\n        clipboard = QApplication.clipboard()\n        clipboard.setText(text)\n        self.show_copy_toast(f\"已复制: {text[:30]}...\" if len(text) > 30 else f\"已复制: {text}\")\n        \n    def show_copy_toast(self, message: str):\n        \"\"\"显示复制成功的轻量提示\"\"\"\n        # 创建一个临时的提示标签\n        toast = QLabel(message, self)\n        toast.setObjectName(\"ToastLabel\")\n        toast.setAlignment(Qt.AlignCenter)\n        toast.adjustSize()\n        \n        # 定位到窗口中央偏上\n        x = (self.width() - toast.width()) // 2\n        y = self.height() // 4\n        toast.move(x, y)\n        toast.show()\n        \n        # 2秒后自动隐藏\n        QTimer.singleShot(2000, toast.deleteLater)\n        \n    def copy_prompt(self):\n        \"\"\"复制提示词到剪贴板\"\"\"\n        prompt_content = self.prompt_text_edit.toPlainText()\n        self.copy_text_to_clipboard(prompt_content)\n    \n    def copy_image(self):\n        \"\"\"复制图片到剪贴板\"\"\"\n        from PySide6.QtWidgets import QApplication\n        image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')\n        if image_path and os.path.exists(image_path):\n            pixmap = QPixmap(image_path)\n            if not pixmap.isNull():\n                clipboard = QApplication.clipboard()\n                clipboard.setPixmap(pixmap)\n                self.show_copy_toast(\"图片已复制到剪贴板\")\n            else:\n                self.show_copy_toast(\"无法复制图片\")\n        else:\n            self.show_copy_toast(\"图片文件不存在\")\n    \n    def copy_all_info(self):\n        \"\"\"复制所有信息到剪贴板\"\"\"\n        from PySide6.QtWidgets import QApplication\n        \n        params = self.image_data.get('parameters', '{}')\n        if isinstance(params, str):\n            try:\n                params = json.loads(params)\n            except:\n                params = {}\n        \n        info_text = f\"\"\"图片详细信息\n===================\n提示词: {self.image_data.get('prompt', '无提示词')}\n尺寸: {params.get('size', '未知')}\n种子值: {params.get('seed', '未知')}\n引导强度: {params.get('guidance_scale', '未知')}\n生成模型: {params.get('model', '未知模型')}\n生成时间: {self.format_time(self.image_data.get('created_at', ''))}\n文件大小: {self.format_file_size(self.image_data.get('file_size', 0))}\n文件路径: {self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')}\n\"\"\"\n        \n        clipboard = QApplication.clipboard()\n        clipboard.setText(info_text)\n        self.show_copy_toast(\"所有信息已复制到剪贴板\")\n\n    def show_copy_message(self, message: str):\n        \"\"\"显示复制成功消息（已弃用，使用show_copy_toast代替）\"\"\"\n        # 直接使用轻量级Toast提示\n        self.show_copy_toast(message)\n\n    def _delete_current_record(self):\n        \"\"\"删除当前记录及相关文件\"\"\"\n        record_id = self._resolve_record_id()\n        if not record_id:\n            self.show_copy_toast(\"无法获取记录ID\")\n            return\n        \n        try:\n            # 获取 RepositoryManager\n            from config_api import get_storage_dir\n            from modules.repository.manager import RepositoryManager\n            \n            storage_dir = get_storage_dir()\n            repo = RepositoryManager(storage_dir)\n            \n            # 执行删除\n            if repo.delete_record_with_files(record_id):\n                self.show_copy_toast(\"记录已删除\")\n                \n                # 发出信号通知父视图刷新\n                self.recordDeleted.emit(record_id)\n                \n                # 从列表中移除当前记录\n                if len(self.image_list) > 1:\n                    del self.image_list[self.current_index]\n                    \n                    # 导航到后一条记录（保持索引，指向原来的下一条）\n                    # 只有当删除的是最后一条时，才需要调整索引\n                    if self.current_index >= len(self.image_list):\n                        self.current_index = len(self.image_list) - 1\n                    \n                    self.load_current_image()\n                    self.update_navigation_buttons()\n                else:\n                    # 只剩一条记录，关闭对话框\n                    self.accept()\n            else:\n                self.show_copy_toast(\"删除失败\")\n        except Exception as e:\n            from utils.logger import logger\n            logger.error(f\"删除记录异常: {e}\")\n            self.show_copy_toast(f\"删除失败: {str(e)}\")\n\n    def _on_reference_clicked(self, asset: Dict[str, Any]):\n        assets = list(self._reference_assets) if self._reference_assets else [asset]\n        start_idx = _find_reference_asset_index(assets, asset)\n        open_reference_preview(\n            self,\n            asset,\n            title_prefix=\"参考图\",\n            asset_list=assets,\n            start_index=start_idx,\n            on_asset_changed=self._sync_reference_selection,\n        )\n\n    def _on_reference_export(self, asset: Dict[str, Any]):\n        export_reference_asset(self, asset)\n\n    def _on_reference_selection_changed(self, asset: Dict[str, Any]):\n        asset_path = None\n        if isinstance(asset, dict):\n            asset_path = asset.get('absolute_path') or asset.get('path')\n        has_path = bool(asset_path and os.path.exists(asset_path))\n        if hasattr(self, 'reference_export_btn'):\n            self.reference_export_btn.setEnabled(has_path)\n\n    def _export_selected_reference(self):\n        asset = self.reference_gallery.current_asset() if hasattr(self, 'reference_gallery') else None\n        if not asset:\n            QMessageBox.information(self, \"导出参考图\", \"请先选择参考图\")\n            return\n        export_reference_asset(self, asset)\n\n    def _refresh_reference_gallery(self):\n        if not hasattr(self, 'reference_gallery'):\n            return\n        self._reference_summary = ensure_reference_info(self.image_data)\n        if self._reference_summary.get('count', 0) <= 0:\n            self.reference_gallery.clear()\n            self.reference_gallery.setVisible(False)\n            if hasattr(self, 'reference_export_btn'):\n                self.reference_export_btn.setEnabled(False)\n            self._reference_assets = []\n            self._export_controller.refresh()\n            return\n        try:\n            self._reference_assets = resolve_reference_assets(self.image_data, absolute=True)\n        except Exception:\n            self._reference_assets = []\n        self.reference_gallery.setVisible(True)\n        self.reference_gallery.set_assets(self._reference_assets)\n        self._on_reference_selection_changed(self.reference_gallery.current_asset())\n        self._export_controller.refresh()\n\n    def _sync_reference_selection(self, asset: Dict[str, Any]):\n        try:\n            self.reference_gallery.select_asset(asset)\n        except Exception:\n            pass\n\n    def _resolve_record_id(self) -> Optional[str]:\n        for key in (\"file_id\", \"id\", \"generation_id\"):\n            value = self.image_data.get(key)\n            if value not in (None, \"\"):\n                return str(value)\n        return None\n\n    def show_context_menu(self, position):\n        \"\"\"显示右键菜单\"\"\"\n        from PySide6.QtWidgets import QMenu\n        from PySide6.QtGui import QAction, QShortcut\n        \n        menu = QMenu(self)\n        \n        # 复制图片动作\n        copy_action = QAction(\"复制图片\", self)\n        copy_action.triggered.connect(self.copy_image)\n        menu.addAction(copy_action)\n        \n        # 下载图片动作\n        download_action = QAction(\"下载图片\", self)\n        download_action.triggered.connect(self.download_image)\n        menu.addAction(download_action)\n        \n        # 显示菜单\n        menu.exec(self.large_image_label.mapToGlobal(position))\n    \n    def download_image(self):\n        \"\"\"下载图片到指定位置\"\"\"\n        from PySide6.QtWidgets import QFileDialog, QMessageBox\n        import shutil\n        \n        image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')\n        if not image_path or not os.path.exists(image_path):\n            self.show_styled_message(\"错误\", \"图片文件不存在\", \"warning\")\n            return\n        \n        # 获取原始文件名\n        original_filename = os.path.basename(image_path)\n        \n        # 打开保存对话框\n        save_path, _ = QFileDialog.getSaveFileName(\n            self,\n            \"保存图片\",\n            original_filename,\n            \"图片文件 (*.png *.jpg *.jpeg *.bmp *.gif)\"\n        )\n        \n        if save_path:\n            try:\n                shutil.copy2(image_path, save_path)\n                self.show_styled_message(\"成功\", f\"图片已保存到:\\n{save_path}\", \"information\")\n            except Exception as e:\n                self.show_styled_message(\"错误\", f\"保存图片失败:\\n{str(e)}\", \"critical\")\n    \n    def update_navigation_buttons(self):\n        \"\"\"更新导航按钮状态（基于有效记录检查）\"\"\"\n        # 检查是否有图片列表\n        if len(self.image_list) <= 1:\n            self.prev_btn.setEnabled(False)\n            self.next_btn.setEnabled(False)\n            self.prev_btn.setToolTip(\"没有更多图片\")\n            self.next_btn.setToolTip(\"没有更多图片\")\n            return\n        \n        # 更新按钮状态（基于有效记录检查）\n        self.prev_btn.setEnabled(self._has_valid_previous_record())\n        self.next_btn.setEnabled(self._has_valid_next_record())\n        \n        # 更新工具提示显示当前位置和快捷键信息\n        current_pos = f\"({self.current_index + 1}/{len(self.image_list)})\"\n        self.prev_btn.setToolTip(f\"上一张 {current_pos} - 快捷键: ←\")\n        self.next_btn.setToolTip(f\"下一张 {current_pos} - 快捷键: →\")\n        \n        # 按钮文本保持简洁的箭头符号\n        self.prev_btn.setText(\"◀\")\n    \n    def _has_valid_previous_record(self):\n        \"\"\"检查是否有有效的上一个记录\"\"\"\n        for i in range(self.current_index - 1, -1, -1):\n            candidate_data = self.image_list[i]\n            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n            if file_path and os.path.exists(file_path):\n                return True\n        return False\n    \n    def _has_valid_next_record(self):\n        \"\"\"检查是否有有效的下一个记录\"\"\"\n        for i in range(self.current_index + 1, len(self.image_list)):\n            candidate_data = self.image_list[i]\n            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n            if file_path and os.path.exists(file_path):\n                return True\n        return False\n    \n    def show_previous_image(self):\n        \"\"\"显示上一张图片（带有效性验证）\"\"\"\n        # 寻找上一个有效记录\n        for i in range(self.current_index - 1, -1, -1):\n            candidate_data = self.image_list[i]\n            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n            \n            if file_path and os.path.exists(file_path):\n                # 找到有效记录\n                self.current_index = i\n                self.load_current_image()\n                self.update_navigation_buttons()\n                return\n        \n        # 没有找到有效的上一个记录，保持当前状态\n        self.update_navigation_buttons()\n    \n    def show_next_image(self):\n        \"\"\"显示下一张图片（带有效性验证）\"\"\"\n        # 寻找下一个有效记录\n        for i in range(self.current_index + 1, len(self.image_list)):\n            candidate_data = self.image_list[i]\n            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n            \n            if file_path and os.path.exists(file_path):\n                # 找到有效记录\n                self.current_index = i\n                self.load_current_image()\n                self.update_navigation_buttons()\n                return\n        \n        # 没有找到有效的下一个记录，保持当前状态\n        self.update_navigation_buttons()\n    \n    def load_current_image(self):\n        \"\"\"加载当前索引的图片\"\"\"\n        if 0 <= self.current_index < len(self.image_list):\n            # 更新当前图片数据\n            self.image_data = self.image_list[self.current_index]\n            \n            # 重新加载图片\n            image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '') or self.image_data.get('file_path', '')\n            if image_path and os.path.exists(image_path):\n                pixmap = QPixmap(image_path)\n                if not pixmap.isNull():\n                    self.large_image_label.setPixmap(pixmap)\n                else:\n                    self.large_image_label.setText(\"图片加载失败\")\n            else:\n                self.large_image_label.setText(\"图片不存在\")\n            \n            # 更新窗口标题\n            self.setWindowTitle(f\"图片详细信息 ({self.current_index + 1}/{len(self.image_list)})\")\n            \n            # 更新提示词内容\n            prompt_content = self.image_data.get('prompt', '无提示词')\n            self.prompt_text_edit.setPlainText(prompt_content)\n            \n            # 更新参数信息\n            self.update_params_area()\n            self._refresh_reference_gallery()\n\n        self._export_controller.refresh()\n    \n    def setup_params_area(self):\n        \"\"\"初始化参数显示区域\"\"\"\n        # Ensure this area is deterministic (avoid stale/duplicated widgets across refresh/theme changes)\n        self._clear_params_layout()\n\n        # 解析生成参数\n        params = self.image_data.get('parameters', '{}')\n        if isinstance(params, str):\n            try:\n                params = json.loads(params)\n            except:\n                params = {}\n        \n        # 提示词区域（可滚动查看全文）\n        prompt_label = QLabel(\"<b>提示词:</b>\")\n        prompt_label.setStyleSheet(\"margin: 0px; padding: 2px 0px;\")\n        unified_style_system.apply_to_widget(prompt_label)\n        self.params_layout.addWidget(prompt_label)\n        \n        # 提示词文本框\n        prompt_content = self.image_data.get('prompt', '无提示词')\n        self.prompt_text_edit = QTextEdit()\n        self.prompt_text_edit.setPlainText(prompt_content)\n        self.prompt_text_edit.setReadOnly(True)  # 只读模式\n        # 约 4 行高度（按当前字体动态计算），避免信息区过高压缩其它内容\n        try:\n            line_height = self.prompt_text_edit.fontMetrics().lineSpacing()\n            target_lines = 4\n            vertical_padding = 16  # 与全局 QTextEdit padding (8*2) 对齐\n            border = 2  # 1px*2\n            height = line_height * target_lines + vertical_padding + border\n            self.prompt_text_edit.setFixedHeight(max(72, int(height)))\n        except Exception:\n            self.prompt_text_edit.setMaximumHeight(96)\n            self.prompt_text_edit.setMinimumHeight(96)\n        self.prompt_text_edit.setVerticalScrollBarPolicy(Qt.ScrollBarAsNeeded)\n        self.prompt_text_edit.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)\n        unified_style_system.apply_to_widget(self.prompt_text_edit)\n        # 应用与 _update_theme 一致的额外样式\n        colors = unified_style_system.get_colors()\n        bg_input = colors.get('palette.neutral.bg_input') or colors.get('palette.neutral.bg_card')\n        text_color = colors.get('text') or colors.get('palette.text.primary')\n        border_subtle = colors.get('palette.neutral.border_subtle') or colors.get('border')\n        brand = colors.get('palette.brand.main') or colors.get('primary')\n        self.prompt_text_edit.setStyleSheet(f\"\"\"\n            QTextEdit {{\n                background-color: {bg_input};\n                color: {text_color};\n                border: 1px solid {border_subtle};\n                border-radius: 8px;\n                padding: 8px;\n            }}\n            QTextEdit:focus {{\n                border-color: {brand};\n            }}\n        \"\"\")\n        self.params_layout.addWidget(self.prompt_text_edit)\n        \n        # 添加复制提示词按钮（使用统一的 SecondaryButton 样式）\n        self.copy_prompt_btn = QPushButton(\"复制提示词\")\n        self.copy_prompt_btn.setObjectName(\"SecondaryButton\")\n        self.copy_prompt_btn.setMaximumHeight(30)\n        unified_style_system.apply_to_widget(self.copy_prompt_btn)\n        self.copy_prompt_btn.clicked.connect(self.copy_prompt)\n        self.params_layout.addWidget(self.copy_prompt_btn)\n        \n        # 存储参数标签列表，用于后续清理\n        self.param_labels = []\n        self.create_param_labels()\n\n    def _clear_params_layout(self):\n        \"\"\"清空参数区布局中的所有控件（保留布局本身），避免重复/遮挡。\"\"\"\n        if not hasattr(self, \"params_layout\") or self.params_layout is None:\n            return\n        while self.params_layout.count() > 0:\n            item = self.params_layout.takeAt(0)\n            w = item.widget()\n            if w is not None:\n                w.hide()  # 立即隐藏，避免 deleteLater 异步导致残留显示\n                w.setParent(None)  # 断开父子关系\n                w.deleteLater()\n    \n    def _update_theme(self):\n        \"\"\"响应主题变化\"\"\"\n        colors = unified_style_system.get_colors()\n        logger.info(f\"[ImageDetailDialog] _update_theme called. Surface color: {colors.get('palette.neutral.bg_surface')}\")\n        \n        # Apply theme to self (Dialog)\n        bg_color = colors.get('palette.neutral.bg_surface') or colors.get('palette.neutral.bg_app') or colors.get('background')\n        text_color = colors.get('text') or colors.get('palette.text.primary')\n        bg_card = colors.get('palette.neutral.bg_card') or colors.get('surface') or bg_color\n        bg_input = colors.get('palette.neutral.bg_input') or bg_card\n        border_subtle = colors.get('palette.neutral.border_subtle') or colors.get('border')\n        brand = colors.get('palette.brand.main') or colors.get('primary') or text_color\n        \n        self.setStyleSheet(f\"\"\"\n            QDialog {{\n                background-color: {bg_color};\n                color: {text_color};\n            }}\n            QLabel {{\n                color: {text_color};\n            }}\n            QWidget#ParamsWidget {{\n                 background-color: {bg_card};\n                 border-left: 1px solid {border_subtle};\n            }}\n        \"\"\")\n\n        if hasattr(self, 'prompt_text_edit'):\n            self.prompt_text_edit.setStyleSheet(f\"\"\"\n                QTextEdit {{\n                    background-color: {bg_input};\n                    color: {text_color};\n                    border: 1px solid {border_subtle};\n                    border-radius: 8px;\n                    padding: 8px;\n                }}\n                QTextEdit:focus {{\n                    border-color: {brand};\n                }}\n            \"\"\")\n\n        # Reapply button styles\n        if hasattr(self, 'fullscreen_btn'):\n            unified_style_system.apply_to_widget(self.fullscreen_btn)\n        if hasattr(self, 'copy_image_btn'):\n            unified_style_system.apply_to_widget(self.copy_image_btn)\n        if hasattr(self, 'delete_btn'):\n            unified_style_system.apply_to_widget(self.delete_btn, extra={'variant': 'danger'})\n        if hasattr(self, 'close_btn'):\n            unified_style_system.apply_to_widget(self.close_btn)\n        if hasattr(self, 'reference_export_btn'):\n            unified_style_system.apply_to_widget(self.reference_export_btn)\n        if hasattr(self, 'export_bundle_btn'):\n            unified_style_system.apply_to_widget(self.export_bundle_btn)\n        if hasattr(self, 'prev_btn'):\n            unified_style_system.apply_to_widget(self.prev_btn)\n        if hasattr(self, 'next_btn'):\n            unified_style_system.apply_to_widget(self.next_btn)\n\n        # Rebuild to ensure all param widgets pick up new palette and no stale widgets remain\n        self.setup_params_area()\n\n    def create_param_labels(self):\n        \"\"\"创建参数标签（初始化或更新时调用）\"\"\"\n        # 清除旧的参数标签 - Fix Race Condition\n        if hasattr(self, 'param_labels'):\n            for label_pair in self.param_labels:\n                # 必须先从布局中移除，防止 deleteLater 的异步销毁导致重影\n                self.params_layout.removeWidget(label_pair[0])\n                self.params_layout.removeWidget(label_pair[1])\n                label_pair[0].deleteLater()  # 删除标题标签\n                label_pair[1].deleteLater()  # 删除值标签\n            self.param_labels.clear()\n        else:\n            self.param_labels = []\n        \n        # 解析生成参数\n        params = self.image_data.get('parameters', '{}')\n        if isinstance(params, str):\n            try:\n                params = json.loads(params)\n            except:\n                params = {}\n        \n        # 详细信息\n        info_items = [\n            (\"尺寸\", f\"{params.get('size', '未知')}\"),\n            (\"种子值\", f\"{params.get('seed', '未知')}\"),\n            (\"引导强度\", f\"{params.get('guidance_scale', '未知')}\"),\n            (\"生成模型\", f\"{params.get('model', '未知模型')}\"),\n            (\"生成时间\", self.format_time(self.image_data.get('created_at', ''))),\n            (\"文件大小\", self.format_file_size(self.image_data.get('file_size', 0))),\n            (\"文件路径\", self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')),\n        ]\n        \n        # 如果是图生图，显示参考图信息\n        if params.get('model', '').find('i2i') != -1:\n            info_items.insert(-2, (\"生成类型\", \"图生图\"))\n            input_image = self.image_data.get('input_image', '')\n            if input_image:\n                info_items.insert(-2, (\"参考图片\", input_image))\n        else:\n            info_items.insert(-2, (\"生成类型\", \"文生图\"))\n        \n        colors = unified_style_system.get_colors()\n        bg_tag = colors.get('palette.neutral.bg_surface') or colors.get('palette.neutral.bg_card') or colors.get('surface')\n        border_tag = colors.get('palette.neutral.border_subtle') or colors.get('border')\n        text_tag = colors.get('text') or colors.get('palette.text.primary')\n        hover_bg = colors.get('palette.neutral.bg_hover') or bg_tag\n        hover_border = colors.get('palette.brand.main') or colors.get('primary') or border_tag\n\n        for label, value in info_items:\n            label_widget = QLabel(f\"<b>{label}:</b>\")\n            label_widget.setStyleSheet(\"margin: 0px; padding: 2px 0px;\")\n            unified_style_system.apply_to_widget(label_widget)\n            self.params_layout.addWidget(label_widget)\n            \n            # 使用可点击的标签\n            value_clickable = ClickableLabel(str(value))\n            value_clickable.set_text_with_ellipsis(str(value), int(self.width() * 0.25))\n            # File path is long and can otherwise expand to fill the panel, overlapping the prompt area.\n            # Keep it single-line with ellipsis and fixed height.\n            if label == \"文件路径\":\n                value_clickable.setWordWrap(False)\n                value_clickable.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)\n                value_clickable.setFixedHeight(32)\n                value_clickable.setToolTip(str(value))\n            else:\n                value_clickable.setWordWrap(True)\n            # 使用动态样式\n            value_clickable.setStyleSheet(f\"\"\"\n                QLabel {{\n                    margin: 0px; \n                    padding: 6px; \n                    background-color: {bg_tag}; \n                    color: {text_tag};\n                    border: 1px solid {border_tag};\n                    border-radius: 4px;\n                }}\n                QLabel:hover {{\n                    background-color: {hover_bg};\n                    border-color: {hover_border};\n                }}\n            \"\"\")\n            unified_style_system.apply_to_widget(value_clickable)\n            value_clickable.clicked.connect(self.copy_text_to_clipboard)\n            self.params_layout.addWidget(value_clickable)\n            \n            # 保存标签引用\n            self.param_labels.append((label_widget, value_clickable))\n\n        # Ensure remaining vertical space doesn't get assigned to the last label widget.\n        self.params_layout.addStretch(1)\n    \n    def update_params_area(self):\n        \"\"\"更新参数显示区域（切换图片时调用）\"\"\"\n        # Full rebuild avoids duplicated/stale widgets (e.g. file path blocks prompt area)\n        self.setup_params_area()\n\n    def closeEvent(self, event):\n        try:\n            if hasattr(self, '_focus_timer') and self._focus_timer.isActive():\n                self._focus_timer.stop()\n        except Exception:\n            pass\n\n        try:\n            self._export_controller.dispose()\n        except Exception:\n            pass\n\n        super().closeEvent(event)\n    \n    def keyPressEvent(self, event):\n        \"\"\"键盘事件处理\"\"\"\n        from PySide6.QtCore import Qt\n        \n        logger.debug(f\"[KEYBOARD] ImageDetailDialog键盘事件: {event.key()}\")\n        \n        if event.key() == Qt.Key_Left:\n            # 左方向键：上一张图片\n            if self.prev_btn.isEnabled():\n                self.show_previous_image()\n            event.accept()\n        elif event.key() == Qt.Key_Right:\n            # 右方向键：下一张图片\n            if self.next_btn.isEnabled():\n                self.show_next_image()\n            event.accept()\n        elif event.key() == Qt.Key_Escape:\n            # ESC键：关闭对话框（保持原有功能）\n            logger.debug(f\"[KEYBOARD] ESC键pressed，fullscreen: {self.is_fullscreen}\")\n            if self.is_fullscreen:\n                self.exit_fullscreen()\n            else:\n                self.accept()\n            event.accept()\n        elif event.key() == Qt.Key_F11:\n            # F11键：全屏切换（保持原有功能）\n            self.toggle_fullscreen()\n            event.accept()\n        else:\n            # 其他按键交给父类处理\n            super().keyPressEvent(event)\n","numLines":958,"startLine":1,"totalLines":958}}}
{"parentUuid":"db87cec5-c5f8-4ab6-a61c-2d086b47cc1f","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_016fVCbnUE9Mi9UPcbWudNmS","type":"message","role":"assistant","content":[{"type":"text","text":"现在让我检查视频对话框的相应按钮："}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3675,"cache_creation_input_tokens":15897,"cache_read_input_tokens":39704,"cache_creation":{"ephemeral_5m_input_tokens":15897,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"3930b3a6-2f5f-4960-a2bf-c467661ac9a4","timestamp":"2025-12-22T04:15:59.598Z"}
{"parentUuid":"3930b3a6-2f5f-4960-a2bf-c467661ac9a4","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_016fVCbnUE9Mi9UPcbWudNmS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MZegdFVrcvHsRR7ZdDCfcT","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/components/dialogs/video_detail_dialog.py","limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3675,"cache_creation_input_tokens":15897,"cache_read_input_tokens":39704,"cache_creation":{"ephemeral_5m_input_tokens":15897,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"02f08147-cd20-44d3-8b3e-3cb0caf1eab2","timestamp":"2025-12-22T04:16:00.128Z"}
{"parentUuid":"02f08147-cd20-44d3-8b3e-3cb0caf1eab2","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MZegdFVrcvHsRR7ZdDCfcT","type":"tool_result","content":"     1→import os\n     2→import json\n     3→from pathlib import Path\n     4→from datetime import datetime\n     5→from typing import Dict, Any, List, Optional\n     6→\n     7→from PySide6.QtWidgets import (\n     8→    QDialog, QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton,\n     9→    QTextEdit, QFileDialog, QMessageBox, QStackedWidget, QSplitter,\n    10→    QApplication\n    11→)\n    12→from PySide6.QtGui import QShortcut\n    13→from PySide6.QtCore import Qt, QTimer, QUrl, QSize, QEvent\n    14→from PySide6.QtGui import QPixmap, QFont, QKeySequence, QPainter, QImage\n    15→from PySide6.QtMultimedia import QMediaPlayer\n    16→from PySide6.QtMultimediaWidgets import QVideoWidget\n    17→\n    18→# 使用全局视频管理器单例\n    19→from services.global_video_manager import get_global_video_manager\n    20→\n    21→from utils.logger import logger\n    22→from components.reference_assets import (\n    23→    ReferenceGalleryWidget,\n    24→    export_reference_asset,\n    25→    open_reference_preview,\n    26→    _find_reference_asset_index,\n    27→)\n    28→from utils.style_system import unified_style_system\n    29→from components.controllers import ExportBundleController\n    30→from utils.reference_display import (\n    31→    build_resolution_text,\n    32→    ensure_reference_info,\n    33→    get_model_display_name,\n    34→    pick_model_code,\n    35→    resolve_reference_assets,\n    36→)\n    37→from PySide6.QtCore import Signal\n    38→\n    39→class VideoDetailDialog(QDialog):\n    40→    \"\"\"视频详细信息对话框\"\"\"\n    41→    \n    42→    # 删除记录后发出信号，通知父视图刷新\n    43→    recordDeleted = Signal(str)  # 参数为被删除的记录ID\n    44→    \n    45→    def __init__(self, video_data: Dict[str, Any], video_list: List[Dict[str, Any]] = None, current_index: int = 0, parent=None):\n    46→        super().__init__(parent)\n    47→        self.video_data = video_data\n    48→        self.video_list = video_list or [video_data]  # 视频列表\n    49→        self.current_index = current_index  # 当前视频索引\n    50→        self.is_fullscreen = False  # 全屏状态\n    51→        self.original_geometry = None  # 原始窗口几何\n    52→        self.param_value_labels = {}  # 存储参数值标签的引用\n    53→        self._reference_summary = ensure_reference_info(self.video_data)\n    54→        self._reference_assets: List[Dict[str, Any]] = []\n    55→        self._export_controller = ExportBundleController(self, \"video\")\n    56→        \n    57→        # Subscribe to theme changes\n    58→        unified_style_system.styleChanged.connect(self._update_theme)\n    59→        \n    60→        self.setup_ui()\n    61→    \n    62→    def set_video_data(self, video_data: Dict[str, Any], video_list: List[Dict[str, Any]] = None, current_index: int = 0):\n    63→        \"\"\"更新视频数据（复用对话框时调用，避免重建 QVideoWidget）\"\"\"\n    64→        logger.debug(f\"[REUSE] 复用对话框，更新视频数据: index={current_index}\")\n    65→        \n    66→        # 1. 先停止当前播放\n    67→        if hasattr(self, '_video_manager') and self._video_manager is not None:\n    68→            self._video_manager.stop()\n    69→        \n    70→        # 2. 重置到缩略图模式\n    71→        if hasattr(self, 'video_stack'):\n    72→            self.video_stack.setCurrentIndex(0)\n    73→        self.is_playing = False\n    74→        \n    75→        # 3. 更新数据\n    76→        self.video_data = video_data\n    77→        self.video_list = video_list or [video_data]\n    78→        self.current_index = current_index\n    79→        self._reference_summary = ensure_reference_info(self.video_data)\n    80→        \n    81→        # 4. 刷新UI\n    82→        self.load_thumbnail()\n    83→        \n    84→        # 5. 更新右侧信息\n    85→        if hasattr(self, 'prompt_text_edit'):\n    86→            prompt_content = self.video_data.get('prompt', '无提示词')\n    87→            self.prompt_text_edit.setPlainText(prompt_content)\n    88→        \n    89→        # 6. 更新参数信息\n    90→        if hasattr(self, 'update_video_params'):\n    91→            self.update_video_params()\n    92→        \n    93→        # 7. 更新导航按钮\n    94→        if hasattr(self, 'update_navigation_buttons'):\n    95→            self.update_navigation_buttons()\n    96→        \n    97→        # 8. 刷新参考图画廊\n    98→        if hasattr(self, '_refresh_reference_gallery'):\n    99→            self._refresh_reference_gallery()\n   100→        \n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"4598fb8c-6703-4719-89b1-d0239670703e","timestamp":"2025-12-22T04:16:00.200Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/components/dialogs/video_detail_dialog.py","content":"import os\nimport json\nfrom pathlib import Path\nfrom datetime import datetime\nfrom typing import Dict, Any, List, Optional\n\nfrom PySide6.QtWidgets import (\n    QDialog, QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton,\n    QTextEdit, QFileDialog, QMessageBox, QStackedWidget, QSplitter,\n    QApplication\n)\nfrom PySide6.QtGui import QShortcut\nfrom PySide6.QtCore import Qt, QTimer, QUrl, QSize, QEvent\nfrom PySide6.QtGui import QPixmap, QFont, QKeySequence, QPainter, QImage\nfrom PySide6.QtMultimedia import QMediaPlayer\nfrom PySide6.QtMultimediaWidgets import QVideoWidget\n\n# 使用全局视频管理器单例\nfrom services.global_video_manager import get_global_video_manager\n\nfrom utils.logger import logger\nfrom components.reference_assets import (\n    ReferenceGalleryWidget,\n    export_reference_asset,\n    open_reference_preview,\n    _find_reference_asset_index,\n)\nfrom utils.style_system import unified_style_system\nfrom components.controllers import ExportBundleController\nfrom utils.reference_display import (\n    build_resolution_text,\n    ensure_reference_info,\n    get_model_display_name,\n    pick_model_code,\n    resolve_reference_assets,\n)\nfrom PySide6.QtCore import Signal\n\nclass VideoDetailDialog(QDialog):\n    \"\"\"视频详细信息对话框\"\"\"\n    \n    # 删除记录后发出信号，通知父视图刷新\n    recordDeleted = Signal(str)  # 参数为被删除的记录ID\n    \n    def __init__(self, video_data: Dict[str, Any], video_list: List[Dict[str, Any]] = None, current_index: int = 0, parent=None):\n        super().__init__(parent)\n        self.video_data = video_data\n        self.video_list = video_list or [video_data]  # 视频列表\n        self.current_index = current_index  # 当前视频索引\n        self.is_fullscreen = False  # 全屏状态\n        self.original_geometry = None  # 原始窗口几何\n        self.param_value_labels = {}  # 存储参数值标签的引用\n        self._reference_summary = ensure_reference_info(self.video_data)\n        self._reference_assets: List[Dict[str, Any]] = []\n        self._export_controller = ExportBundleController(self, \"video\")\n        \n        # Subscribe to theme changes\n        unified_style_system.styleChanged.connect(self._update_theme)\n        \n        self.setup_ui()\n    \n    def set_video_data(self, video_data: Dict[str, Any], video_list: List[Dict[str, Any]] = None, current_index: int = 0):\n        \"\"\"更新视频数据（复用对话框时调用，避免重建 QVideoWidget）\"\"\"\n        logger.debug(f\"[REUSE] 复用对话框，更新视频数据: index={current_index}\")\n        \n        # 1. 先停止当前播放\n        if hasattr(self, '_video_manager') and self._video_manager is not None:\n            self._video_manager.stop()\n        \n        # 2. 重置到缩略图模式\n        if hasattr(self, 'video_stack'):\n            self.video_stack.setCurrentIndex(0)\n        self.is_playing = False\n        \n        # 3. 更新数据\n        self.video_data = video_data\n        self.video_list = video_list or [video_data]\n        self.current_index = current_index\n        self._reference_summary = ensure_reference_info(self.video_data)\n        \n        # 4. 刷新UI\n        self.load_thumbnail()\n        \n        # 5. 更新右侧信息\n        if hasattr(self, 'prompt_text_edit'):\n            prompt_content = self.video_data.get('prompt', '无提示词')\n            self.prompt_text_edit.setPlainText(prompt_content)\n        \n        # 6. 更新参数信息\n        if hasattr(self, 'update_video_params'):\n            self.update_video_params()\n        \n        # 7. 更新导航按钮\n        if hasattr(self, 'update_navigation_buttons'):\n            self.update_navigation_buttons()\n        \n        # 8. 刷新参考图画廊\n        if hasattr(self, '_refresh_reference_gallery'):\n            self._refresh_reference_gallery()\n        ","numLines":100,"startLine":1,"totalLines":1332}}}
{"parentUuid":"4598fb8c-6703-4719-89b1-d0239670703e","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01W8NgwXHS2ULTyzaW5tGxVh","type":"message","role":"assistant","content":[{"type":"text","text":"让我搜索video_detail_dialog中与SecondaryButton相关的部分："}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":5424,"cache_read_input_tokens":55601,"cache_creation":{"ephemeral_5m_input_tokens":5424,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"52f080fd-83ea-43f7-86a4-dff51fa411f4","timestamp":"2025-12-22T04:16:04.420Z"}
{"parentUuid":"52f080fd-83ea-43f7-86a4-dff51fa411f4","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01W8NgwXHS2ULTyzaW5tGxVh","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017ZdEicGQkPbWapW1ziu61r","name":"Grep","input":{"pattern":"SecondaryButton|copy_prompt|复制提示词|导出选中参考","path":"/Users/yunchang/Documents/GitHub/gemeng2/components/dialogs/video_detail_dialog.py","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":5424,"cache_read_input_tokens":55601,"cache_creation":{"ephemeral_5m_input_tokens":5424,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"a0929839-dabc-4c18-97d1-ca1a67c4b89a","timestamp":"2025-12-22T04:16:05.293Z"}
{"parentUuid":"a0929839-dabc-4c18-97d1-ca1a67c4b89a","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017ZdEicGQkPbWapW1ziu61r","type":"tool_result","content":"287:        self.reference_export_btn = QPushButton(\"导出选中参考图\")\n288:        self.reference_export_btn.setObjectName(\"SecondaryButton\")\n294:        self.export_bundle_btn.setObjectName(\"SecondaryButton\")\n423:        # 复制提示词按钮（使用统一的 SecondaryButton 样式）\n424:        self.copy_prompt_btn = QPushButton(\"复制提示词\")\n425:        self.copy_prompt_btn.setObjectName(\"SecondaryButton\")\n426:        self.copy_prompt_btn.setMaximumHeight(30)\n427:        unified_style_system.apply_to_widget(self.copy_prompt_btn)\n428:        self.copy_prompt_btn.clicked.connect(self.copy_prompt)\n429:        params_layout.addWidget(self.copy_prompt_btn)\n855:    def copy_prompt(self):\n856:        \"\"\"复制提示词到剪贴板\"\"\""}]},"uuid":"aed4c419-e36f-4ddb-8fb4-caa9fcf8d04f","timestamp":"2025-12-22T04:16:05.369Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"287:        self.reference_export_btn = QPushButton(\"导出选中参考图\")\n288:        self.reference_export_btn.setObjectName(\"SecondaryButton\")\n294:        self.export_bundle_btn.setObjectName(\"SecondaryButton\")\n423:        # 复制提示词按钮（使用统一的 SecondaryButton 样式）\n424:        self.copy_prompt_btn = QPushButton(\"复制提示词\")\n425:        self.copy_prompt_btn.setObjectName(\"SecondaryButton\")\n426:        self.copy_prompt_btn.setMaximumHeight(30)\n427:        unified_style_system.apply_to_widget(self.copy_prompt_btn)\n428:        self.copy_prompt_btn.clicked.connect(self.copy_prompt)\n429:        params_layout.addWidget(self.copy_prompt_btn)\n855:    def copy_prompt(self):\n856:        \"\"\"复制提示词到剪贴板\"\"\"","numLines":12}}
{"parentUuid":"aed4c419-e36f-4ddb-8fb4-caa9fcf8d04f","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_013Gr5Tosqxg7aJsuxQ9AT5Z","type":"message","role":"assistant","content":[{"type":"text","text":"现在让我检查按钮在 `apply_to_widget` 中是如何处理 objectName 的。我发现了一个关键问题。让我验证一下 `apply_to_widget` 方法中关于 SecondaryButton 的处理："}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":559,"cache_read_input_tokens":61025,"cache_creation":{"ephemeral_5m_input_tokens":559,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"fcd87370-39d2-4126-93e7-fbc3e6645b39","timestamp":"2025-12-22T04:16:11.195Z"}
{"parentUuid":"fcd87370-39d2-4126-93e7-fbc3e6645b39","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_013Gr5Tosqxg7aJsuxQ9AT5Z","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012wZ6GietYSKoWQN6F7oHQi","name":"Grep","input":{"pattern":"apply_to_widget.*SecondaryButton|objectName.*secondary","path":"/Users/yunchang/Documents/GitHub/gemeng2/utils/style_system.py","output_mode":"content"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":559,"cache_read_input_tokens":61025,"cache_creation":{"ephemeral_5m_input_tokens":559,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"8baef48d-3d80-4f44-b6e2-2e060c1bcd4d","timestamp":"2025-12-22T04:16:11.740Z"}
{"parentUuid":"8baef48d-3d80-4f44-b6e2-2e060c1bcd4d","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012wZ6GietYSKoWQN6F7oHQi","type":"tool_result","content":"No matches found"}]},"uuid":"f3f1feb5-957b-4ccb-9bd1-7c5dfbe8afda","timestamp":"2025-12-22T04:16:11.834Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"","numLines":0}}
{"parentUuid":"f3f1feb5-957b-4ccb-9bd1-7c5dfbe8afda","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Hu6DTzjaTPPyJWkXZtcAk7","type":"message","role":"assistant","content":[{"type":"text","text":"让我查看 `get_widget_style` 和 `_generate_style` 方法中关于 objectName 的处理："}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":495,"cache_read_input_tokens":61584,"cache_creation":{"ephemeral_5m_input_tokens":495,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"type":"assistant","uuid":"773c82f0-a8f1-4106-a141-1b10d8832041","timestamp":"2025-12-22T04:16:19.436Z"}
{"parentUuid":"773c82f0-a8f1-4106-a141-1b10d8832041","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Hu6DTzjaTPPyJWkXZtcAk7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PNFitCsurdCHMSASgmd5AG","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/utils/style_system.py","offset":540,"limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":495,"cache_read_input_tokens":61584,"cache_creation":{"ephemeral_5m_input_tokens":495,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"type":"assistant","uuid":"00388e81-3599-47d2-8be2-c7af7fe6f77f","timestamp":"2025-12-22T04:16:19.764Z"}
{"parentUuid":"00388e81-3599-47d2-8be2-c7af7fe6f77f","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PNFitCsurdCHMSASgmd5AG","type":"tool_result","content":"   540→    def apply_to_widget(self, widget: QWidget, widget_type: str = None, recursive: bool = True, extra: Dict[str, Any] = None):\n   541→        \"\"\"应用样式到组件\"\"\"\n   542→        if widget_type is None:\n   543→            widget_type = self.identify_widget_type(widget)\n   544→        \n   545→        # 准备样式参数\n   546→        style_extra = {}\n   547→        \n   548→        # 1. 自动提取 objectName\n   549→        if widget.objectName():\n   550→            style_extra['objectName'] = widget.objectName()\n   551→            \n   552→        # 2. 检查持久化属性 (style_variant, style_extra)\n   553→        # 优先级：传入参数 > 属性 > objectName\n   554→        variant_prop = widget.property('style_variant')\n   555→        extra_prop = widget.property('style_extra')\n   556→        \n   557→        if extra_prop and isinstance(extra_prop, dict):\n   558→            style_extra.update(extra_prop)\n   559→        if variant_prop:\n   560→            style_extra['variant'] = variant_prop\n   561→            \n   562→        # 3. 合并手动传入的参数 (优先级最高，并更新持久化属性)\n   563→        need_polish = False  # 标记是否需要重新polish\n   564→        if extra:\n   565→            style_extra.update(extra)\n   566→            # 如果传入了 extra，保存到属性中以便后续刷新使用\n   567→            if 'variant' in extra:\n   568→                widget.setProperty('style_variant', extra['variant'])\n   569→                need_polish = True  # 设置了动态属性，需要polish\n   570→            # 保存其他 extra 参数\n   571→            other_extras = {k: v for k, v in extra.items() if k != 'variant'}\n   572→            if other_extras:\n   573→                current_extras = widget.property('style_extra') or {}\n   574→                if isinstance(current_extras, dict):\n   575→                    current_extras.update(other_extras)\n   576→                    widget.setProperty('style_extra', current_extras)\n   577→            \n   578→        # 如果没有任何参数，设为 None\n   579→        if not style_extra:\n   580→            style_extra = None\n   581→        \n   582→        style = self.get_widget_style(widget_type, style_extra)\n   583→        if style:\n   584→            # 对于表单控件，直接替换样式（避免继承冲突）\n   585→            # 其他控件保留原有非字体样式并放在前面（新样式优先）\n   586→            form_controls = ('QSpinBox', 'QDoubleSpinBox', 'QComboBox', 'QLineEdit')\n   587→            if widget_type in form_controls:\n   588→                # 表单控件：直接使用新样式，不合并旧样式\n   589→                widget.setStyleSheet(style)\n   590→            else:\n   591→                current_style = widget.styleSheet()\n   592→                if current_style:\n   593→                    # 移除原有的字体相关样式\n   594→                    current_style = self.remove_font_styles(current_style)\n   595→                    # 合并：旧样式在前，新样式在后（新样式优先级更高）\n   596→                    if current_style.strip():\n   597→                        style = f\"{current_style}\\n{style}\"\n   598→                \n   599→                widget.setStyleSheet(style)\n   600→\n   601→        # 如果设置了动态属性（如 style_variant），需要强制 Qt 重新评估样式选择器\n   602→        if need_polish:\n   603→            widget.style().unpolish(widget)\n   604→            widget.style().polish(widget)\n   605→\n   606→        # 设置字体\n   607→        font = widget.font()\n   608→        base_size = self._get_base_font_size_for_widget(widget_type, widget.objectName())\n   609→        font.setPointSize(self.get_scaled_font_size(base_size))\n   610→        widget.setFont(font)\n   611→        \n   612→        # 递归应用到子组件 - 修复递归逻辑\n   613→        if recursive:\n   614→            # 标记已处理的组件，避免重复处理\n   615→            if not hasattr(self, '_processed_widgets'):\n   616→                self._processed_widgets = set()\n   617→            \n   618→            widget_id = id(widget)\n   619→            if widget_id in self._processed_widgets:\n   620→                return\n   621→            self._processed_widgets.add(widget_id)\n   622→            \n   623→            try:\n   624→                for child in widget.findChildren(QWidget):\n   625→                    child_id = id(child)\n   626→                    # 只处理直接子组件，避免重复处理\n   627→                    if child_id not in self._processed_widgets and child.parent() == widget:\n   628→                        # 跳过表单控件的内部子组件，防止样式覆盖\n   629→                        # QComboBox/QSpinBox/QDoubleSpinBox 内部的 QLineEdit 不应单独应用样式\n   630→                        parent_widget = child.parent()\n   631→                        if parent_widget and isinstance(parent_widget, (QComboBox, QSpinBox, QDoubleSpinBox)):\n   632→                            # 标记为已处理但不应用样式\n   633→                            self._processed_widgets.add(child_id)\n   634→                            continue\n   635→                        self.apply_to_widget(child, recursive=True)\n   636→            finally:\n   637→                # 清理处理标记（在顶层调用结束时）\n   638→                if hasattr(self, '_processed_widgets'):\n   639→                    self._processed_widgets.discard(widget_id)\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"a93ec7bf-fb08-4c5c-86d4-bc3b13ae8442","timestamp":"2025-12-22T04:16:19.913Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/utils/style_system.py","content":"    def apply_to_widget(self, widget: QWidget, widget_type: str = None, recursive: bool = True, extra: Dict[str, Any] = None):\n        \"\"\"应用样式到组件\"\"\"\n        if widget_type is None:\n            widget_type = self.identify_widget_type(widget)\n        \n        # 准备样式参数\n        style_extra = {}\n        \n        # 1. 自动提取 objectName\n        if widget.objectName():\n            style_extra['objectName'] = widget.objectName()\n            \n        # 2. 检查持久化属性 (style_variant, style_extra)\n        # 优先级：传入参数 > 属性 > objectName\n        variant_prop = widget.property('style_variant')\n        extra_prop = widget.property('style_extra')\n        \n        if extra_prop and isinstance(extra_prop, dict):\n            style_extra.update(extra_prop)\n        if variant_prop:\n            style_extra['variant'] = variant_prop\n            \n        # 3. 合并手动传入的参数 (优先级最高，并更新持久化属性)\n        need_polish = False  # 标记是否需要重新polish\n        if extra:\n            style_extra.update(extra)\n            # 如果传入了 extra，保存到属性中以便后续刷新使用\n            if 'variant' in extra:\n                widget.setProperty('style_variant', extra['variant'])\n                need_polish = True  # 设置了动态属性，需要polish\n            # 保存其他 extra 参数\n            other_extras = {k: v for k, v in extra.items() if k != 'variant'}\n            if other_extras:\n                current_extras = widget.property('style_extra') or {}\n                if isinstance(current_extras, dict):\n                    current_extras.update(other_extras)\n                    widget.setProperty('style_extra', current_extras)\n            \n        # 如果没有任何参数，设为 None\n        if not style_extra:\n            style_extra = None\n        \n        style = self.get_widget_style(widget_type, style_extra)\n        if style:\n            # 对于表单控件，直接替换样式（避免继承冲突）\n            # 其他控件保留原有非字体样式并放在前面（新样式优先）\n            form_controls = ('QSpinBox', 'QDoubleSpinBox', 'QComboBox', 'QLineEdit')\n            if widget_type in form_controls:\n                # 表单控件：直接使用新样式，不合并旧样式\n                widget.setStyleSheet(style)\n            else:\n                current_style = widget.styleSheet()\n                if current_style:\n                    # 移除原有的字体相关样式\n                    current_style = self.remove_font_styles(current_style)\n                    # 合并：旧样式在前，新样式在后（新样式优先级更高）\n                    if current_style.strip():\n                        style = f\"{current_style}\\n{style}\"\n                \n                widget.setStyleSheet(style)\n\n        # 如果设置了动态属性（如 style_variant），需要强制 Qt 重新评估样式选择器\n        if need_polish:\n            widget.style().unpolish(widget)\n            widget.style().polish(widget)\n\n        # 设置字体\n        font = widget.font()\n        base_size = self._get_base_font_size_for_widget(widget_type, widget.objectName())\n        font.setPointSize(self.get_scaled_font_size(base_size))\n        widget.setFont(font)\n        \n        # 递归应用到子组件 - 修复递归逻辑\n        if recursive:\n            # 标记已处理的组件，避免重复处理\n            if not hasattr(self, '_processed_widgets'):\n                self._processed_widgets = set()\n            \n            widget_id = id(widget)\n            if widget_id in self._processed_widgets:\n                return\n            self._processed_widgets.add(widget_id)\n            \n            try:\n                for child in widget.findChildren(QWidget):\n                    child_id = id(child)\n                    # 只处理直接子组件，避免重复处理\n                    if child_id not in self._processed_widgets and child.parent() == widget:\n                        # 跳过表单控件的内部子组件，防止样式覆盖\n                        # QComboBox/QSpinBox/QDoubleSpinBox 内部的 QLineEdit 不应单独应用样式\n                        parent_widget = child.parent()\n                        if parent_widget and isinstance(parent_widget, (QComboBox, QSpinBox, QDoubleSpinBox)):\n                            # 标记为已处理但不应用样式\n                            self._processed_widgets.add(child_id)\n                            continue\n                        self.apply_to_widget(child, recursive=True)\n            finally:\n                # 清理处理标记（在顶层调用结束时）\n                if hasattr(self, '_processed_widgets'):\n                    self._processed_widgets.discard(widget_id)","numLines":100,"startLine":540,"totalLines":1073}}}
{"parentUuid":"a93ec7bf-fb08-4c5c-86d4-bc3b13ae8442","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Um9VLHYkji55tQuPLsajj8","type":"message","role":"assistant","content":[{"type":"text","text":"现在让我检查 `_generate_style` 方法对 QPushButton 的处理，看看是否处理了 objectName 参数："}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":2038,"cache_read_input_tokens":62079,"cache_creation":{"ephemeral_5m_input_tokens":2038,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"402222d2-e783-41ea-9a24-464367ddc104","timestamp":"2025-12-22T04:16:26.945Z"}
{"parentUuid":"402222d2-e783-41ea-9a24-464367ddc104","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Um9VLHYkji55tQuPLsajj8","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RnBqLmdFmEuwbgfCs5CWdz","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/utils/style_system.py","offset":153,"limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":2038,"cache_read_input_tokens":62079,"cache_creation":{"ephemeral_5m_input_tokens":2038,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"82436b82-29e3-4f83-a632-3355c68045c0","timestamp":"2025-12-22T04:16:27.647Z"}
{"parentUuid":"82436b82-29e3-4f83-a632-3355c68045c0","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RnBqLmdFmEuwbgfCs5CWdz","type":"tool_result","content":"   153→    def _generate_style(self, widget_type: str, extra: Dict[str, Any] = None) -> str:\n   154→        \"\"\"生成组件样式\"\"\"\n   155→        colors = self.get_colors()\n   156→\n   157→        # 字体大小配置（保持代码内定义，因为这些是设计规范）\n   158→        base_sizes = {\n   159→            'small': 12,     # Secondary text\n   160→            'normal': 14,    # Body text, Inputs\n   161→            'medium': 16,    # Headers, Large Buttons\n   162→            'large': 20,     # Titles\n   163→            'xlarge': 24     # Display\n   164→        }\n   165→\n   166→        # 从 JSON 读取 Layout Metrics（支持配置化）\n   167→        # 如果 JSON 没有定义则使用默认值\n   168→        metrics = {\n   169→            'height_lg': theme_engine.get_value('layout.height_lg', 40),\n   170→            'height_base': theme_engine.get_value('layout.height_base', 32),\n   171→            'radius_lg': theme_engine.get_value('layout.radius_lg', 8),\n   172→            'radius_base': theme_engine.get_value('layout.radius_base', 6),\n   173→            'radius_sm': theme_engine.get_value('layout.radius_sm', 4),\n   174→            'padding_x_lg': theme_engine.get_value('layout.padding_x_lg', 12),\n   175→            'padding_x_base': theme_engine.get_value('layout.padding_x_base', 8),\n   176→            'icon_size': theme_engine.get_value('layout.icon_size', 16)\n   177→        }\n   178→\n   179→        styles = {\n   180→            \"QWidget\": f\"\"\"\n   181→                QWidget {{\n   182→                    font-family: {theme_engine.get_font_family()};\n   183→                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n   184→                    color: {colors['text']};\n   185→                }}\n   186→                /* Global Card Style */\n   187→                QWidget#settingsCard, QFrame[class=\"card\"] {{\n   188→                    background-color: {theme_engine.get_color(\"palette.neutral.bg_card\")};\n   189→                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n   190→                    border-radius: {self.get_scaled_font_size(metrics['radius_lg'])}px;\n   191→                }}\n   192→            \"\"\",\n   193→            \n   194→            \"QLabel\": f\"\"\"\n   195→                QLabel {{\n   196→                    color: {colors['text']};\n   197→                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n   198→                    padding: {self.get_scaled_font_size(2)}px 0;\n   199→                }}\n   200→                QLabel#titleLabel {{\n   201→                    font-size: {self.get_scaled_font_size(base_sizes['xlarge'])}px;\n   202→                    font-weight: 600;\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"3255c136-2112-4295-90aa-7247568fa244","timestamp":"2025-12-22T04:16:27.740Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/utils/style_system.py","content":"    def _generate_style(self, widget_type: str, extra: Dict[str, Any] = None) -> str:\n        \"\"\"生成组件样式\"\"\"\n        colors = self.get_colors()\n\n        # 字体大小配置（保持代码内定义，因为这些是设计规范）\n        base_sizes = {\n            'small': 12,     # Secondary text\n            'normal': 14,    # Body text, Inputs\n            'medium': 16,    # Headers, Large Buttons\n            'large': 20,     # Titles\n            'xlarge': 24     # Display\n        }\n\n        # 从 JSON 读取 Layout Metrics（支持配置化）\n        # 如果 JSON 没有定义则使用默认值\n        metrics = {\n            'height_lg': theme_engine.get_value('layout.height_lg', 40),\n            'height_base': theme_engine.get_value('layout.height_base', 32),\n            'radius_lg': theme_engine.get_value('layout.radius_lg', 8),\n            'radius_base': theme_engine.get_value('layout.radius_base', 6),\n            'radius_sm': theme_engine.get_value('layout.radius_sm', 4),\n            'padding_x_lg': theme_engine.get_value('layout.padding_x_lg', 12),\n            'padding_x_base': theme_engine.get_value('layout.padding_x_base', 8),\n            'icon_size': theme_engine.get_value('layout.icon_size', 16)\n        }\n\n        styles = {\n            \"QWidget\": f\"\"\"\n                QWidget {{\n                    font-family: {theme_engine.get_font_family()};\n                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n                    color: {colors['text']};\n                }}\n                /* Global Card Style */\n                QWidget#settingsCard, QFrame[class=\"card\"] {{\n                    background-color: {theme_engine.get_color(\"palette.neutral.bg_card\")};\n                    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n                    border-radius: {self.get_scaled_font_size(metrics['radius_lg'])}px;\n                }}\n            \"\"\",\n            \n            \"QLabel\": f\"\"\"\n                QLabel {{\n                    color: {colors['text']};\n                    font-size: {self.get_scaled_font_size(base_sizes['normal'])}px;\n                    padding: {self.get_scaled_font_size(2)}px 0;\n                }}\n                QLabel#titleLabel {{\n                    font-size: {self.get_scaled_font_size(base_sizes['xlarge'])}px;\n                    font-weight: 600;","numLines":50,"startLine":153,"totalLines":1073}}}
{"parentUuid":"3255c136-2112-4295-90aa-7247568fa244","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01RKcvVHQ89pNYS82D5XUqFr","type":"message","role":"assistant","content":[{"type":"text","text":"现在让我看 `_generate_style` 方法中的 QPushButton 部分和 extra 参数处理："}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1141,"cache_read_input_tokens":64117,"cache_creation":{"ephemeral_5m_input_tokens":1141,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"df85a590-b9d6-4b94-b304-4b60958b0451","timestamp":"2025-12-22T04:16:33.681Z"}
{"parentUuid":"df85a590-b9d6-4b94-b304-4b60958b0451","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01RKcvVHQ89pNYS82D5XUqFr","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PDSRUtUYcJzhQvVEF8NgXV","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/utils/style_system.py","offset":530,"limit":15}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":1141,"cache_read_input_tokens":64117,"cache_creation":{"ephemeral_5m_input_tokens":1141,"ephemeral_1h_input_tokens":0},"output_tokens":142,"service_tier":"standard"}},"type":"assistant","uuid":"06381883-d5a0-4514-a597-1822237f30af","timestamp":"2025-12-22T04:16:34.370Z"}
{"parentUuid":"06381883-d5a0-4514-a597-1822237f30af","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PDSRUtUYcJzhQvVEF8NgXV","type":"tool_result","content":"   530→        }\n   531→        \n   532→        # 添加对象名称特定的样式\n   533→        if extra and 'objectName' in extra:\n   534→            obj_name = extra['objectName']\n   535→            if widget_type == \"QWidget\" and obj_name == \"parameterGroup\":\n   536→                return self._generate_style(\"QGroupBox\", extra)\n   537→        \n   538→        return styles.get(widget_type, \"\")\n   539→    \n   540→    def apply_to_widget(self, widget: QWidget, widget_type: str = None, recursive: bool = True, extra: Dict[str, Any] = None):\n   541→        \"\"\"应用样式到组件\"\"\"\n   542→        if widget_type is None:\n   543→            widget_type = self.identify_widget_type(widget)\n   544→        \n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"fbe4cc80-75ba-4d78-a139-e4f5d2d4c7ff","timestamp":"2025-12-22T04:16:34.458Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/utils/style_system.py","content":"        }\n        \n        # 添加对象名称特定的样式\n        if extra and 'objectName' in extra:\n            obj_name = extra['objectName']\n            if widget_type == \"QWidget\" and obj_name == \"parameterGroup\":\n                return self._generate_style(\"QGroupBox\", extra)\n        \n        return styles.get(widget_type, \"\")\n    \n    def apply_to_widget(self, widget: QWidget, widget_type: str = None, recursive: bool = True, extra: Dict[str, Any] = None):\n        \"\"\"应用样式到组件\"\"\"\n        if widget_type is None:\n            widget_type = self.identify_widget_type(widget)\n        ","numLines":15,"startLine":530,"totalLines":1073}}}
{"parentUuid":"fbe4cc80-75ba-4d78-a139-e4f5d2d4c7ff","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"67192835-e023-4755-bc2b-963b5371b5b7","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"af5554e","slug":"transient-sniffing-marshmallow","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Y1rDKuHwfCQfyk3tqveNLz","type":"message","role":"assistant","content":[{"type":"text","text":"现在问题清晰了。让我创建一份详细的分析报告：\n\n## 问题诊断报告：SecondaryButton 样式不生效\n\n我已经深入分析了代码，找到了 **4 个关键问题**：\n\n### 问题 1: apply_to_widget 中 objectName 被提取但未被使用\n\n**位置**: `/Users/yunchang/Documents/GitHub/gemeng2/utils/style_system.py` 第 549-550 行\n\n```python\n# 1. 自动提取 objectName\nif widget.objectName():\n    style_extra['objectName'] = widget.objectName()\n```\n\n虽然 `apply_to_widget` 方法**提取** objectName 并将其放入 `style_extra` 字典，但这只是将值存储在字典中。问题在于 `_generate_style` 方法几乎完全忽视了它。\n\n### 问题 2: _generate_style 没有处理 objectName 样式\n\n**位置**: `/Users/yunchang/Documents/GitHub/gemeng2/utils/style_system.py` 第 533-536 行\n\n```python\n# 添加对象名称特定的样式\nif extra and 'objectName' in extra:\n    obj_name = extra['objectName']\n    if widget_type == \"QWidget\" and obj_name == \"parameterGroup\":\n        return self._generate_style(\"QGroupBox\", extra)\n\nreturn styles.get(widget_type, \"\")\n```\n\n这段代码**只处理** `parameterGroup` 这一个特殊情况。对于 `SecondaryButton`，即使 objectName 被提取了，也不会触发任何特殊处理。最终生成的还是通用的 `QPushButton` 样式。\n\n### 问题 3: 全局样式表中有冗余的 SecondaryButton 定义\n\n**位置**: `/Users/yunchang/Documents/GitHub/gemeng2/utils/style_system.py` 第 961-979 行（`_get_global_style` 方法）\n\n```qss\n/* Navigation buttons (for detail dialogs) */\nQPushButton#NavButton {\n    background-color: {bg_card};\n    border: 1px solid {border_subtle};\n    border-radius: 15px;\n    ...\n}\n\n/* Play button (for video dialogs) */\nQPushButton#PlayButton {\n    background-color: {brand};\n    ...\n}\n```\n\n有 NavButton 和 PlayButton 的全局样式，但在 `_get_global_style` 中**缺少** `#SecondaryButton` 选择器。\n\n同时在 `_generate_style` 的 QPushButton 部分（第 361-376 行）定义了 `#SecondaryButton`：\n\n```qss\n/* Secondary Buttons (copy prompt, export, etc.) */\nQPushButton#SecondaryButton {\n    background-color: {theme_engine.get_color(\"palette.neutral.bg_card\")};\n    border: 1px solid {theme_engine.get_color(\"palette.neutral.border_subtle\")};\n    ...\n}\n```\n\n**这两处定义互相冲突**——全局样式表和组件级样式表的优先级问题导致样式不稳定。\n\n### 问题 4: QPushButton 选择器优先级问题\n\n在 QSS（Qt 样式表）中，ID 选择器（`#SecondaryButton`）的优先级应该高于类型选择器（`QPushButton`）。但由于：\n\n1. **全局样式表先被应用**（`apply_to_application` 第 750 行）\n2. 然后**组件级样式表被合并**（`apply_to_widget` 第 596-597 行）\n3. 合并时旧样式在前，新样式在后\n\n```python\nstyle = f\"{current_style}\\n{style}\"  # 新样式在后面应该有优先级\n```\n\n但这种合并方式在某些条件下会失效。特别是当：\n- 按钮先被应用了通用样式（可能来自递归调用）\n- 然后被应用 SecondaryButton 样式时\n- 如果之前没有调用 `polish()` 重新评估 QSS 选择器，旧样式可能被缓存\n\n### 问题 5: 缺少 polish() 调用\n\n**位置**: `/Users/yunchang/Documents/GitHub/gemeng2/utils/style_system.py` 第 602-604 行\n\n```python\n# 如果设置了动态属性（如 style_variant），需要强制 Qt 重新评估样式选择器\nif need_polish:\n    widget.style().unpolish(widget)\n    widget.style().polish(widget)\n```\n\n`polish()` 只在设置了 `style_variant` 动态属性时才被调用。但当**仅设置 objectName** 时，不会触发 polish，导致 Qt 不会重新评估 QSS 选择器。\n\n---\n\n## 为什么问题\"时不时\"出现？\n\n1. **初次应用时**：可能按钮恰好被递归处理，且没有其他样式冲突，样式显示正常\n2. **主题切换时**：`_update_theme` 调用 `setup_params_area`（第 814 行），完全重建参数区。新创建的按钮会重新调用 `apply_to_widget`，但可能在缓存或选择器评估时出现问题\n3. **窗口焦点变化时**：Qt 可能会重新渲染，导致样式不稳定\n\n---\n\n## 根本原因总结\n\n| 问题 | 根本原因 | 影响 |\n|------|--------|------|\n| objectName 被提取但未使用 | `_generate_style` 没有为 SecondaryButton 生成特殊样式 | 返回的是通用 QPushButton 样式 |\n| 选择器优先级混乱 | 全局样式 + 组件样式合并，没有统一的优先级处理 | 样式可能被覆盖 |\n| 缺少 polish() 调用 | 仅对 `style_variant` 调用 polish，不对 objectName 调用 | 选择器可能不被重新评估 |\n| 双重定义 | `#SecondaryButton` 同时定义在两处 | 选择器优先级不确定 |\n\n---\n\n## 修复方案概览（不需要执行）\n\n要彻底解决这个问题，需要：\n\n1. **在 `_generate_style` 中添加 objectName 处理逻辑**，根据 objectName 返回相应的样式\n2. **为 objectName 变化也调用 polish()**，不仅仅是 variant 变化\n3. **将 `#SecondaryButton` 定义统一到一处**（建议在 `_get_global_style`）\n4. **在应用 objectName 样式时显式调用 polish()**，强制重新评估选择器\n\n这样就能确保 SecondaryButton 样式稳定一致地生效。"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":840,"cache_read_input_tokens":65258,"cache_creation":{"ephemeral_5m_input_tokens":840,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"55a3d522-34c2-4424-ac27-cd37a48b4a32","timestamp":"2025-12-22T04:16:53.572Z"}
