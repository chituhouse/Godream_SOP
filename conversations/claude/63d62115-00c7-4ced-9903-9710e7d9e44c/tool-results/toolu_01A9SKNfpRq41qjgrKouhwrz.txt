     1â†’#!/usr/bin/env python3
     2â†’# -*- coding: utf-8 -*-
     3â†’"""
     4â†’è§†é¢‘å¡ç‰‡ç»„ä»¶ï¼ˆä» qt_app.py æ‹†åˆ†ï¼‰.
     5â†’
     6â†’DEPRECATED: VideoCard ç±»å·²åºŸå¼ƒï¼Œä»…åœ¨ archive/ ä¸­çš„æ—§ä»£ç ä½¿ç”¨ã€‚
     7â†’ç°ä»£è§†å›¾ä½¿ç”¨ components/delegates/video_card_delegate.py ä¸­çš„ VideoCardDelegateã€‚
     8â†’
     9â†’æ³¨æ„: set_video_detail_handler å‡½æ•°ä»åœ¨ä¸»ä»£ç ä¸­ä½¿ç”¨ï¼Œè¯·å‹¿åˆ é™¤ã€‚
    10â†’"""
    11â†’
    12â†’from __future__ import annotations
    13â†’
    14â†’import os
    15â†’from datetime import datetime
    16â†’from typing import Any, Callable, Dict, List, Optional
    17â†’
    18â†’from PySide6.QtCore import QEvent, Qt, Signal, QTimer
    19â†’from PySide6.QtGui import QPixmap
    20â†’from PySide6.QtWidgets import (
    21â†’    QMenu,
    22â†’    QApplication,
    23â†’    QFileDialog,
    24â†’    QLabel,
    25â†’    QFrame,
    26â†’    QMessageBox,
    27â†’    QSizePolicy,
    28â†’    QVBoxLayout,
    29â†’    QHBoxLayout,
    30â†’    QPushButton,
    31â†’)
    32â†’from PySide6.QtGui import QAction
    33â†’
    34â†’from loguru import logger
    35â†’from utils.reference_assets import summarize_reference_assets
    36â†’from utils.reference_display import (
    37â†’    build_resolution_text,
    38â†’    get_model_display_name,
    39â†’    pick_model_code,
    40â†’)
    41â†’from utils.task_runner import CancelToken, task_runner
    42â†’from utils.ui_utils import DpiScaler
    43â†’from utils.style_system import unified_style_system
    44â†’
    45â†’DetailHandler = Optional[Callable[[Dict[str, Any], List[Dict[str, Any]], int, QFrame], None]]
    46â†’_video_detail_handler: DetailHandler = None
    47â†’
    48â†’
    49â†’def set_video_detail_handler(handler: DetailHandler) -> None:
    50â†’    """æ³¨å†Œç‚¹å‡»å¡ç‰‡æ—¶çš„è¯¦æƒ…å¼¹çª—å›è°ƒã€‚"""
    51â†’    global _video_detail_handler
    52â†’    _video_detail_handler = handler
    53â†’
    54â†’
    55â†’class VideoCard(QFrame):
    56â†’    """è§†é¢‘å¡ç‰‡ç»„ä»¶"""
    57â†’    thumbnail_path_ready = Signal(str)
    58â†’
    59â†’    def __init__(self, video_data: Dict[str, Any], video_list: List[Dict[str, Any]] = None, current_index: int = 0, parent=None):
    60â†’        super().__init__(parent)
    61â†’        self.video_data = video_data
    62â†’        self.video_list = video_list or [video_data]  # è§†é¢‘åˆ—è¡¨
    63â†’        self.current_index = current_index  # å½“å‰è§†é¢‘ç´¢å¼•
    64â†’        self._thumb_cancel = CancelToken()
    65â†’        # åŸæ¯”ä¾‹æ˜¾ç¤ºï¼ˆç»Ÿä¸€æ–°é€»è¾‘ï¼‰
    66â†’        self._video_pix = None  # åŸå›¾åƒç´ ç¼“å­˜ç”¨äºresizeé‡ç®—
    67â†’        self._reference_info = summarize_reference_assets(self.video_data)
    68â†’        try:
    69â†’            self.video_data['_reference_info'] = self._reference_info
    70â†’        except Exception:
    71â†’            pass
    72â†’        self._ref_badge: Optional[QLabel] = None
    73â†’        self.setup_ui()
    74â†’        self._overlay: Optional[QLabel] = None
    75â†’        self._is_generating = False
    76â†’        self._elapsed_timer: Optional[QTimer] = None
    77â†’        self._elapsed_seconds = 0
    78â†’        self._thumbnail_requested = False
    79â†’        
    80â†’    def setup_ui(self):
    81â†’        """è®¾ç½®UI"""
    82â†’        self.setFrameStyle(QFrame.Box)
    83â†’        self.setStyleSheet("""
    84â†’            QFrame {
    85â†’                background-color: #1a1a1a;
    86â†’                border: 1px solid #3a3a5e;
    87â†’                border-radius: 8px;
    88â†’                margin: 5px;
    89â†’            }
    90â†’            QFrame:hover {
    91â†’                border-color: #FF6B35;
    92â†’            }
    93â†’        """)
    94â†’        
    95â†’        layout = QVBoxLayout(self)
    96â†’        layout.setContentsMargins(10, 10, 10, 10)
    97â†’        
    98â†’        # è§†é¢‘ç¼©ç•¥å›¾æ˜¾ç¤ºï¼ˆä¸å†å›ºå®š200Ã—200ï¼ŒæŒ‰åˆ—å®½è‡ªé€‚åº”ï¼‰
    99â†’        self.video_label = QLabel()
   100â†’        try:
   101â†’            self.video_label.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)
   102â†’        except Exception:
   103â†’            pass
   104â†’        self.video_label.setAlignment(Qt.AlignCenter)
   105â†’        try:
   106â†’            radius = DpiScaler.px(4)
   107â†’            self.video_label.setStyleSheet(f"border: 1px solid #ccc; border-radius: {radius}px;")
   108â†’        except Exception:
   109â†’            self.video_label.setStyleSheet("border: 1px solid #ccc; border-radius: 4px;")
   110â†’        try:
   111â†’            self.video_label.installEventFilter(self)
   112â†’        except Exception:
   113â†’            pass
   114â†’        self._ref_badge = QLabel(self.video_label)
   115â†’        self._ref_badge.setAlignment(Qt.AlignCenter)
   116â†’        self._ref_badge.setAttribute(Qt.WA_TransparentForMouseEvents, True)
   117â†’        try:
   118â†’            badge_radius = max(8, DpiScaler.px(10))
   119â†’        except Exception:
   120â†’            badge_radius = 10
   121â†’        self._ref_badge.setStyleSheet(
   122â†’            f"""
   123â†’            QLabel {{
   124â†’                background-color: rgba(0, 120, 212, 210);
   125â†’                color: #ffffff;
   126â†’                border-radius: {badge_radius}px;
   127â†’                padding: 2px 6px;
   128â†’                ;
   129â†’            }}
   130â†’            """
   131â†’        )
   132â†’        self._ref_badge.hide()
   133â†’
   134â†’        # è¿æ¥ä¿¡å·ï¼ŒçœŸå®åŠ è½½ç§»è‡³ showEvent
   135â†’        try:
   136â†’            self.thumbnail_path_ready.connect(self._apply_thumbnail)
   137â†’        except Exception:
   138â†’            pass
   139â†’
   140â†’        self.video_label.setText("ğŸ¬\nç­‰å¾…åŠ è½½")
   141â†’        self.video_label.setStyleSheet("""
   142â†’                QLabel { border: 1px solid #ccc; border-radius: 4px; ; color: #FF6B35; background-color: #2a2a2a; }
   143â†’            """)
   144â†’
   145â†’        layout.addWidget(self.video_label)
   146â†’        self._apply_reference_badge()
   147â†’        
   148â†’        # ä¿¡æ¯åŒºåŸŸ
   149â†’        info_layout = QVBoxLayout()
   150â†’        
   151â†’        # æç¤ºè¯ï¼ˆæˆªæ–­æ˜¾ç¤ºï¼‰
   152â†’        prompt = self.video_data.get('prompt', 'æ— æç¤ºè¯')
   153â†’        prompt_label = QLabel(f"æç¤ºè¯: {prompt[:30]}..." if len(prompt) > 30 else f"æç¤ºè¯: {prompt}")
   154â†’        prompt_label.setWordWrap(True)
   155â†’        try:
   156â†’            prompt_label.setStyleSheet("color: #ffffff;")  # Font size handled by unified style system
   157â†’        except Exception:
   158â†’            prompt_label.setStyleSheet("; color: #ffffff;")
   159â†’        info_layout.addWidget(prompt_label)
   160â†’        
   161â†’        # ç”Ÿæˆæ—¶é—´
   162â†’        created_at = self.video_data.get('created_at', '')
   163â†’        if created_at:
   164â†’            try:
   165â†’                dt = datetime.fromisoformat(created_at.replace('Z', '+00:00'))
   166â†’                time_str = dt.strftime('%Y-%m-%d %H:%M')
   167â†’            except:
   168â†’                time_str = created_at[:16] if len(created_at) > 16 else created_at
   169â†’        else:
   170â†’            time_str = 'æœªçŸ¥æ—¶é—´'
   171â†’        
   172â†’        time_label = QLabel(f"æ—¶é—´: {time_str}")
   173â†’        try:
   174â†’            time_label.setStyleSheet("color: #cccccc;")  # Font size handled by unified style system
   175â†’        except Exception:
   176â†’            time_label.setStyleSheet("; color: #cccccc;")
   177â†’        info_layout.addWidget(time_label)
   178â†’        
   179â†’        # è§†é¢‘ä¿¡æ¯ - ä» parameters ä¸­è·å–å‚æ•°ï¼ˆå…¼å®¹é¡¶çº§å­—æ®µï¼‰
   180â†’        params = self.video_data.get('parameters', {}) or {}
   181â†’        duration = params.get('duration') or self.video_data.get('duration', 'æœªçŸ¥')
   182â†’        resolution = build_resolution_text(self.video_data)
   183â†’        model_code = pick_model_code(self.video_data)
   184â†’        model_display_name = get_model_display_name(model_code)
   185â†’        
   186â†’        duration_label = QLabel(f"æ—¶é•¿: {duration}ç§’")
   187â†’        try:
   188â†’            duration_label.setStyleSheet("color: #cccccc;")  # Font size handled by unified style system
   189â†’        except Exception:
   190â†’            duration_label.setStyleSheet("; color: #cccccc;")
   191â†’        info_layout.addWidget(duration_label)
   192â†’        
   193â†’        resolution_label = QLabel(f"åˆ†è¾¨ç‡: {resolution}")
   194â†’        try:
   195â†’            resolution_label.setStyleSheet("color: #cccccc;")  # Font size handled by unified style system
   196â†’        except Exception:
   197â†’            resolution_label.setStyleSheet("; color: #cccccc;")
   198â†’        info_layout.addWidget(resolution_label)
   199â†’        
   200â†’        model_label = QLabel(f"æ¨¡å‹: {model_display_name}")
   201â†’        try:
   202â†’            model_label.setStyleSheet("color: #cccccc;")  # Font size handled by unified style system
   203â†’        except Exception:
   204â†’            model_label.setStyleSheet("; color: #cccccc;")
   205â†’        info_layout.addWidget(model_label)
   206â†’        
   207â†’        layout.addLayout(info_layout)
   208â†’        
   209â†’        # è®¾ç½®å³é”®èœå•
   210â†’        self.setContextMenuPolicy(Qt.CustomContextMenu)
   211â†’        self.customContextMenuRequested.connect(self.show_context_menu)
   212â†’
   213â†’    def showEvent(self, event):
   214â†’        """åœ¨å¡ç‰‡è¿›å…¥è§†å£æ—¶è§¦å‘ç¼©ç•¥å›¾åŠ è½½ã€‚"""
   215â†’        super().showEvent(event)
   216â†’        if not self._thumbnail_requested:
   217â†’            self.load_video_thumbnail()
   218â†’
   219â†’    def set_generating(self, is_generating: bool):
   220â†’        """è®¾ç½®ç”Ÿæˆä¸­è¦†ç›–çŠ¶æ€ã€‚"""
   221â†’        self._is_generating = bool(is_generating)
   222â†’        if is_generating:
   223â†’            self._elapsed_seconds = 0
   224â†’            self._show_overlay()
   225â†’            self._start_elapsed_timer()
   226â†’        else:
   227â†’            self._hide_overlay()
   228â†’            self._stop_elapsed_timer()
   229â†’
   230â†’    def _show_overlay(self):
   231â†’        if not self._overlay:
   232â†’            self._overlay = QLabel(self.video_label)
   233â†’            self._overlay.setAlignment(Qt.AlignCenter)
   234â†’            self._overlay.setStyleSheet(
   235â†’                """
   236â†’                background-color: rgba(0, 0, 0, 0.75);
   237â†’                color: #ffffff;
   238â†’                font-size: 14px;
   239â†’                font-weight: bold;
   240â†’            """
   241â†’            )
   242â†’            self._overlay.setAttribute(Qt.WA_TransparentForMouseEvents, True)
   243â†’        self._overlay.setText(f"ç”Ÿæˆä¸­ {self._elapsed_seconds}s")
   244â†’        self._overlay.setGeometry(0, 0, self.video_label.width(), self.video_label.height())
   245â†’        self._overlay.show()
   246â†’
   247â†’    def _hide_overlay(self):
   248â†’        if self._overlay:
   249â†’            self._overlay.hide()
   250â†’
   251â†’    def _start_elapsed_timer(self):
   252â†’        if not self._elapsed_timer:
   253â†’            self._elapsed_timer = QTimer(self)
   254â†’            self._elapsed_timer.timeout.connect(self._update_elapsed)
   255â†’        if not self._elapsed_timer.isActive():
   256â†’            self._elapsed_timer.start(1000)
   257â†’
   258â†’    def _stop_elapsed_timer(self):
   259â†’        if self._elapsed_timer and self._elapsed_timer.isActive():
   260â†’            self._elapsed_timer.stop()
   261â†’        self._elapsed_seconds = 0
   262â†’
   263â†’    def _update_elapsed(self):
   264â†’        self._elapsed_seconds += 1
   265â†’        if self._overlay and self._overlay.isVisible():
   266â†’            self._overlay.setText(f"ç”Ÿæˆä¸­ {self._elapsed_seconds}s")
   267â†’        
   268â†’    def load_video_thumbnail(self):
   269â†’        """å¼‚æ­¥åŠ è½½/ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆTaskRunnerï¼‰"""
   270â†’        if self._thumbnail_requested:
   271â†’            return
   272â†’        self._thumbnail_requested = True
   273â†’        try:
   274â†’            thumb_existing = (self.video_data.get('thumbnail_path', '') or self.video_data.get('thumbnail_local_path', ''))
   275â†’            if thumb_existing and os.path.exists(thumb_existing):
   276â†’                self._apply_thumbnail(thumb_existing)
   277â†’                return
   278â†’
   279â†’            video_path = self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '') or self.video_data.get('file_path', '')
   280â†’            if not (video_path and os.path.exists(video_path)):
   281â†’                self.video_label.setText("è§†é¢‘ä¸å­˜åœ¨")
   282â†’                self.video_label.setStyleSheet("""
   283â†’                    QLabel { border: 1px solid #ccc; border-radius: 4px; ; color: #888; }
   284â†’                """)
   285â†’                return
   286â†’
   287â†’            file_id = self.video_data.get('file_id', '') or self.video_data.get('generation_id', '') or self.video_data.get('id', '')
   288â†’            if not file_id:
   289â†’                return
   290â†’
   291â†’            key = f"video-thumb:{file_id}"
   292â†’
   293â†’            def _task():
   294â†’                from utils.video_thumbnail_generator import VideoThumbnailGenerator
   295â†’                from config_api import get_storage_dir
   296â†’                storage_dir = get_storage_dir()
   297â†’                thumbnails_dir = os.path.join(storage_dir, 'thumbnails')
   298â†’                gen = VideoThumbnailGenerator(thumbnails_dir)
   299â†’                return gen.generate_thumbnail_for_video(video_path, file_id)
   300â†’
   301â†’            def _on_done(path):
   302â†’                if path and os.path.exists(path):
   303â†’                    try:
   304â†’                        self.thumbnail_path_ready.emit(path)
   305â†’                    except Exception:
   306â†’                        pass
   307â†’
   308â†’            task_runner.submit(_task, key=key, cancel_token=self._thumb_cancel, on_done=_on_done)
   309â†’        except Exception as e:
   310â†’            self.video_label.setText(f"åŠ è½½é”™è¯¯: {str(e)}")
   311â†’
   312â†’    def _apply_thumbnail(self, thumbnail_path: str):
   313â†’        try:
   314â†’            pixmap = QPixmap(thumbnail_path)
   315â†’            if not pixmap.isNull():
   316â†’                self._video_pix = pixmap
   317â†’                self._update_video_pixmap()
   318â†’                self.video_label.setStyleSheet("""
   319â†’                    QLabel { border: 1px solid #ccc; border-radius: 4px; background-color: #2a2a2a; }
   320â†’                """)
   321â†’                self._apply_reference_badge()
   322â†’        except Exception:
   323â†’            pass
   324â†’
   325â†’    def _meta_dims(self) -> tuple:
   326â†’        try:
   327â†’            w = self.video_data.get('width')
   328â†’            h = self.video_data.get('height')
   329â†’            w = int(float(w)) if w not in (None, '') else None
   330â†’            h = int(float(h)) if h not in (None, '') else None
   331â†’            if not (w and h):
   332â†’                p = self.video_data.get('parameters') or {}
   333â†’                size_txt = p.get('size') or ''
   334â†’                if isinstance(size_txt, str) and 'x' in size_txt:
   335â†’                    sw, sh = size_txt.split('x')
   336â†’                    w, h = int(sw), int(sh)
   337â†’            if not (w and h):
   338â†’                w, h = 1, 1
   339â†’            return w, h
   340â†’        except Exception:
   341â†’            return 1, 1
   342â†’
   343â†’    def _refresh_reference_info(self) -> Dict[str, Any]:
   344â†’        info = self.video_data.get('_reference_info') if isinstance(self.video_data, dict) else None
   345â†’        if not isinstance(info, dict):
   346â†’            info = summarize_reference_assets(self.video_data)
   347â†’            try:
   348â†’                self.video_data['_reference_info'] = info
   349â†’            except Exception:
   350â†’                pass
   351â†’        self._reference_info = info or {}
   352â†’        return self._reference_info
   353â†’
   354â†’    def _apply_reference_badge(self):
   355â†’        if not isinstance(self._ref_badge, QLabel):
   356â†’            return
   357â†’        info = self._refresh_reference_info()
   358â†’        count = info.get('count', 0) if isinstance(info, dict) else 0
   359â†’        summary = info.get('summary', '') if isinstance(info, dict) else ''
   360â†’        if count:
   361â†’            self._ref_badge.setText(str(count))
   362â†’            try:
   363â†’                self._ref_badge.adjustSize()
   364â†’            except Exception:
   365â†’                pass
   366â†’            self._ref_badge.show()
   367â†’            self._update_reference_badge_geometry()
   368â†’        else:
   369â†’            self._ref_badge.hide()
   370â†’        try:
   371â†’            self.setToolTip(summary if summary else '')
   372â†’        except Exception:
   373â†’            pass
   374â†’
   375â†’    def _update_reference_badge_geometry(self):
   376â†’        if not isinstance(self._ref_badge, QLabel) or not self._ref_badge.isVisible():
   377â†’            return
   378â†’        if not hasattr(self, 'video_label'):
   379â†’            return
   380â†’        label_w = self.video_label.width()
   381â†’        label_h = self.video_label.height()
   382â†’        if label_w <= 0 or label_h <= 0:
   383â†’            return
   384â†’        try:
   385â†’            badge_size = self._ref_badge.sizeHint()
   386â†’        except Exception:
   387â†’            badge_size = self._ref_badge.size()
   388â†’        try:
   389â†’            margin = max(4, DpiScaler.px(6))
   390â†’        except Exception:
   391â†’            margin = 6
   392â†’        x = max(0, label_w - badge_size.width() - margin)
   393â†’        y = margin
   394â†’        self._ref_badge.move(x, y)
   395â†’
   396â†’    def set_column_width(self, width: int):
   397â†’        try:
   398â†’            self._column_width = int(width)
   399â†’            w, h = self._meta_dims()
   400â†’            target_h = int(round(self._column_width * h / max(1, w)))
   401â†’            try:
   402â†’                self.video_label.setFixedHeight(target_h)
   403â†’            except Exception:
   404â†’                pass
   405â†’            # è‹¥å·²åŠ è½½ç¼©ç•¥å›¾ï¼Œé‡æ–°æŒ‰åˆ—å®½ç¼©æ”¾
   406â†’            if getattr(self, '_video_pix', None) is not None:
   407â†’                self._update_video_pixmap()
   408â†’            self._update_reference_badge_geometry()
   409â†’        except Exception:
   410â†’            pass
   411â†’
   412â†’    def _available_content_width(self) -> int:
   413â†’        try:
   414â†’            if hasattr(self, '_column_width') and isinstance(self._column_width, int) and self._column_width > 0:
   415â†’                return int(self._column_width)
   416â†’            margins = self.layout().contentsMargins() if isinstance(self.layout(), QVBoxLayout) else None
   417â†’            pad = (margins.left() + margins.right()) if margins else 20
   418â†’            w = max(1, self.width() - pad)
   419â†’            # å¦‚æœå¸ƒå±€å°šæœªå°±ç»ªï¼Œé€€åŒ–ä¸ºlabelå½“å‰å®½åº¦
   420â†’            if self.video_label.width() > 0:
   421â†’                w = max(w, self.video_label.width())
   422â†’            # å†æ¬¡å…œåº•ï¼šä½¿ç”¨è®¾è®¡åˆ—å®½ï¼ˆ280ï¼‰çš„DPIç¼©æ”¾ä½œä¸ºæœ€ä½å®½åº¦
   423â†’            try:
   424â†’                w = max(w, DpiScaler.px(280) - pad)
   425â†’            except Exception:
   426â†’                w = max(w, 200)
   427â†’            return w
   428â†’        except Exception:
   429â†’            try:
   430â†’                return max(1, DpiScaler.px(260))
   431â†’            except Exception:
   432â†’                return 220
   433â†’
   434â†’    def _update_video_pixmap(self):
   435â†’        try:
   436â†’            if not self._video_pix:
   437â†’                return
   438â†’            content_w = self._available_content_width()
   439â†’            pw = max(1, self._video_pix.width())
   440â†’            ph = max(1, self._video_pix.height())
   441â†’            target_w = content_w
   442â†’            target_h = int(round(target_w * ph / pw))
   443â†’            scaled = self._video_pix.scaled(target_w, target_h, Qt.KeepAspectRatio, Qt.SmoothTransformation)
   444â†’            self.video_label.setPixmap(scaled)
   445â†’            try:
   446â†’                self.video_label.setFixedHeight(scaled.height())
   447â†’            except Exception:
   448â†’                pass
   449â†’            self._update_reference_badge_geometry()
   450â†’        except Exception:
   451â†’            pass
   452â†’
   453â†’    def resizeEvent(self, event):
   454â†’        super().resizeEvent(event)
   455â†’        if getattr(self, '_video_pix', None) is not None:
   456â†’            self._update_video_pixmap()
   457â†’        self._update_reference_badge_geometry()
   458â†’        if self._overlay and self._overlay.isVisible():
   459â†’            self._overlay.setGeometry(0, 0, self.video_label.width(), self.video_label.height())
   460â†’
   461â†’    def eventFilter(self, obj, event):
   462â†’        try:
   463â†’            if obj is getattr(self, 'video_label', None) and event.type() == QEvent.Resize:
   464â†’                self._update_reference_badge_geometry()
   465â†’        except Exception:
   466â†’            pass
   467â†’        return super().eventFilter(obj, event)
   468â†’
   469â†’    def mousePressEvent(self, event):
   470â†’        """é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶"""
   471â†’        if event.button() == Qt.LeftButton:
   472â†’            self.on_click(event)
   473â†’        super().mousePressEvent(event)
   474â†’    
   475â†’    def on_click(self, event):
   476â†’        """ç‚¹å‡»äº‹ä»¶ - æ˜¾ç¤ºè§†é¢‘è¯¦ç»†ä¿¡æ¯"""
   477â†’        if _video_detail_handler:
   478â†’            try:
   479â†’                _video_detail_handler(self.video_data, self.video_list, self.current_index, self)
   480â†’                return
   481â†’            except Exception as exc:
   482â†’                logger.error(f"æ˜¾ç¤ºè§†é¢‘è¯¦æƒ…å¤±è´¥: {exc}")
   483â†’        self.show_styled_message("é”™è¯¯", "æ— æ³•æ˜¾ç¤ºè§†é¢‘è¯¦æƒ…ï¼šæœªæ³¨å†Œå¤„ç†å™¨ã€‚", "warning")
   484â†’    
   485â†’    def show_context_menu(self, position):
   486â†’        """æ˜¾ç¤ºå³é”®ä¸Šä¸‹æ–‡èœå•"""
   487â†’        menu = QMenu(self)
   488â†’        menu.setStyleSheet("""
   489â†’            QMenu {
   490â†’                background-color: #2a2a2a;
   491â†’                color: white;
   492â†’                border: 1px solid #555;
   493â†’                border-radius: 4px;
   494â†’                padding: 4px;
   495â†’            }
   496â†’            QMenu::item {
   497â†’                padding: 8px 16px;
   498â†’                border-radius: 4px;
   499â†’            }
   500â†’            QMenu::item:selected {
   501â†’                background-color: #4CAF50;
   502â†’            }
   503â†’        """)
   504â†’        
   505â†’        # ä¸‹è½½è§†é¢‘åŠ¨ä½œ
   506â†’        download_action = QAction("ä¸‹è½½è§†é¢‘", self)
   507â†’        download_action.triggered.connect(self.download_video)
   508â†’        menu.addAction(download_action)
   509â†’        
   510â†’        # å¤åˆ¶è§†é¢‘è·¯å¾„åŠ¨ä½œ
   511â†’        copy_path_action = QAction("å¤åˆ¶è·¯å¾„", self)
   512â†’        copy_path_action.triggered.connect(self.copy_video_path)
   513â†’        menu.addAction(copy_path_action)
   514â†’        
   515â†’        # å¤åˆ¶æç¤ºè¯åŠ¨ä½œ
   516â†’        copy_prompt_action = QAction("å¤åˆ¶æç¤ºè¯", self)
   517â†’        copy_prompt_action.triggered.connect(self.copy_prompt)
   518â†’        menu.addAction(copy_prompt_action)
   519â†’        
   520â†’        # æ˜¾ç¤ºèœå•
   521â†’        menu.exec(self.mapToGlobal(position))
   522â†’    
   523â†’    def download_video(self):
   524â†’        """ä¸‹è½½è§†é¢‘åˆ°æŒ‡å®šä½ç½®"""
   525â†’        video_path = self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')
   526â†’        if not video_path or not os.path.exists(video_path):
   527â†’            self.show_styled_message("é”™è¯¯", "è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨", "warning")
   528â†’            return
   529â†’        
   530â†’        default_name = f"video_{datetime.now().strftime('%Y%m%d_%H%M%S')}.mp4"
   531â†’        save_path = safe_get_save_file_name(
   532â†’            self,
   533â†’            "ä¿å­˜è§†é¢‘",
   534â†’            default_name,
   535â†’            "è§†é¢‘æ–‡ä»¶ (*.mp4)"
   536â†’        )
   537â†’        
   538â†’        if save_path:
   539â†’            try:
   540â†’                import shutil
   541â†’                shutil.copy2(video_path, save_path)
   542â†’                self.show_styled_message("æˆåŠŸ", f"è§†é¢‘å·²ä¿å­˜åˆ°: {os.path.basename(save_path)}", "information")
   543â†’            except Exception as e:
   544â†’                self.show_styled_message("é”™è¯¯", f"ä¿å­˜è§†é¢‘å¤±è´¥: {str(e)}", "critical")
   545â†’    
   546â†’    def copy_video_path(self):
   547â†’        """å¤åˆ¶è§†é¢‘è·¯å¾„åˆ°å‰ªè´´æ¿"""
   548â†’        video_path = self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')
   549â†’        if video_path:
   550â†’            clipboard = QApplication.clipboard()
   551â†’            clipboard.setText(video_path)
   552â†’            self.show_styled_message("æˆåŠŸ", "è§†é¢‘è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "information")
   553â†’        else:
   554â†’            self.show_styled_message("é”™è¯¯", "è§†é¢‘è·¯å¾„ä¸å­˜åœ¨", "warning")
   555â†’    
   556â†’    def copy_prompt(self):
   557â†’        """å¤åˆ¶æç¤ºè¯åˆ°å‰ªè´´æ¿"""
   558â†’        prompt = self.video_data.get('prompt', '')
   559â†’        if prompt:
   560â†’            clipboard = QApplication.clipboard()
   561â†’            clipboard.setText(prompt)
   562â†’            self.show_styled_message("æˆåŠŸ", "æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "information")
   563â†’        else:
   564â†’            self.show_styled_message("é”™è¯¯", "æç¤ºè¯ä¸å­˜åœ¨", "warning")
   565â†’    
   566â†’    def show_styled_message(self, title: str, message: str, icon_type: str = "information"):
   567â†’        """æ˜¾ç¤ºå¸¦æœ‰æ·±è‰²ä¸»é¢˜æ ·å¼çš„æ¶ˆæ¯æ¡†"""
   568â†’        msg_box = QMessageBox(self)
   569â†’        msg_box.setWindowTitle(title)
   570â†’        msg_box.setText(message)
   571â†’        
   572â†’        # è®¾ç½®å›¾æ ‡
   573â†’        if icon_type == "warning":
   574â†’            msg_box.setIcon(QMessageBox.Warning)
   575â†’        elif icon_type == "critical":
   576â†’            msg_box.setIcon(QMessageBox.Critical)
   577â†’        elif icon_type == "question":
   578â†’            msg_box.setIcon(QMessageBox.Question)
   579â†’        else:
   580â†’            msg_box.setIcon(QMessageBox.Information)
   581â†’        
   582â†’        # æ ·å¼ç”±å…¨å±€QSSæ§åˆ¶ï¼Œä¸åœ¨æ­¤è¦†ç›–
   583â†’        
   584â†’        msg_box.exec()
   585â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
