     1â†’#!/usr/bin/env python3
     2â†’# -*- coding: utf-8 -*-
     3â†’"""
     4â†’å›¾ç‰‡å¡ç‰‡ç»„ä»¶ï¼ˆä»Ž qt_app.py æ‹†åˆ†ï¼‰.
     5â†’
     6â†’DEPRECATED: ImageCard ç±»å·²åºŸå¼ƒï¼Œä»…åœ¨ archive/ ä¸­çš„æ—§ä»£ç ä½¿ç”¨ã€‚
     7â†’çŽ°ä»£è§†å›¾ä½¿ç”¨ components/delegates/image_card_delegate.py ä¸­çš„ ImageCardDelegateã€‚
     8â†’
     9â†’æ³¨æ„: set_image_detail_handler å‡½æ•°ä»åœ¨ä¸»ä»£ç ä¸­ä½¿ç”¨ï¼Œè¯·å‹¿åˆ é™¤ã€‚
    10â†’"""
    11â†’
    12â†’from __future__ import annotations
    13â†’
    14â†’import json
    15â†’import os
    16â†’from datetime import datetime
    17â†’from typing import Any, Callable, Dict, List, Optional
    18â†’
    19â†’from PySide6.QtCore import QEvent, QMimeData, Qt, QUrl, QTimer, Signal
    20â†’from PySide6.QtGui import QDrag, QPixmap
    21â†’from PySide6.QtWidgets import QLabel, QFrame, QMessageBox, QVBoxLayout
    22â†’
    23â†’from loguru import logger
    24â†’from utils.reference_assets import summarize_reference_assets
    25â†’from utils.reference_display import get_model_display_name
    26â†’from utils.style_system import unified_style_system
    27â†’from utils.ui_utils import DpiScaler
    28â†’from utils.task_runner import TaskRunner
    29â†’
    30â†’DetailHandler = Optional[Callable[[Dict[str, Any], List[Dict[str, Any]], int, QFrame], None]]
    31â†’_image_detail_handler: DetailHandler = None
    32â†’
    33â†’
    34â†’def set_image_detail_handler(handler: DetailHandler) -> None:
    35â†’    """æ³¨å†Œå›¾ç‰‡è¯¦æƒ…å¯¹è¯æ¡†å¤„ç†å™¨ã€‚"""
    36â†’    global _image_detail_handler
    37â†’    _image_detail_handler = handler
    38â†’
    39â†’
    40â†’class ImageCard(QFrame):
    41â†’    """å›¾ç‰‡å¡ç‰‡ç»„ä»¶"""
    42â†’    
    43â†’    addToReferenceRequested = Signal(str) # Path
    44â†’    
    45â†’    def __init__(self, image_data: Dict[str, Any], image_list: List[Dict[str, Any]] = None, current_index: int = 0, parent=None):
    46â†’        super().__init__(parent)
    47â†’        self.image_data = image_data
    48â†’        self.image_list = image_list or [image_data]  # å›¾ç‰‡åˆ—è¡¨
    49â†’        self.current_index = current_index  # å½“å‰å›¾ç‰‡ç´¢å¼•
    50â†’        # åŽŸæ¯”ä¾‹æ˜¾ç¤ºï¼ˆç»Ÿä¸€æ–°é€»è¾‘ï¼‰
    51â†’        self._image_pix = None
    52â†’        self._reference_info = summarize_reference_assets(self.image_data)
    53â†’        try:
    54â†’            self.image_data['_reference_info'] = self._reference_info
    55â†’        except Exception:
    56â†’            pass
    57â†’        except Exception:
    58â†’            pass
    59â†’        self._ref_badge: Optional[QLabel] = None
    60â†’        self.setup_ui()
    61â†’        self._overlay: Optional[QLabel] = None
    62â†’        
    63â†’        # Signal
    64â†’        self.setContextMenuPolicy(Qt.CustomContextMenu)
    65â†’        self.customContextMenuRequested.connect(self.show_context_menu)
    66â†’        self._is_generating = False
    67â†’        self._thumbnail_loaded = False
    68â†’        
    69â†’        # å¯ç”¨æ‹–æ‹½åŠŸèƒ½
    70â†’        self.setAcceptDrops(False)  # å¡ç‰‡æœ¬èº«ä¸æŽ¥å—æ‹–æ‹½
    71â†’        self.image_label.setAcceptDrops(False)
    72â†’        
    73â†’    def mousePressEvent(self, event):
    74â†’        """é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ - å¼€å§‹æ‹–æ‹½"""
    75â†’        if event.button() == Qt.LeftButton:
    76â†’            # æ£€æŸ¥æ˜¯å¦ç‚¹å‡»åœ¨å›¾ç‰‡åŒºåŸŸ
    77â†’            if self.image_label.geometry().contains(event.pos()):
    78â†’                # åˆ›å»ºæ‹–æ‹½æ“ä½œ
    79â†’                drag = QDrag(self)
    80â†’                mime_data = QMimeData()
    81â†’                
    82â†’                # è®¾ç½®å›¾ç‰‡è·¯å¾„
    83â†’                image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')
    84â†’                if image_path and os.path.exists(image_path):
    85â†’                    mime_data.setUrls([QUrl.fromLocalFile(image_path)])
    86â†’                    
    87â†’                    # è®¾ç½®æ‹–æ‹½å›¾æ ‡
    88â†’                    pixmap = QPixmap(image_path)
    89â†’                    if not pixmap.isNull():
    90â†’                        # ç¼©æ”¾æ‹–æ‹½å›¾æ ‡
    91â†’                        scaled_pixmap = pixmap.scaled(64, 64, Qt.KeepAspectRatio, Qt.SmoothTransformation)
    92â†’                        drag.setPixmap(scaled_pixmap)
    93â†’                        drag.setHotSpot(scaled_pixmap.rect().center())
    94â†’                    
    95â†’                    drag.setMimeData(mime_data)
    96â†’                    
    97â†’                    # æ‰§è¡Œæ‹–æ‹½
    98â†’                    drop_action = drag.exec(Qt.CopyAction)
    99â†’                    return
   100â†’        
   101â†’        # å¦‚æžœä¸æ˜¯æ‹–æ‹½æ“ä½œï¼Œæ‰§è¡ŒåŽŸæ¥çš„ç‚¹å‡»äº‹ä»¶
   102â†’        super().mousePressEvent(event)
   103â†’        
   104â†’    def mouseReleaseEvent(self, event):
   105â†’        """é¼ æ ‡é‡Šæ”¾äº‹ä»¶ - å¤„ç†ç‚¹å‡»"""
   106â†’        if event.button() == Qt.LeftButton:
   107â†’            # æ£€æŸ¥æ˜¯å¦æ˜¯ç®€å•ç‚¹å‡»ï¼ˆæ²¡æœ‰æ‹–æ‹½ï¼‰
   108â†’            if self.image_label.geometry().contains(event.pos()):
   109â†’                self.on_click(event)
   110â†’        super().mouseReleaseEvent(event)
   111â†’        
   112â†’    def setup_ui(self):
   113â†’        """è®¾ç½®UI"""
   114â†’        self.setFrameStyle(QFrame.Box)
   115â†’        self.setStyleSheet("""
   116â†’            QFrame {
   117â†’                background-color: #1a1a1a;
   118â†’                border: 1px solid #3a3a5e;
   119â†’                border-radius: 8px;
   120â†’                margin: 5px;
   121â†’            }
   122â†’            QFrame:hover {
   123â†’                border-color: #4CAF50;
   124â†’            }
   125â†’        """)
   126â†’        
   127â†’        layout = QVBoxLayout(self)
   128â†’        layout.setContentsMargins(10, 10, 10, 10)
   129â†’        
   130â†’        # å›¾ç‰‡æ˜¾ç¤ºï¼ˆä¸å†å›ºå®š200Ã—200ï¼ŒæŒ‰åˆ—å®½è‡ªé€‚åº”ï¼‰
   131â†’        self.image_label = QLabel()
   132â†’        try:
   133â†’            from PySide6.QtWidgets import QSizePolicy
   134â†’            self.image_label.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)
   135â†’        except Exception:
   136â†’            pass
   137â†’        self.image_label.setAlignment(Qt.AlignCenter)  # å±…ä¸­å¯¹é½
   138â†’        self.image_label.setStyleSheet("border: 1px solid #ccc; border-radius: 4px;")
   139â†’        try:
   140â†’            self.image_label.installEventFilter(self)
   141â†’        except Exception:
   142â†’            pass
   143â†’        self._ref_badge = QLabel(self.image_label)
   144â†’        self._ref_badge.setAlignment(Qt.AlignCenter)
   145â†’        self._ref_badge.setAttribute(Qt.WA_TransparentForMouseEvents, True)
   146â†’        try:
   147â†’            radius = max(8, DpiScaler.px(10))
   148â†’        except Exception:
   149â†’            radius = 10
   150â†’        self._ref_badge.setStyleSheet(
   151â†’            f"""
   152â†’            QLabel {{
   153â†’                background-color: rgba(255, 140, 0, 210);
   154â†’                color: #ffffff;
   155â†’                border-radius: {radius}px;
   156â†’                padding: 2px 6px;
   157â†’                ;
   158â†’            }}
   159â†’            """
   160â†’        )
   161â†’        self._ref_badge.hide()
   162â†’
   163â†’        # åˆå§‹å±•ç¤ºå ä½æ–‡æ¡ˆï¼Œå®žé™…åŠ è½½æŽ¨è¿Ÿåˆ° showEvent
   164â†’        self.image_label.setText("ðŸ–¼ï¸\nç­‰å¾…åŠ è½½")
   165â†’
   166â†’        layout.addWidget(self.image_label)
   167â†’        self._apply_reference_badge()
   168â†’        
   169â†’        # ä¿¡æ¯åŒºåŸŸ
   170â†’        info_layout = QVBoxLayout()
   171â†’        
   172â†’        # æç¤ºè¯ï¼ˆæˆªæ–­æ˜¾ç¤ºï¼‰
   173â†’        prompt = self.image_data.get('prompt', 'æ— æç¤ºè¯')
   174â†’        prompt_label = QLabel(f"æç¤ºè¯: {prompt[:30]}..." if len(prompt) > 30 else f"æç¤ºè¯: {prompt}")
   175â†’        prompt_label.setWordWrap(True)
   176â†’        prompt_label.setStyleSheet("; color: #ffffff;")
   177â†’        info_layout.addWidget(prompt_label)
   178â†’        
   179â†’        # ç”Ÿæˆæ—¶é—´
   180â†’        created_at = self.image_data.get('created_at', '')
   181â†’        if created_at:
   182â†’            try:
   183â†’                dt = datetime.fromisoformat(created_at.replace('Z', '+00:00'))
   184â†’                time_str = dt.strftime('%Y-%m-%d %H:%M')
   185â†’            except:
   186â†’                time_str = created_at[:16] if len(created_at) > 16 else created_at
   187â†’        else:
   188â†’            time_str = 'æœªçŸ¥æ—¶é—´'
   189â†’        
   190â†’        time_label = QLabel(f"æ—¶é—´: {time_str}")
   191â†’        time_label.setStyleSheet("; color: #cccccc;")
   192â†’        info_layout.addWidget(time_label)
   193â†’        
   194â†’        # æ¨¡åž‹ä¿¡æ¯
   195â†’        params = self.image_data.get('parameters', '{}')
   196â†’        if isinstance(params, str):
   197â†’            try:
   198â†’                params = json.loads(params)
   199â†’            except:
   200â†’                params = {}
   201â†’        
   202â†’        model_code = params.get('model', 'æœªçŸ¥æ¨¡åž‹')
   203â†’        model_display_name = get_model_display_name(model_code)
   204â†’        model_label = QLabel(f"æ¨¡åž‹: {model_display_name}")
   205â†’        model_label.setStyleSheet("; color: #cccccc;")
   206â†’        info_layout.addWidget(model_label)
   207â†’        
   208â†’        layout.addLayout(info_layout)
   209â†’
   210â†’        # ç‚¹å‡»äº‹ä»¶
   211â†’        self.mousePressEvent = self.on_click
   212â†’
   213â†’    def showEvent(self, event):
   214â†’        """åœ¨å¡ç‰‡æ˜¾ç¤ºæ—¶è§¦å‘ç¼©ç•¥å›¾åŠ è½½ã€‚"""
   215â†’        super().showEvent(event)
   216â†’        if not self._thumbnail_loaded:
   217â†’            self._load_thumbnail()
   218â†’
   219â†’    def set_generating(self, is_generating: bool, progress: int = 0):
   220â†’        """è®¾ç½®ç”Ÿæˆä¸­è¦†ç›–çŠ¶æ€ã€‚"""
   221â†’        self._is_generating = bool(is_generating)
   222â†’        if is_generating:
   223â†’            self._show_overlay(progress)
   224â†’        else:
   225â†’            self._hide_overlay()
   226â†’
   227â†’    def _show_overlay(self, progress: int = 0):
   228â†’        if not self._overlay:
   229â†’            self._overlay = QLabel(self.image_label)
   230â†’            self._overlay.setAlignment(Qt.AlignCenter)
   231â†’            self._overlay.setStyleSheet(
   232â†’                """
   233â†’                background-color: rgba(0, 0, 0, 0.72);
   234â†’                color: #ffffff;
   235â†’                font-size: 14px;
   236â†’                font-weight: bold;
   237â†’            """
   238â†’            )
   239â†’            self._overlay.setAttribute(Qt.WA_TransparentForMouseEvents, True)
   240â†’
   241â†’        if progress > 0:
   242â†’            self._overlay.setText(f"ç”Ÿæˆä¸­... {progress}%")
   243â†’        else:
   244â†’            self._overlay.setText("ç”Ÿæˆä¸­...")
   245â†’
   246â†’        self._overlay.setGeometry(0, 0, self.image_label.width(), self.image_label.height())
   247â†’        self._overlay.show()
   248â†’
   249â†’    def _hide_overlay(self):
   250â†’        if self._overlay:
   251â†’            self._overlay.hide()
   252â†’        
   253â†’    def _load_thumbnail(self):
   254â†’        """å»¶è¿ŸåŠ è½½ç¼©ç•¥å›¾ï¼Œé¿å…éžå¯è§å¡ç‰‡å ç”¨IOã€‚"""
   255â†’        if self._thumbnail_loaded:
   256â†’            return
   257â†’
   258â†’        image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')
   259â†’        if not image_path or not os.path.exists(image_path):
   260â†’            self._thumbnail_loaded = True
   261â†’            self.image_label.setText("å›¾ç‰‡ä¸å­˜åœ¨")
   262â†’            logger.debug(f"å›¾ç‰‡è·¯å¾„æ— æ•ˆï¼Œè·³è¿‡ç¼©ç•¥å›¾åŠ è½½: {image_path}")
   263â†’            return
   264â†’
   265â†’        self._thumbnail_loaded = True
   266â†’        self.image_label.setText("ðŸ–¼ï¸\nåŠ è½½ä¸­...")
   267â†’
   268â†’        task_runner = TaskRunner.instance()
   269â†’
   270â†’        def _load() -> Optional[QPixmap]:
   271â†’            try:
   272â†’                if os.path.exists(image_path):
   273â†’                    pixmap = QPixmap(image_path)
   274â†’                    if not pixmap.isNull():
   275â†’                        return pixmap
   276â†’            except Exception as exc:
   277â†’                logger.warning(f"ç¼©ç•¥å›¾è¯»å–å¤±è´¥: {exc}")
   278â†’            return None
   279â†’
   280â†’        def _on_done(pixmap: Optional[QPixmap]):
   281â†’            def _apply_result():
   282â†’                if pixmap:
   283â†’                    self._image_pix = pixmap
   284â†’                    self._update_image_pixmap()
   285â†’                    self._apply_reference_badge()
   286â†’                else:
   287â†’                    self.image_label.setText("å›¾ç‰‡åŠ è½½å¤±è´¥")
   288â†’
   289â†’            try:
   290â†’                QTimer.singleShot(0, _apply_result)
   291â†’            except Exception:
   292â†’                _apply_result()
   293â†’
   294â†’        task_key = f"thumb:{self.image_data.get('file_id') or image_path}"
   295â†’        task_runner.submit(_load, on_done=_on_done, key=task_key)
   296â†’    
   297â†’    def _available_content_width(self) -> int:
   298â†’        try:
   299â†’            if hasattr(self, '_column_width') and isinstance(self._column_width, int) and self._column_width > 0:
   300â†’                return int(self._column_width)
   301â†’            margins = self.layout().contentsMargins() if isinstance(self.layout(), QVBoxLayout) else None
   302â†’            pad = (margins.left() + margins.right()) if margins else 20
   303â†’            w = max(1, self.width() - pad)
   304â†’            if self.image_label.width() > 0:
   305â†’                w = max(w, self.image_label.width())
   306â†’            try:
   307â†’                w = max(w, DpiScaler.px(280) - pad)
   308â†’            except Exception:
   309â†’                w = max(w, 200)
   310â†’            return w
   311â†’        except Exception:
   312â†’            try:
   313â†’                return max(1, DpiScaler.px(260))
   314â†’            except Exception:
   315â†’                return 220
   316â†’
   317â†’    def _meta_dims(self) -> tuple:
   318â†’        try:
   319â†’            w = self.image_data.get('width')
   320â†’            h = self.image_data.get('height')
   321â†’            w = int(float(w)) if w not in (None, '') else None
   322â†’            h = int(float(h)) if h not in (None, '') else None
   323â†’            if not (w and h):
   324â†’                p = self.image_data.get('parameters') or {}
   325â†’                if isinstance(p, str):
   326â†’                    try:
   327â†’                        p = json.loads(p)
   328â†’                    except Exception:
   329â†’                        p = {}
   330â†’                size_txt = p.get('size') or ''
   331â†’                if isinstance(size_txt, str) and 'x' in size_txt:
   332â†’                    sw, sh = size_txt.split('x')
   333â†’                    w, h = int(sw), int(sh)
   334â†’            if not (w and h):
   335â†’                return None, None
   336â†’            return w, h
   337â†’        except Exception:
   338â†’            return None, None
   339â†’
   340â†’    def _refresh_reference_info(self) -> Dict[str, Any]:
   341â†’        info = self.image_data.get('_reference_info') if isinstance(self.image_data, dict) else None
   342â†’        if not isinstance(info, dict):
   343â†’            info = summarize_reference_assets(self.image_data)
   344â†’            try:
   345â†’                self.image_data['_reference_info'] = info
   346â†’            except Exception:
   347â†’                pass
   348â†’        self._reference_info = info or {}
   349â†’        return self._reference_info
   350â†’
   351â†’    def _apply_reference_badge(self):
   352â†’        if not isinstance(self._ref_badge, QLabel):
   353â†’            return
   354â†’        info = self._refresh_reference_info()
   355â†’        count = info.get('count', 0) if isinstance(info, dict) else 0
   356â†’        summary = info.get('summary', '') if isinstance(info, dict) else ''
   357â†’        if count:
   358â†’            self._ref_badge.setText(str(count))
   359â†’            try:
   360â†’                self._ref_badge.adjustSize()
   361â†’            except Exception:
   362â†’                pass
   363â†’            self._ref_badge.show()
   364â†’            self._update_reference_badge_geometry()
   365â†’        else:
   366â†’            self._ref_badge.hide()
   367â†’        try:
   368â†’            self.setToolTip(summary if summary else '')
   369â†’        except Exception:
   370â†’            pass
   371â†’
   372â†’    def _update_reference_badge_geometry(self):
   373â†’        if not isinstance(self._ref_badge, QLabel) or not self._ref_badge.isVisible():
   374â†’            return
   375â†’        if not hasattr(self, 'image_label'):
   376â†’            return
   377â†’        label_w = self.image_label.width()
   378â†’        label_h = self.image_label.height()
   379â†’        if label_w <= 0 or label_h <= 0:
   380â†’            return
   381â†’        try:
   382â†’            badge_size = self._ref_badge.sizeHint()
   383â†’        except Exception:
   384â†’            badge_size = self._ref_badge.size()
   385â†’        try:
   386â†’            margin = max(4, DpiScaler.px(6))
   387â†’        except Exception:
   388â†’            margin = 6
   389â†’        x = max(0, label_w - badge_size.width() - margin)
   390â†’        y = margin
   391â†’        self._ref_badge.move(x, y)
   392â†’
   393â†’    def set_column_width(self, width: int):
   394â†’        try:
   395â†’            self._column_width = int(width)
   396â†’            w, h = self._meta_dims()
   397â†’            if w and h:
   398â†’                target_h = int(round(self._column_width * h / max(1, w)))
   399â†’                try:
   400â†’                    self.image_label.setFixedHeight(target_h)
   401â†’                except Exception:
   402â†’                    pass
   403â†’            if getattr(self, '_image_pix', None) is not None:
   404â†’                self._update_image_pixmap()
   405â†’            self._update_reference_badge_geometry()
   406â†’        except Exception:
   407â†’            pass
   408â†’
   409â†’    def _update_image_pixmap(self):
   410â†’        try:
   411â†’            if not self._image_pix:
   412â†’                return
   413â†’            content_w = self._available_content_width()
   414â†’            pw = max(1, self._image_pix.width())
   415â†’            ph = max(1, self._image_pix.height())
   416â†’            target_w = content_w
   417â†’            target_h = int(round(target_w * ph / pw))
   418â†’            scaled = self._image_pix.scaled(target_w, target_h, Qt.KeepAspectRatio, Qt.SmoothTransformation)
   419â†’            self.image_label.setPixmap(scaled)
   420â†’            try:
   421â†’                self.image_label.setFixedHeight(scaled.height())
   422â†’            except Exception:
   423â†’                pass
   424â†’            self._update_reference_badge_geometry()
   425â†’        except Exception:
   426â†’            pass
   427â†’
   428â†’    def resizeEvent(self, event):
   429â†’        super().resizeEvent(event)
   430â†’        if getattr(self, '_image_pix', None) is not None:
   431â†’            self._update_image_pixmap()
   432â†’        self._update_reference_badge_geometry()
   433â†’        if self._overlay and self._overlay.isVisible():
   434â†’            self._overlay.setGeometry(0, 0, self.image_label.width(), self.image_label.height())
   435â†’
   436â†’    def on_click(self, event):
   437â†’        """ç‚¹å‡»äº‹ä»¶ - æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯"""
   438â†’        if _image_detail_handler:
   439â†’            try:
   440â†’                _image_detail_handler(self.image_data, self.image_list, self.current_index, self)
   441â†’                return
   442â†’            except Exception as exc:
   443â†’                logger.error(f"æ˜¾ç¤ºå›¾ç‰‡è¯¦æƒ…å¤±è´¥: {exc}")
   444â†’        self.show_styled_message("é”™è¯¯", "æ— æ³•æ˜¾ç¤ºå›¾ç‰‡è¯¦æƒ…ï¼šæœªæ³¨å†Œå¤„ç†å™¨ã€‚", "warning")
   445â†’
   446â†’    def eventFilter(self, obj, event):
   447â†’        try:
   448â†’            if obj is getattr(self, 'image_label', None) and event.type() == QEvent.Resize:
   449â†’                self._update_reference_badge_geometry()
   450â†’        except Exception:
   451â†’            pass
   452â†’        return super().eventFilter(obj, event)
   453â†’    
   454â†’    def show_styled_message(self, title: str, message: str, icon_type: str = "information"):
   455â†’        """æ˜¾ç¤ºå¸¦æœ‰æ·±è‰²ä¸»é¢˜æ ·å¼çš„æ¶ˆæ¯æ¡†"""
   456â†’        msg_box = QMessageBox(self)
   457â†’        msg_box.setWindowTitle(title)
   458â†’        msg_box.setText(message)
   459â†’        
   460â†’        # è®¾ç½®å›¾æ ‡
   461â†’        if icon_type == "warning":
   462â†’            msg_box.setIcon(QMessageBox.Warning)
   463â†’        elif icon_type == "critical":
   464â†’            msg_box.setIcon(QMessageBox.Critical)
   465â†’        elif icon_type == "question":
   466â†’            msg_box.setIcon(QMessageBox.Question)
   467â†’        else:
   468â†’            msg_box.setIcon(QMessageBox.Information)
   469â†’        
   470â†’        # æ ·å¼ç”±å…¨å±€QSSæŽ§åˆ¶ï¼Œä¸åœ¨æ­¤è¦†ç›–
   471â†’        
   472â†’        
   473â†’        # æ ·å¼ç”±å…¨å±€QSSæŽ§åˆ¶ï¼Œä¸åœ¨æ­¤è¦†ç›–
   474â†’        
   475â†’        msg_box.exec()
   476â†’
   477â†’    def show_context_menu(self, pos):
   478â†’        """æ˜¾ç¤ºå³é”®èœå•"""
   479â†’        from PySide6.QtWidgets import QMenu
   480â†’        from PySide6.QtGui import QAction
   481â†’        menu = QMenu(self)
   482â†’        menu.setStyleSheet("""
   483â†’            QMenu {
   484â†’                background-color: #2a2a2a;
   485â†’                color: white;
   486â†’                border: 1px solid #555;
   487â†’            }
   488â†’            QMenu::item {
   489â†’                padding: 6px 20px;
   490â†’            }
   491â†’            QMenu::item:selected {
   492â†’                background-color: #4CAF50;
   493â†’            }
   494â†’        """)
   495â†’        
   496â†’        add_ref_action = QAction("âž• æ·»åŠ åˆ°å‚è€ƒå›¾", self)
   497â†’        add_ref_action.triggered.connect(self._emit_add_to_ref)
   498â†’        menu.addAction(add_ref_action)
   499â†’        
   500â†’        menu.exec(self.mapToGlobal(pos))
   501â†’        
   502â†’    def _emit_add_to_ref(self):
   503â†’        path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')
   504â†’        if path and os.path.exists(path):
   505â†’            self.addToReferenceRequested.emit(str(path))
   506â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
