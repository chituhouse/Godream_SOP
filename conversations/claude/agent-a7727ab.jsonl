{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"831827d4-8f64-40eb-a2ca-946ae836d86c","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"a7727ab","slug":"smooth-dazzling-bear","type":"user","message":{"role":"user","content":"æ·±å…¥åˆ†æ `components/dialogs/image_detail_dialog.py` ä¸­å‚æ•°åŒºçš„åŠ¨æ€å¸ƒå±€ï¼š\n\n**é‡ç‚¹åˆ†æ**ï¼š\n1. å‚æ•°åŒºï¼ˆparams_layoutï¼‰çš„å®Œæ•´ç»“æ„\n2. å‚è€ƒå›¾å­˜åœ¨/ä¸å­˜åœ¨æ—¶çš„å¸ƒå±€å·®å¼‚\n3. `copy_prompt_btn`ã€`reference_export_btn`ã€`export_bundle_btn` çš„ä½ç½®å…³ç³»\n4. `setup_params_area()` æ–¹æ³•çš„å®Œæ•´é€»è¾‘\n5. å“ªäº›ç»„ä»¶æ˜¯å›ºå®šçš„ï¼Œå“ªäº›æ˜¯åŠ¨æ€åˆ›å»ºçš„\n6. å¸ƒå±€åœ¨ä¸åŒè®°å½•ç±»å‹ä¹‹é—´çš„å˜åŒ–\n\n**éœ€è¦æ‰¾å‡º**ï¼š\n- ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é‡å»ºå‚æ•°åŒº\n- æœ‰å‚è€ƒå›¾ vs æ— å‚è€ƒå›¾æ—¶çš„ UI å·®å¼‚\n- æ˜¯å¦å¯ä»¥å°†æŸäº›ç»„ä»¶å›ºå®šåŒ–ï¼ŒåªåŠ¨æ€æ›´æ–°å†…å®¹\n\nè¯·ç”»å‡ºå¸ƒå±€ç»“æ„å›¾ï¼Œè¯¦ç»†è¯´æ˜å„ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚"},"uuid":"9d3c8d0a-42e0-449d-bb5e-8c640b0dc158","timestamp":"2025-12-22T04:36:51.456Z"}
{"parentUuid":"9d3c8d0a-42e0-449d-bb5e-8c640b0dc158","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"831827d4-8f64-40eb-a2ca-946ae836d86c","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"a7727ab","slug":"smooth-dazzling-bear","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01DitXFYqQpYdMqWddTzNXaM","type":"message","role":"assistant","content":[{"type":"text","text":"æˆ‘æ¥æ·±å…¥åˆ†æ `image_detail_dialog.py` ä¸­å‚æ•°åŒºçš„åŠ¨æ€å¸ƒå±€ã€‚è®©æˆ‘å…ˆè¯»å–è¿™ä¸ªæ–‡ä»¶ã€‚"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":3311,"cache_read_input_tokens":17546,"cache_creation":{"ephemeral_5m_input_tokens":3311,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"type":"assistant","uuid":"c24a5e53-07a0-4535-b706-1e2ec6b96ad6","timestamp":"2025-12-22T04:36:56.848Z"}
{"parentUuid":"c24a5e53-07a0-4535-b706-1e2ec6b96ad6","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"831827d4-8f64-40eb-a2ca-946ae836d86c","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"a7727ab","slug":"smooth-dazzling-bear","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01DitXFYqQpYdMqWddTzNXaM","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BPgKF3vdYGiHtW3iL2dfYc","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/components/dialogs/image_detail_dialog.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":3311,"cache_read_input_tokens":17546,"cache_creation":{"ephemeral_5m_input_tokens":3311,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"type":"assistant","uuid":"bb307912-2d54-4d0c-9213-ed9e8d8726e1","timestamp":"2025-12-22T04:36:57.277Z"}
{"parentUuid":"bb307912-2d54-4d0c-9213-ed9e8d8726e1","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"831827d4-8f64-40eb-a2ca-946ae836d86c","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"a7727ab","slug":"smooth-dazzling-bear","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01DitXFYqQpYdMqWddTzNXaM","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BNh1zHiiUh4qGHJaDYrhdV","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/components/dialogs/video_detail_dialog.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":3311,"cache_read_input_tokens":17546,"cache_creation":{"ephemeral_5m_input_tokens":3311,"ephemeral_1h_input_tokens":0},"output_tokens":180,"service_tier":"standard"}},"type":"assistant","uuid":"031abd11-abca-439c-825b-710981b6faf3","timestamp":"2025-12-22T04:36:57.508Z"}
{"parentUuid":"031abd11-abca-439c-825b-710981b6faf3","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"831827d4-8f64-40eb-a2ca-946ae836d86c","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"a7727ab","slug":"smooth-dazzling-bear","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BNh1zHiiUh4qGHJaDYrhdV","type":"tool_result","content":"     1â†’import os\n     2â†’import json\n     3â†’from pathlib import Path\n     4â†’from datetime import datetime\n     5â†’from typing import Dict, Any, List, Optional\n     6â†’\n     7â†’from PySide6.QtWidgets import (\n     8â†’    QDialog, QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton,\n     9â†’    QTextEdit, QFileDialog, QMessageBox, QStackedWidget, QSplitter,\n    10â†’    QApplication\n    11â†’)\n    12â†’from PySide6.QtGui import QShortcut\n    13â†’from PySide6.QtCore import Qt, QTimer, QUrl, QSize, QEvent\n    14â†’from PySide6.QtGui import QPixmap, QFont, QKeySequence, QPainter, QImage\n    15â†’from PySide6.QtMultimedia import QMediaPlayer\n    16â†’from PySide6.QtMultimediaWidgets import QVideoWidget\n    17â†’\n    18â†’# ä½¿ç”¨å…¨å±€è§†é¢‘ç®¡ç†å™¨å•ä¾‹\n    19â†’from services.global_video_manager import get_global_video_manager\n    20â†’\n    21â†’from utils.logger import logger\n    22â†’from components.reference_assets import (\n    23â†’    ReferenceGalleryWidget,\n    24â†’    export_reference_asset,\n    25â†’    open_reference_preview,\n    26â†’    _find_reference_asset_index,\n    27â†’)\n    28â†’from utils.style_system import unified_style_system\n    29â†’from components.controllers import ExportBundleController\n    30â†’from utils.reference_display import (\n    31â†’    build_resolution_text,\n    32â†’    ensure_reference_info,\n    33â†’    get_model_display_name,\n    34â†’    pick_model_code,\n    35â†’    resolve_reference_assets,\n    36â†’)\n    37â†’from PySide6.QtCore import Signal\n    38â†’\n    39â†’class VideoDetailDialog(QDialog):\n    40â†’    \"\"\"è§†é¢‘è¯¦ç»†ä¿¡æ¯å¯¹è¯æ¡†\"\"\"\n    41â†’    \n    42â†’    # åˆ é™¤è®°å½•åå‘å‡ºä¿¡å·ï¼Œé€šçŸ¥çˆ¶è§†å›¾åˆ·æ–°\n    43â†’    recordDeleted = Signal(str)  # å‚æ•°ä¸ºè¢«åˆ é™¤çš„è®°å½•ID\n    44â†’    \n    45â†’    def __init__(self, video_data: Dict[str, Any], video_list: List[Dict[str, Any]] = None, current_index: int = 0, parent=None):\n    46â†’        super().__init__(parent)\n    47â†’        self.video_data = video_data\n    48â†’        self.video_list = video_list or [video_data]  # è§†é¢‘åˆ—è¡¨\n    49â†’        self.current_index = current_index  # å½“å‰è§†é¢‘ç´¢å¼•\n    50â†’        self.is_fullscreen = False  # å…¨å±çŠ¶æ€\n    51â†’        self.original_geometry = None  # åŸå§‹çª—å£å‡ ä½•\n    52â†’        self.param_value_labels = {}  # å­˜å‚¨å‚æ•°å€¼æ ‡ç­¾çš„å¼•ç”¨\n    53â†’        self._reference_summary = ensure_reference_info(self.video_data)\n    54â†’        self._reference_assets: List[Dict[str, Any]] = []\n    55â†’        self._export_controller = ExportBundleController(self, \"video\")\n    56â†’        \n    57â†’        # Subscribe to theme changes\n    58â†’        unified_style_system.styleChanged.connect(self._update_theme)\n    59â†’        \n    60â†’        self.setup_ui()\n    61â†’    \n    62â†’    def set_video_data(self, video_data: Dict[str, Any], video_list: List[Dict[str, Any]] = None, current_index: int = 0):\n    63â†’        \"\"\"æ›´æ–°è§†é¢‘æ•°æ®ï¼ˆå¤ç”¨å¯¹è¯æ¡†æ—¶è°ƒç”¨ï¼Œé¿å…é‡å»º QVideoWidgetï¼‰\"\"\"\n    64â†’        logger.debug(f\"[REUSE] å¤ç”¨å¯¹è¯æ¡†ï¼Œæ›´æ–°è§†é¢‘æ•°æ®: index={current_index}\")\n    65â†’        \n    66â†’        # 1. å…ˆåœæ­¢å½“å‰æ’­æ”¾\n    67â†’        if hasattr(self, '_video_manager') and self._video_manager is not None:\n    68â†’            self._video_manager.stop()\n    69â†’        \n    70â†’        # 2. é‡ç½®åˆ°ç¼©ç•¥å›¾æ¨¡å¼\n    71â†’        if hasattr(self, 'video_stack'):\n    72â†’            self.video_stack.setCurrentIndex(0)\n    73â†’        self.is_playing = False\n    74â†’        \n    75â†’        # 3. æ›´æ–°æ•°æ®\n    76â†’        self.video_data = video_data\n    77â†’        self.video_list = video_list or [video_data]\n    78â†’        self.current_index = current_index\n    79â†’        self._reference_summary = ensure_reference_info(self.video_data)\n    80â†’        \n    81â†’        # 4. åˆ·æ–°UI\n    82â†’        self.load_thumbnail()\n    83â†’        \n    84â†’        # 5. æ›´æ–°å³ä¾§ä¿¡æ¯\n    85â†’        if hasattr(self, 'prompt_text_edit'):\n    86â†’            prompt_content = self.video_data.get('prompt', 'æ— æç¤ºè¯')\n    87â†’            self.prompt_text_edit.setPlainText(prompt_content)\n    88â†’        \n    89â†’        # 6. æ›´æ–°å‚æ•°ä¿¡æ¯\n    90â†’        if hasattr(self, 'update_video_params'):\n    91â†’            self.update_video_params()\n    92â†’        \n    93â†’        # 7. æ›´æ–°å¯¼èˆªæŒ‰é’®\n    94â†’        if hasattr(self, 'update_navigation_buttons'):\n    95â†’            self.update_navigation_buttons()\n    96â†’        \n    97â†’        # 8. åˆ·æ–°å‚è€ƒå›¾ç”»å»Š\n    98â†’        if hasattr(self, '_refresh_reference_gallery'):\n    99â†’            self._refresh_reference_gallery()\n   100â†’        \n   101â†’        # 9. é‡æ–°æ¿€æ´»çª—å£\n   102â†’        self.setEnabled(True)\n   103â†’        self.activateWindow()\n   104â†’        self.raise_()\n   105â†’        self.setFocus()\n   106â†’        \n   107â†’        logger.debug(\"[REUSE] è§†é¢‘æ•°æ®æ›´æ–°å®Œæˆ\")\n   108â†’        \n   109â†’    def setup_ui(self):\n   110â†’        \"\"\"è®¾ç½®UI\"\"\"\n   111â†’        self.setWindowTitle(\"è§†é¢‘è¯¦ç»†ä¿¡æ¯\")\n   112â†’        self.resize(1100, 800)  # æ”¹ä¸ºå¯è°ƒæ•´å¤§å°\n   113â†’        self.setMinimumSize(800, 600)  # è®¾ç½®æœ€å°å°ºå¯¸\n   114â†’        \n   115â†’        # è®¾ç½®ç„¦ç‚¹ç­–ç•¥ï¼Œç¡®ä¿èƒ½æ¥æ”¶é”®ç›˜äº‹ä»¶\n   116â†’        self.setFocusPolicy(Qt.StrongFocus)\n   117â†’        self.setAttribute(Qt.WA_KeyCompression, False)  # ç¦ç”¨é”®ç›˜äº‹ä»¶å‹ç¼©\n   118â†’        self.setFocus()\n   119â†’\n   120â†’        # ç¡®ä¿çª—å£æ¿€æ´»æ—¶è·å¾—ç„¦ç‚¹\n   121â†’        self.activateWindow()\n   122â†’        self.raise_()\n   123â†’\n   124â†’        try:\n   125â†’            self.setObjectName(\"DetailDialog\")\n   126â†’        except Exception:\n   127â†’            pass\n   128â†’\n   129â†’        self._focus_timer = QTimer(self)\n   130â†’        self._focus_timer.setSingleShot(True)\n   131â†’        self._focus_timer.timeout.connect(self._ensure_focus)\n   132â†’\n   133â†’        layout = QHBoxLayout(self)\n   134â†’        \n   135â†’        # å·¦ä¾§ï¼šè§†é¢‘æ’­æ”¾å™¨ï¼ˆå 70%å®½åº¦ï¼‰\n   136â†’        left_widget = QWidget()\n   137â†’        left_layout = QVBoxLayout(left_widget)\n   138â†’        left_layout.setContentsMargins(0, 0, 0, 0)\n   139â†’        \n   140â†’        # è§†é¢‘æ’­æ”¾åŒºåŸŸ\n   141â†’        video_container = QWidget()\n   142â†’        video_container.setObjectName(\"VideoContainer\")\n   143â†’        \n   144â†’        container_layout = QVBoxLayout(video_container)\n   145â†’        container_layout.setContentsMargins(0, 0, 0, 0)\n   146â†’        \n   147â†’        # åˆ›å»ºå †å å¸ƒå±€ï¼Œç”¨äºç¼©ç•¥å›¾å’Œè§†é¢‘æ’­æ”¾å™¨çš„åˆ‡æ¢\n   148â†’        from PySide6.QtWidgets import QStackedWidget\n   149â†’        self.video_stack = QStackedWidget()\n   150â†’        \n   151â†’        # ç¼©ç•¥å›¾é¡µé¢\n   152â†’        self.thumbnail_widget = QWidget()\n   153â†’        self.thumbnail_widget.setObjectName(\"ThumbnailWidget\")\n   154â†’        thumbnail_layout = QVBoxLayout(self.thumbnail_widget)\n   155â†’        thumbnail_layout.setContentsMargins(0, 0, 0, 0)\n   156â†’        thumbnail_layout.setAlignment(Qt.AlignCenter)\n   157â†’        \n   158â†’        # ç¼©ç•¥å›¾æ ‡ç­¾\n   159â†’        self.thumbnail_label = QLabel()\n   160â†’        self.thumbnail_label.setAlignment(Qt.AlignCenter)\n   161â†’        colors = unified_style_system.get_colors()\n   162â†’        player_bg = colors.get('palette.component.player_bg')\n   163â†’        text_on_brand = (\n   164â†’            colors.get('palette.text.on_brand')\n   165â†’            or colors.get('palette.text.primary')\n   166â†’            or colors.get('text')\n   167â†’        )\n   168â†’        self.thumbnail_label.setStyleSheet(f\"\"\"\n   169â†’            QLabel {{\n   170â†’                border: none;\n   171â†’                background-color: {player_bg};\n   172â†’                color: {text_on_brand};\n   173â†’            }}\n   174â†’        \"\"\")\n   175â†’        self.thumbnail_label.setMinimumSize(400, 300)\n   176â†’        # ä¸ä½¿ç”¨setScaledContentsï¼Œæ”¹ä¸ºæ‰‹åŠ¨ç¼©æ”¾\n   177â†’        # self.thumbnail_label.setScaledContents(True)\n   178â†’        \n   179â†’        # æ’­æ”¾æŒ‰é’®è¦†ç›–å±‚\n   180â†’        self.play_overlay = QLabel(\"â–¶\")\n   181â†’        self.play_overlay.setAlignment(Qt.AlignCenter)\n   182â†’        self.play_overlay.setObjectName(\"PlayOverlay\")\n   183â†’        \n   184â†’        # åˆ›å»ºç¼©ç•¥å›¾å®¹å™¨ï¼Œä½¿ç”¨ç›¸å¯¹å®šä½\n   185â†’        thumbnail_container = QWidget()\n   186â†’        thumbnail_container.setStyleSheet(f\"border: none; background-color: {player_bg};\")\n   187â†’        # è®¾ç½®å›ºå®šå°ºå¯¸ç¡®ä¿å®¹å™¨æœ‰æ­£ç¡®çš„å¤§å°\n   188â†’        thumbnail_container.setFixedSize(640, 480)\n   189â†’        \n   190â†’        # ä½¿ç”¨ç»å¯¹å®šä½æ”¾ç½®æ’­æ”¾æŒ‰é’®\n   191â†’        def setup_thumbnail_layout():\n   192â†’            self.thumbnail_label.setParent(thumbnail_container)\n   193â†’            self.play_overlay.setParent(thumbnail_container)\n   194â†’            \n   195â†’            # ç¡®ä¿æ ‡ç­¾å¯è§\n   196â†’            self.thumbnail_label.show()\n   197â†’            self.play_overlay.show()\n   198â†’            \n   199â†’            def resize_thumbnail_container():\n   200â†’                if hasattr(self, 'thumbnail_label') and hasattr(self, 'play_overlay'):\n   201â†’                    container_size = thumbnail_container.size()\n   202â†’                    logger.debug(f\"[UI] è¯¦æƒ…ç¼©ç•¥å›¾å®¹å™¨å°ºå¯¸: {container_size}\")\n   203â†’                    \n   204â†’                    # è®¾ç½®ç¼©ç•¥å›¾æ ‡ç­¾å°ºå¯¸å’Œä½ç½®\n   205â†’                    self.thumbnail_label.setGeometry(0, 0, container_size.width(), container_size.height())\n   206â†’                    \n   207â†’                    # æ’­æ”¾æŒ‰é’®å±…ä¸­\n   208â†’                    overlay_x = max(0, (container_size.width() - 70) // 2)\n   209â†’                    overlay_y = max(0, (container_size.height() - 70) // 2)\n   210â†’                    self.play_overlay.setGeometry(overlay_x, overlay_y, 70, 70)\n   211â†’                    \n   212â†’                    logger.debug(f\"[UI] ç¼©ç•¥å›¾æ ‡ç­¾ä½ç½®: {self.thumbnail_label.geometry()}\")\n   213â†’                    logger.debug(f\"[UI] æ’­æ”¾æŒ‰é’®ä½ç½®: {self.play_overlay.geometry()}\")\n   214â†’            \n   215â†’            def handle_resize_event(event):\n   216â†’                resize_thumbnail_container()\n   217â†’                QWidget.resizeEvent(thumbnail_container, event)\n   218â†’            \n   219â†’            thumbnail_container.resizeEvent = handle_resize_event\n   220â†’            \n   221â†’            # ç«‹å³è°ƒç”¨å¸ƒå±€å‡½æ•°\n   222â†’            resize_thumbnail_container()\n   223â†’        \n   224â†’        setup_thumbnail_layout()\n   225â†’        \n   226â†’        # ç‚¹å‡»äº‹ä»¶\n   227â†’        self.thumbnail_label.mousePressEvent = self.on_thumbnail_click\n   228â†’        self.play_overlay.mousePressEvent = self.on_thumbnail_click\n   229â†’        \n   230â†’        thumbnail_layout.addWidget(thumbnail_container)\n   231â†’        \n   232â†’        # è§†é¢‘æ’­æ”¾å™¨é¡µé¢\n   233â†’        self.video_widget = QVideoWidget()\n   234â†’        self.video_widget.setObjectName(\"VideoWidget\")\n   235â†’        \n   236â†’        # ä½¿ç”¨å…¨å±€è§†é¢‘ç®¡ç†å™¨ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰\n   237â†’        logger.debug(\"[UI] è¿æ¥å…¨å±€è§†é¢‘ç®¡ç†å™¨...\")\n   238â†’        self._video_manager = get_global_video_manager()\n   239â†’        \n   240â†’        # ç»‘å®šå½“å‰å¯¹è¯æ¡†ï¼ˆç‹¬å ç»‘å®šï¼Œåªæœ‰å½“å‰å¯¹è¯æ¡†æ¥æ”¶ä¿¡å·ï¼‰\n   241â†’        self._video_manager.bind_dialog(self)\n   242â†’        logger.debug(\"[UI] å…¨å±€è§†é¢‘ç®¡ç†å™¨ç»‘å®šå®Œæˆ\")\n   243â†’        \n   244â†’        # æ’­æ”¾çŠ¶æ€æ ‡å¿—\n   245â†’        self.is_playing = False\n   246â†’        \n   247â†’        # æ·»åŠ åˆ°å †å å¸ƒå±€\n   248â†’        self.video_stack.addWidget(self.thumbnail_widget)  # ç´¢å¼•0ï¼šç¼©ç•¥å›¾\n   249â†’        self.video_stack.addWidget(self.video_widget)      # ç´¢å¼•1ï¼šQtè§†é¢‘æ’­æ”¾å™¨\n   250â†’        \n   251â†’        # åŠ è½½è§†é¢‘å’Œç¼©ç•¥å›¾\n   252â†’        video_path = self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')\n   253â†’        if video_path and os.path.exists(video_path):\n   254â†’            # ä¸åœ¨åˆå§‹åŒ–æ—¶åŠ è½½åª’ä½“ï¼Œå»¶è¿Ÿåˆ°ç”¨æˆ·ç‚¹å‡»æ’­æ”¾æ—¶\n   255â†’            self.load_thumbnail()\n   256â†’        \n   257â†’        container_layout.addWidget(self.video_stack)\n   258â†’        \n   259â†’        # è§†é¢‘åŒºåŸŸå æ®æ‰€æœ‰å¯ç”¨ç©ºé—´\n   260â†’        left_splitter = QSplitter(Qt.Vertical)\n   261â†’        left_splitter.addWidget(video_container)\n   262â†’\n   263â†’        self.reference_gallery = ReferenceGalleryWidget()\n   264â†’        try:\n   265â†’            self.reference_gallery.referenceClicked.connect(self._on_reference_clicked)\n   266â†’            self.reference_gallery.exportRequested.connect(self._on_reference_export)\n   267â†’            self.reference_gallery.selectionChanged.connect(self._on_reference_selection_changed)\n   268â†’        except Exception:\n   269â†’            pass\n   270â†’        # å‚è€ƒå›¾åŒºåŸŸå®¹å™¨ï¼ŒåŒ…å«ç”»å»Šä¸æ“ä½œæŒ‰é’®\n   271â†’        reference_section = QWidget()\n   272â†’        reference_section_layout = QVBoxLayout(reference_section)\n   273â†’        reference_section_layout.setContentsMargins(0, 0, 0, 0)\n   274â†’        reference_section_layout.setSpacing(6)\n   275â†’        reference_section_layout.addWidget(self.reference_gallery)\n   276â†’        # å°†å·¦ä¾§åˆ†å‰²å™¨å…ˆåŠ å…¥ä¸»å¸ƒå±€ï¼ˆç¬¬äºŒå—ç¨åè¡¥å……æŒ‰é’®åŒºåå†æ·»åŠ ï¼‰\n   277â†’        # æ³¨æ„ï¼šæœ€ç»ˆä¼šæŠŠ reference_section æ”¾å…¥åˆ†å‰²å™¨\n   278â†’\n   279â†’        reference_button_layout = QHBoxLayout()\n   280â†’        reference_button_layout.setContentsMargins(0, 0, 0, 0)\n   281â†’        reference_button_layout.setSpacing(6)\n   282â†’        self.export_status_label = QLabel(\"\")\n   283â†’        self.export_status_label.setObjectName(\"infoLabel\")\n   284â†’        unified_style_system.apply_to_widget(self.export_status_label)\n   285â†’        reference_button_layout.addWidget(self.export_status_label)\n   286â†’        reference_button_layout.addStretch(1)\n   287â†’        self.reference_export_btn = QPushButton(\"å¯¼å‡ºé€‰ä¸­å‚è€ƒå›¾\")\n   288â†’        self.reference_export_btn.setObjectName(\"SecondaryButton\")\n   289â†’        self.reference_export_btn.setEnabled(False)\n   290â†’        unified_style_system.apply_to_widget(self.reference_export_btn)\n   291â†’        self.reference_export_btn.clicked.connect(self._export_selected_reference)\n   292â†’        reference_button_layout.addWidget(self.reference_export_btn)\n   293â†’        self.export_bundle_btn = QPushButton(\"å¯¼å‡ºè®°å½•\")\n   294â†’        self.export_bundle_btn.setObjectName(\"SecondaryButton\")\n   295â†’        self.export_bundle_btn.setEnabled(False)\n   296â†’        unified_style_system.apply_to_widget(self.export_bundle_btn)\n   297â†’        self._export_controller.configure(\n   298â†’            self.export_bundle_btn,\n   299â†’            self.export_status_label,\n   300â†’            self._resolve_video_record_id,\n   301â†’            context_widget=self,\n   302â†’        )\n   303â†’        reference_button_layout.addWidget(self.export_bundle_btn)\n   304â†’        reference_section_layout.addLayout(reference_button_layout)\n   305â†’        # å°†å‚è€ƒå›¾åŒºåŸŸåŠ å…¥åˆ†å‰²å™¨ï¼Œå¹¶æŠŠåˆ†å‰²å™¨åŠ å…¥å·¦ä¾§å¸ƒå±€\n   306â†’        left_splitter.addWidget(reference_section)\n   307â†’        try:\n   308â†’            left_splitter.setStretchFactor(0, 3)\n   309â†’            left_splitter.setStretchFactor(1, 2)\n   310â†’            left_splitter.setSizes([520, 280])\n   311â†’        except Exception:\n   312â†’            pass\n   313â†’        left_layout.addWidget(left_splitter, 1)\n   314â†’\n   315â†’        # åº•éƒ¨æ§åˆ¶åŒºåŸŸ\n   316â†’        controls_layout = QHBoxLayout()\n   317â†’        controls_layout.setContentsMargins(0, 5, 0, 5)\n   318â†’        controls_layout.setSpacing(10)\n   319â†’        \n   320â†’        # æ’­æ”¾/æš‚åœæŒ‰é’®\n   321â†’        self.play_button = QPushButton(\"â–¶\")\n   322â†’        self.play_button.setFixedSize(40, 30)\n   323â†’        self.play_button.setObjectName(\"PlayButton\")\n   324â†’        unified_style_system.apply_to_widget(self.play_button)\n   325â†’        self.play_button.clicked.connect(self.toggle_play_pause)\n   326â†’        controls_layout.addWidget(self.play_button)\n   327â†’        \n   328â†’        # è¿›åº¦æ¡ï¼ˆç®€å•çš„æ ‡ç­¾æ˜¾ç¤ºï¼‰\n   329â†’        self.progress_label = QLabel(\"00:00 / 00:00\")\n   330â†’        self.progress_label.setObjectName(\"ProgressLabel\")\n   331â†’        controls_layout.addWidget(self.progress_label, 1)\n   332â†’        \n   333â†’        # éŸ³é‡æ§åˆ¶\n   334â†’        volume_label = QLabel(\"ğŸ”Š\")\n   335â†’        volume_label.setObjectName(\"infoLabel\")\n   336â†’        unified_style_system.apply_to_widget(volume_label)\n   337â†’        controls_layout.addWidget(volume_label)\n   338â†’        \n   339â†’        # å¯¼èˆªæŒ‰é’®\n   340â†’        self.prev_btn = QPushButton(\"â—€\")\n   341â†’        self.prev_btn.setFixedSize(30, 30)\n   342â†’        self.prev_btn.setObjectName(\"NavButton\")\n   343â†’        unified_style_system.apply_to_widget(self.prev_btn)\n   344â†’        self.prev_btn.clicked.connect(self.show_previous_video)\n   345â†’        controls_layout.addWidget(self.prev_btn)\n   346â†’\n   347â†’        self.next_btn = QPushButton(\"â–¶\")\n   348â†’        self.next_btn.setFixedSize(30, 30)\n   349â†’        self.next_btn.setObjectName(\"NavButton\")\n   350â†’        unified_style_system.apply_to_widget(self.next_btn)\n   351â†’        self.next_btn.clicked.connect(self.show_next_video)\n   352â†’        controls_layout.addWidget(self.next_btn)\n   353â†’        \n   354â†’        left_layout.addLayout(controls_layout)\n   355â†’\n   356â†’        # æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€\n   357â†’        self.update_navigation_buttons()\n   358â†’        self._refresh_reference_gallery()\n   359â†’        self._export_controller.refresh()\n   360â†’\n   361â†’        # å³ä¾§ï¼šè¯¦ç»†ä¿¡æ¯ï¼ˆå›ºå®š30%å®½åº¦ï¼‰\n   362â†’        right_layout = QVBoxLayout()\n   363â†’        \n   364â†’        # åˆ›å»ºå‚æ•°æ˜¾ç¤ºåŒºåŸŸ\n   365â†’        params_widget = QWidget()\n   366â†’        params_widget.setFixedWidth(int(self.width() * 0.3))\n   367â†’        params_widget.setObjectName(\"ParamsWidget\")\n   368â†’        params_layout = QVBoxLayout(params_widget)\n   369â†’        params_layout.setSpacing(0)\n   370â†’        params_layout.setContentsMargins(5, 5, 5, 5)\n   371â†’        \n   372â†’        # è§£æç”Ÿæˆå‚æ•°\n   373â†’        params = self.video_data.get('parameters', '{}')\n   374â†’        if isinstance(params, str):\n   375â†’            try:\n   376â†’                params = json.loads(params)\n   377â†’            except:\n   378â†’                params = {}\n   379â†’        \n   380â†’        # æç¤ºè¯åŒºåŸŸ\n   381â†’        prompt_label = QLabel(\"<b>æç¤ºè¯:</b>\")\n   382â†’        prompt_label.setStyleSheet(\"margin: 0px; padding: 2px 0px;\")\n   383â†’        unified_style_system.apply_to_widget(prompt_label)\n   384â†’        params_layout.addWidget(prompt_label)\n   385â†’        \n   386â†’        # æç¤ºè¯æ–‡æœ¬æ¡†\n   387â†’        prompt_content = self.video_data.get('prompt', 'æ— æç¤ºè¯')\n   388â†’        self.prompt_text_edit = QTextEdit()\n   389â†’        self.prompt_text_edit.setPlainText(prompt_content)\n   390â†’        self.prompt_text_edit.setReadOnly(True)\n   391â†’        # çº¦ 4 è¡Œé«˜åº¦ï¼ˆæŒ‰å½“å‰å­—ä½“åŠ¨æ€è®¡ç®—ï¼‰ï¼Œé¿å…æç¤ºè¯åŒºåŸŸè¿‡é«˜æŒ¤å‹å…¶å®ƒä¿¡æ¯\n   392â†’        try:\n   393â†’            line_height = self.prompt_text_edit.fontMetrics().lineSpacing()\n   394â†’            target_lines = 4\n   395â†’            vertical_padding = 16  # ä¸å…¨å±€ QTextEdit padding (8*2) å¯¹é½\n   396â†’            border = 2  # 1px*2\n   397â†’            height = line_height * target_lines + vertical_padding + border\n   398â†’            self.prompt_text_edit.setFixedHeight(max(72, int(height)))\n   399â†’        except Exception:\n   400â†’            self.prompt_text_edit.setMaximumHeight(96)\n   401â†’            self.prompt_text_edit.setMinimumHeight(96)\n   402â†’        unified_style_system.apply_to_widget(self.prompt_text_edit)\n   403â†’        # åº”ç”¨ä¸ _update_theme ä¸€è‡´çš„é¢å¤–æ ·å¼\n   404â†’        colors = unified_style_system.get_colors()\n   405â†’        bg_input = colors.get('palette.neutral.bg_input') or colors.get('palette.neutral.bg_card')\n   406â†’        text_color = colors.get('text') or colors.get('palette.text.primary')\n   407â†’        border_subtle = colors.get('palette.neutral.border_subtle') or colors.get('border')\n   408â†’        brand = colors.get('palette.brand.main') or colors.get('primary')\n   409â†’        self.prompt_text_edit.setStyleSheet(f\"\"\"\n   410â†’            QTextEdit {{\n   411â†’                background-color: {bg_input};\n   412â†’                color: {text_color};\n   413â†’                border: 1px solid {border_subtle};\n   414â†’                border-radius: 8px;\n   415â†’                padding: 8px;\n   416â†’            }}\n   417â†’            QTextEdit:focus {{\n   418â†’                border-color: {brand};\n   419â†’            }}\n   420â†’        \"\"\")\n   421â†’        params_layout.addWidget(self.prompt_text_edit)\n   422â†’        \n   423â†’        # å¤åˆ¶æç¤ºè¯æŒ‰é’®ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„ SecondaryButton æ ·å¼ï¼‰\n   424â†’        self.copy_prompt_btn = QPushButton(\"å¤åˆ¶æç¤ºè¯\")\n   425â†’        self.copy_prompt_btn.setObjectName(\"SecondaryButton\")\n   426â†’        self.copy_prompt_btn.setMaximumHeight(30)\n   427â†’        unified_style_system.apply_to_widget(self.copy_prompt_btn)\n   428â†’        self.copy_prompt_btn.clicked.connect(self.copy_prompt)\n   429â†’        params_layout.addWidget(self.copy_prompt_btn)\n   430â†’        \n   431â†’        # è¯¦ç»†ä¿¡æ¯ - ä¿å­˜æ ‡ç­¾å¼•ç”¨ä»¥ä¾¿åç»­æ›´æ–°\n   432â†’        self.param_labels = {}  # å­˜å‚¨å‚æ•°å€¼æ ‡ç­¾çš„å¼•ç”¨\n   433â†’\n   434â†’        # ä» parameters ä¸­è·å–å‚æ•°ï¼ˆå…¼å®¹é¡¶çº§å­—æ®µï¼‰\n   435â†’        params = self.video_data.get('parameters', {}) or {}\n   436â†’        duration = params.get('duration') or self.video_data.get('duration', 'æœªçŸ¥')\n   437â†’        file_size = params.get('file_size') or self.video_data.get('file_size', 0)\n   438â†’\n   439â†’        info_items = [\n   440â†’            (\"åˆ†è¾¨ç‡\", build_resolution_text(self.video_data)),\n   441â†’            (\"æ—¶é•¿\", f\"{duration}ç§’\"),\n   442â†’            (\"æ¨¡å‹\", get_model_display_name(pick_model_code(self.video_data))),\n   443â†’            (\"ç”Ÿæˆæ—¶é—´\", self.format_time(self.video_data.get('created_at', ''))),\n   444â†’            (\"æ–‡ä»¶å¤§å°\", self.format_file_size(file_size)),\n   445â†’            (\"æ–‡ä»¶è·¯å¾„\", self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')),\n   446â†’        ]\n   447â†’        \n   448â†’        for label, value in info_items:\n   449â†’            label_widget = QLabel(f\"<b>{label}:</b>\")\n   450â†’            label_widget.setStyleSheet(\"margin: 0px; padding: 2px 0px;\")\n   451â†’            unified_style_system.apply_to_widget(label_widget)\n   452â†’            params_layout.addWidget(label_widget)\n   453â†’            \n   454â†’            # Use QLineEdit for better copy interaction\n   455â†’            from PySide6.QtWidgets import QLineEdit\n   456â†’            value_label = QLineEdit(str(value))\n   457â†’            value_label.setReadOnly(True)\n   458â†’            value_label.setCursorPosition(0)\n   459â†’            value_label.setCursorPosition(0)\n   460â†’            # Style is now handled in _update_theme\n   461â†’            unified_style_system.apply_to_widget(value_label)\n   462â†’            params_layout.addWidget(value_label)\n   463â†’            \n   464â†’            # ä¿å­˜å‚æ•°å€¼æ ‡ç­¾å¼•ç”¨ï¼Œç”¨äºåç»­æ›´æ–°\n   465â†’            self.param_value_labels[label] = value_label\n   466â†’        \n   467â†’        right_layout.addWidget(params_widget)\n   468â†’        \n   469â†’        # æ§åˆ¶æŒ‰é’®\n   470â†’        button_layout = QHBoxLayout()\n   471â†’\n   472â†’        self.fullscreen_btn = QPushButton(\"å…¨å± (F11)\")\n   473â†’        self.fullscreen_btn.setMaximumHeight(30)\n   474â†’        unified_style_system.apply_to_widget(self.fullscreen_btn)\n   475â†’        self.fullscreen_btn.clicked.connect(self.toggle_fullscreen)\n   476â†’        button_layout.addWidget(self.fullscreen_btn)\n   477â†’\n   478â†’        self.download_btn = QPushButton(\"ä¸‹è½½è§†é¢‘\")\n   479â†’        self.download_btn.setMaximumHeight(30)\n   480â†’        unified_style_system.apply_to_widget(self.download_btn)\n   481â†’        self.download_btn.clicked.connect(self.download_video)\n   482â†’        button_layout.addWidget(self.download_btn)\n   483â†’\n   484â†’        self.delete_btn = QPushButton(\"åˆ é™¤è®°å½•\")\n   485â†’        self.delete_btn.setMaximumHeight(30)\n   486â†’        unified_style_system.apply_to_widget(self.delete_btn, extra={'variant': 'danger'})\n   487â†’        self.delete_btn.clicked.connect(self._delete_current_record)\n   488â†’        button_layout.addWidget(self.delete_btn)\n   489â†’\n   490â†’        right_layout.addLayout(button_layout)\n   491â†’\n   492â†’        self.close_btn = QPushButton(\"å…³é—­ï¼ˆESCï¼‰\")\n   493â†’        unified_style_system.apply_to_widget(self.close_btn)\n   494â†’        self.close_btn.clicked.connect(self.accept)\n   495â†’        right_layout.addWidget(self.close_btn)\n   496â†’        \n   497â†’        # è®¾ç½®å¸ƒå±€æ¯”ä¾‹ï¼šå·¦ä¾§70%ï¼Œå³ä¾§30%\n   498â†’        layout.addWidget(left_widget, 7)\n   499â†’        layout.addLayout(right_layout, 3)\n   500â†’        \n   501â†’        # æ·»åŠ é”®ç›˜å¿«æ·é”®\n   502â†’        self.setup_shortcuts()\n   503â†’\n   504â†’        # å»¶è¿Ÿè®¾ç½®ç„¦ç‚¹ï¼Œç¡®ä¿çª—å£å®Œå…¨åˆå§‹åŒ–åè·å¾—ç„¦ç‚¹\n   505â†’        self._focus_timer.start(100)\n   506â†’        self._esc_shortcut = QShortcut(QKeySequence(Qt.Key_Escape), self)\n   507â†’        self._esc_shortcut.activated.connect(self.handle_escape_key)\n   508â†’        self._esc_shortcut.activated.connect(self.handle_escape_key)\n   509â†’        \n   510â†’        # Apply initial theme\n   511â†’        self._update_theme()\n   512â†’        \n   513â†’        # ä¿¡å·å·²åœ¨setup_uiå¼€å¤´è¿æ¥ï¼Œä¸é‡å¤è¿æ¥\n   514â†’    \n   515â†’    def closeEvent(self, event):\n   516â†’        \"\"\"çª—å£å…³é—­äº‹ä»¶ï¼Œç¡®ä¿åœæ­¢æ’­æ”¾å¹¶é‡Šæ”¾èµ„æº\"\"\"\n   517â†’        # 0. é˜»æ­¢å¯¹è¯æ¡†ç»§ç»­æ¥æ”¶äº‹ä»¶\n   518â†’        self.setEnabled(False)\n   519â†’        \n   520â†’        # 1. åœæ­¢ç„¦ç‚¹å®šæ—¶å™¨\n   521â†’        if hasattr(self, '_focus_timer') and self._focus_timer.isActive():\n   522â†’            self._focus_timer.stop()\n   523â†’        \n   524â†’        # 2. æ¸…ç†å‚è€ƒå›¾ç”»å»Š\n   525â†’        if hasattr(self, 'reference_gallery') and self.reference_gallery is not None:\n   526â†’            try:\n   527â†’                self.reference_gallery.clear()\n   528â†’            except Exception as e:\n   529â†’                logger.warning(f\"[CLEANUP] æ¸…ç†å‚è€ƒå›¾ç”»å»Šæ—¶å‡ºé”™: {e}\")\n   530â†’        \n   531â†’        # 3. è§£ç»‘å¹¶åœæ­¢å…¨å±€è§†é¢‘ç®¡ç†å™¨\n   532â†’        if hasattr(self, '_video_manager') and self._video_manager is not None:\n   533â†’            try:\n   534â†’                # è§£ç»‘å¯¹è¯æ¡†ï¼ˆå–æ¶ˆç‹¬å ç»‘å®šï¼‰\n   535â†’                self._video_manager.unbind_dialog(self)\n   536â†’                \n   537â†’                # åœæ­¢æ’­æ”¾å¹¶æ–­å¼€è§†é¢‘è¾“å‡º\n   538â†’                self._video_manager.stop()\n   539â†’                \n   540â†’            except Exception as e:\n   541â†’                logger.warning(f\"[CLEANUP] åœæ­¢å…¨å±€è§†é¢‘ç®¡ç†å™¨æ—¶å‡ºé”™: {e}\")\n   542â†’\n   543â†’        # 4. å…¼å®¹æ—§å­—æ®µï¼šè‹¥å­˜åœ¨æœ¬åœ° media_player ä¹Ÿåœæ­¢\n   544â†’        if hasattr(self, 'media_player') and self.media_player:\n   545â†’            try:\n   546â†’                self.media_player.stop()\n   547â†’            except Exception:\n   548â†’                pass\n   549â†’\n   550â†’        # 5. æ¸…ç†å¯¼å‡ºæ§åˆ¶å™¨\n   551â†’        try:\n   552â†’            self._export_controller.dispose()\n   553â†’        except Exception:\n   554â†’            pass\n   555â†’        \n   556â†’        self.is_playing = False\n   557â†’        super().closeEvent(event)\n   558â†’    \n   559â†’    def load_thumbnail(self):\n   560â†’        \"\"\"åŠ è½½è§†é¢‘ç¼©ç•¥å›¾\"\"\"\n   561â†’        import os  # å°†oså¯¼å…¥ç§»åˆ°å‡½æ•°å¼€å¤´\n   562â†’        try:\n   563â†’            logger.debug(\"å¼€å§‹åŠ è½½ç¼©ç•¥å›¾...\")\n   564â†’            logger.debug(f\"è§†é¢‘æ•°æ®: {self.video_data}\")\n   565â†’            \n   566â†’            # è·å–ç¼©ç•¥å›¾è·¯å¾„\n   567â†’            thumbnail_path = self.video_data.get('thumbnail_local_path', '')\n   568â†’            logger.debug(f\"ä»video_dataè·å–çš„thumbnail_local_path: {thumbnail_path}\")\n   569â†’            \n   570â†’            if thumbnail_path and os.path.exists(thumbnail_path):\n   571â†’                logger.debug(f\"æ‰¾åˆ°ç°æœ‰ç¼©ç•¥å›¾æ–‡ä»¶: {thumbnail_path}\")\n   572â†’                # ä½¿ç”¨ç°æœ‰ç¼©ç•¥å›¾\n   573â†’                pixmap = QPixmap(thumbnail_path)\n   574â†’                logger.debug(f\"QPixmapåŠ è½½ç»“æœ: isNull={pixmap.isNull()}, size={pixmap.size()}\")\n   575â†’            else:\n   576â†’                logger.debug(\"ç¼©ç•¥å›¾æ–‡ä»¶ä¸å­˜åœ¨æˆ–è·¯å¾„ä¸ºç©ºï¼Œå¼€å§‹ç”Ÿæˆç¼©ç•¥å›¾...\")\n   577â†’                # ç”Ÿæˆç¼©ç•¥å›¾\n   578â†’                video_path = self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')\n   579â†’                logger.debug(f\"è§†é¢‘æ–‡ä»¶è·¯å¾„: {video_path}\")\n   580â†’                \n   581â†’                if video_path and os.path.exists(video_path):\n   582â†’                    logger.debug(\"è§†é¢‘æ–‡ä»¶å­˜åœ¨ï¼Œå¼€å§‹ç”Ÿæˆç¼©ç•¥å›¾...\")\n   583â†’                    from utils.video_thumbnail_generator import VideoThumbnailGenerator\n   584â†’                    from config_api import get_storage_dir\n   585â†’                    storage_dir = get_storage_dir()\n   586â†’                    thumbnails_dir = os.path.join(storage_dir, 'thumbnails')\n   587â†’                    logger.debug(f\"ç¼©ç•¥å›¾ç›®å½•: {thumbnails_dir}\")\n   588â†’                    \n   589â†’                    generator = VideoThumbnailGenerator(thumbnails_dir)\n   590â†’                    video_id = self.video_data.get('id', os.path.basename(video_path).split('.')[0])\n   591â†’                    logger.debug(f\"è§†é¢‘ID: {video_id}\")\n   592â†’                    \n   593â†’                    thumbnail_path = generator.generate_thumbnail_for_video(video_path, video_id)\n   594â†’                    logger.debug(f\"ç”Ÿæˆçš„ç¼©ç•¥å›¾è·¯å¾„: {thumbnail_path}\")\n   595â†’                    \n   596â†’                    if thumbnail_path and os.path.exists(thumbnail_path):\n   597â†’                        logger.debug(\"ç¼©ç•¥å›¾ç”ŸæˆæˆåŠŸï¼ŒåŠ è½½åˆ°QPixmap...\")\n   598â†’                        pixmap = QPixmap(thumbnail_path)\n   599â†’                        logger.debug(f\"QPixmapåŠ è½½ç»“æœ: isNull={pixmap.isNull()}, size={pixmap.size()}\")\n   600â†’                    else:\n   601â†’                        logger.debug(\"ç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å›¾ç‰‡\")\n   602â†’                        # ä½¿ç”¨é»˜è®¤å›¾ç‰‡\n   603â†’                        pixmap = self.create_default_thumbnail()\n   604â†’                else:\n   605â†’                    logger.debug(\"è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å›¾ç‰‡\")\n   606â†’                    pixmap = self.create_default_thumbnail()\n   607â†’            \n   608â†’            if not pixmap.isNull():\n   609â†’                logger.debug(\"å¼€å§‹ç¼©æ”¾å›¾ç‰‡...\")\n   610â†’                # ç¼©æ”¾å›¾ç‰‡ä»¥é€‚åº”æ ‡ç­¾å¤§å°\n   611â†’                label_size = self.thumbnail_label.size()\n   612â†’                logger.debug(f\"æ ‡ç­¾å¤§å°: {label_size}\")\n   613â†’                \n   614â†’                scaled_pixmap = pixmap.scaled(\n   615â†’                    label_size,\n   616â†’                    Qt.KeepAspectRatio,\n   617â†’                    Qt.SmoothTransformation\n   618â†’                )\n   619â†’                logger.debug(f\"ç¼©æ”¾åå›¾ç‰‡å¤§å°: {scaled_pixmap.size()}\")\n   620â†’                \n   621â†’                self.thumbnail_label.setPixmap(scaled_pixmap)\n   622â†’                logger.debug(\"ç¼©ç•¥å›¾è®¾ç½®æˆåŠŸ\")\n   623â†’            else:\n   624â†’                logger.debug(\"QPixmapä¸ºç©ºï¼Œæ˜¾ç¤ºé”™è¯¯æ–‡æœ¬\")\n   625â†’                self.thumbnail_label.setText(\"æ— æ³•åŠ è½½ç¼©ç•¥å›¾\")\n   626â†’                \n   627â†’        except Exception as e:\n   628â†’            logger.debug(f\"åŠ è½½ç¼©ç•¥å›¾å¼‚å¸¸: {e}\")\n   629â†’            import traceback\n   630â†’            traceback.print_exc()\n   631â†’            self.thumbnail_label.setText(\"ç¼©ç•¥å›¾åŠ è½½å¤±è´¥\")\n   632â†’    \n   633â†’    def create_default_thumbnail(self):\n   634â†’        \"\"\"åˆ›å»ºé»˜è®¤ç¼©ç•¥å›¾\"\"\"\n   635â†’        pixmap = QPixmap(400, 300)\n   636â†’        pixmap.fill(Qt.black)\n   637â†’        \n   638â†’        from PySide6.QtGui import QPainter, QFont\n   639â†’        painter = QPainter(pixmap)\n   640â†’        painter.setPen(Qt.white)\n   641â†’        painter.setFont(QFont())  # Font configuration handled by unified style system\n   642â†’        painter.drawText(pixmap.rect(), Qt.AlignCenter, \"è§†é¢‘é¢„è§ˆ\")\n   643â†’        painter.end()\n   644â†’        \n   645â†’        return pixmap\n   646â†’    \n   647â†’    def on_thumbnail_click(self, event):\n   648â†’        \"\"\"ç¼©ç•¥å›¾ç‚¹å‡»äº‹ä»¶\"\"\"\n   649â†’        self.start_video_playback()\n   650â†’    \n   651â†’    def start_video_playback(self):\n   652â†’        \"\"\"å¼€å§‹è§†é¢‘æ’­æ”¾\"\"\"\n   653â†’        logger.debug(\"[UI] å¼€å§‹è§†é¢‘æ’­æ”¾â€¦\")\n   654â†’        \n   655â†’        # æ£€æŸ¥è§†é¢‘æ–‡ä»¶\n   656â†’        video_path = self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')\n   657â†’        \n   658â†’        if not video_path or not os.path.exists(video_path):\n   659â†’            logger.warning(f\"[UI] è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨: {video_path}\")\n   660â†’            from PySide6.QtWidgets import QMessageBox\n   661â†’            QMessageBox.critical(self, \"é”™è¯¯\", \"è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨\")\n   662â†’            return\n   663â†’        \n   664â†’        # åˆ‡æ¢åˆ°è§†é¢‘æ’­æ”¾å™¨\n   665â†’        self.video_stack.setCurrentIndex(1)\n   666â†’        self.is_playing = True\n   667â†’        \n   668â†’        # ä½¿ç”¨å…¨å±€è§†é¢‘ç®¡ç†å™¨æ’­æ”¾\n   669â†’        self._video_manager.play(video_path, self.video_widget)\n   670â†’        logger.debug(\"[UI] å¼€å§‹æ’­æ”¾è§†é¢‘\")\n   671â†’    \n   672â†’    def toggle_play_pause(self):\n   673â†’        \"\"\"åˆ‡æ¢æ’­æ”¾/æš‚åœ\"\"\"\n   674â†’        if not self.is_playing:\n   675â†’            self.start_video_playback()\n   676â†’        else:\n   677â†’            self._video_manager.toggle_play_pause()\n   678â†’    \n   679â†’    def on_state_changed(self, state):\n   680â†’        \"\"\"æ’­æ”¾çŠ¶æ€æ”¹å˜\"\"\"\n   681â†’        if state == QMediaPlayer.PlaybackState.PlayingState:\n   682â†’            self.play_button.setText(\"â¸\")\n   683â†’        else:\n   684â†’            self.play_button.setText(\"â–¶\")\n   685â†’    \n   686â†’    def on_position_changed(self, position):\n   687â†’        \"\"\"æ’­æ”¾ä½ç½®æ”¹å˜\"\"\"\n   688â†’        if hasattr(self, 'media_player'):\n   689â†’            duration = self.media_player.duration()\n   690â†’            if duration > 0:\n   691â†’                current_time = self.format_duration(position)\n   692â†’                total_time = self.format_duration(duration)\n   693â†’                self.progress_label.setText(f\"{current_time} / {total_time}\")\n   694â†’    \n   695â†’    def on_duration_changed(self, duration):\n   696â†’        \"\"\"è§†é¢‘æ—¶é•¿æ”¹å˜\"\"\"\n   697â†’        if duration > 0:\n   698â†’            total_time = self.format_duration(duration)\n   699â†’            self.progress_label.setText(f\"00:00 / {total_time}\")\n   700â†’    \n   701â†’    def on_media_error(self, error, error_string):\n   702â†’        \"\"\"åª’ä½“æ’­æ”¾é”™è¯¯å¤„ç†\"\"\"\n   703â†’        logger.error(f\"[MEDIA] æ’­æ”¾é”™è¯¯: {error}, ä¿¡æ¯: {error_string}\")\n   704â†’        \n   705â†’        from PySide6.QtWidgets import QMessageBox\n   706â†’        msg_box = QMessageBox(self)\n   707â†’        msg_box.setIcon(QMessageBox.Critical)\n   708â†’        msg_box.setText(\"è§†é¢‘æ’­æ”¾é”™è¯¯\")\n   709â†’        msg_box.setInformativeText(f\"æ— æ³•æ’­æ”¾è§†é¢‘: {error_string}\")\n   710â†’        msg_box.exec()\n   711â†’        \n   712â†’        # è¿”å›ç¼©ç•¥å›¾æ¨¡å¼\n   713â†’        self.video_stack.setCurrentIndex(0)\n   714â†’        self.is_playing = False\n   715â†’    \n   716â†’    def on_media_status_changed(self, status):\n   717â†’        \"\"\"åª’ä½“çŠ¶æ€æ”¹å˜\"\"\"\n   718â†’        from PySide6.QtMultimedia import QMediaPlayer\n   719â†’        \n   720â†’        logger.debug(f\"[MEDIA] çŠ¶æ€æ”¹å˜: {status}\")\n   721â†’        \n   722â†’        if status == QMediaPlayer.MediaStatus.EndOfMedia:\n   723â†’            # è§†é¢‘æ’­æ”¾ç»“æŸï¼Œè¿”å›ç¼©ç•¥å›¾æ¨¡å¼\n   724â†’            logger.debug(\"[MEDIA] æ’­æ”¾ç»“æŸï¼Œåˆ‡å›ç¼©ç•¥å›¾æ¨¡å¼\")\n   725â†’            self.video_stack.setCurrentIndex(0)\n   726â†’            self.is_playing = False\n   727â†’            if hasattr(self, 'media_player'):\n   728â†’                self.media_player.setPosition(0)  # é‡ç½®æ’­æ”¾ä½ç½®\n   729â†’            self.progress_label.setText(\"00:00 / 00:00\")\n   730â†’        elif status == QMediaPlayer.MediaStatus.InvalidMedia:\n   731â†’            logger.warning(\"[MEDIA] åª’ä½“æ–‡ä»¶æ— æ•ˆ\")\n   732â†’        elif status == QMediaPlayer.MediaStatus.BufferedMedia:\n   733â†’            logger.debug(\"[MEDIA] åª’ä½“ç¼“å†²å®Œæˆ\")\n   734â†’        elif status == QMediaPlayer.MediaStatus.LoadingMedia:\n   735â†’            logger.debug(\"[MEDIA] æ­£åœ¨åŠ è½½åª’ä½“\")\n   736â†’        elif status == QMediaPlayer.MediaStatus.StalledMedia:\n   737â†’            logger.debug(\"[MEDIA] æ’­æ”¾å¡é¡¿\")\n   738â†’    \n   739â†’    def format_duration(self, ms):\n   740â†’        \"\"\"æ ¼å¼åŒ–æ—¶é•¿æ˜¾ç¤º\"\"\"\n   741â†’        seconds = ms // 1000\n   742â†’        minutes = seconds // 60\n   743â†’        seconds = seconds % 60\n   744â†’        return f\"{minutes:02d}:{seconds:02d}\"\n   745â†’    \n   746â†’    # OpenCV playback methods removed - using QtMultimedia exclusively\n   747â†’\n   748â†’    \n   749â†’    def format_time(self, time_str: str) -> str:\n   750â†’        \"\"\"æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º\"\"\"\n   751â†’        if not time_str:\n   752â†’            return 'æœªçŸ¥æ—¶é—´'\n   753â†’        try:\n   754â†’            dt = datetime.fromisoformat(time_str.replace('Z', '+00:00'))\n   755â†’            return dt.strftime('%Y-%m-%d %H:%M:%S')\n   756â†’        except:\n   757â†’            return time_str[:19] if len(time_str) > 19 else time_str\n   758â†’    \n   759â†’    def format_file_size(self, size) -> str:\n   760â†’        \"\"\"æ ¼å¼åŒ–æ–‡ä»¶å¤§å°æ˜¾ç¤º\"\"\"\n   761â†’        try:\n   762â†’            size = float(size) if size else 0\n   763â†’        except (ValueError, TypeError):\n   764â†’            return 'æœªçŸ¥å¤§å°'\n   765â†’            \n   766â†’        if size == 0:\n   767â†’            return 'æœªçŸ¥å¤§å°'\n   768â†’        \n   769â†’        for unit in ['B', 'KB', 'MB', 'GB']:\n   770â†’            if size < 1024.0:\n   771â†’                return f\"{size:.1f} {unit}\"\n   772â†’            size /= 1024.0\n   773â†’        return f\"{size:.1f} TB\"\n   774â†’    \n   775â†’    def setup_shortcuts(self):\n   776â†’        \"\"\"è®¾ç½®é”®ç›˜å¿«æ·é”®\"\"\"\n   777â†’        # ç§»é™¤æ‰€æœ‰QShortcutï¼Œç»Ÿä¸€ä½¿ç”¨keyPressEventå¤„ç†\n   778â†’        # é¿å…å¿«æ·é”®å†²çªé—®é¢˜\n   779â†’        pass\n   780â†’    \n   781â†’    def _ensure_focus(self):\n   782â†’        \"\"\"ç¡®ä¿çª—å£è·å¾—ç„¦ç‚¹\"\"\"\n   783â†’        self.activateWindow()\n   784â†’        self.raise_()\n   785â†’        self.setFocus()\n   786â†’        logger.debug(f\"[FOCUS] VideoDialogçª—å£ç„¦ç‚¹è®¾ç½®å®Œæˆï¼ŒhasFocus: {self.hasFocus()}\")\n   787â†’    \n   788â†’    def keyPressEvent(self, event):\n   789â†’        \"\"\"é”®ç›˜äº‹ä»¶å¤„ç†\"\"\"\n   790â†’        from PySide6.QtCore import Qt\n   791â†’        \n   792â†’        logger.debug(f\"[KEYBOARD] VideoDetailDialogé”®ç›˜äº‹ä»¶: {event.key()}\")\n   793â†’        \n   794â†’        if event.key() == Qt.Key_Left:\n   795â†’            # å·¦æ–¹å‘é”®ï¼šä¸Šä¸€ä¸ªè§†é¢‘\n   796â†’            logger.debug(f\"[KEYBOARD] å·¦é”®pressedï¼Œprev_btn enabled: {self.prev_btn.isEnabled()}\")\n   797â†’            if self.prev_btn.isEnabled():\n   798â†’                self.show_previous_video()\n   799â†’            event.accept()\n   800â†’        elif event.key() == Qt.Key_Right:\n   801â†’            # å³æ–¹å‘é”®ï¼šä¸‹ä¸€ä¸ªè§†é¢‘\n   802â†’            logger.debug(f\"[KEYBOARD] å³é”®pressedï¼Œnext_btn enabled: {self.next_btn.isEnabled()}\")\n   803â†’            if self.next_btn.isEnabled():\n   804â†’                self.show_next_video()\n   805â†’            event.accept()\n   806â†’        elif event.key() == Qt.Key_Escape:\n   807â†’            # ESCé”®ï¼šå…³é—­å¯¹è¯æ¡†ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰\n   808â†’            logger.debug(f\"[KEYBOARD] ESCé”®pressedï¼Œfullscreen: {self.is_fullscreen}\")\n   809â†’            if self.is_fullscreen:\n   810â†’                self.exit_fullscreen()\n   811â†’            else:\n   812â†’                self.accept()\n   813â†’            event.accept()\n   814â†’        elif event.key() == Qt.Key_F11:\n   815â†’            # F11é”®ï¼šå…¨å±åˆ‡æ¢ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰\n   816â†’            self.toggle_fullscreen()\n   817â†’            event.accept()\n   818â†’        elif event.key() == Qt.Key_Space:\n   819â†’            # ç©ºæ ¼é”®ï¼šæ’­æ”¾/æš‚åœ\n   820â†’            self.toggle_play_pause()\n   821â†’            event.accept()\n   822â†’        else:\n   823â†’            # å…¶ä»–æŒ‰é”®äº¤ç»™çˆ¶ç±»å¤„ç†\n   824â†’            super().keyPressEvent(event)\n   825â†’    \n   826â†’    def toggle_fullscreen(self):\n   827â†’        \"\"\"åˆ‡æ¢å…¨å±æ¨¡å¼\"\"\"\n   828â†’        if self.is_fullscreen:\n   829â†’            self.exit_fullscreen()\n   830â†’        else:\n   831â†’            self.enter_fullscreen()\n   832â†’    \n   833â†’    def enter_fullscreen(self):\n   834â†’        \"\"\"è¿›å…¥å…¨å±æ¨¡å¼\"\"\"\n   835â†’        if not self.is_fullscreen:\n   836â†’            self.original_geometry = self.geometry()\n   837â†’            self.showFullScreen()\n   838â†’            self.is_fullscreen = True\n   839â†’    \n   840â†’    def exit_fullscreen(self):\n   841â†’        \"\"\"é€€å‡ºå…¨å±æ¨¡å¼\"\"\"\n   842â†’        if self.is_fullscreen:\n   843â†’            self.showNormal()\n   844â†’            if self.original_geometry:\n   845â†’                self.setGeometry(self.original_geometry)\n   846â†’            self.is_fullscreen = False\n   847â†’    \n   848â†’    def handle_escape_key(self):\n   849â†’        \"\"\"å¤„ç†ESCé”®\"\"\"\n   850â†’        if self.is_fullscreen:\n   851â†’            self.exit_fullscreen()\n   852â†’        else:\n   853â†’            self.accept()\n   854â†’    \n   855â†’    def copy_prompt(self):\n   856â†’        \"\"\"å¤åˆ¶æç¤ºè¯åˆ°å‰ªè´´æ¿\"\"\"\n   857â†’        prompt_content = self.prompt_text_edit.toPlainText()\n   858â†’        clipboard = QApplication.clipboard()\n   859â†’        clipboard.setText(prompt_content)\n   860â†’        self.show_copy_toast(\"æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿\")\n   861â†’    \n   862â†’    def show_copy_toast(self, message: str):\n   863â†’        \"\"\"æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„è½»é‡æç¤º\"\"\"\n   864â†’        toast = QLabel(message, self)\n   865â†’        toast.setObjectName(\"ToastLabel\")\n   866â†’        toast.setAlignment(Qt.AlignCenter)\n   867â†’        toast.adjustSize()\n   868â†’        \n   869â†’        x = (self.width() - toast.width()) // 2\n   870â†’        y = self.height() // 4\n   871â†’        toast.move(x, y)\n   872â†’        toast.show()\n   873â†’        \n   874â†’        QTimer.singleShot(2000, toast.deleteLater)\n   875â†’\n   876â†’    def _on_reference_clicked(self, asset: Dict[str, Any]):\n   877â†’        assets = list(self._reference_assets) if self._reference_assets else [asset]\n   878â†’        start_idx = _find_reference_asset_index(assets, asset)\n   879â†’        open_reference_preview(\n   880â†’            self,\n   881â†’            asset,\n   882â†’            title_prefix=\"å‚è€ƒå›¾\",\n   883â†’            asset_list=assets,\n   884â†’            start_index=start_idx,\n   885â†’            on_asset_changed=self._sync_reference_selection,\n   886â†’        )\n   887â†’\n   888â†’    def _on_reference_export(self, asset: Dict[str, Any]):\n   889â†’        export_reference_asset(self, asset)\n   890â†’\n   891â†’    def _on_reference_selection_changed(self, asset: Dict[str, Any]):\n   892â†’        asset_path = None\n   893â†’        if isinstance(asset, dict):\n   894â†’            asset_path = asset.get('absolute_path') or asset.get('path')\n   895â†’        has_path = bool(asset_path and os.path.exists(asset_path))\n   896â†’        if hasattr(self, 'reference_export_btn'):\n   897â†’            self.reference_export_btn.setEnabled(has_path)\n   898â†’\n   899â†’    def _export_selected_reference(self):\n   900â†’        asset = self.reference_gallery.current_asset() if hasattr(self, 'reference_gallery') else None\n   901â†’        if not asset:\n   902â†’            QMessageBox.information(self, \"å¯¼å‡ºå‚è€ƒå›¾\", \"è¯·å…ˆé€‰æ‹©å‚è€ƒå›¾\")\n   903â†’            return\n   904â†’        export_reference_asset(self, asset)\n   905â†’\n   906â†’    def _refresh_reference_gallery(self):\n   907â†’        if not hasattr(self, 'reference_gallery'):\n   908â†’            return\n   909â†’        self._reference_summary = ensure_reference_info(self.video_data)\n   910â†’        if self._reference_summary.get('count', 0) <= 0:\n   911â†’            self.reference_gallery.setVisible(False)\n   912â†’            self.reference_gallery.clear()\n   913â†’            if hasattr(self, 'reference_export_btn'):\n   914â†’                self.reference_export_btn.setEnabled(False)\n   915â†’            self._reference_assets = []\n   916â†’            self._export_controller.refresh()\n   917â†’            return\n   918â†’        try:\n   919â†’            self._reference_assets = resolve_reference_assets(self.video_data, absolute=True)\n   920â†’        except Exception:\n   921â†’            self._reference_assets = []\n   922â†’        self.reference_gallery.set_assets(self._reference_assets)\n   923â†’        self.reference_gallery.setVisible(True)\n   924â†’        self._on_reference_selection_changed(self.reference_gallery.current_asset())\n   925â†’        self._export_controller.refresh()\n   926â†’\n   927â†’    def _sync_reference_selection(self, asset: Dict[str, Any]):\n   928â†’        try:\n   929â†’            self.reference_gallery.select_asset(asset)\n   930â†’        except Exception:\n   931â†’            pass\n   932â†’\n   933â†’    def _resolve_video_record_id(self) -> Optional[str]:\n   934â†’        for key in (\"file_id\", \"id\", \"generation_id\"):\n   935â†’            value = self.video_data.get(key)\n   936â†’            if value not in (None, \"\"):\n   937â†’                return str(value)\n   938â†’        return None\n   939â†’\n   940â†’    def _delete_current_record(self):\n   941â†’        \"\"\"åˆ é™¤å½“å‰è§†é¢‘è®°å½•åŠç›¸å…³æ–‡ä»¶\"\"\"\n   942â†’        record_id = self._resolve_video_record_id()\n   943â†’        if not record_id:\n   944â†’            self.show_copy_toast(\"æ— æ³•è·å–è®°å½•ID\")\n   945â†’            return\n   946â†’        \n   947â†’        try:\n   948â†’            # åœæ­¢å½“å‰æ’­æ”¾\n   949â†’            if hasattr(self, 'media_player'):\n   950â†’                self.media_player.stop()\n   951â†’            \n   952â†’            # è·å– RepositoryManager\n   953â†’            from config_api import get_storage_dir\n   954â†’            from modules.repository.manager import RepositoryManager\n   955â†’            \n   956â†’            storage_dir = get_storage_dir()\n   957â†’            repo = RepositoryManager(storage_dir)\n   958â†’            \n   959â†’            # æ‰§è¡Œåˆ é™¤\n   960â†’            if repo.delete_record_with_files(record_id):\n   961â†’                self.show_copy_toast(\"è®°å½•å·²åˆ é™¤\")\n   962â†’                \n   963â†’                # å‘å‡ºä¿¡å·é€šçŸ¥çˆ¶è§†å›¾åˆ·æ–°\n   964â†’                self.recordDeleted.emit(record_id)\n   965â†’                \n   966â†’                # ä»åˆ—è¡¨ä¸­ç§»é™¤å½“å‰è®°å½•\n   967â†’                if len(self.video_list) > 1:\n   968â†’                    del self.video_list[self.current_index]\n   969â†’                    \n   970â†’                    # å¯¼èˆªåˆ°åä¸€æ¡è®°å½•ï¼ˆä¿æŒç´¢å¼•ï¼ŒæŒ‡å‘åŸæ¥çš„ä¸‹ä¸€æ¡ï¼‰\n   971â†’                    # åªæœ‰å½“åˆ é™¤çš„æ˜¯æœ€åä¸€æ¡æ—¶ï¼Œæ‰éœ€è¦è°ƒæ•´ç´¢å¼•\n   972â†’                    if self.current_index >= len(self.video_list):\n   973â†’                        self.current_index = len(self.video_list) - 1\n   974â†’                    \n   975â†’                    # æ›´æ–° video_data åˆ°æ–°çš„å½“å‰è®°å½•\n   976â†’                    self.video_data = self.video_list[self.current_index]\n   977â†’                    self.load_video()\n   978â†’                    self.update_navigation_buttons()\n   979â†’                else:\n   980â†’                    # åªå‰©ä¸€æ¡è®°å½•ï¼Œå…³é—­å¯¹è¯æ¡†\n   981â†’                    self.accept()\n   982â†’            else:\n   983â†’                self.show_copy_toast(\"åˆ é™¤å¤±è´¥\")\n   984â†’        except Exception as e:\n   985â†’            from utils.logger import logger\n   986â†’            logger.error(f\"åˆ é™¤è§†é¢‘è®°å½•å¼‚å¸¸: {e}\")\n   987â†’            self.show_copy_toast(f\"åˆ é™¤å¤±è´¥: {str(e)}\")\n   988â†’\n   989â†’    def download_video(self):\n   990â†’        \"\"\"ä¸‹è½½è§†é¢‘åˆ°æŒ‡å®šä½ç½®\"\"\"\n   991â†’        video_path = self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')\n   992â†’        if not video_path or not os.path.exists(video_path):\n   993â†’            self.show_styled_message(\"é”™è¯¯\", \"è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨\", \"warning\")\n   994â†’            return\n   995â†’        \n   996â†’        file_dialog = QFileDialog()\n   997â†’        save_path, _ = file_dialog.getSaveFileName(\n   998â†’            self,\n   999â†’            \"ä¿å­˜è§†é¢‘\",\n  1000â†’            f\"video_{datetime.now().strftime('%Y%m%d_%H%M%S')}.mp4\",\n  1001â†’            \"è§†é¢‘æ–‡ä»¶ (*.mp4)\"\n  1002â†’        )\n  1003â†’        \n  1004â†’        if save_path:\n  1005â†’            try:\n  1006â†’                import shutil\n  1007â†’                shutil.copy2(video_path, save_path)\n  1008â†’                self.show_copy_toast(f\"è§†é¢‘å·²ä¿å­˜åˆ°: {os.path.basename(save_path)}\")\n  1009â†’            except Exception as e:\n  1010â†’                self.show_styled_message(\"é”™è¯¯\", f\"ä¿å­˜è§†é¢‘å¤±è´¥: {str(e)}\", \"critical\")\n  1011â†’    \n  1012â†’    def update_navigation_buttons(self):\n  1013â†’        \"\"\"æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€ï¼ˆåŸºäºæœ‰æ•ˆè®°å½•æ£€æŸ¥ï¼‰\"\"\"\n  1014â†’        logger.debug(f\"[NAV] æ›´æ–°å¯¼èˆªæŒ‰é’®ï¼šå½“å‰ç´¢å¼•{self.current_index}ï¼Œæ€»è®°å½•æ•°{len(self.video_list)}\")\n  1015â†’        \n  1016â†’        has_prev = self._has_valid_previous_record()\n  1017â†’        has_next = self._has_valid_next_record()\n  1018â†’        \n  1019â†’        logger.debug(f\"[NAV] æœ‰æ•ˆè®°å½•æ£€æŸ¥ï¼šprev={has_prev}, next={has_next}\")\n  1020â†’        \n  1021â†’        self.prev_btn.setEnabled(has_prev)\n  1022â†’        self.next_btn.setEnabled(has_next)\n  1023â†’    \n  1024â†’    def _has_valid_previous_record(self):\n  1025â†’        \"\"\"æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ä¸Šä¸€ä¸ªè®°å½•\"\"\"\n  1026â†’        logger.debug(f\"[NAV] æ£€æŸ¥ä¸Šä¸€ä¸ªè®°å½•ï¼šä»ç´¢å¼•{self.current_index - 1}åˆ°0\")\n  1027â†’        for i in range(self.current_index - 1, -1, -1):\n  1028â†’            candidate_data = self.video_list[i]\n  1029â†’            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n  1030â†’            content_type = candidate_data.get('content_type', '')\n  1031â†’            \n  1032â†’            # æ£€æŸ¥æ–‡ä»¶æ‰©å±•åï¼Œç¡®ä¿æ˜¯è§†é¢‘æ–‡ä»¶\n  1033â†’            is_video = False\n  1034â†’            if file_path:\n  1035â†’                from pathlib import Path\n  1036â†’                file_ext = Path(file_path).suffix.lower()\n  1037â†’                is_video = file_ext in ['.mp4', '.avi', '.mov', '.mkv', '.webm']\n  1038â†’            \n  1039â†’            logger.debug(f\"[NAV] æ£€æŸ¥ç´¢å¼•{i}: file_path={file_path}, content_type={content_type}, is_video={is_video}, exists={os.path.exists(file_path) if file_path else False}\")\n  1040â†’            \n  1041â†’            if file_path and os.path.exists(file_path) and is_video:\n  1042â†’                logger.debug(f\"[NAV] æ‰¾åˆ°æœ‰æ•ˆçš„ä¸Šä¸€ä¸ªè§†é¢‘è®°å½•ï¼šç´¢å¼•{i}\")\n  1043â†’                return True\n  1044â†’        logger.debug(f\"[NAV] æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä¸Šä¸€ä¸ªè§†é¢‘è®°å½•\")\n  1045â†’        return False\n  1046â†’    \n  1047â†’    def _has_valid_next_record(self):\n  1048â†’        \"\"\"æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ä¸‹ä¸€ä¸ªè®°å½•\"\"\"\n  1049â†’        logger.debug(f\"[NAV] æ£€æŸ¥ä¸‹ä¸€ä¸ªè®°å½•ï¼šä»ç´¢å¼•{self.current_index + 1}åˆ°{len(self.video_list) - 1}\")\n  1050â†’        for i in range(self.current_index + 1, len(self.video_list)):\n  1051â†’            candidate_data = self.video_list[i]\n  1052â†’            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n  1053â†’            content_type = candidate_data.get('content_type', '')\n  1054â†’            \n  1055â†’            # æ£€æŸ¥æ–‡ä»¶æ‰©å±•åï¼Œç¡®ä¿æ˜¯è§†é¢‘æ–‡ä»¶\n  1056â†’            is_video = False\n  1057â†’            if file_path:\n  1058â†’                from pathlib import Path\n  1059â†’                file_ext = Path(file_path).suffix.lower()\n  1060â†’                is_video = file_ext in ['.mp4', '.avi', '.mov', '.mkv', '.webm']\n  1061â†’            \n  1062â†’            logger.debug(f\"[NAV] æ£€æŸ¥ç´¢å¼•{i}: file_path={file_path}, content_type={content_type}, is_video={is_video}, exists={os.path.exists(file_path) if file_path else False}\")\n  1063â†’            \n  1064â†’            if file_path and os.path.exists(file_path) and is_video:\n  1065â†’                logger.debug(f\"[NAV] æ‰¾åˆ°æœ‰æ•ˆçš„ä¸‹ä¸€ä¸ªè§†é¢‘è®°å½•ï¼šç´¢å¼•{i}\")\n  1066â†’                return True\n  1067â†’        logger.debug(f\"[NAV] æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä¸‹ä¸€ä¸ªè§†é¢‘è®°å½•\")\n  1068â†’        return False\n  1069â†’    \n  1070â†’    def show_previous_video(self):\n  1071â†’        \"\"\"æ˜¾ç¤ºä¸Šä¸€ä¸ªè§†é¢‘ï¼ˆå¸¦æœ‰æ•ˆæ€§éªŒè¯ï¼‰\"\"\"\n  1072â†’        # å¯»æ‰¾ä¸Šä¸€ä¸ªæœ‰æ•ˆè§†é¢‘è®°å½•\n  1073â†’        for i in range(self.current_index - 1, -1, -1):\n  1074â†’            candidate_data = self.video_list[i]\n  1075â†’            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n  1076â†’            \n  1077â†’            # æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘æ–‡ä»¶\n  1078â†’            is_video = False\n  1079â†’            if file_path:\n  1080â†’                from pathlib import Path\n  1081â†’                file_ext = Path(file_path).suffix.lower()\n  1082â†’                is_video = file_ext in ['.mp4', '.avi', '.mov', '.mkv', '.webm']\n  1083â†’            \n  1084â†’            if file_path and os.path.exists(file_path) and is_video:\n  1085â†’                # æ‰¾åˆ°æœ‰æ•ˆè§†é¢‘è®°å½•\n  1086â†’                logger.debug(f\"[NAV] åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªè§†é¢‘ï¼šç´¢å¼•{i}\")\n  1087â†’                self.current_index = i\n  1088â†’                self.video_data = self.video_list[i]\n  1089â†’                self.load_video()\n  1090â†’                self.update_navigation_buttons()\n  1091â†’                return\n  1092â†’        \n  1093â†’        # æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä¸Šä¸€ä¸ªè§†é¢‘è®°å½•ï¼Œä¿æŒå½“å‰çŠ¶æ€\n  1094â†’        logger.debug(f\"[NAV] æ²¡æœ‰ä¸Šä¸€ä¸ªè§†é¢‘å¯åˆ‡æ¢\")\n  1095â†’        self.update_navigation_buttons()\n  1096â†’    \n  1097â†’    def show_next_video(self):\n  1098â†’        \"\"\"æ˜¾ç¤ºä¸‹ä¸€ä¸ªè§†é¢‘ï¼ˆå¸¦æœ‰æ•ˆæ€§éªŒè¯ï¼‰\"\"\"\n  1099â†’        # å¯»æ‰¾ä¸‹ä¸€ä¸ªæœ‰æ•ˆè§†é¢‘è®°å½•\n  1100â†’        for i in range(self.current_index + 1, len(self.video_list)):\n  1101â†’            candidate_data = self.video_list[i]\n  1102â†’            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n  1103â†’            \n  1104â†’            # æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘æ–‡ä»¶\n  1105â†’            is_video = False\n  1106â†’            if file_path:\n  1107â†’                from pathlib import Path\n  1108â†’                file_ext = Path(file_path).suffix.lower()\n  1109â†’                is_video = file_ext in ['.mp4', '.avi', '.mov', '.mkv', '.webm']\n  1110â†’            \n  1111â†’            if file_path and os.path.exists(file_path) and is_video:\n  1112â†’                # æ‰¾åˆ°æœ‰æ•ˆè§†é¢‘è®°å½•\n  1113â†’                logger.debug(f\"[NAV] åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè§†é¢‘ï¼šç´¢å¼•{i}\")\n  1114â†’                self.current_index = i\n  1115â†’                self.video_data = self.video_list[i]\n  1116â†’                self.load_video()\n  1117â†’                self.update_navigation_buttons()\n  1118â†’                return\n  1119â†’        \n  1120â†’        # æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä¸‹ä¸€ä¸ªè§†é¢‘è®°å½•ï¼Œä¿æŒå½“å‰çŠ¶æ€\n  1121â†’        logger.debug(f\"[NAV] æ²¡æœ‰ä¸‹ä¸€ä¸ªè§†é¢‘å¯åˆ‡æ¢\")\n  1122â†’        self.update_navigation_buttons()\n  1123â†’    \n  1124â†’    def load_video(self):\n  1125â†’        \"\"\"åŠ è½½æ–°è§†é¢‘\"\"\"\n  1126â†’        logger.debug(\"[UI] åŠ è½½æ–°è§†é¢‘â€¦\")\n  1127â†’        \n  1128â†’        # åœæ­¢å½“å‰æ’­æ”¾å™¨\n  1129â†’        if hasattr(self, 'media_player') and self.media_player:\n  1130â†’            self.media_player.stop()\n  1131â†’        \n  1132â†’        video_path = self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')\n  1133â†’        if video_path and os.path.exists(video_path):\n  1134â†’            from PySide6.QtCore import QUrl\n  1135â†’            if hasattr(self, 'media_player') and self.media_player:\n  1136â†’                self.media_player.setSource(QUrl.fromLocalFile(video_path))\n  1137â†’            \n  1138â†’            # é‡ç½®åˆ°ç¼©ç•¥å›¾æ¨¡å¼\n  1139â†’            self.video_stack.setCurrentIndex(0)\n  1140â†’            self.is_playing = False\n  1141â†’            \n  1142â†’            # é‡æ–°åŠ è½½ç¼©ç•¥å›¾\n  1143â†’            self.load_thumbnail()\n  1144â†’            \n  1145â†’            # æ›´æ–°å³ä¾§ä¿¡æ¯\n  1146â†’            prompt_content = self.video_data.get('prompt', 'æ— æç¤ºè¯')\n  1147â†’            self.prompt_text_edit.setPlainText(prompt_content)\n  1148â†’            \n  1149â†’            # æ›´æ–°å‚æ•°ä¿¡æ¯\n  1150â†’            self.update_video_params()\n  1151â†’            \n  1152â†’            logger.debug(\"[UI] æ–°è§†é¢‘åŠ è½½å®Œæˆ\")\n  1153â†’        else:\n  1154â†’            self.video_stack.setCurrentIndex(0)\n  1155â†’            self.is_playing = False\n  1156â†’\n  1157â†’        self._refresh_reference_gallery()\n  1158â†’        self._export_controller.refresh()\n  1159â†’    \n  1160â†’    def _update_theme(self):\n  1161â†’        \"\"\"å“åº”ä¸»é¢˜å˜åŒ–\"\"\"\n  1162â†’        colors = unified_style_system.get_colors()\n  1163â†’        \n  1164â†’        # Apply theme to self (Dialog)\n  1165â†’        # Note: In some OS/Qt versions, QDialog styling needs explicit background\n  1166â†’        bg_color = colors.get('palette.neutral.bg_surface') or colors.get('palette.neutral.bg_app') or colors.get('background')\n  1167â†’        text_color = colors.get('text') or colors.get('palette.text.primary')\n  1168â†’        bg_card = colors.get('palette.neutral.bg_card') or colors.get('surface') or bg_color\n  1169â†’        bg_input = colors.get('palette.neutral.bg_input') or colors.get('palette.neutral.bg_card') or bg_card\n  1170â†’        border_subtle = colors.get('palette.neutral.border_subtle') or colors.get('border')\n  1171â†’        brand = colors.get('palette.brand.main') or colors.get('primary') or text_color\n  1172â†’        \n  1173â†’        self.setStyleSheet(f\"\"\"\n  1174â†’            QDialog {{\n  1175â†’                background-color: {bg_color};\n  1176â†’                color: {text_color};\n  1177â†’            }}\n  1178â†’            QLabel {{\n  1179â†’                color: {text_color};\n  1180â†’            }}\n  1181â†’            QWidget#ParamsWidget {{\n  1182â†’                 background-color: {bg_card};\n  1183â†’                 border-left: 1px solid {border_subtle};\n  1184â†’            }}\n  1185â†’        \"\"\")\n  1186â†’        \n  1187â†’        # Update specific controls directly\n  1188â†’        if hasattr(self, 'prompt_text_edit'):\n  1189â†’             self.prompt_text_edit.setStyleSheet(f\"\"\"\n  1190â†’                QTextEdit {{\n  1191â†’                    background-color: {bg_input};\n  1192â†’                    color: {text_color};\n  1193â†’                    border: 1px solid {border_subtle};\n  1194â†’                    border-radius: 8px;\n  1195â†’                    padding: 8px;\n  1196â†’                }}\n  1197â†’                QTextEdit:focus {{\n  1198â†’                    border-color: {brand};\n  1199â†’                }}\n  1200â†’             \"\"\")\n  1201â†’\n  1202â†’        # Manually update param labels that were stored\n  1203â†’        if hasattr(self, 'param_value_labels'):\n  1204â†’            for label, value_label in self.param_value_labels.items():\n  1205â†’                value_label.setStyleSheet(f\"\"\"\n  1206â†’                    QLineEdit {{\n  1207â†’                        background-color: {bg_input};\n  1208â†’                        color: {text_color};\n  1209â†’                        border: 1px solid {border_subtle};\n  1210â†’                        padding: 4px;\n  1211â†’                        border-radius: 8px;\n  1212â†’                    }}\n  1213â†’                    QLineEdit:focus {{\n  1214â†’                        border-color: {brand};\n  1215â†’                    }}\n  1216â†’                \"\"\")\n  1217â†’\n  1218â†’        # Update thumbnail background if visible\n  1219â†’        if hasattr(self, 'thumbnail_label'):\n  1220â†’             player_bg = colors.get('palette.component.player_bg') or bg_color\n  1221â†’             self.thumbnail_label.setStyleSheet(f\"\"\"\n  1222â†’                QLabel {{\n  1223â†’                    border: none;\n  1224â†’                    background-color: {player_bg};\n  1225â†’                    color: {text_color};\n  1226â†’                }}\n  1227â†’             \"\"\")\n  1228â†’\n  1229â†’        # Reapply button styles\n  1230â†’        if hasattr(self, 'fullscreen_btn'):\n  1231â†’            unified_style_system.apply_to_widget(self.fullscreen_btn)\n  1232â†’        if hasattr(self, 'download_btn'):\n  1233â†’            unified_style_system.apply_to_widget(self.download_btn)\n  1234â†’        if hasattr(self, 'delete_btn'):\n  1235â†’            unified_style_system.apply_to_widget(self.delete_btn, extra={'variant': 'danger'})\n  1236â†’        if hasattr(self, 'close_btn'):\n  1237â†’            unified_style_system.apply_to_widget(self.close_btn)\n  1238â†’        if hasattr(self, 'reference_export_btn'):\n  1239â†’            unified_style_system.apply_to_widget(self.reference_export_btn)\n  1240â†’        if hasattr(self, 'export_bundle_btn'):\n  1241â†’            unified_style_system.apply_to_widget(self.export_bundle_btn)\n  1242â†’        if hasattr(self, 'play_button'):\n  1243â†’            unified_style_system.apply_to_widget(self.play_button)\n  1244â†’        if hasattr(self, 'prev_btn'):\n  1245â†’            unified_style_system.apply_to_widget(self.prev_btn)\n  1246â†’        if hasattr(self, 'next_btn'):\n  1247â†’            unified_style_system.apply_to_widget(self.next_btn)\n  1248â†’\n  1249â†’    def update_video_params(self):\n  1250â†’        \"\"\"æ›´æ–°è§†é¢‘å‚æ•°æ˜¾ç¤ºï¼ˆåˆ‡æ¢è§†é¢‘æ—¶è°ƒç”¨ï¼‰\"\"\"\n  1251â†’        try:\n  1252â†’            # è§£æç”Ÿæˆå‚æ•°\n  1253â†’            params = self.video_data.get('parameters', '{}')\n  1254â†’            if isinstance(params, str):\n  1255â†’                try:\n  1256â†’                    params = json.loads(params)\n  1257â†’                except:\n  1258â†’                    params = {}\n  1259â†’\n  1260â†’            # ä» parameters ä¸­è·å–å‚æ•°ï¼ˆå…¼å®¹é¡¶çº§å­—æ®µï¼‰\n  1261â†’            duration = params.get('duration') or self.video_data.get('duration', 'æœªçŸ¥')\n  1262â†’            file_size = params.get('file_size') or self.video_data.get('file_size', 0)\n  1263â†’\n  1264â†’            # é‡æ–°æ„å»ºå‚æ•°ä¿¡æ¯\n  1265â†’            info_items = [\n  1266â†’                (\"åˆ†è¾¨ç‡\", build_resolution_text(self.video_data)),\n  1267â†’                (\"æ—¶é•¿\", f\"{duration}ç§’\"),\n  1268â†’                (\"æ¨¡å‹\", get_model_display_name(pick_model_code(self.video_data))),\n  1269â†’                (\"ç”Ÿæˆæ—¶é—´\", self.format_time(self.video_data.get('created_at', ''))),\n  1270â†’                (\"æ–‡ä»¶å¤§å°\", self.format_file_size(file_size)),\n  1271â†’                (\"æ–‡ä»¶è·¯å¾„\", self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')),\n  1272â†’            ]\n  1273â†’            \n  1274â†’            # æ›´æ–°å·²ä¿å­˜çš„æ ‡ç­¾\n  1275â†’            for label, new_value in info_items:\n  1276â†’                if label in self.param_value_labels:\n  1277â†’                    self.param_value_labels[label].setText(str(new_value))\n  1278â†’            \n  1279â†’            logger.debug(\"è§†é¢‘å‚æ•°å·²æ›´æ–°\")\n  1280â†’            \n  1281â†’        except Exception as e:\n  1282â†’            logger.error(f\"æ›´æ–°è§†é¢‘å‚æ•°å¤±è´¥: {e}\")\n  1283â†’    \n  1284â†’    def update_param_labels(self):\n  1285â†’        \"\"\"æ›´æ–°å‚æ•°æ ‡ç­¾å†…å®¹\"\"\"\n  1286â†’        try:\n  1287â†’            # ä» parameters ä¸­è·å–å‚æ•°ï¼ˆå…¼å®¹é¡¶çº§å­—æ®µï¼‰\n  1288â†’            params = self.video_data.get('parameters', {}) or {}\n  1289â†’            duration = params.get('duration') or self.video_data.get('duration', 'æœªçŸ¥')\n  1290â†’            file_size = params.get('file_size') or self.video_data.get('file_size', 0)\n  1291â†’\n  1292â†’            # æ›´æ–°å„ä¸ªå‚æ•°æ ‡ç­¾\n  1293â†’            param_updates = {\n  1294â†’                \"åˆ†è¾¨ç‡\": build_resolution_text(self.video_data),\n  1295â†’                \"æ—¶é•¿\": f\"{duration}ç§’\",\n  1296â†’                \"æ¨¡å‹\": get_model_display_name(pick_model_code(self.video_data)),\n  1297â†’                \"ç”Ÿæˆæ—¶é—´\": self.format_time(self.video_data.get('created_at', '')),\n  1298â†’                \"æ–‡ä»¶å¤§å°\": self.format_file_size(file_size),\n  1299â†’                \"æ–‡ä»¶è·¯å¾„\": self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')\n  1300â†’            }\n  1301â†’            \n  1302â†’            for param_name, new_value in param_updates.items():\n  1303â†’                if param_name in self.param_labels:\n  1304â†’                    self.param_labels[param_name].setText(str(new_value))\n  1305â†’                    logger.debug(f\"å·²æ›´æ–°å‚æ•° {param_name}: {new_value}\")\n  1306â†’            \n  1307â†’            logger.debug(\"è§†é¢‘å‚æ•°æ ‡ç­¾æ›´æ–°å®Œæˆ\")\n  1308â†’        except Exception as e:\n  1309â†’            logger.error(f\"æ›´æ–°è§†é¢‘å‚æ•°æ ‡ç­¾å¤±è´¥: {e}\")\n  1310â†’    \n  1311â†’    def show_styled_message(self, title: str, message: str, icon_type: str = \"information\"):\n  1312â†’        \"\"\"æ˜¾ç¤ºå¸¦æœ‰æ·±è‰²ä¸»é¢˜æ ·å¼çš„æ¶ˆæ¯æ¡†\"\"\"\n  1313â†’        from PySide6.QtWidgets import QMessageBox\n  1314â†’        \n  1315â†’        msg_box = QMessageBox(self)\n  1316â†’        msg_box.setWindowTitle(title)\n  1317â†’        msg_box.setText(message)\n  1318â†’        \n  1319â†’        # è®¾ç½®å›¾æ ‡\n  1320â†’        if icon_type == \"warning\":\n  1321â†’            msg_box.setIcon(QMessageBox.Warning)\n  1322â†’        elif icon_type == \"critical\":\n  1323â†’            msg_box.setIcon(QMessageBox.Critical)\n  1324â†’        elif icon_type == \"question\":\n  1325â†’            msg_box.setIcon(QMessageBox.Question)\n  1326â†’        else:\n  1327â†’            msg_box.setIcon(QMessageBox.Information)\n  1328â†’        \n  1329â†’        # æ ·å¼ç”±å…¨å±€QSSæ§åˆ¶\n  1330â†’        \n  1331â†’        msg_box.exec()\n  1332â†’\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"0aa92f95-dacd-46e8-953e-42dd3f1ef4ad","timestamp":"2025-12-22T04:37:00.432Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/components/dialogs/video_detail_dialog.py","content":"import os\nimport json\nfrom pathlib import Path\nfrom datetime import datetime\nfrom typing import Dict, Any, List, Optional\n\nfrom PySide6.QtWidgets import (\n    QDialog, QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton,\n    QTextEdit, QFileDialog, QMessageBox, QStackedWidget, QSplitter,\n    QApplication\n)\nfrom PySide6.QtGui import QShortcut\nfrom PySide6.QtCore import Qt, QTimer, QUrl, QSize, QEvent\nfrom PySide6.QtGui import QPixmap, QFont, QKeySequence, QPainter, QImage\nfrom PySide6.QtMultimedia import QMediaPlayer\nfrom PySide6.QtMultimediaWidgets import QVideoWidget\n\n# ä½¿ç”¨å…¨å±€è§†é¢‘ç®¡ç†å™¨å•ä¾‹\nfrom services.global_video_manager import get_global_video_manager\n\nfrom utils.logger import logger\nfrom components.reference_assets import (\n    ReferenceGalleryWidget,\n    export_reference_asset,\n    open_reference_preview,\n    _find_reference_asset_index,\n)\nfrom utils.style_system import unified_style_system\nfrom components.controllers import ExportBundleController\nfrom utils.reference_display import (\n    build_resolution_text,\n    ensure_reference_info,\n    get_model_display_name,\n    pick_model_code,\n    resolve_reference_assets,\n)\nfrom PySide6.QtCore import Signal\n\nclass VideoDetailDialog(QDialog):\n    \"\"\"è§†é¢‘è¯¦ç»†ä¿¡æ¯å¯¹è¯æ¡†\"\"\"\n    \n    # åˆ é™¤è®°å½•åå‘å‡ºä¿¡å·ï¼Œé€šçŸ¥çˆ¶è§†å›¾åˆ·æ–°\n    recordDeleted = Signal(str)  # å‚æ•°ä¸ºè¢«åˆ é™¤çš„è®°å½•ID\n    \n    def __init__(self, video_data: Dict[str, Any], video_list: List[Dict[str, Any]] = None, current_index: int = 0, parent=None):\n        super().__init__(parent)\n        self.video_data = video_data\n        self.video_list = video_list or [video_data]  # è§†é¢‘åˆ—è¡¨\n        self.current_index = current_index  # å½“å‰è§†é¢‘ç´¢å¼•\n        self.is_fullscreen = False  # å…¨å±çŠ¶æ€\n        self.original_geometry = None  # åŸå§‹çª—å£å‡ ä½•\n        self.param_value_labels = {}  # å­˜å‚¨å‚æ•°å€¼æ ‡ç­¾çš„å¼•ç”¨\n        self._reference_summary = ensure_reference_info(self.video_data)\n        self._reference_assets: List[Dict[str, Any]] = []\n        self._export_controller = ExportBundleController(self, \"video\")\n        \n        # Subscribe to theme changes\n        unified_style_system.styleChanged.connect(self._update_theme)\n        \n        self.setup_ui()\n    \n    def set_video_data(self, video_data: Dict[str, Any], video_list: List[Dict[str, Any]] = None, current_index: int = 0):\n        \"\"\"æ›´æ–°è§†é¢‘æ•°æ®ï¼ˆå¤ç”¨å¯¹è¯æ¡†æ—¶è°ƒç”¨ï¼Œé¿å…é‡å»º QVideoWidgetï¼‰\"\"\"\n        logger.debug(f\"[REUSE] å¤ç”¨å¯¹è¯æ¡†ï¼Œæ›´æ–°è§†é¢‘æ•°æ®: index={current_index}\")\n        \n        # 1. å…ˆåœæ­¢å½“å‰æ’­æ”¾\n        if hasattr(self, '_video_manager') and self._video_manager is not None:\n            self._video_manager.stop()\n        \n        # 2. é‡ç½®åˆ°ç¼©ç•¥å›¾æ¨¡å¼\n        if hasattr(self, 'video_stack'):\n            self.video_stack.setCurrentIndex(0)\n        self.is_playing = False\n        \n        # 3. æ›´æ–°æ•°æ®\n        self.video_data = video_data\n        self.video_list = video_list or [video_data]\n        self.current_index = current_index\n        self._reference_summary = ensure_reference_info(self.video_data)\n        \n        # 4. åˆ·æ–°UI\n        self.load_thumbnail()\n        \n        # 5. æ›´æ–°å³ä¾§ä¿¡æ¯\n        if hasattr(self, 'prompt_text_edit'):\n            prompt_content = self.video_data.get('prompt', 'æ— æç¤ºè¯')\n            self.prompt_text_edit.setPlainText(prompt_content)\n        \n        # 6. æ›´æ–°å‚æ•°ä¿¡æ¯\n        if hasattr(self, 'update_video_params'):\n            self.update_video_params()\n        \n        # 7. æ›´æ–°å¯¼èˆªæŒ‰é’®\n        if hasattr(self, 'update_navigation_buttons'):\n            self.update_navigation_buttons()\n        \n        # 8. åˆ·æ–°å‚è€ƒå›¾ç”»å»Š\n        if hasattr(self, '_refresh_reference_gallery'):\n            self._refresh_reference_gallery()\n        \n        # 9. é‡æ–°æ¿€æ´»çª—å£\n        self.setEnabled(True)\n        self.activateWindow()\n        self.raise_()\n        self.setFocus()\n        \n        logger.debug(\"[REUSE] è§†é¢‘æ•°æ®æ›´æ–°å®Œæˆ\")\n        \n    def setup_ui(self):\n        \"\"\"è®¾ç½®UI\"\"\"\n        self.setWindowTitle(\"è§†é¢‘è¯¦ç»†ä¿¡æ¯\")\n        self.resize(1100, 800)  # æ”¹ä¸ºå¯è°ƒæ•´å¤§å°\n        self.setMinimumSize(800, 600)  # è®¾ç½®æœ€å°å°ºå¯¸\n        \n        # è®¾ç½®ç„¦ç‚¹ç­–ç•¥ï¼Œç¡®ä¿èƒ½æ¥æ”¶é”®ç›˜äº‹ä»¶\n        self.setFocusPolicy(Qt.StrongFocus)\n        self.setAttribute(Qt.WA_KeyCompression, False)  # ç¦ç”¨é”®ç›˜äº‹ä»¶å‹ç¼©\n        self.setFocus()\n\n        # ç¡®ä¿çª—å£æ¿€æ´»æ—¶è·å¾—ç„¦ç‚¹\n        self.activateWindow()\n        self.raise_()\n\n        try:\n            self.setObjectName(\"DetailDialog\")\n        except Exception:\n            pass\n\n        self._focus_timer = QTimer(self)\n        self._focus_timer.setSingleShot(True)\n        self._focus_timer.timeout.connect(self._ensure_focus)\n\n        layout = QHBoxLayout(self)\n        \n        # å·¦ä¾§ï¼šè§†é¢‘æ’­æ”¾å™¨ï¼ˆå 70%å®½åº¦ï¼‰\n        left_widget = QWidget()\n        left_layout = QVBoxLayout(left_widget)\n        left_layout.setContentsMargins(0, 0, 0, 0)\n        \n        # è§†é¢‘æ’­æ”¾åŒºåŸŸ\n        video_container = QWidget()\n        video_container.setObjectName(\"VideoContainer\")\n        \n        container_layout = QVBoxLayout(video_container)\n        container_layout.setContentsMargins(0, 0, 0, 0)\n        \n        # åˆ›å»ºå †å å¸ƒå±€ï¼Œç”¨äºç¼©ç•¥å›¾å’Œè§†é¢‘æ’­æ”¾å™¨çš„åˆ‡æ¢\n        from PySide6.QtWidgets import QStackedWidget\n        self.video_stack = QStackedWidget()\n        \n        # ç¼©ç•¥å›¾é¡µé¢\n        self.thumbnail_widget = QWidget()\n        self.thumbnail_widget.setObjectName(\"ThumbnailWidget\")\n        thumbnail_layout = QVBoxLayout(self.thumbnail_widget)\n        thumbnail_layout.setContentsMargins(0, 0, 0, 0)\n        thumbnail_layout.setAlignment(Qt.AlignCenter)\n        \n        # ç¼©ç•¥å›¾æ ‡ç­¾\n        self.thumbnail_label = QLabel()\n        self.thumbnail_label.setAlignment(Qt.AlignCenter)\n        colors = unified_style_system.get_colors()\n        player_bg = colors.get('palette.component.player_bg')\n        text_on_brand = (\n            colors.get('palette.text.on_brand')\n            or colors.get('palette.text.primary')\n            or colors.get('text')\n        )\n        self.thumbnail_label.setStyleSheet(f\"\"\"\n            QLabel {{\n                border: none;\n                background-color: {player_bg};\n                color: {text_on_brand};\n            }}\n        \"\"\")\n        self.thumbnail_label.setMinimumSize(400, 300)\n        # ä¸ä½¿ç”¨setScaledContentsï¼Œæ”¹ä¸ºæ‰‹åŠ¨ç¼©æ”¾\n        # self.thumbnail_label.setScaledContents(True)\n        \n        # æ’­æ”¾æŒ‰é’®è¦†ç›–å±‚\n        self.play_overlay = QLabel(\"â–¶\")\n        self.play_overlay.setAlignment(Qt.AlignCenter)\n        self.play_overlay.setObjectName(\"PlayOverlay\")\n        \n        # åˆ›å»ºç¼©ç•¥å›¾å®¹å™¨ï¼Œä½¿ç”¨ç›¸å¯¹å®šä½\n        thumbnail_container = QWidget()\n        thumbnail_container.setStyleSheet(f\"border: none; background-color: {player_bg};\")\n        # è®¾ç½®å›ºå®šå°ºå¯¸ç¡®ä¿å®¹å™¨æœ‰æ­£ç¡®çš„å¤§å°\n        thumbnail_container.setFixedSize(640, 480)\n        \n        # ä½¿ç”¨ç»å¯¹å®šä½æ”¾ç½®æ’­æ”¾æŒ‰é’®\n        def setup_thumbnail_layout():\n            self.thumbnail_label.setParent(thumbnail_container)\n            self.play_overlay.setParent(thumbnail_container)\n            \n            # ç¡®ä¿æ ‡ç­¾å¯è§\n            self.thumbnail_label.show()\n            self.play_overlay.show()\n            \n            def resize_thumbnail_container():\n                if hasattr(self, 'thumbnail_label') and hasattr(self, 'play_overlay'):\n                    container_size = thumbnail_container.size()\n                    logger.debug(f\"[UI] è¯¦æƒ…ç¼©ç•¥å›¾å®¹å™¨å°ºå¯¸: {container_size}\")\n                    \n                    # è®¾ç½®ç¼©ç•¥å›¾æ ‡ç­¾å°ºå¯¸å’Œä½ç½®\n                    self.thumbnail_label.setGeometry(0, 0, container_size.width(), container_size.height())\n                    \n                    # æ’­æ”¾æŒ‰é’®å±…ä¸­\n                    overlay_x = max(0, (container_size.width() - 70) // 2)\n                    overlay_y = max(0, (container_size.height() - 70) // 2)\n                    self.play_overlay.setGeometry(overlay_x, overlay_y, 70, 70)\n                    \n                    logger.debug(f\"[UI] ç¼©ç•¥å›¾æ ‡ç­¾ä½ç½®: {self.thumbnail_label.geometry()}\")\n                    logger.debug(f\"[UI] æ’­æ”¾æŒ‰é’®ä½ç½®: {self.play_overlay.geometry()}\")\n            \n            def handle_resize_event(event):\n                resize_thumbnail_container()\n                QWidget.resizeEvent(thumbnail_container, event)\n            \n            thumbnail_container.resizeEvent = handle_resize_event\n            \n            # ç«‹å³è°ƒç”¨å¸ƒå±€å‡½æ•°\n            resize_thumbnail_container()\n        \n        setup_thumbnail_layout()\n        \n        # ç‚¹å‡»äº‹ä»¶\n        self.thumbnail_label.mousePressEvent = self.on_thumbnail_click\n        self.play_overlay.mousePressEvent = self.on_thumbnail_click\n        \n        thumbnail_layout.addWidget(thumbnail_container)\n        \n        # è§†é¢‘æ’­æ”¾å™¨é¡µé¢\n        self.video_widget = QVideoWidget()\n        self.video_widget.setObjectName(\"VideoWidget\")\n        \n        # ä½¿ç”¨å…¨å±€è§†é¢‘ç®¡ç†å™¨ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰\n        logger.debug(\"[UI] è¿æ¥å…¨å±€è§†é¢‘ç®¡ç†å™¨...\")\n        self._video_manager = get_global_video_manager()\n        \n        # ç»‘å®šå½“å‰å¯¹è¯æ¡†ï¼ˆç‹¬å ç»‘å®šï¼Œåªæœ‰å½“å‰å¯¹è¯æ¡†æ¥æ”¶ä¿¡å·ï¼‰\n        self._video_manager.bind_dialog(self)\n        logger.debug(\"[UI] å…¨å±€è§†é¢‘ç®¡ç†å™¨ç»‘å®šå®Œæˆ\")\n        \n        # æ’­æ”¾çŠ¶æ€æ ‡å¿—\n        self.is_playing = False\n        \n        # æ·»åŠ åˆ°å †å å¸ƒå±€\n        self.video_stack.addWidget(self.thumbnail_widget)  # ç´¢å¼•0ï¼šç¼©ç•¥å›¾\n        self.video_stack.addWidget(self.video_widget)      # ç´¢å¼•1ï¼šQtè§†é¢‘æ’­æ”¾å™¨\n        \n        # åŠ è½½è§†é¢‘å’Œç¼©ç•¥å›¾\n        video_path = self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')\n        if video_path and os.path.exists(video_path):\n            # ä¸åœ¨åˆå§‹åŒ–æ—¶åŠ è½½åª’ä½“ï¼Œå»¶è¿Ÿåˆ°ç”¨æˆ·ç‚¹å‡»æ’­æ”¾æ—¶\n            self.load_thumbnail()\n        \n        container_layout.addWidget(self.video_stack)\n        \n        # è§†é¢‘åŒºåŸŸå æ®æ‰€æœ‰å¯ç”¨ç©ºé—´\n        left_splitter = QSplitter(Qt.Vertical)\n        left_splitter.addWidget(video_container)\n\n        self.reference_gallery = ReferenceGalleryWidget()\n        try:\n            self.reference_gallery.referenceClicked.connect(self._on_reference_clicked)\n            self.reference_gallery.exportRequested.connect(self._on_reference_export)\n            self.reference_gallery.selectionChanged.connect(self._on_reference_selection_changed)\n        except Exception:\n            pass\n        # å‚è€ƒå›¾åŒºåŸŸå®¹å™¨ï¼ŒåŒ…å«ç”»å»Šä¸æ“ä½œæŒ‰é’®\n        reference_section = QWidget()\n        reference_section_layout = QVBoxLayout(reference_section)\n        reference_section_layout.setContentsMargins(0, 0, 0, 0)\n        reference_section_layout.setSpacing(6)\n        reference_section_layout.addWidget(self.reference_gallery)\n        # å°†å·¦ä¾§åˆ†å‰²å™¨å…ˆåŠ å…¥ä¸»å¸ƒå±€ï¼ˆç¬¬äºŒå—ç¨åè¡¥å……æŒ‰é’®åŒºåå†æ·»åŠ ï¼‰\n        # æ³¨æ„ï¼šæœ€ç»ˆä¼šæŠŠ reference_section æ”¾å…¥åˆ†å‰²å™¨\n\n        reference_button_layout = QHBoxLayout()\n        reference_button_layout.setContentsMargins(0, 0, 0, 0)\n        reference_button_layout.setSpacing(6)\n        self.export_status_label = QLabel(\"\")\n        self.export_status_label.setObjectName(\"infoLabel\")\n        unified_style_system.apply_to_widget(self.export_status_label)\n        reference_button_layout.addWidget(self.export_status_label)\n        reference_button_layout.addStretch(1)\n        self.reference_export_btn = QPushButton(\"å¯¼å‡ºé€‰ä¸­å‚è€ƒå›¾\")\n        self.reference_export_btn.setObjectName(\"SecondaryButton\")\n        self.reference_export_btn.setEnabled(False)\n        unified_style_system.apply_to_widget(self.reference_export_btn)\n        self.reference_export_btn.clicked.connect(self._export_selected_reference)\n        reference_button_layout.addWidget(self.reference_export_btn)\n        self.export_bundle_btn = QPushButton(\"å¯¼å‡ºè®°å½•\")\n        self.export_bundle_btn.setObjectName(\"SecondaryButton\")\n        self.export_bundle_btn.setEnabled(False)\n        unified_style_system.apply_to_widget(self.export_bundle_btn)\n        self._export_controller.configure(\n            self.export_bundle_btn,\n            self.export_status_label,\n            self._resolve_video_record_id,\n            context_widget=self,\n        )\n        reference_button_layout.addWidget(self.export_bundle_btn)\n        reference_section_layout.addLayout(reference_button_layout)\n        # å°†å‚è€ƒå›¾åŒºåŸŸåŠ å…¥åˆ†å‰²å™¨ï¼Œå¹¶æŠŠåˆ†å‰²å™¨åŠ å…¥å·¦ä¾§å¸ƒå±€\n        left_splitter.addWidget(reference_section)\n        try:\n            left_splitter.setStretchFactor(0, 3)\n            left_splitter.setStretchFactor(1, 2)\n            left_splitter.setSizes([520, 280])\n        except Exception:\n            pass\n        left_layout.addWidget(left_splitter, 1)\n\n        # åº•éƒ¨æ§åˆ¶åŒºåŸŸ\n        controls_layout = QHBoxLayout()\n        controls_layout.setContentsMargins(0, 5, 0, 5)\n        controls_layout.setSpacing(10)\n        \n        # æ’­æ”¾/æš‚åœæŒ‰é’®\n        self.play_button = QPushButton(\"â–¶\")\n        self.play_button.setFixedSize(40, 30)\n        self.play_button.setObjectName(\"PlayButton\")\n        unified_style_system.apply_to_widget(self.play_button)\n        self.play_button.clicked.connect(self.toggle_play_pause)\n        controls_layout.addWidget(self.play_button)\n        \n        # è¿›åº¦æ¡ï¼ˆç®€å•çš„æ ‡ç­¾æ˜¾ç¤ºï¼‰\n        self.progress_label = QLabel(\"00:00 / 00:00\")\n        self.progress_label.setObjectName(\"ProgressLabel\")\n        controls_layout.addWidget(self.progress_label, 1)\n        \n        # éŸ³é‡æ§åˆ¶\n        volume_label = QLabel(\"ğŸ”Š\")\n        volume_label.setObjectName(\"infoLabel\")\n        unified_style_system.apply_to_widget(volume_label)\n        controls_layout.addWidget(volume_label)\n        \n        # å¯¼èˆªæŒ‰é’®\n        self.prev_btn = QPushButton(\"â—€\")\n        self.prev_btn.setFixedSize(30, 30)\n        self.prev_btn.setObjectName(\"NavButton\")\n        unified_style_system.apply_to_widget(self.prev_btn)\n        self.prev_btn.clicked.connect(self.show_previous_video)\n        controls_layout.addWidget(self.prev_btn)\n\n        self.next_btn = QPushButton(\"â–¶\")\n        self.next_btn.setFixedSize(30, 30)\n        self.next_btn.setObjectName(\"NavButton\")\n        unified_style_system.apply_to_widget(self.next_btn)\n        self.next_btn.clicked.connect(self.show_next_video)\n        controls_layout.addWidget(self.next_btn)\n        \n        left_layout.addLayout(controls_layout)\n\n        # æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€\n        self.update_navigation_buttons()\n        self._refresh_reference_gallery()\n        self._export_controller.refresh()\n\n        # å³ä¾§ï¼šè¯¦ç»†ä¿¡æ¯ï¼ˆå›ºå®š30%å®½åº¦ï¼‰\n        right_layout = QVBoxLayout()\n        \n        # åˆ›å»ºå‚æ•°æ˜¾ç¤ºåŒºåŸŸ\n        params_widget = QWidget()\n        params_widget.setFixedWidth(int(self.width() * 0.3))\n        params_widget.setObjectName(\"ParamsWidget\")\n        params_layout = QVBoxLayout(params_widget)\n        params_layout.setSpacing(0)\n        params_layout.setContentsMargins(5, 5, 5, 5)\n        \n        # è§£æç”Ÿæˆå‚æ•°\n        params = self.video_data.get('parameters', '{}')\n        if isinstance(params, str):\n            try:\n                params = json.loads(params)\n            except:\n                params = {}\n        \n        # æç¤ºè¯åŒºåŸŸ\n        prompt_label = QLabel(\"<b>æç¤ºè¯:</b>\")\n        prompt_label.setStyleSheet(\"margin: 0px; padding: 2px 0px;\")\n        unified_style_system.apply_to_widget(prompt_label)\n        params_layout.addWidget(prompt_label)\n        \n        # æç¤ºè¯æ–‡æœ¬æ¡†\n        prompt_content = self.video_data.get('prompt', 'æ— æç¤ºè¯')\n        self.prompt_text_edit = QTextEdit()\n        self.prompt_text_edit.setPlainText(prompt_content)\n        self.prompt_text_edit.setReadOnly(True)\n        # çº¦ 4 è¡Œé«˜åº¦ï¼ˆæŒ‰å½“å‰å­—ä½“åŠ¨æ€è®¡ç®—ï¼‰ï¼Œé¿å…æç¤ºè¯åŒºåŸŸè¿‡é«˜æŒ¤å‹å…¶å®ƒä¿¡æ¯\n        try:\n            line_height = self.prompt_text_edit.fontMetrics().lineSpacing()\n            target_lines = 4\n            vertical_padding = 16  # ä¸å…¨å±€ QTextEdit padding (8*2) å¯¹é½\n            border = 2  # 1px*2\n            height = line_height * target_lines + vertical_padding + border\n            self.prompt_text_edit.setFixedHeight(max(72, int(height)))\n        except Exception:\n            self.prompt_text_edit.setMaximumHeight(96)\n            self.prompt_text_edit.setMinimumHeight(96)\n        unified_style_system.apply_to_widget(self.prompt_text_edit)\n        # åº”ç”¨ä¸ _update_theme ä¸€è‡´çš„é¢å¤–æ ·å¼\n        colors = unified_style_system.get_colors()\n        bg_input = colors.get('palette.neutral.bg_input') or colors.get('palette.neutral.bg_card')\n        text_color = colors.get('text') or colors.get('palette.text.primary')\n        border_subtle = colors.get('palette.neutral.border_subtle') or colors.get('border')\n        brand = colors.get('palette.brand.main') or colors.get('primary')\n        self.prompt_text_edit.setStyleSheet(f\"\"\"\n            QTextEdit {{\n                background-color: {bg_input};\n                color: {text_color};\n                border: 1px solid {border_subtle};\n                border-radius: 8px;\n                padding: 8px;\n            }}\n            QTextEdit:focus {{\n                border-color: {brand};\n            }}\n        \"\"\")\n        params_layout.addWidget(self.prompt_text_edit)\n        \n        # å¤åˆ¶æç¤ºè¯æŒ‰é’®ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„ SecondaryButton æ ·å¼ï¼‰\n        self.copy_prompt_btn = QPushButton(\"å¤åˆ¶æç¤ºè¯\")\n        self.copy_prompt_btn.setObjectName(\"SecondaryButton\")\n        self.copy_prompt_btn.setMaximumHeight(30)\n        unified_style_system.apply_to_widget(self.copy_prompt_btn)\n        self.copy_prompt_btn.clicked.connect(self.copy_prompt)\n        params_layout.addWidget(self.copy_prompt_btn)\n        \n        # è¯¦ç»†ä¿¡æ¯ - ä¿å­˜æ ‡ç­¾å¼•ç”¨ä»¥ä¾¿åç»­æ›´æ–°\n        self.param_labels = {}  # å­˜å‚¨å‚æ•°å€¼æ ‡ç­¾çš„å¼•ç”¨\n\n        # ä» parameters ä¸­è·å–å‚æ•°ï¼ˆå…¼å®¹é¡¶çº§å­—æ®µï¼‰\n        params = self.video_data.get('parameters', {}) or {}\n        duration = params.get('duration') or self.video_data.get('duration', 'æœªçŸ¥')\n        file_size = params.get('file_size') or self.video_data.get('file_size', 0)\n\n        info_items = [\n            (\"åˆ†è¾¨ç‡\", build_resolution_text(self.video_data)),\n            (\"æ—¶é•¿\", f\"{duration}ç§’\"),\n            (\"æ¨¡å‹\", get_model_display_name(pick_model_code(self.video_data))),\n            (\"ç”Ÿæˆæ—¶é—´\", self.format_time(self.video_data.get('created_at', ''))),\n            (\"æ–‡ä»¶å¤§å°\", self.format_file_size(file_size)),\n            (\"æ–‡ä»¶è·¯å¾„\", self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')),\n        ]\n        \n        for label, value in info_items:\n            label_widget = QLabel(f\"<b>{label}:</b>\")\n            label_widget.setStyleSheet(\"margin: 0px; padding: 2px 0px;\")\n            unified_style_system.apply_to_widget(label_widget)\n            params_layout.addWidget(label_widget)\n            \n            # Use QLineEdit for better copy interaction\n            from PySide6.QtWidgets import QLineEdit\n            value_label = QLineEdit(str(value))\n            value_label.setReadOnly(True)\n            value_label.setCursorPosition(0)\n            value_label.setCursorPosition(0)\n            # Style is now handled in _update_theme\n            unified_style_system.apply_to_widget(value_label)\n            params_layout.addWidget(value_label)\n            \n            # ä¿å­˜å‚æ•°å€¼æ ‡ç­¾å¼•ç”¨ï¼Œç”¨äºåç»­æ›´æ–°\n            self.param_value_labels[label] = value_label\n        \n        right_layout.addWidget(params_widget)\n        \n        # æ§åˆ¶æŒ‰é’®\n        button_layout = QHBoxLayout()\n\n        self.fullscreen_btn = QPushButton(\"å…¨å± (F11)\")\n        self.fullscreen_btn.setMaximumHeight(30)\n        unified_style_system.apply_to_widget(self.fullscreen_btn)\n        self.fullscreen_btn.clicked.connect(self.toggle_fullscreen)\n        button_layout.addWidget(self.fullscreen_btn)\n\n        self.download_btn = QPushButton(\"ä¸‹è½½è§†é¢‘\")\n        self.download_btn.setMaximumHeight(30)\n        unified_style_system.apply_to_widget(self.download_btn)\n        self.download_btn.clicked.connect(self.download_video)\n        button_layout.addWidget(self.download_btn)\n\n        self.delete_btn = QPushButton(\"åˆ é™¤è®°å½•\")\n        self.delete_btn.setMaximumHeight(30)\n        unified_style_system.apply_to_widget(self.delete_btn, extra={'variant': 'danger'})\n        self.delete_btn.clicked.connect(self._delete_current_record)\n        button_layout.addWidget(self.delete_btn)\n\n        right_layout.addLayout(button_layout)\n\n        self.close_btn = QPushButton(\"å…³é—­ï¼ˆESCï¼‰\")\n        unified_style_system.apply_to_widget(self.close_btn)\n        self.close_btn.clicked.connect(self.accept)\n        right_layout.addWidget(self.close_btn)\n        \n        # è®¾ç½®å¸ƒå±€æ¯”ä¾‹ï¼šå·¦ä¾§70%ï¼Œå³ä¾§30%\n        layout.addWidget(left_widget, 7)\n        layout.addLayout(right_layout, 3)\n        \n        # æ·»åŠ é”®ç›˜å¿«æ·é”®\n        self.setup_shortcuts()\n\n        # å»¶è¿Ÿè®¾ç½®ç„¦ç‚¹ï¼Œç¡®ä¿çª—å£å®Œå…¨åˆå§‹åŒ–åè·å¾—ç„¦ç‚¹\n        self._focus_timer.start(100)\n        self._esc_shortcut = QShortcut(QKeySequence(Qt.Key_Escape), self)\n        self._esc_shortcut.activated.connect(self.handle_escape_key)\n        self._esc_shortcut.activated.connect(self.handle_escape_key)\n        \n        # Apply initial theme\n        self._update_theme()\n        \n        # ä¿¡å·å·²åœ¨setup_uiå¼€å¤´è¿æ¥ï¼Œä¸é‡å¤è¿æ¥\n    \n    def closeEvent(self, event):\n        \"\"\"çª—å£å…³é—­äº‹ä»¶ï¼Œç¡®ä¿åœæ­¢æ’­æ”¾å¹¶é‡Šæ”¾èµ„æº\"\"\"\n        # 0. é˜»æ­¢å¯¹è¯æ¡†ç»§ç»­æ¥æ”¶äº‹ä»¶\n        self.setEnabled(False)\n        \n        # 1. åœæ­¢ç„¦ç‚¹å®šæ—¶å™¨\n        if hasattr(self, '_focus_timer') and self._focus_timer.isActive():\n            self._focus_timer.stop()\n        \n        # 2. æ¸…ç†å‚è€ƒå›¾ç”»å»Š\n        if hasattr(self, 'reference_gallery') and self.reference_gallery is not None:\n            try:\n                self.reference_gallery.clear()\n            except Exception as e:\n                logger.warning(f\"[CLEANUP] æ¸…ç†å‚è€ƒå›¾ç”»å»Šæ—¶å‡ºé”™: {e}\")\n        \n        # 3. è§£ç»‘å¹¶åœæ­¢å…¨å±€è§†é¢‘ç®¡ç†å™¨\n        if hasattr(self, '_video_manager') and self._video_manager is not None:\n            try:\n                # è§£ç»‘å¯¹è¯æ¡†ï¼ˆå–æ¶ˆç‹¬å ç»‘å®šï¼‰\n                self._video_manager.unbind_dialog(self)\n                \n                # åœæ­¢æ’­æ”¾å¹¶æ–­å¼€è§†é¢‘è¾“å‡º\n                self._video_manager.stop()\n                \n            except Exception as e:\n                logger.warning(f\"[CLEANUP] åœæ­¢å…¨å±€è§†é¢‘ç®¡ç†å™¨æ—¶å‡ºé”™: {e}\")\n\n        # 4. å…¼å®¹æ—§å­—æ®µï¼šè‹¥å­˜åœ¨æœ¬åœ° media_player ä¹Ÿåœæ­¢\n        if hasattr(self, 'media_player') and self.media_player:\n            try:\n                self.media_player.stop()\n            except Exception:\n                pass\n\n        # 5. æ¸…ç†å¯¼å‡ºæ§åˆ¶å™¨\n        try:\n            self._export_controller.dispose()\n        except Exception:\n            pass\n        \n        self.is_playing = False\n        super().closeEvent(event)\n    \n    def load_thumbnail(self):\n        \"\"\"åŠ è½½è§†é¢‘ç¼©ç•¥å›¾\"\"\"\n        import os  # å°†oså¯¼å…¥ç§»åˆ°å‡½æ•°å¼€å¤´\n        try:\n            logger.debug(\"å¼€å§‹åŠ è½½ç¼©ç•¥å›¾...\")\n            logger.debug(f\"è§†é¢‘æ•°æ®: {self.video_data}\")\n            \n            # è·å–ç¼©ç•¥å›¾è·¯å¾„\n            thumbnail_path = self.video_data.get('thumbnail_local_path', '')\n            logger.debug(f\"ä»video_dataè·å–çš„thumbnail_local_path: {thumbnail_path}\")\n            \n            if thumbnail_path and os.path.exists(thumbnail_path):\n                logger.debug(f\"æ‰¾åˆ°ç°æœ‰ç¼©ç•¥å›¾æ–‡ä»¶: {thumbnail_path}\")\n                # ä½¿ç”¨ç°æœ‰ç¼©ç•¥å›¾\n                pixmap = QPixmap(thumbnail_path)\n                logger.debug(f\"QPixmapåŠ è½½ç»“æœ: isNull={pixmap.isNull()}, size={pixmap.size()}\")\n            else:\n                logger.debug(\"ç¼©ç•¥å›¾æ–‡ä»¶ä¸å­˜åœ¨æˆ–è·¯å¾„ä¸ºç©ºï¼Œå¼€å§‹ç”Ÿæˆç¼©ç•¥å›¾...\")\n                # ç”Ÿæˆç¼©ç•¥å›¾\n                video_path = self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')\n                logger.debug(f\"è§†é¢‘æ–‡ä»¶è·¯å¾„: {video_path}\")\n                \n                if video_path and os.path.exists(video_path):\n                    logger.debug(\"è§†é¢‘æ–‡ä»¶å­˜åœ¨ï¼Œå¼€å§‹ç”Ÿæˆç¼©ç•¥å›¾...\")\n                    from utils.video_thumbnail_generator import VideoThumbnailGenerator\n                    from config_api import get_storage_dir\n                    storage_dir = get_storage_dir()\n                    thumbnails_dir = os.path.join(storage_dir, 'thumbnails')\n                    logger.debug(f\"ç¼©ç•¥å›¾ç›®å½•: {thumbnails_dir}\")\n                    \n                    generator = VideoThumbnailGenerator(thumbnails_dir)\n                    video_id = self.video_data.get('id', os.path.basename(video_path).split('.')[0])\n                    logger.debug(f\"è§†é¢‘ID: {video_id}\")\n                    \n                    thumbnail_path = generator.generate_thumbnail_for_video(video_path, video_id)\n                    logger.debug(f\"ç”Ÿæˆçš„ç¼©ç•¥å›¾è·¯å¾„: {thumbnail_path}\")\n                    \n                    if thumbnail_path and os.path.exists(thumbnail_path):\n                        logger.debug(\"ç¼©ç•¥å›¾ç”ŸæˆæˆåŠŸï¼ŒåŠ è½½åˆ°QPixmap...\")\n                        pixmap = QPixmap(thumbnail_path)\n                        logger.debug(f\"QPixmapåŠ è½½ç»“æœ: isNull={pixmap.isNull()}, size={pixmap.size()}\")\n                    else:\n                        logger.debug(\"ç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å›¾ç‰‡\")\n                        # ä½¿ç”¨é»˜è®¤å›¾ç‰‡\n                        pixmap = self.create_default_thumbnail()\n                else:\n                    logger.debug(\"è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å›¾ç‰‡\")\n                    pixmap = self.create_default_thumbnail()\n            \n            if not pixmap.isNull():\n                logger.debug(\"å¼€å§‹ç¼©æ”¾å›¾ç‰‡...\")\n                # ç¼©æ”¾å›¾ç‰‡ä»¥é€‚åº”æ ‡ç­¾å¤§å°\n                label_size = self.thumbnail_label.size()\n                logger.debug(f\"æ ‡ç­¾å¤§å°: {label_size}\")\n                \n                scaled_pixmap = pixmap.scaled(\n                    label_size,\n                    Qt.KeepAspectRatio,\n                    Qt.SmoothTransformation\n                )\n                logger.debug(f\"ç¼©æ”¾åå›¾ç‰‡å¤§å°: {scaled_pixmap.size()}\")\n                \n                self.thumbnail_label.setPixmap(scaled_pixmap)\n                logger.debug(\"ç¼©ç•¥å›¾è®¾ç½®æˆåŠŸ\")\n            else:\n                logger.debug(\"QPixmapä¸ºç©ºï¼Œæ˜¾ç¤ºé”™è¯¯æ–‡æœ¬\")\n                self.thumbnail_label.setText(\"æ— æ³•åŠ è½½ç¼©ç•¥å›¾\")\n                \n        except Exception as e:\n            logger.debug(f\"åŠ è½½ç¼©ç•¥å›¾å¼‚å¸¸: {e}\")\n            import traceback\n            traceback.print_exc()\n            self.thumbnail_label.setText(\"ç¼©ç•¥å›¾åŠ è½½å¤±è´¥\")\n    \n    def create_default_thumbnail(self):\n        \"\"\"åˆ›å»ºé»˜è®¤ç¼©ç•¥å›¾\"\"\"\n        pixmap = QPixmap(400, 300)\n        pixmap.fill(Qt.black)\n        \n        from PySide6.QtGui import QPainter, QFont\n        painter = QPainter(pixmap)\n        painter.setPen(Qt.white)\n        painter.setFont(QFont())  # Font configuration handled by unified style system\n        painter.drawText(pixmap.rect(), Qt.AlignCenter, \"è§†é¢‘é¢„è§ˆ\")\n        painter.end()\n        \n        return pixmap\n    \n    def on_thumbnail_click(self, event):\n        \"\"\"ç¼©ç•¥å›¾ç‚¹å‡»äº‹ä»¶\"\"\"\n        self.start_video_playback()\n    \n    def start_video_playback(self):\n        \"\"\"å¼€å§‹è§†é¢‘æ’­æ”¾\"\"\"\n        logger.debug(\"[UI] å¼€å§‹è§†é¢‘æ’­æ”¾â€¦\")\n        \n        # æ£€æŸ¥è§†é¢‘æ–‡ä»¶\n        video_path = self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')\n        \n        if not video_path or not os.path.exists(video_path):\n            logger.warning(f\"[UI] è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨: {video_path}\")\n            from PySide6.QtWidgets import QMessageBox\n            QMessageBox.critical(self, \"é”™è¯¯\", \"è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨\")\n            return\n        \n        # åˆ‡æ¢åˆ°è§†é¢‘æ’­æ”¾å™¨\n        self.video_stack.setCurrentIndex(1)\n        self.is_playing = True\n        \n        # ä½¿ç”¨å…¨å±€è§†é¢‘ç®¡ç†å™¨æ’­æ”¾\n        self._video_manager.play(video_path, self.video_widget)\n        logger.debug(\"[UI] å¼€å§‹æ’­æ”¾è§†é¢‘\")\n    \n    def toggle_play_pause(self):\n        \"\"\"åˆ‡æ¢æ’­æ”¾/æš‚åœ\"\"\"\n        if not self.is_playing:\n            self.start_video_playback()\n        else:\n            self._video_manager.toggle_play_pause()\n    \n    def on_state_changed(self, state):\n        \"\"\"æ’­æ”¾çŠ¶æ€æ”¹å˜\"\"\"\n        if state == QMediaPlayer.PlaybackState.PlayingState:\n            self.play_button.setText(\"â¸\")\n        else:\n            self.play_button.setText(\"â–¶\")\n    \n    def on_position_changed(self, position):\n        \"\"\"æ’­æ”¾ä½ç½®æ”¹å˜\"\"\"\n        if hasattr(self, 'media_player'):\n            duration = self.media_player.duration()\n            if duration > 0:\n                current_time = self.format_duration(position)\n                total_time = self.format_duration(duration)\n                self.progress_label.setText(f\"{current_time} / {total_time}\")\n    \n    def on_duration_changed(self, duration):\n        \"\"\"è§†é¢‘æ—¶é•¿æ”¹å˜\"\"\"\n        if duration > 0:\n            total_time = self.format_duration(duration)\n            self.progress_label.setText(f\"00:00 / {total_time}\")\n    \n    def on_media_error(self, error, error_string):\n        \"\"\"åª’ä½“æ’­æ”¾é”™è¯¯å¤„ç†\"\"\"\n        logger.error(f\"[MEDIA] æ’­æ”¾é”™è¯¯: {error}, ä¿¡æ¯: {error_string}\")\n        \n        from PySide6.QtWidgets import QMessageBox\n        msg_box = QMessageBox(self)\n        msg_box.setIcon(QMessageBox.Critical)\n        msg_box.setText(\"è§†é¢‘æ’­æ”¾é”™è¯¯\")\n        msg_box.setInformativeText(f\"æ— æ³•æ’­æ”¾è§†é¢‘: {error_string}\")\n        msg_box.exec()\n        \n        # è¿”å›ç¼©ç•¥å›¾æ¨¡å¼\n        self.video_stack.setCurrentIndex(0)\n        self.is_playing = False\n    \n    def on_media_status_changed(self, status):\n        \"\"\"åª’ä½“çŠ¶æ€æ”¹å˜\"\"\"\n        from PySide6.QtMultimedia import QMediaPlayer\n        \n        logger.debug(f\"[MEDIA] çŠ¶æ€æ”¹å˜: {status}\")\n        \n        if status == QMediaPlayer.MediaStatus.EndOfMedia:\n            # è§†é¢‘æ’­æ”¾ç»“æŸï¼Œè¿”å›ç¼©ç•¥å›¾æ¨¡å¼\n            logger.debug(\"[MEDIA] æ’­æ”¾ç»“æŸï¼Œåˆ‡å›ç¼©ç•¥å›¾æ¨¡å¼\")\n            self.video_stack.setCurrentIndex(0)\n            self.is_playing = False\n            if hasattr(self, 'media_player'):\n                self.media_player.setPosition(0)  # é‡ç½®æ’­æ”¾ä½ç½®\n            self.progress_label.setText(\"00:00 / 00:00\")\n        elif status == QMediaPlayer.MediaStatus.InvalidMedia:\n            logger.warning(\"[MEDIA] åª’ä½“æ–‡ä»¶æ— æ•ˆ\")\n        elif status == QMediaPlayer.MediaStatus.BufferedMedia:\n            logger.debug(\"[MEDIA] åª’ä½“ç¼“å†²å®Œæˆ\")\n        elif status == QMediaPlayer.MediaStatus.LoadingMedia:\n            logger.debug(\"[MEDIA] æ­£åœ¨åŠ è½½åª’ä½“\")\n        elif status == QMediaPlayer.MediaStatus.StalledMedia:\n            logger.debug(\"[MEDIA] æ’­æ”¾å¡é¡¿\")\n    \n    def format_duration(self, ms):\n        \"\"\"æ ¼å¼åŒ–æ—¶é•¿æ˜¾ç¤º\"\"\"\n        seconds = ms // 1000\n        minutes = seconds // 60\n        seconds = seconds % 60\n        return f\"{minutes:02d}:{seconds:02d}\"\n    \n    # OpenCV playback methods removed - using QtMultimedia exclusively\n\n    \n    def format_time(self, time_str: str) -> str:\n        \"\"\"æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º\"\"\"\n        if not time_str:\n            return 'æœªçŸ¥æ—¶é—´'\n        try:\n            dt = datetime.fromisoformat(time_str.replace('Z', '+00:00'))\n            return dt.strftime('%Y-%m-%d %H:%M:%S')\n        except:\n            return time_str[:19] if len(time_str) > 19 else time_str\n    \n    def format_file_size(self, size) -> str:\n        \"\"\"æ ¼å¼åŒ–æ–‡ä»¶å¤§å°æ˜¾ç¤º\"\"\"\n        try:\n            size = float(size) if size else 0\n        except (ValueError, TypeError):\n            return 'æœªçŸ¥å¤§å°'\n            \n        if size == 0:\n            return 'æœªçŸ¥å¤§å°'\n        \n        for unit in ['B', 'KB', 'MB', 'GB']:\n            if size < 1024.0:\n                return f\"{size:.1f} {unit}\"\n            size /= 1024.0\n        return f\"{size:.1f} TB\"\n    \n    def setup_shortcuts(self):\n        \"\"\"è®¾ç½®é”®ç›˜å¿«æ·é”®\"\"\"\n        # ç§»é™¤æ‰€æœ‰QShortcutï¼Œç»Ÿä¸€ä½¿ç”¨keyPressEventå¤„ç†\n        # é¿å…å¿«æ·é”®å†²çªé—®é¢˜\n        pass\n    \n    def _ensure_focus(self):\n        \"\"\"ç¡®ä¿çª—å£è·å¾—ç„¦ç‚¹\"\"\"\n        self.activateWindow()\n        self.raise_()\n        self.setFocus()\n        logger.debug(f\"[FOCUS] VideoDialogçª—å£ç„¦ç‚¹è®¾ç½®å®Œæˆï¼ŒhasFocus: {self.hasFocus()}\")\n    \n    def keyPressEvent(self, event):\n        \"\"\"é”®ç›˜äº‹ä»¶å¤„ç†\"\"\"\n        from PySide6.QtCore import Qt\n        \n        logger.debug(f\"[KEYBOARD] VideoDetailDialogé”®ç›˜äº‹ä»¶: {event.key()}\")\n        \n        if event.key() == Qt.Key_Left:\n            # å·¦æ–¹å‘é”®ï¼šä¸Šä¸€ä¸ªè§†é¢‘\n            logger.debug(f\"[KEYBOARD] å·¦é”®pressedï¼Œprev_btn enabled: {self.prev_btn.isEnabled()}\")\n            if self.prev_btn.isEnabled():\n                self.show_previous_video()\n            event.accept()\n        elif event.key() == Qt.Key_Right:\n            # å³æ–¹å‘é”®ï¼šä¸‹ä¸€ä¸ªè§†é¢‘\n            logger.debug(f\"[KEYBOARD] å³é”®pressedï¼Œnext_btn enabled: {self.next_btn.isEnabled()}\")\n            if self.next_btn.isEnabled():\n                self.show_next_video()\n            event.accept()\n        elif event.key() == Qt.Key_Escape:\n            # ESCé”®ï¼šå…³é—­å¯¹è¯æ¡†ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰\n            logger.debug(f\"[KEYBOARD] ESCé”®pressedï¼Œfullscreen: {self.is_fullscreen}\")\n            if self.is_fullscreen:\n                self.exit_fullscreen()\n            else:\n                self.accept()\n            event.accept()\n        elif event.key() == Qt.Key_F11:\n            # F11é”®ï¼šå…¨å±åˆ‡æ¢ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰\n            self.toggle_fullscreen()\n            event.accept()\n        elif event.key() == Qt.Key_Space:\n            # ç©ºæ ¼é”®ï¼šæ’­æ”¾/æš‚åœ\n            self.toggle_play_pause()\n            event.accept()\n        else:\n            # å…¶ä»–æŒ‰é”®äº¤ç»™çˆ¶ç±»å¤„ç†\n            super().keyPressEvent(event)\n    \n    def toggle_fullscreen(self):\n        \"\"\"åˆ‡æ¢å…¨å±æ¨¡å¼\"\"\"\n        if self.is_fullscreen:\n            self.exit_fullscreen()\n        else:\n            self.enter_fullscreen()\n    \n    def enter_fullscreen(self):\n        \"\"\"è¿›å…¥å…¨å±æ¨¡å¼\"\"\"\n        if not self.is_fullscreen:\n            self.original_geometry = self.geometry()\n            self.showFullScreen()\n            self.is_fullscreen = True\n    \n    def exit_fullscreen(self):\n        \"\"\"é€€å‡ºå…¨å±æ¨¡å¼\"\"\"\n        if self.is_fullscreen:\n            self.showNormal()\n            if self.original_geometry:\n                self.setGeometry(self.original_geometry)\n            self.is_fullscreen = False\n    \n    def handle_escape_key(self):\n        \"\"\"å¤„ç†ESCé”®\"\"\"\n        if self.is_fullscreen:\n            self.exit_fullscreen()\n        else:\n            self.accept()\n    \n    def copy_prompt(self):\n        \"\"\"å¤åˆ¶æç¤ºè¯åˆ°å‰ªè´´æ¿\"\"\"\n        prompt_content = self.prompt_text_edit.toPlainText()\n        clipboard = QApplication.clipboard()\n        clipboard.setText(prompt_content)\n        self.show_copy_toast(\"æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿\")\n    \n    def show_copy_toast(self, message: str):\n        \"\"\"æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„è½»é‡æç¤º\"\"\"\n        toast = QLabel(message, self)\n        toast.setObjectName(\"ToastLabel\")\n        toast.setAlignment(Qt.AlignCenter)\n        toast.adjustSize()\n        \n        x = (self.width() - toast.width()) // 2\n        y = self.height() // 4\n        toast.move(x, y)\n        toast.show()\n        \n        QTimer.singleShot(2000, toast.deleteLater)\n\n    def _on_reference_clicked(self, asset: Dict[str, Any]):\n        assets = list(self._reference_assets) if self._reference_assets else [asset]\n        start_idx = _find_reference_asset_index(assets, asset)\n        open_reference_preview(\n            self,\n            asset,\n            title_prefix=\"å‚è€ƒå›¾\",\n            asset_list=assets,\n            start_index=start_idx,\n            on_asset_changed=self._sync_reference_selection,\n        )\n\n    def _on_reference_export(self, asset: Dict[str, Any]):\n        export_reference_asset(self, asset)\n\n    def _on_reference_selection_changed(self, asset: Dict[str, Any]):\n        asset_path = None\n        if isinstance(asset, dict):\n            asset_path = asset.get('absolute_path') or asset.get('path')\n        has_path = bool(asset_path and os.path.exists(asset_path))\n        if hasattr(self, 'reference_export_btn'):\n            self.reference_export_btn.setEnabled(has_path)\n\n    def _export_selected_reference(self):\n        asset = self.reference_gallery.current_asset() if hasattr(self, 'reference_gallery') else None\n        if not asset:\n            QMessageBox.information(self, \"å¯¼å‡ºå‚è€ƒå›¾\", \"è¯·å…ˆé€‰æ‹©å‚è€ƒå›¾\")\n            return\n        export_reference_asset(self, asset)\n\n    def _refresh_reference_gallery(self):\n        if not hasattr(self, 'reference_gallery'):\n            return\n        self._reference_summary = ensure_reference_info(self.video_data)\n        if self._reference_summary.get('count', 0) <= 0:\n            self.reference_gallery.setVisible(False)\n            self.reference_gallery.clear()\n            if hasattr(self, 'reference_export_btn'):\n                self.reference_export_btn.setEnabled(False)\n            self._reference_assets = []\n            self._export_controller.refresh()\n            return\n        try:\n            self._reference_assets = resolve_reference_assets(self.video_data, absolute=True)\n        except Exception:\n            self._reference_assets = []\n        self.reference_gallery.set_assets(self._reference_assets)\n        self.reference_gallery.setVisible(True)\n        self._on_reference_selection_changed(self.reference_gallery.current_asset())\n        self._export_controller.refresh()\n\n    def _sync_reference_selection(self, asset: Dict[str, Any]):\n        try:\n            self.reference_gallery.select_asset(asset)\n        except Exception:\n            pass\n\n    def _resolve_video_record_id(self) -> Optional[str]:\n        for key in (\"file_id\", \"id\", \"generation_id\"):\n            value = self.video_data.get(key)\n            if value not in (None, \"\"):\n                return str(value)\n        return None\n\n    def _delete_current_record(self):\n        \"\"\"åˆ é™¤å½“å‰è§†é¢‘è®°å½•åŠç›¸å…³æ–‡ä»¶\"\"\"\n        record_id = self._resolve_video_record_id()\n        if not record_id:\n            self.show_copy_toast(\"æ— æ³•è·å–è®°å½•ID\")\n            return\n        \n        try:\n            # åœæ­¢å½“å‰æ’­æ”¾\n            if hasattr(self, 'media_player'):\n                self.media_player.stop()\n            \n            # è·å– RepositoryManager\n            from config_api import get_storage_dir\n            from modules.repository.manager import RepositoryManager\n            \n            storage_dir = get_storage_dir()\n            repo = RepositoryManager(storage_dir)\n            \n            # æ‰§è¡Œåˆ é™¤\n            if repo.delete_record_with_files(record_id):\n                self.show_copy_toast(\"è®°å½•å·²åˆ é™¤\")\n                \n                # å‘å‡ºä¿¡å·é€šçŸ¥çˆ¶è§†å›¾åˆ·æ–°\n                self.recordDeleted.emit(record_id)\n                \n                # ä»åˆ—è¡¨ä¸­ç§»é™¤å½“å‰è®°å½•\n                if len(self.video_list) > 1:\n                    del self.video_list[self.current_index]\n                    \n                    # å¯¼èˆªåˆ°åä¸€æ¡è®°å½•ï¼ˆä¿æŒç´¢å¼•ï¼ŒæŒ‡å‘åŸæ¥çš„ä¸‹ä¸€æ¡ï¼‰\n                    # åªæœ‰å½“åˆ é™¤çš„æ˜¯æœ€åä¸€æ¡æ—¶ï¼Œæ‰éœ€è¦è°ƒæ•´ç´¢å¼•\n                    if self.current_index >= len(self.video_list):\n                        self.current_index = len(self.video_list) - 1\n                    \n                    # æ›´æ–° video_data åˆ°æ–°çš„å½“å‰è®°å½•\n                    self.video_data = self.video_list[self.current_index]\n                    self.load_video()\n                    self.update_navigation_buttons()\n                else:\n                    # åªå‰©ä¸€æ¡è®°å½•ï¼Œå…³é—­å¯¹è¯æ¡†\n                    self.accept()\n            else:\n                self.show_copy_toast(\"åˆ é™¤å¤±è´¥\")\n        except Exception as e:\n            from utils.logger import logger\n            logger.error(f\"åˆ é™¤è§†é¢‘è®°å½•å¼‚å¸¸: {e}\")\n            self.show_copy_toast(f\"åˆ é™¤å¤±è´¥: {str(e)}\")\n\n    def download_video(self):\n        \"\"\"ä¸‹è½½è§†é¢‘åˆ°æŒ‡å®šä½ç½®\"\"\"\n        video_path = self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')\n        if not video_path or not os.path.exists(video_path):\n            self.show_styled_message(\"é”™è¯¯\", \"è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨\", \"warning\")\n            return\n        \n        file_dialog = QFileDialog()\n        save_path, _ = file_dialog.getSaveFileName(\n            self,\n            \"ä¿å­˜è§†é¢‘\",\n            f\"video_{datetime.now().strftime('%Y%m%d_%H%M%S')}.mp4\",\n            \"è§†é¢‘æ–‡ä»¶ (*.mp4)\"\n        )\n        \n        if save_path:\n            try:\n                import shutil\n                shutil.copy2(video_path, save_path)\n                self.show_copy_toast(f\"è§†é¢‘å·²ä¿å­˜åˆ°: {os.path.basename(save_path)}\")\n            except Exception as e:\n                self.show_styled_message(\"é”™è¯¯\", f\"ä¿å­˜è§†é¢‘å¤±è´¥: {str(e)}\", \"critical\")\n    \n    def update_navigation_buttons(self):\n        \"\"\"æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€ï¼ˆåŸºäºæœ‰æ•ˆè®°å½•æ£€æŸ¥ï¼‰\"\"\"\n        logger.debug(f\"[NAV] æ›´æ–°å¯¼èˆªæŒ‰é’®ï¼šå½“å‰ç´¢å¼•{self.current_index}ï¼Œæ€»è®°å½•æ•°{len(self.video_list)}\")\n        \n        has_prev = self._has_valid_previous_record()\n        has_next = self._has_valid_next_record()\n        \n        logger.debug(f\"[NAV] æœ‰æ•ˆè®°å½•æ£€æŸ¥ï¼šprev={has_prev}, next={has_next}\")\n        \n        self.prev_btn.setEnabled(has_prev)\n        self.next_btn.setEnabled(has_next)\n    \n    def _has_valid_previous_record(self):\n        \"\"\"æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ä¸Šä¸€ä¸ªè®°å½•\"\"\"\n        logger.debug(f\"[NAV] æ£€æŸ¥ä¸Šä¸€ä¸ªè®°å½•ï¼šä»ç´¢å¼•{self.current_index - 1}åˆ°0\")\n        for i in range(self.current_index - 1, -1, -1):\n            candidate_data = self.video_list[i]\n            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n            content_type = candidate_data.get('content_type', '')\n            \n            # æ£€æŸ¥æ–‡ä»¶æ‰©å±•åï¼Œç¡®ä¿æ˜¯è§†é¢‘æ–‡ä»¶\n            is_video = False\n            if file_path:\n                from pathlib import Path\n                file_ext = Path(file_path).suffix.lower()\n                is_video = file_ext in ['.mp4', '.avi', '.mov', '.mkv', '.webm']\n            \n            logger.debug(f\"[NAV] æ£€æŸ¥ç´¢å¼•{i}: file_path={file_path}, content_type={content_type}, is_video={is_video}, exists={os.path.exists(file_path) if file_path else False}\")\n            \n            if file_path and os.path.exists(file_path) and is_video:\n                logger.debug(f\"[NAV] æ‰¾åˆ°æœ‰æ•ˆçš„ä¸Šä¸€ä¸ªè§†é¢‘è®°å½•ï¼šç´¢å¼•{i}\")\n                return True\n        logger.debug(f\"[NAV] æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä¸Šä¸€ä¸ªè§†é¢‘è®°å½•\")\n        return False\n    \n    def _has_valid_next_record(self):\n        \"\"\"æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ä¸‹ä¸€ä¸ªè®°å½•\"\"\"\n        logger.debug(f\"[NAV] æ£€æŸ¥ä¸‹ä¸€ä¸ªè®°å½•ï¼šä»ç´¢å¼•{self.current_index + 1}åˆ°{len(self.video_list) - 1}\")\n        for i in range(self.current_index + 1, len(self.video_list)):\n            candidate_data = self.video_list[i]\n            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n            content_type = candidate_data.get('content_type', '')\n            \n            # æ£€æŸ¥æ–‡ä»¶æ‰©å±•åï¼Œç¡®ä¿æ˜¯è§†é¢‘æ–‡ä»¶\n            is_video = False\n            if file_path:\n                from pathlib import Path\n                file_ext = Path(file_path).suffix.lower()\n                is_video = file_ext in ['.mp4', '.avi', '.mov', '.mkv', '.webm']\n            \n            logger.debug(f\"[NAV] æ£€æŸ¥ç´¢å¼•{i}: file_path={file_path}, content_type={content_type}, is_video={is_video}, exists={os.path.exists(file_path) if file_path else False}\")\n            \n            if file_path and os.path.exists(file_path) and is_video:\n                logger.debug(f\"[NAV] æ‰¾åˆ°æœ‰æ•ˆçš„ä¸‹ä¸€ä¸ªè§†é¢‘è®°å½•ï¼šç´¢å¼•{i}\")\n                return True\n        logger.debug(f\"[NAV] æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä¸‹ä¸€ä¸ªè§†é¢‘è®°å½•\")\n        return False\n    \n    def show_previous_video(self):\n        \"\"\"æ˜¾ç¤ºä¸Šä¸€ä¸ªè§†é¢‘ï¼ˆå¸¦æœ‰æ•ˆæ€§éªŒè¯ï¼‰\"\"\"\n        # å¯»æ‰¾ä¸Šä¸€ä¸ªæœ‰æ•ˆè§†é¢‘è®°å½•\n        for i in range(self.current_index - 1, -1, -1):\n            candidate_data = self.video_list[i]\n            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n            \n            # æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘æ–‡ä»¶\n            is_video = False\n            if file_path:\n                from pathlib import Path\n                file_ext = Path(file_path).suffix.lower()\n                is_video = file_ext in ['.mp4', '.avi', '.mov', '.mkv', '.webm']\n            \n            if file_path and os.path.exists(file_path) and is_video:\n                # æ‰¾åˆ°æœ‰æ•ˆè§†é¢‘è®°å½•\n                logger.debug(f\"[NAV] åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªè§†é¢‘ï¼šç´¢å¼•{i}\")\n                self.current_index = i\n                self.video_data = self.video_list[i]\n                self.load_video()\n                self.update_navigation_buttons()\n                return\n        \n        # æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä¸Šä¸€ä¸ªè§†é¢‘è®°å½•ï¼Œä¿æŒå½“å‰çŠ¶æ€\n        logger.debug(f\"[NAV] æ²¡æœ‰ä¸Šä¸€ä¸ªè§†é¢‘å¯åˆ‡æ¢\")\n        self.update_navigation_buttons()\n    \n    def show_next_video(self):\n        \"\"\"æ˜¾ç¤ºä¸‹ä¸€ä¸ªè§†é¢‘ï¼ˆå¸¦æœ‰æ•ˆæ€§éªŒè¯ï¼‰\"\"\"\n        # å¯»æ‰¾ä¸‹ä¸€ä¸ªæœ‰æ•ˆè§†é¢‘è®°å½•\n        for i in range(self.current_index + 1, len(self.video_list)):\n            candidate_data = self.video_list[i]\n            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n            \n            # æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘æ–‡ä»¶\n            is_video = False\n            if file_path:\n                from pathlib import Path\n                file_ext = Path(file_path).suffix.lower()\n                is_video = file_ext in ['.mp4', '.avi', '.mov', '.mkv', '.webm']\n            \n            if file_path and os.path.exists(file_path) and is_video:\n                # æ‰¾åˆ°æœ‰æ•ˆè§†é¢‘è®°å½•\n                logger.debug(f\"[NAV] åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè§†é¢‘ï¼šç´¢å¼•{i}\")\n                self.current_index = i\n                self.video_data = self.video_list[i]\n                self.load_video()\n                self.update_navigation_buttons()\n                return\n        \n        # æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä¸‹ä¸€ä¸ªè§†é¢‘è®°å½•ï¼Œä¿æŒå½“å‰çŠ¶æ€\n        logger.debug(f\"[NAV] æ²¡æœ‰ä¸‹ä¸€ä¸ªè§†é¢‘å¯åˆ‡æ¢\")\n        self.update_navigation_buttons()\n    \n    def load_video(self):\n        \"\"\"åŠ è½½æ–°è§†é¢‘\"\"\"\n        logger.debug(\"[UI] åŠ è½½æ–°è§†é¢‘â€¦\")\n        \n        # åœæ­¢å½“å‰æ’­æ”¾å™¨\n        if hasattr(self, 'media_player') and self.media_player:\n            self.media_player.stop()\n        \n        video_path = self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')\n        if video_path and os.path.exists(video_path):\n            from PySide6.QtCore import QUrl\n            if hasattr(self, 'media_player') and self.media_player:\n                self.media_player.setSource(QUrl.fromLocalFile(video_path))\n            \n            # é‡ç½®åˆ°ç¼©ç•¥å›¾æ¨¡å¼\n            self.video_stack.setCurrentIndex(0)\n            self.is_playing = False\n            \n            # é‡æ–°åŠ è½½ç¼©ç•¥å›¾\n            self.load_thumbnail()\n            \n            # æ›´æ–°å³ä¾§ä¿¡æ¯\n            prompt_content = self.video_data.get('prompt', 'æ— æç¤ºè¯')\n            self.prompt_text_edit.setPlainText(prompt_content)\n            \n            # æ›´æ–°å‚æ•°ä¿¡æ¯\n            self.update_video_params()\n            \n            logger.debug(\"[UI] æ–°è§†é¢‘åŠ è½½å®Œæˆ\")\n        else:\n            self.video_stack.setCurrentIndex(0)\n            self.is_playing = False\n\n        self._refresh_reference_gallery()\n        self._export_controller.refresh()\n    \n    def _update_theme(self):\n        \"\"\"å“åº”ä¸»é¢˜å˜åŒ–\"\"\"\n        colors = unified_style_system.get_colors()\n        \n        # Apply theme to self (Dialog)\n        # Note: In some OS/Qt versions, QDialog styling needs explicit background\n        bg_color = colors.get('palette.neutral.bg_surface') or colors.get('palette.neutral.bg_app') or colors.get('background')\n        text_color = colors.get('text') or colors.get('palette.text.primary')\n        bg_card = colors.get('palette.neutral.bg_card') or colors.get('surface') or bg_color\n        bg_input = colors.get('palette.neutral.bg_input') or colors.get('palette.neutral.bg_card') or bg_card\n        border_subtle = colors.get('palette.neutral.border_subtle') or colors.get('border')\n        brand = colors.get('palette.brand.main') or colors.get('primary') or text_color\n        \n        self.setStyleSheet(f\"\"\"\n            QDialog {{\n                background-color: {bg_color};\n                color: {text_color};\n            }}\n            QLabel {{\n                color: {text_color};\n            }}\n            QWidget#ParamsWidget {{\n                 background-color: {bg_card};\n                 border-left: 1px solid {border_subtle};\n            }}\n        \"\"\")\n        \n        # Update specific controls directly\n        if hasattr(self, 'prompt_text_edit'):\n             self.prompt_text_edit.setStyleSheet(f\"\"\"\n                QTextEdit {{\n                    background-color: {bg_input};\n                    color: {text_color};\n                    border: 1px solid {border_subtle};\n                    border-radius: 8px;\n                    padding: 8px;\n                }}\n                QTextEdit:focus {{\n                    border-color: {brand};\n                }}\n             \"\"\")\n\n        # Manually update param labels that were stored\n        if hasattr(self, 'param_value_labels'):\n            for label, value_label in self.param_value_labels.items():\n                value_label.setStyleSheet(f\"\"\"\n                    QLineEdit {{\n                        background-color: {bg_input};\n                        color: {text_color};\n                        border: 1px solid {border_subtle};\n                        padding: 4px;\n                        border-radius: 8px;\n                    }}\n                    QLineEdit:focus {{\n                        border-color: {brand};\n                    }}\n                \"\"\")\n\n        # Update thumbnail background if visible\n        if hasattr(self, 'thumbnail_label'):\n             player_bg = colors.get('palette.component.player_bg') or bg_color\n             self.thumbnail_label.setStyleSheet(f\"\"\"\n                QLabel {{\n                    border: none;\n                    background-color: {player_bg};\n                    color: {text_color};\n                }}\n             \"\"\")\n\n        # Reapply button styles\n        if hasattr(self, 'fullscreen_btn'):\n            unified_style_system.apply_to_widget(self.fullscreen_btn)\n        if hasattr(self, 'download_btn'):\n            unified_style_system.apply_to_widget(self.download_btn)\n        if hasattr(self, 'delete_btn'):\n            unified_style_system.apply_to_widget(self.delete_btn, extra={'variant': 'danger'})\n        if hasattr(self, 'close_btn'):\n            unified_style_system.apply_to_widget(self.close_btn)\n        if hasattr(self, 'reference_export_btn'):\n            unified_style_system.apply_to_widget(self.reference_export_btn)\n        if hasattr(self, 'export_bundle_btn'):\n            unified_style_system.apply_to_widget(self.export_bundle_btn)\n        if hasattr(self, 'play_button'):\n            unified_style_system.apply_to_widget(self.play_button)\n        if hasattr(self, 'prev_btn'):\n            unified_style_system.apply_to_widget(self.prev_btn)\n        if hasattr(self, 'next_btn'):\n            unified_style_system.apply_to_widget(self.next_btn)\n\n    def update_video_params(self):\n        \"\"\"æ›´æ–°è§†é¢‘å‚æ•°æ˜¾ç¤ºï¼ˆåˆ‡æ¢è§†é¢‘æ—¶è°ƒç”¨ï¼‰\"\"\"\n        try:\n            # è§£æç”Ÿæˆå‚æ•°\n            params = self.video_data.get('parameters', '{}')\n            if isinstance(params, str):\n                try:\n                    params = json.loads(params)\n                except:\n                    params = {}\n\n            # ä» parameters ä¸­è·å–å‚æ•°ï¼ˆå…¼å®¹é¡¶çº§å­—æ®µï¼‰\n            duration = params.get('duration') or self.video_data.get('duration', 'æœªçŸ¥')\n            file_size = params.get('file_size') or self.video_data.get('file_size', 0)\n\n            # é‡æ–°æ„å»ºå‚æ•°ä¿¡æ¯\n            info_items = [\n                (\"åˆ†è¾¨ç‡\", build_resolution_text(self.video_data)),\n                (\"æ—¶é•¿\", f\"{duration}ç§’\"),\n                (\"æ¨¡å‹\", get_model_display_name(pick_model_code(self.video_data))),\n                (\"ç”Ÿæˆæ—¶é—´\", self.format_time(self.video_data.get('created_at', ''))),\n                (\"æ–‡ä»¶å¤§å°\", self.format_file_size(file_size)),\n                (\"æ–‡ä»¶è·¯å¾„\", self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')),\n            ]\n            \n            # æ›´æ–°å·²ä¿å­˜çš„æ ‡ç­¾\n            for label, new_value in info_items:\n                if label in self.param_value_labels:\n                    self.param_value_labels[label].setText(str(new_value))\n            \n            logger.debug(\"è§†é¢‘å‚æ•°å·²æ›´æ–°\")\n            \n        except Exception as e:\n            logger.error(f\"æ›´æ–°è§†é¢‘å‚æ•°å¤±è´¥: {e}\")\n    \n    def update_param_labels(self):\n        \"\"\"æ›´æ–°å‚æ•°æ ‡ç­¾å†…å®¹\"\"\"\n        try:\n            # ä» parameters ä¸­è·å–å‚æ•°ï¼ˆå…¼å®¹é¡¶çº§å­—æ®µï¼‰\n            params = self.video_data.get('parameters', {}) or {}\n            duration = params.get('duration') or self.video_data.get('duration', 'æœªçŸ¥')\n            file_size = params.get('file_size') or self.video_data.get('file_size', 0)\n\n            # æ›´æ–°å„ä¸ªå‚æ•°æ ‡ç­¾\n            param_updates = {\n                \"åˆ†è¾¨ç‡\": build_resolution_text(self.video_data),\n                \"æ—¶é•¿\": f\"{duration}ç§’\",\n                \"æ¨¡å‹\": get_model_display_name(pick_model_code(self.video_data)),\n                \"ç”Ÿæˆæ—¶é—´\": self.format_time(self.video_data.get('created_at', '')),\n                \"æ–‡ä»¶å¤§å°\": self.format_file_size(file_size),\n                \"æ–‡ä»¶è·¯å¾„\": self.video_data.get('absolute_path', '') or self.video_data.get('file_path', '')\n            }\n            \n            for param_name, new_value in param_updates.items():\n                if param_name in self.param_labels:\n                    self.param_labels[param_name].setText(str(new_value))\n                    logger.debug(f\"å·²æ›´æ–°å‚æ•° {param_name}: {new_value}\")\n            \n            logger.debug(\"è§†é¢‘å‚æ•°æ ‡ç­¾æ›´æ–°å®Œæˆ\")\n        except Exception as e:\n            logger.error(f\"æ›´æ–°è§†é¢‘å‚æ•°æ ‡ç­¾å¤±è´¥: {e}\")\n    \n    def show_styled_message(self, title: str, message: str, icon_type: str = \"information\"):\n        \"\"\"æ˜¾ç¤ºå¸¦æœ‰æ·±è‰²ä¸»é¢˜æ ·å¼çš„æ¶ˆæ¯æ¡†\"\"\"\n        from PySide6.QtWidgets import QMessageBox\n        \n        msg_box = QMessageBox(self)\n        msg_box.setWindowTitle(title)\n        msg_box.setText(message)\n        \n        # è®¾ç½®å›¾æ ‡\n        if icon_type == \"warning\":\n            msg_box.setIcon(QMessageBox.Warning)\n        elif icon_type == \"critical\":\n            msg_box.setIcon(QMessageBox.Critical)\n        elif icon_type == \"question\":\n            msg_box.setIcon(QMessageBox.Question)\n        else:\n            msg_box.setIcon(QMessageBox.Information)\n        \n        # æ ·å¼ç”±å…¨å±€QSSæ§åˆ¶\n        \n        msg_box.exec()\n","numLines":1332,"startLine":1,"totalLines":1332}}}
{"parentUuid":"0aa92f95-dacd-46e8-953e-42dd3f1ef4ad","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"831827d4-8f64-40eb-a2ca-946ae836d86c","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"a7727ab","slug":"smooth-dazzling-bear","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BPgKF3vdYGiHtW3iL2dfYc","type":"tool_result","content":"     1â†’import os\n     2â†’import json\n     3â†’from datetime import datetime\n     4â†’from typing import Dict, Any, List, Optional\n     5â†’\n     6â†’from PySide6.QtWidgets import (\n     7â†’    QDialog, QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton,\n     8â†’    QTextEdit, QFileDialog, QMessageBox, QSplitter, QApplication,\n     9â†’    QMenu, QSizePolicy\n    10â†’)\n    11â†’from PySide6.QtGui import QAction, QShortcut\n    12â†’from PySide6.QtCore import Qt, QTimer, QSize, QEvent\n    13â†’from PySide6.QtGui import QPixmap, QKeySequence\n    14â†’\n    15â†’from utils.logger import logger\n    16â†’from utils.style_system import unified_style_system\n    17â†’from components.widgets import ZoomableImageLabel, ClickableLabel\n    18â†’from components.reference_assets import (\n    19â†’    ReferenceGalleryWidget,\n    20â†’    export_reference_asset,\n    21â†’    open_reference_preview,\n    22â†’    _find_reference_asset_index,\n    23â†’)\n    24â†’from components.controllers import ExportBundleController\n    25â†’from utils.reference_display import ensure_reference_info, resolve_reference_assets\n    26â†’from PySide6.QtCore import Signal\n    27â†’\n    28â†’class ImageDetailDialog(QDialog):\n    29â†’    \"\"\"å›¾ç‰‡è¯¦ç»†ä¿¡æ¯å¯¹è¯æ¡†\"\"\"\n    30â†’    \n    31â†’    # åˆ é™¤è®°å½•åå‘å‡ºä¿¡å·ï¼Œé€šçŸ¥çˆ¶è§†å›¾åˆ·æ–°\n    32â†’    recordDeleted = Signal(str)  # å‚æ•°ä¸ºè¢«åˆ é™¤çš„è®°å½•ID\n    33â†’    \n    34â†’    def __init__(self, image_data: Dict[str, Any], image_list: List[Dict[str, Any]] = None, current_index: int = 0, parent=None):\n    35â†’        super().__init__(parent)\n    36â†’        self.image_data = image_data\n    37â†’        self.image_list = image_list or [image_data]  # å›¾ç‰‡åˆ—è¡¨\n    38â†’        self.current_index = current_index  # å½“å‰å›¾ç‰‡ç´¢å¼•\n    39â†’        self.zoom_factor = 1.0  # ç¼©æ”¾å› å­\n    40â†’        self.is_fullscreen = False  # å…¨å±çŠ¶æ€\n    41â†’        self.original_geometry = None  # åŸå§‹çª—å£å‡ ä½•\n    42â†’        self._reference_summary = ensure_reference_info(self.image_data)\n    43â†’        self._reference_assets: List[Dict[str, Any]] = []\n    44â†’        self._export_controller = ExportBundleController(self, \"image\")\n    45â†’        \n    46â†’        # Subscribe to theme changes\n    47â†’        unified_style_system.styleChanged.connect(self._update_theme)\n    48â†’        \n    49â†’        self.setup_ui()\n    50â†’        \n    51â†’    def setup_ui(self):\n    52â†’        \"\"\"è®¾ç½®UI\"\"\"\n    53â†’        self.setWindowTitle(\"å›¾ç‰‡è¯¦ç»†ä¿¡æ¯\")\n    54â†’        self.resize(1100, 800)  # æ”¹ä¸ºå¯è°ƒæ•´å¤§å°\n    55â†’        self.setMinimumSize(800, 600)  # è®¾ç½®æœ€å°å°ºå¯¸\n    56â†’        \n    57â†’        # è®¾ç½®ç„¦ç‚¹ç­–ç•¥ï¼Œç¡®ä¿èƒ½æ¥æ”¶é”®ç›˜äº‹ä»¶\n    58â†’        self.setFocusPolicy(Qt.StrongFocus)\n    59â†’        self.setAttribute(Qt.WA_KeyCompression, False)  # ç¦ç”¨é”®ç›˜äº‹ä»¶å‹ç¼©\n    60â†’        self.setFocus()\n    61â†’\n    62â†’        # ç¡®ä¿çª—å£æ¿€æ´»æ—¶è·å¾—ç„¦ç‚¹\n    63â†’        self.activateWindow()\n    64â†’        self.raise_()\n    65â†’\n    66â†’        try:\n    67â†’            self.setObjectName(\"DetailDialog\")\n    68â†’        except Exception:\n    69â†’            pass\n    70â†’\n    71â†’        self._focus_timer = QTimer(self)\n    72â†’        self._focus_timer.setSingleShot(True)\n    73â†’        self._focus_timer.timeout.connect(self._ensure_focus)\n    74â†’\n    75â†’        layout = QHBoxLayout(self)\n    76â†’        \n    77â†’        # å·¦ä¾§ï¼šå¤§å›¾æ˜¾ç¤ºï¼ˆå 70%å®½åº¦ï¼‰\n    78â†’        left_widget = QWidget()\n    79â†’        left_layout = QVBoxLayout(left_widget)\n    80â†’        left_layout.setContentsMargins(0, 0, 0, 0)\n    81â†’        \n    82â†’        # å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸï¼ˆå æ®ä¸Šæ–¹å…¨éƒ¨ç©ºé—´ï¼‰\n    83â†’        image_container = QWidget()\n    84â†’        image_container.setObjectName(\"ImageContainer\")\n    85â†’        image_container.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)\n    86â†’\n    87â†’        # åœ¨å®¹å™¨å†…åˆ›å»ºå¸ƒå±€\n    88â†’        container_layout = QVBoxLayout(image_container)\n    89â†’        container_layout.setContentsMargins(0, 0, 0, 0)\n    90â†’        container_layout.setSpacing(0)\n    91â†’\n    92â†’        # ä½¿ç”¨å¯ç¼©æ”¾çš„å›¾ç‰‡æ ‡ç­¾ï¼Œè‡ªé€‚åº”å®¹å™¨å¤§å°\n    93â†’        self.large_image_label = ZoomableImageLabel()\n    94â†’        self.large_image_label.setAlignment(Qt.AlignCenter)\n    95â†’        self.large_image_label.setStyleSheet(\"border: none; background-color: transparent;\")\n    96â†’        \n    97â†’        # è®¾ç½®å³é”®èœå•\n    98â†’        self.large_image_label.setContextMenuPolicy(Qt.CustomContextMenu)\n    99â†’        self.large_image_label.customContextMenuRequested.connect(self.show_context_menu)\n   100â†’        \n   101â†’        # åŠ è½½å¤§å›¾\n   102â†’        image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')\n   103â†’        if image_path and os.path.exists(image_path):\n   104â†’            pixmap = QPixmap(image_path)\n   105â†’            if not pixmap.isNull():\n   106â†’                self.large_image_label.setPixmap(pixmap)\n   107â†’        \n   108â†’        container_layout.addWidget(self.large_image_label, 1)\n   109â†’\n   110â†’        reference_section = QWidget()\n   111â†’        reference_section.setObjectName(\"ReferenceSection\")\n   112â†’        reference_section.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)\n   113â†’        reference_section_layout = QVBoxLayout(reference_section)\n   114â†’        reference_section_layout.setContentsMargins(0, 0, 0, 0)\n   115â†’        reference_section_layout.setSpacing(8)\n   116â†’\n   117â†’        self.reference_gallery = ReferenceGalleryWidget()\n   118â†’        self.reference_gallery.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)\n   119â†’        try:\n   120â†’            self.reference_gallery.referenceClicked.connect(self._on_reference_clicked)\n   121â†’            self.reference_gallery.exportRequested.connect(self._on_reference_export)\n   122â†’            self.reference_gallery.selectionChanged.connect(self._on_reference_selection_changed)\n   123â†’        except Exception:\n   124â†’            pass\n   125â†’        reference_section_layout.addWidget(self.reference_gallery, 1)\n   126â†’\n   127â†’        reference_button_layout = QHBoxLayout()\n   128â†’        reference_button_layout.setContentsMargins(0, 0, 0, 0)\n   129â†’        reference_button_layout.setSpacing(6)\n   130â†’        self.export_status_label = QLabel(\"\")\n   131â†’        self.export_status_label.setObjectName(\"infoLabel\")\n   132â†’        unified_style_system.apply_to_widget(self.export_status_label)\n   133â†’        reference_button_layout.addWidget(self.export_status_label)\n   134â†’        reference_button_layout.addStretch(1)\n   135â†’        self.reference_export_btn = QPushButton(\"å¯¼å‡ºé€‰ä¸­å‚è€ƒå›¾\")\n   136â†’        self.reference_export_btn.setObjectName(\"SecondaryButton\")\n   137â†’        self.reference_export_btn.setEnabled(False)\n   138â†’        unified_style_system.apply_to_widget(self.reference_export_btn)\n   139â†’        self.reference_export_btn.clicked.connect(self._export_selected_reference)\n   140â†’        reference_button_layout.addWidget(self.reference_export_btn)\n   141â†’        self.export_bundle_btn = QPushButton(\"å¯¼å‡ºè®°å½•\")\n   142â†’        self.export_bundle_btn.setObjectName(\"SecondaryButton\")\n   143â†’        self.export_bundle_btn.setEnabled(False)\n   144â†’        unified_style_system.apply_to_widget(self.export_bundle_btn)\n   145â†’        self._export_controller.configure(\n   146â†’            self.export_bundle_btn,\n   147â†’            self.export_status_label,\n   148â†’            self._resolve_record_id,\n   149â†’            context_widget=self,\n   150â†’        )\n   151â†’        reference_button_layout.addWidget(self.export_bundle_btn)\n   152â†’        reference_section_layout.addLayout(reference_button_layout)\n   153â†’\n   154â†’        self._image_reference_splitter = QSplitter(Qt.Vertical)\n   155â†’        self._image_reference_splitter.setObjectName(\"ImageReferenceSplitter\")\n   156â†’        self._image_reference_splitter.setChildrenCollapsible(False)\n   157â†’        self._image_reference_splitter.setHandleWidth(6)\n   158â†’        self._image_reference_splitter.addWidget(image_container)\n   159â†’        self._image_reference_splitter.addWidget(reference_section)\n   160â†’        self._image_reference_splitter.setStretchFactor(0, 3)\n   161â†’        self._image_reference_splitter.setStretchFactor(1, 2)\n   162â†’        self._image_reference_splitter.setSizes([520, 280])\n   163â†’\n   164â†’        left_layout.addWidget(self._image_reference_splitter, 1)\n   165â†’\n   166â†’        # åº•éƒ¨åŒºåŸŸï¼šå¯¼èˆªæŒ‰é’® + è¯´æ˜æ–‡æœ¬æ¡†ï¼ˆä¸å³ä¾§å‚æ•°æ é«˜åº¦å¯¹é½ï¼‰\n   167â†’        bottom_layout = QHBoxLayout()\n   168â†’        bottom_layout.setContentsMargins(0, 5, 0, 5)\n   169â†’        bottom_layout.setSpacing(10)\n   170â†’        \n   171â†’        # å‘å·¦æŒ‰é’®\n   172â†’        self.prev_btn = QPushButton(\"â—€\")\n   173â†’        self.prev_btn.setFixedSize(30, 30)  # å›ºå®šå°ºå¯¸\n   174â†’        self.prev_btn.setObjectName(\"NavButton\")\n   175â†’        unified_style_system.apply_to_widget(self.prev_btn)\n   176â†’        self.prev_btn.clicked.connect(self.show_previous_image)\n   177â†’        bottom_layout.addWidget(self.prev_btn)\n   178â†’        \n   179â†’        # ä¸­é—´çš„è¯´æ˜æ–‡æœ¬æ¡†ï¼ˆå®Œå…¨é€æ˜è®¾è®¡ï¼‰\n   180â†’        zoom_info = QLabel(\"æç¤ºï¼šé¼ æ ‡ä½ç½®ç¼©æ”¾ï¼Œç‚¹å‡»æ‹–æ‹½ï¼ŒåŒå‡»é‡ç½®\")\n   181â†’        zoom_info.setObjectName(\"infoLabel\")\n   182â†’        unified_style_system.apply_to_widget(zoom_info)\n   183â†’        zoom_info.setAlignment(Qt.AlignCenter)\n   184â†’        zoom_info.setMinimumHeight(30)  # ä¸æŒ‰é’®é«˜åº¦ä¸€è‡´\n   185â†’        zoom_info.setMaximumHeight(30)  # å›ºå®šé«˜åº¦ï¼Œé˜²æ­¢æ–‡å­—è¢«å‹ç¼©\n   186â†’        bottom_layout.addWidget(zoom_info, 1)  # å æ®ä¸­é—´æ‰€æœ‰ç©ºé—´\n   187â†’        \n   188â†’        # å‘å³æŒ‰é’®\n   189â†’        self.next_btn = QPushButton(\"â–¶\")\n   190â†’        self.next_btn.setFixedSize(30, 30)  # å›ºå®šå°ºå¯¸\n   191â†’        self.next_btn.setObjectName(\"NavButton\")\n   192â†’        unified_style_system.apply_to_widget(self.next_btn)\n   193â†’        self.next_btn.clicked.connect(self.show_next_image)\n   194â†’        bottom_layout.addWidget(self.next_btn)\n   195â†’        \n   196â†’        left_layout.addLayout(bottom_layout)\n   197â†’\n   198â†’        # æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€\n   199â†’        self.update_navigation_buttons()\n   200â†’        self._refresh_reference_gallery()\n   201â†’        self._export_controller.refresh()\n   202â†’\n   203â†’        # å³ä¾§ï¼šè¯¦ç»†ä¿¡æ¯ï¼ˆå›ºå®š30%å®½åº¦ï¼‰\n   204â†’        right_layout = QVBoxLayout()\n   205â†’        \n   206â†’        # åˆ›å»ºå‚æ•°æ˜¾ç¤ºåŒºåŸŸï¼ˆä¸ä½¿ç”¨æ»šåŠ¨æ¡ï¼‰\n   207â†’        params_widget = QWidget()\n   208â†’        params_widget.setFixedWidth(int(self.width() * 0.3))  # å›ºå®š30%å®½åº¦\n   209â†’        params_widget.setObjectName(\"ParamsWidget\")\n   210â†’        self.params_layout = QVBoxLayout(params_widget)  # ä¿å­˜å¼•ç”¨ä»¥ä¾¿åç»­æ›´æ–°\n   211â†’        self.params_layout.setSpacing(0)  # è®¾ç½®é—´è·ä¸º0\n   212â†’        self.params_layout.setContentsMargins(5, 5, 5, 5)  # è®¾ç½®ç´§å‡‘çš„è¾¹è·\n   213â†’        \n   214â†’        # åˆå§‹åŒ–å‚æ•°æ˜¾ç¤ºåŒºåŸŸ\n   215â†’        self.setup_params_area()\n   216â†’        \n   217â†’        \n   218â†’        right_layout.addWidget(params_widget)\n   219â†’        \n   220â†’        # å…¨å±å’Œå¤åˆ¶å›¾ç‰‡æŒ‰é’®ï¼ˆä¸å‚æ•°åŒºåº•éƒ¨å¯¹é½ï¼‰\n   221â†’        image_control_layout = QHBoxLayout()\n   222â†’\n   223â†’        self.fullscreen_btn = QPushButton(\"å…¨å± (F11)\")\n   224â†’        self.fullscreen_btn.setMaximumHeight(30)\n   225â†’        unified_style_system.apply_to_widget(self.fullscreen_btn)\n   226â†’        self.fullscreen_btn.clicked.connect(self.toggle_fullscreen)\n   227â†’        image_control_layout.addWidget(self.fullscreen_btn)\n   228â†’\n   229â†’        self.copy_image_btn = QPushButton(\"å¤åˆ¶å›¾ç‰‡\")\n   230â†’        self.copy_image_btn.setMaximumHeight(30)\n   231â†’        unified_style_system.apply_to_widget(self.copy_image_btn)\n   232â†’        self.copy_image_btn.clicked.connect(self.copy_image)\n   233â†’        image_control_layout.addWidget(self.copy_image_btn)\n   234â†’\n   235â†’        right_layout.addLayout(image_control_layout)\n   236â†’\n   237â†’        # å…¶ä»–æŒ‰é’®\n   238â†’        button_layout = QHBoxLayout()\n   239â†’\n   240â†’        self.delete_btn = QPushButton(\"åˆ é™¤è®°å½•\")\n   241â†’        unified_style_system.apply_to_widget(self.delete_btn, extra={'variant': 'danger'})\n   242â†’        self.delete_btn.clicked.connect(self._delete_current_record)\n   243â†’        button_layout.addWidget(self.delete_btn)\n   244â†’\n   245â†’        self.close_btn = QPushButton(\"å…³é—­ï¼ˆESCï¼‰\")\n   246â†’        unified_style_system.apply_to_widget(self.close_btn)\n   247â†’        self.close_btn.clicked.connect(self.accept)\n   248â†’        button_layout.addWidget(self.close_btn)\n   249â†’        \n   250â†’        right_layout.addLayout(button_layout)\n   251â†’        \n   252â†’        # è®¾ç½®å¸ƒå±€æ¯”ä¾‹ï¼šå·¦ä¾§70%ï¼Œå³ä¾§30%\n   253â†’        layout.addWidget(left_widget, 7)\n   254â†’        layout.addLayout(right_layout, 3)\n   255â†’        \n   256â†’        # æ·»åŠ é”®ç›˜å¿«æ·é”®\n   257â†’        self.setup_shortcuts()\n   258â†’\n   259â†’        # å»¶è¿Ÿè®¾ç½®ç„¦ç‚¹ï¼Œç¡®ä¿çª—å£å®Œå…¨åˆå§‹åŒ–åè·å¾—ç„¦ç‚¹\n   260â†’        self._focus_timer.start(100)\n   261â†’\n   262â†’        self._esc_shortcut = QShortcut(QKeySequence(Qt.Key_Escape), self)\n   263â†’        self._esc_shortcut.activated.connect(self.handle_escape_key)\n   264â†’        \n   265â†’        # Apply initial theme\n   266â†’        self._update_theme()\n   267â†’    \n   268â†’    def format_time(self, time_str: str) -> str:\n   269â†’        \"\"\"æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º\"\"\"\n   270â†’        if not time_str:\n   271â†’            return 'æœªçŸ¥æ—¶é—´'\n   272â†’        try:\n   273â†’            dt = datetime.fromisoformat(time_str.replace('Z', '+00:00'))\n   274â†’            return dt.strftime('%Y-%m-%d %H:%M:%S')\n   275â†’        except:\n   276â†’            return time_str[:19] if len(time_str) > 19 else time_str\n   277â†’    \n   278â†’    def format_file_size(self, size) -> str:\n   279â†’        \"\"\"æ ¼å¼åŒ–æ–‡ä»¶å¤§å°æ˜¾ç¤º\"\"\"\n   280â†’        # å¤„ç†å­—ç¬¦ä¸²ç±»å‹çš„size\n   281â†’        try:\n   282â†’            size = float(size) if size else 0\n   283â†’        except (ValueError, TypeError):\n   284â†’            return 'æœªçŸ¥å¤§å°'\n   285â†’            \n   286â†’        if size == 0:\n   287â†’            return 'æœªçŸ¥å¤§å°'\n   288â†’        \n   289â†’        for unit in ['B', 'KB', 'MB', 'GB']:\n   290â†’            if size < 1024.0:\n   291â†’                return f\"{size:.1f} {unit}\"\n   292â†’            size /= 1024.0\n   293â†’        return f\"{size:.1f} TB\"\n   294â†’    \n   295â†’    def setup_shortcuts(self):\n   296â†’        \"\"\"è®¾ç½®é”®ç›˜å¿«æ·é”®\"\"\"\n   297â†’        # ç§»é™¤æ‰€æœ‰QShortcutï¼Œç»Ÿä¸€ä½¿ç”¨keyPressEventå¤„ç†\n   298â†’        # é¿å…å¿«æ·é”®å†²çªé—®é¢˜\n   299â†’        pass\n   300â†’    \n   301â†’    def _ensure_focus(self):\n   302â†’        \"\"\"ç¡®ä¿çª—å£è·å¾—ç„¦ç‚¹\"\"\"\n   303â†’        self.activateWindow()\n   304â†’        self.raise_()\n   305â†’        self.setFocus()\n   306â†’        logger.debug(f\"[FOCUS] ImageDialogçª—å£ç„¦ç‚¹è®¾ç½®å®Œæˆï¼ŒhasFocus: {self.hasFocus()}\")\n   307â†’        \n   308â†’    def toggle_fullscreen(self):\n   309â†’        \"\"\"åˆ‡æ¢å…¨å±æ¨¡å¼\"\"\"\n   310â†’        if self.is_fullscreen:\n   311â†’            self.exit_fullscreen()\n   312â†’        else:\n   313â†’            self.enter_fullscreen()\n   314â†’            \n   315â†’    def enter_fullscreen(self):\n   316â†’        \"\"\"è¿›å…¥å…¨å±æ¨¡å¼\"\"\"\n   317â†’        if not self.is_fullscreen:\n   318â†’            self.original_geometry = self.geometry()\n   319â†’            self.showFullScreen()\n   320â†’            self.is_fullscreen = True\n   321â†’            \n   322â†’    def exit_fullscreen(self):\n   323â†’        \"\"\"é€€å‡ºå…¨å±æ¨¡å¼\"\"\"\n   324â†’        if self.is_fullscreen:\n   325â†’            self.showNormal()\n   326â†’            if self.original_geometry:\n   327â†’                self.setGeometry(self.original_geometry)\n   328â†’            self.is_fullscreen = False\n   329â†’            \n   330â†’    def handle_escape_key(self):\n   331â†’        \"\"\"å¤„ç†ESCé”®ï¼šå¦‚æœæ˜¯å…¨å±åˆ™é€€å‡ºå…¨å±ï¼Œå¦åˆ™å…³é—­å¯¹è¯æ¡†\"\"\"\n   332â†’        if self.is_fullscreen:\n   333â†’            self.exit_fullscreen()\n   334â†’        else:\n   335â†’            self.accept()  # å…³é—­å¯¹è¯æ¡†\n   336â†’            \n   337â†’    def copy_text_to_clipboard(self, text: str):\n   338â†’        \"\"\"å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿å¹¶æ˜¾ç¤ºæç¤º\"\"\"\n   339â†’        from PySide6.QtWidgets import QApplication\n   340â†’        clipboard = QApplication.clipboard()\n   341â†’        clipboard.setText(text)\n   342â†’        self.show_copy_toast(f\"å·²å¤åˆ¶: {text[:30]}...\" if len(text) > 30 else f\"å·²å¤åˆ¶: {text}\")\n   343â†’        \n   344â†’    def show_copy_toast(self, message: str):\n   345â†’        \"\"\"æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„è½»é‡æç¤º\"\"\"\n   346â†’        # åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æç¤ºæ ‡ç­¾\n   347â†’        toast = QLabel(message, self)\n   348â†’        toast.setObjectName(\"ToastLabel\")\n   349â†’        toast.setAlignment(Qt.AlignCenter)\n   350â†’        toast.adjustSize()\n   351â†’        \n   352â†’        # å®šä½åˆ°çª—å£ä¸­å¤®åä¸Š\n   353â†’        x = (self.width() - toast.width()) // 2\n   354â†’        y = self.height() // 4\n   355â†’        toast.move(x, y)\n   356â†’        toast.show()\n   357â†’        \n   358â†’        # 2ç§’åè‡ªåŠ¨éšè—\n   359â†’        QTimer.singleShot(2000, toast.deleteLater)\n   360â†’        \n   361â†’    def copy_prompt(self):\n   362â†’        \"\"\"å¤åˆ¶æç¤ºè¯åˆ°å‰ªè´´æ¿\"\"\"\n   363â†’        prompt_content = self.prompt_text_edit.toPlainText()\n   364â†’        self.copy_text_to_clipboard(prompt_content)\n   365â†’    \n   366â†’    def copy_image(self):\n   367â†’        \"\"\"å¤åˆ¶å›¾ç‰‡åˆ°å‰ªè´´æ¿\"\"\"\n   368â†’        from PySide6.QtWidgets import QApplication\n   369â†’        image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')\n   370â†’        if image_path and os.path.exists(image_path):\n   371â†’            pixmap = QPixmap(image_path)\n   372â†’            if not pixmap.isNull():\n   373â†’                clipboard = QApplication.clipboard()\n   374â†’                clipboard.setPixmap(pixmap)\n   375â†’                self.show_copy_toast(\"å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿\")\n   376â†’            else:\n   377â†’                self.show_copy_toast(\"æ— æ³•å¤åˆ¶å›¾ç‰‡\")\n   378â†’        else:\n   379â†’            self.show_copy_toast(\"å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨\")\n   380â†’    \n   381â†’    def copy_all_info(self):\n   382â†’        \"\"\"å¤åˆ¶æ‰€æœ‰ä¿¡æ¯åˆ°å‰ªè´´æ¿\"\"\"\n   383â†’        from PySide6.QtWidgets import QApplication\n   384â†’        \n   385â†’        params = self.image_data.get('parameters', '{}')\n   386â†’        if isinstance(params, str):\n   387â†’            try:\n   388â†’                params = json.loads(params)\n   389â†’            except:\n   390â†’                params = {}\n   391â†’        \n   392â†’        info_text = f\"\"\"å›¾ç‰‡è¯¦ç»†ä¿¡æ¯\n   393â†’===================\n   394â†’æç¤ºè¯: {self.image_data.get('prompt', 'æ— æç¤ºè¯')}\n   395â†’å°ºå¯¸: {params.get('size', 'æœªçŸ¥')}\n   396â†’ç§å­å€¼: {params.get('seed', 'æœªçŸ¥')}\n   397â†’å¼•å¯¼å¼ºåº¦: {params.get('guidance_scale', 'æœªçŸ¥')}\n   398â†’ç”Ÿæˆæ¨¡å‹: {params.get('model', 'æœªçŸ¥æ¨¡å‹')}\n   399â†’ç”Ÿæˆæ—¶é—´: {self.format_time(self.image_data.get('created_at', ''))}\n   400â†’æ–‡ä»¶å¤§å°: {self.format_file_size(self.image_data.get('file_size', 0))}\n   401â†’æ–‡ä»¶è·¯å¾„: {self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')}\n   402â†’\"\"\"\n   403â†’        \n   404â†’        clipboard = QApplication.clipboard()\n   405â†’        clipboard.setText(info_text)\n   406â†’        self.show_copy_toast(\"æ‰€æœ‰ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿\")\n   407â†’\n   408â†’    def show_copy_message(self, message: str):\n   409â†’        \"\"\"æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæ¶ˆæ¯ï¼ˆå·²å¼ƒç”¨ï¼Œä½¿ç”¨show_copy_toastä»£æ›¿ï¼‰\"\"\"\n   410â†’        # ç›´æ¥ä½¿ç”¨è½»é‡çº§Toastæç¤º\n   411â†’        self.show_copy_toast(message)\n   412â†’\n   413â†’    def _delete_current_record(self):\n   414â†’        \"\"\"åˆ é™¤å½“å‰è®°å½•åŠç›¸å…³æ–‡ä»¶\"\"\"\n   415â†’        record_id = self._resolve_record_id()\n   416â†’        if not record_id:\n   417â†’            self.show_copy_toast(\"æ— æ³•è·å–è®°å½•ID\")\n   418â†’            return\n   419â†’        \n   420â†’        try:\n   421â†’            # è·å– RepositoryManager\n   422â†’            from config_api import get_storage_dir\n   423â†’            from modules.repository.manager import RepositoryManager\n   424â†’            \n   425â†’            storage_dir = get_storage_dir()\n   426â†’            repo = RepositoryManager(storage_dir)\n   427â†’            \n   428â†’            # æ‰§è¡Œåˆ é™¤\n   429â†’            if repo.delete_record_with_files(record_id):\n   430â†’                self.show_copy_toast(\"è®°å½•å·²åˆ é™¤\")\n   431â†’                \n   432â†’                # å‘å‡ºä¿¡å·é€šçŸ¥çˆ¶è§†å›¾åˆ·æ–°\n   433â†’                self.recordDeleted.emit(record_id)\n   434â†’                \n   435â†’                # ä»åˆ—è¡¨ä¸­ç§»é™¤å½“å‰è®°å½•\n   436â†’                if len(self.image_list) > 1:\n   437â†’                    del self.image_list[self.current_index]\n   438â†’                    \n   439â†’                    # å¯¼èˆªåˆ°åä¸€æ¡è®°å½•ï¼ˆä¿æŒç´¢å¼•ï¼ŒæŒ‡å‘åŸæ¥çš„ä¸‹ä¸€æ¡ï¼‰\n   440â†’                    # åªæœ‰å½“åˆ é™¤çš„æ˜¯æœ€åä¸€æ¡æ—¶ï¼Œæ‰éœ€è¦è°ƒæ•´ç´¢å¼•\n   441â†’                    if self.current_index >= len(self.image_list):\n   442â†’                        self.current_index = len(self.image_list) - 1\n   443â†’                    \n   444â†’                    self.load_current_image()\n   445â†’                    self.update_navigation_buttons()\n   446â†’                else:\n   447â†’                    # åªå‰©ä¸€æ¡è®°å½•ï¼Œå…³é—­å¯¹è¯æ¡†\n   448â†’                    self.accept()\n   449â†’            else:\n   450â†’                self.show_copy_toast(\"åˆ é™¤å¤±è´¥\")\n   451â†’        except Exception as e:\n   452â†’            from utils.logger import logger\n   453â†’            logger.error(f\"åˆ é™¤è®°å½•å¼‚å¸¸: {e}\")\n   454â†’            self.show_copy_toast(f\"åˆ é™¤å¤±è´¥: {str(e)}\")\n   455â†’\n   456â†’    def _on_reference_clicked(self, asset: Dict[str, Any]):\n   457â†’        assets = list(self._reference_assets) if self._reference_assets else [asset]\n   458â†’        start_idx = _find_reference_asset_index(assets, asset)\n   459â†’        open_reference_preview(\n   460â†’            self,\n   461â†’            asset,\n   462â†’            title_prefix=\"å‚è€ƒå›¾\",\n   463â†’            asset_list=assets,\n   464â†’            start_index=start_idx,\n   465â†’            on_asset_changed=self._sync_reference_selection,\n   466â†’        )\n   467â†’\n   468â†’    def _on_reference_export(self, asset: Dict[str, Any]):\n   469â†’        export_reference_asset(self, asset)\n   470â†’\n   471â†’    def _on_reference_selection_changed(self, asset: Dict[str, Any]):\n   472â†’        asset_path = None\n   473â†’        if isinstance(asset, dict):\n   474â†’            asset_path = asset.get('absolute_path') or asset.get('path')\n   475â†’        has_path = bool(asset_path and os.path.exists(asset_path))\n   476â†’        if hasattr(self, 'reference_export_btn'):\n   477â†’            self.reference_export_btn.setEnabled(has_path)\n   478â†’\n   479â†’    def _export_selected_reference(self):\n   480â†’        asset = self.reference_gallery.current_asset() if hasattr(self, 'reference_gallery') else None\n   481â†’        if not asset:\n   482â†’            QMessageBox.information(self, \"å¯¼å‡ºå‚è€ƒå›¾\", \"è¯·å…ˆé€‰æ‹©å‚è€ƒå›¾\")\n   483â†’            return\n   484â†’        export_reference_asset(self, asset)\n   485â†’\n   486â†’    def _refresh_reference_gallery(self):\n   487â†’        if not hasattr(self, 'reference_gallery'):\n   488â†’            return\n   489â†’        self._reference_summary = ensure_reference_info(self.image_data)\n   490â†’        if self._reference_summary.get('count', 0) <= 0:\n   491â†’            self.reference_gallery.clear()\n   492â†’            self.reference_gallery.setVisible(False)\n   493â†’            if hasattr(self, 'reference_export_btn'):\n   494â†’                self.reference_export_btn.setEnabled(False)\n   495â†’            self._reference_assets = []\n   496â†’            self._export_controller.refresh()\n   497â†’            return\n   498â†’        try:\n   499â†’            self._reference_assets = resolve_reference_assets(self.image_data, absolute=True)\n   500â†’        except Exception:\n   501â†’            self._reference_assets = []\n   502â†’        self.reference_gallery.setVisible(True)\n   503â†’        self.reference_gallery.set_assets(self._reference_assets)\n   504â†’        self._on_reference_selection_changed(self.reference_gallery.current_asset())\n   505â†’        self._export_controller.refresh()\n   506â†’\n   507â†’    def _sync_reference_selection(self, asset: Dict[str, Any]):\n   508â†’        try:\n   509â†’            self.reference_gallery.select_asset(asset)\n   510â†’        except Exception:\n   511â†’            pass\n   512â†’\n   513â†’    def _resolve_record_id(self) -> Optional[str]:\n   514â†’        for key in (\"file_id\", \"id\", \"generation_id\"):\n   515â†’            value = self.image_data.get(key)\n   516â†’            if value not in (None, \"\"):\n   517â†’                return str(value)\n   518â†’        return None\n   519â†’\n   520â†’    def show_context_menu(self, position):\n   521â†’        \"\"\"æ˜¾ç¤ºå³é”®èœå•\"\"\"\n   522â†’        from PySide6.QtWidgets import QMenu\n   523â†’        from PySide6.QtGui import QAction, QShortcut\n   524â†’        \n   525â†’        menu = QMenu(self)\n   526â†’        \n   527â†’        # å¤åˆ¶å›¾ç‰‡åŠ¨ä½œ\n   528â†’        copy_action = QAction(\"å¤åˆ¶å›¾ç‰‡\", self)\n   529â†’        copy_action.triggered.connect(self.copy_image)\n   530â†’        menu.addAction(copy_action)\n   531â†’        \n   532â†’        # ä¸‹è½½å›¾ç‰‡åŠ¨ä½œ\n   533â†’        download_action = QAction(\"ä¸‹è½½å›¾ç‰‡\", self)\n   534â†’        download_action.triggered.connect(self.download_image)\n   535â†’        menu.addAction(download_action)\n   536â†’        \n   537â†’        # æ˜¾ç¤ºèœå•\n   538â†’        menu.exec(self.large_image_label.mapToGlobal(position))\n   539â†’    \n   540â†’    def download_image(self):\n   541â†’        \"\"\"ä¸‹è½½å›¾ç‰‡åˆ°æŒ‡å®šä½ç½®\"\"\"\n   542â†’        from PySide6.QtWidgets import QFileDialog, QMessageBox\n   543â†’        import shutil\n   544â†’        \n   545â†’        image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')\n   546â†’        if not image_path or not os.path.exists(image_path):\n   547â†’            self.show_styled_message(\"é”™è¯¯\", \"å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨\", \"warning\")\n   548â†’            return\n   549â†’        \n   550â†’        # è·å–åŸå§‹æ–‡ä»¶å\n   551â†’        original_filename = os.path.basename(image_path)\n   552â†’        \n   553â†’        # æ‰“å¼€ä¿å­˜å¯¹è¯æ¡†\n   554â†’        save_path, _ = QFileDialog.getSaveFileName(\n   555â†’            self,\n   556â†’            \"ä¿å­˜å›¾ç‰‡\",\n   557â†’            original_filename,\n   558â†’            \"å›¾ç‰‡æ–‡ä»¶ (*.png *.jpg *.jpeg *.bmp *.gif)\"\n   559â†’        )\n   560â†’        \n   561â†’        if save_path:\n   562â†’            try:\n   563â†’                shutil.copy2(image_path, save_path)\n   564â†’                self.show_styled_message(\"æˆåŠŸ\", f\"å›¾ç‰‡å·²ä¿å­˜åˆ°:\\n{save_path}\", \"information\")\n   565â†’            except Exception as e:\n   566â†’                self.show_styled_message(\"é”™è¯¯\", f\"ä¿å­˜å›¾ç‰‡å¤±è´¥:\\n{str(e)}\", \"critical\")\n   567â†’    \n   568â†’    def update_navigation_buttons(self):\n   569â†’        \"\"\"æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€ï¼ˆåŸºäºæœ‰æ•ˆè®°å½•æ£€æŸ¥ï¼‰\"\"\"\n   570â†’        # æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡åˆ—è¡¨\n   571â†’        if len(self.image_list) <= 1:\n   572â†’            self.prev_btn.setEnabled(False)\n   573â†’            self.next_btn.setEnabled(False)\n   574â†’            self.prev_btn.setToolTip(\"æ²¡æœ‰æ›´å¤šå›¾ç‰‡\")\n   575â†’            self.next_btn.setToolTip(\"æ²¡æœ‰æ›´å¤šå›¾ç‰‡\")\n   576â†’            return\n   577â†’        \n   578â†’        # æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆåŸºäºæœ‰æ•ˆè®°å½•æ£€æŸ¥ï¼‰\n   579â†’        self.prev_btn.setEnabled(self._has_valid_previous_record())\n   580â†’        self.next_btn.setEnabled(self._has_valid_next_record())\n   581â†’        \n   582â†’        # æ›´æ–°å·¥å…·æç¤ºæ˜¾ç¤ºå½“å‰ä½ç½®å’Œå¿«æ·é”®ä¿¡æ¯\n   583â†’        current_pos = f\"({self.current_index + 1}/{len(self.image_list)})\"\n   584â†’        self.prev_btn.setToolTip(f\"ä¸Šä¸€å¼  {current_pos} - å¿«æ·é”®: â†\")\n   585â†’        self.next_btn.setToolTip(f\"ä¸‹ä¸€å¼  {current_pos} - å¿«æ·é”®: â†’\")\n   586â†’        \n   587â†’        # æŒ‰é’®æ–‡æœ¬ä¿æŒç®€æ´çš„ç®­å¤´ç¬¦å·\n   588â†’        self.prev_btn.setText(\"â—€\")\n   589â†’    \n   590â†’    def _has_valid_previous_record(self):\n   591â†’        \"\"\"æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ä¸Šä¸€ä¸ªè®°å½•\"\"\"\n   592â†’        for i in range(self.current_index - 1, -1, -1):\n   593â†’            candidate_data = self.image_list[i]\n   594â†’            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n   595â†’            if file_path and os.path.exists(file_path):\n   596â†’                return True\n   597â†’        return False\n   598â†’    \n   599â†’    def _has_valid_next_record(self):\n   600â†’        \"\"\"æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ä¸‹ä¸€ä¸ªè®°å½•\"\"\"\n   601â†’        for i in range(self.current_index + 1, len(self.image_list)):\n   602â†’            candidate_data = self.image_list[i]\n   603â†’            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n   604â†’            if file_path and os.path.exists(file_path):\n   605â†’                return True\n   606â†’        return False\n   607â†’    \n   608â†’    def show_previous_image(self):\n   609â†’        \"\"\"æ˜¾ç¤ºä¸Šä¸€å¼ å›¾ç‰‡ï¼ˆå¸¦æœ‰æ•ˆæ€§éªŒè¯ï¼‰\"\"\"\n   610â†’        # å¯»æ‰¾ä¸Šä¸€ä¸ªæœ‰æ•ˆè®°å½•\n   611â†’        for i in range(self.current_index - 1, -1, -1):\n   612â†’            candidate_data = self.image_list[i]\n   613â†’            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n   614â†’            \n   615â†’            if file_path and os.path.exists(file_path):\n   616â†’                # æ‰¾åˆ°æœ‰æ•ˆè®°å½•\n   617â†’                self.current_index = i\n   618â†’                self.load_current_image()\n   619â†’                self.update_navigation_buttons()\n   620â†’                return\n   621â†’        \n   622â†’        # æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä¸Šä¸€ä¸ªè®°å½•ï¼Œä¿æŒå½“å‰çŠ¶æ€\n   623â†’        self.update_navigation_buttons()\n   624â†’    \n   625â†’    def show_next_image(self):\n   626â†’        \"\"\"æ˜¾ç¤ºä¸‹ä¸€å¼ å›¾ç‰‡ï¼ˆå¸¦æœ‰æ•ˆæ€§éªŒè¯ï¼‰\"\"\"\n   627â†’        # å¯»æ‰¾ä¸‹ä¸€ä¸ªæœ‰æ•ˆè®°å½•\n   628â†’        for i in range(self.current_index + 1, len(self.image_list)):\n   629â†’            candidate_data = self.image_list[i]\n   630â†’            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n   631â†’            \n   632â†’            if file_path and os.path.exists(file_path):\n   633â†’                # æ‰¾åˆ°æœ‰æ•ˆè®°å½•\n   634â†’                self.current_index = i\n   635â†’                self.load_current_image()\n   636â†’                self.update_navigation_buttons()\n   637â†’                return\n   638â†’        \n   639â†’        # æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä¸‹ä¸€ä¸ªè®°å½•ï¼Œä¿æŒå½“å‰çŠ¶æ€\n   640â†’        self.update_navigation_buttons()\n   641â†’    \n   642â†’    def load_current_image(self):\n   643â†’        \"\"\"åŠ è½½å½“å‰ç´¢å¼•çš„å›¾ç‰‡\"\"\"\n   644â†’        if 0 <= self.current_index < len(self.image_list):\n   645â†’            # æ›´æ–°å½“å‰å›¾ç‰‡æ•°æ®\n   646â†’            self.image_data = self.image_list[self.current_index]\n   647â†’            \n   648â†’            # é‡æ–°åŠ è½½å›¾ç‰‡\n   649â†’            image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '') or self.image_data.get('file_path', '')\n   650â†’            if image_path and os.path.exists(image_path):\n   651â†’                pixmap = QPixmap(image_path)\n   652â†’                if not pixmap.isNull():\n   653â†’                    self.large_image_label.setPixmap(pixmap)\n   654â†’                else:\n   655â†’                    self.large_image_label.setText(\"å›¾ç‰‡åŠ è½½å¤±è´¥\")\n   656â†’            else:\n   657â†’                self.large_image_label.setText(\"å›¾ç‰‡ä¸å­˜åœ¨\")\n   658â†’            \n   659â†’            # æ›´æ–°çª—å£æ ‡é¢˜\n   660â†’            self.setWindowTitle(f\"å›¾ç‰‡è¯¦ç»†ä¿¡æ¯ ({self.current_index + 1}/{len(self.image_list)})\")\n   661â†’            \n   662â†’            # æ›´æ–°æç¤ºè¯å†…å®¹\n   663â†’            prompt_content = self.image_data.get('prompt', 'æ— æç¤ºè¯')\n   664â†’            self.prompt_text_edit.setPlainText(prompt_content)\n   665â†’            \n   666â†’            # æ›´æ–°å‚æ•°ä¿¡æ¯\n   667â†’            self.update_params_area()\n   668â†’            self._refresh_reference_gallery()\n   669â†’\n   670â†’        self._export_controller.refresh()\n   671â†’    \n   672â†’    def setup_params_area(self):\n   673â†’        \"\"\"åˆå§‹åŒ–å‚æ•°æ˜¾ç¤ºåŒºåŸŸ\"\"\"\n   674â†’        # Ensure this area is deterministic (avoid stale/duplicated widgets across refresh/theme changes)\n   675â†’        self._clear_params_layout()\n   676â†’\n   677â†’        # è§£æç”Ÿæˆå‚æ•°\n   678â†’        params = self.image_data.get('parameters', '{}')\n   679â†’        if isinstance(params, str):\n   680â†’            try:\n   681â†’                params = json.loads(params)\n   682â†’            except:\n   683â†’                params = {}\n   684â†’        \n   685â†’        # æç¤ºè¯åŒºåŸŸï¼ˆå¯æ»šåŠ¨æŸ¥çœ‹å…¨æ–‡ï¼‰\n   686â†’        prompt_label = QLabel(\"<b>æç¤ºè¯:</b>\")\n   687â†’        prompt_label.setStyleSheet(\"margin: 0px; padding: 2px 0px;\")\n   688â†’        unified_style_system.apply_to_widget(prompt_label)\n   689â†’        self.params_layout.addWidget(prompt_label)\n   690â†’        \n   691â†’        # æç¤ºè¯æ–‡æœ¬æ¡†\n   692â†’        prompt_content = self.image_data.get('prompt', 'æ— æç¤ºè¯')\n   693â†’        self.prompt_text_edit = QTextEdit()\n   694â†’        self.prompt_text_edit.setPlainText(prompt_content)\n   695â†’        self.prompt_text_edit.setReadOnly(True)  # åªè¯»æ¨¡å¼\n   696â†’        # çº¦ 4 è¡Œé«˜åº¦ï¼ˆæŒ‰å½“å‰å­—ä½“åŠ¨æ€è®¡ç®—ï¼‰ï¼Œé¿å…ä¿¡æ¯åŒºè¿‡é«˜å‹ç¼©å…¶å®ƒå†…å®¹\n   697â†’        try:\n   698â†’            line_height = self.prompt_text_edit.fontMetrics().lineSpacing()\n   699â†’            target_lines = 4\n   700â†’            vertical_padding = 16  # ä¸å…¨å±€ QTextEdit padding (8*2) å¯¹é½\n   701â†’            border = 2  # 1px*2\n   702â†’            height = line_height * target_lines + vertical_padding + border\n   703â†’            self.prompt_text_edit.setFixedHeight(max(72, int(height)))\n   704â†’        except Exception:\n   705â†’            self.prompt_text_edit.setMaximumHeight(96)\n   706â†’            self.prompt_text_edit.setMinimumHeight(96)\n   707â†’        self.prompt_text_edit.setVerticalScrollBarPolicy(Qt.ScrollBarAsNeeded)\n   708â†’        self.prompt_text_edit.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)\n   709â†’        unified_style_system.apply_to_widget(self.prompt_text_edit)\n   710â†’        # åº”ç”¨ä¸ _update_theme ä¸€è‡´çš„é¢å¤–æ ·å¼\n   711â†’        colors = unified_style_system.get_colors()\n   712â†’        bg_input = colors.get('palette.neutral.bg_input') or colors.get('palette.neutral.bg_card')\n   713â†’        text_color = colors.get('text') or colors.get('palette.text.primary')\n   714â†’        border_subtle = colors.get('palette.neutral.border_subtle') or colors.get('border')\n   715â†’        brand = colors.get('palette.brand.main') or colors.get('primary')\n   716â†’        self.prompt_text_edit.setStyleSheet(f\"\"\"\n   717â†’            QTextEdit {{\n   718â†’                background-color: {bg_input};\n   719â†’                color: {text_color};\n   720â†’                border: 1px solid {border_subtle};\n   721â†’                border-radius: 8px;\n   722â†’                padding: 8px;\n   723â†’            }}\n   724â†’            QTextEdit:focus {{\n   725â†’                border-color: {brand};\n   726â†’            }}\n   727â†’        \"\"\")\n   728â†’        self.params_layout.addWidget(self.prompt_text_edit)\n   729â†’        \n   730â†’        # æ·»åŠ å¤åˆ¶æç¤ºè¯æŒ‰é’®ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„ SecondaryButton æ ·å¼ï¼‰\n   731â†’        self.copy_prompt_btn = QPushButton(\"å¤åˆ¶æç¤ºè¯\")\n   732â†’        self.copy_prompt_btn.setObjectName(\"SecondaryButton\")\n   733â†’        self.copy_prompt_btn.setMaximumHeight(30)\n   734â†’        unified_style_system.apply_to_widget(self.copy_prompt_btn)\n   735â†’        self.copy_prompt_btn.clicked.connect(self.copy_prompt)\n   736â†’        self.params_layout.addWidget(self.copy_prompt_btn)\n   737â†’        \n   738â†’        # å­˜å‚¨å‚æ•°æ ‡ç­¾åˆ—è¡¨ï¼Œç”¨äºåç»­æ¸…ç†\n   739â†’        self.param_labels = []\n   740â†’        self.create_param_labels()\n   741â†’\n   742â†’    def _clear_params_layout(self):\n   743â†’        \"\"\"æ¸…ç©ºå‚æ•°åŒºå¸ƒå±€ä¸­çš„æ‰€æœ‰æ§ä»¶ï¼ˆä¿ç•™å¸ƒå±€æœ¬èº«ï¼‰ï¼Œé¿å…é‡å¤/é®æŒ¡ã€‚\"\"\"\n   744â†’        if not hasattr(self, \"params_layout\") or self.params_layout is None:\n   745â†’            return\n   746â†’        while self.params_layout.count() > 0:\n   747â†’            item = self.params_layout.takeAt(0)\n   748â†’            w = item.widget()\n   749â†’            if w is not None:\n   750â†’                w.hide()  # ç«‹å³éšè—ï¼Œé¿å… deleteLater å¼‚æ­¥å¯¼è‡´æ®‹ç•™æ˜¾ç¤º\n   751â†’                w.setParent(None)  # æ–­å¼€çˆ¶å­å…³ç³»\n   752â†’                w.deleteLater()\n   753â†’    \n   754â†’    def _update_theme(self):\n   755â†’        \"\"\"å“åº”ä¸»é¢˜å˜åŒ–\"\"\"\n   756â†’        colors = unified_style_system.get_colors()\n   757â†’        logger.info(f\"[ImageDetailDialog] _update_theme called. Surface color: {colors.get('palette.neutral.bg_surface')}\")\n   758â†’        \n   759â†’        # Apply theme to self (Dialog)\n   760â†’        bg_color = colors.get('palette.neutral.bg_surface') or colors.get('palette.neutral.bg_app') or colors.get('background')\n   761â†’        text_color = colors.get('text') or colors.get('palette.text.primary')\n   762â†’        bg_card = colors.get('palette.neutral.bg_card') or colors.get('surface') or bg_color\n   763â†’        bg_input = colors.get('palette.neutral.bg_input') or bg_card\n   764â†’        border_subtle = colors.get('palette.neutral.border_subtle') or colors.get('border')\n   765â†’        brand = colors.get('palette.brand.main') or colors.get('primary') or text_color\n   766â†’        \n   767â†’        self.setStyleSheet(f\"\"\"\n   768â†’            QDialog {{\n   769â†’                background-color: {bg_color};\n   770â†’                color: {text_color};\n   771â†’            }}\n   772â†’            QLabel {{\n   773â†’                color: {text_color};\n   774â†’            }}\n   775â†’            QWidget#ParamsWidget {{\n   776â†’                 background-color: {bg_card};\n   777â†’                 border-left: 1px solid {border_subtle};\n   778â†’            }}\n   779â†’        \"\"\")\n   780â†’\n   781â†’        if hasattr(self, 'prompt_text_edit'):\n   782â†’            self.prompt_text_edit.setStyleSheet(f\"\"\"\n   783â†’                QTextEdit {{\n   784â†’                    background-color: {bg_input};\n   785â†’                    color: {text_color};\n   786â†’                    border: 1px solid {border_subtle};\n   787â†’                    border-radius: 8px;\n   788â†’                    padding: 8px;\n   789â†’                }}\n   790â†’                QTextEdit:focus {{\n   791â†’                    border-color: {brand};\n   792â†’                }}\n   793â†’            \"\"\")\n   794â†’\n   795â†’        # Reapply button styles\n   796â†’        if hasattr(self, 'fullscreen_btn'):\n   797â†’            unified_style_system.apply_to_widget(self.fullscreen_btn)\n   798â†’        if hasattr(self, 'copy_image_btn'):\n   799â†’            unified_style_system.apply_to_widget(self.copy_image_btn)\n   800â†’        if hasattr(self, 'delete_btn'):\n   801â†’            unified_style_system.apply_to_widget(self.delete_btn, extra={'variant': 'danger'})\n   802â†’        if hasattr(self, 'close_btn'):\n   803â†’            unified_style_system.apply_to_widget(self.close_btn)\n   804â†’        if hasattr(self, 'reference_export_btn'):\n   805â†’            unified_style_system.apply_to_widget(self.reference_export_btn)\n   806â†’        if hasattr(self, 'export_bundle_btn'):\n   807â†’            unified_style_system.apply_to_widget(self.export_bundle_btn)\n   808â†’        if hasattr(self, 'prev_btn'):\n   809â†’            unified_style_system.apply_to_widget(self.prev_btn)\n   810â†’        if hasattr(self, 'next_btn'):\n   811â†’            unified_style_system.apply_to_widget(self.next_btn)\n   812â†’\n   813â†’        # Rebuild to ensure all param widgets pick up new palette and no stale widgets remain\n   814â†’        self.setup_params_area()\n   815â†’\n   816â†’    def create_param_labels(self):\n   817â†’        \"\"\"åˆ›å»ºå‚æ•°æ ‡ç­¾ï¼ˆåˆå§‹åŒ–æˆ–æ›´æ–°æ—¶è°ƒç”¨ï¼‰\"\"\"\n   818â†’        # æ¸…é™¤æ—§çš„å‚æ•°æ ‡ç­¾ - Fix Race Condition\n   819â†’        if hasattr(self, 'param_labels'):\n   820â†’            for label_pair in self.param_labels:\n   821â†’                # å¿…é¡»å…ˆä»å¸ƒå±€ä¸­ç§»é™¤ï¼Œé˜²æ­¢ deleteLater çš„å¼‚æ­¥é”€æ¯å¯¼è‡´é‡å½±\n   822â†’                self.params_layout.removeWidget(label_pair[0])\n   823â†’                self.params_layout.removeWidget(label_pair[1])\n   824â†’                label_pair[0].deleteLater()  # åˆ é™¤æ ‡é¢˜æ ‡ç­¾\n   825â†’                label_pair[1].deleteLater()  # åˆ é™¤å€¼æ ‡ç­¾\n   826â†’            self.param_labels.clear()\n   827â†’        else:\n   828â†’            self.param_labels = []\n   829â†’        \n   830â†’        # è§£æç”Ÿæˆå‚æ•°\n   831â†’        params = self.image_data.get('parameters', '{}')\n   832â†’        if isinstance(params, str):\n   833â†’            try:\n   834â†’                params = json.loads(params)\n   835â†’            except:\n   836â†’                params = {}\n   837â†’        \n   838â†’        # è¯¦ç»†ä¿¡æ¯\n   839â†’        info_items = [\n   840â†’            (\"å°ºå¯¸\", f\"{params.get('size', 'æœªçŸ¥')}\"),\n   841â†’            (\"ç§å­å€¼\", f\"{params.get('seed', 'æœªçŸ¥')}\"),\n   842â†’            (\"å¼•å¯¼å¼ºåº¦\", f\"{params.get('guidance_scale', 'æœªçŸ¥')}\"),\n   843â†’            (\"ç”Ÿæˆæ¨¡å‹\", f\"{params.get('model', 'æœªçŸ¥æ¨¡å‹')}\"),\n   844â†’            (\"ç”Ÿæˆæ—¶é—´\", self.format_time(self.image_data.get('created_at', ''))),\n   845â†’            (\"æ–‡ä»¶å¤§å°\", self.format_file_size(self.image_data.get('file_size', 0))),\n   846â†’            (\"æ–‡ä»¶è·¯å¾„\", self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')),\n   847â†’        ]\n   848â†’        \n   849â†’        # å¦‚æœæ˜¯å›¾ç”Ÿå›¾ï¼Œæ˜¾ç¤ºå‚è€ƒå›¾ä¿¡æ¯\n   850â†’        if params.get('model', '').find('i2i') != -1:\n   851â†’            info_items.insert(-2, (\"ç”Ÿæˆç±»å‹\", \"å›¾ç”Ÿå›¾\"))\n   852â†’            input_image = self.image_data.get('input_image', '')\n   853â†’            if input_image:\n   854â†’                info_items.insert(-2, (\"å‚è€ƒå›¾ç‰‡\", input_image))\n   855â†’        else:\n   856â†’            info_items.insert(-2, (\"ç”Ÿæˆç±»å‹\", \"æ–‡ç”Ÿå›¾\"))\n   857â†’        \n   858â†’        colors = unified_style_system.get_colors()\n   859â†’        bg_tag = colors.get('palette.neutral.bg_surface') or colors.get('palette.neutral.bg_card') or colors.get('surface')\n   860â†’        border_tag = colors.get('palette.neutral.border_subtle') or colors.get('border')\n   861â†’        text_tag = colors.get('text') or colors.get('palette.text.primary')\n   862â†’        hover_bg = colors.get('palette.neutral.bg_hover') or bg_tag\n   863â†’        hover_border = colors.get('palette.brand.main') or colors.get('primary') or border_tag\n   864â†’\n   865â†’        for label, value in info_items:\n   866â†’            label_widget = QLabel(f\"<b>{label}:</b>\")\n   867â†’            label_widget.setStyleSheet(\"margin: 0px; padding: 2px 0px;\")\n   868â†’            unified_style_system.apply_to_widget(label_widget)\n   869â†’            self.params_layout.addWidget(label_widget)\n   870â†’            \n   871â†’            # ä½¿ç”¨å¯ç‚¹å‡»çš„æ ‡ç­¾\n   872â†’            value_clickable = ClickableLabel(str(value))\n   873â†’            value_clickable.set_text_with_ellipsis(str(value), int(self.width() * 0.25))\n   874â†’            # File path is long and can otherwise expand to fill the panel, overlapping the prompt area.\n   875â†’            # Keep it single-line with ellipsis and fixed height.\n   876â†’            if label == \"æ–‡ä»¶è·¯å¾„\":\n   877â†’                value_clickable.setWordWrap(False)\n   878â†’                value_clickable.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)\n   879â†’                value_clickable.setFixedHeight(32)\n   880â†’                value_clickable.setToolTip(str(value))\n   881â†’            else:\n   882â†’                value_clickable.setWordWrap(True)\n   883â†’            # ä½¿ç”¨åŠ¨æ€æ ·å¼\n   884â†’            value_clickable.setStyleSheet(f\"\"\"\n   885â†’                QLabel {{\n   886â†’                    margin: 0px; \n   887â†’                    padding: 6px; \n   888â†’                    background-color: {bg_tag}; \n   889â†’                    color: {text_tag};\n   890â†’                    border: 1px solid {border_tag};\n   891â†’                    border-radius: 4px;\n   892â†’                }}\n   893â†’                QLabel:hover {{\n   894â†’                    background-color: {hover_bg};\n   895â†’                    border-color: {hover_border};\n   896â†’                }}\n   897â†’            \"\"\")\n   898â†’            unified_style_system.apply_to_widget(value_clickable)\n   899â†’            value_clickable.clicked.connect(self.copy_text_to_clipboard)\n   900â†’            self.params_layout.addWidget(value_clickable)\n   901â†’            \n   902â†’            # ä¿å­˜æ ‡ç­¾å¼•ç”¨\n   903â†’            self.param_labels.append((label_widget, value_clickable))\n   904â†’\n   905â†’        # Ensure remaining vertical space doesn't get assigned to the last label widget.\n   906â†’        self.params_layout.addStretch(1)\n   907â†’    \n   908â†’    def update_params_area(self):\n   909â†’        \"\"\"æ›´æ–°å‚æ•°æ˜¾ç¤ºåŒºåŸŸï¼ˆåˆ‡æ¢å›¾ç‰‡æ—¶è°ƒç”¨ï¼‰\"\"\"\n   910â†’        # Full rebuild avoids duplicated/stale widgets (e.g. file path blocks prompt area)\n   911â†’        self.setup_params_area()\n   912â†’\n   913â†’    def closeEvent(self, event):\n   914â†’        try:\n   915â†’            if hasattr(self, '_focus_timer') and self._focus_timer.isActive():\n   916â†’                self._focus_timer.stop()\n   917â†’        except Exception:\n   918â†’            pass\n   919â†’\n   920â†’        try:\n   921â†’            self._export_controller.dispose()\n   922â†’        except Exception:\n   923â†’            pass\n   924â†’\n   925â†’        super().closeEvent(event)\n   926â†’    \n   927â†’    def keyPressEvent(self, event):\n   928â†’        \"\"\"é”®ç›˜äº‹ä»¶å¤„ç†\"\"\"\n   929â†’        from PySide6.QtCore import Qt\n   930â†’        \n   931â†’        logger.debug(f\"[KEYBOARD] ImageDetailDialogé”®ç›˜äº‹ä»¶: {event.key()}\")\n   932â†’        \n   933â†’        if event.key() == Qt.Key_Left:\n   934â†’            # å·¦æ–¹å‘é”®ï¼šä¸Šä¸€å¼ å›¾ç‰‡\n   935â†’            if self.prev_btn.isEnabled():\n   936â†’                self.show_previous_image()\n   937â†’            event.accept()\n   938â†’        elif event.key() == Qt.Key_Right:\n   939â†’            # å³æ–¹å‘é”®ï¼šä¸‹ä¸€å¼ å›¾ç‰‡\n   940â†’            if self.next_btn.isEnabled():\n   941â†’                self.show_next_image()\n   942â†’            event.accept()\n   943â†’        elif event.key() == Qt.Key_Escape:\n   944â†’            # ESCé”®ï¼šå…³é—­å¯¹è¯æ¡†ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰\n   945â†’            logger.debug(f\"[KEYBOARD] ESCé”®pressedï¼Œfullscreen: {self.is_fullscreen}\")\n   946â†’            if self.is_fullscreen:\n   947â†’                self.exit_fullscreen()\n   948â†’            else:\n   949â†’                self.accept()\n   950â†’            event.accept()\n   951â†’        elif event.key() == Qt.Key_F11:\n   952â†’            # F11é”®ï¼šå…¨å±åˆ‡æ¢ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰\n   953â†’            self.toggle_fullscreen()\n   954â†’            event.accept()\n   955â†’        else:\n   956â†’            # å…¶ä»–æŒ‰é”®äº¤ç»™çˆ¶ç±»å¤„ç†\n   957â†’            super().keyPressEvent(event)\n   958â†’\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"cb28d405-5e7d-4e2e-aa4e-4fffd14a2446","timestamp":"2025-12-22T04:37:01.094Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/components/dialogs/image_detail_dialog.py","content":"import os\nimport json\nfrom datetime import datetime\nfrom typing import Dict, Any, List, Optional\n\nfrom PySide6.QtWidgets import (\n    QDialog, QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton,\n    QTextEdit, QFileDialog, QMessageBox, QSplitter, QApplication,\n    QMenu, QSizePolicy\n)\nfrom PySide6.QtGui import QAction, QShortcut\nfrom PySide6.QtCore import Qt, QTimer, QSize, QEvent\nfrom PySide6.QtGui import QPixmap, QKeySequence\n\nfrom utils.logger import logger\nfrom utils.style_system import unified_style_system\nfrom components.widgets import ZoomableImageLabel, ClickableLabel\nfrom components.reference_assets import (\n    ReferenceGalleryWidget,\n    export_reference_asset,\n    open_reference_preview,\n    _find_reference_asset_index,\n)\nfrom components.controllers import ExportBundleController\nfrom utils.reference_display import ensure_reference_info, resolve_reference_assets\nfrom PySide6.QtCore import Signal\n\nclass ImageDetailDialog(QDialog):\n    \"\"\"å›¾ç‰‡è¯¦ç»†ä¿¡æ¯å¯¹è¯æ¡†\"\"\"\n    \n    # åˆ é™¤è®°å½•åå‘å‡ºä¿¡å·ï¼Œé€šçŸ¥çˆ¶è§†å›¾åˆ·æ–°\n    recordDeleted = Signal(str)  # å‚æ•°ä¸ºè¢«åˆ é™¤çš„è®°å½•ID\n    \n    def __init__(self, image_data: Dict[str, Any], image_list: List[Dict[str, Any]] = None, current_index: int = 0, parent=None):\n        super().__init__(parent)\n        self.image_data = image_data\n        self.image_list = image_list or [image_data]  # å›¾ç‰‡åˆ—è¡¨\n        self.current_index = current_index  # å½“å‰å›¾ç‰‡ç´¢å¼•\n        self.zoom_factor = 1.0  # ç¼©æ”¾å› å­\n        self.is_fullscreen = False  # å…¨å±çŠ¶æ€\n        self.original_geometry = None  # åŸå§‹çª—å£å‡ ä½•\n        self._reference_summary = ensure_reference_info(self.image_data)\n        self._reference_assets: List[Dict[str, Any]] = []\n        self._export_controller = ExportBundleController(self, \"image\")\n        \n        # Subscribe to theme changes\n        unified_style_system.styleChanged.connect(self._update_theme)\n        \n        self.setup_ui()\n        \n    def setup_ui(self):\n        \"\"\"è®¾ç½®UI\"\"\"\n        self.setWindowTitle(\"å›¾ç‰‡è¯¦ç»†ä¿¡æ¯\")\n        self.resize(1100, 800)  # æ”¹ä¸ºå¯è°ƒæ•´å¤§å°\n        self.setMinimumSize(800, 600)  # è®¾ç½®æœ€å°å°ºå¯¸\n        \n        # è®¾ç½®ç„¦ç‚¹ç­–ç•¥ï¼Œç¡®ä¿èƒ½æ¥æ”¶é”®ç›˜äº‹ä»¶\n        self.setFocusPolicy(Qt.StrongFocus)\n        self.setAttribute(Qt.WA_KeyCompression, False)  # ç¦ç”¨é”®ç›˜äº‹ä»¶å‹ç¼©\n        self.setFocus()\n\n        # ç¡®ä¿çª—å£æ¿€æ´»æ—¶è·å¾—ç„¦ç‚¹\n        self.activateWindow()\n        self.raise_()\n\n        try:\n            self.setObjectName(\"DetailDialog\")\n        except Exception:\n            pass\n\n        self._focus_timer = QTimer(self)\n        self._focus_timer.setSingleShot(True)\n        self._focus_timer.timeout.connect(self._ensure_focus)\n\n        layout = QHBoxLayout(self)\n        \n        # å·¦ä¾§ï¼šå¤§å›¾æ˜¾ç¤ºï¼ˆå 70%å®½åº¦ï¼‰\n        left_widget = QWidget()\n        left_layout = QVBoxLayout(left_widget)\n        left_layout.setContentsMargins(0, 0, 0, 0)\n        \n        # å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸï¼ˆå æ®ä¸Šæ–¹å…¨éƒ¨ç©ºé—´ï¼‰\n        image_container = QWidget()\n        image_container.setObjectName(\"ImageContainer\")\n        image_container.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)\n\n        # åœ¨å®¹å™¨å†…åˆ›å»ºå¸ƒå±€\n        container_layout = QVBoxLayout(image_container)\n        container_layout.setContentsMargins(0, 0, 0, 0)\n        container_layout.setSpacing(0)\n\n        # ä½¿ç”¨å¯ç¼©æ”¾çš„å›¾ç‰‡æ ‡ç­¾ï¼Œè‡ªé€‚åº”å®¹å™¨å¤§å°\n        self.large_image_label = ZoomableImageLabel()\n        self.large_image_label.setAlignment(Qt.AlignCenter)\n        self.large_image_label.setStyleSheet(\"border: none; background-color: transparent;\")\n        \n        # è®¾ç½®å³é”®èœå•\n        self.large_image_label.setContextMenuPolicy(Qt.CustomContextMenu)\n        self.large_image_label.customContextMenuRequested.connect(self.show_context_menu)\n        \n        # åŠ è½½å¤§å›¾\n        image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')\n        if image_path and os.path.exists(image_path):\n            pixmap = QPixmap(image_path)\n            if not pixmap.isNull():\n                self.large_image_label.setPixmap(pixmap)\n        \n        container_layout.addWidget(self.large_image_label, 1)\n\n        reference_section = QWidget()\n        reference_section.setObjectName(\"ReferenceSection\")\n        reference_section.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)\n        reference_section_layout = QVBoxLayout(reference_section)\n        reference_section_layout.setContentsMargins(0, 0, 0, 0)\n        reference_section_layout.setSpacing(8)\n\n        self.reference_gallery = ReferenceGalleryWidget()\n        self.reference_gallery.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)\n        try:\n            self.reference_gallery.referenceClicked.connect(self._on_reference_clicked)\n            self.reference_gallery.exportRequested.connect(self._on_reference_export)\n            self.reference_gallery.selectionChanged.connect(self._on_reference_selection_changed)\n        except Exception:\n            pass\n        reference_section_layout.addWidget(self.reference_gallery, 1)\n\n        reference_button_layout = QHBoxLayout()\n        reference_button_layout.setContentsMargins(0, 0, 0, 0)\n        reference_button_layout.setSpacing(6)\n        self.export_status_label = QLabel(\"\")\n        self.export_status_label.setObjectName(\"infoLabel\")\n        unified_style_system.apply_to_widget(self.export_status_label)\n        reference_button_layout.addWidget(self.export_status_label)\n        reference_button_layout.addStretch(1)\n        self.reference_export_btn = QPushButton(\"å¯¼å‡ºé€‰ä¸­å‚è€ƒå›¾\")\n        self.reference_export_btn.setObjectName(\"SecondaryButton\")\n        self.reference_export_btn.setEnabled(False)\n        unified_style_system.apply_to_widget(self.reference_export_btn)\n        self.reference_export_btn.clicked.connect(self._export_selected_reference)\n        reference_button_layout.addWidget(self.reference_export_btn)\n        self.export_bundle_btn = QPushButton(\"å¯¼å‡ºè®°å½•\")\n        self.export_bundle_btn.setObjectName(\"SecondaryButton\")\n        self.export_bundle_btn.setEnabled(False)\n        unified_style_system.apply_to_widget(self.export_bundle_btn)\n        self._export_controller.configure(\n            self.export_bundle_btn,\n            self.export_status_label,\n            self._resolve_record_id,\n            context_widget=self,\n        )\n        reference_button_layout.addWidget(self.export_bundle_btn)\n        reference_section_layout.addLayout(reference_button_layout)\n\n        self._image_reference_splitter = QSplitter(Qt.Vertical)\n        self._image_reference_splitter.setObjectName(\"ImageReferenceSplitter\")\n        self._image_reference_splitter.setChildrenCollapsible(False)\n        self._image_reference_splitter.setHandleWidth(6)\n        self._image_reference_splitter.addWidget(image_container)\n        self._image_reference_splitter.addWidget(reference_section)\n        self._image_reference_splitter.setStretchFactor(0, 3)\n        self._image_reference_splitter.setStretchFactor(1, 2)\n        self._image_reference_splitter.setSizes([520, 280])\n\n        left_layout.addWidget(self._image_reference_splitter, 1)\n\n        # åº•éƒ¨åŒºåŸŸï¼šå¯¼èˆªæŒ‰é’® + è¯´æ˜æ–‡æœ¬æ¡†ï¼ˆä¸å³ä¾§å‚æ•°æ é«˜åº¦å¯¹é½ï¼‰\n        bottom_layout = QHBoxLayout()\n        bottom_layout.setContentsMargins(0, 5, 0, 5)\n        bottom_layout.setSpacing(10)\n        \n        # å‘å·¦æŒ‰é’®\n        self.prev_btn = QPushButton(\"â—€\")\n        self.prev_btn.setFixedSize(30, 30)  # å›ºå®šå°ºå¯¸\n        self.prev_btn.setObjectName(\"NavButton\")\n        unified_style_system.apply_to_widget(self.prev_btn)\n        self.prev_btn.clicked.connect(self.show_previous_image)\n        bottom_layout.addWidget(self.prev_btn)\n        \n        # ä¸­é—´çš„è¯´æ˜æ–‡æœ¬æ¡†ï¼ˆå®Œå…¨é€æ˜è®¾è®¡ï¼‰\n        zoom_info = QLabel(\"æç¤ºï¼šé¼ æ ‡ä½ç½®ç¼©æ”¾ï¼Œç‚¹å‡»æ‹–æ‹½ï¼ŒåŒå‡»é‡ç½®\")\n        zoom_info.setObjectName(\"infoLabel\")\n        unified_style_system.apply_to_widget(zoom_info)\n        zoom_info.setAlignment(Qt.AlignCenter)\n        zoom_info.setMinimumHeight(30)  # ä¸æŒ‰é’®é«˜åº¦ä¸€è‡´\n        zoom_info.setMaximumHeight(30)  # å›ºå®šé«˜åº¦ï¼Œé˜²æ­¢æ–‡å­—è¢«å‹ç¼©\n        bottom_layout.addWidget(zoom_info, 1)  # å æ®ä¸­é—´æ‰€æœ‰ç©ºé—´\n        \n        # å‘å³æŒ‰é’®\n        self.next_btn = QPushButton(\"â–¶\")\n        self.next_btn.setFixedSize(30, 30)  # å›ºå®šå°ºå¯¸\n        self.next_btn.setObjectName(\"NavButton\")\n        unified_style_system.apply_to_widget(self.next_btn)\n        self.next_btn.clicked.connect(self.show_next_image)\n        bottom_layout.addWidget(self.next_btn)\n        \n        left_layout.addLayout(bottom_layout)\n\n        # æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€\n        self.update_navigation_buttons()\n        self._refresh_reference_gallery()\n        self._export_controller.refresh()\n\n        # å³ä¾§ï¼šè¯¦ç»†ä¿¡æ¯ï¼ˆå›ºå®š30%å®½åº¦ï¼‰\n        right_layout = QVBoxLayout()\n        \n        # åˆ›å»ºå‚æ•°æ˜¾ç¤ºåŒºåŸŸï¼ˆä¸ä½¿ç”¨æ»šåŠ¨æ¡ï¼‰\n        params_widget = QWidget()\n        params_widget.setFixedWidth(int(self.width() * 0.3))  # å›ºå®š30%å®½åº¦\n        params_widget.setObjectName(\"ParamsWidget\")\n        self.params_layout = QVBoxLayout(params_widget)  # ä¿å­˜å¼•ç”¨ä»¥ä¾¿åç»­æ›´æ–°\n        self.params_layout.setSpacing(0)  # è®¾ç½®é—´è·ä¸º0\n        self.params_layout.setContentsMargins(5, 5, 5, 5)  # è®¾ç½®ç´§å‡‘çš„è¾¹è·\n        \n        # åˆå§‹åŒ–å‚æ•°æ˜¾ç¤ºåŒºåŸŸ\n        self.setup_params_area()\n        \n        \n        right_layout.addWidget(params_widget)\n        \n        # å…¨å±å’Œå¤åˆ¶å›¾ç‰‡æŒ‰é’®ï¼ˆä¸å‚æ•°åŒºåº•éƒ¨å¯¹é½ï¼‰\n        image_control_layout = QHBoxLayout()\n\n        self.fullscreen_btn = QPushButton(\"å…¨å± (F11)\")\n        self.fullscreen_btn.setMaximumHeight(30)\n        unified_style_system.apply_to_widget(self.fullscreen_btn)\n        self.fullscreen_btn.clicked.connect(self.toggle_fullscreen)\n        image_control_layout.addWidget(self.fullscreen_btn)\n\n        self.copy_image_btn = QPushButton(\"å¤åˆ¶å›¾ç‰‡\")\n        self.copy_image_btn.setMaximumHeight(30)\n        unified_style_system.apply_to_widget(self.copy_image_btn)\n        self.copy_image_btn.clicked.connect(self.copy_image)\n        image_control_layout.addWidget(self.copy_image_btn)\n\n        right_layout.addLayout(image_control_layout)\n\n        # å…¶ä»–æŒ‰é’®\n        button_layout = QHBoxLayout()\n\n        self.delete_btn = QPushButton(\"åˆ é™¤è®°å½•\")\n        unified_style_system.apply_to_widget(self.delete_btn, extra={'variant': 'danger'})\n        self.delete_btn.clicked.connect(self._delete_current_record)\n        button_layout.addWidget(self.delete_btn)\n\n        self.close_btn = QPushButton(\"å…³é—­ï¼ˆESCï¼‰\")\n        unified_style_system.apply_to_widget(self.close_btn)\n        self.close_btn.clicked.connect(self.accept)\n        button_layout.addWidget(self.close_btn)\n        \n        right_layout.addLayout(button_layout)\n        \n        # è®¾ç½®å¸ƒå±€æ¯”ä¾‹ï¼šå·¦ä¾§70%ï¼Œå³ä¾§30%\n        layout.addWidget(left_widget, 7)\n        layout.addLayout(right_layout, 3)\n        \n        # æ·»åŠ é”®ç›˜å¿«æ·é”®\n        self.setup_shortcuts()\n\n        # å»¶è¿Ÿè®¾ç½®ç„¦ç‚¹ï¼Œç¡®ä¿çª—å£å®Œå…¨åˆå§‹åŒ–åè·å¾—ç„¦ç‚¹\n        self._focus_timer.start(100)\n\n        self._esc_shortcut = QShortcut(QKeySequence(Qt.Key_Escape), self)\n        self._esc_shortcut.activated.connect(self.handle_escape_key)\n        \n        # Apply initial theme\n        self._update_theme()\n    \n    def format_time(self, time_str: str) -> str:\n        \"\"\"æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º\"\"\"\n        if not time_str:\n            return 'æœªçŸ¥æ—¶é—´'\n        try:\n            dt = datetime.fromisoformat(time_str.replace('Z', '+00:00'))\n            return dt.strftime('%Y-%m-%d %H:%M:%S')\n        except:\n            return time_str[:19] if len(time_str) > 19 else time_str\n    \n    def format_file_size(self, size) -> str:\n        \"\"\"æ ¼å¼åŒ–æ–‡ä»¶å¤§å°æ˜¾ç¤º\"\"\"\n        # å¤„ç†å­—ç¬¦ä¸²ç±»å‹çš„size\n        try:\n            size = float(size) if size else 0\n        except (ValueError, TypeError):\n            return 'æœªçŸ¥å¤§å°'\n            \n        if size == 0:\n            return 'æœªçŸ¥å¤§å°'\n        \n        for unit in ['B', 'KB', 'MB', 'GB']:\n            if size < 1024.0:\n                return f\"{size:.1f} {unit}\"\n            size /= 1024.0\n        return f\"{size:.1f} TB\"\n    \n    def setup_shortcuts(self):\n        \"\"\"è®¾ç½®é”®ç›˜å¿«æ·é”®\"\"\"\n        # ç§»é™¤æ‰€æœ‰QShortcutï¼Œç»Ÿä¸€ä½¿ç”¨keyPressEventå¤„ç†\n        # é¿å…å¿«æ·é”®å†²çªé—®é¢˜\n        pass\n    \n    def _ensure_focus(self):\n        \"\"\"ç¡®ä¿çª—å£è·å¾—ç„¦ç‚¹\"\"\"\n        self.activateWindow()\n        self.raise_()\n        self.setFocus()\n        logger.debug(f\"[FOCUS] ImageDialogçª—å£ç„¦ç‚¹è®¾ç½®å®Œæˆï¼ŒhasFocus: {self.hasFocus()}\")\n        \n    def toggle_fullscreen(self):\n        \"\"\"åˆ‡æ¢å…¨å±æ¨¡å¼\"\"\"\n        if self.is_fullscreen:\n            self.exit_fullscreen()\n        else:\n            self.enter_fullscreen()\n            \n    def enter_fullscreen(self):\n        \"\"\"è¿›å…¥å…¨å±æ¨¡å¼\"\"\"\n        if not self.is_fullscreen:\n            self.original_geometry = self.geometry()\n            self.showFullScreen()\n            self.is_fullscreen = True\n            \n    def exit_fullscreen(self):\n        \"\"\"é€€å‡ºå…¨å±æ¨¡å¼\"\"\"\n        if self.is_fullscreen:\n            self.showNormal()\n            if self.original_geometry:\n                self.setGeometry(self.original_geometry)\n            self.is_fullscreen = False\n            \n    def handle_escape_key(self):\n        \"\"\"å¤„ç†ESCé”®ï¼šå¦‚æœæ˜¯å…¨å±åˆ™é€€å‡ºå…¨å±ï¼Œå¦åˆ™å…³é—­å¯¹è¯æ¡†\"\"\"\n        if self.is_fullscreen:\n            self.exit_fullscreen()\n        else:\n            self.accept()  # å…³é—­å¯¹è¯æ¡†\n            \n    def copy_text_to_clipboard(self, text: str):\n        \"\"\"å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿å¹¶æ˜¾ç¤ºæç¤º\"\"\"\n        from PySide6.QtWidgets import QApplication\n        clipboard = QApplication.clipboard()\n        clipboard.setText(text)\n        self.show_copy_toast(f\"å·²å¤åˆ¶: {text[:30]}...\" if len(text) > 30 else f\"å·²å¤åˆ¶: {text}\")\n        \n    def show_copy_toast(self, message: str):\n        \"\"\"æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„è½»é‡æç¤º\"\"\"\n        # åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æç¤ºæ ‡ç­¾\n        toast = QLabel(message, self)\n        toast.setObjectName(\"ToastLabel\")\n        toast.setAlignment(Qt.AlignCenter)\n        toast.adjustSize()\n        \n        # å®šä½åˆ°çª—å£ä¸­å¤®åä¸Š\n        x = (self.width() - toast.width()) // 2\n        y = self.height() // 4\n        toast.move(x, y)\n        toast.show()\n        \n        # 2ç§’åè‡ªåŠ¨éšè—\n        QTimer.singleShot(2000, toast.deleteLater)\n        \n    def copy_prompt(self):\n        \"\"\"å¤åˆ¶æç¤ºè¯åˆ°å‰ªè´´æ¿\"\"\"\n        prompt_content = self.prompt_text_edit.toPlainText()\n        self.copy_text_to_clipboard(prompt_content)\n    \n    def copy_image(self):\n        \"\"\"å¤åˆ¶å›¾ç‰‡åˆ°å‰ªè´´æ¿\"\"\"\n        from PySide6.QtWidgets import QApplication\n        image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')\n        if image_path and os.path.exists(image_path):\n            pixmap = QPixmap(image_path)\n            if not pixmap.isNull():\n                clipboard = QApplication.clipboard()\n                clipboard.setPixmap(pixmap)\n                self.show_copy_toast(\"å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿\")\n            else:\n                self.show_copy_toast(\"æ— æ³•å¤åˆ¶å›¾ç‰‡\")\n        else:\n            self.show_copy_toast(\"å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨\")\n    \n    def copy_all_info(self):\n        \"\"\"å¤åˆ¶æ‰€æœ‰ä¿¡æ¯åˆ°å‰ªè´´æ¿\"\"\"\n        from PySide6.QtWidgets import QApplication\n        \n        params = self.image_data.get('parameters', '{}')\n        if isinstance(params, str):\n            try:\n                params = json.loads(params)\n            except:\n                params = {}\n        \n        info_text = f\"\"\"å›¾ç‰‡è¯¦ç»†ä¿¡æ¯\n===================\næç¤ºè¯: {self.image_data.get('prompt', 'æ— æç¤ºè¯')}\nå°ºå¯¸: {params.get('size', 'æœªçŸ¥')}\nç§å­å€¼: {params.get('seed', 'æœªçŸ¥')}\nå¼•å¯¼å¼ºåº¦: {params.get('guidance_scale', 'æœªçŸ¥')}\nç”Ÿæˆæ¨¡å‹: {params.get('model', 'æœªçŸ¥æ¨¡å‹')}\nç”Ÿæˆæ—¶é—´: {self.format_time(self.image_data.get('created_at', ''))}\næ–‡ä»¶å¤§å°: {self.format_file_size(self.image_data.get('file_size', 0))}\næ–‡ä»¶è·¯å¾„: {self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')}\n\"\"\"\n        \n        clipboard = QApplication.clipboard()\n        clipboard.setText(info_text)\n        self.show_copy_toast(\"æ‰€æœ‰ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿\")\n\n    def show_copy_message(self, message: str):\n        \"\"\"æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæ¶ˆæ¯ï¼ˆå·²å¼ƒç”¨ï¼Œä½¿ç”¨show_copy_toastä»£æ›¿ï¼‰\"\"\"\n        # ç›´æ¥ä½¿ç”¨è½»é‡çº§Toastæç¤º\n        self.show_copy_toast(message)\n\n    def _delete_current_record(self):\n        \"\"\"åˆ é™¤å½“å‰è®°å½•åŠç›¸å…³æ–‡ä»¶\"\"\"\n        record_id = self._resolve_record_id()\n        if not record_id:\n            self.show_copy_toast(\"æ— æ³•è·å–è®°å½•ID\")\n            return\n        \n        try:\n            # è·å– RepositoryManager\n            from config_api import get_storage_dir\n            from modules.repository.manager import RepositoryManager\n            \n            storage_dir = get_storage_dir()\n            repo = RepositoryManager(storage_dir)\n            \n            # æ‰§è¡Œåˆ é™¤\n            if repo.delete_record_with_files(record_id):\n                self.show_copy_toast(\"è®°å½•å·²åˆ é™¤\")\n                \n                # å‘å‡ºä¿¡å·é€šçŸ¥çˆ¶è§†å›¾åˆ·æ–°\n                self.recordDeleted.emit(record_id)\n                \n                # ä»åˆ—è¡¨ä¸­ç§»é™¤å½“å‰è®°å½•\n                if len(self.image_list) > 1:\n                    del self.image_list[self.current_index]\n                    \n                    # å¯¼èˆªåˆ°åä¸€æ¡è®°å½•ï¼ˆä¿æŒç´¢å¼•ï¼ŒæŒ‡å‘åŸæ¥çš„ä¸‹ä¸€æ¡ï¼‰\n                    # åªæœ‰å½“åˆ é™¤çš„æ˜¯æœ€åä¸€æ¡æ—¶ï¼Œæ‰éœ€è¦è°ƒæ•´ç´¢å¼•\n                    if self.current_index >= len(self.image_list):\n                        self.current_index = len(self.image_list) - 1\n                    \n                    self.load_current_image()\n                    self.update_navigation_buttons()\n                else:\n                    # åªå‰©ä¸€æ¡è®°å½•ï¼Œå…³é—­å¯¹è¯æ¡†\n                    self.accept()\n            else:\n                self.show_copy_toast(\"åˆ é™¤å¤±è´¥\")\n        except Exception as e:\n            from utils.logger import logger\n            logger.error(f\"åˆ é™¤è®°å½•å¼‚å¸¸: {e}\")\n            self.show_copy_toast(f\"åˆ é™¤å¤±è´¥: {str(e)}\")\n\n    def _on_reference_clicked(self, asset: Dict[str, Any]):\n        assets = list(self._reference_assets) if self._reference_assets else [asset]\n        start_idx = _find_reference_asset_index(assets, asset)\n        open_reference_preview(\n            self,\n            asset,\n            title_prefix=\"å‚è€ƒå›¾\",\n            asset_list=assets,\n            start_index=start_idx,\n            on_asset_changed=self._sync_reference_selection,\n        )\n\n    def _on_reference_export(self, asset: Dict[str, Any]):\n        export_reference_asset(self, asset)\n\n    def _on_reference_selection_changed(self, asset: Dict[str, Any]):\n        asset_path = None\n        if isinstance(asset, dict):\n            asset_path = asset.get('absolute_path') or asset.get('path')\n        has_path = bool(asset_path and os.path.exists(asset_path))\n        if hasattr(self, 'reference_export_btn'):\n            self.reference_export_btn.setEnabled(has_path)\n\n    def _export_selected_reference(self):\n        asset = self.reference_gallery.current_asset() if hasattr(self, 'reference_gallery') else None\n        if not asset:\n            QMessageBox.information(self, \"å¯¼å‡ºå‚è€ƒå›¾\", \"è¯·å…ˆé€‰æ‹©å‚è€ƒå›¾\")\n            return\n        export_reference_asset(self, asset)\n\n    def _refresh_reference_gallery(self):\n        if not hasattr(self, 'reference_gallery'):\n            return\n        self._reference_summary = ensure_reference_info(self.image_data)\n        if self._reference_summary.get('count', 0) <= 0:\n            self.reference_gallery.clear()\n            self.reference_gallery.setVisible(False)\n            if hasattr(self, 'reference_export_btn'):\n                self.reference_export_btn.setEnabled(False)\n            self._reference_assets = []\n            self._export_controller.refresh()\n            return\n        try:\n            self._reference_assets = resolve_reference_assets(self.image_data, absolute=True)\n        except Exception:\n            self._reference_assets = []\n        self.reference_gallery.setVisible(True)\n        self.reference_gallery.set_assets(self._reference_assets)\n        self._on_reference_selection_changed(self.reference_gallery.current_asset())\n        self._export_controller.refresh()\n\n    def _sync_reference_selection(self, asset: Dict[str, Any]):\n        try:\n            self.reference_gallery.select_asset(asset)\n        except Exception:\n            pass\n\n    def _resolve_record_id(self) -> Optional[str]:\n        for key in (\"file_id\", \"id\", \"generation_id\"):\n            value = self.image_data.get(key)\n            if value not in (None, \"\"):\n                return str(value)\n        return None\n\n    def show_context_menu(self, position):\n        \"\"\"æ˜¾ç¤ºå³é”®èœå•\"\"\"\n        from PySide6.QtWidgets import QMenu\n        from PySide6.QtGui import QAction, QShortcut\n        \n        menu = QMenu(self)\n        \n        # å¤åˆ¶å›¾ç‰‡åŠ¨ä½œ\n        copy_action = QAction(\"å¤åˆ¶å›¾ç‰‡\", self)\n        copy_action.triggered.connect(self.copy_image)\n        menu.addAction(copy_action)\n        \n        # ä¸‹è½½å›¾ç‰‡åŠ¨ä½œ\n        download_action = QAction(\"ä¸‹è½½å›¾ç‰‡\", self)\n        download_action.triggered.connect(self.download_image)\n        menu.addAction(download_action)\n        \n        # æ˜¾ç¤ºèœå•\n        menu.exec(self.large_image_label.mapToGlobal(position))\n    \n    def download_image(self):\n        \"\"\"ä¸‹è½½å›¾ç‰‡åˆ°æŒ‡å®šä½ç½®\"\"\"\n        from PySide6.QtWidgets import QFileDialog, QMessageBox\n        import shutil\n        \n        image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')\n        if not image_path or not os.path.exists(image_path):\n            self.show_styled_message(\"é”™è¯¯\", \"å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨\", \"warning\")\n            return\n        \n        # è·å–åŸå§‹æ–‡ä»¶å\n        original_filename = os.path.basename(image_path)\n        \n        # æ‰“å¼€ä¿å­˜å¯¹è¯æ¡†\n        save_path, _ = QFileDialog.getSaveFileName(\n            self,\n            \"ä¿å­˜å›¾ç‰‡\",\n            original_filename,\n            \"å›¾ç‰‡æ–‡ä»¶ (*.png *.jpg *.jpeg *.bmp *.gif)\"\n        )\n        \n        if save_path:\n            try:\n                shutil.copy2(image_path, save_path)\n                self.show_styled_message(\"æˆåŠŸ\", f\"å›¾ç‰‡å·²ä¿å­˜åˆ°:\\n{save_path}\", \"information\")\n            except Exception as e:\n                self.show_styled_message(\"é”™è¯¯\", f\"ä¿å­˜å›¾ç‰‡å¤±è´¥:\\n{str(e)}\", \"critical\")\n    \n    def update_navigation_buttons(self):\n        \"\"\"æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€ï¼ˆåŸºäºæœ‰æ•ˆè®°å½•æ£€æŸ¥ï¼‰\"\"\"\n        # æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡åˆ—è¡¨\n        if len(self.image_list) <= 1:\n            self.prev_btn.setEnabled(False)\n            self.next_btn.setEnabled(False)\n            self.prev_btn.setToolTip(\"æ²¡æœ‰æ›´å¤šå›¾ç‰‡\")\n            self.next_btn.setToolTip(\"æ²¡æœ‰æ›´å¤šå›¾ç‰‡\")\n            return\n        \n        # æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆåŸºäºæœ‰æ•ˆè®°å½•æ£€æŸ¥ï¼‰\n        self.prev_btn.setEnabled(self._has_valid_previous_record())\n        self.next_btn.setEnabled(self._has_valid_next_record())\n        \n        # æ›´æ–°å·¥å…·æç¤ºæ˜¾ç¤ºå½“å‰ä½ç½®å’Œå¿«æ·é”®ä¿¡æ¯\n        current_pos = f\"({self.current_index + 1}/{len(self.image_list)})\"\n        self.prev_btn.setToolTip(f\"ä¸Šä¸€å¼  {current_pos} - å¿«æ·é”®: â†\")\n        self.next_btn.setToolTip(f\"ä¸‹ä¸€å¼  {current_pos} - å¿«æ·é”®: â†’\")\n        \n        # æŒ‰é’®æ–‡æœ¬ä¿æŒç®€æ´çš„ç®­å¤´ç¬¦å·\n        self.prev_btn.setText(\"â—€\")\n    \n    def _has_valid_previous_record(self):\n        \"\"\"æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ä¸Šä¸€ä¸ªè®°å½•\"\"\"\n        for i in range(self.current_index - 1, -1, -1):\n            candidate_data = self.image_list[i]\n            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n            if file_path and os.path.exists(file_path):\n                return True\n        return False\n    \n    def _has_valid_next_record(self):\n        \"\"\"æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ä¸‹ä¸€ä¸ªè®°å½•\"\"\"\n        for i in range(self.current_index + 1, len(self.image_list)):\n            candidate_data = self.image_list[i]\n            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n            if file_path and os.path.exists(file_path):\n                return True\n        return False\n    \n    def show_previous_image(self):\n        \"\"\"æ˜¾ç¤ºä¸Šä¸€å¼ å›¾ç‰‡ï¼ˆå¸¦æœ‰æ•ˆæ€§éªŒè¯ï¼‰\"\"\"\n        # å¯»æ‰¾ä¸Šä¸€ä¸ªæœ‰æ•ˆè®°å½•\n        for i in range(self.current_index - 1, -1, -1):\n            candidate_data = self.image_list[i]\n            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n            \n            if file_path and os.path.exists(file_path):\n                # æ‰¾åˆ°æœ‰æ•ˆè®°å½•\n                self.current_index = i\n                self.load_current_image()\n                self.update_navigation_buttons()\n                return\n        \n        # æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä¸Šä¸€ä¸ªè®°å½•ï¼Œä¿æŒå½“å‰çŠ¶æ€\n        self.update_navigation_buttons()\n    \n    def show_next_image(self):\n        \"\"\"æ˜¾ç¤ºä¸‹ä¸€å¼ å›¾ç‰‡ï¼ˆå¸¦æœ‰æ•ˆæ€§éªŒè¯ï¼‰\"\"\"\n        # å¯»æ‰¾ä¸‹ä¸€ä¸ªæœ‰æ•ˆè®°å½•\n        for i in range(self.current_index + 1, len(self.image_list)):\n            candidate_data = self.image_list[i]\n            file_path = candidate_data.get('absolute_path', '') or candidate_data.get('file_path', '')\n            \n            if file_path and os.path.exists(file_path):\n                # æ‰¾åˆ°æœ‰æ•ˆè®°å½•\n                self.current_index = i\n                self.load_current_image()\n                self.update_navigation_buttons()\n                return\n        \n        # æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä¸‹ä¸€ä¸ªè®°å½•ï¼Œä¿æŒå½“å‰çŠ¶æ€\n        self.update_navigation_buttons()\n    \n    def load_current_image(self):\n        \"\"\"åŠ è½½å½“å‰ç´¢å¼•çš„å›¾ç‰‡\"\"\"\n        if 0 <= self.current_index < len(self.image_list):\n            # æ›´æ–°å½“å‰å›¾ç‰‡æ•°æ®\n            self.image_data = self.image_list[self.current_index]\n            \n            # é‡æ–°åŠ è½½å›¾ç‰‡\n            image_path = self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '') or self.image_data.get('file_path', '')\n            if image_path and os.path.exists(image_path):\n                pixmap = QPixmap(image_path)\n                if not pixmap.isNull():\n                    self.large_image_label.setPixmap(pixmap)\n                else:\n                    self.large_image_label.setText(\"å›¾ç‰‡åŠ è½½å¤±è´¥\")\n            else:\n                self.large_image_label.setText(\"å›¾ç‰‡ä¸å­˜åœ¨\")\n            \n            # æ›´æ–°çª—å£æ ‡é¢˜\n            self.setWindowTitle(f\"å›¾ç‰‡è¯¦ç»†ä¿¡æ¯ ({self.current_index + 1}/{len(self.image_list)})\")\n            \n            # æ›´æ–°æç¤ºè¯å†…å®¹\n            prompt_content = self.image_data.get('prompt', 'æ— æç¤ºè¯')\n            self.prompt_text_edit.setPlainText(prompt_content)\n            \n            # æ›´æ–°å‚æ•°ä¿¡æ¯\n            self.update_params_area()\n            self._refresh_reference_gallery()\n\n        self._export_controller.refresh()\n    \n    def setup_params_area(self):\n        \"\"\"åˆå§‹åŒ–å‚æ•°æ˜¾ç¤ºåŒºåŸŸ\"\"\"\n        # Ensure this area is deterministic (avoid stale/duplicated widgets across refresh/theme changes)\n        self._clear_params_layout()\n\n        # è§£æç”Ÿæˆå‚æ•°\n        params = self.image_data.get('parameters', '{}')\n        if isinstance(params, str):\n            try:\n                params = json.loads(params)\n            except:\n                params = {}\n        \n        # æç¤ºè¯åŒºåŸŸï¼ˆå¯æ»šåŠ¨æŸ¥çœ‹å…¨æ–‡ï¼‰\n        prompt_label = QLabel(\"<b>æç¤ºè¯:</b>\")\n        prompt_label.setStyleSheet(\"margin: 0px; padding: 2px 0px;\")\n        unified_style_system.apply_to_widget(prompt_label)\n        self.params_layout.addWidget(prompt_label)\n        \n        # æç¤ºè¯æ–‡æœ¬æ¡†\n        prompt_content = self.image_data.get('prompt', 'æ— æç¤ºè¯')\n        self.prompt_text_edit = QTextEdit()\n        self.prompt_text_edit.setPlainText(prompt_content)\n        self.prompt_text_edit.setReadOnly(True)  # åªè¯»æ¨¡å¼\n        # çº¦ 4 è¡Œé«˜åº¦ï¼ˆæŒ‰å½“å‰å­—ä½“åŠ¨æ€è®¡ç®—ï¼‰ï¼Œé¿å…ä¿¡æ¯åŒºè¿‡é«˜å‹ç¼©å…¶å®ƒå†…å®¹\n        try:\n            line_height = self.prompt_text_edit.fontMetrics().lineSpacing()\n            target_lines = 4\n            vertical_padding = 16  # ä¸å…¨å±€ QTextEdit padding (8*2) å¯¹é½\n            border = 2  # 1px*2\n            height = line_height * target_lines + vertical_padding + border\n            self.prompt_text_edit.setFixedHeight(max(72, int(height)))\n        except Exception:\n            self.prompt_text_edit.setMaximumHeight(96)\n            self.prompt_text_edit.setMinimumHeight(96)\n        self.prompt_text_edit.setVerticalScrollBarPolicy(Qt.ScrollBarAsNeeded)\n        self.prompt_text_edit.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)\n        unified_style_system.apply_to_widget(self.prompt_text_edit)\n        # åº”ç”¨ä¸ _update_theme ä¸€è‡´çš„é¢å¤–æ ·å¼\n        colors = unified_style_system.get_colors()\n        bg_input = colors.get('palette.neutral.bg_input') or colors.get('palette.neutral.bg_card')\n        text_color = colors.get('text') or colors.get('palette.text.primary')\n        border_subtle = colors.get('palette.neutral.border_subtle') or colors.get('border')\n        brand = colors.get('palette.brand.main') or colors.get('primary')\n        self.prompt_text_edit.setStyleSheet(f\"\"\"\n            QTextEdit {{\n                background-color: {bg_input};\n                color: {text_color};\n                border: 1px solid {border_subtle};\n                border-radius: 8px;\n                padding: 8px;\n            }}\n            QTextEdit:focus {{\n                border-color: {brand};\n            }}\n        \"\"\")\n        self.params_layout.addWidget(self.prompt_text_edit)\n        \n        # æ·»åŠ å¤åˆ¶æç¤ºè¯æŒ‰é’®ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„ SecondaryButton æ ·å¼ï¼‰\n        self.copy_prompt_btn = QPushButton(\"å¤åˆ¶æç¤ºè¯\")\n        self.copy_prompt_btn.setObjectName(\"SecondaryButton\")\n        self.copy_prompt_btn.setMaximumHeight(30)\n        unified_style_system.apply_to_widget(self.copy_prompt_btn)\n        self.copy_prompt_btn.clicked.connect(self.copy_prompt)\n        self.params_layout.addWidget(self.copy_prompt_btn)\n        \n        # å­˜å‚¨å‚æ•°æ ‡ç­¾åˆ—è¡¨ï¼Œç”¨äºåç»­æ¸…ç†\n        self.param_labels = []\n        self.create_param_labels()\n\n    def _clear_params_layout(self):\n        \"\"\"æ¸…ç©ºå‚æ•°åŒºå¸ƒå±€ä¸­çš„æ‰€æœ‰æ§ä»¶ï¼ˆä¿ç•™å¸ƒå±€æœ¬èº«ï¼‰ï¼Œé¿å…é‡å¤/é®æŒ¡ã€‚\"\"\"\n        if not hasattr(self, \"params_layout\") or self.params_layout is None:\n            return\n        while self.params_layout.count() > 0:\n            item = self.params_layout.takeAt(0)\n            w = item.widget()\n            if w is not None:\n                w.hide()  # ç«‹å³éšè—ï¼Œé¿å… deleteLater å¼‚æ­¥å¯¼è‡´æ®‹ç•™æ˜¾ç¤º\n                w.setParent(None)  # æ–­å¼€çˆ¶å­å…³ç³»\n                w.deleteLater()\n    \n    def _update_theme(self):\n        \"\"\"å“åº”ä¸»é¢˜å˜åŒ–\"\"\"\n        colors = unified_style_system.get_colors()\n        logger.info(f\"[ImageDetailDialog] _update_theme called. Surface color: {colors.get('palette.neutral.bg_surface')}\")\n        \n        # Apply theme to self (Dialog)\n        bg_color = colors.get('palette.neutral.bg_surface') or colors.get('palette.neutral.bg_app') or colors.get('background')\n        text_color = colors.get('text') or colors.get('palette.text.primary')\n        bg_card = colors.get('palette.neutral.bg_card') or colors.get('surface') or bg_color\n        bg_input = colors.get('palette.neutral.bg_input') or bg_card\n        border_subtle = colors.get('palette.neutral.border_subtle') or colors.get('border')\n        brand = colors.get('palette.brand.main') or colors.get('primary') or text_color\n        \n        self.setStyleSheet(f\"\"\"\n            QDialog {{\n                background-color: {bg_color};\n                color: {text_color};\n            }}\n            QLabel {{\n                color: {text_color};\n            }}\n            QWidget#ParamsWidget {{\n                 background-color: {bg_card};\n                 border-left: 1px solid {border_subtle};\n            }}\n        \"\"\")\n\n        if hasattr(self, 'prompt_text_edit'):\n            self.prompt_text_edit.setStyleSheet(f\"\"\"\n                QTextEdit {{\n                    background-color: {bg_input};\n                    color: {text_color};\n                    border: 1px solid {border_subtle};\n                    border-radius: 8px;\n                    padding: 8px;\n                }}\n                QTextEdit:focus {{\n                    border-color: {brand};\n                }}\n            \"\"\")\n\n        # Reapply button styles\n        if hasattr(self, 'fullscreen_btn'):\n            unified_style_system.apply_to_widget(self.fullscreen_btn)\n        if hasattr(self, 'copy_image_btn'):\n            unified_style_system.apply_to_widget(self.copy_image_btn)\n        if hasattr(self, 'delete_btn'):\n            unified_style_system.apply_to_widget(self.delete_btn, extra={'variant': 'danger'})\n        if hasattr(self, 'close_btn'):\n            unified_style_system.apply_to_widget(self.close_btn)\n        if hasattr(self, 'reference_export_btn'):\n            unified_style_system.apply_to_widget(self.reference_export_btn)\n        if hasattr(self, 'export_bundle_btn'):\n            unified_style_system.apply_to_widget(self.export_bundle_btn)\n        if hasattr(self, 'prev_btn'):\n            unified_style_system.apply_to_widget(self.prev_btn)\n        if hasattr(self, 'next_btn'):\n            unified_style_system.apply_to_widget(self.next_btn)\n\n        # Rebuild to ensure all param widgets pick up new palette and no stale widgets remain\n        self.setup_params_area()\n\n    def create_param_labels(self):\n        \"\"\"åˆ›å»ºå‚æ•°æ ‡ç­¾ï¼ˆåˆå§‹åŒ–æˆ–æ›´æ–°æ—¶è°ƒç”¨ï¼‰\"\"\"\n        # æ¸…é™¤æ—§çš„å‚æ•°æ ‡ç­¾ - Fix Race Condition\n        if hasattr(self, 'param_labels'):\n            for label_pair in self.param_labels:\n                # å¿…é¡»å…ˆä»å¸ƒå±€ä¸­ç§»é™¤ï¼Œé˜²æ­¢ deleteLater çš„å¼‚æ­¥é”€æ¯å¯¼è‡´é‡å½±\n                self.params_layout.removeWidget(label_pair[0])\n                self.params_layout.removeWidget(label_pair[1])\n                label_pair[0].deleteLater()  # åˆ é™¤æ ‡é¢˜æ ‡ç­¾\n                label_pair[1].deleteLater()  # åˆ é™¤å€¼æ ‡ç­¾\n            self.param_labels.clear()\n        else:\n            self.param_labels = []\n        \n        # è§£æç”Ÿæˆå‚æ•°\n        params = self.image_data.get('parameters', '{}')\n        if isinstance(params, str):\n            try:\n                params = json.loads(params)\n            except:\n                params = {}\n        \n        # è¯¦ç»†ä¿¡æ¯\n        info_items = [\n            (\"å°ºå¯¸\", f\"{params.get('size', 'æœªçŸ¥')}\"),\n            (\"ç§å­å€¼\", f\"{params.get('seed', 'æœªçŸ¥')}\"),\n            (\"å¼•å¯¼å¼ºåº¦\", f\"{params.get('guidance_scale', 'æœªçŸ¥')}\"),\n            (\"ç”Ÿæˆæ¨¡å‹\", f\"{params.get('model', 'æœªçŸ¥æ¨¡å‹')}\"),\n            (\"ç”Ÿæˆæ—¶é—´\", self.format_time(self.image_data.get('created_at', ''))),\n            (\"æ–‡ä»¶å¤§å°\", self.format_file_size(self.image_data.get('file_size', 0))),\n            (\"æ–‡ä»¶è·¯å¾„\", self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')),\n        ]\n        \n        # å¦‚æœæ˜¯å›¾ç”Ÿå›¾ï¼Œæ˜¾ç¤ºå‚è€ƒå›¾ä¿¡æ¯\n        if params.get('model', '').find('i2i') != -1:\n            info_items.insert(-2, (\"ç”Ÿæˆç±»å‹\", \"å›¾ç”Ÿå›¾\"))\n            input_image = self.image_data.get('input_image', '')\n            if input_image:\n                info_items.insert(-2, (\"å‚è€ƒå›¾ç‰‡\", input_image))\n        else:\n            info_items.insert(-2, (\"ç”Ÿæˆç±»å‹\", \"æ–‡ç”Ÿå›¾\"))\n        \n        colors = unified_style_system.get_colors()\n        bg_tag = colors.get('palette.neutral.bg_surface') or colors.get('palette.neutral.bg_card') or colors.get('surface')\n        border_tag = colors.get('palette.neutral.border_subtle') or colors.get('border')\n        text_tag = colors.get('text') or colors.get('palette.text.primary')\n        hover_bg = colors.get('palette.neutral.bg_hover') or bg_tag\n        hover_border = colors.get('palette.brand.main') or colors.get('primary') or border_tag\n\n        for label, value in info_items:\n            label_widget = QLabel(f\"<b>{label}:</b>\")\n            label_widget.setStyleSheet(\"margin: 0px; padding: 2px 0px;\")\n            unified_style_system.apply_to_widget(label_widget)\n            self.params_layout.addWidget(label_widget)\n            \n            # ä½¿ç”¨å¯ç‚¹å‡»çš„æ ‡ç­¾\n            value_clickable = ClickableLabel(str(value))\n            value_clickable.set_text_with_ellipsis(str(value), int(self.width() * 0.25))\n            # File path is long and can otherwise expand to fill the panel, overlapping the prompt area.\n            # Keep it single-line with ellipsis and fixed height.\n            if label == \"æ–‡ä»¶è·¯å¾„\":\n                value_clickable.setWordWrap(False)\n                value_clickable.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)\n                value_clickable.setFixedHeight(32)\n                value_clickable.setToolTip(str(value))\n            else:\n                value_clickable.setWordWrap(True)\n            # ä½¿ç”¨åŠ¨æ€æ ·å¼\n            value_clickable.setStyleSheet(f\"\"\"\n                QLabel {{\n                    margin: 0px; \n                    padding: 6px; \n                    background-color: {bg_tag}; \n                    color: {text_tag};\n                    border: 1px solid {border_tag};\n                    border-radius: 4px;\n                }}\n                QLabel:hover {{\n                    background-color: {hover_bg};\n                    border-color: {hover_border};\n                }}\n            \"\"\")\n            unified_style_system.apply_to_widget(value_clickable)\n            value_clickable.clicked.connect(self.copy_text_to_clipboard)\n            self.params_layout.addWidget(value_clickable)\n            \n            # ä¿å­˜æ ‡ç­¾å¼•ç”¨\n            self.param_labels.append((label_widget, value_clickable))\n\n        # Ensure remaining vertical space doesn't get assigned to the last label widget.\n        self.params_layout.addStretch(1)\n    \n    def update_params_area(self):\n        \"\"\"æ›´æ–°å‚æ•°æ˜¾ç¤ºåŒºåŸŸï¼ˆåˆ‡æ¢å›¾ç‰‡æ—¶è°ƒç”¨ï¼‰\"\"\"\n        # Full rebuild avoids duplicated/stale widgets (e.g. file path blocks prompt area)\n        self.setup_params_area()\n\n    def closeEvent(self, event):\n        try:\n            if hasattr(self, '_focus_timer') and self._focus_timer.isActive():\n                self._focus_timer.stop()\n        except Exception:\n            pass\n\n        try:\n            self._export_controller.dispose()\n        except Exception:\n            pass\n\n        super().closeEvent(event)\n    \n    def keyPressEvent(self, event):\n        \"\"\"é”®ç›˜äº‹ä»¶å¤„ç†\"\"\"\n        from PySide6.QtCore import Qt\n        \n        logger.debug(f\"[KEYBOARD] ImageDetailDialogé”®ç›˜äº‹ä»¶: {event.key()}\")\n        \n        if event.key() == Qt.Key_Left:\n            # å·¦æ–¹å‘é”®ï¼šä¸Šä¸€å¼ å›¾ç‰‡\n            if self.prev_btn.isEnabled():\n                self.show_previous_image()\n            event.accept()\n        elif event.key() == Qt.Key_Right:\n            # å³æ–¹å‘é”®ï¼šä¸‹ä¸€å¼ å›¾ç‰‡\n            if self.next_btn.isEnabled():\n                self.show_next_image()\n            event.accept()\n        elif event.key() == Qt.Key_Escape:\n            # ESCé”®ï¼šå…³é—­å¯¹è¯æ¡†ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰\n            logger.debug(f\"[KEYBOARD] ESCé”®pressedï¼Œfullscreen: {self.is_fullscreen}\")\n            if self.is_fullscreen:\n                self.exit_fullscreen()\n            else:\n                self.accept()\n            event.accept()\n        elif event.key() == Qt.Key_F11:\n            # F11é”®ï¼šå…¨å±åˆ‡æ¢ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰\n            self.toggle_fullscreen()\n            event.accept()\n        else:\n            # å…¶ä»–æŒ‰é”®äº¤ç»™çˆ¶ç±»å¤„ç†\n            super().keyPressEvent(event)\n","numLines":958,"startLine":1,"totalLines":958}}}
{"parentUuid":"cb28d405-5e7d-4e2e-aa4e-4fffd14a2446","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"831827d4-8f64-40eb-a2ca-946ae836d86c","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"a7727ab","slug":"smooth-dazzling-bear","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01BG8Qf8qkVBwuaCEoVTQErJ","type":"message","role":"assistant","content":[{"type":"text","text":"ç°åœ¨è®©æˆ‘æœç´¢ç›¸å…³çš„æ ·å¼ç³»ç»Ÿå’Œå‚æ•°ç›¸å…³çš„ç»„ä»¶æ–‡ä»¶ï¼š"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":21368,"cache_creation_input_tokens":15805,"cache_read_input_tokens":20857,"cache_creation":{"ephemeral_5m_input_tokens":15805,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"1fc5b696-c4b9-47fd-9b7f-ca883fd11da9","timestamp":"2025-12-22T04:37:10.420Z"}
{"parentUuid":"1fc5b696-c4b9-47fd-9b7f-ca883fd11da9","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"831827d4-8f64-40eb-a2ca-946ae836d86c","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"a7727ab","slug":"smooth-dazzling-bear","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01BG8Qf8qkVBwuaCEoVTQErJ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01M9Cu7whkA4ALze49vg9DTx","name":"Glob","input":{"pattern":"components/widgets/*.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":21368,"cache_creation_input_tokens":15805,"cache_read_input_tokens":20857,"cache_creation":{"ephemeral_5m_input_tokens":15805,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"29b02f91-3199-41d8-b81a-11c978fee6b4","timestamp":"2025-12-22T04:37:10.639Z"}
{"parentUuid":"29b02f91-3199-41d8-b81a-11c978fee6b4","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"831827d4-8f64-40eb-a2ca-946ae836d86c","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"a7727ab","slug":"smooth-dazzling-bear","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01BG8Qf8qkVBwuaCEoVTQErJ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CyQR541pjMhoc8z8JB115Y","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/utils/style_system.py","limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":21368,"cache_creation_input_tokens":15805,"cache_read_input_tokens":20857,"cache_creation":{"ephemeral_5m_input_tokens":15805,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"37d06004-b6ea-40f4-8800-8ed61dd3c21f","timestamp":"2025-12-22T04:37:11.172Z"}
{"parentUuid":"37d06004-b6ea-40f4-8800-8ed61dd3c21f","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"831827d4-8f64-40eb-a2ca-946ae836d86c","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"a7727ab","slug":"smooth-dazzling-bear","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CyQR541pjMhoc8z8JB115Y","type":"tool_result","content":"     1â†’\"\"\"ç»Ÿä¸€çš„æ ·å¼ç®¡ç†ç³»ç»Ÿ - å¢å¼ºç‰ˆ\"\"\"\n     2â†’\n     3â†’from PySide6.QtWidgets import (\n     4â†’    QApplication, QWidget, QLabel, QComboBox, QPushButton,\n     5â†’    QSpinBox, QDoubleSpinBox, QSlider, QCheckBox, QGroupBox,\n     6â†’    QTextEdit, QLineEdit, QRadioButton, QScrollArea, QProgressBar,\n     7â†’    QListWidget, QListView, QTableWidget, QTableView, QTreeWidget,\n     8â†’    QTreeView, QTabWidget, QToolButton, QMenuBar, QMenu, QToolBar\n     9â†’)\n    10â†’from PySide6.QtCore import QObject, Signal, Qt\n    11â†’from PySide6.QtGui import QFont, QPalette, QColor\n    12â†’from typing import Optional, Dict, Any, Type, List\n    13â†’import re\n    14â†’from utils.theme_engine import theme_engine\n    15â†’\n    16â†’\n    17â†’class UnifiedStyleSystem(QObject):\n    18â†’    \"\"\"ç»Ÿä¸€çš„æ ·å¼ç®¡ç†ç³»ç»Ÿ - å¢å¼ºç‰ˆ\n    19â†’    \n    20â†’    è´Ÿè´£ç®¡ç†æ‰€æœ‰UIç»„ä»¶çš„æ ·å¼ï¼Œç¡®ä¿å­—ä½“å¤§å°å¯ä»¥ç»Ÿä¸€ç¼©æ”¾\n    21â†’    æ”¯æŒç»„ä»¶ç±»å‹è‡ªåŠ¨è¯†åˆ«å’Œæ ·å¼ç»§æ‰¿\n    22â†’    \"\"\"\n    23â†’    \n    24â†’    styleChanged = Signal()\n    25â†’    \n    26â†’    _instance: Optional['UnifiedStyleSystem'] = None\n    27â†’    \n    28â†’    def __new__(cls):\n    29â†’        if cls._instance is None:\n    30â†’            cls._instance = super().__new__(cls)\n    31â†’        return cls._instance\n    32â†’    \n    33â†’    def __init__(self):\n    34â†’        # å…ˆè°ƒç”¨çˆ¶ç±»åˆå§‹åŒ–\n    35â†’        super().__init__()\n    36â†’        \n    37â†’        # æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰\n    38â†’        if hasattr(self, '_initialized') and self._initialized:\n    39â†’            return\n    40â†’            \n    41â†’        self._initialized = True\n    42â†’        self._base_font_size = 12\n    43â†’        self._font_scale = 1.0\n    44â†’        self._style_cache: Dict[str, str] = {}\n    45â†’        self._widget_registry: Dict[int, str] = {}  # è®°å½•widget IDåˆ°ç±»å‹çš„æ˜ å°„\n    46â†’\n    47â†’        # è¿æ¥ä¸»é¢˜åŠ è½½ä¿¡å·ï¼Œå®ç°è§£è€¦\n    48â†’        theme_engine.themeLoaded.connect(self._on_theme_loaded)\n    49â†’\n    50â†’    def _on_theme_loaded(self):\n    51â†’        \"\"\"ä¸»é¢˜åŠ è½½å®Œæˆåè‡ªåŠ¨åˆ·æ–°æ ·å¼\"\"\"\n    52â†’        self.apply_theme()\n    53â†’        \n    54â†’        # ç»„ä»¶ç±»å‹æ˜ å°„è¡¨\n    55â†’        self._widget_type_map = {\n    56â†’            QLabel: \"QLabel\",\n    57â†’            QComboBox: \"QComboBox\",\n    58â†’            QPushButton: \"QPushButton\",\n    59â†’            QSpinBox: \"QSpinBox\",\n    60â†’            QDoubleSpinBox: \"QDoubleSpinBox\",\n    61â†’            QSlider: \"QSlider\",\n    62â†’            QCheckBox: \"QCheckBox\",\n    63â†’            QRadioButton: \"QRadioButton\",\n    64â†’            QGroupBox: \"QGroupBox\",\n    65â†’            QTextEdit: \"QTextEdit\",\n    66â†’            QLineEdit: \"QLineEdit\",\n    67â†’            QScrollArea: \"QScrollArea\",\n    68â†’            QProgressBar: \"QProgressBar\",\n    69â†’            QListWidget: \"QListWidget\",\n    70â†’            QListView: \"QListView\",\n    71â†’            QTableWidget: \"QTableWidget\",\n    72â†’            QTableView: \"QTableView\",\n    73â†’            QTreeWidget: \"QTreeWidget\",\n    74â†’            QTreeView: \"QTreeView\",\n    75â†’            QTabWidget: \"QTabWidget\",\n    76â†’            QToolButton: \"QToolButton\",\n    77â†’            QMenuBar: \"QMenuBar\",\n    78â†’            QMenu: \"QMenu\",\n    79â†’            QToolBar: \"QToolBar\"\n    80â†’        }\n    81â†’\n    82â†’    def identify_widget_type(self, widget: QWidget) -> str:\n    83â†’        \"\"\"æ™ºèƒ½è¯†åˆ«ç»„ä»¶ç±»å‹\n    84â†’        \n    85â†’        ä¼˜å…ˆä½¿ç”¨ç²¾ç¡®ç±»ååŒ¹é…ï¼Œé¿å… isinstance è¯¯åˆ¤å¯¼è‡´å­ç±»è¢«è¯†åˆ«ä¸ºçˆ¶ç±»\n    86â†’        \"\"\"\n    87â†’        # é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ³¨å†Œçš„ç±»å‹\n    88â†’        widget_id = id(widget)\n    89â†’        if widget_id in self._widget_registry:\n    90â†’            return self._widget_registry[widget_id]\n    91â†’        \n    92â†’        # ä¼˜å…ˆï¼šç²¾ç¡®ç±»ååŒ¹é…ï¼ˆæœ€å¯é ï¼‰\n    93â†’        class_name = widget.__class__.__name__\n    94â†’        known_types = {\n    95â†’            'QSpinBox', 'QDoubleSpinBox', 'QComboBox', 'QLineEdit',\n    96â†’            'QPushButton', 'QLabel', 'QCheckBox', 'QRadioButton',\n    97â†’            'QSlider', 'QGroupBox', 'QTextEdit', 'QScrollArea',\n    98â†’            'QProgressBar', 'QListWidget', 'QListView', 'QTableWidget',\n    99â†’            'QTableView', 'QTreeWidget', 'QTreeView', 'QTabWidget',\n   100â†’            'QToolButton', 'QMenuBar', 'QMenu', 'QToolBar'\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"ee8780b3-b70f-42ff-a77d-3723776b9f7c","timestamp":"2025-12-22T04:37:11.236Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/utils/style_system.py","content":"\"\"\"ç»Ÿä¸€çš„æ ·å¼ç®¡ç†ç³»ç»Ÿ - å¢å¼ºç‰ˆ\"\"\"\n\nfrom PySide6.QtWidgets import (\n    QApplication, QWidget, QLabel, QComboBox, QPushButton,\n    QSpinBox, QDoubleSpinBox, QSlider, QCheckBox, QGroupBox,\n    QTextEdit, QLineEdit, QRadioButton, QScrollArea, QProgressBar,\n    QListWidget, QListView, QTableWidget, QTableView, QTreeWidget,\n    QTreeView, QTabWidget, QToolButton, QMenuBar, QMenu, QToolBar\n)\nfrom PySide6.QtCore import QObject, Signal, Qt\nfrom PySide6.QtGui import QFont, QPalette, QColor\nfrom typing import Optional, Dict, Any, Type, List\nimport re\nfrom utils.theme_engine import theme_engine\n\n\nclass UnifiedStyleSystem(QObject):\n    \"\"\"ç»Ÿä¸€çš„æ ·å¼ç®¡ç†ç³»ç»Ÿ - å¢å¼ºç‰ˆ\n    \n    è´Ÿè´£ç®¡ç†æ‰€æœ‰UIç»„ä»¶çš„æ ·å¼ï¼Œç¡®ä¿å­—ä½“å¤§å°å¯ä»¥ç»Ÿä¸€ç¼©æ”¾\n    æ”¯æŒç»„ä»¶ç±»å‹è‡ªåŠ¨è¯†åˆ«å’Œæ ·å¼ç»§æ‰¿\n    \"\"\"\n    \n    styleChanged = Signal()\n    \n    _instance: Optional['UnifiedStyleSystem'] = None\n    \n    def __new__(cls):\n        if cls._instance is None:\n            cls._instance = super().__new__(cls)\n        return cls._instance\n    \n    def __init__(self):\n        # å…ˆè°ƒç”¨çˆ¶ç±»åˆå§‹åŒ–\n        super().__init__()\n        \n        # æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰\n        if hasattr(self, '_initialized') and self._initialized:\n            return\n            \n        self._initialized = True\n        self._base_font_size = 12\n        self._font_scale = 1.0\n        self._style_cache: Dict[str, str] = {}\n        self._widget_registry: Dict[int, str] = {}  # è®°å½•widget IDåˆ°ç±»å‹çš„æ˜ å°„\n\n        # è¿æ¥ä¸»é¢˜åŠ è½½ä¿¡å·ï¼Œå®ç°è§£è€¦\n        theme_engine.themeLoaded.connect(self._on_theme_loaded)\n\n    def _on_theme_loaded(self):\n        \"\"\"ä¸»é¢˜åŠ è½½å®Œæˆåè‡ªåŠ¨åˆ·æ–°æ ·å¼\"\"\"\n        self.apply_theme()\n        \n        # ç»„ä»¶ç±»å‹æ˜ å°„è¡¨\n        self._widget_type_map = {\n            QLabel: \"QLabel\",\n            QComboBox: \"QComboBox\",\n            QPushButton: \"QPushButton\",\n            QSpinBox: \"QSpinBox\",\n            QDoubleSpinBox: \"QDoubleSpinBox\",\n            QSlider: \"QSlider\",\n            QCheckBox: \"QCheckBox\",\n            QRadioButton: \"QRadioButton\",\n            QGroupBox: \"QGroupBox\",\n            QTextEdit: \"QTextEdit\",\n            QLineEdit: \"QLineEdit\",\n            QScrollArea: \"QScrollArea\",\n            QProgressBar: \"QProgressBar\",\n            QListWidget: \"QListWidget\",\n            QListView: \"QListView\",\n            QTableWidget: \"QTableWidget\",\n            QTableView: \"QTableView\",\n            QTreeWidget: \"QTreeWidget\",\n            QTreeView: \"QTreeView\",\n            QTabWidget: \"QTabWidget\",\n            QToolButton: \"QToolButton\",\n            QMenuBar: \"QMenuBar\",\n            QMenu: \"QMenu\",\n            QToolBar: \"QToolBar\"\n        }\n\n    def identify_widget_type(self, widget: QWidget) -> str:\n        \"\"\"æ™ºèƒ½è¯†åˆ«ç»„ä»¶ç±»å‹\n        \n        ä¼˜å…ˆä½¿ç”¨ç²¾ç¡®ç±»ååŒ¹é…ï¼Œé¿å… isinstance è¯¯åˆ¤å¯¼è‡´å­ç±»è¢«è¯†åˆ«ä¸ºçˆ¶ç±»\n        \"\"\"\n        # é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ³¨å†Œçš„ç±»å‹\n        widget_id = id(widget)\n        if widget_id in self._widget_registry:\n            return self._widget_registry[widget_id]\n        \n        # ä¼˜å…ˆï¼šç²¾ç¡®ç±»ååŒ¹é…ï¼ˆæœ€å¯é ï¼‰\n        class_name = widget.__class__.__name__\n        known_types = {\n            'QSpinBox', 'QDoubleSpinBox', 'QComboBox', 'QLineEdit',\n            'QPushButton', 'QLabel', 'QCheckBox', 'QRadioButton',\n            'QSlider', 'QGroupBox', 'QTextEdit', 'QScrollArea',\n            'QProgressBar', 'QListWidget', 'QListView', 'QTableWidget',\n            'QTableView', 'QTreeWidget', 'QTreeView', 'QTabWidget',\n            'QToolButton', 'QMenuBar', 'QMenu', 'QToolBar'","numLines":100,"startLine":1,"totalLines":1078}}}
{"parentUuid":"ee8780b3-b70f-42ff-a77d-3723776b9f7c","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"831827d4-8f64-40eb-a2ca-946ae836d86c","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"a7727ab","slug":"smooth-dazzling-bear","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01M9Cu7whkA4ALze49vg9DTx","type":"tool_result","content":"/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/__init__.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/clickable_label.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/zoomable_text_edit.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/zoomable_image_label.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/mode_button.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/reference_images_simple.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/video_image_upload_panel.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/reference_assets_panel.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/toast_manager.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/image_preview_dialog.py\n/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/integrated_reference_panel.py"}]},"uuid":"87f1015a-e2fa-4818-b2a5-b429b04313a3","timestamp":"2025-12-22T04:37:11.275Z","toolUseResult":{"filenames":["/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/__init__.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/clickable_label.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/zoomable_text_edit.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/zoomable_image_label.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/mode_button.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/reference_images_simple.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/video_image_upload_panel.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/reference_assets_panel.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/toast_manager.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/image_preview_dialog.py","/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/integrated_reference_panel.py"],"durationMs":49,"numFiles":11,"truncated":false}}
{"parentUuid":"87f1015a-e2fa-4818-b2a5-b429b04313a3","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"831827d4-8f64-40eb-a2ca-946ae836d86c","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"a7727ab","slug":"smooth-dazzling-bear","message":{"model":"claude-haiku-4-5-20251001","id":"msg_012XU9zaTFE49RVcjC1Eppqp","type":"message","role":"assistant","content":[{"type":"text","text":"ç°åœ¨è®©æˆ‘æŸ¥çœ‹ ClickableLabel ç»„ä»¶ï¼š"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1603,"cache_creation_input_tokens":21881,"cache_read_input_tokens":36662,"cache_creation":{"ephemeral_5m_input_tokens":21881,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"51eb07e6-a27d-4873-b861-f4153c208f46","timestamp":"2025-12-22T04:37:16.270Z"}
{"parentUuid":"51eb07e6-a27d-4873-b861-f4153c208f46","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"831827d4-8f64-40eb-a2ca-946ae836d86c","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"a7727ab","slug":"smooth-dazzling-bear","message":{"model":"claude-haiku-4-5-20251001","id":"msg_012XU9zaTFE49RVcjC1Eppqp","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018NBBKEWvnYLXoSthQ3JN4r","name":"Read","input":{"file_path":"/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/clickable_label.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1603,"cache_creation_input_tokens":21881,"cache_read_input_tokens":36662,"cache_creation":{"ephemeral_5m_input_tokens":21881,"ephemeral_1h_input_tokens":0},"output_tokens":93,"service_tier":"standard"}},"type":"assistant","uuid":"1886a788-9113-4648-8bf6-983feb8d10f7","timestamp":"2025-12-22T04:37:16.791Z"}
{"parentUuid":"1886a788-9113-4648-8bf6-983feb8d10f7","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"831827d4-8f64-40eb-a2ca-946ae836d86c","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"a7727ab","slug":"smooth-dazzling-bear","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018NBBKEWvnYLXoSthQ3JN4r","type":"tool_result","content":"     1â†’#!/usr/bin/env python3\n     2â†’# -*- coding: utf-8 -*-\n     3â†’\"\"\"Clickable label extracted from qt_app.\"\"\"\n     4â†’\n     5â†’from __future__ import annotations\n     6â†’\n     7â†’from PySide6.QtCore import Signal, Qt\n     8â†’from PySide6.QtWidgets import QLabel\n     9â†’\n    10â†’class ClickableLabel(QLabel):\n    11â†’    \"\"\"å¯ç‚¹å‡»çš„æ ‡ç­¾ï¼Œæ”¯æŒå¤åˆ¶åŠŸèƒ½\"\"\"\n    12â†’    \n    13â†’    clicked = Signal(str)  # ç‚¹å‡»ä¿¡å·ï¼Œä¼ é€’æ–‡æœ¬å†…å®¹\n    14â†’    \n    15â†’    def __init__(self, text=\"\", parent=None):\n    16â†’        super().__init__(text, parent)\n    17â†’        self.full_text = text\n    18â†’        self.setCursor(Qt.PointingHandCursor)\n    19â†’        \n    20â†’    def mousePressEvent(self, event):\n    21â†’        \"\"\"é¼ æ ‡ç‚¹å‡»äº‹ä»¶\"\"\"\n    22â†’        if event.button() == Qt.LeftButton:\n    23â†’            self.clicked.emit(self.full_text)\n    24â†’        super().mousePressEvent(event)\n    25â†’        \n    26â†’    def set_text_with_ellipsis(self, text: str, max_width: int):\n    27â†’        \"\"\"è®¾ç½®æ–‡æœ¬ï¼Œè¶…å‡ºå®½åº¦æ—¶æ˜¾ç¤ºçœç•¥å·\"\"\"\n    28â†’        self.full_text = text\n    29â†’        \n    30â†’        # ä½¿ç”¨å­—ä½“åº¦é‡è®¡ç®—æ–‡æœ¬å®½åº¦\n    31â†’        font_metrics = self.fontMetrics()\n    32â†’        elided_text = font_metrics.elidedText(text, Qt.ElideRight, max_width)\n    33â†’        self.setText(elided_text)\n    34â†’\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"679db18a-428a-4902-8fe9-f31b8b0347da","timestamp":"2025-12-22T04:37:16.845Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/yunchang/Documents/GitHub/gemeng2/components/widgets/clickable_label.py","content":"#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n\"\"\"Clickable label extracted from qt_app.\"\"\"\n\nfrom __future__ import annotations\n\nfrom PySide6.QtCore import Signal, Qt\nfrom PySide6.QtWidgets import QLabel\n\nclass ClickableLabel(QLabel):\n    \"\"\"å¯ç‚¹å‡»çš„æ ‡ç­¾ï¼Œæ”¯æŒå¤åˆ¶åŠŸèƒ½\"\"\"\n    \n    clicked = Signal(str)  # ç‚¹å‡»ä¿¡å·ï¼Œä¼ é€’æ–‡æœ¬å†…å®¹\n    \n    def __init__(self, text=\"\", parent=None):\n        super().__init__(text, parent)\n        self.full_text = text\n        self.setCursor(Qt.PointingHandCursor)\n        \n    def mousePressEvent(self, event):\n        \"\"\"é¼ æ ‡ç‚¹å‡»äº‹ä»¶\"\"\"\n        if event.button() == Qt.LeftButton:\n            self.clicked.emit(self.full_text)\n        super().mousePressEvent(event)\n        \n    def set_text_with_ellipsis(self, text: str, max_width: int):\n        \"\"\"è®¾ç½®æ–‡æœ¬ï¼Œè¶…å‡ºå®½åº¦æ—¶æ˜¾ç¤ºçœç•¥å·\"\"\"\n        self.full_text = text\n        \n        # ä½¿ç”¨å­—ä½“åº¦é‡è®¡ç®—æ–‡æœ¬å®½åº¦\n        font_metrics = self.fontMetrics()\n        elided_text = font_metrics.elidedText(text, Qt.ElideRight, max_width)\n        self.setText(elided_text)\n","numLines":34,"startLine":1,"totalLines":34}}}
{"parentUuid":"679db18a-428a-4902-8fe9-f31b8b0347da","isSidechain":true,"userType":"external","cwd":"/Users/yunchang/Documents/GitHub/gemeng2","sessionId":"831827d4-8f64-40eb-a2ca-946ae836d86c","version":"2.0.75","gitBranch":"refactor/ui-v2-linear","agentId":"a7727ab","slug":"smooth-dazzling-bear","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01So1hNJDh1vqNbAxbvv3f9h","type":"message","role":"assistant","content":[{"type":"text","text":"å®Œç¾ã€‚ç°åœ¨æˆ‘å·²ç»æœ‰äº†å®Œæ•´çš„ä»£ç åˆ†æã€‚è®©æˆ‘ç”Ÿæˆè¯¦ç»†çš„åˆ†ææŠ¥å‘Šã€‚\n\n## æ·±å…¥åˆ†æï¼šImageDetailDialog å‚æ•°åŒºåŠ¨æ€å¸ƒå±€\n\næˆ‘å·²å®Œæ•´åˆ†æäº† `image_detail_dialog.py` å’Œ `video_detail_dialog.py` ä¸­å‚æ•°åŒºçš„åŠ¨æ€å¸ƒå±€ç»“æ„ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„å‘ç°å’Œå»ºè®®ã€‚\n\n### 1. å‚æ•°åŒºçš„å®Œæ•´ç»“æ„\n\n**å¸ƒå±€å±‚çº§å…³ç³»**ï¼š\n```\nparams_widget (QWidget) - å›ºå®šå®½åº¦ 30%\n  â””â”€ self.params_layout (QVBoxLayout)\n      â”œâ”€ \"æç¤ºè¯:\" æ ‡ç­¾ (QLabel)\n      â”œâ”€ æç¤ºè¯æ–‡æœ¬æ¡† (self.prompt_text_edit - QTextEdit)\n      â”œâ”€ \"å¤åˆ¶æç¤ºè¯\" æŒ‰é’® (self.copy_prompt_btn - QPushButton)\n      â”œâ”€ å‚æ•°æ ‡ç­¾å¯¹é›†åˆ (self.param_labels - list)\n      â”‚  â””â”€ (label_widget, value_clickable)å¯¹ Ã— N\n      â”‚      â”œâ”€ å‚æ•°æ ‡ç­¾ (QLabel)\n      â”‚      â””â”€ å‚æ•°å€¼ (ClickableLabel)\n      â””â”€ Stretch å ä½ç¬¦\n```\n\n### 2. å‚æ•°æ˜¾ç¤ºä¸åŠ¨æ€é‡å»ºçš„å…³é”®ä»£ç \n\n**æ ¸å¿ƒæ–¹æ³•è°ƒç”¨é“¾**ï¼š\n\n| æ–¹æ³• | è§¦å‘æ—¶æœº | ä½œç”¨ |\n|------|--------|------|\n| `setup_params_area()` | åˆå§‹åŒ– + ä¸»é¢˜å˜åŒ– + åˆ‡æ¢è®°å½• | å®Œå…¨æ¸…ç©ºå¹¶é‡å»ºæ•´ä¸ªå‚æ•°åŒº |\n| `_clear_params_layout()` | åœ¨ `setup_params_area()` å¼€å¤´ | æ¸…ç©ºæ‰€æœ‰æ§ä»¶ï¼Œé¿å…é‡å¤ |\n| `create_param_labels()` | åœ¨ `setup_params_area()` ç»“å°¾ | åˆ›å»ºå‚æ•°æ ‡ç­¾å¯¹ |\n| `update_params_area()` | åˆ‡æ¢å›¾ç‰‡æ—¶è°ƒç”¨ | å®é™…ä¸Šè°ƒç”¨ `setup_params_area()` |\n\n**å…³é”®ä»£ç ç‰‡æ®µï¼ˆç¬¬672-741è¡Œï¼‰**ï¼š\n\n```python\ndef setup_params_area(self):\n    \"\"\"åˆå§‹åŒ–å‚æ•°æ˜¾ç¤ºåŒºåŸŸ\"\"\"\n    # ç¬¬1æ­¥ï¼šæ¸…ç©ºæ—§æ§ä»¶\n    self._clear_params_layout()\n    \n    # ç¬¬2æ­¥ï¼šåˆ›å»ºæç¤ºè¯åŒºåŸŸï¼ˆå›ºå®šï¼‰\n    prompt_label = QLabel(\"<b>æç¤ºè¯:</b>\")\n    self.params_layout.addWidget(prompt_label)\n    \n    # ç¬¬3æ­¥ï¼šåˆ›å»ºæç¤ºè¯æ–‡æœ¬æ¡†ï¼ˆå›ºå®šï¼‰\n    self.prompt_text_edit = QTextEdit()\n    self.prompt_text_edit.setPlainText(prompt_content)\n    self.params_layout.addWidget(self.prompt_text_edit)\n    \n    # ç¬¬4æ­¥ï¼šåˆ›å»ºå¤åˆ¶æŒ‰é’®ï¼ˆå›ºå®šï¼‰\n    self.copy_prompt_btn = QPushButton(\"å¤åˆ¶æç¤ºè¯\")\n    self.params_layout.addWidget(self.copy_prompt_btn)\n    \n    # ç¬¬5æ­¥ï¼šåˆ›å»ºå‚æ•°æ ‡ç­¾ï¼ˆåŠ¨æ€ï¼‰\n    self.param_labels = []  # é‡ç½®åˆ—è¡¨\n    self.create_param_labels()\n\ndef _clear_params_layout(self):\n    \"\"\"æ¸…ç©ºå‚æ•°åŒºå¸ƒå±€ä¸­çš„æ‰€æœ‰æ§ä»¶\"\"\"\n    while self.params_layout.count() > 0:\n        item = self.params_layout.takeAt(0)\n        w = item.widget()\n        if w is not None:\n            w.hide()      # ç«‹å³éšè—ï¼Œé¿å…å¼‚æ­¥æ˜¾ç¤ºæ®‹ç•™\n            w.setParent(None)  # æ–­å¼€çˆ¶å­å…³ç³»\n            w.deleteLater()  # å¼‚æ­¥é”€æ¯\n```\n\n### 3. å‚æ•°æ ‡ç­¾çš„åˆ›å»ºï¼ˆç¬¬816-903è¡Œï¼‰\n\n**create_param_labels() é€»è¾‘**ï¼š\n\n```python\ndef create_param_labels(self):\n    \"\"\"åˆ›å»ºå‚æ•°æ ‡ç­¾ï¼ˆåˆå§‹åŒ–æˆ–æ›´æ–°æ—¶è°ƒç”¨ï¼‰\"\"\"\n    # æ¸…é™¤æ—§çš„å‚æ•°æ ‡ç­¾\n    if hasattr(self, 'param_labels'):\n        for label_pair in self.param_labels:\n            self.params_layout.removeWidget(label_pair[0])\n            self.params_layout.removeWidget(label_pair[1])\n            label_pair[0].deleteLater()\n            label_pair[1].deleteLater()\n        self.param_labels.clear()\n    \n    # æ„å»ºå‚æ•°åˆ—è¡¨ï¼ˆåŒ…å«æ¡ä»¶é€»è¾‘ï¼‰\n    info_items = [\n        (\"å°ºå¯¸\", f\"{params.get('size', 'æœªçŸ¥')}\"),\n        (\"ç§å­å€¼\", f\"{params.get('seed', 'æœªçŸ¥')}\"),\n        # ... å…¶ä»–å‚æ•° ...\n    ]\n    \n    # å¦‚æœæ˜¯å›¾ç”Ÿå›¾ï¼Œæ’å…¥å‚è€ƒå›¾ä¿¡æ¯\n    if params.get('model', '').find('i2i') != -1:\n        info_items.insert(-2, (\"ç”Ÿæˆç±»å‹\", \"å›¾ç”Ÿå›¾\"))\n        input_image = self.image_data.get('input_image', '')\n        if input_image:\n            info_items.insert(-2, (\"å‚è€ƒå›¾ç‰‡\", input_image))\n    else:\n        info_items.insert(-2, (\"ç”Ÿæˆç±»å‹\", \"æ–‡ç”Ÿå›¾\"))\n    \n    # ä¸ºæ¯ä¸ªå‚æ•°åˆ›å»ºæ ‡ç­¾å¯¹\n    for label, value in info_items:\n        label_widget = QLabel(f\"<b>{label}:</b>\")\n        value_clickable = ClickableLabel(str(value))\n        # ... æ ·å¼è®¾ç½® ...\n        self.param_labels.append((label_widget, value_clickable))\n    \n    # æ·»åŠ æœ«å°¾ stretch\n    self.params_layout.addStretch(1)\n```\n\n### 4. ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é‡å»º\n\n**é—®é¢˜æ ¹æº**ï¼š\n\n1. **å‚è€ƒå›¾å¯è§æ€§å˜åŒ–**ï¼ˆImage Dialogï¼‰\n   - ä»£ç ä¸­è™½ç„¶æ²¡æœ‰ç›´æ¥åœ¨ `image_detail_dialog.py` å‚æ•°åŒºå¤„ç†å‚è€ƒå›¾ï¼Œä½†å‚æ•°å¯èƒ½å› å‚è€ƒå›¾çš„å­˜åœ¨/ä¸å­˜åœ¨è€Œéœ€è¦è°ƒæ•´\n\n2. **æ¡ä»¶é€»è¾‘å¯¼è‡´å‚æ•°æ•°é‡å˜åŒ–**\n   - å›¾ç”Ÿå›¾ vs æ–‡ç”Ÿå›¾ï¼š`params.get('model')` åŒ…å« 'i2i' æ—¶æ˜¾ç¤ºä¸åŒå†…å®¹\n   - å‚è€ƒå›¾å­˜åœ¨æ—¶ï¼šé¢å¤–æ’å…¥ \"å‚è€ƒå›¾ç‰‡\" å‚æ•°\n\n3. **ä¸»é¢˜å˜åŒ–éœ€è¦é‡å»ºæ ·å¼**\n   - `_update_theme()` ç¬¬814è¡Œï¼šè°ƒç”¨ `self.setup_params_area()` å®Œå…¨é‡å»º\n   - ç†ç”±ï¼šæ‰€æœ‰å‚æ•°æ ‡ç­¾çš„æ ·å¼ï¼ˆé¢œè‰²ã€èƒŒæ™¯ï¼‰éœ€è¦ä»ä¸»é¢˜ç³»ç»Ÿé‡æ–°è·å–\n\n4. **å†…å­˜æ³„æ¼é£é™©**\n   - ç›´æ¥ä¿®æ”¹ `setText()` å¯èƒ½å¯¼è‡´æ—§æ ‡ç­¾å¯¹è±¡ä»åœ¨å†…å­˜ä¸­\n   - å®Œå…¨æ¸…ç©ºåé‡å»ºæ˜¯æ›´å®‰å…¨çš„åšæ³•\n\n### 5. å…³é”®å‘ç°ï¼šä¸¤ä¸ªå¯¹è¯æ¡†çš„å·®å¼‚\n\n**Image Dialog**ï¼ˆç¬¬672-911è¡Œï¼‰ï¼š\n- ä½¿ç”¨ `ClickableLabel`ï¼ˆè‡ªå®šä¹‰æ ‡ç­¾ï¼Œæ”¯æŒç‚¹å‡»å¤åˆ¶ï¼‰\n- å‚æ•°æ ‡ç­¾å¯¹å­˜å‚¨ä¸º `self.param_labels = list`\n- æ–‡ä»¶è·¯å¾„ç‰¹æ®Šå¤„ç†ï¼š`setWordWrap(False)` + å›ºå®šé«˜åº¦ + çœç•¥å·\n\n**Video Dialog**ï¼ˆç¬¬361-465è¡Œï¼‰ï¼š\n- ä½¿ç”¨ `QLineEdit`ï¼ˆåªè¯»è¾“å…¥æ¡†ï¼Œæ”¯æŒæ–‡æœ¬é€‰æ‹©ï¼‰\n- å‚æ•°å€¼æ ‡ç­¾å­˜å‚¨ä¸º `self.param_value_labels = dict`ï¼ˆæŒ‰æ ‡ç­¾åç´¢å¼•ï¼‰\n- `update_video_params()` æ–¹æ³•åªæ›´æ–°å·²ä¿å­˜æ ‡ç­¾çš„æ–‡æœ¬ï¼Œæ— éœ€é‡å»º\n\n### 6. å¸ƒå±€åœ¨ä¸åŒè®°å½•ç±»å‹çš„å˜åŒ–\n\n**å‚æ•°åˆ—è¡¨åŠ¨æ€æ„é€ **ï¼ˆç¬¬839-857è¡Œï¼‰ï¼š\n\n```python\ninfo_items = [\n    (\"å°ºå¯¸\", params.get('size', 'æœªçŸ¥')),\n    (\"ç§å­å€¼\", params.get('seed', 'æœªçŸ¥')),\n    (\"å¼•å¯¼å¼ºåº¦\", params.get('guidance_scale', 'æœªçŸ¥')),\n    (\"ç”Ÿæˆæ¨¡å‹\", params.get('model', 'æœªçŸ¥æ¨¡å‹')),\n    (\"ç”Ÿæˆæ—¶é—´\", self.format_time(self.image_data.get('created_at', ''))),\n    (\"æ–‡ä»¶å¤§å°\", self.format_file_size(self.image_data.get('file_size', 0))),\n    (\"æ–‡ä»¶è·¯å¾„\", self.image_data.get('absolute_path', '') or self.image_data.get('file_path', '')),\n]\n\n# æ¡ä»¶æ’å…¥ï¼šç”Ÿæˆç±»å‹ + å‚è€ƒå›¾\nif params.get('model', '').find('i2i') != -1:\n    # å›¾ç”Ÿå›¾è·¯å¾„\n    info_items.insert(-2, (\"ç”Ÿæˆç±»å‹\", \"å›¾ç”Ÿå›¾\"))\n    if input_image:\n        info_items.insert(-2, (\"å‚è€ƒå›¾ç‰‡\", input_image))\nelse:\n    # æ–‡ç”Ÿå›¾è·¯å¾„\n    info_items.insert(-2, (\"ç”Ÿæˆç±»å‹\", \"æ–‡ç”Ÿå›¾\"))\n```\n\n**å‚æ•°æ•°é‡å˜åŒ–**ï¼š\n- åŸºç¡€å‚æ•°ï¼š7 ä¸ª\n- æœ‰å‚è€ƒå›¾æ—¶ï¼š+1ï¼ˆ\"å‚è€ƒå›¾ç‰‡\"ï¼‰\n- æ— å‚è€ƒå›¾æ—¶ï¼šå›ºå®š 8 ä¸ª\n\n### 7. é—®é¢˜åˆ†æï¼šä¸ºä»€ä¹ˆæ–‡ä»¶è·¯å¾„ä¼šè¦†ç›–æç¤ºè¯åŒº\n\n**æ ¹æœ¬åŸå› **ï¼ˆç¬¬873-879è¡Œï¼‰ï¼š\n\n```python\nif label == \"æ–‡ä»¶è·¯å¾„\":\n    value_clickable.setWordWrap(False)  # ç¦ç”¨æ¢è¡Œ\n    value_clickable.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)\n    value_clickable.setFixedHeight(32)  # å›ºå®šé«˜åº¦ï¼Œä½†ä»ç„¶å¯èƒ½æº¢å‡º\n```\n\n**é—®é¢˜**ï¼š\n1. å½“æ–‡ä»¶è·¯å¾„å¾ˆé•¿æ—¶ï¼Œ`ClickableLabel` çš„ `set_text_with_ellipsis()` åŸºäºå›ºå®šå®½åº¦è®¡ç®—\n2. `self.width() * 0.25` å¯èƒ½ä¸è¶³ä»¥å®¹çº³çœç•¥å·å¤„ç†\n3. å‚æ•°æ ‡ç­¾æ²¡æœ‰æ˜ç¡®çš„æœ€å¤§é«˜åº¦é™åˆ¶ï¼Œå¯èƒ½è¶…è¿‡å¸ƒå±€é¢„æœŸ\n4. æœ«å°¾çš„ `addStretch(1)` å¯èƒ½ä¸è¶³ä»¥å æ®å‰©ä½™ç©ºé—´ï¼Œå¯¼è‡´å‚æ•°æ ‡ç­¾å‹ç¼©æç¤ºè¯åŒº\n\n### 8. ç”Ÿå‘½å‘¨æœŸå¯¹æ¯”è¡¨\n\n| ç»„ä»¶ | åˆ›å»ºæ—¶ | ä¸»é¢˜å˜åŒ–æ—¶ | åˆ‡æ¢è®°å½•æ—¶ | é”€æ¯æ—¶ |\n|------|------|---------|---------|------|\n| params_widget | ä¿ç•™ï¼ˆä¸é‡å»ºï¼‰ | ä¿ç•™ | ä¿ç•™ | é”€æ¯ |\n| params_layout | ä¿ç•™ | ä¿ç•™ | ä¿ç•™ | é”€æ¯ |\n| prompt_label | é‡å»º | é‡å»º | é‡å»º | é”€æ¯ |\n| prompt_text_edit | é‡å»º | é‡å»º | é‡å»º | é”€æ¯ |\n| copy_prompt_btn | é‡å»º | é‡å»º | é‡å»º | é”€æ¯ |\n| param_labels[] | é‡å»º | é‡å»º | é‡å»º | é”€æ¯ |\n| stretch å ä½ç¬¦ | é‡å»º | é‡å»º | é‡å»º | é”€æ¯ |\n\n### 9. è¯¦ç»†çš„å¸ƒå±€ç»“æ„å›¾\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  ImageDetailDialog (1100 Ã— 800)         â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚                      â”‚  å³ä¾§å¸ƒå±€ (30%)  â”‚\nâ”‚   å·¦ä¾§å¸ƒå±€ (70%)     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚                      â”‚ â”‚ params_widget  â”‚\nâ”‚                      â”‚ â”‚ (å›ºå®šå®½åº¦)     â”‚\nâ”‚                      â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚                      â”‚ â”‚ â”‚params_layout â”‚\nâ”‚                      â”‚ â”‚ â”‚ (QVBoxLayout)â”‚\nâ”‚                      â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚                      â”‚ â”‚ â”‚ æ ‡ç­¾: æç¤ºè¯ â”‚\nâ”‚                      â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚                      â”‚ â”‚ â”‚ æ–‡æœ¬æ¡†(4è¡Œ)  â”‚\nâ”‚                      â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚  å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ        â”‚ â”‚ â”‚ å¤åˆ¶æŒ‰é’®     â”‚\nâ”‚  (520px)             â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚                      â”‚ â”‚ â”‚ å‚æ•°å¯¹1      â”‚ â† åŠ¨æ€åˆ›å»º\nâ”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚ â”‚ â”‚ å‚æ•°å¯¹2      â”‚\nâ”‚                      â”‚ â”‚ â”‚  ...         â”‚\nâ”‚  å‚è€ƒå›¾åº“åŒºåŸŸ        â”‚ â”‚ â”‚ å‚æ•°å¯¹N      â”‚\nâ”‚  (280px)             â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚                      â”‚ â”‚ â”‚ Stretch()    â”‚ â† å æ®å‰©ä½™ç©ºé—´\nâ”‚                      â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\nâ”‚                      â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚                      â”‚ â”‚ å…¨å±/å¤åˆ¶æŒ‰é’®    â”‚\nâ”‚                      â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚                      â”‚ â”‚ åˆ é™¤/å…³é—­æŒ‰é’®    â”‚\nâ”‚                      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### 10. å»ºè®®ï¼šå›ºå®šåŒ–æŸäº›ç»„ä»¶\n\n**å¯ä»¥å›ºå®šåŒ–çš„ç»„ä»¶**ï¼š\n\n1. **æç¤ºè¯åŒºåŸŸ**ï¼ˆç›®å‰ä¼šé‡å»ºï¼‰\n   - å¯ä»¥æ”¹ä¸ºåªæ›´æ–° `setPlainText()` å†…å®¹\n   - ä¿ç•™å¯¹è±¡å¼•ç”¨ï¼Œé¿å…é‡å»º\n\n2. **å‚æ•°åŒºåŸŸå®¹å™¨**\n   - `params_widget` å’Œ `params_layout` å·²ç»å›ºå®š\n   - åªæœ‰å†…å®¹éœ€è¦æ›´æ–°\n\n**ä¸åº”å›ºå®šåŒ–çš„ç»„ä»¶**ï¼š\n\n1. **å‚æ•°æ ‡ç­¾å¯¹** - å› ä¸ºï¼š\n   - å‚æ•°æ•°é‡å¯èƒ½å˜åŒ–ï¼ˆæœ‰æ— å‚è€ƒå›¾ï¼‰\n   - å‚æ•°é¡ºåºå¯èƒ½å˜åŒ–ï¼ˆ`insert()` æ“ä½œï¼‰\n   - ä¸»é¢˜å˜åŒ–éœ€è¦é‡æ–°åº”ç”¨æ ·å¼\n\n2. **å…¨å±€ stretch** - å› ä¸ºï¼š\n   - å‚æ•°æ•°é‡å˜åŒ–ä¼šæ”¹å˜ stretch çš„æ•ˆæœ\n   - å®Œå…¨é‡å»ºæ›´ç®€æ´\n\n### 11. æ ¸å¿ƒé—®é¢˜æ€»ç»“\n\n| é—®é¢˜ | åŸå›  | å½“å‰è§£å†³æ–¹æ¡ˆ | æ•ˆæœ |\n|------|------|----------|------|\n| å‚æ•°åŒºé‡å¤åˆ›å»º | å‚æ•°æ•°é‡/ä¸»é¢˜å˜åŒ– | å®Œå…¨é‡å»º | å®Œæ•´ä½†å¯èƒ½ä½æ•ˆ |\n| æ–‡ä»¶è·¯å¾„è¦†ç›– | çœç•¥å·è®¡ç®—ä¸ç²¾å‡† | å›ºå®šé«˜åº¦ + å›ºå®šå®½åº¦ | éƒ¨åˆ†æ”¹å–„ |\n| å†…å­˜æ³„æ¼é£é™© | æ—§å¯¹è±¡æœªåŠæ—¶æ¸…ç† | `deleteLater()` | å¼‚æ­¥æ¸…ç†æœ‰å»¶è¿Ÿ |\n| ä¸»é¢˜å˜åŒ–é—ªçƒ | å®Œå…¨é‡å»ºæ‰€æœ‰æ§ä»¶ | `setup_params_area()` | å¿…è¦ä½†æ— æ³•é¿å… |\n\nè¿™å°±æ˜¯ Image Detail Dialog å‚æ•°åŒºçš„å®Œæ•´åˆ†æã€‚æ ¸å¿ƒè®¾è®¡æ˜¯åŸºäº**æ¡ä»¶é©±åŠ¨çš„åŠ¨æ€é‡å»º**ï¼Œåœ¨å‚æ•°æ•°é‡æˆ–æ ·å¼å˜åŒ–æ—¶å½»åº•åˆ·æ–°ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Œä½†ä»£ä»·æ˜¯æ¯æ¬¡éƒ½ä¼šé”€æ¯å¹¶é‡å»ºæ‰€æœ‰ç»„ä»¶ã€‚"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":2629,"cache_read_input_tokens":58543,"cache_creation":{"ephemeral_5m_input_tokens":2629,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"c89d2aae-39f5-4924-9dca-9bda22b41c07","timestamp":"2025-12-22T04:37:51.029Z"}
